<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¨ ×‘×“×™×§×” ××”×™×¨×” - ×œ××” ××ª× ×ª×§?</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error { background: #f8d7da; border-left: 5px solid #dc3545; }
        .success { background: #d4edda; border-left: 5px solid #28a745; }
        .warning { background: #fff3cd; border-left: 5px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 5px solid #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        .big-button {
            background: #dc3545;
            font-size: 1.3em;
            padding: 20px 40px;
            width: 100%;
            margin: 15px 0;
            font-weight: bold;
        }
        .big-button:hover { background: #c82333; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .status-box {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            background: #f8f9fa;
        }
        .step {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .step-title {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸš¨ ×‘×“×™×§×” ××”×™×¨×” - ×œ××” ××ª× ×ª×§?</h1>
    
    <div class="section error">
        <h3>âš ï¸ ×”×‘×¢×™×”</h3>
        <p><strong>×”××©×ª××© ××ª× ×ª×§ ×›×©×× ×¡×” ×œ×¨×›×•×© ×× ×•×™ ×œ××¨×•×ª ×©×”×•× ××—×•×‘×¨!</strong></p>
        <p>×‘×•××• × ×‘×“×•×§ ×‘×“×™×•×§ ××™×¤×” ×–×” ×§×•×¨×” ×•× ×ª×§×Ÿ ××ª ×–×”.</p>
    </div>
    
    <div class="section info">
        <h3>ğŸ” ××¦×‘ ××™××•×ª × ×•×›×—×™</h3>
        <div id="auth-status" class="status-box">×˜×•×¢×Ÿ...</div>
    </div>
    
    <div class="section">
        <h3>ğŸ§ª ×‘×“×™×§×•×ª ××”×™×¨×•×ª</h3>
        <button onclick="checkAuthState()">ğŸ” ×‘×“×•×§ ××¦×‘ ××™××•×ª</button>
        <button onclick="simulateLogin()">ğŸ”‘ ×”×ª×—×‘×¨ ×–×× ×™×ª</button>
        <button onclick="testSubscriptionDirect()">ğŸ’³ ×‘×“×•×§ API ×× ×•×™ ×™×©×™×¨×•×ª</button>
        <button onclick="clearAllAndStart()">ğŸ—‘ï¸ × ×§×” ×”×›×œ ×•×”×ª×—×œ ××—×“×©</button>
    </div>
    
    <div class="section">
        <h3>ğŸ¯ ×‘×“×™×§×ª ×–×¨×™××” ××œ××”</h3>
        <button class="big-button" onclick="testFullFlow()">
            ğŸš¨ ×‘×“×•×§ ×œ××” ××ª× ×ª×§ - ×–×¨×™××” ××œ××”
        </button>
        <div id="flow-result" class="status-box">
            ×ª×•×¦××•×ª ×”×‘×“×™×§×” ×™×•×¤×™×¢×• ×›××Ÿ
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ“‹ ×©×œ×‘×™ ×”×‘×“×™×§×”</h3>
        <div class="step">
            <div class="step-title">×©×œ×‘ 1: ×‘×“×™×§×ª ××¦×‘ ×”×ª×—×œ×ª×™</div>
            <button onclick="step1()">ğŸ” ×‘×“×•×§ ××¦×‘ ×”×ª×—×œ×ª×™</button>
            <div id="step1-result">×œ× ×”×•×¨×¥</div>
        </div>
        
        <div class="step">
            <div class="step-title">×©×œ×‘ 2: ×¡×™××•×œ×¦×™×” ×”×ª×—×‘×¨×•×ª</div>
            <button onclick="step2()">ğŸ”‘ ×”×ª×—×‘×¨</button>
            <div id="step2-result">×œ× ×”×•×¨×¥</div>
        </div>
        
        <div class="step">
            <div class="step-title">×©×œ×‘ 3: × ×™×¡×™×•×Ÿ ×¨×›×™×©×ª ×× ×•×™</div>
            <button onclick="step3()">ğŸ’³ × ×¡×” ×œ×¨×›×•×© ×× ×•×™</button>
            <div id="step3-result">×œ× ×”×•×¨×¥</div>
        </div>
        
        <div class="step">
            <div class="step-title">×©×œ×‘ 4: ×‘×“×™×§×” ×× ×”×ª× ×ª×§</div>
            <button onclick="step4()">â“ ×‘×“×•×§ ×× ×¢×“×™×™×Ÿ ××—×•×‘×¨</button>
            <div id="step4-result">×œ× ×”×•×¨×¥</div>
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ“‹ ×œ×•×’ ××¤×•×¨×˜</h3>
        <button onclick="clearLog()">ğŸ—‘ï¸ × ×§×” ×œ×•×’</button>
        <pre id="detailed-log">×”×œ×•×’ ×™×•×¤×™×¢ ×›××Ÿ...</pre>
    </div>

    <script>
        let logEntries = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const entry = `[${timestamp}] ${message}`;
            logEntries.push(entry);
            document.getElementById('detailed-log').textContent = logEntries.join('\n');
            console.log(entry);
        }
        
        function updateAuthStatus() {
            const status = {
                cookies: {},
                storage: {},
                memory: {},
                url: {}
            };
            
            // Check cookies
            try {
                const cookies = document.cookie.split('; ');
                status.cookies.userId = cookies.find(c => c.startsWith('userId='))?.split('=')[1] || null;
                status.cookies.userAuth = cookies.find(c => c.startsWith('userAuth='))?.split('=')[1] || null;
                status.cookies.user_id = cookies.find(c => c.startsWith('user_id='))?.split('=')[1] || null;
                status.cookies.all = document.cookie;
            } catch (error) {
                status.cookies.error = error.message;
            }
            
            // Check storage
            try {
                status.storage.sessionStorage = sessionStorage.getItem('userId');
                status.storage.localStorage = localStorage.getItem('userId');
            } catch (error) {
                status.storage.error = error.message;
            }
            
            // Check memory
            try {
                status.memory.autoPageUserId = window._autoPageUserId;
                status.memory.autoPageAuth = window.autoPageAuth?.userId;
            } catch (error) {
                status.memory.error = error.message;
            }
            
            // Check URL
            try {
                const urlParams = new URLSearchParams(window.location.search);
                status.url.userId = urlParams.get('userId');
                status.url.pageId = urlParams.get('pageId');
            } catch (error) {
                status.url.error = error.message;
            }
            
            // Find best userId
            const userId = status.cookies.userId || 
                          status.cookies.userAuth || 
                          status.cookies.user_id ||
                          status.storage.sessionStorage ||
                          status.storage.localStorage ||
                          status.memory.autoPageUserId ||
                          status.memory.autoPageAuth ||
                          status.url.userId;
            
            document.getElementById('auth-status').innerHTML = `
                <strong>ğŸª Cookies:</strong><br>
                &nbsp;&nbsp;userId: ${status.cookies.userId ? 'âœ… ' + status.cookies.userId : 'âŒ'}<br>
                &nbsp;&nbsp;userAuth: ${status.cookies.userAuth ? 'âœ… ' + status.cookies.userAuth : 'âŒ'}<br>
                &nbsp;&nbsp;user_id: ${status.cookies.user_id ? 'âœ… ' + status.cookies.user_id : 'âŒ'}<br>
                &nbsp;&nbsp;All cookies: ${status.cookies.all || '×¨×™×§'}<br><br>
                
                <strong>ğŸ’¾ Storage:</strong><br>
                &nbsp;&nbsp;sessionStorage: ${status.storage.sessionStorage ? 'âœ… ' + status.storage.sessionStorage : (status.storage.error ? 'ğŸš« ' + status.storage.error : 'âŒ')}<br>
                &nbsp;&nbsp;localStorage: ${status.storage.localStorage ? 'âœ… ' + status.storage.localStorage : 'âŒ'}<br><br>
                
                <strong>ğŸ§  Memory:</strong><br>
                &nbsp;&nbsp;_autoPageUserId: ${status.memory.autoPageUserId ? 'âœ… ' + status.memory.autoPageUserId : 'âŒ'}<br>
                &nbsp;&nbsp;autoPageAuth: ${status.memory.autoPageAuth ? 'âœ… ' + status.memory.autoPageAuth : 'âŒ'}<br><br>
                
                <strong>ğŸ”— URL:</strong><br>
                &nbsp;&nbsp;userId: ${status.url.userId ? 'âœ… ' + status.url.userId : 'âŒ'}<br>
                &nbsp;&nbsp;pageId: ${status.url.pageId ? 'âœ… ' + status.url.pageId : 'âŒ'}<br><br>
                
                <strong>ğŸ¯ Best userId:</strong> ${userId ? 'âœ… ' + userId : 'âŒ ×œ× × ××¦×'}
            `;
            
            return { userId, status };
        }
        
        function checkAuthState() {
            log('ğŸ” ×‘×•×“×§ ××¦×‘ ××™××•×ª...');
            const result = updateAuthStatus();
            
            if (result.userId) {
                log(`âœ… × ××¦× userId: ${result.userId}`);
            } else {
                log('âŒ ×œ× × ××¦× userId ×‘×©×•× ××§×•×');
            }
            
            return result;
        }
        
        function simulateLogin() {
            log('ğŸ”‘ ××“××” ×”×ª×—×‘×¨×•×ª...');
            const testUserId = 'google_111351120503275674259';
            
            // Set all possible cookies
            document.cookie = `userId=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
            document.cookie = `userAuth=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
            document.cookie = `user_id=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
            
            // Set storage
            try {
                sessionStorage.setItem('userId', testUserId);
                localStorage.setItem('userId', testUserId);
            } catch (e) {
                log('âš ï¸ Could not set storage: ' + e.message);
            }
            
            // Set memory
            window._autoPageUserId = testUserId;
            window.autoPageAuth = { userId: testUserId, timestamp: Date.now() };
            
            log(`âœ… ×”×ª×—×‘×¨×•×ª ×¡×•××œ×¦×” ×¢× userId: ${testUserId}`);
            updateAuthStatus();
        }
        
        async function testSubscriptionDirect() {
            log('ğŸ’³ ×‘×•×“×§ API ×× ×•×™ ×™×©×™×¨×•×ª...');
            
            const authResult = checkAuthState();
            if (!authResult.userId) {
                log('âŒ ××™×Ÿ userId - ××¨×™×¥ ×¡×™××•×œ×¦×™×” ×”×ª×—×‘×¨×•×ª ×§×•×“×');
                simulateLogin();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const finalAuth = checkAuthState();
            
            try {
                const response = await fetch('/api/subscription/activate-page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': finalAuth.userId
                    },
                    body: JSON.stringify({
                        documentId: 'test-page-123',
                        userId: finalAuth.userId,
                        months: 1
                    })
                });
                
                const result = await response.json();
                
                log(`ğŸ“Š API Response: Status ${response.status}`);
                log(`ğŸ“Š API Result: ${JSON.stringify(result, null, 2)}`);
                
                // Check if still logged in after API call
                const afterAuth = checkAuthState();
                
                if (afterAuth.userId) {
                    log('âœ… ×¢×“×™×™×Ÿ ××—×•×‘×¨ ××—×¨×™ ×§×¨×™××ª API');
                } else {
                    log('âŒ ×”×ª× ×ª×§ ××—×¨×™ ×§×¨×™××ª API!');
                }
                
                return { response, result, stillLoggedIn: !!afterAuth.userId };
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×§×¨×™××ª API: ${error.message}`);
                return { error: error.message };
            }
        }
        
        function clearAllAndStart() {
            log('ğŸ—‘ï¸ ×× ×§×” ×”×›×œ ×•××ª×—×™×œ ××—×“×©...');
            
            // Clear cookies
            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'userAuth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'user_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            // Clear storage
            try {
                sessionStorage.clear();
                localStorage.clear();
            } catch (e) {
                log('âš ï¸ Could not clear storage: ' + e.message);
            }
            
            // Clear memory
            delete window._autoPageUserId;
            delete window.autoPageAuth;
            
            log('âœ… ×”×›×œ × ×•×§×”');
            updateAuthStatus();
        }
        
        async function testFullFlow() {
            log('ğŸš¨ ××ª×—×™×œ ×‘×“×™×§×ª ×–×¨×™××” ××œ××”...');
            const resultDiv = document.getElementById('flow-result');
            
            resultDiv.innerHTML = 'â³ ×‘×•×“×§ ×œ××” ××ª× ×ª×§... ×× × ×”××ª×Ÿ';
            resultDiv.className = 'status-box info';
            
            try {
                // Step 1: Clear everything
                clearAllAndStart();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 2: Login
                simulateLogin();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 3: Test subscription
                const subscriptionResult = await testSubscriptionDirect();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 4: Final check
                const finalAuth = checkAuthState();
                
                if (finalAuth.userId && subscriptionResult.stillLoggedIn) {
                    resultDiv.innerHTML = `
                        ğŸ‰ ×”×‘×“×™×§×” ×”×•×©×œ××” - ×œ× ×”×ª× ×ª×§!<br><br>
                        âœ… ×”×ª×—×‘×¨×•×ª ×¢×‘×“×”<br>
                        âœ… API ×× ×•×™ ×¢×‘×“<br>
                        âœ… ×¢×“×™×™×Ÿ ××—×•×‘×¨ ××—×¨×™ ×”×›×œ<br><br>
                        <strong>ğŸ¯ ×”××¡×§× ×”:</strong> ×”×ª×™×§×•×Ÿ ×¢×•×‘×“!<br>
                        ×× ××ª×” ×¢×“×™×™×Ÿ ××ª× ×ª×§, ×–×” ×§×•×¨×” ×‘××§×•× ××—×¨.
                    `;
                    resultDiv.className = 'status-box success';
                    log('ğŸ‰ Full flow test PASSED - no disconnect detected');
                } else {
                    resultDiv.innerHTML = `
                        âŒ × ××¦××” ×‘×¢×™×” - ×”××©×ª××© ××ª× ×ª×§!<br><br>
                        âŒ ×”×ª× ×ª×§ ×‘××”×œ×š ×”×ª×”×œ×™×š<br>
                        ğŸ“Š API Status: ${subscriptionResult.response?.status || 'N/A'}<br>
                        ğŸ“Š Still logged in: ${subscriptionResult.stillLoggedIn ? 'Yes' : 'No'}<br><br>
                        <strong>ğŸ” ×‘×“×•×§ ××ª ×”×œ×•×’ ×œ××˜×” ×œ×¤×¨×˜×™×</strong>
                    `;
                    resultDiv.className = 'status-box error';
                    log('âŒ Full flow test FAILED - disconnect detected');
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ ×©×’×™××” ×‘×‘×“×™×§×”: ${error.message}`;
                resultDiv.className = 'status-box error';
                log(`âŒ Full flow test error: ${error.message}`);
            }
        }
        
        function step1() {
            log('ğŸ” ×©×œ×‘ 1: ×‘×•×“×§ ××¦×‘ ×”×ª×—×œ×ª×™...');
            const result = checkAuthState();
            
            document.getElementById('step1-result').innerHTML = 
                result.userId ? 
                `âœ… × ××¦× userId: ${result.userId}` : 
                'âŒ ××™×Ÿ userId - ×¦×¨×™×š ×œ×”×ª×—×‘×¨';
        }
        
        function step2() {
            log('ğŸ”‘ ×©×œ×‘ 2: ××ª×—×‘×¨...');
            simulateLogin();
            document.getElementById('step2-result').innerHTML = 'âœ… ×”×ª×—×‘×¨×•×ª ×”×•×©×œ××”';
        }
        
        async function step3() {
            log('ğŸ’³ ×©×œ×‘ 3: ×× ×¡×” ×œ×¨×›×•×© ×× ×•×™...');
            const result = await testSubscriptionDirect();
            
            document.getElementById('step3-result').innerHTML = 
                result.error ? 
                `âŒ ×©×’×™××”: ${result.error}` : 
                `âœ… API ×¢×‘×“ (Status: ${result.response?.status})`;
        }
        
        function step4() {
            log('â“ ×©×œ×‘ 4: ×‘×•×“×§ ×× ×¢×“×™×™×Ÿ ××—×•×‘×¨...');
            const result = checkAuthState();
            
            document.getElementById('step4-result').innerHTML = 
                result.userId ? 
                `âœ… ×¢×“×™×™×Ÿ ××—×•×‘×¨: ${result.userId}` : 
                'âŒ ×”×ª× ×ª×§!';
        }
        
        function clearLog() {
            logEntries = [];
            document.getElementById('detailed-log').textContent = '×”×œ×•×’ × ×•×§×”...';
        }
        
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×›×œ 3 ×©× ×™×•×ª
        setInterval(updateAuthStatus, 3000);
        
        // ×¢×“×›×•×Ÿ ×¨××©×•× ×™
        updateAuthStatus();
        log('ğŸš¨ Quick Disconnect Debug Page Loaded');
    </script>
</body>
</html>