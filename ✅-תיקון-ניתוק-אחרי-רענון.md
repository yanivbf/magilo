# ✅ תיקון ניתוק אחרי רענון דף

## הבעיה:
כשמרעננים את הדף (F5), המערכת מנתקת את המשתמש ומפנה ל-`/login`.

---

## הסיבה:

### בעיה 1: `getUserById` לא עבד עם Google users
הפונקציה חיפשה לפי `/users/${id}` (מספר), אבל משתמשי Google יש להם `userId` כמו `google_123456789`.

### בעיה 2: `checkSession` לא טיפל נכון בתשובה
ה-API מחזיר `{ success: true, user: {...} }` אבל הקוד ציפה לקבל את ה-user ישירות.

---

## מה תיקנתי:

### 1. שיפור `getUserById` ב-`strapi.js`

**לפני:**
```javascript
export async function getUserById(id) {
	const response = await strapi.get(`/users/${id}`, {
		populate: ['pages', 'purchases', 'leads']
	});
	return response.data;
}
```

**אחרי:**
```javascript
export async function getUserById(id) {
	// If id starts with "google_" or other prefix, search by userId field
	if (id && (id.startsWith('google_') || id.includes('_'))) {
		console.log('🔍 Searching user by userId field:', id);
		const response = await strapi.get('/users', {
			filters: {
				userId: {
					$eq: id
				}
			},
			populate: ['pages', 'purchases', 'leads']
		});
		
		if (response.data && response.data.length > 0) {
			return response.data[0];
		}
		throw new Error(`User not found with userId: ${id}`);
	}
	
	// Otherwise, search by numeric ID
	const response = await strapi.get(`/users/${id}`, {
		populate: ['pages', 'purchases', 'leads']
	});
	return response.data;
}
```

**מה זה עושה:**
- ✅ בודק אם ה-ID מתחיל ב-`google_` או מכיל `_`
- ✅ אם כן, מחפש לפי שדה `userId` במקום ID מספרי
- ✅ אם לא, מחפש לפי ID רגיל (תאימות לאחור)

---

### 2. שיפור `checkSession` ב-`auth.js`

**לפני:**
```javascript
async function checkSession() {
	try {
		const userId = getCookie('userId');
		if (userId) {
			const response = await fetch(`/api/user/${userId}`);
			if (response.ok) {
				const userData = await response.json();
				currentUser.set(userData);
			}
		}
	} catch (error) {
		console.error('Error checking session:', error);
	}
}
```

**אחרי:**
```javascript
async function checkSession() {
	try {
		const userId = getCookie('userId');
		console.log('🔍 Checking session... userId from cookie:', userId);
		
		if (userId) {
			const response = await fetch(`/api/user/${userId}`);
			if (response.ok) {
				const data = await response.json();
				// API returns { success: true, user: {...} }
				const userData = data.user || data;
				console.log('✅ Session restored! User:', userData.name || userData.email);
				// Make sure we have the correct structure
				currentUser.set({
					id: userData.id || userId,
					userId: userData.id || userId,
					email: userData.email,
					name: userData.name,
					avatar: userData.avatar,
					subscriptionStatus: userData.subscriptionStatus || 'inactive'
				});
			} else {
				console.warn('⚠️ Failed to fetch user data, status:', response.status);
				// Clear invalid cookie
				deleteCookie('userId');
			}
		} else {
			console.log('⚠️ No userId cookie found');
		}
	} catch (error) {
		console.error('❌ Error checking session:', error);
	}
}
```

**מה זה עושה:**
- ✅ מוסיף console.log לדיבוג
- ✅ מטפל נכון בתשובה מה-API (`data.user || data`)
- ✅ בונה את אובייקט המשתמש בצורה נכונה
- ✅ מוחק cookie לא תקין אם יש שגיאה

---

## איך זה עובד עכשיו:

### תרחיש 1: רענון דף אחרי התחברות עם Google ✅

1. **דף נטען** → `checkSession()` רץ אוטומטית
2. **קורא cookie** → `userId=google_123456789`
3. **שולח בקשה** → `GET /api/user/google_123456789`
4. **API קורא ל-`getUserById`** → מחפש לפי `userId` field
5. **מוצא משתמש** → מחזיר את הנתונים
6. **שומר ב-store** → `currentUser.set(...)`
7. **משתמש נשאר מחובר!** ✅

### תרחיש 2: רענון דף אחרי התחברות רגילה ✅

1. **דף נטען** → `checkSession()` רץ
2. **קורא cookie** → `userId=123` (מספר)
3. **API קורא ל-`getUserById`** → מחפש לפי ID מספרי
4. **מוצא משתמש** → מחזיר את הנתונים
5. **משתמש נשאר מחובר!** ✅

---

## בדיקה:

### 1. פתח Console (F12)

לחץ F12 ובחר בטאב "Console"

### 2. התחבר עם Google

לך ל: `http://localhost:5173/login`

### 3. בדוק ב-Console

אמור לראות:
```
🔍 Checking session... userId from cookie: google_123456789
🔍 Searching user by userId field: google_123456789
✅ Session restored! User: [השם שלך]
```

### 4. רענן את הדף (F5)

אמור לראות שוב:
```
🔍 Checking session... userId from cookie: google_123456789
✅ Session restored! User: [השם שלך]
```

### 5. בדוק שאתה עדיין מחובר

- ✅ אתה אמור להישאר בדשבורד
- ✅ התמונה/שם שלך אמורים להופיע
- ✅ הדפים שלך אמורים להיות שם

---

## אם זה עדיין לא עובד:

### בדיקה 1: Cookie קיים?

פתח DevTools (F12) → Application → Cookies → `http://localhost:5173`

אמור לראות:
```
Name: userId
Value: google_123456789
Path: /
Expires: [30 ימים מהיום]
```

### בדיקה 2: API עובד?

פתח Console ורוץ:
```javascript
fetch('/api/user/google_123456789').then(r => r.json()).then(console.log)
```

אמור לקבל:
```json
{
  "success": true,
  "user": {
    "id": "...",
    "name": "...",
    "email": "..."
  }
}
```

### בדיקה 3: Strapi עובד?

בדוק ש-Strapi רץ:
```
http://localhost:1337/admin
```

---

## סיכום:

✅ תיקנתי את `getUserById` לתמוך ב-Google users
✅ תיקנתי את `checkSession` לטפל נכון בתשובה
✅ הוספתי console.log לדיבוג
✅ עכשיו רענון דף לא אמור לנתק אותך!

---

**רענן את הדף עכשיו ותגיד לי אם זה עובד!** 🚀

