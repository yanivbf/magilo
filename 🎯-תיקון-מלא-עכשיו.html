<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ ×ª×™×§×•×Ÿ ××œ× - ×¢×›×©×™×•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border-radius: 15px;
            color: white;
        }
        .step {
            background: white;
            margin: 15px 0;
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #4ecdc4;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .step:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .status {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin: 8px;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
        }
        .urgent {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24) !important;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .progress {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .actions {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ×ª×™×§×•×Ÿ ××œ× - ×‘×¢×™×™×ª × ×™×ª×•×§ ××™××•×ª</h1>
            <p>×¤×•×ª×¨ ××ª ×›×œ ×”×‘×¢×™×•×ª: localStorage, Cookies, Google OAuth</p>
        </div>

        <div class="step">
            <h3>ğŸ“Š ×”×ª×§×“××•×ª ×›×œ×œ×™×ª</h3>
            <div class="progress">
                <div class="progress-bar" id="overallProgress" style="width: 0%">0%</div>
            </div>
            <div id="overallStatus" class="status info">××ª×›×•× ×Ÿ ×œ×ª×™×§×•×Ÿ...</div>
        </div>

        <div class="grid">
            <div class="step">
                <h3>ğŸ” 1. ×‘×“×™×§×ª ××™××•×ª</h3>
                <div id="authResult" class="status info">×××ª×™×Ÿ...</div>
                <button onclick="checkAuth()">×‘×“×•×§ ××™××•×ª</button>
            </div>

            <div class="step">
                <h3>ğŸª 2. ×‘×“×™×§×ª Cookies</h3>
                <div id="cookieResult" class="status info">×××ª×™×Ÿ...</div>
                <button onclick="checkCookies()">×‘×“×•×§ Cookies</button>
            </div>

            <div class="step">
                <h3>ğŸ’¾ 3. ×‘×“×™×§×ª localStorage</h3>
                <div id="localStorageResult" class="status info">×××ª×™×Ÿ...</div>
                <button onclick="checkLocalStorage()">×‘×“×•×§ localStorage</button>
            </div>

            <div class="step">
                <h3>ğŸ”— 4. ×‘×“×™×§×ª Google OAuth</h3>
                <div id="googleResult" class="status info">×××ª×™×Ÿ...</div>
                <button onclick="checkGoogle()">×‘×“×•×§ Google</button>
            </div>
        </div>

        <div class="actions">
            <h3>âš¡ ×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</h3>
            <button onclick="runFullDiagnosis()" class="urgent">ğŸ” ××‘×—×•×Ÿ ××œ×</button>
            <button onclick="fixAllIssues()" class="urgent">ğŸ”§ ×ª×§×Ÿ ×”×›×œ</button>
            <button onclick="createTempUser()" class="urgent">ğŸ‘¤ ×¦×•×¨ ××©×ª××© ×–×× ×™</button>
            <button onclick="resetAndReload()">ğŸ”„ ××™×¤×•×¡ ×•×¨×¢× ×•×Ÿ</button>
            <button onclick="goToDashboard()">ğŸ“Š ×œ×š ×œ×“×©×‘×•×¨×“</button>
        </div>

        <div class="step">
            <h3>ğŸ“ ×§×•× ×¡×•×œ ×ª×™×§×•× ×™×</h3>
            <div id="console" class="console">××ª×—×™×œ ××‘×—×•×Ÿ...\n</div>
            <button onclick="clearConsole()">× ×§×” ×§×•× ×¡×•×œ</button>
            <button onclick="downloadLog()">×”×•×¨×“ ×œ×•×’</button>
        </div>

        <div id="detailedResults"></div>
    </div>

    <script>
        let currentStep = 0;
        const totalSteps = 4;
        let logEntries = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const entry = `[${timestamp}] ${message}`;
            logEntries.push(entry);
            
            const console = document.getElementById('console');
            console.innerHTML += entry + '\n';
            console.scrollTop = console.scrollHeight;
            
            console.log(message);
        }

        function updateProgress(step, message) {
            currentStep = step;
            const progress = (step / totalSteps) * 100;
            const progressBar = document.getElementById('overallProgress');
            const statusElement = document.getElementById('overallStatus');
            
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
            statusElement.textContent = message;
            statusElement.className = step === totalSteps ? 'status success' : 'status info';
        }

        function setResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        // ×‘×“×™×§×ª ××™××•×ª
        async function checkAuth() {
            log('ğŸ” ×‘×•×“×§ ××¦×‘ ××™××•×ª...');
            setResult('authResult', 'info', '×‘×•×“×§...');
            
            try {
                // ×‘×“×•×§ cookie
                const cookies = document.cookie;
                const userIdMatch = cookies.match(/userId=([^;]+)/);
                const userId = userIdMatch ? userIdMatch[1] : null;
                
                log(`Cookie userId: ${userId || '×œ× × ××¦×'}`);
                
                if (userId) {
                    // ×‘×“×•×§ ×¢× ×”×©×¨×ª
                    try {
                        const response = await fetch('/api/user/current');
                        const data = await response.json();
                        
                        if (response.ok && data) {
                            setResult('authResult', 'success', `âœ… ××—×•×‘×¨: ${data.name || userId}`);
                            log(`âœ… ××™××•×ª ×ª×§×™×Ÿ: ${data.name || userId}`);
                            return true;
                        } else {
                            setResult('authResult', 'warning', `âš ï¸ Cookie ×§×™×™× ××‘×œ ×©×¨×ª ×œ× ××–×”×”`);
                            log(`âš ï¸ ×©×¨×ª ×œ× ××–×”×” ××ª ×”××©×ª××©: ${response.status}`);
                            return false;
                        }
                    } catch (serverError) {
                        setResult('authResult', 'warning', `âš ï¸ Cookie ×§×™×™× ××‘×œ ×©×¨×ª ×œ× ×–××™×Ÿ`);
                        log(`âš ï¸ ×©×’×™××ª ×©×¨×ª: ${serverError.message}`);
                        return false;
                    }
                } else {
                    setResult('authResult', 'error', 'âŒ ×œ× ××—×•×‘×¨ - ××™×Ÿ userId');
                    log('âŒ ×œ× × ××¦× userId ×‘cookies');
                    return false;
                }
            } catch (error) {
                setResult('authResult', 'error', `âŒ ×©×’×™××”: ${error.message}`);
                log(`âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ××™××•×ª: ${error.message}`);
                return false;
            }
        }

        // ×‘×“×™×§×ª cookies
        function checkCookies() {
            log('ğŸª ×‘×•×“×§ ×™×›×•×œ×ª cookies...');
            setResult('cookieResult', 'info', '×‘×•×“×§...');
            
            try {
                // × ×¡×” ×œ×™×¦×•×¨ cookie ×‘×“×™×§×”
                const testValue = 'test_' + Date.now();
                document.cookie = `test=${testValue}; path=/`;
                
                // ×‘×“×•×§ ×× × ×•×¦×¨
                const created = document.cookie.includes(`test=${testValue}`);
                
                if (created) {
                    // × ×§×” ××ª cookie ×”×‘×“×™×§×”
                    document.cookie = 'test=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
                    
                    const cookieCount = document.cookie.split(';').filter(c => c.trim()).length;
                    setResult('cookieResult', 'success', `âœ… Cookies ×¢×•×‘×“×™× (${cookieCount} cookies)`);
                    log(`âœ… Cookies ×¢×•×‘×“×™× ×ª×§×™×Ÿ, ×¡×”"×›: ${cookieCount}`);
                    return true;
                } else {
                    setResult('cookieResult', 'error', 'âŒ ×œ× ×™×›×•×œ ×œ×™×¦×•×¨ cookies');
                    log('âŒ ×œ× ×”×¦×œ×™×— ×œ×™×¦×•×¨ cookie ×‘×“×™×§×”');
                    return false;
                }
            } catch (error) {
                setResult('cookieResult', 'error', `âŒ ×©×’×™××”: ${error.message}`);
                log(`âŒ ×©×’×™××” ×‘cookies: ${error.message}`);
                return false;
            }
        }

        // ×‘×“×™×§×ª localStorage
        function checkLocalStorage() {
            log('ğŸ’¾ ×‘×•×“×§ localStorage...');
            setResult('localStorageResult', 'info', '×‘×•×“×§...');
            
            try {
                const testKey = '__test_' + Date.now();
                const testValue = 'test_value';
                
                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved === testValue) {
                    setResult('localStorageResult', 'success', 'âœ… localStorage ×¢×•×‘×“ ×ª×§×™×Ÿ');
                    log('âœ… localStorage ×–××™×Ÿ ×•×¢×•×‘×“');
                    return true;
                } else {
                    setResult('localStorageResult', 'error', 'âŒ localStorage ×œ× ×¢×•×‘×“ ×›×¨××•×™');
                    log('âŒ localStorage ×œ× ××—×–×™×¨ ×¢×¨×›×™× × ×›×•× ×™×');
                    return false;
                }
            } catch (error) {
                setResult('localStorageResult', 'error', `âŒ localStorage ×—×¡×•×: ${error.message}`);
                log(`âŒ localStorage ×œ× ×–××™×Ÿ: ${error.message}`);
                return false;
            }
        }

        // ×‘×“×™×§×ª Google OAuth
        function checkGoogle() {
            log('ğŸ”— ×‘×•×“×§ ×”×’×“×¨×•×ª Google OAuth...');
            setResult('googleResult', 'info', '×‘×•×“×§...');
            
            const currentUrl = window.location.origin;
            const currentPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            
            log(`URL × ×•×›×—×™: ${currentUrl}`);
            log(`×¤×•×¨×˜ × ×•×›×—×™: ${currentPort}`);
            
            // ×¨×©×™××ª ×¤×•×¨×˜×™× ××•×’×“×¨×™×
            const configuredPorts = ['3000', '5173', '5174', '5175'];
            const isConfigured = configuredPorts.includes(currentPort);
            
            if (isConfigured) {
                setResult('googleResult', 'success', `âœ… ×¤×•×¨×˜ ××•×’×“×¨: ${currentUrl}`);
                log(`âœ… ×¤×•×¨×˜ ${currentPort} ××•×’×“×¨ ×‘-Google Console`);
                return true;
            } else {
                setResult('googleResult', 'error', `âŒ ×¤×•×¨×˜ ×œ× ××•×’×“×¨: ${currentUrl}`);
                log(`âŒ ×¤×•×¨×˜ ${currentPort} ×œ× ××•×’×“×¨ ×‘-Google Console`);
                log(`×¦×¨×™×š ×œ×”×•×¡×™×£: ${currentUrl} ×•-${currentUrl}/api/auth/google`);
                return false;
            }
        }

        // ××‘×—×•×Ÿ ××œ×
        async function runFullDiagnosis() {
            log('ğŸ” ××ª×—×™×œ ××‘×—×•×Ÿ ××œ×...');
            updateProgress(0, '××ª×—×™×œ ××‘×—×•×Ÿ...');
            
            const results = {};
            
            // ×‘×“×™×§×” 1: ××™××•×ª
            updateProgress(1, '×‘×•×“×§ ××™××•×ª...');
            results.auth = await checkAuth();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // ×‘×“×™×§×” 2: cookies
            updateProgress(2, '×‘×•×“×§ cookies...');
            results.cookies = checkCookies();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // ×‘×“×™×§×” 3: localStorage
            updateProgress(3, '×‘×•×“×§ localStorage...');
            results.localStorage = checkLocalStorage();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // ×‘×“×™×§×” 4: Google OAuth
            updateProgress(4, '×‘×•×“×§ Google OAuth...');
            results.google = checkGoogle();
            
            // ×¡×™×›×•×
            const passedTests = Object.values(results).filter(r => r).length;
            const totalTests = Object.keys(results).length;
            
            log(`ğŸ“Š ×¡×™×›×•× ××‘×—×•×Ÿ: ${passedTests}/${totalTests} ×‘×“×™×§×•×ª ×¢×‘×¨×•`);
            updateProgress(4, `××‘×—×•×Ÿ ×”×•×©×œ×: ${passedTests}/${totalTests} ×ª×§×™×Ÿ`);
            
            if (passedTests === totalTests) {
                log('ğŸ‰ ×›×œ ×”×‘×“×™×§×•×ª ×¢×‘×¨×• ×‘×”×¦×œ×—×”!');
            } else {
                log('âš ï¸ × ××¦××• ×‘×¢×™×•×ª ×©×“×•×¨×©×•×ª ×ª×™×§×•×Ÿ');
            }
            
            return results;
        }

        // ×ª×™×§×•×Ÿ ×›×œ ×”×‘×¢×™×•×ª
        async function fixAllIssues() {
            log('ğŸ”§ ××ª×—×™×œ ×ª×™×§×•×Ÿ ×›×œ ×”×‘×¢×™×•×ª...');
            
            try {
                // ×ª×™×§×•×Ÿ 1: × ×§×” localStorage ×¤×’×•×
                try {
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        try {
                            const value = localStorage.getItem(key);
                            JSON.parse(value);
                        } catch (e) {
                            localStorage.removeItem(key);
                            log(`ğŸ—‘ï¸ ×”×•×¡×¨ × ×ª×•×Ÿ ×¤×’×•×: ${key}`);
                        }
                    });
                } catch (e) {
                    log('âš ï¸ localStorage ×œ× ×–××™×Ÿ ×œ× ×™×§×•×™');
                }
                
                // ×ª×™×§×•×Ÿ 2: ×¦×•×¨ ××©×ª××© ×–×× ×™ ×× ××™×Ÿ
                const userId = getCookie('userId');
                if (!userId) {
                    const tempUserId = await createTempUser();
                    if (tempUserId) {
                        log(`âœ… × ×•×¦×¨ ××©×ª××© ×–×× ×™: ${tempUserId}`);
                    }
                }
                
                // ×ª×™×§×•×Ÿ 3: ×‘×“×•×§ ×©×¨×ª
                try {
                    const response = await fetch('/api/user/current');
                    if (response.ok) {
                        log('âœ… ×©×¨×ª ××’×™×‘ ×ª×§×™×Ÿ');
                    } else {
                        log(`âš ï¸ ×©×¨×ª ××’×™×‘ ×¢× ×©×’×™××”: ${response.status}`);
                    }
                } catch (e) {
                    log(`âš ï¸ ×©×¨×ª ×œ× ×–××™×Ÿ: ${e.message}`);
                }
                
                log('âœ… ×›×œ ×”×ª×™×§×•× ×™× ×”×•×©×œ××•!');
                
                // ×”×¦×¢ ×œ×¨×¢× ×Ÿ
                if (confirm('âœ… ×”×ª×™×§×•× ×™× ×”×•×©×œ××•! ×”×× ×œ×¨×¢× ×Ÿ ××ª ×”×“×£?')) {
                    window.location.reload();
                }
                
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×ª×™×§×•×Ÿ: ${error.message}`);
            }
        }

        // ×™×¦×™×¨×ª ××©×ª××© ×–×× ×™
        async function createTempUser() {
            log('ğŸ‘¤ ×™×•×¦×¨ ××©×ª××© ×–×× ×™...');
            
            try {
                const tempUserId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // ×©××•×¨ ×‘cookie
                const expires = new Date(Date.now() + 24 * 60 * 60 * 1000).toUTCString(); // 24 ×©×¢×•×ª
                document.cookie = `userId=${tempUserId}; expires=${expires}; path=/; SameSite=Lax`;
                
                // ×‘×“×•×§ ×©× ×©××¨
                const saved = document.cookie.includes(`userId=${tempUserId}`);
                
                if (saved) {
                    log(`âœ… ××©×ª××© ×–×× ×™ × ×•×¦×¨: ${tempUserId}`);
                    
                    // × ×¡×” ×œ×©××•×¨ ×’× ×‘localStorage
                    try {
                        const userData = {
                            id: tempUserId,
                            userId: tempUserId,
                            email: '',
                            name: '××©×ª××© ×–×× ×™',
                            avatar: null,
                            subscriptionStatus: 'active',
                            isTemp: true,
                            created: new Date().toISOString()
                        };
                        localStorage.setItem('currentUser', JSON.stringify(userData));
                        log('âœ… × ×ª×•× ×™ ××©×ª××© × ×©××¨×• ×’× ×‘localStorage');
                    } catch (e) {
                        log('âš ï¸ ×œ× ×”×¦×œ×™×— ×œ×©××•×¨ ×‘localStorage (×œ× ×§×¨×™×˜×™)');
                    }
                    
                    return tempUserId;
                } else {
                    log('âŒ ×œ× ×”×¦×œ×™×— ×œ×©××•×¨ cookie');
                    return null;
                }
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ××©×ª××© ×–×× ×™: ${error.message}`);
                return null;
            }
        }

        // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function resetAndReload() {
            if (confirm('âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ××¤×¡ ×”×›×œ ×•×œ×¨×¢× ×Ÿ?')) {
                log('ğŸ”„ ×××¤×¡ ×”×›×œ...');
                
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });
                    
                    log('âœ… ××™×¤×•×¡ ×”×•×©×œ×, ××¨×¢× ×Ÿ...');
                    setTimeout(() => window.location.reload(), 1000);
                } catch (error) {
                    log(`âŒ ×©×’×™××” ×‘××™×¤×•×¡: ${error.message}`);
                }
            }
        }

        function goToDashboard() {
            log('ğŸ“Š ××¢×‘×¨ ×œ×“×©×‘×•×¨×“...');
            window.location.href = '/dashboard';
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
            logEntries = [];
            log('×§×•× ×¡×•×œ × ×•×§×”');
        }

        function downloadLog() {
            const logText = logEntries.join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auth-fix-log-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ×”×¤×¢×œ×” ××•×˜×•××˜×™×ª
        window.onload = function() {
            log('ğŸš€ ××¢×¨×›×ª ×ª×™×§×•×Ÿ ××™××•×ª × ×˜×¢× ×”');
            log('×œ×—×¥ ×¢×œ "××‘×—×•×Ÿ ××œ×" ×›×“×™ ×œ×”×ª×—×™×œ');
            
            // ×”×¤×¢×œ ××‘×—×•×Ÿ ××•×˜×•××˜×™ ××—×¨×™ 2 ×©× ×™×•×ª
            setTimeout(() => {
                log('ğŸ”„ ××ª×—×™×œ ××‘×—×•×Ÿ ××•×˜×•××˜×™...');
                runFullDiagnosis();
            }, 2000);
        };
    </script>
</body>
</html>