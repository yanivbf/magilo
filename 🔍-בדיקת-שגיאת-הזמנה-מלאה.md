# 🔍 בדיקת שגיאת הזמנה - מדריך מלא

## מה עשינו

הוספנו **לוגים מפורטים מאוד** בכל שלב של תהליך ההזמנה כדי לזהות בדיוק איפה השגיאה מתרחשת.

---

## 🎯 איך לבדוק

### שיטה 1: בדיקה בדף האמיתי

1. **פתח את הדף עם החנות** (http://localhost:5174/pages/YOUR_PAGE_SLUG)
2. **פתח את הקונסול** (F12 → Console)
3. **הוסף מוצר לעגלה**
4. **לחץ על "המשך לתשלום"**
5. **מלא את הטופס**
6. **לחץ על "שלח הזמנה"**
7. **צפה בלוגים בקונסול**

### שיטה 2: בדיקה עם קובץ הבדיקה

1. **פתח את הקובץ**: `test-purchase-order-detailed.html`
2. **מלא את הפרטים** (userId, pageId)
3. **לחץ על "שלח הזמנה לבדיקה"**
4. **צפה בלוגים ובתוצאה**

---

## 📊 מה תראה בקונסול

### ✅ תרחיש מוצלח

```
🛒 submitOrder called
📋 Customer info: {name: "ישראל", phone: "050-1234567", ...}
🛒 Cart: [{name: "מוצר 1", price: 50, quantity: 2}, ...]
💰 Cart total: 175
📄 Page ID: abc123def456
✅ Validation passed, preparing order...
👤 User ID from cookie: google_123456789
📦 Order items prepared: [{name: "מוצר 1", quantity: 2, price: 50, ...}]
📤 Sending request body: {userId: "google_123456789", pageId: "abc123def456", ...}
🌐 Sending POST request to /api/purchase...
📥 Response status: 200 OK
📥 Response data: {success: true, purchaseId: 15, message: "Purchase created successfully"}
✅ Order submitted successfully!
```

### ❌ תרחיש עם שגיאה

```
🛒 submitOrder called
📋 Customer info: {name: "ישראל", phone: "050-1234567", ...}
🛒 Cart: [{name: "מוצר 1", price: 50, quantity: 2}]
💰 Cart total: 175
📄 Page ID: undefined  ← 🚨 הבעיה כאן!
✅ Validation passed, preparing order...
👤 User ID from cookie: google_123456789
📦 Order items prepared: [...]
📤 Sending request body: {...}
🌐 Sending POST request to /api/purchase...
📥 Response status: 400 Bad Request
📥 Response data: {error: "Missing pageId"}
❌ Server returned error: Missing pageId
❌ Error submitting order: Missing pageId
```

---

## 🔍 שגיאות נפוצות ופתרונות

### 1. ❌ Missing pageId

**מה זה אומר:**  
הקומפוננט לא מקבל את ה-pageId מה-context.

**איך לתקן:**
```javascript
// בדוק ב-pages/[slug]/+page.svelte שיש:
setContext('pageId', page.documentId);
```

**איך לבדוק:**
```javascript
// הוסף בקונסול:
console.log('📄 Page ID:', pageId);
// אם זה undefined - הבעיה היא ב-context
```

---

### 2. ❌ Missing userId

**מה זה אומר:**  
אין userId בעוגייה או שהעוגייה פגה.

**איך לתקן:**
1. התחבר מחדש
2. או בדוק בקונסול:
```javascript
document.cookie.split('; ').find(row => row.startsWith('userId='))
```

**איך לבדוק:**
```javascript
// הוסף בקונסול:
console.log('🍪 Cookies:', document.cookie);
```

---

### 3. ❌ Invalid total amount

**מה זה אומר:**  
הסכום הכולל הוא 0 או שלילי.

**איך לתקן:**
- בדוק שהמוצרים במחירים תקינים
- בדוק שהעגלה לא ריקה

**איך לבדוק:**
```javascript
// הוסף בקונסול:
console.log('💰 Cart total:', cartTotal);
console.log('🛒 Cart:', cart);
```

---

### 4. ❌ Failed to create purchase in Strapi

**מה זה אומר:**  
השגיאה היא בשרת Strapi עצמו.

**איך לתקן:**
1. בדוק את הלוגים בטרמינל של Strapi
2. בדוק שהשדות בסכמה תואמים
3. בדוק שיש הרשאות ליצור purchase

**איך לבדוק:**
```bash
# בטרמינל של Strapi תראה:
❌ Strapi purchase creation error:
  - Error message: ...
  - Response status: 400
  - Response data: {...}
```

---

### 5. ❌ Network Error / Failed to fetch

**מה זה אומר:**  
הבקשה לא הגיעה לשרת בכלל.

**איך לתקן:**
1. בדוק שהשרת רץ (http://localhost:5174)
2. בדוק את ה-Network tab בדפדפן
3. בדוק שאין בעיות CORS

---

## 🛠️ כלי בדיקה

### 1. בדיקה בקונסול הדפדפן

```javascript
// בדוק userId
console.log('User ID:', document.cookie.split('; ').find(row => row.startsWith('userId='))?.split('=')[1]);

// בדוק pageId (בדף עצמו)
// צריך להיות זמין דרך context
```

### 2. בדיקה ב-Network Tab

1. פתח F12 → Network
2. סנן ל-"purchase"
3. שלח הזמנה
4. לחץ על הבקשה
5. צפה ב-Request Payload ו-Response

### 3. בדיקה בטרמינל

```bash
# בטרמינל של SvelteKit תראה:
🛒 PURCHASE REQUEST: {...}
🔍 Looking up Strapi user for Google ID: google_123456
✅ Found Strapi user ID: 1 for google_123456
💾 Creating purchase in Strapi with data: {...}
✅ Purchase created with ID: 15
```

---

## 📝 מה לעשות אחרי הבדיקה

1. **העתק את כל הלוגים** מהקונסול
2. **העתק את הלוגים** מהטרמינל
3. **שלח לי אותם** ואני אזהה את הבעיה המדויקת

---

## 🎯 דוגמאות לבעיות שזיהינו בעבר

### בעיה: כפתור לא מגיב
**פתרון:** הסרנו onclick והשארנו רק type="submit"

### בעיה: לולאה אינסופית
**פתרון:** הסרנו onclick כפול שגרם ללולאה

### בעיה: 400 Bad Request
**פתרון:** תיקנו את שמות השדות (items → products)

### בעיה: 500 Internal Server Error
**פתרון:** תיקנו את populate=deep,3 ל-populate=*

---

## ✅ סיכום

עכשיו יש לנו **לוגים מפורטים** בכל שלב:
- ✅ בקומפוננט (frontend)
- ✅ ב-API (backend)
- ✅ ב-Strapi wrapper (database)

**נסה לשלוח הזמנה ותראה לי את הלוגים!**
