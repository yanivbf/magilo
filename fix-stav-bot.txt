=== ×”×•×¨××•×ª ×ª×™×§×•×Ÿ ×™×“× ×™ ===

×”×§×•×‘×¥ marketplace.html ××¡×•×‘×š ××“×™ ×œ×ª×§×•×Ÿ ××•×˜×•××˜×™.

×›×“×™ ×œ×ª×§×Ÿ ×™×“× ×™×ª:

1. ×¤×ª×— ××ª public/marketplace.html
2. ×—×¤×©: async function sendStavMessage()
3. ××—×§ ××ª ×›×œ ×”×ª×•×›×Ÿ ×©×œ ×”×¤×•× ×§×¦×™×” (×-{ ×¢×“ })
4. ×”×“×‘×§ ××ª ×”×§×•×“ ×”×¤×©×•×˜ ×”×–×”:

```javascript
async function sendStavMessage() {
    const input = document.getElementById('stavChatInput');
    const userMessage = input.value.trim();
    
    if (!userMessage) return;
    
    // ×× ×¢ ×›×¤×™×œ×•×™×•×ª
    const now = Date.now();
    if (userMessage === lastSentUserMessage && (now - lastSentUserMessageTime) < 10000) {
        return;
    }
    
    lastSentUserMessage = userMessage;
    lastSentUserMessageTime = now;
    
    // ×”×¦×’ ×”×•×“×¢×ª ××©×ª××©
    addStavMessage(userMessage, true);
    input.value = '';
    
    // ×”×¦×’ "××§×œ×™×“×”..."
    const typingDiv = document.createElement('div');
    typingDiv.className = 'stav-message bot stav-typing-indicator';
    typingDiv.id = 'stav-typing-indicator';
    typingDiv.innerHTML = `<div class="stav-loader"><div class="inner one"></div><div class="inner two"></div><div class="inner three"></div></div><span>×¡×ª×™×• ××§×œ×™×“×”...</span>`;
    
    const messagesDiv = document.getElementById('stavChatMessages');
    messagesDiv.appendChild(typingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    try {
        // ×§×‘×œ ×“×¤×™×
        const pagesRes = await fetch('/api/pages/all');
        const pagesData = await pagesRes.json();
        const allPages = pagesData.pages || [];
        
        console.log(`ğŸ“Š Got ${allPages.length} pages, sending to N8N...`);
        
        // ×©×œ×— ×œ-N8N
        const n8nRes = await fetch('/api/n8n-webhook', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: userMessage,
                context: 'stav-marketplace',
                allPages: allPages.map(p => ({
                    title: p.title,
                    description: p.description,
                    pageType: p.pageType,
                    category: p.category,
                    city: p.city,
                    phone: p.phone,
                    pageId: p.pageId,
                    userId: p.userId
                }))
            })
        });
        
        // ×”×¡×¨ "××§×œ×™×“×”..."
        document.getElementById('stav-typing-indicator')?.remove();
        
        if (!n8nRes.ok) {
            addStavMessage('××•×¤×¡, ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª. × ×¡×” ×©×•×‘.', false);
            return;
        }
        
        const n8nData = await n8nRes.json();
        console.log('âœ… N8N response:', n8nData);
        
        // ×”×¦×’ ×ª×©×•×‘×”
        let botMessage = '';
        
        if (n8nData.pages && n8nData.pages.length > 0) {
            botMessage = n8nData.message || `××¦××ª×™ ${n8nData.pages.length} ××¤×©×¨×•×™×•×ª:\n\n`;
            n8nData.pages.slice(0, 5).forEach((p, i) => {
                botMessage += `${i + 1}. ${p.title}`;
                if (p.description) botMessage += ` - ${p.description}`;
                if (p.city) botMessage += `\n   ğŸ“ ${p.city}`;
                if (p.phone) botMessage += ` â€¢ ğŸ“ ${p.phone}`;
                botMessage += `\n\n`;
            });
        } else {
            botMessage = n8nData.message || n8nData.response || '×œ× ×”×‘× ×ª×™, ×ª×•×›×œ ×œ× ×¡×— ××—×¨×ª?';
        }
        
        addStavMessage(botMessage, false);
        
    } catch (error) {
        console.error('âŒ Error:', error);
        document.getElementById('stav-typing-indicator')?.remove();
        addStavMessage('××•×¤×¡, ××©×”×• ×”×©×ª×‘×©. × ×¡×” ×©×•×‘.', false);
    }
}
```

×–×”×•! ×–×” ×™×¢×‘×•×“!












