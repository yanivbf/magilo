<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×“×™×§×” ××”×™×¨×” - ×”×ª×—×‘×¨×•×ª</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 8px; max-width: 800px; margin: 0 auto; }
        .success { color: #28a745; background: #d4edda; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { color: #0c5460; background: #d1ecf1; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 16px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 14px; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .status-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border-right: 4px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ×‘×“×™×§×” ××”×™×¨×” - ×‘×¢×™×™×ª ×”×ª×—×‘×¨×•×ª</h1>
        
        <div class="info">
            <strong>ğŸ¯ ××˜×¨×”:</strong> ×œ×–×”×•×ª ×‘×“×™×•×§ ××” ×”×‘×¢×™×” ×¢× ×”×”×ª×—×‘×¨×•×ª ×•×œ×ª×§×Ÿ ××•×ª×”
        </div>
        
        <div class="status-grid">
            <div class="status-card">
                <h3>ğŸŒ ×¤×¨×˜×™ ×”×©×¨×ª</h3>
                <div id="serverInfo">×‘×•×“×§...</div>
            </div>
            <div class="status-card">
                <h3>ğŸª ×¡×˜×˜×•×¡ Cookies</h3>
                <div id="cookieInfo">×‘×•×“×§...</div>
            </div>
        </div>
        
        <button onclick="runFullCheck()">ğŸ” ×‘×“×™×§×” ××œ××”</button>
        <button onclick="testGoogleAuth()">ğŸ” ×‘×“×•×§ Google OAuth</button>
        <button onclick="clearAndRedirect()">ğŸ—‘ï¸ × ×§×” ×•×¢×‘×•×¨ ×œ×”×ª×—×‘×¨×•×ª</button>
        
        <div id="results"></div>
    </div>

    <script>
        const results = document.getElementById('results');
        
        function updateServerInfo() {
            const serverInfo = document.getElementById('serverInfo');
            const port = window.location.port || '80';
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            
            serverInfo.innerHTML = `
                <strong>×¤×•×¨×˜:</strong> ${port}<br>
                <strong>URL:</strong> ${protocol}//${hostname}:${port}<br>
                <strong>Origin:</strong> ${window.location.origin}
            `;
        }
        
        function updateCookieInfo() {
            const cookieInfo = document.getElementById('cookieInfo');
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                if (key) acc[key] = value;
                return acc;
            }, {});
            
            const userId = cookies.userId;
            let cookieStatus = '';
            
            if (userId) {
                if (userId.startsWith('google_')) {
                    cookieStatus = `<span style="color: #28a745;">âœ… ${userId}</span>`;
                } else {
                    cookieStatus = `<span style="color: #dc3545;">âŒ ${userId} (×©×’×•×™)</span>`;
                }
            } else {
                cookieStatus = '<span style="color: #6c757d;">âŒ ××™×Ÿ cookie</span>';
            }
            
            cookieInfo.innerHTML = `
                <strong>userId:</strong> ${cookieStatus}<br>
                <strong>×¡×”"×› cookies:</strong> ${Object.keys(cookies).length}
            `;
        }
        
        async function runFullCheck() {
            results.innerHTML = '<div class="info">ğŸ” ××¨×™×¥ ×‘×“×™×§×” ××œ××”...</div>';
            
            let report = '<h3>ğŸ“‹ ×“×•×— ×‘×“×™×§×” ××œ××”</h3>';
            
            // 1. Check current URL and port
            const currentPort = window.location.port || '80';
            const currentOrigin = window.location.origin;
            
            report += `<div class="info">
                <strong>1. ×¤×¨×˜×™ ×”×©×¨×ª:</strong><br>
                â€¢ ×¤×•×¨×˜ × ×•×›×—×™: ${currentPort}<br>
                â€¢ Origin: ${currentOrigin}
            </div>`;
            
            // 2. Check cookies
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                if (key) acc[key] = value;
                return acc;
            }, {});
            
            const userId = cookies.userId;
            let cookieStatus = '×ª×§×™×Ÿ';
            let cookieClass = 'success';
            
            if (!userId) {
                cookieStatus = '×—×¡×¨ userId cookie';
                cookieClass = 'error';
            } else if (!userId.startsWith('google_')) {
                cookieStatus = `userId ×©×’×•×™: ${userId} (×¦×¨×™×š ×œ×”×ª×—×™×œ ×‘-google_)`;
                cookieClass = 'error';
            }
            
            report += `<div class="${cookieClass}">
                <strong>2. ×‘×“×™×§×ª Cookies:</strong><br>
                â€¢ ×¡×˜×˜×•×¡: ${cookieStatus}<br>
                â€¢ ×¡×”"×› cookies: ${Object.keys(cookies).length}
            </div>`;
            
            // 3. Test API connectivity
            try {
                const response = await fetch('/api/user/current');
                const data = await response.json();
                
                if (response.ok && data.authenticated) {
                    report += `<div class="success">
                        <strong>3. ×‘×“×™×§×ª API:</strong><br>
                        â€¢ âœ… API ×¢×•×‘×“<br>
                        â€¢ âœ… ××©×ª××© ××—×•×‘×¨: ${data.userId}
                    </div>`;
                } else {
                    report += `<div class="error">
                        <strong>3. ×‘×“×™×§×ª API:</strong><br>
                        â€¢ âŒ ××©×ª××© ×œ× ××—×•×‘×¨<br>
                        â€¢ Status: ${response.status}<br>
                        â€¢ Response: ${JSON.stringify(data)}
                    </div>`;
                }
            } catch (error) {
                report += `<div class="error">
                    <strong>3. ×‘×“×™×§×ª API:</strong><br>
                    â€¢ âŒ ×©×’×™××ª ×—×™×‘×•×¨: ${error.message}
                </div>`;
            }
            
            // 4. Recommendations
            report += '<h3>ğŸ’¡ ×”××œ×¦×•×ª ×œ×ª×™×§×•×Ÿ:</h3>';
            
            if (!userId || !userId.startsWith('google_')) {
                report += `<div class="info">
                    <strong>ğŸ”§ ×¦×¨×™×š ×œ×ª×§×Ÿ Cookies:</strong><br>
                    1. ×œ×—×¥ ×¢×œ "× ×§×” ×•×¢×‘×•×¨ ×œ×”×ª×—×‘×¨×•×ª" ×œ××˜×”<br>
                    2. ××• ×¤×ª×—: <a href="× ×§×”-cookies-×•×”×ª×—×‘×¨-××—×“×©.html" target="_blank">× ×§×”-cookies-×•×”×ª×—×‘×¨-××—×“×©.html</a>
                </div>`;
            }
            
            if (currentPort !== '5173' && currentPort !== '5174') {
                report += `<div class="info">
                    <strong>ğŸŒ ×‘×¢×™×™×ª ×¤×•×¨×˜:</strong><br>
                    â€¢ ×”×©×¨×ª ×¨×¥ ×¢×œ ×¤×•×¨×˜ ${currentPort}<br>
                    â€¢ Google OAuth ××•×’×“×¨ ×¨×§ ×œ-5173/5174<br>
                    â€¢ ×¦×¨×™×š ×œ×”×•×¡×™×£ ${currentOrigin} ×œ-Google Console
                </div>`;
            }
            
            results.innerHTML = report;
        }
        
        async function testGoogleAuth() {
            results.innerHTML = '<div class="info">ğŸ” ×‘×•×“×§ Google OAuth...</div>';
            
            try {
                // Try to access Google Auth endpoint
                const response = await fetch('/api/auth/google');
                
                if (response.ok) {
                    results.innerHTML = '<div class="success">âœ… Google OAuth endpoint ×–××™×Ÿ</div>';
                } else {
                    results.innerHTML = `<div class="error">âŒ Google OAuth endpoint ×œ× ×–××™×Ÿ (${response.status})</div>`;
                }
            } catch (error) {
                results.innerHTML = `<div class="error">âŒ ×©×’×™××” ×‘×’×™×©×” ×œ-Google OAuth: ${error.message}</div>`;
            }
        }
        
        function clearAndRedirect() {
            // Clear all cookies
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i];
                const eqPos = cookie.indexOf("=");
                const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name.trim() + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
            }
            
            results.innerHTML = '<div class="success">âœ… Cookies × ×•×§×•! ××¤× ×” ×œ×”×ª×—×‘×¨×•×ª...</div>';
            
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        }
        
        // Initialize
        updateServerInfo();
        updateCookieInfo();
        
        // Auto-refresh cookie info every 5 seconds
        setInterval(() => {
            updateCookieInfo();
        }, 5000);
    </script>
</body>
</html>