# 🔧 תיקון העלאת תמונות מוצרים

## הבעיה שהייתה
שגיאת 500 (Internal Server Error) בהעלאת תמונות למוצרים.

**הסיבה:** הקוד ניסה לעדכן מוצר כישות נפרדת ב-Strapi, אבל המוצרים נשמרים כ-JSON בתוך הדף.

## הפתרון

### 1. עדכון ה-API Endpoint
במקום לעדכן מוצר נפרד, עכשיו הקוד:
1. מעלה תמונה ל-Strapi
2. מקבל URL של התמונה
3. שולף את הדף מ-Strapi
4. מוצא את מקטע המוצרים
5. מעדכן את התמונה של המוצר הספציפי ב-JSON
6. שומר את הדף המעודכן

### 2. הוספת pageId
הקומפוננט עכשיו מקבל את ה-`pageId` כ-prop ושולח אותו ל-API.

### 3. רענון אוטומטי
אחרי העלאה מוצלחת, הדף מתרענן אוטומטית אחרי שנייה כדי להציג את התמונה החדשה.

## מה תוקן

### קובץ: `upload-product-image/+server.js`
```javascript
// לפני: ניסה לעדכן products/${productId}
// אחרי: מעדכן את ה-JSON בתוך הדף
```

**שינויים:**
- ✅ נוסף פרמטר `pageId`
- ✅ שליפת הדף המלא
- ✅ חיפוש מקטע המוצרים
- ✅ עדכון התמונה ב-JSON
- ✅ שמירת הדף המעודכן

### קובץ: `ProductsGallerySection.svelte`
```javascript
// לפני: שלח רק productId
// אחרי: שולח productId + pageId
```

**שינויים:**
- ✅ נוסף prop `pageId`
- ✅ בדיקה ש-pageId קיים
- ✅ שליחת pageId ל-API
- ✅ רענון דף אחרי העלאה מוצלחת
- ✅ טיפול טוב יותר בשגיאות

### קובץ: `view/[slug]/+page.svelte`
```svelte
<!-- לפני -->
<ProductsGallerySection data={{...}} />

<!-- אחרי -->
<ProductsGallerySection 
  data={{...}} 
  pageId={data.page.documentId || data.page.id}
/>
```

**שינויים:**
- ✅ העברת pageId לקומפוננט

## איך זה עובד עכשיו

### תהליך העלאת תמונה:
1. **משתמש לוחץ על תמונה** → פותח file picker
2. **בוחר תמונה** → `handleImageUpload()` מופעל
3. **בדיקת pageId** → אם אין, מציג שגיאה
4. **יצירת FormData** → image + productId + pageId
5. **שליחה ל-API** → POST /api/upload-product-image
6. **API מעלה ל-Strapi** → מקבל URL
7. **API שולף דף** → GET /api/pages/{pageId}
8. **API מוצא מקטע** → sections.find(type === 'products')
9. **API מעדכן JSON** → products[i].image = newUrl
10. **API שומר דף** → PUT /api/pages/{pageId}
11. **תגובה ללקוח** → { success, imageUrl }
12. **עדכון UI** → products[i].image = imageUrl
13. **רענון דף** → window.location.reload() אחרי שנייה

## איך לבדוק

1. פתח דף עם מוצרים
2. רחף מעל תמונת מוצר
3. לחץ על התמונה
4. בחר תמונה חדשה
5. המתן להעלאה
6. תראה הודעה: "✅ התמונה הוחלפה בהצלחה"
7. הדף מתרענן אוטומטית
8. התמונה החדשה מופיעה!

## טיפול בשגיאות

### אם אין pageId:
```
❌ שגיאה: חסר מזהה דף
```

### אם העלאה נכשלה:
```
❌ שגיאה בהעלאת התמונה
```

### אם המוצר לא נמצא:
```
404: Product not found
```

### אם הדף לא נמצא:
```
404: Page not found
```

## לוגים לדיבאג

### בקונסול הדפדפן:
```
📸 Uploading image for product: 1 page: abc-123
✅ Image uploaded: { success: true, imageUrl: "..." }
```

### בקונסול השרת:
```
📸 Uploading product image: { productId: 1, pageId: "abc-123" }
✅ Image uploaded to Strapi: http://...
✅ Updating product image: 1
✅ Page updated with new product image
```

---

**סטטוס:** ✅ תוקן  
**גרסה:** 2.0 - עובד עם JSON במקום ישויות נפרדות
