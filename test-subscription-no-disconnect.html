<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ ×‘×“×™×§×ª ×× ×•×™ ×œ×œ× × ×™×ª×•×§</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { background: #d4edda; border-left: 5px solid #28a745; }
        .error { background: #f8d7da; border-left: 5px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 5px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 5px solid #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .big-button {
            background: #28a745;
            font-size: 1.2em;
            padding: 15px 30px;
            width: 100%;
            margin: 10px 0;
        }
        .big-button:hover { background: #218838; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-item {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ×‘×“×™×§×ª ×× ×•×™ ×œ×œ× × ×™×ª×•×§</h1>
    
    <div class="section info">
        <h3>ğŸ“Š ××¦×‘ ××™××•×ª × ×•×›×—×™</h3>
        <div id="auth-status">×˜×•×¢×Ÿ...</div>
    </div>
    
    <div class="section">
        <h3>ğŸ§ª ×‘×“×™×§×•×ª ××”×™×¨×•×ª</h3>
        <button onclick="simulateLogin()">ğŸ”‘ ×¡×™××•×œ×¦×™×” ×”×ª×—×‘×¨×•×ª</button>
        <button onclick="testSubscriptionAPI()">ğŸ’³ ×‘×“×•×§ API ×× ×•×™</button>
        <button onclick="testFullSubscriptionFlow()">ğŸš€ ×‘×“×•×§ ×–×¨×™××ª ×× ×•×™ ××œ××”</button>
        <div id="test-results" class="status-item">
            ×ª×•×¦××•×ª ×”×‘×“×™×§×•×ª ×™×•×¤×™×¢×• ×›××Ÿ
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ¯ ×‘×“×™×§×ª ×× ×•×™ ×œ×œ× × ×™×ª×•×§</h3>
        <button class="big-button" onclick="testNoDisconnectSubscription()">
            ğŸš€ ×‘×“×•×§ ×× ×•×™ ×œ×œ× × ×™×ª×•×§
        </button>
        <div id="subscription-results" class="status-item">
            ×ª×•×¦××•×ª ×‘×“×™×§×ª ×”×× ×•×™ ×™×•×¤×™×¢×• ×›××Ÿ
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ“‹ ×œ×•×’ ××¤×•×¨×˜</h3>
        <button onclick="clearLog()">ğŸ—‘ï¸ × ×§×” ×œ×•×’</button>
        <pre id="detailed-log">×”×œ×•×’ ×™×•×¤×™×¢ ×›××Ÿ...</pre>
    </div>

    <script>
        let logEntries = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const entry = `[${timestamp}] ${message}`;
            logEntries.push(entry);
            document.getElementById('detailed-log').textContent = logEntries.join('\n');
            console.log(entry);
        }
        
        function updateAuthStatus() {
            const status = {
                cookies: {},
                storage: {},
                memory: {}
            };
            
            // Check cookies
            try {
                const cookies = document.cookie.split('; ');
                status.cookies.userId = cookies.find(c => c.startsWith('userId='))?.split('=')[1] || null;
                status.cookies.userAuth = cookies.find(c => c.startsWith('userAuth='))?.split('=')[1] || null;
                status.cookies.user_id = cookies.find(c => c.startsWith('user_id='))?.split('=')[1] || null;
            } catch (error) {
                status.cookies.error = error.message;
            }
            
            // Check sessionStorage
            try {
                status.storage.sessionStorage = sessionStorage.getItem('userId');
            } catch (error) {
                status.storage.sessionStorageError = error.message;
            }
            
            // Check localStorage
            try {
                status.storage.localStorage = localStorage.getItem('userId');
            } catch (error) {
                status.storage.localStorageError = error.message;
            }
            
            // Check memory
            try {
                status.memory.autoPageUserId = window._autoPageUserId;
                status.memory.autoPageAuth = window.autoPageAuth?.userId;
            } catch (error) {
                status.memory.error = error.message;
            }
            
            // Find best userId
            const userId = status.cookies.userId || 
                          status.cookies.userAuth || 
                          status.cookies.user_id ||
                          status.storage.sessionStorage ||
                          status.storage.localStorage ||
                          status.memory.autoPageUserId ||
                          status.memory.autoPageAuth;
            
            document.getElementById('auth-status').innerHTML = `
                <strong>ğŸª Cookies:</strong><br>
                &nbsp;&nbsp;userId: ${status.cookies.userId || 'âŒ'}<br>
                &nbsp;&nbsp;userAuth: ${status.cookies.userAuth || 'âŒ'}<br>
                &nbsp;&nbsp;user_id: ${status.cookies.user_id || 'âŒ'}<br>
                <strong>ğŸ’¾ Storage:</strong><br>
                &nbsp;&nbsp;sessionStorage: ${status.storage.sessionStorage || (status.storage.sessionStorageError ? 'ğŸš« ' + status.storage.sessionStorageError : 'âŒ')}<br>
                &nbsp;&nbsp;localStorage: ${status.storage.localStorage || (status.storage.localStorageError ? 'ğŸš« ' + status.storage.localStorageError : 'âŒ')}<br>
                <strong>ğŸ§  Memory:</strong><br>
                &nbsp;&nbsp;_autoPageUserId: ${status.memory.autoPageUserId || 'âŒ'}<br>
                &nbsp;&nbsp;autoPageAuth: ${status.memory.autoPageAuth || 'âŒ'}<br>
                <strong>ğŸ¯ Best userId:</strong> ${userId ? 'âœ… ' + userId : 'âŒ ×œ× × ××¦×'}
            `;
            
            return userId;
        }
        
        function simulateLogin() {
            log('ğŸ”‘ ××“××” ×”×ª×—×‘×¨×•×ª...');
            const testUserId = 'google_111351120503275674259';
            
            // Set cookies
            document.cookie = `userId=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
            document.cookie = `userAuth=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
            document.cookie = `user_id=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
            
            // Set storage
            try {
                sessionStorage.setItem('userId', testUserId);
                localStorage.setItem('userId', testUserId);
            } catch (e) {
                log('âš ï¸ Could not set storage: ' + e.message);
            }
            
            // Set memory
            window._autoPageUserId = testUserId;
            window.autoPageAuth = { userId: testUserId, timestamp: Date.now() };
            
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = `âœ… ×”×ª×—×‘×¨×•×ª ×¡×•××œ×¦×” ×‘×”×¦×œ×—×”! User ID: ${testUserId}`;
            resultsDiv.className = 'status-item success';
            
            log(`âœ… Login simulated with userId: ${testUserId}`);
            updateAuthStatus();
        }
        
        async function testSubscriptionAPI() {
            log('ğŸ’³ ×‘×•×“×§ API ×× ×•×™...');
            const resultsDiv = document.getElementById('test-results');
            
            const userId = updateAuthStatus();
            if (!userId) {
                resultsDiv.innerHTML = 'âŒ ××™×Ÿ userId ×–××™×Ÿ - ×”×¨×¥ ×¡×™××•×œ×¦×™×” ×”×ª×—×‘×¨×•×ª ×§×•×“×';
                resultsDiv.className = 'status-item error';
                return;
            }
            
            try {
                const response = await fetch('/api/subscription/activate-page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify({
                        documentId: 'test-page-id',
                        userId: userId,
                        months: 1
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultsDiv.innerHTML = `âœ… API ×× ×•×™ ×¢×•×‘×“! Status: ${response.status}`;
                    resultsDiv.className = 'status-item success';
                    log('âœ… Subscription API test passed');
                } else {
                    // Check if it's the new error format (no logout)
                    if (result.needsRefresh && result.keepSession) {
                        resultsDiv.innerHTML = `
                            âœ… API ×”×—×–×™×¨ ×©×’×™××” ××‘×œ ×œ× ×× ×ª×§!<br>
                            ğŸ“„ Status: ${response.status} (×œ× 401)<br>
                            ğŸ“„ Error: ${result.error}<br>
                            ğŸ”„ needsRefresh: ${result.needsRefresh}<br>
                            ğŸ”’ keepSession: ${result.keepSession}
                        `;
                        resultsDiv.className = 'status-item success';
                        log(`âœ… API returned error but won't cause logout: ${result.error}`);
                    } else {
                        resultsDiv.innerHTML = `
                            âš ï¸ API ×”×—×–×™×¨ ×©×’×™××”:<br>
                            ğŸ“„ Status: ${response.status}<br>
                            ğŸ“„ Error: ${result.error || 'Unknown error'}<br>
                            ğŸ” needsLogin: ${result.needsLogin}<br>
                            ğŸ” keepSession: ${result.keepSession}
                        `;
                        resultsDiv.className = 'status-item warning';
                        log(`âš ï¸ API returned error: ${result.error}`);
                    }
                }
            } catch (error) {
                resultsDiv.innerHTML = `âŒ ×©×’×™××” ×‘×§×¨×™××” ×œ-API: ${error.message}`;
                resultsDiv.className = 'status-item error';
                log(`âŒ API call failed: ${error.message}`);
            }
        }
        
        async function testFullSubscriptionFlow() {
            log('ğŸš€ ×‘×•×“×§ ×–×¨×™××ª ×× ×•×™ ××œ××”...');
            
            // Step 1: Simulate login
            simulateLogin();
            
            // Step 2: Test API after short delay
            setTimeout(async () => {
                await testSubscriptionAPI();
                
                // Step 3: Check if we're still logged in
                setTimeout(() => {
                    const userId = updateAuthStatus();
                    const resultsDiv = document.getElementById('test-results');
                    
                    if (userId) {
                        resultsDiv.innerHTML += '<br><br>âœ… ×¢×“×™×™×Ÿ ××—×•×‘×¨ ××—×¨×™ ×‘×“×™×§×ª API!';
                        log('âœ… Still logged in after API test');
                    } else {
                        resultsDiv.innerHTML += '<br><br>âŒ ×”×ª× ×ª×§ ××—×¨×™ ×‘×“×™×§×ª API!';
                        log('âŒ Got disconnected after API test');
                    }
                }, 1000);
            }, 500);
        }
        
        async function testNoDisconnectSubscription() {
            log('ğŸš€ ××¨×™×¥ ×‘×“×™×§×ª ×× ×•×™ ×œ×œ× × ×™×ª×•×§...');
            const resultsDiv = document.getElementById('subscription-results');
            
            resultsDiv.innerHTML = 'â³ ×‘×•×“×§ ×× ×•×™... ×× × ×”××ª×Ÿ';
            resultsDiv.className = 'status-item info';
            
            // Step 1: Ensure we have userId
            let userId = updateAuthStatus();
            if (!userId) {
                log('âš ï¸ No userId found, simulating login first');
                simulateLogin();
                userId = updateAuthStatus();
            }
            
            if (!userId) {
                resultsDiv.innerHTML = 'âŒ ×œ× × ×™×ª×Ÿ ×œ×§×‘×œ userId - ×‘×“×•×§ ××ª ×”×’×“×¨×•×ª ×”×“×¤×“×¤×Ÿ';
                resultsDiv.className = 'status-item error';
                return;
            }
            
            log(`ğŸ“„ Testing subscription with userId: ${userId}`);
            
            // Step 2: Test subscription API with error simulation
            try {
                // First test with missing pageId to trigger error
                const response = await fetch('/api/subscription/activate-page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify({
                        // Missing documentId to trigger error
                        userId: userId,
                        months: 1
                    })
                });
                
                const result = await response.json();
                
                // Check if we're still logged in after the API call
                const userIdAfter = updateAuthStatus();
                
                if (userIdAfter) {
                    resultsDiv.innerHTML = `
                        ğŸ‰ ×‘×“×™×§×ª ×× ×•×™ ×œ×œ× × ×™×ª×•×§ ×”×•×©×œ××” ×‘×”×¦×œ×—×”!<br><br>
                        <strong>âœ… ×ª×•×¦××•×ª:</strong><br>
                        1. âœ… API × ×§×¨× (Status: ${response.status})<br>
                        2. âœ… ×¢×“×™×™×Ÿ ××—×•×‘×¨ ××—×¨×™ ×”×©×’×™××”<br>
                        3. âœ… ×œ× ×”×•×¤× ×” ×œ×”×ª×—×‘×¨×•×ª<br>
                        4. âœ… userId × ×©××¨: ${userIdAfter}<br><br>
                        <strong>ğŸ“Š ×ª×’×•×‘×ª API:</strong><br>
                        Error: ${result.error}<br>
                        needsRefresh: ${result.needsRefresh}<br>
                        keepSession: ${result.keepSession}<br><br>
                        <strong>ğŸ¯ ×”××¡×§× ×”:</strong> ×”××¢×¨×›×ª ×œ× ×× ×ª×§×ª ×™×•×ª×¨!
                    `;
                    resultsDiv.className = 'status-item success';
                    log('ğŸ‰ No disconnect test PASSED - user stays logged in');
                } else {
                    resultsDiv.innerHTML = `
                        âŒ ×‘×“×™×§×ª ×× ×•×™ ×œ×œ× × ×™×ª×•×§ × ×›×©×œ×”!<br><br>
                        <strong>âŒ ×‘×¢×™×”:</strong> ×”××©×ª××© ×”×ª× ×ª×§ ××—×¨×™ ×§×¨×™××ª API<br>
                        <strong>ğŸ“Š API Status:</strong> ${response.status}<br>
                        <strong>ğŸ“Š API Response:</strong> ${JSON.stringify(result, null, 2)}<br><br>
                        <strong>ğŸ’¡ ×¤×ª×¨×•×Ÿ:</strong> ×¦×¨×™×š ×œ×ª×§×Ÿ ××ª ×”×§×•×“ × ×•×¡×£
                    `;
                    resultsDiv.className = 'status-item error';
                    log('âŒ No disconnect test FAILED - user got disconnected');
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×× ×•×™:<br><br>
                    <strong>Error:</strong> ${error.message}<br>
                    <strong>ğŸ’¡ ×”×¦×¢×”:</strong> ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×•× ×¡×” ×©×•×‘
                `;
                resultsDiv.className = 'status-item error';
                log(`âŒ Subscription test error: ${error.message}`);
            }
        }
        
        function clearLog() {
            logEntries = [];
            document.getElementById('detailed-log').textContent = '×”×œ×•×’ × ×•×§×”...';
        }
        
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×›×œ 3 ×©× ×™×•×ª
        setInterval(updateAuthStatus, 3000);
        
        // ×¢×“×›×•×Ÿ ×¨××©×•× ×™
        updateAuthStatus();
        log('ğŸ”§ No Disconnect Subscription Test Page Loaded');
    </script>
</body>
</html>