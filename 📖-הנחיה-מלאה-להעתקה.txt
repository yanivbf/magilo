════════════════════════════════════════════════════════════════════════
  📖 הנחיה מלאה - Marketplace Bot
════════════════════════════════════════════════════════════════════════

🎯 3 צעדים פשוטים ב-n8n:

1️⃣ Google Gemini Chat Node → System Message
2️⃣ Google Gemini Chat Node → User Message
3️⃣ Code Node → JavaScript Code

════════════════════════════════════════════════════════════════════════


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1️⃣ System Message (Google Gemini Node)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

בחר הכל מכאן ⬇️ ועד הקו הבא והעתק:

אתה בוט עוזר למרקטפלייס של דפים.

תפקידך:
1. לקרוא מה המשתמש שאל
2. לחפש דף מתאים ברשימת הדפים הזמינים
3. אם הדף בקטגוריה אחרת - לעבור אליה
4. אם הדף בקטגוריה הנוכחית - לגלול אליו
5. אם אין דף מתאים - להגיד שלא מצאת

דוגמאות לתשובות:

דוגמה 1 - משתמש מחפש "שוקולד" ויש חנות שוקולד בקטגוריית store אבל הוא ב-landing:
{"message":"🍫 מצאתי חנות שוקולד! עובר לקטגוריית החנויות...","action":"change_category","category":"store"}

דוגמה 2 - משתמש מחפש "שוקולד" והוא כבר בקטגוריה הנכונה:
{"message":"✨ מצאתי! הנה חנות השוקולד","action":"scroll_to_page","page_id":"1760122549721_שוקולד_html"}

דוגמה 3 - לא נמצא דף מתאים:
{"message":"😕 לא מצאתי דף מתאים","action":"none"}

חוקים:
- תחזיר רק JSON, ללא ``` ללא markdown
- העתק את ה-ID של הדף בדיוק כמו שהוא מופיע
- פעולות אפשריות: none, change_category, scroll_to_page
- אם אתה מחזיר change_category תוסיף "category": "store/landing/course/portfolio/all"
- אם אתה מחזיר scroll_to_page תוסיף "page_id": "המזהה_המדויק"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ עצור פה! הדבק את מה שהעתקת ב-System Message
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
2️⃣ User Message / Prompt (Google Gemini Node)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

בחר הכל מכאן ⬇️ ועד הקו הבא והעתק:

הקטגוריה הנוכחית: {{ $json.current_category }}

רשימת כל הדפים הזמינים:
{{ $json.available_pages_text }}

המשתמש שאל: {{ $json.user_message }}

---

עכשיו חפש דף מתאים והחזר JSON בפורמט:
{"message":"ההודעה למשתמש","action":"none או change_category או scroll_to_page"}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ עצור פה! הדבק את מה שהעתקת ב-User Message
⚠️ אל תשנה את {{ }} - n8n יחליף אוטומטית!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
3️⃣ Code Node (JavaScript)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

בחר הכל מכאן ⬇️ ועד הקו הבא והעתק:

// קוד פשוט - בדיוק כמו הבוט בדפים!
// מחזיר רק message ו-action

const aiResponse = $input.item.json.output || $input.item.json.message || $input.item.json;

let result;

try {
  if (typeof aiResponse === 'string') {
    // נקה markdown
    const clean = aiResponse
      .replace(/```json/g, '')
      .replace(/```/g, '')
      .replace(/\\n/g, '')
      .replace(/\n/g, '')
      .trim();
    
    result = JSON.parse(clean);
  } else {
    result = aiResponse;
  }
} catch (e) {
  // fallback
  result = {
    message: 'סליחה, לא הבנתי...',
    action: 'none'
  };
}

// החזר בדיוק כמו הבוט בדפים
return {
  json: {
    message: result.message || 'סליחה, לא הבנתי...',
    action: result.action || 'none',
    category: result.category,
    page_id: result.page_id
  }
};

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ עצור פה! הדבק את מה שהעתקת ב-Code Node
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


════════════════════════════════════════════════════════════════════════
⚙️ הגדרות נוספות ב-n8n
════════════════════════════════════════════════════════════════════════

Google Gemini Chat Node:
┌────────────────────────────────────────┐
│ Model: gemini-1.5-flash               │
│ Temperature: 0.3                      │
│ Response Format: json ⚠️ חשוב מאוד!  │
└────────────────────────────────────────┘


════════════════════════════════════════════════════════════════════════
🔗 סדר הצמתים ב-n8n
════════════════════════════════════════════════════════════════════════

[Webhook]
    ↓
    קבלת בקשה מהמרקטפלייס
    ↓
[Google Gemini Chat]
    ├─ System Message: (העתקת מסעיף 1️⃣)
    └─ User Message: (העתקת מסעיף 2️⃣)
    ↓
    הבוט חושב ומחזיר תשובה
    ↓
[Code Node]
    └─ Code: (העתקת מסעיף 3️⃣)
    ↓
    ניקוי התשובה מ-markdown
    ↓
[Respond to Webhook]
    ↓
    שליחה חזרה למרקטפלייס


════════════════════════════════════════════════════════════════════════
🧪 בדיקה
════════════════════════════════════════════════════════════════════════

1. שמור את ה-Workflow ב-n8n
2. פתח את המרקטפלייס בדפדפן
3. פתח Console (לחץ F12)
4. שלח הודעה לבוט: "שוקולד"

תוצאה צפויה:
✅ הבוט עונה: "🍫 מצאתי חנות שוקולד! עובר לקטגוריית החנויות..."
✅ המרקטפלייס עובר לקטגוריית החנויות
✅ אם יש דף שוקולד - הוא גולל אליו


════════════════════════════════════════════════════════════════════════
❓ שאלות נפוצות
════════════════════════════════════════════════════════════════════════

ש: מה זה {{ $json.user_message }}?
ת: זה משתנה של n8n. אל תשנה אותו! n8n יחליף אוטומטית ל-"שוקולד"

ש: הבוט מחזיר markdown?
ת: בדוק ש-Response Format מוגדר ל-json (לא text!)

ש: הבוט לא מוצא דפים?
ת: בדוק ב-Console של הדפדפן מה מגיע ב-available_pages_text

ש: איפה אני רואה שגיאות?
ת: ב-n8n Execution Log + Console של הדפדפן (F12)


════════════════════════════════════════════════════════════════════════
✅ סיימת!
════════════════════════════════════════════════════════════════════════

עכשיו יש לך בוט מרקטפלייס חכם שעובד בדיוק כמו הבוט בדפים!

פשוט, ישיר, עובד! 🚀


