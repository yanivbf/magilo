<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×“×™×§×ª × ×™×•×•×˜ ×•××™××•×ª - Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 20px; border: 2px solid #e0e0e0; border-radius: 8px; }
        .success { border-color: #4CAF50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .warning { border-color: #ff9800; background: #fff8f0; }
        button { padding: 12px 24px; margin: 10px 5px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 14px; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 4px; display: inline-block; margin: 5px 0; }
        .status.online { background: #4CAF50; color: white; }
        .status.offline { background: #f44336; color: white; }
        .log { max-height: 300px; overflow-y: auto; background: #000; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ×‘×“×™×§×ª ×‘×¢×™×™×ª × ×™×•×•×˜ ×•××™××•×ª</h1>
        <p><strong>×‘×¢×™×”:</strong> ××©×ª××© ××ª×—×‘×¨ ×‘×”×¦×œ×—×”, × ×›× ×¡ ×œ×¢×•×¨×š, ××‘×œ ×›×©×—×•×–×¨ ×œ×“×©×‘×•×¨×“ ×”×•× ××ª× ×ª×§</p>
        
        <div class="test-section">
            <h2>ğŸ“Š ××¦×‘ × ×•×›×—×™</h2>
            <div id="currentStatus">×˜×•×¢×Ÿ...</div>
        </div>
        
        <div class="test-section">
            <h2>ğŸª ×‘×“×™×§×ª Cookies</h2>
            <div id="cookieStatus">×˜×•×¢×Ÿ...</div>
            <button class="btn-primary" onclick="checkCookies()">×¨×¢× ×Ÿ ×‘×“×™×§×ª Cookies</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”„ ×‘×“×™×§×ª API ××™××•×ª</h2>
            <div id="apiStatus">×˜×•×¢×Ÿ...</div>
            <button class="btn-primary" onclick="checkAuthAPI()">×‘×“×•×§ API ××™××•×ª</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ§ª ×¡×™××•×œ×¦×™×™×ª ×”×‘×¢×™×”</h2>
            <p>× ×¡×” ×œ×©×—×–×¨ ××ª ×”×‘×¢×™×”:</p>
            <button class="btn-success" onclick="simulateLogin()">1. ×”×ª×—×‘×¨ (×¡×™××•×œ×¦×™×”)</button>
            <button class="btn-warning" onclick="simulateEditorNavigation()">2. × ×•×•×˜ ×œ×¢×•×¨×š</button>
            <button class="btn-danger" onclick="simulateDashboardNavigation()">3. ×—×–×•×¨ ×œ×“×©×‘×•×¨×“</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“ ×œ×•×’ ×‘×“×™×§×•×ª</h2>
            <div id="testLog" class="log"></div>
            <button class="btn-primary" onclick="clearLog()">× ×§×” ×œ×•×’</button>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”§ ×¤×ª×¨×•× ×•×ª ××•×¦×¢×™×</h2>
            <button class="btn-success" onclick="testFix1()">×ª×™×§×•×Ÿ 1: Cookie Scope</button>
            <button class="btn-success" onclick="testFix2()">×ª×™×§×•×Ÿ 2: Auth Store</button>
            <button class="btn-success" onclick="testFix3()">×ª×™×§×•×Ÿ 3: Navigation</button>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('testLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44' : type === 'success' ? '#4f4' : type === 'warning' ? '#fa4' : '#0f0';
            logElement.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            logElement.innerHTML = '';
        }
        
        async function checkCurrentStatus() {
            log('ğŸ” ×‘×•×“×§ ××¦×‘ × ×•×›×—×™...');
            
            // Check if servers are running
            try {
                const frontendResponse = await fetch('http://localhost:5173/api/user/current');
                const backendResponse = await fetch('http://localhost:1337/api/users/me');
                
                document.getElementById('currentStatus').innerHTML = `
                    <div class="status ${frontendResponse.ok ? 'online' : 'offline'}">
                        Frontend (5173): ${frontendResponse.ok ? '×¤×•×¢×œ' : '×œ× ×¤×•×¢×œ'}
                    </div>
                    <div class="status ${backendResponse.ok ? 'online' : 'offline'}">
                        Backend (1337): ${backendResponse.ok ? '×¤×•×¢×œ' : '×œ× ×¤×•×¢×œ'}
                    </div>
                `;
                
                log(`Frontend: ${frontendResponse.ok ? 'âœ… ×¤×•×¢×œ' : 'âŒ ×œ× ×¤×•×¢×œ'}`, frontendResponse.ok ? 'success' : 'error');
                log(`Backend: ${backendResponse.ok ? 'âœ… ×¤×•×¢×œ' : 'âŒ ×œ× ×¤×•×¢×œ'}`, backendResponse.ok ? 'success' : 'error');
                
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×©×¨×ª×™×: ${error.message}`, 'error');
                document.getElementById('currentStatus').innerHTML = '<div class="status offline">×©×’×™××” ×‘×‘×“×™×§×ª ×©×¨×ª×™×</div>';
            }
        }
        
        function checkCookies() {
            log('ğŸª ×‘×•×“×§ cookies...');
            
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                acc[key] = value;
                return acc;
            }, {});
            
            const userId = cookies.userId;
            const subscriptionStatus = cookies.subscriptionStatus;
            
            let cookieHtml = '<h3>Cookies × ×•×›×—×™×™×:</h3><pre>';
            cookieHtml += JSON.stringify(cookies, null, 2);
            cookieHtml += '</pre>';
            
            if (userId) {
                cookieHtml += `<div class="status online">userId: ${userId}</div>`;
                log(`âœ… userId cookie × ××¦×: ${userId}`, 'success');
            } else {
                cookieHtml += `<div class="status offline">userId: ×œ× × ××¦×</div>`;
                log(`âŒ userId cookie ×œ× × ××¦×`, 'error');
            }
            
            if (subscriptionStatus) {
                cookieHtml += `<div class="status online">subscriptionStatus: ${subscriptionStatus}</div>`;
                log(`âœ… subscriptionStatus: ${subscriptionStatus}`, 'success');
            }
            
            document.getElementById('cookieStatus').innerHTML = cookieHtml;
        }
        
        async function checkAuthAPI() {
            log('ğŸ”„ ×‘×•×“×§ API ××™××•×ª...');
            
            try {
                const response = await fetch('/api/user/current');
                const data = await response.json();
                
                let apiHtml = `<h3>×ª×’×•×‘×ª API:</h3>`;
                apiHtml += `<div class="status ${response.ok ? 'online' : 'offline'}">Status: ${response.status}</div>`;
                apiHtml += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                document.getElementById('apiStatus').innerHTML = apiHtml;
                
                if (response.ok && data.authenticated) {
                    log(`âœ… API ××™××•×ª: ××©×ª××© ××—×•×‘×¨ (${data.userId})`, 'success');
                } else {
                    log(`âŒ API ××™××•×ª: ××©×ª××© ×œ× ××—×•×‘×¨`, 'error');
                }
                
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘-API ××™××•×ª: ${error.message}`, 'error');
                document.getElementById('apiStatus').innerHTML = `<div class="status offline">×©×’×™××”: ${error.message}</div>`;
            }
        }
        
        function simulateLogin() {
            log('ğŸ” ××“××” ×”×ª×—×‘×¨×•×ª...');
            
            // Set a test userId cookie
            const testUserId = 'google_test_' + Date.now();
            document.cookie = `userId=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
            
            log(`âœ… Cookie × ×•×¦×¨: userId=${testUserId}`, 'success');
            checkCookies();
        }
        
        function simulateEditorNavigation() {
            log('ğŸ“ ××“××” × ×™×•×•×˜ ×œ×¢×•×¨×š...');
            
            // Check if userId still exists
            const userId = document.cookie.split(';').find(c => c.trim().startsWith('userId='));
            
            if (userId) {
                log(`âœ… ×‘×¢×•×¨×š: userId ×¢×“×™×™×Ÿ ×§×™×™× (${userId.split('=')[1]})`, 'success');
            } else {
                log(`âŒ ×‘×¢×•×¨×š: userId × ×¢×œ×!`, 'error');
            }
        }
        
        function simulateDashboardNavigation() {
            log('ğŸ  ××“××” × ×™×•×•×˜ ×œ×“×©×‘×•×¨×“...');
            
            // This is where the problem occurs - check auth state
            const userId = document.cookie.split(';').find(c => c.trim().startsWith('userId='));
            
            if (userId) {
                log(`âœ… ×‘×“×©×‘×•×¨×“: userId ×¢×“×™×™×Ÿ ×§×™×™× (${userId.split('=')[1]})`, 'success');
                log(`ğŸ” ×‘×•×“×§ ×× ×”×‘×¢×™×” ×”×™× ×‘-auth store ××• ×‘-dashboard component...`, 'warning');
            } else {
                log(`âŒ ×‘×“×©×‘×•×¨×“: userId × ×¢×œ×! ×–×• ×”×‘×¢×™×”!`, 'error');
            }
            
            checkAuthAPI();
        }
        
        function testFix1() {
            log('ğŸ”§ ×‘×•×“×§ ×ª×™×§×•×Ÿ 1: Cookie Scope...');
            
            // Test cookie with explicit path and domain
            const testUserId = 'google_fix1_' + Date.now();
            document.cookie = `userId=${testUserId}; path=/; domain=localhost; max-age=2592000; SameSite=Lax; Secure=false`;
            
            log(`âœ… Cookie ×¢× scope ××¤×•×¨×© × ×•×¦×¨: ${testUserId}`, 'success');
            
            setTimeout(() => {
                const cookie = document.cookie.split(';').find(c => c.trim().startsWith('userId='));
                if (cookie && cookie.includes(testUserId)) {
                    log(`âœ… ×ª×™×§×•×Ÿ 1: Cookie × ×©××¨ ×‘×”×¦×œ×—×”`, 'success');
                } else {
                    log(`âŒ ×ª×™×§×•×Ÿ 1: Cookie ×œ× × ×©××¨`, 'error');
                }
            }, 1000);
        }
        
        function testFix2() {
            log('ğŸ”§ ×‘×•×“×§ ×ª×™×§×•×Ÿ 2: Auth Store...');
            
            // Test localStorage as backup
            const testUserId = 'google_fix2_' + Date.now();
            localStorage.setItem('userId', testUserId);
            document.cookie = `userId=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
            
            log(`âœ… userId × ×©××¨ ×’× ×‘-localStorage ×•×’× ×‘-cookie`, 'success');
            
            // Test retrieval
            const cookieUserId = document.cookie.split(';').find(c => c.trim().startsWith('userId='))?.split('=')[1];
            const localStorageUserId = localStorage.getItem('userId');
            
            if (cookieUserId === testUserId && localStorageUserId === testUserId) {
                log(`âœ… ×ª×™×§×•×Ÿ 2: ×©× ×™ ×”××§×•×¨×•×ª ×¢×•×‘×“×™×`, 'success');
            } else {
                log(`âŒ ×ª×™×§×•×Ÿ 2: ×‘×¢×™×” ×‘××—×“ ×”××§×•×¨×•×ª`, 'error');
            }
        }
        
        function testFix3() {
            log('ğŸ”§ ×‘×•×“×§ ×ª×™×§×•×Ÿ 3: Navigation...');
            
            // Test different navigation methods
            log(`ğŸ” ×‘×•×“×§ ×©×™×˜×•×ª × ×™×•×•×˜ ×©×•× ×•×ª:`, 'info');
            log(`   - goto('/dashboard') - SvelteKit client-side routing`, 'info');
            log(`   - window.location.href = '/dashboard' - Full page reload`, 'info');
            log(`   - history.pushState() - Manual history manipulation`, 'info');
            
            log(`ğŸ’¡ ×”××œ×¦×”: ×œ×”×©×ª××© ×‘-goto ×¢× replaceState ××• ×œ×•×•×“× ×©×”-auth store ××ª×¢×“×›×Ÿ ×œ×¤× ×™ ×”× ×™×•×•×˜`, 'warning');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ ××ª×—×™×œ ×‘×“×™×§×ª × ×™×•×•×˜ ×•××™××•×ª...');
            checkCurrentStatus();
            checkCookies();
            checkAuthAPI();
        });
    </script>
</body>
</html>