<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ ×‘×“×™×§×ª ×ª×™×§×•×Ÿ localStorage Security</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { background: #d4edda; border-left: 5px solid #28a745; }
        .error { background: #f8d7da; border-left: 5px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 5px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 5px solid #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .big-button {
            background: #28a745;
            font-size: 1.2em;
            padding: 15px 30px;
            width: 100%;
            margin: 10px 0;
        }
        .big-button:hover { background: #218838; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-item {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ×‘×“×™×§×ª ×ª×™×§×•×Ÿ localStorage Security</h1>
    
    <div class="section info">
        <h3>ğŸ“Š ××¦×‘ Storage × ×•×›×—×™</h3>
        <div id="storage-status">×˜×•×¢×Ÿ...</div>
    </div>
    
    <div class="section">
        <h3>ğŸ§ª ×‘×“×™×§×•×ª Storage</h3>
        <div class="grid">
            <div>
                <button onclick="testLocalStorage()">ğŸ’¾ ×‘×“×•×§ localStorage</button>
                <button onclick="testSessionStorage()">ğŸ”„ ×‘×“×•×§ sessionStorage</button>
                <button onclick="testMemoryStorage()">ğŸ§  ×‘×“×•×§ Memory Storage</button>
            </div>
            <div>
                <button onclick="testCookies()">ğŸª ×‘×“×•×§ Cookies</button>
                <button onclick="testAllMethods()">ğŸ”¬ ×‘×“×•×§ ×›×œ ×”×©×™×˜×•×ª</button>
                <button onclick="simulateAuthFlow()">ğŸ”‘ ×¡×™××•×œ×¦×™×” ×”×ª×—×‘×¨×•×ª</button>
            </div>
        </div>
        <div id="storage-results" class="status-item">
            ×ª×•×¦××•×ª ×‘×“×™×§×•×ª ×”-Storage ×™×•×¤×™×¢×• ×›××Ÿ
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ› ï¸ ×›×œ×™ ×ª×™×§×•×Ÿ</h3>
        <div class="grid">
            <div>
                <button onclick="setTestUser()">ğŸ‘¤ ×”×’×“×¨ ××©×ª××© ×‘×“×™×§×”</button>
                <button onclick="clearAllStorage()">ğŸ—‘ï¸ × ×§×” ×›×œ ×”-Storage</button>
                <button onclick="migrateToSafeStorage()">ğŸ”„ ×”×¢×‘×¨ ×œ-Storage ×‘×˜×•×—</button>
            </div>
            <div>
                <button onclick="testSubscriptionFlow()">ğŸ’³ ×‘×“×•×§ ×–×¨×™××ª ×× ×•×™</button>
                <button onclick="debugStorageIssues()">ğŸ› ×“×‘×’ ×‘×¢×™×•×ª Storage</button>
                <button onclick="forceRecovery()">âš¡ ×©×—×–×•×¨ ×‘×›×•×—</button>
            </div>
        </div>
        <div id="fix-results" class="status-item">
            ×ª×•×¦××•×ª ×›×œ×™ ×”×ª×™×§×•×Ÿ ×™×•×¤×™×¢×• ×›××Ÿ
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ“‹ ×œ×•×’ ××¤×•×¨×˜</h3>
        <button onclick="clearLog()">ğŸ—‘ï¸ × ×§×” ×œ×•×’</button>
        <pre id="detailed-log">×”×œ×•×’ ×™×•×¤×™×¢ ×›××Ÿ...</pre>
    </div>

    <script>
        let logEntries = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const entry = `[${timestamp}] ${message}`;
            logEntries.push(entry);
            document.getElementById('detailed-log').textContent = logEntries.join('\n');
            console.log(entry);
        }
        
        function updateStorageStatus() {
            const status = {
                localStorage: 'unknown',
                sessionStorage: 'unknown',
                memoryStorage: 'unknown',
                cookies: 'unknown'
            };
            
            // Test localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                status.localStorage = 'âœ… ×–××™×Ÿ';
            } catch (error) {
                status.localStorage = 'âŒ ×—×¡×•×: ' + error.message;
            }
            
            // Test sessionStorage
            try {
                sessionStorage.setItem('test', 'test');
                sessionStorage.removeItem('test');
                status.sessionStorage = 'âœ… ×–××™×Ÿ';
            } catch (error) {
                status.sessionStorage = 'âŒ ×—×¡×•×: ' + error.message;
            }
            
            // Test memory storage
            try {
                window._testMemory = 'test';
                delete window._testMemory;
                status.memoryStorage = 'âœ… ×–××™×Ÿ';
            } catch (error) {
                status.memoryStorage = 'âŒ ×—×¡×•×: ' + error.message;
            }
            
            // Test cookies
            try {
                document.cookie = 'test=test';
                const cookieExists = document.cookie.includes('test=test');
                document.cookie = 'test=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                status.cookies = cookieExists ? 'âœ… ×–××™×Ÿ' : 'âš ï¸ ××•×’×‘×œ';
            } catch (error) {
                status.cookies = 'âŒ ×—×¡×•×: ' + error.message;
            }
            
            document.getElementById('storage-status').innerHTML = `
                <strong>ğŸ’¾ localStorage:</strong> ${status.localStorage}<br>
                <strong>ğŸ”„ sessionStorage:</strong> ${status.sessionStorage}<br>
                <strong>ğŸ§  Memory Storage:</strong> ${status.memoryStorage}<br>
                <strong>ğŸª Cookies:</strong> ${status.cookies}<br>
                <strong>ğŸ•’ ×–××Ÿ:</strong> ${new Date().toLocaleString('he-IL')}
            `;
        }
        
        function testLocalStorage() {
            log('ğŸ’¾ ×‘×•×“×§ localStorage...');
            const resultsDiv = document.getElementById('storage-results');
            
            try {
                const testValue = 'test-' + Date.now();
                localStorage.setItem('testKey', testValue);
                const retrieved = localStorage.getItem('testKey');
                localStorage.removeItem('testKey');
                
                if (retrieved === testValue) {
                    resultsDiv.innerHTML = 'âœ… localStorage ×¢×•×‘×“ ×ª×§×™×Ÿ!';
                    resultsDiv.className = 'status-item success';
                    log('âœ… localStorage test passed');
                    return true;
                } else {
                    resultsDiv.innerHTML = 'âŒ localStorage ×œ× ××—×–×™×¨ × ×ª×•× ×™× × ×›×•× ×™×';
                    resultsDiv.className = 'status-item error';
                    log('âŒ localStorage data mismatch');
                    return false;
                }
            } catch (error) {
                resultsDiv.innerHTML = `âŒ localStorage ×—×¡×•×: ${error.message}`;
                resultsDiv.className = 'status-item error';
                log(`âŒ localStorage blocked: ${error.message}`);
                return false;
            }
        }
        
        function testSessionStorage() {
            log('ğŸ”„ ×‘×•×“×§ sessionStorage...');
            const resultsDiv = document.getElementById('storage-results');
            
            try {
                const testValue = 'test-' + Date.now();
                sessionStorage.setItem('testKey', testValue);
                const retrieved = sessionStorage.getItem('testKey');
                sessionStorage.removeItem('testKey');
                
                if (retrieved === testValue) {
                    resultsDiv.innerHTML = 'âœ… sessionStorage ×¢×•×‘×“ ×ª×§×™×Ÿ!';
                    resultsDiv.className = 'status-item success';
                    log('âœ… sessionStorage test passed');
                    return true;
                } else {
                    resultsDiv.innerHTML = 'âŒ sessionStorage ×œ× ××—×–×™×¨ × ×ª×•× ×™× × ×›×•× ×™×';
                    resultsDiv.className = 'status-item error';
                    log('âŒ sessionStorage data mismatch');
                    return false;
                }
            } catch (error) {
                resultsDiv.innerHTML = `âŒ sessionStorage ×—×¡×•×: ${error.message}`;
                resultsDiv.className = 'status-item error';
                log(`âŒ sessionStorage blocked: ${error.message}`);
                return false;
            }
        }
        
        function testMemoryStorage() {
            log('ğŸ§  ×‘×•×“×§ Memory Storage...');
            const resultsDiv = document.getElementById('storage-results');
            
            try {
                const testValue = 'test-' + Date.now();
                window._testMemoryStorage = testValue;
                const retrieved = window._testMemoryStorage;
                delete window._testMemoryStorage;
                
                if (retrieved === testValue) {
                    resultsDiv.innerHTML = 'âœ… Memory Storage ×¢×•×‘×“ ×ª×§×™×Ÿ!';
                    resultsDiv.className = 'status-item success';
                    log('âœ… Memory storage test passed');
                    return true;
                } else {
                    resultsDiv.innerHTML = 'âŒ Memory Storage ×œ× ×¢×•×‘×“';
                    resultsDiv.className = 'status-item error';
                    log('âŒ Memory storage failed');
                    return false;
                }
            } catch (error) {
                resultsDiv.innerHTML = `âŒ Memory Storage ×©×’×™××”: ${error.message}`;
                resultsDiv.className = 'status-item error';
                log(`âŒ Memory storage error: ${error.message}`);
                return false;
            }
        }
        
        function testCookies() {
            log('ğŸª ×‘×•×“×§ Cookies...');
            const resultsDiv = document.getElementById('storage-results');
            
            try {
                const testValue = 'test-' + Date.now();
                document.cookie = `testCookie=${testValue}; path=/; max-age=60`;
                
                const cookieExists = document.cookie.includes(`testCookie=${testValue}`);
                
                // Clean up
                document.cookie = 'testCookie=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                
                if (cookieExists) {
                    resultsDiv.innerHTML = 'âœ… Cookies ×¢×•×‘×“×™× ×ª×§×™×Ÿ!';
                    resultsDiv.className = 'status-item success';
                    log('âœ… Cookies test passed');
                    return true;
                } else {
                    resultsDiv.innerHTML = 'âŒ Cookies ×œ× × ×©××¨×™×';
                    resultsDiv.className = 'status-item error';
                    log('âŒ Cookies not saving');
                    return false;
                }
            } catch (error) {
                resultsDiv.innerHTML = `âŒ Cookies ×©×’×™××”: ${error.message}`;
                resultsDiv.className = 'status-item error';
                log(`âŒ Cookies error: ${error.message}`);
                return false;
            }
        }
        
        function testAllMethods() {
            log('ğŸ”¬ ×‘×•×“×§ ×›×œ ×”×©×™×˜×•×ª...');
            const resultsDiv = document.getElementById('storage-results');
            
            const results = [];
            results.push(`localStorage: ${testLocalStorage() ? 'âœ…' : 'âŒ'}`);
            results.push(`sessionStorage: ${testSessionStorage() ? 'âœ…' : 'âŒ'}`);
            results.push(`Memory: ${testMemoryStorage() ? 'âœ…' : 'âŒ'}`);
            results.push(`Cookies: ${testCookies() ? 'âœ…' : 'âŒ'}`);
            
            const workingMethods = results.filter(r => r.includes('âœ…')).length;
            
            resultsDiv.innerHTML = `
                <strong>×ª×•×¦××•×ª ×‘×“×™×§×”:</strong><br>
                ${results.join('<br>')}<br><br>
                <strong>×©×™×˜×•×ª ×¢×•×‘×“×•×ª: ${workingMethods}/4</strong>
            `;
            
            if (workingMethods >= 2) {
                resultsDiv.className = 'status-item success';
                log(`âœ… ${workingMethods}/4 storage methods working`);
            } else if (workingMethods >= 1) {
                resultsDiv.className = 'status-item warning';
                log(`âš ï¸ Only ${workingMethods}/4 storage methods working`);
            } else {
                resultsDiv.className = 'status-item error';
                log('âŒ No storage methods working');
            }
        }
        
        function simulateAuthFlow() {
            log('ğŸ”‘ ××“××” ×–×¨×™××ª ×”×ª×—×‘×¨×•×ª...');
            const resultsDiv = document.getElementById('storage-results');
            const testUserId = 'google_111351120503275674259';
            
            const methods = [];
            
            // Try cookies
            try {
                document.cookie = `userId=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
                document.cookie = `userAuth=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
                methods.push('âœ… Cookies');
            } catch (error) {
                methods.push('âŒ Cookies');
            }
            
            // Try sessionStorage
            try {
                sessionStorage.setItem('userId', testUserId);
                methods.push('âœ… sessionStorage');
            } catch (error) {
                methods.push('âŒ sessionStorage');
            }
            
            // Try localStorage
            try {
                localStorage.setItem('userId', testUserId);
                methods.push('âœ… localStorage');
            } catch (error) {
                methods.push('âŒ localStorage');
            }
            
            // Try memory
            try {
                window._autoPageUserId = testUserId;
                window.autoPageAuth = { userId: testUserId, timestamp: Date.now() };
                methods.push('âœ… Memory');
            } catch (error) {
                methods.push('âŒ Memory');
            }
            
            resultsDiv.innerHTML = `
                <strong>×¡×™××•×œ×¦×™×” ×”×•×©×œ××”:</strong><br>
                ${methods.join('<br>')}<br><br>
                <strong>ğŸ†” Test User ID:</strong> ${testUserId}
            `;
            resultsDiv.className = 'status-item success';
            log(`âœ… Auth simulation complete: ${methods.filter(m => m.includes('âœ…')).length}/4 methods`);
        }
        
        function setTestUser() {
            const userId = prompt('×”×›× ×¡ userId ×œ×‘×“×™×§×”:', 'google_111351120503275674259');
            if (userId) {
                simulateAuthFlow();
                
                const resultsDiv = document.getElementById('fix-results');
                resultsDiv.innerHTML = `âœ… ××©×ª××© ×‘×“×™×§×” ×”×•×’×“×¨: ${userId}`;
                resultsDiv.className = 'status-item success';
                log(`âœ… Test user set: ${userId}`);
            }
        }
        
        function clearAllStorage() {
            log('ğŸ—‘ï¸ ×× ×§×” ×›×œ ×”-Storage...');
            
            // Clear cookies
            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'userAuth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'user_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            // Clear storages
            try { localStorage.clear(); } catch (e) {}
            try { sessionStorage.clear(); } catch (e) {}
            
            // Clear memory
            delete window._autoPageUserId;
            delete window.autoPageAuth;
            
            const resultsDiv = document.getElementById('fix-results');
            resultsDiv.innerHTML = 'ğŸ—‘ï¸ ×›×œ ×”-Storage × ×•×§×”!';
            resultsDiv.className = 'status-item warning';
            log('ğŸ—‘ï¸ All storage cleared');
            updateStorageStatus();
        }
        
        function migrateToSafeStorage() {
            log('ğŸ”„ ××¢×‘×™×¨ ×œ-Storage ×‘×˜×•×—...');
            const resultsDiv = document.getElementById('fix-results');
            
            let userId = null;
            
            // Try to find existing userId
            try {
                userId = localStorage.getItem('userId') || 
                         sessionStorage.getItem('userId') ||
                         window._autoPageUserId ||
                         document.cookie.split('; ').find(row => row.startsWith('userId='))?.split('=')[1];
            } catch (error) {
                log(`âš ï¸ Error reading existing storage: ${error.message}`);
            }
            
            if (!userId) {
                userId = 'google_111351120503275674259'; // Default test user
                log('âš ï¸ No existing userId found, using default test user');
            }
            
            const methods = [];
            
            // Store in all available methods
            // 1. Cookies (most reliable)
            try {
                document.cookie = `userId=${userId}; path=/; max-age=2592000; SameSite=Lax`;
                document.cookie = `userAuth=${userId}; path=/; max-age=2592000; SameSite=Lax`;
                methods.push('âœ… Cookies');
            } catch (error) {
                methods.push('âŒ Cookies');
            }
            
            // 2. sessionStorage (more permissive than localStorage)
            try {
                sessionStorage.setItem('userId', userId);
                methods.push('âœ… sessionStorage');
            } catch (error) {
                methods.push('âŒ sessionStorage');
            }
            
            // 3. Memory (always works)
            try {
                window._autoPageUserId = userId;
                window.autoPageAuth = { userId: userId, timestamp: Date.now() };
                methods.push('âœ… Memory');
            } catch (error) {
                methods.push('âŒ Memory');
            }
            
            // 4. localStorage (if available)
            try {
                localStorage.setItem('userId', userId);
                methods.push('âœ… localStorage');
            } catch (error) {
                methods.push('âŒ localStorage (blocked)');
            }
            
            resultsDiv.innerHTML = `
                <strong>×”×¢×‘×¨×” ×œ-Storage ×‘×˜×•×— ×”×•×©×œ××”:</strong><br>
                ${methods.join('<br>')}<br><br>
                <strong>ğŸ†” User ID:</strong> ${userId}
            `;
            resultsDiv.className = 'status-item success';
            log(`âœ… Safe storage migration complete: ${methods.filter(m => m.includes('âœ…')).length}/4 methods`);
        }
        
        function testSubscriptionFlow() {
            log('ğŸ’³ ×‘×•×“×§ ×–×¨×™××ª ×× ×•×™...');
            const resultsDiv = document.getElementById('fix-results');
            
            // Check if we have userId in any storage
            let userId = null;
            const sources = [];
            
            try {
                userId = document.cookie.split('; ').find(row => row.startsWith('userId='))?.split('=')[1];
                if (userId) sources.push('Cookie');
            } catch (e) {}
            
            try {
                if (!userId) {
                    userId = sessionStorage.getItem('userId');
                    if (userId) sources.push('sessionStorage');
                }
            } catch (e) {}
            
            try {
                if (!userId) {
                    userId = localStorage.getItem('userId');
                    if (userId) sources.push('localStorage');
                }
            } catch (e) {}
            
            try {
                if (!userId) {
                    userId = window._autoPageUserId;
                    if (userId) sources.push('Memory');
                }
            } catch (e) {}
            
            if (userId) {
                resultsDiv.innerHTML = `
                    âœ… ×–×¨×™××ª ×× ×•×™ ×–××™× ×”!<br>
                    ğŸ†” User ID: ${userId}<br>
                    ğŸ“ ××§×•×¨: ${sources.join(', ')}<br>
                    ğŸ”— × ×™×ª×Ÿ ×œ×¢×‘×•×¨ ×œ×“×£ ×× ×•×™
                `;
                resultsDiv.className = 'status-item success';
                log(`âœ… Subscription flow available - userId from: ${sources.join(', ')}`);
            } else {
                resultsDiv.innerHTML = 'âŒ ××™×Ÿ userId ×–××™×Ÿ - ×–×¨×™××ª ×× ×•×™ ×œ× ×ª×¢×‘×•×“';
                resultsDiv.className = 'status-item error';
                log('âŒ No userId available for subscription flow');
            }
        }
        
        function debugStorageIssues() {
            log('ğŸ› ××“×‘×’ ×‘×¢×™×•×ª Storage...');
            const resultsDiv = document.getElementById('fix-results');
            
            const debug = {
                userAgent: navigator.userAgent,
                cookieEnabled: navigator.cookieEnabled,
                storageQuota: 'unknown',
                securityErrors: []
            };
            
            // Test storage quota
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    navigator.storage.estimate().then(estimate => {
                        debug.storageQuota = `${Math.round(estimate.usage / 1024 / 1024)}MB / ${Math.round(estimate.quota / 1024 / 1024)}MB`;
                    });
                }
            } catch (error) {
                debug.securityErrors.push('Storage API: ' + error.message);
            }
            
            // Test each storage method
            ['localStorage', 'sessionStorage'].forEach(storageType => {
                try {
                    const storage = window[storageType];
                    storage.setItem('test', 'test');
                    storage.removeItem('test');
                } catch (error) {
                    debug.securityErrors.push(`${storageType}: ${error.message}`);
                }
            });
            
            resultsDiv.innerHTML = `
                <strong>ğŸ› Storage Debug Info:</strong><br>
                <strong>Browser:</strong> ${debug.userAgent.split(' ').pop()}<br>
                <strong>Cookies Enabled:</strong> ${debug.cookieEnabled ? 'Yes' : 'No'}<br>
                <strong>Storage Quota:</strong> ${debug.storageQuota}<br>
                <strong>Security Errors:</strong><br>
                ${debug.securityErrors.length > 0 ? debug.securityErrors.join('<br>') : 'None'}
            `;
            resultsDiv.className = 'status-item info';
            log('ğŸ› Storage debug completed');
        }
        
        function forceRecovery() {
            log('âš¡ ××‘×¦×¢ ×©×—×–×•×¨ ×‘×›×•×—...');
            
            // First migrate to safe storage
            migrateToSafeStorage();
            
            // Then test subscription flow
            setTimeout(() => {
                testSubscriptionFlow();
            }, 500);
            
            const resultsDiv = document.getElementById('fix-results');
            resultsDiv.innerHTML = 'âš¡ ×©×—×–×•×¨ ×‘×›×•×— ×”×•×©×œ×! ×‘×“×•×§ ××ª ×”×ª×•×¦××•×ª ×œ××¢×œ×”.';
            resultsDiv.className = 'status-item success';
            log('âš¡ Force recovery completed');
        }
        
        function clearLog() {
            logEntries = [];
            document.getElementById('detailed-log').textContent = '×”×œ×•×’ × ×•×§×”...';
        }
        
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×›×œ 5 ×©× ×™×•×ª
        setInterval(updateStorageStatus, 5000);
        
        // ×¢×“×›×•×Ÿ ×¨××©×•× ×™
        updateStorageStatus();
        log('ğŸ”§ localStorage Security Fix Test Page Loaded');
    </script>
</body>
</html>