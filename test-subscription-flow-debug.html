<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ×‘×“×™×§×ª ×–×¨×™××ª ×× ×•×™ - DEBUG</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { background: #d4edda; border-left: 5px solid #28a745; }
        .error { background: #f8d7da; border-left: 5px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 5px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 5px solid #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .big-button {
            background: #28a745;
            font-size: 1.2em;
            padding: 15px 30px;
            width: 100%;
            margin: 10px 0;
        }
        .big-button:hover { background: #218838; }
        .danger-button {
            background: #dc3545;
            font-size: 1.1em;
            padding: 12px 25px;
        }
        .danger-button:hover { background: #c82333; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .status-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
        }
        .flow-step {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .step-title {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ×‘×“×™×§×ª ×–×¨×™××ª ×× ×•×™ - DEBUG</h1>
    
    <div class="section info">
        <h3>ğŸ“Š ××¦×‘ × ×•×›×—×™</h3>
        <div class="status-grid">
            <div>
                <h4>ğŸª Cookies</h4>
                <div id="cookies-status">×˜×•×¢×Ÿ...</div>
            </div>
            <div>
                <h4>ğŸ’¾ Storage</h4>
                <div id="storage-status">×˜×•×¢×Ÿ...</div>
            </div>
        </div>
        <div class="status-item">
            <strong>ğŸ¯ Best userId:</strong> <span id="best-userid">×˜×•×¢×Ÿ...</span>
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ§ª ×”×›× ×” ×œ×‘×“×™×§×”</h3>
        <button onclick="simulateLogin()">ğŸ”‘ ×¡×™××•×œ×¦×™×” ×”×ª×—×‘×¨×•×ª</button>
        <button onclick="clearAllAuth()">ğŸ—‘ï¸ × ×§×” ×›×œ ××™××•×ª</button>
        <button onclick="setTestPageId()">ğŸ“„ ×”×’×“×¨ pageId ×œ×‘×“×™×§×”</button>
        <div class="status-item">
            <strong>ğŸ“„ Current pageId:</strong> <span id="current-pageid">×œ× ×”×•×’×“×¨</span>
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸš€ ×‘×“×™×§×ª ×–×¨×™××” ××œ××”</h3>
        <div class="flow-step">
            <div class="step-title">×©×œ×‘ 1: ×”×›× ×”</div>
            <button onclick="step1_prepare()">ğŸ”§ ×”×›×Ÿ ××¢×¨×›×ª</button>
            <div id="step1-result">×œ× ×”×•×¨×¥</div>
        </div>
        
        <div class="flow-step">
            <div class="step-title">×©×œ×‘ 2: × ×™×•×•×˜ ×œ×“×£ ×× ×•×™</div>
            <button onclick="step2_navigate()">ğŸ§­ × ×•×•×˜ ×œ×“×£ ×× ×•×™</button>
            <div id="step2-result">×œ× ×”×•×¨×¥</div>
        </div>
        
        <div class="flow-step">
            <div class="step-title">×©×œ×‘ 3: ×‘×“×™×§×ª API ×× ×•×™</div>
            <button onclick="step3_testAPI()">ğŸ’³ ×‘×“×•×§ API</button>
            <div id="step3-result">×œ× ×”×•×¨×¥</div>
        </div>
        
        <div class="flow-step">
            <div class="step-title">×©×œ×‘ 4: ×¡×™××•×œ×¦×™×” ×¨×›×™×©×”</div>
            <button onclick="step4_simulatePurchase()">ğŸ›’ ×¡×™××•×œ×¦×™×” ×¨×›×™×©×”</button>
            <div id="step4-result">×œ× ×”×•×¨×¥</div>
        </div>
    </div>
    
    <div class="section">
        <h3>âš¡ ×‘×“×™×§×” ××”×™×¨×”</h3>
        <button class="big-button" onclick="runFullTest()">
            ğŸš€ ×”×¨×¥ ×‘×“×™×§×” ××œ××”
        </button>
        <div id="full-test-result" class="status-item">
            ×ª×•×¦××•×ª ×”×‘×“×™×§×” ×”××œ××” ×™×•×¤×™×¢×• ×›××Ÿ
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ†˜ ×‘×“×™×§×ª ×ª×¨×—×™×© ×‘×¢×™×”</h3>
        <button class="danger-button" onclick="simulateAuthLoss()">
            âš ï¸ ×¡×™××•×œ×¦×™×” ××™×‘×•×“ ××™××•×ª
        </button>
        <div id="auth-loss-result" class="status-item">
            ×ª×•×¦××•×ª ×¡×™××•×œ×¦×™×” ××™×‘×•×“ ××™××•×ª ×™×•×¤×™×¢×• ×›××Ÿ
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ“‹ ×œ×•×’ ××¤×•×¨×˜</h3>
        <button onclick="clearLog()">ğŸ—‘ï¸ × ×§×” ×œ×•×’</button>
        <button onclick="exportLog()">ğŸ“¤ ×™×™×¦× ×œ×•×’</button>
        <pre id="detailed-log">×”×œ×•×’ ×™×•×¤×™×¢ ×›××Ÿ...</pre>
    </div>

    <script>
        let logEntries = [];
        let testPageId = 'test-page-12345';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const entry = `[${timestamp}] ${message}`;
            logEntries.push(entry);
            document.getElementById('detailed-log').textContent = logEntries.join('\n');
            console.log(entry);
        }
        
        function updateStatus() {
            // Check cookies
            const cookies = {
                userId: getCookie('userId'),
                userAuth: getCookie('userAuth'),
                user_id: getCookie('user_id')
            };
            
            // Check storage
            const storage = {
                sessionStorage: null,
                localStorage: null,
                sessionError: null,
                localError: null
            };
            
            try {
                storage.sessionStorage = sessionStorage.getItem('userId');
            } catch (e) {
                storage.sessionError = e.message;
            }
            
            try {
                storage.localStorage = localStorage.getItem('userId');
            } catch (e) {
                storage.localError = e.message;
            }
            
            // Check memory
            const memory = {
                autoPageUserId: window._autoPageUserId,
                autoPageAuth: window.autoPageAuth?.userId
            };
            
            // Find best userId
            const bestUserId = cookies.userId || 
                              cookies.userAuth || 
                              cookies.user_id ||
                              storage.sessionStorage ||
                              storage.localStorage ||
                              memory.autoPageUserId ||
                              memory.autoPageAuth;
            
            // Update display
            document.getElementById('cookies-status').innerHTML = `
                userId: ${cookies.userId ? 'âœ… ' + cookies.userId : 'âŒ'}<br>
                userAuth: ${cookies.userAuth ? 'âœ… ' + cookies.userAuth : 'âŒ'}<br>
                user_id: ${cookies.user_id ? 'âœ… ' + cookies.user_id : 'âŒ'}
            `;
            
            document.getElementById('storage-status').innerHTML = `
                sessionStorage: ${storage.sessionStorage ? 'âœ… ' + storage.sessionStorage : (storage.sessionError ? 'ğŸš« ' + storage.sessionError : 'âŒ')}<br>
                localStorage: ${storage.localStorage ? 'âœ… ' + storage.localStorage : (storage.localError ? 'ğŸš« ' + storage.localError : 'âŒ')}<br>
                memory: ${memory.autoPageUserId ? 'âœ… ' + memory.autoPageUserId : 'âŒ'}
            `;
            
            document.getElementById('best-userid').textContent = bestUserId ? 'âœ… ' + bestUserId : 'âŒ ×œ× × ××¦×';
            
            // Update pageId display
            const urlParams = new URLSearchParams(window.location.search);
            const currentPageId = urlParams.get('pageId') || testPageId;
            document.getElementById('current-pageid').textContent = currentPageId;
            
            return bestUserId;
        }
        
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        function setCookie(name, value) {
            document.cookie = `${name}=${value}; path=/; max-age=2592000; SameSite=Lax`;
        }
        
        function simulateLogin() {
            log('ğŸ”‘ ××“××” ×”×ª×—×‘×¨×•×ª...');
            const testUserId = 'google_111351120503275674259';
            
            // Set cookies
            setCookie('userId', testUserId);
            setCookie('userAuth', testUserId);
            setCookie('user_id', testUserId);
            
            // Set storage
            try {
                sessionStorage.setItem('userId', testUserId);
                localStorage.setItem('userId', testUserId);
            } catch (e) {
                log('âš ï¸ Could not set storage: ' + e.message);
            }
            
            // Set memory
            window._autoPageUserId = testUserId;
            window.autoPageAuth = { userId: testUserId, timestamp: Date.now() };
            
            log(`âœ… Login simulated with userId: ${testUserId}`);
            updateStatus();
        }
        
        function clearAllAuth() {
            log('ğŸ—‘ï¸ ×× ×§×” ×›×œ ××™××•×ª...');
            
            // Clear cookies
            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'userAuth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'user_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            // Clear storage
            try {
                sessionStorage.removeItem('userId');
                localStorage.removeItem('userId');
            } catch (e) {
                log('âš ï¸ Could not clear storage: ' + e.message);
            }
            
            // Clear memory
            delete window._autoPageUserId;
            delete window.autoPageAuth;
            
            log('âœ… All auth cleared');
            updateStatus();
        }
        
        function setTestPageId() {
            testPageId = prompt('×”×›× ×¡ pageId ×œ×‘×“×™×§×”:', testPageId) || testPageId;
            log(`ğŸ“„ Test pageId set to: ${testPageId}`);
            updateStatus();
        }
        
        function step1_prepare() {
            log('ğŸ”§ Step 1: Preparing system...');
            simulateLogin();
            document.getElementById('step1-result').innerHTML = 'âœ… ××¢×¨×›×ª ××•×›× ×” - ××©×ª××© ××—×•×‘×¨';
            document.getElementById('step1-result').className = 'success';
        }
        
        function step2_navigate() {
            log('ğŸ§­ Step 2: Testing navigation to subscription page...');
            const userId = updateStatus();
            
            if (!userId) {
                document.getElementById('step2-result').innerHTML = 'âŒ ××™×Ÿ userId - ×”×¨×¥ ×©×œ×‘ 1 ×§×•×“×';
                document.getElementById('step2-result').className = 'error';
                return;
            }
            
            // Simulate navigation
            const subscribeUrl = `/subscribe?pageId=${testPageId}`;
            log(`ğŸ§­ Would navigate to: ${subscribeUrl}`);
            
            document.getElementById('step2-result').innerHTML = `âœ… × ×™×•×•×˜ ××•×›×Ÿ ×œ: ${subscribeUrl}`;
            document.getElementById('step2-result').className = 'success';
        }
        
        async function step3_testAPI() {
            log('ğŸ’³ Step 3: Testing subscription API...');
            const userId = updateStatus();
            
            if (!userId) {
                document.getElementById('step3-result').innerHTML = 'âŒ ××™×Ÿ userId - ×”×¨×¥ ×©×œ×‘ 1 ×§×•×“×';
                document.getElementById('step3-result').className = 'error';
                return;
            }
            
            try {
                const response = await fetch('/api/subscription/activate-page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify({
                        documentId: testPageId,
                        userId: userId,
                        months: 1
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('step3-result').innerHTML = `âœ… API ×¢×•×‘×“! Status: ${response.status}`;
                    document.getElementById('step3-result').className = 'success';
                    log('âœ… API test passed');
                } else {
                    if (result.needsRefresh && result.keepSession) {
                        document.getElementById('step3-result').innerHTML = `
                            âœ… API ×”×—×–×™×¨ ×©×’×™××” ××‘×œ ×œ× ×× ×ª×§!<br>
                            Status: ${response.status}<br>
                            Error: ${result.error}
                        `;
                        document.getElementById('step3-result').className = 'success';
                        log(`âœ… API returned safe error: ${result.error}`);
                    } else {
                        document.getElementById('step3-result').innerHTML = `
                            âš ï¸ API ×”×—×–×™×¨ ×©×’×™××”:<br>
                            Status: ${response.status}<br>
                            Error: ${result.error}
                        `;
                        document.getElementById('step3-result').className = 'warning';
                        log(`âš ï¸ API returned error: ${result.error}`);
                    }
                }
            } catch (error) {
                document.getElementById('step3-result').innerHTML = `âŒ ×©×’×™××” ×‘×§×¨×™××” ×œ-API: ${error.message}`;
                document.getElementById('step3-result').className = 'error';
                log(`âŒ API call failed: ${error.message}`);
            }
        }
        
        async function step4_simulatePurchase() {
            log('ğŸ›’ Step 4: Simulating purchase flow...');
            
            // Check if still logged in after API test
            const userId = updateStatus();
            
            if (!userId) {
                document.getElementById('step4-result').innerHTML = 'âŒ ××™×‘×“× ×• ××ª ×”××©×ª××© ×‘××”×œ×š ×”×ª×”×œ×™×š!';
                document.getElementById('step4-result').className = 'error';
                log('âŒ Lost user during process');
                return;
            }
            
            // Simulate the full purchase flow
            try {
                // Step 4a: Validate user and page
                log('ğŸ” Validating user and page...');
                
                // Step 4b: Process payment (simulated)
                log('ğŸ’³ Processing payment (simulated)...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 4c: Activate subscription
                log('âš¡ Activating subscription...');
                await step3_testAPI();
                
                // Step 4d: Check if still logged in
                const finalUserId = updateStatus();
                
                if (finalUserId) {
                    document.getElementById('step4-result').innerHTML = `
                        ğŸ‰ ×¨×›×™×©×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!<br>
                        âœ… ××©×ª××© ×¢×“×™×™×Ÿ ××—×•×‘×¨: ${finalUserId}<br>
                        âœ… ×œ× ×”×•×¤× ×” ×œ×”×ª×—×‘×¨×•×ª<br>
                        âœ… ×”×ª×”×œ×™×š ×¢×‘×¨ ×œ×œ× × ×™×ª×•×§
                    `;
                    document.getElementById('step4-result').className = 'success';
                    log('ğŸ‰ Purchase simulation completed successfully');
                } else {
                    document.getElementById('step4-result').innerHTML = `
                        âŒ ×¨×›×™×©×” × ×›×©×œ×” - ×”××©×ª××© ×”×ª× ×ª×§!<br>
                        âŒ ××™×‘×“× ×• ××ª ×”××©×ª××© ×‘××”×œ×š ×”×ª×”×œ×™×š<br>
                        ğŸ’¡ ×¦×¨×™×š ×œ×ª×§×Ÿ ××ª ×”×§×•×“
                    `;
                    document.getElementById('step4-result').className = 'error';
                    log('âŒ Purchase simulation failed - user disconnected');
                }
            } catch (error) {
                document.getElementById('step4-result').innerHTML = `âŒ ×©×’×™××” ×‘×¨×›×™×©×”: ${error.message}`;
                document.getElementById('step4-result').className = 'error';
                log(`âŒ Purchase simulation error: ${error.message}`);
            }
        }
        
        async function runFullTest() {
            log('ğŸš€ ××¨×™×¥ ×‘×“×™×§×” ××œ××”...');
            const resultDiv = document.getElementById('full-test-result');
            
            resultDiv.innerHTML = 'â³ ××¨×™×¥ ×‘×“×™×§×” ××œ××”... ×× × ×”××ª×Ÿ';
            resultDiv.className = 'status-item info';
            
            try {
                // Step 1: Prepare
                step1_prepare();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 2: Navigate
                step2_navigate();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 3: Test API
                await step3_testAPI();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 4: Simulate purchase
                await step4_simulatePurchase();
                
                // Final check
                const finalUserId = updateStatus();
                
                if (finalUserId) {
                    resultDiv.innerHTML = `
                        ğŸ‰ ×‘×“×™×§×” ××œ××” ×”×•×©×œ××” ×‘×”×¦×œ×—×”!<br><br>
                        âœ… ×›×œ ×”×©×œ×‘×™× ×¢×‘×¨×•<br>
                        âœ… ××©×ª××© ×¢×“×™×™×Ÿ ××—×•×‘×¨: ${finalUserId}<br>
                        âœ… ×œ× ×”×™×” × ×™×ª×•×§ ×‘××”×œ×š ×”×ª×”×œ×™×š<br>
                        âœ… ×”××¢×¨×›×ª ×¢×•×‘×“×ª ×›××• ×©×¦×¨×™×š!<br><br>
                        <strong>ğŸ¯ ×”××¡×§× ×”:</strong> ×”×ª×™×§×•×Ÿ ×¢×•×‘×“!
                    `;
                    resultDiv.className = 'status-item success';
                    log('ğŸ‰ Full test PASSED');
                } else {
                    resultDiv.innerHTML = `
                        âŒ ×‘×“×™×§×” ××œ××” × ×›×©×œ×”!<br><br>
                        âŒ ×”××©×ª××© ×”×ª× ×ª×§ ×‘××”×œ×š ×”×ª×”×œ×™×š<br>
                        ğŸ’¡ ×¦×¨×™×š ×œ×‘×“×•×§ ××ª ×”×§×•×“ × ×•×¡×£<br><br>
                        <strong>ğŸ” ×‘×“×•×§ ××ª ×”×œ×•×’ ×œ××˜×” ×œ×¤×¨×˜×™×</strong>
                    `;
                    resultDiv.className = 'status-item error';
                    log('âŒ Full test FAILED');
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ ×©×’×™××” ×‘×‘×“×™×§×” ××œ××”: ${error.message}`;
                resultDiv.className = 'status-item error';
                log(`âŒ Full test error: ${error.message}`);
            }
        }
        
        async function simulateAuthLoss() {
            log('âš ï¸ ××“××” ××™×‘×•×“ ××™××•×ª...');
            const resultDiv = document.getElementById('auth-loss-result');
            
            // First, ensure we're logged in
            simulateLogin();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Clear only cookies (simulate cookie loss)
            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'userAuth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'user_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            log('ğŸª Cookies cleared, storage should still have userId');
            
            // Now test if the system can recover
            try {
                const response = await fetch('/api/subscription/activate-page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        documentId: testPageId,
                        months: 1
                    })
                });
                
                const result = await response.json();
                
                // Check if we can recover
                const recoveredUserId = updateStatus();
                
                if (recoveredUserId) {
                    resultDiv.innerHTML = `
                        ğŸ‰ ×©×—×–×•×¨ ×××™×‘×•×“ ××™××•×ª ×”×¦×œ×™×—!<br><br>
                        âœ… ×”××¢×¨×›×ª ×–×™×”×ª×” ××™×‘×•×“ cookies<br>
                        âœ… ×©×—×–×¨×” userId ×-storage<br>
                        âœ… ×œ× ×”×¤× ×ª×” ×œ×”×ª×—×‘×¨×•×ª<br>
                        âœ… ××©×ª××© ×¢×“×™×™×Ÿ ××—×•×‘×¨: ${recoveredUserId}<br><br>
                        <strong>ğŸ¯ ×”××¡×§× ×”:</strong> ×× ×’× ×•×Ÿ ×”×©×—×–×•×¨ ×¢×•×‘×“!
                    `;
                    resultDiv.className = 'status-item success';
                    log('ğŸ‰ Auth loss recovery PASSED');
                } else {
                    resultDiv.innerHTML = `
                        âŒ ×©×—×–×•×¨ ×××™×‘×•×“ ××™××•×ª × ×›×©×œ!<br><br>
                        âŒ ×”××¢×¨×›×ª ×œ× ×”×¦×œ×™×—×” ×œ×©×—×–×¨ ××ª ×”××©×ª××©<br>
                        âŒ ×›× ×¨××” ×”×¤× ×ª×” ×œ×”×ª×—×‘×¨×•×ª<br><br>
                        <strong>ğŸ’¡ ×¤×ª×¨×•×Ÿ:</strong> ×¦×¨×™×š ×œ×©×¤×¨ ××ª ×× ×’× ×•×Ÿ ×”×©×—×–×•×¨
                    `;
                    resultDiv.className = 'status-item error';
                    log('âŒ Auth loss recovery FAILED');
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×©×—×–×•×¨: ${error.message}`;
                resultDiv.className = 'status-item error';
                log(`âŒ Auth loss recovery error: ${error.message}`);
            }
        }
        
        function clearLog() {
            logEntries = [];
            document.getElementById('detailed-log').textContent = '×”×œ×•×’ × ×•×§×”...';
        }
        
        function exportLog() {
            const logText = logEntries.join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `subscription-debug-log-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×›×œ 2 ×©× ×™×•×ª
        setInterval(updateStatus, 2000);
        
        // ×¢×“×›×•×Ÿ ×¨××©×•× ×™
        updateStatus();
        log('ğŸ” Subscription Flow Debug Page Loaded');
    </script>
</body>
</html>