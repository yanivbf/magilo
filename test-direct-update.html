<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>×‘×“×™×§×ª ×¢×“×›×•×Ÿ ×™×©×™×¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            direction: rtl;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>×‘×“×™×§×ª ×¢×“×›×•×Ÿ ××§×˜×¢×™×</h1>
    
    <div>
        <label>Page ID (documentId ××• numeric):</label>
        <input type="text" id="pageId" value="icqxvujoujrxd0a484ropuid" style="width: 300px;">
    </div>
    
    <div style="margin-top: 20px;">
        <button onclick="testUpdate()">×‘×“×•×§ ×¢×“×›×•×Ÿ ××§×˜×¢</button>
        <button onclick="clearLog()">× ×§×” ×œ×•×’</button>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testUpdate() {
            const pageId = document.getElementById('pageId').value;
            
            log('ğŸ” ××ª×—×™×œ ×‘×“×™×§×”...');
            log(`ğŸ“„ Page ID: ${pageId}`);
            
            try {
                // Step 1: Get current page
                log('\nğŸ“¥ ×©×œ×‘ 1: ×§×•×¨× ×“×£ × ×•×›×—×™...');
                const getResponse = await fetch(`http://localhost:5173/api/pages/${pageId}`);
                if (!getResponse.ok) {
                    throw new Error(`Failed to get page: ${getResponse.status}`);
                }
                const pageData = await getResponse.json();
                log(`âœ… ×“×£ × ××¦×: ${pageData.title}`, 'success');
                log(`   - ID: ${pageData.id}`);
                log(`   - DocumentID: ${pageData.documentId}`);
                log(`   - ××¡×¤×¨ ××§×˜×¢×™×: ${pageData.sections?.length || 0}`);
                
                if (pageData.sections && pageData.sections.length > 0) {
                    const section0 = pageData.sections[0];
                    log(`   - ××§×˜×¢ 0 ×¡×•×’: ${section0.type}`);
                    log(`   - ×ª××•× ×” × ×•×›×—×™×ª: ${section0.data?.image || '××™×Ÿ'}`);
                    
                    // Step 2: Update the image
                    const newImageUrl = `http://localhost:1337/uploads/test_${Date.now()}.png`;
                    log(`\nğŸ’¾ ×©×œ×‘ 2: ××¢×“×›×Ÿ ×ª××•× ×” ×œ: ${newImageUrl}`);
                    
                    const updateResponse = await fetch('http://localhost:5173/api/update-page', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            pageId: pageId,
                            field: 'sections.0.data.image',
                            value: newImageUrl
                        })
                    });
                    
                    log(`ğŸ“¡ ×ª×’×•×‘×ª ×©×¨×ª: ${updateResponse.status}`);
                    
                    if (!updateResponse.ok) {
                        const errorText = await updateResponse.text();
                        log(`âŒ ×©×’×™××”: ${errorText}`, 'error');
                        throw new Error(`Update failed: ${updateResponse.status}`);
                    }
                    
                    const updateResult = await updateResponse.json();
                    log(`âœ… ×¢×“×›×•×Ÿ ×”×¦×œ×™×—: ${JSON.stringify(updateResult)}`, 'success');
                    
                    // Step 3: Verify
                    log('\nğŸ” ×©×œ×‘ 3: ××××ª ×¢×“×›×•×Ÿ...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const verifyResponse = await fetch(`http://localhost:5173/api/pages/${pageId}`, {
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    });
                    const verifyData = await verifyResponse.json();
                    const updatedImage = verifyData.sections[0].data.image;
                    
                    log(`ğŸ“ ×ª××•× ×” ×œ××—×¨ ×¢×“×›×•×Ÿ: ${updatedImage}`);
                    
                    if (updatedImage === newImageUrl) {
                        log('\nâœ… ×”×¦×œ×—×”! ×”×¢×“×›×•×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”!', 'success');
                    } else {
                        log('\nâŒ ×›×™×©×œ×•×Ÿ! ×”×¢×“×›×•×Ÿ ×œ× × ×©××¨!', 'error');
                        log(`   ×¦×¤×•×™: ${newImageUrl}`, 'error');
                        log(`   ×”×ª×§×‘×œ: ${updatedImage}`, 'error');
                    }
                } else {
                    log('âŒ ××™×Ÿ ××§×˜×¢×™× ×‘×“×£', 'error');
                }
                
            } catch (error) {
                log(`\nâŒ ×©×’×™××”: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
