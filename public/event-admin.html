<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול אירוע - AutoPage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            text-align: right;
            background: #f5f7fa;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .stat-card.green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-card.red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        .guest-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border-right: 5px solid #8b5cf6;
        }
        .guest-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .guest-card.confirmed { border-right-color: #10b981; }
        .guest-card.pending { border-right-color: #f59e0b; }
        .guest-card.declined { border-right-color: #ef4444; }
        
        .gift-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-right: 4px solid #ec4899;
        }
    </style>
</head>
<body>
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">🎉 ניהול אירוע</h1>
                        <p class="text-gray-600" id="event-name">טוען...</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="window.location.href='/'" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                            🏠 דף הבית
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Stats -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <h3 id="total-guests">0</h3>
                    <p>סה"כ מוזמנים</p>
                </div>
                <div class="stat-card green">
                    <h3 id="confirmed-guests">0</h3>
                    <p>✓ אישרו הגעה</p>
                </div>
                <div class="stat-card orange">
                    <h3 id="pending-guests">0</h3>
                    <p>⏳ ממתינים</p>
                </div>
                <div class="stat-card red">
                    <h3 id="declined-guests">0</h3>
                    <p>✗ לא יגיעו</p>
                </div>
            </div>

            <!-- Guests Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">👥 רשימת מוזמנים</h2>
                    <div class="flex gap-3">
                        <input type="text" id="search-guest" placeholder="🔍 חפש מוזמן..." class="px-4 py-2 border-2 rounded-lg">
                        <select id="filter-status" class="px-4 py-2 border-2 rounded-lg">
                            <option value="all">הכל</option>
                            <option value="confirmed">✓ אישרו</option>
                            <option value="pending">⏳ ממתינים</option>
                            <option value="declined">✗ לא יגיעו</option>
                        </select>
                    </div>
                </div>
                <div id="guests-list" class="space-y-3">
                    <p class="text-center text-gray-500 py-8">טוען מוזמנים...</p>
                </div>
            </div>

            <!-- Gifts Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6">🎁 מתנות שהתקבלו</h2>
                <div id="gifts-list" class="space-y-3">
                    <p class="text-center text-gray-500 py-8">טוען מתנות...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allGuests = [];
        let allGifts = [];
        let eventInfo = {};

        function getEventInfo() {
            const urlParams = new URLSearchParams(window.location.search);
            eventInfo = {
                eventId: urlParams.get('eventId') || urlParams.get('page'),
                userId: urlParams.get('userId')
            };
            console.log('📋 Event info from URL:', eventInfo);
            return eventInfo;
        }

        async function loadEventData() {
            console.log('🔍 loadEventData called');
            const info = getEventInfo();
            
            if (!info.eventId || !info.userId) {
                console.warn('⚠️ Missing eventId or userId in URL!');
                return;
            }

            // Update event name
            document.getElementById('event-name').textContent = decodeURIComponent(info.eventId).replace('_html', '').replace(/_/g, ' ');

            console.log(`📊 Fetching event data for: ${info.eventId}`);
            
            try {
                // Load RSVPs (guests)
                const rsvpUrl = `/api/event/${info.eventId}/rsvps?userId=${info.userId}`;
                console.log('🌐 RSVP API URL:', rsvpUrl);
                
                const rsvpResponse = await fetch(rsvpUrl);
                const rsvpData = await rsvpResponse.json();
                
                console.log('✅ RSVP data received:', rsvpData);
                allGuests = rsvpData.rsvps || [];
                
                // Load gifts/purchases
                const giftsUrl = `/api/analytics/page/${info.eventId}?userId=${info.userId}`;
                console.log('🌐 Gifts API URL:', giftsUrl);
                
                const giftsResponse = await fetch(giftsUrl);
                const giftsData = await giftsResponse.json();
                
                console.log('✅ Gifts data received:', giftsData);
                allGifts = giftsData.purchases || [];
                
                // Render
                renderGuests(allGuests);
                renderGifts(allGifts);
                updateStats();
                
                console.log('✅ Event dashboard updated');
            } catch (error) {
                console.error('❌ Error loading event data:', error);
            }
        }

        function renderGuests(guests) {
            const container = document.getElementById('guests-list');
            if (!guests || guests.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">אין מוזמנים עדיין</p>';
                return;
            }
            
            container.innerHTML = guests.map(guest => `
                <div class="guest-card ${guest.status}">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">${guest.name}</div>
                            <div class="text-sm text-gray-600">${guest.phone || ''}</div>
                            <div class="text-xs text-gray-500">${new Date(guest.createdAt).toLocaleString('he-IL')}</div>
                        </div>
                        <div class="text-left">
                            <span class="px-4 py-2 rounded-full font-bold ${
                                guest.status === 'confirmed' ? 'bg-green-100 text-green-700' :
                                guest.status === 'declined' ? 'bg-red-100 text-red-700' :
                                'bg-yellow-100 text-yellow-700'
                            }">
                                ${guest.status === 'confirmed' ? '✓ מגיע' : guest.status === 'declined' ? '✗ לא מגיע' : '⏳ ממתין'}
                            </span>
                            ${guest.guests ? `<div class="text-sm text-gray-600 mt-2">👨‍👩‍👧‍👦 ${guest.guests} אורחים</div>` : ''}
                        </div>
                    </div>
                    ${guest.message ? `<div class="mt-3 p-3 bg-gray-50 rounded-lg text-sm">"${guest.message}"</div>` : ''}
                </div>
            `).join('');
        }

        function renderGifts(gifts) {
            const container = document.getElementById('gifts-list');
            if (!gifts || gifts.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">אין מתנות עדיין</p>';
                return;
            }
            
            const totalGifts = gifts.reduce((sum, g) => sum + g.total, 0);
            
            container.innerHTML = `
                <div class="bg-pink-50 border-2 border-pink-200 rounded-lg p-4 mb-6">
                    <div class="text-center">
                        <div class="text-4xl font-bold text-pink-600">₪${totalGifts.toLocaleString()}</div>
                        <div class="text-pink-700 font-semibold">סה"כ מתנות שהתקבלו</div>
                    </div>
                </div>
                ${gifts.map(gift => `
                    <div class="gift-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-lg">${gift.customerName}</div>
                                <div class="text-sm text-gray-600">${gift.customerPhone || ''}</div>
                                <div class="text-xs text-gray-500">${new Date(gift.createdAt).toLocaleString('he-IL')}</div>
                            </div>
                            <div class="text-2xl font-bold text-pink-600">₪${gift.total}</div>
                        </div>
                        ${gift.products && gift.products.length > 0 ? 
                            `<div class="mt-2 text-sm text-gray-700">
                                ${gift.products.map(p => `• ${p.name}`).join('<br>')}
                            </div>` : ''}
                    </div>
                `).join('')}
            `;
        }

        function updateStats() {
            const confirmed = allGuests.filter(g => g.status === 'confirmed').length;
            const pending = allGuests.filter(g => g.status === 'pending' || !g.status).length;
            const declined = allGuests.filter(g => g.status === 'declined').length;
            
            document.getElementById('total-guests').textContent = allGuests.length;
            document.getElementById('confirmed-guests').textContent = confirmed;
            document.getElementById('pending-guests').textContent = pending;
            document.getElementById('declined-guests').textContent = declined;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadEventData();
            
            // Setup filters
            document.getElementById('search-guest')?.addEventListener('input', filterGuests);
            document.getElementById('filter-status')?.addEventListener('change', filterGuests);
        });

        function filterGuests() {
            const search = document.getElementById('search-guest')?.value?.toLowerCase() || '';
            const status = document.getElementById('filter-status')?.value || 'all';
            
            let filtered = allGuests;
            
            if (status !== 'all') {
                filtered = filtered.filter(g => g.status === status);
            }
            
            if (search) {
                filtered = filtered.filter(g => 
                    g.name?.toLowerCase().includes(search) ||
                    g.phone?.includes(search)
                );
            }
            
            renderGuests(filtered);
        }
    </script>
</body>
</html>
