<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×ª×•×¨×™× - ×¤×× ×œ × ×™×”×•×œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Heebo', sans-serif;
        }
        
        .appointment-card {
            position: relative;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .appointment-card.pending {
            border-left: 5px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2);
            animation: pulse-card 2s ease-in-out infinite;
        }
        
        @keyframes pulse-card {
            0%, 100% {
                box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2);
            }
            50% {
                box-shadow: 0 6px 12px rgba(245, 158, 11, 0.4);
            }
        }
        
        .appointment-card.pending::after {
            content: 'âš ï¸ ×××ª×™×Ÿ ×œ××™×©×•×¨';
            position: absolute;
            top: 10px;
            left: 10px;
            background: #f59e0b;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .appointment-card.confirmed {
            border-left-color: #10b981;
            background-color: #f0fdf4;
        }
        
        .appointment-card.cancelled {
            border-left-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .appointment-card:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .stat-card.amber {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .stat-card.red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .nav-tab {
            padding: 12px 24px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            font-weight: 600;
            cursor: pointer;
            background: white;
            border: 2px solid #e5e7eb;
            border-bottom: none;
        }
        
        .nav-tab.active {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .nav-tab:not(.active):hover {
            background-color: #f3f4f6;
        }
        
        .view-content {
            display: none;
        }
        
        .view-content.active {
            display: block;
        }
        
        .time-slot-calendar {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }
        
        .time-slot-item {
            position: relative;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            text-align: center;
            transition: all 0.3s;
        }
        
        .time-slot-item.free {
            background: #d1fae5;
            border-color: #10b981;
        }
        
        .time-slot-item.pending {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 3px solid #f59e0b;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
            animation: pulse-pending 2s ease-in-out infinite;
        }
        
        @keyframes pulse-pending {
            0%, 100% {
                box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 25px rgba(245, 158, 11, 0.6);
                transform: scale(1.02);
            }
        }
        
        .time-slot-item.pending::before {
            content: 'âš ï¸ ×××ª×™×Ÿ ×œ××™×©×•×¨';
            position: absolute;
            top: -10px;
            right: 10px;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .time-slot-item.confirmed {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .time-slot-item.cancelled {
            background: #fee2e2;
            border-color: #ef4444;
        }
        
        .time-slot-item.break {
            background: #e9d5ff;
            border-color: #a855f7;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50 no-print">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“… × ×™×”×•×œ ×ª×•×¨×™×</h1>
                    <span id="page-title" class="text-lg text-gray-600"></span>
                </div>
                <div class="flex gap-3">
                    <button onclick="refreshData()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                        ğŸ”„ ×¨×¢× ×Ÿ
                    </button>
                    <button onclick="window.print()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                        ğŸ–¨ï¸ ×”×“×¤×¡
                    </button>
                    <button onclick="goBackToPage()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition">
                        â† ×—×–×•×¨ ×œ×“×£
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 no-print">
            <div class="stat-card">
                <div class="text-sm opacity-90 mb-2">×¡×”"×› ×ª×•×¨×™×</div>
                <div class="text-4xl font-bold" id="total-appointments">0</div>
            </div>
            <div class="stat-card green">
                <div class="text-sm opacity-90 mb-2">×ª×•×¨×™× ×××•×©×¨×™×</div>
                <div class="text-4xl font-bold" id="confirmed-appointments">0</div>
            </div>
            <div class="stat-card amber">
                <div class="text-sm opacity-90 mb-2">×××ª×™× ×™× ×œ××™×©×•×¨</div>
                <div class="text-4xl font-bold" id="pending-appointments">0</div>
            </div>
            <div class="stat-card red">
                <div class="text-sm opacity-90 mb-2">×ª×•×¨×™× ××‘×•×˜×œ×™×</div>
                <div class="text-4xl font-bold" id="cancelled-appointments">0</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-xl shadow-md mb-6 no-print">
            <div class="flex gap-2 p-4 border-b-2">
                <button class="nav-tab active" onclick="switchView('list')" data-view="list">
                    ğŸ“‹ ×¨×©×™××ª ×ª×•×¨×™×
                </button>
                <button class="nav-tab" onclick="switchView('calendar')" data-view="calendar">
                    ğŸ“… ×ª×¦×•×’×ª ×™×•××Ÿ
                </button>
                <button class="nav-tab" onclick="switchView('customers')" data-view="customers">
                    ğŸ’¬ ××•×¢×“×•×Ÿ ×œ×§×•×—×•×ª
                </button>
                <button class="nav-tab" onclick="switchView('services')" data-view="services">
                    ğŸ’‡ × ×™×”×•×œ ×©×™×¨×•×ª×™×
                </button>
            </div>
        </div>

        <!-- View: List -->
        <div id="view-list" class="view-content active">
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div class="flex gap-3 flex-wrap mb-4">
                    <button class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600" onclick="filterAppointments('all')">
                        ×”×›×œ
                    </button>
                    <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" onclick="filterAppointments('today')">
                        ×”×™×•×
                    </button>
                    <button class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600" onclick="filterAppointments('tomorrow')">
                        ××—×¨
                    </button>
                    <button class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600" onclick="filterAppointments('week')">
                        ×”×©×‘×•×¢
                    </button>
                    <button class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600" onclick="filterAppointments('pending')">
                        ×××ª×™× ×™×
                    </button>
                    <button class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600" onclick="filterAppointments('confirmed')">
                        ×××•×©×¨×™×
                    </button>
                </div>
                
                <div class="flex gap-3">
                    <input type="date" id="filter-date" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterByDate()">
                    <input type="text" id="search-input" placeholder="×—×¤×© ×œ×¤×™ ×©×, ×˜×œ×¤×•×Ÿ ××• ×©×™×¨×•×ª..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" oninput="searchAppointments()">
                </div>
            </div>

            <div id="appointments-container" class="space-y-4">
                <!-- Appointments will be loaded here -->
            </div>

            <div id="empty-state" class="hidden text-center py-12">
                <div class="text-6xl mb-4">ğŸ“…</div>
                <h3 class="text-2xl font-bold text-gray-700 mb-2">××™×Ÿ ×ª×•×¨×™× ×œ×”×¦×’×”</h3>
                <p class="text-gray-600">×”×ª×•×¨×™× ×©×™×ª×§×‘×œ×• ×™×•×¤×™×¢×• ×›××Ÿ</p>
            </div>
        </div>

        <!-- View: Calendar -->
        <div id="view-calendar" class="view-content">
            <div class="bg-white rounded-xl shadow-md p-6 mb-4">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="changeCalendarDate(-1)" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        â† ×™×•× ×§×•×“×
                    </button>
                    <div class="flex items-center gap-4">
                        <h2 id="calendar-date" class="text-2xl font-bold"></h2>
                        <button onclick="showDaySettings()" class="px-3 py-1 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">
                            âš™ï¸ ×”×’×“×¨×•×ª ×™×•×
                        </button>
                    </div>
                    <button onclick="changeCalendarDate(1)" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        ×™×•× ×”×‘× â†’
                    </button>
                </div>
                <div id="calendar-grid" class="time-slot-calendar">
                    <!-- Time slots will be rendered here -->
                </div>
            </div>
        </div>

        <!-- View: Customers Club -->
        <div id="view-customers" class="view-content">
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">ğŸ’¬ ××•×¢×“×•×Ÿ ×œ×§×•×—×•×ª</h2>
                <p class="text-gray-600 mb-6">×›×œ ×”×œ×§×•×—×•×ª ×©×§×‘×¢×• ×ª×•×¨ ××™ ×¤×¢× ××•×¤×™×¢×™× ×›××Ÿ</p>
                
                <!-- Bulk Message Form -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg mb-6">
                    <h3 class="text-lg font-bold mb-4">ğŸ“¨ ×©×œ×— ×”×•×“×¢×” ×œ×›×•×œ×</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">×‘×—×¨ ×ª×‘× ×™×ª ×”×•×“×¢×”:</label>
                        <select id="message-template" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="loadTemplate()">
                            <option value="">×›×ª×•×‘ ×”×•×“×¢×” ××©×œ×š...</option>
                            <option value="holiday">ğŸ‰ ×—×’ ×©××—</option>
                            <option value="promotion">ğŸ ××‘×¦×¢ ××™×•×—×“</option>
                            <option value="update">ğŸ“¢ ×¢×“×›×•×Ÿ ×—×©×•×‘</option>
                            <option value="reminder">â° ×ª×–×›×•×¨×ª</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">×”×•×“×¢×”:</label>
                        <textarea id="bulk-message" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="×›×ª×•×‘ ××ª ×”×”×•×“×¢×” ×©×œ×š ×›××Ÿ..."></textarea>
                    </div>
                    
                    <div class="flex gap-3 flex-wrap">
                        <button onclick="sendBulkMessage(false)" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                            ğŸ“¤ ×©×œ×— ×œ× ×‘×—×¨×™×
                        </button>
                        <button onclick="sendBulkMessage(true)" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                            ğŸ“¢ ×©×œ×— ×œ×›×•×œ×
                        </button>
                        <button onclick="sendBulkAuto()" class="px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg hover:from-orange-600 hover:to-red-600 font-semibold shadow-lg">
                            âš¡ ×©×œ×™×—×” ××•×˜×•××˜×™×ª - ×¢× ×›×¤×ª×•×¨ "×”×‘×"
                        </button>
                    </div>
                    <div class="mt-3 p-3 bg-orange-50 border border-orange-200 rounded-lg text-sm">
                        <strong>ğŸ’¡ ×©×œ×™×—×” ××•×˜×•××˜×™×ª:</strong> ×¤×•×ª×— ×œ×§×•×— ××—×“, ××ª×” ×©×•×œ×— ×‘WhatsApp, ×œ×•×—×¥ "×”×‘×" â†’ ×¤×•×ª×— ××ª ×”×©× ×™. 
                        <br><strong>ğŸ’¡ ×˜×™×¤:</strong> ×‘×—×¨ ×œ×§×•×—×•×ª ×¡×¤×¦×™×¤×™×™× ×œ×¤× ×™, ××• ××œ ×ª×‘×—×¨ = ×©×•×œ×— ×œ×›×•×œ×!
                    </div>
                </div>
                
                <!-- Customer List Controls -->
                <div class="flex gap-3 mb-4">
                    <button onclick="selectAllCustomers()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        âœ… ×‘×—×¨ ×”×›×œ
                    </button>
                    <button onclick="deselectAllCustomers()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        âŒ ×‘×˜×œ ×‘×—×™×¨×”
                    </button>
                    <input type="text" id="customer-search" placeholder="×—×¤×© ×œ×§×•×—..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" oninput="filterCustomers()">
                </div>
                
                <div id="customers-list">
                    <!-- Customers will be rendered here -->
                </div>
            </div>
        </div>

        <!-- View: Services Management -->
        <div id="view-services" class="view-content">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">ğŸ’‡ × ×™×”×•×œ ×©×™×¨×•×ª×™×</h2>
                        <p class="text-gray-600 mt-1">×”×’×“×¨ ××ª ×”×©×™×¨×•×ª×™× ×©××ª×” ××¦×™×¢</p>
                    </div>
                    <button onclick="addNewService()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                        â• ×”×•×¡×£ ×©×™×¨×•×ª ×—×“×©
                    </button>
                </div>
                
                <div id="services-list" class="space-y-4">
                    <!-- Services will be rendered here -->
                </div>
                
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="loadServices()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        ğŸ”„ ×¨×¢× ×Ÿ
                    </button>
                    <button onclick="saveServices()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                        ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let allAppointments = [];
        let filteredAppointments = [];
        let currentFilter = 'all';
        let userId = '';
        let pageId = '';
        let pageName = '';
        let currentView = 'list';
        let calendarDate = new Date();
        let allCustomers = [];
        let filteredCustomers = [];
        let selectedCustomers = [];
        let services = [];

        // Get URL Parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            userId = params.get('userId') || '';
            pageId = params.get('pageId') || '';
            let rawPageName = params.get('pageName') || '×”×“×£ ×©×œ×™';
            
            // ğŸ”¥ Decode pageId if it's URL-encoded (might contain Hebrew characters)
            if (pageId) {
                try {
                    pageId = decodeURIComponent(pageId);
                } catch (e) {
                    console.warn('âš ï¸ Could not decode pageId, using as-is:', e);
                }
            }
            
            // Clean page name (remove numbers and _html)
            pageName = rawPageName
                .replace(/_\d+_html$/, '')  // Remove _1234567890_html
                .replace(/_html$/, '')       // Remove _html
                .replace(/\s+\d{13,}/, '')   // Remove long numbers (13+ digits) with space before
                .replace(/_/g, ' ')          // Replace underscores with spaces
                .trim();                     // Remove extra spaces
            
            // Show clean page name in title (without the long number)
            document.getElementById('page-title').textContent = `(${pageName})`;
            
            console.log('ğŸ“‹ URL Params - userId:', userId, 'pageId:', pageId, 'pageName:', pageName);
            
            if (!userId || !pageId) {
                alert('×—×¡×¨×™× ×¤×¨×˜×™ ×“×£. ×× × ×’×© ×“×¨×š ×”×§×™×©×•×¨ ×‘×“×£ ×©×œ×š.');
                return false;
            }
            return true;
        }

        // Load Appointments
        async function loadAppointments() {
            if (!getUrlParams()) return;
            
            console.log('ğŸ“… Loading appointments - userId:', userId, 'pageId:', pageId);
            console.log('ğŸ“… Full URL params:', window.location.search);
            console.log('ğŸ“… Decoded pageId:', pageId);
            
            try {
                // ğŸ”¥ Ensure both userId and pageId are properly encoded
                const encodedUserId = encodeURIComponent(userId);
                const encodedPageId = encodeURIComponent(pageId);
                const apiUrl = `/api/appointments/${encodedUserId}/${encodedPageId}`;
                console.log('ğŸ“… Fetching from:', apiUrl);
                console.log('ğŸ“… Encoded userId:', encodedUserId, 'encodedPageId:', encodedPageId);
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Failed to fetch appointments:', response.status, errorText);
                    throw new Error('Failed to fetch appointments: ' + response.status);
                }
                
                const data = await response.json();
                console.log('ğŸ“… Received data:', data);
                console.log('ğŸ“… Data type:', typeof data, 'Is array?', Array.isArray(data));
                
                // ğŸ”¥ Handle different response formats
                if (Array.isArray(data)) {
                    allAppointments = data;
                    console.log('ğŸ“… Response is array, using directly');
                } else if (data && data.appointments !== undefined) {
                    if (Array.isArray(data.appointments)) {
                        allAppointments = data.appointments;
                        console.log('ğŸ“… Response has appointments array, length:', data.appointments.length);
                    } else {
                        console.warn('âš ï¸ Response.appointments is not an array:', typeof data.appointments, data.appointments);
                        allAppointments = [];
                    }
                } else {
                    console.warn('âš ï¸ Unexpected response format. Data keys:', Object.keys(data || {}));
                    allAppointments = [];
                }
                
                console.log('ğŸ“… Final loaded appointments:', allAppointments.length);
                if (allAppointments.length > 0) {
                    console.log('âœ… First appointment:', allAppointments[0]);
                    console.log('âœ… All appointments pageIds:', allAppointments.map(a => a.pageId || '(no pageId)'));
                } else {
                    console.log('âš ï¸ No appointments loaded. Full response:', JSON.stringify(data, null, 2));
                }
                
                allAppointments.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateB - dateA;
                });
                
                filterAppointments(currentFilter);
                updateStatistics();
                buildCustomersList();
                
                if (currentView === 'calendar') {
                    renderCalendarView();
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                document.getElementById('appointments-container').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <div class="text-red-600 font-bold mb-2">×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×•×¨×™×</div>
                        <div class="text-red-500">${error.message}</div>
                    </div>
                `;
            }
        }

        // Load Services
        async function loadServices() {
            if (!getUrlParams()) return;
            
            console.log('ğŸ”§ Loading services - userId:', userId, 'pageId:', pageId);
            
            try {
                // ğŸ”¥ Try multiple paths for metadata.json (same logic as other endpoints)
                const encodedUserId = encodeURIComponent(userId);
                const encodedPageId = encodeURIComponent(pageId);
                const decodedPageId = decodeURIComponent(pageId);
                
                // Try all possible metadata paths
                const possiblePaths = [
                    `/output/${encodedUserId}/${encodedPageId}_data/metadata.json`,
                    `/output/${encodedUserId}/${encodedPageId}_html_data/metadata.json`,
                    `/output/${encodedUserId}/${decodedPageId}_data/metadata.json`,
                    `/output/${encodedUserId}/${decodedPageId}_html_data/metadata.json`,
                    `/output/${encodedUserId}/${decodedPageId.replace(/_html$/, '')}_data/metadata.json`,
                    `/output/${encodedUserId}/${decodedPageId.replace(/_html$/, '')}_html_data/metadata.json`,
                    `/users/${encodedUserId}/${encodedPageId}_data/metadata.json`,
                    `/users/${encodedUserId}/${encodedPageId}_html_data/metadata.json`
                ];
                
                let metadata = null;
                let foundPath = null;
                
                for (const metadataPath of possiblePaths) {
                    console.log(`ğŸ” Trying metadata path: ${metadataPath}`);
                    const response = await fetch(metadataPath);
                    if (response.ok) {
                        metadata = await response.json();
                        foundPath = metadataPath;
                        console.log(`âœ… Found metadata at: ${metadataPath}`);
                        break;
                    }
                }
                
                if (metadata) {
                    services = metadata.services || [];
                    console.log('âœ… Loaded services:', services.length, 'services from', foundPath);
                    if (services.length > 0) {
                        console.log('âœ… Services:', services.map(s => s.name || s));
                    } else {
                        console.log('â„¹ï¸ No services in metadata (services array is empty or missing)');
                    }
                    renderServices();
                } else {
                    console.warn('âš ï¸ No metadata found in any of the tried paths');
                    console.log('âš ï¸ Tried paths:', possiblePaths);
                    services = [];
                    renderServices();
                }
            } catch (error) {
                console.error('âŒ Failed to load services:', error);
                services = [];
                renderServices();
            }
        }

        // Render Services
        function renderServices() {
            const container = document.getElementById('services-list');
            if (services.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">ğŸ’‡</div>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">××™×Ÿ ×©×™×¨×•×ª×™× ×¢×“×™×™×Ÿ</h3>
                        <p class="text-gray-600">×œ×—×¥ ×¢×œ "×”×•×¡×£ ×©×™×¨×•×ª ×—×“×©" ×›×“×™ ×œ×”×ª×—×™×œ</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = services.map((service, index) => `
                <div class="service-item bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg border-2 border-purple-200">
                    <div class="flex items-start gap-4">
                        <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">×©× ×”×©×™×¨×•×ª</label>
                                <input 
                                    type="text" 
                                    value="${service.name || ''}" 
                                    onchange="updateService(${index}, 'name', this.value)"
                                    class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500"
                                    placeholder="×œ××©×œ: ×ª×¡×¤×•×¨×ª ×’×‘×¨×™×"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">××©×š (×“×§×•×ª)</label>
                                <input 
                                    type="number" 
                                    value="${service.duration || 30}" 
                                    onchange="updateService(${index}, 'duration', parseInt(this.value))"
                                    class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500"
                                    min="15" 
                                    step="15"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">××—×™×¨ (â‚ª)</label>
                                <input 
                                    type="number" 
                                    value="${service.price || 0}" 
                                    onchange="updateService(${index}, 'price', parseFloat(this.value))"
                                    class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500"
                                    min="0" 
                                    step="10"
                                />
                            </div>
                        </div>
                        <button 
                            onclick="deleteService(${index})" 
                            class="mt-6 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                            title="××—×§ ×©×™×¨×•×ª"
                        >
                            ğŸ—‘ï¸ ××—×§
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Add New Service
        function addNewService() {
            services.push({
                name: '',
                duration: 30,
                price: 80
            });
            renderServices();
        }

        // Update Service
        function updateService(index, field, value) {
            if (services[index]) {
                services[index][field] = value;
                console.log('âœ… Updated service:', services[index]);
            }
        }

        // Delete Service
        function deleteService(index) {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×©×™×¨×•×ª ×–×”?')) {
                services.splice(index, 1);
                renderServices();
                showToast('×”×©×™×¨×•×ª × ××—×§ ×‘×”×¦×œ×—×”');
            }
        }

        // Save Services
        async function saveServices() {
            try {
                const response = await fetch(`/api/update-services/${userId}/${pageId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ services })
                });
                
                if (response.ok) {
                    showToast('âœ… ×”×©×™×¨×•×ª×™× × ×©××¨×• ×‘×”×¦×œ×—×”!');
                    console.log('âœ… Services saved successfully');
                } else {
                    throw new Error('Failed to save services');
                }
            } catch (error) {
                console.error('âŒ Error saving services:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×©×™×¨×•×ª×™×. × ×¡×” ×©×•×‘.');
            }
        }

        // Switch View
        function switchView(view) {
            currentView = view;
            
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.dataset.view === view) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.view-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`view-${view}`).classList.add('active');
            
            // Load specific view data
            if (view === 'calendar') {
                renderCalendarView();
            } else if (view === 'customers') {
                buildCustomersList();
                renderCustomers();
            } else if (view === 'services') {
                // ğŸ”¥ Load services when switching to services view
                loadServices();
            }
        }

        // Update Statistics
        function updateStatistics() {
            const total = allAppointments.length;
            const confirmed = allAppointments.filter(a => a.status === 'confirmed').length;
            const pending = allAppointments.filter(a => a.status === 'pending' || !a.status).length;
            const cancelled = allAppointments.filter(a => a.status === 'cancelled').length;
            
            document.getElementById('total-appointments').textContent = total;
            document.getElementById('confirmed-appointments').textContent = confirmed;
            document.getElementById('pending-appointments').textContent = pending;
            document.getElementById('cancelled-appointments').textContent = cancelled;
        }

        // Filter Appointments
        function filterAppointments(filter) {
            currentFilter = filter;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (filter === 'all') {
                filteredAppointments = allAppointments;
            } else if (filter === 'today') {
                filteredAppointments = allAppointments.filter(a => {
                    const aptDate = new Date(a.date);
                    return aptDate.toDateString() === today.toDateString();
                });
            } else if (filter === 'tomorrow') {
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                filteredAppointments = allAppointments.filter(a => {
                    const aptDate = new Date(a.date);
                    return aptDate.toDateString() === tomorrow.toDateString();
                });
            } else if (filter === 'week') {
                const weekEnd = new Date(today);
                weekEnd.setDate(weekEnd.getDate() + 7);
                filteredAppointments = allAppointments.filter(a => {
                    const aptDate = new Date(a.date);
                    return aptDate >= today && aptDate <= weekEnd;
                });
            } else if (filter === 'pending') {
                filteredAppointments = allAppointments.filter(a => a.status === 'pending' || !a.status);
            } else if (filter === 'confirmed') {
                filteredAppointments = allAppointments.filter(a => a.status === 'confirmed');
            }
            
            renderAppointments();
        }

        // Render Appointments
        function renderAppointments() {
            const container = document.getElementById('appointments-container');
            const emptyState = document.getElementById('empty-state');
            
            if (filteredAppointments.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            container.innerHTML = filteredAppointments.map(apt => `
                <div class="appointment-card bg-white rounded-lg shadow p-6 ${apt.status || 'pending'}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <h3 class="text-xl font-bold text-gray-800">${apt.name}</h3>
                                <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                    apt.status === 'confirmed' ? 'bg-green-100 text-green-800' :
                                    apt.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                                    'bg-amber-100 text-amber-800'
                                }">
                                    ${apt.status === 'confirmed' ? 'âœ… ×××•×©×¨' :
                                      apt.status === 'cancelled' ? 'âŒ ××‘×•×˜×œ' :
                                      'â³ ×××ª×™×Ÿ'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-gray-600">
                                <div>ğŸ“… <strong>×ª××¨×™×š:</strong> ${new Date(apt.date).toLocaleDateString('he-IL')}</div>
                                <div>ğŸ• <strong>×©×¢×”:</strong> ${apt.time}</div>
                                <div>ğŸ“ <strong>×˜×œ×¤×•×Ÿ:</strong> ${apt.phone}</div>
                                ${apt.service ? `<div>ğŸ’‡ <strong>×©×™×¨×•×ª:</strong> ${apt.service}</div>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${apt.status !== 'confirmed' ? `
                                <button onclick="updateStatus('${apt.id}', 'confirmed')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                                    âœ… ××©×¨
                                </button>
                            ` : ''}
                            ${apt.status !== 'cancelled' ? `
                                <button onclick="updateStatus('${apt.id}', 'cancelled')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                                    âŒ ×‘×˜×œ
                                </button>
                            ` : ''}
                            <button onclick="contactCustomer('${apt.phone}', '${apt.name}')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                                ğŸ’¬ WhatsApp
                            </button>
                            <button onclick="deleteAppointment('${apt.id}', '${apt.name}')" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                ğŸ—‘ï¸ ××—×§
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update Status
        async function updateStatus(appointmentId, newStatus) {
            try {
                const response = await fetch(`/api/appointments/${appointmentId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    const apt = allAppointments.find(a => a.id === appointmentId);
                    if (apt) {
                        apt.status = newStatus;
                    }
                    
                    filterAppointments(currentFilter);
                    updateStatistics();
                    
                    // ğŸ¯ Refresh calendar view if we're in calendar mode
                    if (currentView === 'calendar') {
                        renderCalendarView();
                    }
                    
                    showToast('âœ… ×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
                    
                    // Send WhatsApp message when confirming
                    if (newStatus === 'confirmed' && apt) {
                        const cleanPhone = apt.phone.replace(/[^0-9]/g, '');
                        const israelPhone = cleanPhone.startsWith('0') ? '972' + cleanPhone.substring(1) : cleanPhone;
                        const businessPhone = '972526663398'; // You can make this dynamic
                        const message = encodeURIComponent(`×©×œ×•× ${apt.name},\n\n×”×ª×•×¨ ×©×œ×š ××•×©×¨!\n\n×ª××¨×™×š: ${new Date(apt.date).toLocaleDateString('he-IL')}\n×©×¢×”: ${apt.time}\n${pageName}\n\n××—×›×™× ×œ×š!\n\n×œ×¤×¨×˜×™× × ×•×¡×¤×™×: ${businessPhone}`);
                        window.open(`https://wa.me/${israelPhone}?text=${message}`, '_blank');
                    }
                } else {
                    throw new Error('Failed to update status');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡');
            }
        }

        // Delete Appointment
        async function deleteAppointment(appointmentId, customerName) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×ª×•×¨ ×©×œ ${customerName}?\n\n×©×™× ×œ×‘: ×”×œ×§×•×— ×™×™×©××¨ ×‘××•×¢×“×•×Ÿ ×”×œ×§×•×—×•×ª.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/appointments/${appointmentId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    allAppointments = allAppointments.filter(a => a.id !== appointmentId);
                    filterAppointments(currentFilter);
                    updateStatistics();
                    
                    // ğŸ¯ Refresh calendar view if we're in calendar mode
                    if (currentView === 'calendar') {
                        renderCalendarView();
                    }
                    
                    showToast('âœ… ×”×ª×•×¨ × ××—×§ ×‘×”×¦×œ×—×”');
                } else {
                    throw new Error('Failed to delete appointment');
                }
            } catch (error) {
                console.error('Error deleting appointment:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×ª×•×¨');
            }
        }

        // Contact Customer
        function contactCustomer(phone, customerName = '') {
            if (!phone) {
                alert('×œ× × ××¦× ××¡×¤×¨ ×˜×œ×¤×•×Ÿ');
                return;
            }
            
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            const israelPhone = cleanPhone.startsWith('0') ? '972' + cleanPhone.substring(1) : cleanPhone;
            const message = customerName ? `×©×œ×•× ${customerName}, ` : '×©×œ×•×, ';
            window.open(`https://wa.me/${israelPhone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        // Filter by Date
        function filterByDate() {
            const dateInput = document.getElementById('filter-date').value;
            if (!dateInput) {
                filterAppointments('all');
                return;
            }
            
            filteredAppointments = allAppointments.filter(a => a.date === dateInput);
            renderAppointments();
        }

        // Search Appointments
        function searchAppointments() {
            const query = document.getElementById('search-input').value.toLowerCase();
            if (!query) {
                filterAppointments(currentFilter);
                return;
            }
            
            filteredAppointments = allAppointments.filter(a => 
                a.name.toLowerCase().includes(query) ||
                a.phone.includes(query) ||
                (a.service && a.service.toLowerCase().includes(query))
            );
            renderAppointments();
        }

        // Calendar View Functions
        function changeCalendarDate(days) {
            calendarDate.setDate(calendarDate.getDate() + days);
            renderCalendarView();
        }

        async function renderCalendarView() {
            const dateStr = calendarDate.toISOString().split('T')[0];
            const dayName = calendarDate.toLocaleDateString('he-IL', { weekday: 'long' });
            document.getElementById('calendar-date').textContent = `${dayName}, ${calendarDate.toLocaleDateString('he-IL')}`;
            
            try {
                // Load metadata for working hours
                const metaResponse = await fetch(`/users/${userId}/${pageId}_data/metadata.json`);
                let workingHours = { start: '09:00', end: '17:00' };
                let breaks = [];
                
                if (metaResponse.ok) {
                    const metadata = await metaResponse.json();
                    workingHours = metadata.workingHours || workingHours;
                    breaks = metadata.breaks || [];
                }
                
                // Load day settings
                const daySettings = {};
                try {
                    const settingsResponse = await fetch(`/api/day-settings/${userId}/${pageId}`);
                    if (settingsResponse.ok) {
                        const settings = await settingsResponse.json();
                        Object.assign(daySettings, settings);
                    }
                } catch (e) {
                    console.warn('No day settings found');
                }
                
                // Check if day is closed
                if (daySettings[dateStr] && daySettings[dateStr].closed) {
                    document.getElementById('calendar-grid').innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">ğŸš«</div>
                            <h3 class="text-2xl font-bold text-gray-700">×™×•× ×—×•×¤×©</h3>
                        </div>
                    `;
                    return;
                }
                
                const dayAppointments = allAppointments.filter(a => a.date === dateStr);
                
                // Generate time slots
                let [startHour, startMin] = workingHours.start.split(':').map(Number);
                let [endHour, endMin] = workingHours.end.split(':').map(Number);
                
                const slots = [];
                let hour = startHour;
                let min = startMin;
                
                while (true) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                    
                    // Check if break time
                    const isBreak = breaks.some(b => timeStr >= b.start && timeStr < b.end);
                    
                    // Check if blocked
                    const isBlocked = daySettings[dateStr] && daySettings[dateStr].blockedSlots && 
                        daySettings[dateStr].blockedSlots.some(block => timeStr >= block.start && timeStr < block.end);
                    
                    // Check if booked
                    const apt = dayAppointments.find(a => a.time === timeStr && a.status !== 'cancelled');
                    
                    let slotClass = 'free';
                    let slotText = '×¤× ×•×™';
                    let buttons = '';
                    let timeDisplay = timeStr;
                    
                    if (isBreak) {
                        slotClass = 'break';
                        slotText = '×”×¤×¡×§×”';
                    } else if (isBlocked) {
                        slotClass = 'cancelled';
                        slotText = '×—×¡×•×';
                    } else if (apt) {
                        slotClass = apt.status || 'pending';
                        slotText = apt.name;
                        
                        // ğŸ¯ Calculate end time based on duration
                        if (apt.duration) {
                            const [aptHour, aptMin] = timeStr.split(':').map(Number);
                            const totalMinutes = aptHour * 60 + aptMin + apt.duration;
                            const endHour = Math.floor(totalMinutes / 60);
                            const endMin = totalMinutes % 60;
                            const endTimeStr = `${endHour.toString().padStart(2, '0')}:${endMin.toString().padStart(2, '0')}`;
                            timeDisplay = `${timeStr}-${endTimeStr}`;
                        }
                        
                        buttons = `
                            <div class="mt-2 flex gap-1">
                                ${apt.status !== 'confirmed' ? `<button onclick="updateStatus('${apt.id}', 'confirmed')" class="px-2 py-1 bg-green-500 text-white rounded text-xs">âœ…</button>` : ''}
                                ${apt.status !== 'cancelled' ? `<button onclick="updateStatus('${apt.id}', 'cancelled')" class="px-2 py-1 bg-red-500 text-white rounded text-xs">âŒ</button>` : ''}
                                <button onclick="contactCustomer('${apt.phone}', '${apt.name}')" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">ğŸ’¬</button>
                                <button onclick="deleteAppointment('${apt.id}', '${apt.name}')" class="px-2 py-1 bg-gray-500 text-white rounded text-xs">ğŸ—‘ï¸</button>
                            </div>
                        `;
                    }
                    
                    // Add slot to display (for ALL cases)
                    slots.push(`
                        <div class="time-slot-item ${slotClass}">
                            <div class="font-bold">${timeDisplay}</div>
                            <div class="text-sm">${slotText}</div>
                            ${apt && apt.service ? `<div class="text-xs text-gray-600">${apt.service}</div>` : ''}
                            ${buttons}
                        </div>
                    `);
                    
                    // Increment by 15 minutes
                    min += 15;
                    if (min >= 60) {
                        min = 0;
                        hour++;
                    }
                    
                    // Break condition
                    if (hour > endHour || (hour === endHour && min >= endMin)) {
                        break;
                    }
                }
                
                document.getElementById('calendar-grid').innerHTML = slots.join('');
                
            } catch (error) {
                console.error('Error rendering calendar:', error);
                document.getElementById('calendar-grid').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-red-600 font-bold">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×•××Ÿ</div>
                    </div>
                `;
            }
        }

        // Day Settings Functions
        function showDaySettings() {
            const dateStr = calendarDate.toISOString().split('T')[0];
            const dayName = calendarDate.toLocaleDateString('he-IL', { weekday: 'long' });
            
            const modal = document.createElement('div');
            modal.id = 'day-settings-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
                    <h2 class="text-2xl font-bold mb-4">âš™ï¸ ×”×’×“×¨×•×ª ×œ×™×•× ${dayName}</h2>
                    <p class="text-gray-600 mb-6">${calendarDate.toLocaleDateString('he-IL')}</p>
                    
                    <div class="space-y-3">
                        <button onclick="closeDayCompletely('${dateStr}')" class="w-full px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold">
                            ğŸš« ×¡×’×•×¨ ×™×•× ×–×” ×œ×—×œ×•×˜×™×Ÿ
                        </button>
                        <button onclick="blockSpecificSlots('${dateStr}')" class="w-full px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold">
                            â° ×—×¡×•× ×ª××™ ×–××Ÿ ×¡×¤×¦×™×¤×™×™×
                        </button>
                        <button onclick="reopenDay('${dateStr}')" class="w-full px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
                            âœ… ×¤×ª×— ×™×•× ×–×” ××—×“×©
                        </button>
                        <button onclick="document.getElementById('day-settings-modal').remove()" class="w-full px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold">
                            âŒ ×‘×™×˜×•×œ
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function closeDayCompletely(dateStr) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¡×’×•×¨ ××ª ×”×™×•× ${dateStr} ×œ×—×œ×•×˜×™×Ÿ?\n\n×”×™×•× ×œ× ×™×”×™×” ×–××™×Ÿ ×œ×§×‘×™×¢×ª ×ª×•×¨×™×.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/day-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        pageId,
                        date: dateStr,
                        action: 'close'
                    })
                });
                
                if (response.ok) {
                    document.getElementById('day-settings-modal').remove();
                    renderCalendarView();
                    showToast('âœ… ×”×™×•× × ×¡×’×¨ ×‘×”×¦×œ×—×”');
                } else {
                    throw new Error('Failed to close day');
                }
            } catch (error) {
                console.error('Error closing day:', error);
                alert('×©×’×™××” ×‘×¡×’×™×¨×ª ×™×•×. × ×¡×” ×©×•×‘.');
            }
        }

        function blockSpecificSlots(dateStr) {
            document.getElementById('day-settings-modal').remove();
            
            const modal = document.createElement('div');
            modal.id = 'block-slots-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
                    <h2 class="text-2xl font-bold mb-4">â° ×—×¡×™××ª ×ª××™ ×–××Ÿ</h2>
                    <p class="text-gray-600 mb-4">×‘×—×¨ ×˜×•×•×— ×©×¢×•×ª ×œ×—×¡×™××”</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">×©×¢×ª ×”×ª×—×œ×”</label>
                            <input type="time" id="block-start" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="13:00" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">×©×¢×ª ×¡×™×•×</label>
                            <input type="time" id="block-end" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="14:00" />
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="confirmBlockSlots('${dateStr}')" class="flex-1 px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold">
                            âœ… ××©×¨ ×—×¡×™××”
                        </button>
                        <button onclick="document.getElementById('block-slots-modal').remove()" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold">
                            âŒ ×‘×™×˜×•×œ
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function confirmBlockSlots(dateStr) {
            const startTime = document.getElementById('block-start').value;
            const endTime = document.getElementById('block-end').value;
            
            if (!startTime || !endTime) {
                alert('×× × ×‘×—×¨ ×©×¢×ª ×”×ª×—×œ×” ×•×¡×™×•×');
                return;
            }
            
            if (startTime >= endTime) {
                alert('×©×¢×ª ×”×¡×™×•× ×—×™×™×‘×ª ×œ×”×™×•×ª ××—×¨×™ ×©×¢×ª ×”×”×ª×—×œ×”');
                return;
            }
            
            try {
                const response = await fetch('/api/day-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        pageId,
                        date: dateStr,
                        action: 'block',
                        startTime,
                        endTime
                    })
                });
                
                if (response.ok) {
                    document.getElementById('block-slots-modal').remove();
                    renderCalendarView();
                    showToast(`âœ… ×ª××™ ×–××Ÿ × ×—×¡××•: ${startTime} - ${endTime}`);
                } else {
                    throw new Error('Failed to block slots');
                }
            } catch (error) {
                console.error('Error blocking slots:', error);
                alert('×©×’×™××” ×‘×—×¡×™××ª ×ª××™×. × ×¡×” ×©×•×‘.');
            }
        }

        async function reopenDay(dateStr) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¤×ª×•×— ××ª ×”×™×•× ${dateStr} ××—×“×©?\n\n×›×œ ×”×—×¡×™××•×ª ×™×•×¡×¨×•.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/day-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        pageId,
                        date: dateStr,
                        action: 'reopen'
                    })
                });
                
                if (response.ok) {
                    document.getElementById('day-settings-modal').remove();
                    renderCalendarView();
                    showToast('âœ… ×”×™×•× × ×¤×ª×— ××—×“×© ×‘×”×¦×œ×—×”');
                } else {
                    throw new Error('Failed to reopen day');
                }
            } catch (error) {
                console.error('Error reopening day:', error);
                alert('×©×’×™××” ×‘×¤×ª×™×—×ª ×™×•×. × ×¡×” ×©×•×‘.');
            }
        }

        // Customer Club Functions
        function buildCustomersList() {
            const customersMap = new Map();
            
            allAppointments.forEach(apt => {
                if (!customersMap.has(apt.phone)) {
                    customersMap.set(apt.phone, {
                        name: apt.name,
                        phone: apt.phone,
                        email: apt.email || '',
                        appointments: 0,
                        services: new Set()
                    });
                }
                
                const customer = customersMap.get(apt.phone);
                customer.appointments++;
                if (apt.service) {
                    customer.services.add(apt.service);
                }
            });
            
            allCustomers = Array.from(customersMap.values());
            filteredCustomers = [...allCustomers];
        }

        function renderCustomers() {
            const container = document.getElementById('customers-list');
            
            if (filteredCustomers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">ğŸ‘¥</div>
                        <h3 class="text-xl font-bold text-gray-700">××™×Ÿ ×œ×§×•×—×•×ª ×¢×“×™×™×Ÿ</h3>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredCustomers.map((customer, index) => `
                <div class="customer-item bg-white p-4 rounded-lg border-2 border-gray-200 mb-3">
                    <div class="flex items-center gap-4">
                        <input 
                            type="checkbox" 
                            id="customer-${index}" 
                            onchange="toggleCustomerSelection('${customer.phone}')"
                            class="w-5 h-5"
                        />
                        <div class="flex-1">
                            <h3 class="font-bold text-lg">${customer.name}</h3>
                            <p class="text-gray-600 text-sm">ğŸ“ ${customer.phone}</p>
                            <p class="text-gray-600 text-sm">ğŸ“Š ${customer.appointments} ×ª×•×¨×™× â€¢ ${Array.from(customer.services).join(', ')}</p>
                        </div>
                        <button onclick="contactCustomer('${customer.phone}', '${customer.name}')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            ğŸ’¬ ×©×œ×— ×”×•×“×¢×”
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function toggleCustomerSelection(phone) {
            const index = selectedCustomers.indexOf(phone);
            if (index > -1) {
                selectedCustomers.splice(index, 1);
            } else {
                selectedCustomers.push(phone);
            }
        }

        function selectAllCustomers() {
            selectedCustomers = filteredCustomers.map(c => c.phone);
            document.querySelectorAll('.customer-item input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deselectAllCustomers() {
            selectedCustomers = [];
            document.querySelectorAll('.customer-item input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function filterCustomers() {
            const query = document.getElementById('customer-search').value.toLowerCase();
            if (!query) {
                filteredCustomers = [...allCustomers];
            } else {
                filteredCustomers = allCustomers.filter(c =>
                    c.name.toLowerCase().includes(query) ||
                    c.phone.includes(query)
                );
            }
            renderCustomers();
        }

        function loadTemplate() {
            const template = document.getElementById('message-template').value;
            const textarea = document.getElementById('bulk-message');
            
            const templates = {
                holiday: `ğŸ‰ ×—×’ ×©××—!\n\n×¨×•×¦×™× ×œ×¨×¢× ×Ÿ ××ª ×”××¨××” ×œ×§×¨××ª ×”×—×’?\n×§×‘×¢×• ×ª×•×¨ ×¢×›×©×™×• ×‘-${pageName} ğŸ’‡`,
                promotion: `ğŸ ××‘×¦×¢ ××™×•×—×“!\n\n×©×™×¨×•×ª×™× × ×‘×—×¨×™× ×‘××—×™×¨ ××•×–×œ!\n××”×¨×• ×œ×§×‘×•×¢ ×ª×•×¨ ×‘-${pageName} â°`,
                update: `ğŸ“¢ ×¢×“×›×•×Ÿ ×—×©×•×‘\n\n×”×™! ×¨×¦×™× ×• ×œ×¢×“×›×Ÿ ××ª×›× ×¢×œ ×©×™× ×•×™ ×‘×©×¢×•×ª ×”×¤×¢×™×œ×•×ª.\n\n${pageName}`,
                reminder: `â° ×ª×–×›×•×¨×ª\n\n×”×™! ×¨×§ ×¨×¦×™× ×• ×œ×”×–×›×™×¨ ×©×× ×—× ×• ×¤×” ×‘×©×‘×™×œ×›× ğŸ˜Š\n\n${pageName}`
            };
            
            if (templates[template]) {
                textarea.value = templates[template];
            }
        }

        function sendBulkMessage(sendToAll) {
            const message = document.getElementById('bulk-message').value;
            if (!message.trim()) {
                alert('×× × ×›×ª×•×‘ ×”×•×“×¢×” ×œ×¤× ×™ ×©×œ×™×—×”');
                return;
            }
            
            const customersToSend = sendToAll ? allCustomers : allCustomers.filter(c => selectedCustomers.includes(c.phone));
            
            if (customersToSend.length === 0) {
                alert('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×œ×§×•×— ××—×“');
                return;
            }
            
            showSimpleClickList(customersToSend, message);
        }

        // âš¡ AUTO-SEND MODE - Semi-automatic with control panel
        let autoSendQueue = [];
        let autoSendIndex = 0;
        let autoSendMessage = '';
        
        function sendBulkAuto() {
            const message = document.getElementById('bulk-message').value;
            if (!message.trim()) {
                alert('×× × ×›×ª×•×‘ ×”×•×“×¢×” ×œ×¤× ×™ ×©×œ×™×—×”');
                return;
            }
            
            // Send only to selected customers (if any selected), otherwise to all
            const customersToSend = selectedCustomers.length > 0 
                ? allCustomers.filter(c => selectedCustomers.includes(c.phone))
                : allCustomers;
            
            if (customersToSend.length === 0) {
                alert('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×œ×§×•×— ××—×“');
                return;
            }
            
            const customerType = selectedCustomers.length > 0 ? '× ×‘×—×¨×™×' : '×›×œ ×”×œ×§×•×—×•×ª';
            
            if (!confirm(`âš¡ ×©×œ×™×—×” ××•×˜×•××˜×™×ª ×œ-${customerType}!\n\n×–×” ×™×¤×ª×— ×œ×§×•×— ××—×“ ×‘×›×œ ×¤×¢×.\n××ª×” ×©×•×œ×— ×‘WhatsApp â† ×—×•×–×¨ ×œ×¤×” â† ×œ×•×—×¥ "×”×‘×".\n\n××ª×—×™×œ ×¢× ${customersToSend.length} ×œ×§×•×—×•×ª?`)) {
                return;
            }
            
            // Initialize queue
            autoSendQueue = [...customersToSend];
            autoSendIndex = 0;
            autoSendMessage = message;
            
            // Show control panel
            showAutoSendPanel();
            
            // Open first customer
            sendToNextInQueue();
        }
        
        function showAutoSendPanel() {
            // Remove existing panel if any
            const existingPanel = document.getElementById('auto-send-panel');
            if (existingPanel) {
                existingPanel.remove();
            }
            
            const panel = document.createElement('div');
            panel.id = 'auto-send-panel';
            panel.className = 'fixed bottom-6 right-6 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl shadow-2xl p-6 z-50 min-w-[350px]';
            panel.innerHTML = `
                <div class="text-center">
                    <h3 class="text-xl font-bold mb-3">âš¡ ×©×œ×™×—×” ××•×˜×•××˜×™×ª</h3>
                    <div class="bg-white bg-opacity-20 rounded-lg p-4 mb-4">
                        <div class="text-3xl font-bold mb-1" id="auto-send-progress">1 / ${autoSendQueue.length}</div>
                        <div class="text-sm">× ×©×œ×—×•</div>
                        <div class="w-full bg-white bg-opacity-30 rounded-full h-2 mt-2">
                            <div id="auto-send-bar" class="bg-white h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <button onclick="sendToNextInQueue()" class="w-full px-6 py-3 bg-white text-orange-600 rounded-lg hover:bg-gray-100 font-bold text-lg animate-pulse">
                            â–¶ï¸ ×”×‘×
                        </button>
                        <button onclick="closeAutoSendPanel()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            âŒ ×¡×™×™×
                        </button>
                    </div>
                    <div class="mt-3 text-xs bg-white bg-opacity-20 rounded p-2">
                        ğŸ’¡ ×œ×—×¥ "×©×œ×—" ×‘WhatsApp â† ×—×–×•×¨ ×œ×›××Ÿ â† ×œ×—×¥ "â–¶ï¸ ×”×‘×"
                    </div>
                </div>
            `;
            document.body.appendChild(panel);
        }
        
        function sendToNextInQueue() {
            if (autoSendIndex >= autoSendQueue.length) {
                showToast('âœ… ×¡×™×™××ª ×œ×©×œ×•×— ×œ×›×œ ×”×œ×§×•×—×•×ª!');
                closeAutoSendPanel();
                return;
            }
            
            const customer = autoSendQueue[autoSendIndex];
            const cleanPhone = customer.phone.replace(/[^0-9]/g, '');
            const israelPhone = cleanPhone.startsWith('0') ? '972' + cleanPhone.substring(1) : cleanPhone;
            const personalizedMessage = autoSendMessage.replace(/\[×©×\]/g, customer.name);
            const encodedMessage = encodeURIComponent(personalizedMessage);
            
            // Open WhatsApp
            window.open(`https://wa.me/${israelPhone}?text=${encodedMessage}`, '_blank');
            
            // Update progress
            autoSendIndex++;
            updateAutoSendProgress();
            
            // Mark as sent in the list
            showToast(`âœ… × ×©×œ×— ×œ-${customer.name}`);
        }
        
        function updateAutoSendProgress() {
            const progressText = document.getElementById('auto-send-progress');
            const progressBar = document.getElementById('auto-send-bar');
            
            if (progressText) {
                progressText.textContent = `${autoSendIndex} / ${autoSendQueue.length}`;
            }
            
            if (progressBar) {
                const percentage = (autoSendIndex / autoSendQueue.length) * 100;
                progressBar.style.width = `${percentage}%`;
            }
        }
        
        function closeAutoSendPanel() {
            const panel = document.getElementById('auto-send-panel');
            if (panel) {
                panel.remove();
            }
            autoSendQueue = [];
            autoSendIndex = 0;
            autoSendMessage = '';
        }

        function showSimpleClickList(customers, message) {
            const container = document.getElementById('customers-list');
            
            container.innerHTML = `
                <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg mb-4">
                    <h3 class="text-xl font-bold mb-3">ğŸ“¤ ×©×œ×™×—×ª ×”×•×“×¢×•×ª (${customers.length} ×œ×§×•×—×•×ª)</h3>
                    <p class="text-sm text-gray-700 mb-4">
                        <strong>×”×•×¨××•×ª:</strong> ×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "ğŸ’¬ ×©×œ×—" ×œ×™×“ ×›×œ ×œ×§×•×— ×›×“×™ ×œ×¤×ª×•×— WhatsApp.<br>
                        ××—×¨×™ ×©×©×•×œ×— ×‘WhatsApp, ×”×›×¤×ª×•×¨ ×™×©×ª× ×” ×œ"âœ… × ×©×œ×—"
                    </p>
                    <button onclick="renderCustomers()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        â† ×—×–×•×¨ ×œ×¨×©×™××ª ×œ×§×•×—×•×ª
                    </button>
                </div>
                
                <div class="space-y-3">
                    ${customers.map((customer, index) => {
                        const cleanPhone = customer.phone.replace(/[^0-9]/g, '');
                        const israelPhone = cleanPhone.startsWith('0') ? '972' + cleanPhone.substring(1) : cleanPhone;
                        const personalizedMessage = message.replace(/\[×©×\]/g, customer.name);
                        const encodedMessage = encodeURIComponent(personalizedMessage);
                        
                        return `
                            <div class="bg-white p-4 rounded-lg border-2 border-gray-200 flex items-center gap-4">
                                <span class="text-2xl font-bold text-gray-400">${index + 1}.</span>
                                <div class="flex-1">
                                    <h3 class="font-bold">${customer.name}</h3>
                                    <p class="text-sm text-gray-600">${customer.phone}</p>
                                </div>
                                <a 
                                    href="https://wa.me/${israelPhone}?text=${encodedMessage}" 
                                    target="_blank"
                                    id="send-btn-${index}"
                                    onclick="markBulkAsSent(${index})"
                                    class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold transition"
                                >
                                    ğŸ’¬ ×©×œ×—
                                </a>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function markBulkAsSent(index) {
            setTimeout(() => {
                const btn = document.getElementById(`send-btn-${index}`);
                if (btn) {
                    btn.textContent = 'âœ… × ×©×œ×—';
                    btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    btn.classList.add('bg-gray-400');
                    btn.onclick = null;
                }
            }, 500);
        }

        // ============================================
        // SERVICES MANAGEMENT
        // ============================================
        
        async function loadServices() {
            try {
                const response = await fetch(`/output/${userId}/${pageId}_data/metadata.json`);
                if (response.ok) {
                    const metadata = await response.json();
                    services = metadata.services || [];
                    console.log('âœ… Loaded services:', services);
                    renderServices();
                } else {
                    services = [];
                    renderServices();
                }
            } catch (error) {
                console.error('âŒ Failed to load services:', error);
                services = [];
                renderServices();
            }
        }
        
        function renderServices() {
            const container = document.getElementById('services-list');
            if (!container) return;
            
            if (services.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                        <div class="text-4xl mb-3">ğŸ’‡</div>
                        <p class="text-gray-600 font-semibold">××™×Ÿ ×©×™×¨×•×ª×™× ×¢×“×™×™×Ÿ</p>
                        <p class="text-gray-500 text-sm mt-1">×œ×—×¥ ×¢×œ "×”×•×¡×£ ×©×™×¨×•×ª ×—×“×©" ×›×“×™ ×œ×”×ª×—×™×œ</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = services.map((service, index) => `
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-5 rounded-lg border-2 border-purple-200 hover:shadow-md transition-all">
                    <div class="flex items-start gap-4">
                        <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">×©× ×”×©×™×¨×•×ª</label>
                                <input 
                                    type="text" 
                                    value="${service.name}" 
                                    onchange="updateService(${index}, 'name', this.value)"
                                    class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200"
                                    placeholder="×œ××©×œ: ×ª×¡×¤×•×¨×ª ×’×‘×¨×™×"
                                />
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">××©×š (×“×§×•×ª)</label>
                                <input 
                                    type="number" 
                                    value="${service.duration}" 
                                    onchange="updateService(${index}, 'duration', parseInt(this.value))"
                                    class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200"
                                    min="15" 
                                    step="15"
                                />
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">××—×™×¨ (â‚ª)</label>
                                <input 
                                    type="number" 
                                    value="${service.price}" 
                                    onchange="updateService(${index}, 'price', parseFloat(this.value))"
                                    class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200"
                                    min="0" 
                                    step="10"
                                />
                            </div>
                        </div>
                        <button 
                            onclick="deleteService(${index})" 
                            class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-semibold"
                            title="××—×§ ×©×™×¨×•×ª"
                        >
                            ğŸ—‘ï¸
                        </button>
                    </div>
                    <div class="mt-3 text-sm text-gray-600 bg-white p-2 rounded">
                        <strong>×ª×¦×•×’×” ×‘×“×£:</strong> ${service.name} - ${service.duration} ×“×§×•×ª - â‚ª${service.price}
                    </div>
                </div>
            `).join('');
        }
        
        function addNewService() {
            services.push({
                name: '×©×™×¨×•×ª ×—×“×©',
                duration: 30,
                price: 100
            });
            renderServices();
            showToast('×©×™×¨×•×ª ×—×“×© × ×•×¡×£! ××œ ×ª×©×›×— ×œ×©××•×¨');
        }
        
        function updateService(index, field, value) {
            if (services[index]) {
                services[index][field] = value;
                console.log('Updated service:', services[index]);
            }
        }
        
        function deleteService(index) {
            if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª "${services[index].name}"?`)) {
                services.splice(index, 1);
                renderServices();
                showToast('×©×™×¨×•×ª × ××—×§! ××œ ×ª×©×›×— ×œ×©××•×¨');
            }
        }
        
        async function saveServices() {
            try {
                const response = await fetch(`/api/update-services/${userId}/${pageId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ services })
                });
                
                if (response.ok) {
                    showToast('âœ… ×”×©×™×¨×•×ª×™× × ×©××¨×• ×‘×”×¦×œ×—×”!');
                    await loadServices(); // Reload to confirm
                } else {
                    throw new Error('Failed to save services');
                }
            } catch (error) {
                console.error('âŒ Failed to save services:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×©×™×¨×•×ª×™×. × ×¡×” ×©×•×‘.');
            }
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function refreshData() {
            loadAppointments();
            if (currentView === 'services') {
                loadServices();
            }
            showToast('×”× ×ª×•× ×™× ×¢×•×“×›× ×•');
        }

        function goBackToPage() {
            window.close();
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 no-print';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);

        // Initialize on load
        if (getUrlParams()) {
            loadAppointments();
            // ğŸ”¥ Also load services on initial load (if services view might be opened)
            loadServices();
        }
    </script>
</body>
</html>
