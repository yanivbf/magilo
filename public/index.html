<!DOCTYPE html>
<html lang="he" dir="rtl">
    <!-- 🚀 VERSION: 2025-01-26-FIX-BOT-JSON 🚀 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPage - דף כניסה</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rubik', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }
        
        .loading-dots {
            display: inline-block;
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        /* Generation Loading Animation Styles */
        .gen-loader {
            width: 60px; 
            height: 60px;
            border-radius: 50%;
            perspective: 800px;
            margin: 0 auto 20px;
        }
        
        .gen-loader .inner {
            position: absolute;
            box-sizing: border-box;
            width: 100%; 
            height: 100%;
            border-radius: 50%;
        }
        
        .gen-loader .inner.one {
            left: 0%; 
            top: 0%;
            animation: rotate-one 1.5s linear infinite;
            border-bottom: 3px solid #8b5cf6;
        }
        
        .gen-loader .inner.two {
            right: 0%; 
            top: 0%;
            animation: rotate-two 1.5s linear infinite;
            border-right: 3px solid #ec4899;
        }
        
        .gen-loader .inner.three {
            right: 0%; 
            bottom: 0%;
            animation: rotate-three 1.5s linear infinite;
            border-top: 3px solid #3b82f6;
        }
        
        @keyframes rotate-one { 
            0% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(0deg); } 
            100% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(360deg); } 
        }
        
        @keyframes rotate-two { 
            0% { transform: rotateX(50deg) rotateY(10deg) rotateZ(0deg); } 
            100% { transform: rotateX(50deg) rotateY(10deg) rotateZ(360deg); } 
        }
        
        @keyframes rotate-three { 
            0% { transform: rotateX(35deg) rotateY(55deg) rotateZ(0deg); } 
            100% { transform: rotateX(35deg) rotateY(55deg) rotateZ(360deg); } 
        }
        
        .gen-text {
            text-align: center;
            font-weight: 500;
            color: #6b7280;
            margin-top: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .debug {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: right;
            max-height: 150px;
            overflow-y: auto;
            word-break: break-all;
        }
        .project-saved-indicator {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .status-badge {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }

        /* Tooltip styles */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            animation: fadeIn 0.2s ease-in-out;
        }
        
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            margin-bottom: 1px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(5px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-processing {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        /* Dropdown Menu Styles */
        .dropdown-menu {
            min-width: 180px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Stav Chat Styles */
        .stav-chat-window {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .stav-chat-window.active {
            display: flex;
        }
        
        .stav-chat-container {
            width: 95%;
            max-width: 1400px;
            height: 90%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .stav-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stav-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
        }
        
        .stav-message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .stav-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .stav-message.bot {
            background: white;
            color: #333;
            margin-left: auto;
            margin-right: 0;
            text-align: right !important;
            direction: rtl !important;
            display: block !important;
            width: 100% !important;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 12px 16px !important;
            text-align: right !important;
            align-self: flex-end !important;
            max-width: none !important;
        }
        
        .typing-text {
            display: inline-block;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .stav-chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }
        
        .stav-chat-input input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .stav-chat-input input:focus {
            border-color: #667eea;
        }
        
        .stav-chat-input button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .stav-chat-input button:hover {
            background: #5a67d8;
        }
        
        .typing-dots {
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0; }
            30% { opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 transition-all duration-500">

    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">

        <div id="login-view" class="w-full max-w-6xl mx-auto hidden">
            <div class="bg-white rounded-2xl shadow-2xl flex flex-col md:flex-row-reverse overflow-hidden">
                <div class="w-full md:w-1/2 p-8 sm:p-12 flex flex-col justify-center">
                    <h1 class="text-4xl md:text-5xl font-bold text-indigo-700 mb-4 leading-tight">דף נחיתה מנצח.<br/>בלחיצת כפתור.</h1>
                    <p class="text-gray-800 text-lg leading-relaxed mb-6">
                        תפסיק לבזבז זמן וכסף. הבוט החכם של AutoPage יבנה לך דף נחיתה מקצועי שממיר גולשים ללקוחות - תוך דקות, בלי צורך בקוד או ידע בעיצוב.
                    </p>
                     <ul class="space-y-4 text-gray-700 mb-8 text-base">
                        <li class="flex items-center gap-3">✨ <b>יצירה מיידית:</b> ענה על כמה שאלות והדף שלך באוויר.</li>
                        <li class="flex items-center gap-3">🎨 <b>עיצוב יוקרתי:</b> בחר מתוך תבניות שנראות כאילו עוצבו בסטודיו.</li>
                        <li class="flex items-center gap-3">🚀 <b>מוכן לצמיחה:</b> חיבור קל לוואטסאפ, אימייל וניהול לידים.</li>
                        <li class="flex items-center gap-3">💡 <b>24/7 בשבילך:</b> הבוט עונה לגולשים גם כשאתה ישן.</li>
                    </ul>
                    
                    <!-- Auth Tabs -->
                    <div class="flex mb-6 border-b border-gray-200">
                        <button id="loginTab" class="flex-1 py-3 px-4 text-center font-medium text-indigo-600 border-b-2 border-indigo-600" onclick="showAuthTab('login')">
                            התחברות
                        </button>
                        <button id="registerTab" class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700" onclick="showAuthTab('register')">
                            הרשמה
                        </button>
                    </div>

                    <!-- Login Form -->
                    <div id="loginForm" class="auth-form">
                        <div class="mb-4">
                            <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">אימייל:</label>
                            <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="הכנס את האימייל שלך">
                        </div>
                        <div class="mb-4">
                            <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">סיסמה:</label>
                            <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="הכנס את הסיסמה שלך">
                        </div>
                        <button onclick="loginWithEmail()" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-indigo-700 transition-transform transform hover:scale-105 mb-3">
                            התחבר
                        </button>
                        <button onclick="resetPassword()" class="w-full text-indigo-600 py-2 px-4 font-medium hover:text-indigo-800 transition">
                            שכחת סיסמה?
                        </button>
                    </div>

                    <!-- Register Form -->
                    <div id="registerForm" class="auth-form hidden">
                        <div class="mb-4">
                            <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-2">אימייל:</label>
                            <input type="email" id="registerEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="הכנס את האימייל שלך">
                        </div>
                        <div class="mb-4">
                            <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-2">סיסמה:</label>
                            <input type="password" id="registerPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="הכנס סיסמה חדשה">
                        </div>
                        <div class="mb-4">
                            <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">אישור סיסמה:</label>
                            <input type="password" id="confirmPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="הכנס שוב את הסיסמה">
                        </div>
                        <button onclick="registerWithEmail()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-green-700 transition-transform transform hover:scale-105 mb-3">
                            הרשם
                        </button>
                    </div>

                    <!-- Divider -->
                    <div class="flex items-center my-6">
                        <div class="flex-1 border-t border-gray-300"></div>
                        <span class="px-4 text-gray-500 text-sm">או</span>
                        <div class="flex-1 border-t border-gray-300"></div>
                    </div>
                    
                    <button id="googleSignInBtn" class="w-full bg-red-600 text-white py-4 px-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 hover:bg-red-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-gray-400">
                        <svg class="w-6 h-6" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span>התחבר עם Google</span>
                    </button>
                    <div id="loading" class="mt-4 flex items-center justify-center gap-2 text-gray-500 hidden">
                        <div class="loader"></div>
                        <span>מתחבר...</span>
                    </div>
                    <div id="error-message" class="bg-red-100 text-red-700 p-3 rounded-lg mt-4 hidden"></div>
                    <div id="success-message" class="bg-green-100 text-green-700 p-3 rounded-lg mt-4 hidden"></div>
                </div>
                
                <aside class="relative bg-slate-100 p-4 w-full md:w-1/2 hidden md:flex items-center justify-center">
                    <div id="slides-container" class="relative w-full max-w-md h-[480px] overflow-hidden rounded-xl shadow-lg">
                        </div>
                    <button id="prev" class="absolute top-1/2 -translate-y-1/2 right-7 bg-white/90 hover:bg-white rounded-full w-9 h-9 grid place-items-center shadow z-10">‹</button>
                    <button id="next" class="absolute top-1/2 -translate-y-1/2 left-7 bg-white/90 hover:bg-white rounded-full w-9 h-9 grid place-items-center shadow z-10">›</button>
                    <div id="dots" class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-2 z-10"></div>
                </aside>
            </div>
        </div>


        <div id="dashboard-view" class="w-full max-w-5xl hidden">
            <div class="bg-slate-50 p-4 rounded-2xl shadow-2xl">
                <!-- כפתורי פעולה ראשיים -->
                <div class="flex justify-end gap-4 mb-1">
                    <button id="account-summary-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <svg class="w-5 h-5 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        סיכום חשבון
                    </button>
                    <a href="/marketplace.html" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Marketplace
                    </a>
                    <button id="stav-chat-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        🤖 סתיו
                    </button>
                    <button id="admin-panel-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors hidden">
                        <svg class="w-5 h-5 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31-2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        פאנל מנהל
                    </button>
                </div>
                
                <!-- User info and logout button -->
                <div class="flex items-center justify-between mb-1 pb-1 border-b border-gray-200">
                    <div class="flex items-center gap-2">
                        <img id="user-avatar" src="https://placehold.co/80x80/E2E8F0/4A5568?text=U" alt="תמונת פרופיל" class="w-8 h-8 rounded-full object-cover">
                        <div class="text-right">
                            <div id="user-name" class="font-semibold text-gray-700 text-xs">
                                <span class="loading-dots">טוען</span>
                            </div>
                            <div id="subscription-status" class="text-xs text-gray-500">
                                <span id="subscription-badge" class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <span id="subscription-text">משתמש רשום</span>
                                </span>
                            </div>
                        </div>
                        <button onclick="signOut()" title="התנתק" class="text-gray-500 hover:text-red-600 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>
                </div>

                <div id="projects-section">
                    <div class="flex justify-between items-center mb-1">
                         <h2 class="text-2xl font-bold text-gray-800">דפי הנחיתה שלי</h2>
                        <button onclick="goToFullApp()" class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-bold hover:bg-indigo-700 transition-transform transform hover:scale-105 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span>דף חדש</span>
                        </button>
                    </div>
                    <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Subscription Modal -->
    <div id="page-subscription-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">הפעל מנוי לצפייה בדף</h3>
                        <p class="text-gray-600">הפעל מנוי חודשי ב-₪39 לצפייה בדף זה</p>
                    </div>
                
                <div class="space-y-4 mb-6">
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">גישה מלאה לדף</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">קישור קבוע לדף</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">עדכונים אוטומטיים</span>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-indigo-600 mb-1">₪39</div>
                        <div class="text-sm text-gray-500">לחודש</div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="closePageSubscriptionModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-300 transition">
                        ביטול
                    </button>
                        <button onclick="processPageSubscription()" class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-indigo-700 transition">
                            הפעל מנוי
                        </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subscription-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">מנוי AutoPage Pro</h3>
                    <p class="text-gray-600">התחל מנוי חודשי ב-₪39 וקבל גישה מלאה</p>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">יצירת דפים ללא הגבלה</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">קישור קבוע לדף שלך</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">תמיכה טכנית 24/7</span>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-indigo-600 mb-1">₪39</div>
                        <div class="text-sm text-gray-500">לחודש</div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeSubscriptionModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-300 transition">
                        ביטול
                    </button>
                    <button onclick="processSubscription()" class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-indigo-700 transition">
                        התחל מנוי
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="fixed inset-0 bg-gray-100 z-50 hidden">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <div class="w-64 bg-white shadow-lg border-l border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h1 class="text-xl font-bold text-gray-800">פאנל מנהל</h1>
                        <button id="close-admin-panel" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <nav class="mt-6">
                    <div class="px-3 space-y-1">
                        <button id="dashboard-tab" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-white bg-indigo-600">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v1H8V5z"></path>
                            </svg>
                            דשבורד
                        </button>
                        
                        <button id="users-tab" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            משתמשים
                        </button>
                        
                        <button id="finance-tab" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                            כספים
                        </button>
                        
                        <button id="analytics-tab" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            סטטיסטיקות
                        </button>
                        
                        <button id="settings-tab" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            הגדרות
                        </button>

                        <a href="/marketplace.html" target="_blank" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-indigo-700 bg-indigo-50 hover:bg-indigo-100 hover:text-indigo-900 mt-2">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h5l2 3h8a1 1 0 011 1v11a2 2 0 01-2 2H5a2 2 0 01-2-2V4z"/>
                            </svg>
                            Marketplace
                        </a>
                    </div>
                </nav>
            </div>
            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Top Bar -->
                <header class="bg-white shadow-sm border-b border-gray-200">
                    <div class="px-6 py-4">
                        <div class="flex items-center justify-between">
                            <h2 id="admin-page-title" class="text-2xl font-semibold text-gray-800">דשבורד</h2>
                            <div class="flex items-center space-x-4">
                                <div class="text-sm text-gray-500">
                                    <span id="admin-current-time"></span>
                                </div>
                                <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                    A
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
                
                <!-- Content Area -->
                <main class="flex-1 overflow-y-auto bg-gray-50 p-6">

                    <!-- Dashboard Content -->
                    <div id="dashboard-content" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">משתמשים במערכת</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="dashboard-total-users">0</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">הכנסות חודשיות</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="dashboard-monthly-revenue">₪0</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">דפים פעילים</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="dashboard-active-pages">0</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-amber-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">דפים לא פעילים</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="dashboard-inactive-pages">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">פעילות אחרונה</h3>
                                </div>
                                <div class="p-6 max-h-96 overflow-y-auto">
                                    <div id="recent-activity" class="space-y-4">
                                        <!-- פעילות אמיתית תיטען כאן -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">סטטיסטיקות מהירות</h3>
                                </div>
                                <div class="p-6">
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium text-gray-500">משתמשים חדשים השבוע</span>
                                            <span class="text-sm font-semibold text-gray-900" id="weekly-new-users">1</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium text-gray-500">דפים שנוצרו השבוע</span>
                                            <span class="text-sm font-semibold text-gray-900" id="weekly-new-pages">0</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium text-gray-500">הכנסות השבוע</span>
                                            <span class="text-sm font-semibold text-gray-900" id="weekly-revenue">₪0</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium text-gray-500">שיעור המרה</span>
                                            <span class="text-sm font-semibold text-gray-900" id="conversion-rate">100%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Management Content -->
                    <div id="users-content" class="tab-content hidden">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-medium text-gray-900">ניהול משתמשים</h3>
                                    <button class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">
                                        משתמש חדש
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">משתמש</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">אימייל</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">תאריך הצטרפות</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מנוי</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">פעולות</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Finance Management Content -->
                    <div id="finance-content" class="tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">הכנסות חודשיות</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="monthly-revenue">₪2,450</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">משתמשים מחוברים</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="active-users">1</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">דפים שנוצרו</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="total-pages">47</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">היסטוריית תשלומים</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">משתמש</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סכום</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">תאריך</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סטטוס</th>
                                        </tr>
                                    </thead>
                                    <tbody id="payments-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Payments will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Content -->
                    <div id="analytics-content" class="tab-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">סטטוס דפים</h3>
                                </div>
                                <div class="p-6">
                                    <div id="pages-status-chart" class="h-64 flex items-center justify-center">
                                        <div class="text-center">
                                            <div class="w-32 h-32 mx-auto mb-4 relative">
                                                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                                                    <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                                                    <circle id="pages-progress" cx="50" cy="50" r="40" stroke="#10b981" stroke-width="8" fill="none" 
                                                            stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"/>
                                                </svg>
                                                <div class="absolute inset-0 flex items-center justify-center">
                                                    <span id="pages-percentage" class="text-2xl font-bold text-gray-700">0%</span>
                                                </div>
                                            </div>
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between text-sm">
                                                    <span class="text-gray-600">דפים פעילים</span>
                                                    <span id="active-pages-count" class="font-medium">0</span>
                                                </div>
                                                <div class="flex items-center justify-between text-sm">
                                                    <span class="text-gray-600">דפים לא פעילים</span>
                                                    <span id="inactive-pages-count" class="font-medium">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">הכנסות חודשיות</h3>
                                </div>
                                <div class="p-6">
                                    <div id="revenue-chart" class="h-64 flex items-center justify-center">
                                        <div class="text-center">
                                            <div class="text-4xl font-bold text-green-600 mb-2" id="monthly-revenue-display">₪0</div>
                                            <div class="text-sm text-gray-500 mb-4">הכנסות החודש</div>
                                            <div class="space-y-3">
                                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                                    <span class="text-sm text-gray-600">דפים פעילים</span>
                                                    <span id="revenue-active-pages" class="font-medium text-green-600">0</span>
                                                </div>
                                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                    <span class="text-sm text-gray-600">דפים לא פעילים</span>
                                                    <span id="revenue-inactive-pages" class="font-medium text-gray-600">0</span>
                                                </div>
                                                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                                    <span class="text-sm text-gray-600">פוטנציאל הכנסות</span>
                                                    <span id="revenue-potential" class="font-medium text-blue-600">₪0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-lg font-medium text-gray-900">פעילות</h3>
                                        <div class="flex bg-gray-100 rounded-lg p-1">
                                            <button id="daily-btn" class="px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md transition-colors" onclick="changeActivityPeriod('daily')">יומי</button>
                                            <button id="weekly-btn" class="px-3 py-1 text-sm font-medium bg-white text-gray-900 shadow-sm rounded-md transition-colors" onclick="changeActivityPeriod('weekly')">שבועי</button>
                                            <button id="monthly-btn" class="px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md transition-colors" onclick="changeActivityPeriod('monthly')">חודשי</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div id="weekly-activity-chart" class="h-64">
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-blue-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">דפים שנוצרו השבוע</span>
                                                </div>
                                                <span id="weekly-pages-created" class="font-bold text-blue-600">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-green-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">דפים שהופעלו השבוע</span>
                                                </div>
                                                <span id="weekly-pages-activated" class="font-bold text-green-600">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-purple-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">הכנסות השבוע</span>
                                                </div>
                                                <span id="weekly-revenue-display" class="font-bold text-purple-600">₪0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">סטטיסטיקות משתמשים</h3>
                                </div>
                                <div class="p-6">
                                    <div id="users-stats-chart" class="h-64">
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between p-4 bg-indigo-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-indigo-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">סה"כ משתמשים מחוברים</span>
                                                </div>
                                                <span id="total-users-count" class="font-bold text-indigo-600">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-green-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">משתמשים מחוברים</span>
                                                </div>
                                                <span id="active-users-count" class="font-bold text-green-600">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-4 bg-amber-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-amber-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">משתמשים לא מחוברים</span>
                                                </div>
                                                <span id="inactive-users-count" class="font-bold text-amber-600">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-red-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">שיעור המרה</span>
                                                </div>
                                                <span id="conversion-rate-display" class="font-bold text-red-600">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Content -->
                    <div id="settings-content" class="tab-content hidden">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">הגדרות מערכת</h3>
                            </div>
                            <div class="p-6">
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">שם המערכת</label>
                                        <input type="text" value="AutoPage" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">אימייל מנהל</label>
                                        <input type="email" value="admin@autopage.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">הגדרות אבטחה</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" checked class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="mr-2 text-sm text-gray-700">דורש אימות דו-שלבי</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="mr-2 text-sm text-gray-700">הגבל מספר ניסיונות התחברות</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ניקוי נתונים</label>
                                        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                                            <p class="text-sm text-gray-700 mb-3">
                                                🧹 נקה נתונים יתומים (קניות ומוזמנים מדפים שנמחקו)
                                            </p>
                                            <button onclick="cleanOrphanedData()" class="bg-yellow-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-yellow-700">
                                                🗑️ נקה נתונים יתומים
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex justify-end">
                                        <button class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">
                                            שמור הגדרות
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Stav Chat Window -->
    <div class="stav-chat-window" id="stavChatWindow">
        <div class="stav-chat-container">
            <div class="stav-chat-header">
                <h2>🤖 סתיו</h2>
                <button onclick="toggleStavChat()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
            </div>
        <div class="stav-chat-messages" id="stavChatMessages">
            <div class="stav-message bot">
                שלום! 😊 איך אני יכולה לעזור לך?
            </div>
        </div>
            <div class="stav-chat-input">
                <input type="text" id="stavChatInput" placeholder="כתוב הודעה...">
                <button onclick="sendStavMessage()">שלח</button>
            </div>
        </div>
    </div>

    <!-- Responsive overrides for Stav chat -->
    <style>
        .stav-chat-window { z-index: 9999; position: fixed; right: 24px; bottom: 24px; }
        .stav-chat-window.fullscreen { inset: 0 !important; right: 0 !important; left: 0 !important; top: 0 !important; bottom: 0 !important; width: 100vw !important; height: 100vh !important; margin: 0 !important; padding: 0 !important; }
        .stav-chat-container { display: flex !important; flex-direction: column !important; }
        .stav-chat-window.fullscreen .stav-chat-container { width: 100% !important; max-width: none !important; height: 100% !important; margin: 0 !important; border-radius: 0 !important; }
        .stav-chat-header { flex: 0 0 auto !important; }
        .stav-chat-messages { flex: 1 1 auto !important; overflow-y: auto !important; }
        .stav-chat-input { flex: 0 0 auto !important; }
        @media (max-width: 640px) {
            .stav-chat-window { left: 4vw; right: 4vw; bottom: calc(16px + env(safe-area-inset-bottom)); }
            .stav-chat-container { width: 100%; max-height: min(70vh, 560px); border-radius: 16px; overflow: hidden; }
            .stav-chat-messages { max-height: none !important; }
            .stav-chat-input { padding-bottom: max(8px, env(safe-area-inset-bottom)); }
        }
    </style>
    <script>
        // --- Local fallback logic to avoid repeating the same greeting and answer simple queries ---
        let stavFirstReplySent = false;
        function stavLocalFallbackReply(message) {
            try {
                const raw = (message || '').toString();
                const msg = raw.trim();
                const lower = msg.toLowerCase();

                // Greetings
                if (/^(היי|הי|שלום)[!\s\u200f\u200e]*$/i.test(msg)) {
                    return stavFirstReplySent
                        ? 'היי! כאן לעזור. על מה תרצה לשוחח?'
                        : 'היי! 😊 איך אני יכולה לעזור לך?';
                }

                // Introductions / names
                if (/(אני|קוראים לי)\s*יניב/i.test(msg)) {
                    return 'היי יניב! 😊 נעים להכיר! איך אפשר לעזור?';
                }

                // Simple general knowledge example
                if (/מה\s+גודל\s+(כדור\s*הארץ|הארץ)/i.test(lower)) {
                    return 'קוטר כדור הארץ בערך 12,742 ק״מ (רדיוס ~6,371 ק״מ).';
                }

                // Default helpful prompt
                return 'קיבלתי! ספר/י קצת יותר מה את/ה מחפש/ת, ואכוון אותך.';
            } catch (_) {
                return 'הבנתי! איך אוכל לעזור?';
            }
        }
        // === AUTO-OPEN STAV FROM MARKETPLACE ===
        // Check if we came from marketplace with a pending message
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('openStav') === 'true' && window.innerWidth >= 768) { // don't auto-open on small screens
                const pendingMessage = localStorage.getItem('stavPendingMessage');
                if (pendingMessage) {
                    // Open Stav chat
                    setTimeout(() => {
                        toggleStavChat();
                        // Set the message and send it
                        const stavInput = document.getElementById('stavChatInput');
                        if (stavInput) {
                            stavInput.value = pendingMessage;
                            localStorage.removeItem('stavPendingMessage');
                            setTimeout(() => {
                                sendStavMessage();
                            }, 500);
                        }
                    }, 300);
                }
            }
        });

        // Force fullscreen when chat opens
        window.addEventListener('DOMContentLoaded', function() {
            const win = document.getElementById('stavChatWindow');
            if (win) {
                const origToggle = window.toggleStavChat;
                window.toggleStavChat = function() {
                    if (typeof origToggle === 'function') origToggle();
                    win.classList.add('fullscreen');
                }
            }
        });

        // --- Performance Optimization for Edge ---
        // Keep console.log enabled for debugging (commented out the disabling)
        // const isEdge = navigator.userAgent.indexOf('Edg') > -1;
        // if (isEdge) {
        //     // Completely disable console in Edge
        //     console.log = function() {};
        //     console.info = function() {};
        //     console.debug = function() {};
        //     console.warn = function() {};
        //     
        //     // Add timeout protection for all async operations
        //     window.EDGE_TIMEOUT = 5000; // 5 seconds max for any operation
        //     
        //     // Disable all animations in Edge
        //     document.documentElement.style.setProperty('--animation-duration', '0s');
        // }
        
        // --- הגדרות ---
        const supabaseUrl = 'https://osoqfadqohqcauawzmmq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zb3FmYWRxb2hxY2F1YXd6bW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2OTIzMjMsImV4cCI6MjA3MzI2ODMyM30.TBLmKIntYGSfBm2StItfWm87-ebojV_NbaKNcYNWMPg';
        const googleClientId = '589919062235-o6ohhnon54a12dav2lg24goh1m4ks43p.apps.googleusercontent.com';

        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);
        let currentUser = null;
        let subscriptionData = null;
        let subscriptionTimer = null;
        let currentPageForSubscription = null;
        let projects = []; // Global projects array for manageProject access

        // --- Admin Variables ---
        const ADMIN_USER_ID = 'fae06b49-1239-4ba5-93db-244ce2851fb4'; // המנהל הנוכחי
        let isAdmin = false;
        let adminTimeInterval = null; // Prevent memory leak from multiple intervals
        let isDashboardLoading = false; // Prevent multiple simultaneous dashboard loads
        let loadProjectsTimeout = null; // Debounce loadProjects calls
        let isLoadingProjects = false; // Prevent concurrent loadProjects calls

        // --- User Session Management ---
        function saveCurrentUser(user) {
            if (user) {
                sessionStorage.setItem('currentUser', JSON.stringify(user));
            }
        }

        function loadCurrentUser() {
            try {
                const stored = sessionStorage.getItem('currentUser');
                return stored ? JSON.parse(stored) : null;
            } catch (error) {
                console.error('Error loading user from session:', error);
                return null;
            }
        }

        function clearCurrentUser() {
            sessionStorage.removeItem('currentUser');
        }

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const adminPanel = document.getElementById('admin-panel');
        const closeAdminPanel = document.getElementById('close-admin-panel');
        const adminPageTitle = document.getElementById('admin-page-title');
        const adminCurrentTime = document.getElementById('admin-current-time');
        
        // --- Subscription Functions ---
        function openSubscriptionModal() {
            document.getElementById('subscription-modal').classList.remove('hidden');
        }

        function closeSubscriptionModal() {
            document.getElementById('subscription-modal').classList.add('hidden');
        }

        async function processSubscription() {
            if (!currentUser) {
                showError('עליך להיות מחובר כדי לרכוש מנוי');
                return;
            }

            // סימולציה של תשלום - בפועל כאן יהיה שילוב עם מערכת תשלומים
            try {
                // יצירת מנוי חדש
                const subscriptionEndDate = new Date();
                subscriptionEndDate.setMonth(subscriptionEndDate.getMonth() + 1);

                subscriptionData = {
                    userId: currentUser.id,
                    startDate: new Date().toISOString(),
                    endDate: subscriptionEndDate.toISOString(),
                    isActive: true,
                    pageUrl: `${window.location.origin}/pages/${currentUser.id}/landing.html`
                };

                // שמירה ב-localStorage (בפועל יהיה בבסיס נתונים)
                localStorage.setItem(`subscription_${currentUser.id}`, JSON.stringify(subscriptionData));

                closeSubscriptionModal();
                // updateSubscriptionUI(); // לא נדרש יותר
                startSubscriptionCountdown();
                
                showSuccess('המנוי הופעל בהצלחה!');
                
            } catch (error) {
                console.error('Subscription error:', error);
                showError('שגיאה בהפעלת המנוי');
            }
        }

        function updateSubscriptionUI() {
            // הפונקציה הזו כבר לא נדרשת כי הסרנו את האלמנטים מהדף הראשי
            // כל המנויים הם פרטיים לכל דף
            console.log('updateSubscriptionUI called - no longer needed');
        }

        function startSubscriptionCountdown() {
            if (!subscriptionData || !subscriptionData.isActive) return;

            const subscriptionCountdown = document.getElementById('subscription-countdown');
            
            function updateCountdown() {
                const now = new Date().getTime();
                const endDate = new Date(subscriptionData.endDate).getTime();
                const timeLeft = endDate - now;

                if (timeLeft <= 0) {
                    // המנוי פג
                    subscriptionData.isActive = false;
                    localStorage.setItem(`subscription_${currentUser.id}`, JSON.stringify(subscriptionData));
                    // updateSubscriptionUI(); // לא נדרש יותר
                    showError('המנוי שלך פג. אנא חדש את המנוי להמשך השימוש.');
                    // Clear interval when subscription expires
                    if (subscriptionTimer) {
                        clearInterval(subscriptionTimer);
                        subscriptionTimer = null;
                    }
                    return;
                }

                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));

                subscriptionCountdown.textContent = `נותרו: ${days} ימים, ${hours} שעות, ${minutes} דקות`;
            }

            updateCountdown();
            // Clear previous interval to prevent memory leak
            if (subscriptionTimer) {
                clearInterval(subscriptionTimer);
            }
            subscriptionTimer = setInterval(updateCountdown, 60000); // עדכון כל דקה
        }

        function loadSubscriptionData() {
            if (!currentUser) return;
            
            const stored = localStorage.getItem(`subscription_${currentUser.id}`);
            if (stored) {
                subscriptionData = JSON.parse(stored);
                
                // בדוק אם המנוי עדיין פעיל
                const now = new Date().getTime();
                const endDate = new Date(subscriptionData.endDate).getTime();
                
                if (now > endDate) {
                    subscriptionData.isActive = false;
                    localStorage.setItem(`subscription_${currentUser.id}`, JSON.stringify(subscriptionData));
                }
            }
            
            // updateSubscriptionUI(); // לא נדרש יותר
        }

        // --- Page Subscription Functions ---
        function openPageSubscriptionModal(pageId) {
            console.log('Opening subscription modal for page:', pageId);
            currentPageForSubscription = pageId;
            document.getElementById('page-subscription-modal').classList.remove('hidden');
        }

        function closePageSubscriptionModal() {
            document.getElementById('page-subscription-modal').classList.add('hidden');
            currentPageForSubscription = null;
        }

        // --- Account Summary Modal Functions ---
        function openAccountSummaryModal() {
            document.getElementById('account-summary-modal').classList.remove('hidden');
            // עדכן את הנתונים במודל עם נתונים אמיתיים
            updateModalAccountSummary();
        }

        function closeAccountSummaryModal() {
            document.getElementById('account-summary-modal').classList.add('hidden');
        }

        async function updateModalAccountSummary() {
            console.log('=== updateModalAccountSummary called ===');
            console.log('Current user:', currentUser);
            
            if (!currentUser || !currentUser.id) {
                console.log('No current user, skipping modal update');
                return;
            }

            try {
                // קבל את הדפים מהשרת (כמו ב-loadProjects)
                console.log('Fetching pages from server...');
                const response = await fetch(`/api/pages/${currentUser.id}`);
                const serverData = await response.json();
                const serverPages = serverData.pages || [];
                console.log('Server pages for modal:', serverPages);
                
                // קבל גם דפים מקומיים
                const localData = JSON.parse(localStorage.getItem('autopage_data') || '{}');
                const localPages = localData.pages || [];
                console.log('Local pages for modal:', localPages);
                
                // שלב את הנתונים
                const allPages = [...serverPages, ...localPages];
                console.log('All pages for modal:', allPages);

                // ספור מנויים פעילים - בדוק גם localStorage וגם השרת
                // משתמש ב-localStorage כי עדיין לא כל המנויים מסונכרנים לשרת
                let activeSubscriptions = 0;
                allPages.forEach(page => {
                    // בדוק תחילה את localStorage (כי עדיין לא כל המנויים מסונכרנים)
                    const pageKey = `local_${page.fileName}`;
                    const pageSubscription = localStorage.getItem(`page_subscription_${pageKey}`);
                    
                    let isActive = false;
                    
                    // בדוק localStorage תחילה (כי המנויים עדיין שם)
                    if (pageSubscription) {
                        try {
                            const subscriptionData = JSON.parse(pageSubscription);
                            if (subscriptionData && subscriptionData.isActive === true) {
                                isActive = true;
                            }
                        } catch (e) {
                            console.error('Error parsing subscription:', e);
                        }
                    }
                    
                    // אם localStorage לא נמצא, בדוק את השרת
                    if (!isActive && page.isActive === true) {
                        isActive = true;
                    }
                    
                    if (isActive) {
                        activeSubscriptions++;
                    }
                });

                console.log(`Modal - Total pages: ${allPages.length}, Active subscriptions: ${activeSubscriptions}`);
                console.log('Modal - Pages with isActive:', allPages.map(p => ({ 
                    fileName: p.fileName, 
                    isActive: p.isActive, 
                    type: typeof p.isActive 
                })));

                // חשב חיוב חודשי (₪39 לכל דף פעיל בלבד)
                const monthlyCharge = activeSubscriptions * 39;
                const lastUpdateTime = new Date().toLocaleString('he-IL');

                // עדכן את המודל
                document.getElementById('modal-account-total-pages').textContent = allPages.length;
                document.getElementById('modal-account-active-pages').textContent = activeSubscriptions;
                document.getElementById('modal-account-monthly-charge').textContent = `₪${monthlyCharge}`;
                document.getElementById('modal-last-update').textContent = lastUpdateTime;

                // עדכן את התצוגות המקדימות הקטנות
                document.getElementById('modal-total-pages-icon').textContent = allPages.length;
                document.getElementById('modal-active-pages-icon').textContent = activeSubscriptions;
                document.getElementById('modal-monthly-charge-amount').textContent = monthlyCharge;

                console.log('Modal Account Summary Updated:', {
                    totalPages: allPages.length,
                    activePages: activeSubscriptions,
                    monthlyCharge,
                    serverPages: serverPages.length,
                    localPages: localPages.length
                });

            } catch (error) {
                console.error('Error updating modal account summary:', error);
                // הצג נתונים ברירת מחדל
                document.getElementById('modal-account-total-pages').textContent = '0';
                document.getElementById('modal-account-active-pages').textContent = '0';
                document.getElementById('modal-account-monthly-charge').textContent = '₪0';
                document.getElementById('modal-last-update').textContent = new Date().toLocaleString('he-IL');
            }
        }

        async function processPageSubscription() {
            console.log('🔔 Processing subscription for:', currentPageForSubscription);
            console.log('👤 Current user:', currentUser);
            
            if (!currentUser || !currentPageForSubscription) {
                showError('שגיאה בפרטי המנוי');
                return;
            }

            try {
                // יצירת מנוי לדף ספציפי
                const subscriptionEndDate = new Date();
                subscriptionEndDate.setMonth(subscriptionEndDate.getMonth() + 1);

                const pageSubscriptionData = {
                    pageId: currentPageForSubscription,
                    userId: currentUser.id,
                    startDate: new Date().toISOString(),
                    endDate: subscriptionEndDate.toISOString(),
                    isActive: true
                };

                // שמירה ב-localStorage
                const storageKey = `page_subscription_${currentPageForSubscription}`;
                localStorage.setItem(storageKey, JSON.stringify(pageSubscriptionData));
                console.log('✅ Subscription saved to localStorage with key:', storageKey);
                console.log('📦 Subscription data:', pageSubscriptionData);
                
                // בדוק שהנתונים נשמרו בהצלחה
                const savedData = localStorage.getItem(storageKey);
                console.log('🔍 Verification - data saved?', savedData !== null);

                closePageSubscriptionModal();
                
                // עדכן את הכרטיס מיידית
                console.log('🔄 Looking for project card:', currentPageForSubscription);
                const projectCard = document.querySelector(`[data-project-id="${currentPageForSubscription}"]`);
                console.log('📌 Project card found:', projectCard !== null);
                
                if (projectCard) {
                    // מצא את אזור הכפתורים - עדכנו את ה-selector
                    const actionButtonsDiv = projectCard.querySelector('.flex.items-center.justify-between');
                    console.log('🔘 Action buttons div found:', actionButtonsDiv !== null);
                    
                    if (actionButtonsDiv) {
                        // מצא את הכפתור הצהוב "הפעל מנוי" והחלף אותו בכפתור ירוק "צפה"
                        const subscribeBtn = actionButtonsDiv.querySelector('button.bg-yellow-500');
                        if (subscribeBtn) {
                            subscribeBtn.outerHTML = `
                                <button onclick="viewProject('${currentPageForSubscription}')" class="bg-green-500 text-white px-3 py-2 rounded text-sm font-medium hover:bg-green-600 transition shadow-sm" style="min-width: 60px;">
                                    צפה
                                </button>`;
                            console.log('✅ Button updated successfully!');
                        }
                        
                        // עדכן את התג של הסטטוס
                        const statusBadge = projectCard.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.className = 'status-badge status-completed';
                            statusBadge.textContent = 'מנוי פעיל';
                        }
                        
                        // עדכן את התג בפינה של התמונה
                        const cornerBadge = projectCard.querySelector('.absolute.top-3.right-3 > div');
                        if (cornerBadge) {
                            cornerBadge.className = 'bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1';
                            cornerBadge.innerHTML = `
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                זמין לצפייה`;
                        }
                    }
                }
                
                showSuccess('המנוי לדף הופעל בהצלחה! כעת ניתן לצפות בדף');
                
                // רענן את הדשבורד לאחר שניה
                setTimeout(() => {
                    console.log('🔄 Reloading projects...');
                    loadProjects();
                }, 1000);
                
            } catch (error) {
                console.error('❌ Page subscription error:', error);
                showError('שגיאה בהפעלת המנוי לדף');
            }
        }
        
        // --- לוגיקת אימות ---
        window.onload = async function() {
            console.log("=== PAGE LOAD CHECK ===");
            
            // בדוק אם חזרנו מיצירת דף חדש
            const urlParams = new URLSearchParams(window.location.search);
            const fromCreator = urlParams.get('fromCreator');
            if (fromCreator === 'true') {
                // נקה את הפרמטר מה-URL
                window.history.replaceState({}, document.title, window.location.pathname);
                // עדכן את המודל אם הוא פתוח (רק אם באמת צריך)
                // הוסר רענון אוטומטי שגרם לבעיות
            }
            
            // נסה לטעון משתמש מ-sessionStorage
            const savedUser = loadCurrentUser();
            if (savedUser) {
                console.log("Found saved user in session:", savedUser.email);
                currentUser = savedUser;
                // המתן קצת לפני הצגת הדשבורד
                setTimeout(() => {
                showDashboard();
                }, 100);
                return;
            }
            
            console.log("Supabase URL:", supabaseUrl);
            console.log("Supabase Key:", supabaseKey ? 'Present' : 'Missing');
            
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                console.log("Session data:", session);
                console.log("Session error:", error);
                
                if (session && session.user) {
                    console.log("Found existing session!");
                    console.log("User ID:", session.user.id);
                    console.log("User email:", session.user.email);
                    currentUser = session.user;
                    saveCurrentUser(currentUser);
                    setTimeout(() => {
                    showDashboard();
                    }, 100);
                } else {
                    console.log("No session found, showing login");
                    loginView.classList.remove('hidden');
                    initGoogleSignIn();
                }
            } catch (err) {
                console.error("Error checking session:", err);
                loginView.classList.remove('hidden');
                initGoogleSignIn();
            }
        };

        function initCarousel() {
            const DEMOS = [
                {src:'https://images.pexels.com/photos/1779487/pexels-photo-1779487.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'דף נחיתה לעסק'},
                {src:'https://images.pexels.com/photos/262978/pexels-photo-262978.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'תפריט למסעדה'},
                {src:'https://images.pexels.com/photos/374631/pexels-photo-374631.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'קטלוג מוצרים'},
                {src:'https://images.pexels.com/photos/5077063/pexels-photo-5077063.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'פוסט שיווקי'},
                {src:'https://images.pexels.com/photos/4050315/pexels-photo-4050315.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'כרטיס ביקור דיגיטלי'},
                {src:'https://images.pexels.com/photos/326503/pexels-photo-326503.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'אתר תדמית'}
            ];
            const slidesContainer = document.getElementById('slides-container');
            if (slidesContainer) {
                const dotsC = document.getElementById('dots');
                const prevBtn = document.getElementById('prev');
                const nextBtn = document.getElementById('next');
                const count = DEMOS.length;
                let i = 0;
                let timer;
                slidesContainer.innerHTML = DEMOS.map((d) => `
                    <figure class="absolute inset-0 w-full h-full transition-opacity duration-700 ease-in-out opacity-0">
                        <img loading="lazy" src="${d.src}" alt="${d.caption}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https.placehold.co/800x600/cccccc/ffffff?text=Image+Not+Found';">
                        <figcaption class="absolute bottom-3 right-3 bg-white/85 px-3 py-1 rounded text-xs font-medium text-gray-700 shadow">${d.caption}</figcaption>
                    </figure>
                `).join('');
                const slides = Array.from(slidesContainer.children);
                dotsC.innerHTML = DEMOS.map(() => '<button class="w-2.5 h-2.5 rounded-full bg-white/60 transition-colors"></button>').join('');
                const dots = [...dotsC.children];
                function setDot() { dots.forEach((d, j) => { d.className = 'w-2.5 h-2.5 rounded-full transition-colors ' + (j === i ? 'bg-white shadow' : 'bg-white/60'); }); }
                function go(n) { i = (n + count) % count; slides.forEach((slide, index) => { slide.classList.toggle('opacity-100', index === i); }); setDot(); }
                function reset() { clearInterval(timer); auto(); }
                function auto() { timer = setInterval(() => go(i + 1), 5000); }
                prevBtn.onclick = () => { go(i - 1); reset(); };
                nextBtn.onclick = () => { go(i + 1); reset(); };
                dots.forEach((d, idx) => d.onclick = () => { go(idx); reset(); });
                go(0);
                auto();
            }
        }

        // --- פונקציות אימות רגיל ---
        function showAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.className = 'flex-1 py-3 px-4 text-center font-medium text-indigo-600 border-b-2 border-indigo-600';
                registerTab.className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.className = 'flex-1 py-3 px-4 text-center font-medium text-indigo-600 border-b-2 border-indigo-600';
                loginTab.className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }
        async function loginWithEmail() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            console.log("=== LOGIN ATTEMPT ===");
            console.log("Email:", email);
            
            if (!email || !password) {
                showError('אנא מלא את כל השדות');
                return;
            }
            
            showLoading(true);
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                console.log("Login response:", { data, error });
                
                if (error) {
                    console.error("Login error:", error);
                    showError('שגיאה בהתחברות: ' + error.message);
                } else if (data && data.user) {
                    console.log("Login successful!");
                    console.log("User ID:", data.user.id);
                    currentUser = data.user;
                    saveCurrentUser(currentUser);
                    setTimeout(() => {
                    showDashboard();
                    }, 100);
                } else {
                    console.error("No user data in response");
                    showError('שגיאה בהתחברות');
                }
            } catch (error) {
                console.error("Login exception:", error);
                showError('שגיאה בהתחברות');
            } finally {
                showLoading(false);
            }
        }

        async function registerWithEmail() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!email || !password || !confirmPassword) {
                showError('אנא מלא את כל השדות');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('הסיסמאות אינן תואמות');
                return;
            }
            
            if (password.length < 6) {
                showError('הסיסמה חייבת להכיל לפחות 6 תווים');
                return;
            }
            
            showLoading(true);
            
            try {
                console.log("=== REGISTRATION ATTEMPT ===");
                console.log("Email:", email);
                
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: email.split('@')[0],
                            full_name: email.split('@')[0]
                        }
                    }
                });
                
                console.log("Registration response:", { data, error });
                
                if (error) {
                    console.error("Registration error:", error);
                    showError('שגיאה בהרשמה: ' + error.message);
                } else if (data && data.user) {
                    console.log("Registration successful!");
                    console.log("User ID:", data.user.id);
                    showSuccess('הרשמה בוצעה בהצלחה! בדוק את האימייל שלך לאישור החשבון.');
                    // עבר לטב התחברות
                    showAuthTab('login');
                    // נקה את השדות
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    console.error("No user data in registration response");
                    showError('שגיאה בהרשמה');
                }
            } catch (error) {
                showError('שגיאה בהרשמה');
            } finally {
                showLoading(false);
            }
        }

        async function resetPassword() {
            const email = document.getElementById('loginEmail').value;
            
            if (!email) {
                showError('אנא הכנס את האימייל שלך תחילה');
                return;
            }
            
            showLoading(true);
            
            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/reset-password'
                });
                
                if (error) {
                    showError('שגיאה בשליחת אימייל שחזור: ' + error.message);
                } else {
                    showSuccess('נשלח אימייל שחזור סיסמה. בדוק את תיבת הדואר שלך.');
                }
            } catch (error) {
                showError('שגיאה בשליחת אימייל שחזור');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            if (show) {
                loadingEl.classList.remove('hidden');
            } else {
                loadingEl.classList.add('hidden');
            }
        }

        function showSuccess(message) {
            // יצירת הודעת הצלחה זמנית
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        function initGoogleSignIn() {
            console.log("=== INIT GOOGLE SIGNIN ===");
            if (typeof google === 'undefined') {
                console.log("Google not loaded yet, retrying...");
                setTimeout(initGoogleSignIn, 100);
                return;
            }
            
            console.log("Google loaded, initializing...");
            initCarousel();
            google.accounts.id.initialize({
                client_id: googleClientId,
                callback: handleGoogleResponse,
                auto_select: false,
                cancel_on_tap_outside: false,
            });
            
            // Use renderButton instead of prompt() - more reliable
            const buttonDiv = document.getElementById('googleSignInBtn');
            
            // Hide the custom button and create a wrapper for Google's button
            buttonDiv.style.display = 'none';
            const googleButtonWrapper = document.createElement('div');
            googleButtonWrapper.id = 'google-button-wrapper';
            googleButtonWrapper.style.width = '100%';
            buttonDiv.parentNode.insertBefore(googleButtonWrapper, buttonDiv.nextSibling);
            
            // Render Google's official button
            google.accounts.id.renderButton(
                googleButtonWrapper,
                {
                    theme: 'filled_blue',
                    size: 'large',
                    width: buttonDiv.offsetWidth || 350,
                    text: 'signin_with',
                    locale: 'he',
                    logo_alignment: 'left'
                }
            );
            
            console.log("Google Sign-In button rendered");
        }

        async function handleGoogleResponse(response) {
            console.log("=== GOOGLE RESPONSE ===");
            console.log("Google credential:", response.credential);
            
            // Show loading immediately
            showLoading(true);
            const googleButtonWrapper = document.getElementById('google-button-wrapper');
            if (googleButtonWrapper) {
                googleButtonWrapper.style.display = 'none';
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithIdToken({
                    provider: 'google',
                    token: response.credential,
                });
                
                console.log("Google sign-in response:", { data, error });
                
                if (error) {
                    console.error("Supabase auth error:", error);
                    showError('שגיאה בהתחברות עם Google: ' + error.message);
                    showLoading(false);
                    if (googleButtonWrapper) {
                        googleButtonWrapper.style.display = 'block';
                    }
                } else if (data && data.user) {
                    currentUser = data.user;
                    saveCurrentUser(currentUser);
                    console.log("✅ Google login successful!");
                    console.log("User ID:", currentUser.id);
                    console.log("User email:", currentUser.email);
                    console.log("User metadata:", currentUser?.user_metadata);
                    
                    // שמור משתמש בשרת עם נתוני Google האמיתיים
                    try {
                        const userExtracted = extractUserData(currentUser);
                        const response = await fetch(`/api/user/${currentUser.id}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: currentUser.email || '',
                                name: userExtracted.name,
                                avatar: userExtracted.avatar
                            })
                        });
                        if (response.ok) {
                            console.log('✅ User data saved to server');
                        }
                    } catch (err) {
                        console.error('Error saving user to server:', err);
                    }
                    
                    showSuccess('התחברת בהצלחה! טוען את הדשבורד...');
                    setTimeout(() => {
                    showDashboard();
                    }, 800);
                } else {
                    console.error("No user data in Google response");
                    showError('שגיאה: לא התקבלו נתוני משתמש מ-Google');
                    showLoading(false);
                    if (googleButtonWrapper) {
                        googleButtonWrapper.style.display = 'block';
                    }
                }
            } catch (err) {
                console.error("Google sign-in exception:", err);
                showError('שגיאה בהתחברות: ' + (err.message || 'נסה שוב'));
                showLoading(false);
                if (googleButtonWrapper) {
                    googleButtonWrapper.style.display = 'block';
                }
            }
        }
        
        // פונקציה חכמה לחילוץ נתונים
        function extractUserData(user) {
            console.log("=== EXTRACTING USER DATA ===");
            console.log("Raw user object:", user);
            console.log("User metadata:", user.user_metadata);
            console.log("User email:", user.email);
            
            // חילוץ שם - נסה כמה אפשרויות
            let name = 'משתמש רשום';
            
            // בדוק user_metadata
            if (user.user_metadata) {
                if (user.user_metadata.name) name = user.user_metadata.name;
                else if (user.user_metadata.full_name) name = user.user_metadata.full_name;
                else if (user.user_metadata.display_name) name = user.user_metadata.display_name;
                else if (user.user_metadata.first_name || user.user_metadata.last_name) {
                    name = `${user.user_metadata.first_name || ''} ${user.user_metadata.last_name || ''}`.trim();
                }
            }
            
            // אם לא מצאנו שם, נסה מהאימייל
            if (name === 'משתמש רשום' && user.email) {
                const emailName = user.email.split('@')[0];
                name = emailName.charAt(0).toUpperCase() + emailName.slice(1);
            }
            
            // חילוץ תמונה - נסה כמה אפשרויות
            let avatar = null;
            if (user.user_metadata?.avatar_url) avatar = user.user_metadata.avatar_url;
            else if (user.user_metadata?.picture) avatar = user.user_metadata.picture;
            else if (user.user_metadata?.picture_url) avatar = user.user_metadata.picture_url;
            else avatar = 'https://placehold.co/80x80/E2E8F0/4A5568?text=' + encodeURIComponent(name.charAt(0));
            
            console.log("Extracted name:", name);
            console.log("Extracted avatar:", avatar);
            console.log("========================");
            
            return { name, avatar };
        }
        
        // --- Admin Functions ---
        function checkAdminStatus() {
            isAdmin = currentUser && currentUser.id === ADMIN_USER_ID;
            console.log('Checking admin status:', { 
                currentUser: currentUser?.email, 
                userId: currentUser?.id, 
                adminId: ADMIN_USER_ID, 
                isAdmin 
            });
            if (isAdmin) {
                adminPanelBtn.classList.remove('hidden');
                console.log('Admin panel button shown');
            } else {
                adminPanelBtn.classList.add('hidden');
                console.log('Admin panel button hidden');
            }
        }

        async function openAdminPanel() {
            adminPanel.classList.remove('hidden');
            // המתן שהפאנל ייטען לפני שמנסים לעדכן נתונים
            await new Promise(resolve => setTimeout(resolve, 50));
            // עדכן את הדשבורד העליון מיד
            updateAdminTime();
            // Clear previous interval to prevent memory leak
            if (adminTimeInterval) {
                clearInterval(adminTimeInterval);
            }
            adminTimeInterval = setInterval(updateAdminTime, 1000); // עדכן כל שנייה
            // טען את כל הנתונים (זה יקרא ל-updateDashboardCards פנימית)
            await loadAdminData();
        }

        function closeAdminPanelHandler() {
            adminPanel.classList.add('hidden');
            // Clear interval when closing to prevent memory leak
            if (adminTimeInterval) {
                clearInterval(adminTimeInterval);
                adminTimeInterval = null;
            }
        }

        function updateAdminTime() {
            if (adminCurrentTime) {
                const now = new Date();
                adminCurrentTime.textContent = now.toLocaleString('he-IL');
            }
        }

        async function loadAdminData() {
            console.log('Loading admin data...', { isAdmin, currentUser: currentUser?.email, userId: currentUser?.id });
            if (!isAdmin) {
                console.log('User is not admin, skipping admin data load');
                return;
            }
            
            try {
                // עדכן את הדשבורד העליון מיד
                await updateDashboardCards();
                
                // טען נתוני משתמשים
                console.log('Loading users data...');
                await loadUsersData();
                
                // טען נתוני כספים
                console.log('Loading finance data...');
                await loadFinanceData();
                
                // טען סטטיסטיקות
                console.log('Loading analytics data...');
                await loadAnalyticsData();
                
                // עדכן שוב את הדשבורד אחרי שהכל נטען
                await updateDashboardCards();
                
                // רענן את הדשבורד הראשי
                console.log('Loading projects...');
                await loadProjects();
                
                // עדכן שוב את הדשבורד אחרי שהכל נטען
                await updateDashboardCards();
                
                console.log('Admin data loaded successfully');
            } catch (error) {
                console.error('Error loading admin data:', error);
                // Show error to user
                if (adminPanel && !adminPanel.classList.contains('hidden')) {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
                    errorMsg.textContent = 'שגיאה בטעינת נתוני המנהל. נסה לרענן את הדף.';
                    const mainContent = adminPanel.querySelector('main');
                    if (mainContent) {
                        mainContent.insertBefore(errorMsg, mainContent.firstChild);
                        setTimeout(() => errorMsg.remove(), 5000);
                    }
                }
            }
        }

        async function loadUsersData() {
            try {
                // טען את כל המשתמשים מהשרת
                const response = await fetch('/api/users');
                const serverUsers = await response.json();
                
                console.log('Server users:', serverUsers);
                
                const usersTableBody = document.getElementById('users-table-body');
                usersTableBody.innerHTML = '';

                // טען את כל הדפים כדי לחשב מנויים אמיתיים
                const allPagesResponse = await fetch('/api/all-pages');
                const allPages = await allPagesResponse.json();
                
                console.log('All pages for subscription calculation:', allPages);

                // הצג את כל המשתמשים מהשרת (כולל המנהל אם הוא קיים)
                serverUsers.forEach(user => {
                    // חשב מנויים פעילים אמיתיים למשתמש
                    let activeSubscriptions = 0;
                    let totalRevenue = 0;
                    
                    // מצא את כל הדפים של המשתמש הזה
                    const userPages = allPages.filter(page => page.userId === user.id);
                    
                    userPages.forEach(page => {
                        // השתמש ב-isActive מהשרת (מ-metadata.json) במקום localStorage
                        const isActive = page.isActive === true;
                        
                        if (isActive) {
                                    activeSubscriptions++;
                                    totalRevenue += 39;
                        }
                    });
                    
                    // עדכן את הנתונים
                    user.activeSubscriptions = activeSubscriptions;
                    user.totalRevenue = totalRevenue;
                    user.subscription_status = activeSubscriptions > 0 ? 'active' : 'inactive';
                    user.totalPages = userPages.length;
                    
                    console.log(`User ${user.email}: ${activeSubscriptions} active subscriptions, status: ${user.subscription_status}`);
                    console.log(`User pages:`, userPages.map(p => ({ fileName: p.fileName, isActive: p.isActive })));
                    
                    // צור את השורה
                    const row = createUserRow(user);
                    usersTableBody.appendChild(row);
                });

                console.log('Loaded users:', serverUsers.length, 'from server');

            } catch (error) {
                console.error('Error loading users:', error);
                loadLocalUsersData();
            }
        }
        function loadLocalUsersData() {
            // טען נתונים מקומיים
            const usersTableBody = document.getElementById('users-table-body');
            usersTableBody.innerHTML = '';

            // קבל את כל המשתמשים מ-localStorage
            const localData = JSON.parse(localStorage.getItem('autopage_data') || '{}');
            const pages = localData.pages || [];
            
            // חשב סטטיסטיקות משתמש
            let totalPages = pages.length;
            let activeSubscriptions = 0;
            let totalRevenue = 0;
            
            // חשב מנויים פעילים אמיתיים
            activeSubscriptions = 0;
            totalRevenue = 0;
            
            pages.forEach(page => {
                // בדוק אם יש מנוי פעיל לדף הזה - נסה כמה מפתחות
                let pageSubscription = null;
                
                // 1. נסה עם שם הקובץ המלא
                pageSubscription = localStorage.getItem(`page_subscription_${page.fileName}`);
                
                // 2. נסה עם שם קובץ ללא סיומת
                if (!pageSubscription) {
                    const fileNameWithoutExt = page.fileName.replace('.html', '');
                    pageSubscription = localStorage.getItem(`page_subscription_${fileNameWithoutExt}`);
                }
                
                // 3. נסה עם ID של הדף
                if (!pageSubscription) {
                    pageSubscription = localStorage.getItem(`page_subscription_${page.id || page.fileName}`);
                }
                
                // 4. נסה עם כל המפתחות הקיימים
                if (!pageSubscription) {
                    const allKeys = Object.keys(localStorage).filter(key => key.includes('page_subscription'));
                    for (const key of allKeys) {
                        const keyValue = localStorage.getItem(key);
                        try {
                            const sub = JSON.parse(keyValue);
                            // בדוק אם זה המנוי של הדף הזה
                            if (sub.pageId === page.fileName || 
                                sub.pageId === page.id || 
                                key.includes(page.fileName) ||
                                key.includes(page.id)) {
                                pageSubscription = keyValue;
                                break;
                            }
                        } catch (e) {
                            // המשך לחפש
                        }
                    }
                }
                
                if (pageSubscription) {
                    try {
                        const subscription = JSON.parse(pageSubscription);
                        if (subscription.isActive) {
                            activeSubscriptions++;
                            totalRevenue += 39;
                        }
                    } catch (e) {
                        console.error('Error parsing subscription:', e);
                    }
                }
            });
            
            // הוסף את המשתמש הנוכחי עם נתונים אמיתיים
            if (currentUser) {
                const isCurrentAdmin = currentUser.id === ADMIN_USER_ID;
                const row = createUserRow({
                    id: currentUser.id,
                    email: currentUser.email,
                    full_name: currentUser.user_metadata?.full_name || (isCurrentAdmin ? 'מנהל' : 'משתמש'),
                    created_at: new Date().toISOString(),
                    subscription_status: activeSubscriptions > 0 ? 'active' : 'inactive',
                    totalPages: totalPages,
                    activeSubscriptions: activeSubscriptions,
                    totalRevenue: totalRevenue,
                    isAdmin: isCurrentAdmin
                });
                usersTableBody.appendChild(row);
            }

            console.log('User Data:', {
                totalPages,
                activeSubscriptions,
                totalRevenue,
                user: currentUser?.user_metadata?.full_name,
                isAdmin: isAdmin,
                userId: currentUser?.id,
                adminId: ADMIN_USER_ID
            });
        }

        function createUserRow(user) {
            const row = document.createElement('tr');
            row.setAttribute('data-user-id', user.id);
            const joinDate = new Date(user.created_at).toLocaleDateString('he-IL');
            // בדוק אם המשתמש מחובר - רק המשתמש הנוכחי מחובר (כי אנחנו בממשק המנהל)
            // "מחובר" פירושו שהמשתמש הזה הוא זה שפתוח בממשק המנהל כרגע
            const isConnected = user.id === currentUser?.id;
            // במקרה של ממשק מנהל, רק המשתמש הנוכחי (המנהל) מחובר
            // כל המשתמשים האחרים לא מחוברים כרגע
            const statusBadge = isConnected ? 
                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">מחובר</span>' :
                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">לא מחובר</span>';

            // בדוק אם זה המנהל
            const isCurrentAdmin = user.id === currentUser?.id || user.isAdmin;
            const adminBadge = isCurrentAdmin ? 
                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 mr-2">מנהל</span>' : '';

            // הוסף מידע נוסף על המשתמש
            const additionalInfo = user.totalPages ? 
                `<div class="text-xs text-gray-400 mt-1">
                    דפים: ${user.totalPages} | מנויים פעילים: ${user.activeSubscriptions || 0} | הכנסות: ₪${user.totalRevenue || 0}
                </div>` : '';

            // כפתורי פעולה - מנהל יכול לשלוט בכל המשתמשים
            const actionButtons = isCurrentAdmin ? 
                `<span class="text-gray-400 text-sm">מנהל המערכת</span>` :
                `<button onclick="toggleUserStatus('${user.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                    ${isConnected ? 'נתק' : 'התחבר'}
                </button>
                <button onclick="viewUserPages('${user.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                    דפים
                </button>
                <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">
                    מחק
                </button>`;

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <div class="h-10 w-10 rounded-full ${isCurrentAdmin ? 'bg-red-600' : 'bg-indigo-600'} flex items-center justify-center text-white font-bold">
                                ${user.full_name.charAt(0)}
                            </div>
                        </div>
                        <div class="mr-4">
                            <div class="text-sm font-medium text-gray-900 flex items-center">
                                ${user.full_name}
                                ${adminBadge}
                            </div>
                            <div class="text-sm text-gray-500">${user.id}</div>
                            ${additionalInfo}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.email}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${joinDate}</td>
                <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    ${actionButtons}
                </td>
            `;
            return row;
        }

        // פונקציה מרכזית לעדכון הדשבורד העליון - נקראת מכל המקומות
        async function updateDashboardCards() {
            console.log('🎯 updateDashboardCards() called - UPDATING ALL DASHBOARD CARDS');
            try {
                // קבל את כל הדפים
                const pagesResponse = await fetch('/api/all-pages');
                if (!pagesResponse.ok) {
                    throw new Error(`Failed to fetch pages: ${pagesResponse.status}`);
                }
                const allPages = await pagesResponse.json();
                
                // קבל את כל המשתמשים
                const usersResponse = await fetch('/api/users');
                if (!usersResponse.ok) {
                    throw new Error(`Failed to fetch users: ${usersResponse.status}`);
                }
                const allUsers = await usersResponse.json();
                
                // חשב נתונים
                const totalUsers = allUsers.length;
                const totalPages = allPages.length;
                let activePages = 0;
                let inactivePages = 0;
                
                allPages.forEach(page => {
                    // בדוק אם הדף פעיל - רק אם isActive מוגדר במפורש כ-true
                    const isActive = page.isActive === true;
                    if (isActive) {
                        activePages++;
                    } else {
                        // כל דף שלא פעיל במפורש נחשב לא פעיל
                        inactivePages++;
                    }
                });
                
                // לוג מפורט לבדיקה
                console.log('📊 Page Status Breakdown:', {
                    total: allPages.length,
                    active: activePages,
                    inactive: inactivePages,
                    pagesWithIsActive: allPages.filter(p => p.isActive !== undefined).length,
                    pagesWithIsActiveTrue: allPages.filter(p => p.isActive === true).length,
                    pagesWithIsActiveFalse: allPages.filter(p => p.isActive === false).length,
                    pagesWithIsActiveUndefined: allPages.filter(p => p.isActive === undefined).length,
                    samplePages: allPages.slice(0, 3).map(p => ({ 
                        fileName: p.fileName, 
                        isActive: p.isActive, 
                        type: typeof p.isActive 
                    }))
                });
                
                const monthlyRevenue = activePages * 39;
                
                console.log('📊 Dashboard Data:', {
                    totalUsers,
                    totalPages,
                    activePages,
                    inactivePages,
                    monthlyRevenue
                });
                
                // עדכן את כל האלמנטים
                const dashboardTotalUsers = document.getElementById('dashboard-total-users');
                const dashboardMonthlyRevenue = document.getElementById('dashboard-monthly-revenue');
                const dashboardActivePages = document.getElementById('dashboard-active-pages');
                const dashboardInactivePages = document.getElementById('dashboard-inactive-pages');
                
                if (dashboardTotalUsers) {
                    dashboardTotalUsers.textContent = totalUsers.toString();
                    console.log('✅ Updated dashboard-total-users:', totalUsers);
                } else {
                    console.error('❌ dashboard-total-users element NOT FOUND!');
                }
                
                if (dashboardMonthlyRevenue) {
                    dashboardMonthlyRevenue.textContent = `₪${monthlyRevenue}`;
                    console.log('✅ Updated dashboard-monthly-revenue:', monthlyRevenue);
                } else {
                    console.error('❌ dashboard-monthly-revenue element NOT FOUND!');
                }
                
                if (dashboardActivePages) {
                    dashboardActivePages.textContent = activePages.toString();
                    console.log('✅ Updated dashboard-active-pages:', activePages);
                } else {
                    console.error('❌ dashboard-active-pages element NOT FOUND!');
                }
                
                if (dashboardInactivePages) {
                    dashboardInactivePages.textContent = inactivePages.toString();
                    console.log('✅ Updated dashboard-inactive-pages:', inactivePages);
                } else {
                    console.error('❌ dashboard-inactive-pages element NOT FOUND!');
                    // נסה למצוא את האלמנט בדרכים אחרות
                    const altElement = document.querySelector('#dashboard-inactive-pages');
                    if (altElement) {
                        altElement.textContent = inactivePages.toString();
                        console.log('✅ Found dashboard-inactive-pages via querySelector');
                    }
                }
                
            } catch (error) {
                console.error('❌ Error in updateDashboardCards:', error);
            }
        }

        async function loadFinanceData() {
            console.log('🚀 loadFinanceData() called');
            // עדכן את הדשבורד העליון מיד
            await updateDashboardCards();
            
            // טען נתונים אמיתיים מהשרת
            try {
                console.log('📡 Fetching /api/all-pages...');
                // קבל את כל הדפים במערכת מהשרת
                const response = await fetch('/api/all-pages');
                if (!response.ok) {
                    console.error('❌ Failed to fetch /api/all-pages:', response.status, response.statusText);
                    throw new Error(`Failed to fetch: ${response.status}`);
                }
                const allPages = await response.json();
                console.log('✅ Received allPages:', allPages.length, 'pages');
                
                console.log('📊 All pages in system:', allPages.length);
                console.log('📊 Pages with isActive:', allPages.filter(p => p.isActive !== undefined).length);
                console.log('📊 Pages with isActive=true:', allPages.filter(p => p.isActive === true).length);
                console.log('📊 Pages with isActive=false:', allPages.filter(p => p.isActive === false).length);
                console.log('📊 Pages with isActive undefined:', allPages.filter(p => p.isActive === undefined).length);
                
                // לוג מפורט של כל הדפים עם isActive
                console.log('📋 All pages with isActive status:');
                allPages.forEach((p, index) => {
                    console.log(`  ${index + 1}. ${p.fileName} | userId: ${p.userId} | isActive: ${p.isActive} (type: ${typeof p.isActive})`);
                });
                
                // קבל את מספר המשתמשים הכולל במערכת
                console.log('📡 Fetching /api/users...');
                const usersResponse = await fetch('/api/users');
                if (!usersResponse.ok) {
                    console.error('❌ Failed to fetch /api/users:', usersResponse.status, usersResponse.statusText);
                    throw new Error(`Failed to fetch users: ${usersResponse.status}`);
                }
                const users = await usersResponse.json();
                const totalUsersInSystem = users.length;
                console.log('✅ Received users:', totalUsersInSystem, 'users');
                
                console.log('👥 Total users in system:', totalUsersInSystem);
                console.log('👥 Users:', users.map(u => ({ id: u.id, email: u.email, pages: u.totalPages })));
                
                // חשב מנויים פעילים ולא פעילים
                // בדוק localStorage של המשתמש הנוכחי (המנהל) למנויים פעילים
                const totalPages = allPages.length;
                
                let activeSubscriptions = 0;
                let inactivePages = 0;
                
                // בדוק כל דף - האם יש מנוי פעיל (מ-metadata.json בשרת)
                allPages.forEach(page => {
                    // השתמש ב-isActive מהשרת (מ-metadata.json) במקום localStorage
                    // בדוק גם אם isActive לא מוגדר (undefined) - נחשב כלא פעיל
                    const isActive = page.isActive === true;
                    
                    // לוג מפורט לכל הדפים
                    console.log(`📄 Page: ${page.fileName} | isActive: ${page.isActive} | type: ${typeof page.isActive} | will count as: ${isActive ? 'ACTIVE' : 'INACTIVE'}`);
                    
                    if (isActive) {
                        console.log(`✅ Active page: ${page.fileName} (userId: ${page.userId})`);
                            activeSubscriptions++;
                        } else {
                        inactivePages++;
                    }
                });
                const monthlyRevenue = activeSubscriptions * 39; // ₪39 לכל דף פעיל בלבד
                
                console.log('Finance Data:', {
                    totalPages,
                    totalUsersInSystem,
                    activeSubscriptions,
                    inactivePages,
                    monthlyRevenue,
                    pages: allPages.map(p => ({ name: p.title, fileName: p.fileName, userId: p.userId, isActive: p.isActive }))
                });
                
                // לוג נוסף לבדיקה
                console.log('Active pages details:', allPages.filter(p => p.isActive === true).map(p => ({ 
                    fileName: p.fileName, 
                    userId: p.userId, 
                    isActive: p.isActive 
                })));
                
                // עדכן את הדשבורד
                const monthlyRevenueEl = document.getElementById('monthly-revenue');
                const activeUsersEl = document.getElementById('active-users');
                const totalPagesEl = document.getElementById('total-pages');
                
                if (monthlyRevenueEl) monthlyRevenueEl.textContent = `₪${monthlyRevenue}`;
                if (activeUsersEl) activeUsersEl.textContent = totalUsersInSystem.toString();
                if (totalPagesEl) totalPagesEl.textContent = totalPages.toString();
                
                // עדכן את הדשבורד העליון - כבר נעשה ב-updateDashboardCards בתחילת הפונקציה
                
                // לוג סיכום
                console.log('📊 Dashboard Summary:', {
                    totalUsers: totalUsersInSystem,
                    activePages: activeSubscriptions,
                    inactivePages: inactivePages,
                    monthlyRevenue: monthlyRevenue,
                    totalPages: totalPages
                });
                
            } catch (error) {
                console.error('❌ Error loading finance data:', error);
                console.error('Error stack:', error.stack);
                // נתונים דמו במקרה של שגיאה
                const monthlyRevenueEl = document.getElementById('monthly-revenue');
                const activeUsersEl = document.getElementById('active-users');
                const totalPagesEl = document.getElementById('total-pages');
                
                if (monthlyRevenueEl) monthlyRevenueEl.textContent = '₪0';
                if (activeUsersEl) activeUsersEl.textContent = '1';
                if (totalPagesEl) totalPagesEl.textContent = '0';
                
                // עדכן גם את הדשבורד הראשי
                const dashboardTotalUsers = document.getElementById('dashboard-total-users');
                const dashboardMonthlyRevenue = document.getElementById('dashboard-monthly-revenue');
                const dashboardActivePages = document.getElementById('dashboard-active-pages');
                const dashboardInactivePages = document.getElementById('dashboard-inactive-pages');
                
                if (dashboardTotalUsers) dashboardTotalUsers.textContent = '0';
                if (dashboardMonthlyRevenue) dashboardMonthlyRevenue.textContent = '₪0';
                if (dashboardActivePages) dashboardActivePages.textContent = '0';
                if (dashboardInactivePages) dashboardInactivePages.textContent = '0';
            }

            // טען היסטוריית תשלומים
            const paymentsTableBody = document.getElementById('payments-table-body');
            paymentsTableBody.innerHTML = '';

            // צור תשלומים אמיתיים על בסיס הדפים עם מנויים פעילים
            const allPagesResponse = await fetch('/api/all-pages');
            const allPages = await allPagesResponse.json();
            
            const realPayments = [];
            
            allPages.forEach((page, index) => {
                // בדוק אם יש מנוי פעיל לדף הזה
                const pageSubscription = localStorage.getItem(`page_subscription_${page.fileName}`);
                if (pageSubscription) {
                    const subscription = JSON.parse(pageSubscription);
                    if (subscription.isActive) {
                        // רק דפים עם מנוי פעיל נחשבים כתשלום
                        realPayments.push({
                            user: currentUser?.user_metadata?.full_name || 'משתמש',
                            amount: '₪39',
                            date: new Date(subscription.purchaseDate || page.created_at || Date.now() - (index * 86400000)).toLocaleDateString('he-IL'),
                            status: 'completed',
                            pageName: page.title || 'דף נחיתה'
                        });
                    }
                }
            });
            
            console.log('Real Payments:', realPayments);
            
            // אם אין תשלומים, הוסף הודעה
            const demoPayments = realPayments.length > 0 ? realPayments : [{
                user: 'אין תשלומים',
                amount: '₪0',
                date: '-',
                status: 'none',
                pageName: 'אין דפים עם מנוי פעיל'
            }];

            demoPayments.forEach(payment => {
                const row = document.createElement('tr');
                let statusBadge;
                
                if (payment.status === 'completed') {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">הושלם</span>';
                } else if (payment.status === 'none') {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">אין נתונים</span>';
                } else {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">ממתין</span>';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.user}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.amount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${payment.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                `;
                paymentsTableBody.appendChild(row);
            });
        }
        async function loadAnalyticsData() {
            // טען נתונים אמיתיים לסטטיסטיקות
            try {
                const response = await fetch('/api/all-pages');
                const allPages = await response.json();
                
                // חשב דפים שנוצרו השבוע
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                const weeklyPages = allPages.filter(page => {
                    const pageDate = new Date(page.created_at || Date.now());
                    return pageDate >= weekAgo;
                }).length;
                
                // חשב מנויים פעילים השבוע - רק דפים שנוצרו השבוע ויש להם מנוי פעיל
                let weeklyActiveSubscriptions = 0;
                let weeklyRevenue = 0;
                
                allPages.forEach(page => {
                    const pageDate = new Date(page.created_at || Date.now());
                    const isWeekly = pageDate >= weekAgo;
                    
                    // השתמש ב-isActive מהשרת (מ-metadata.json)
                    const isActive = page.isActive === true;
                    
                    if (isWeekly && isActive) {
                            weeklyActiveSubscriptions++;
                            weeklyRevenue += 39;
                    }
                });
                
                console.log('Analytics Data:', {
                    weeklyPages,
                    weeklyActiveSubscriptions,
                    weeklyRevenue,
                    totalPages: allPages.length
                });
                
                // עדכן את הסטטיסטיקות
                const weeklyNewUsers = document.getElementById('weekly-new-users');
                const weeklyNewPages = document.getElementById('weekly-new-pages');
                const weeklyRevenueEl = document.getElementById('weekly-revenue');
                const conversionRate = document.getElementById('conversion-rate');
                
                // משתמשים מחוברים - כרגע רק המנהל מחובר
                const totalUsers = 1; // רק המנהל מחובר כרגע
                
                if (weeklyNewUsers) weeklyNewUsers.textContent = "1"; // משתמש חדש השבוע (המנהל)
                if (weeklyNewPages) weeklyNewPages.textContent = weeklyPages.toString();
                if (weeklyRevenueEl) weeklyRevenueEl.textContent = `₪${weeklyRevenue}`;
                
                // חשב שיעור המרה - דפים פעילים מתוך סה"כ דפים
                // ספור דפים פעילים לפי isActive מהשרת (מ-metadata.json)
                const totalActiveSubscriptions = allPages.filter(page => page.isActive === true).length;
                const conversionRateValue = allPages.length > 0 ? Math.round((totalActiveSubscriptions / allPages.length) * 100) : 0;
                if (conversionRate) conversionRate.textContent = `${conversionRateValue}%`;
                
                // טען פעילות אמיתית
                await loadRecentActivity(allPages);
                
                // עדכן גרפים
                await updateAnalyticsCharts(allPages, totalUsers);
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
            }
        }

        // משתנה גלובלי לתקופת הפעילות הנוכחית
        let currentActivityPeriod = 'weekly';

        async function updateAnalyticsCharts(allPages, totalUsers) {
            try {
                // חשב נתונים לגרפים - בדוק localStorage למנויים פעילים
                const totalPages = allPages.length;
                let activePages = 0;
                let inactivePages = 0;
                let weeklyActivePages = 0;
                
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                
                // בדוק כל דף - האם יש מנוי פעיל (מ-metadata.json בשרת)
                allPages.forEach(page => {
                    // השתמש ב-isActive מהשרת (מ-metadata.json) במקום localStorage
                    const isActive = page.isActive === true;
                    const pageDate = new Date(page.created_at || Date.now());
                    const isWeekly = pageDate >= weekAgo;
                    
                    if (isActive) {
                            activePages++;
                            // בדוק אם זה השבוע
                        if (isWeekly) {
                                weeklyActivePages++;
                        }
                    } else {
                        inactivePages++;
                    }
                });
                
                const percentage = totalPages > 0 ? Math.round((activePages / totalPages) * 100) : 0;
                const monthlyRevenue = activePages * 39;
                const potentialRevenue = totalPages * 39;
                
                // עדכן גרף סטטוס דפים
                const pagesProgress = document.getElementById('pages-progress');
                const pagesPercentage = document.getElementById('pages-percentage');
                const activePagesCount = document.getElementById('active-pages-count');
                const inactivePagesCount = document.getElementById('inactive-pages-count');
                
                if (pagesProgress) {
                    const circumference = 251.2; // 2 * π * 40
                    const offset = circumference - (percentage / 100) * circumference;
                    pagesProgress.style.strokeDashoffset = offset;
                }
                
                if (pagesPercentage) pagesPercentage.textContent = `${percentage}%`;
                if (activePagesCount) activePagesCount.textContent = activePages.toString();
                if (inactivePagesCount) inactivePagesCount.textContent = inactivePages.toString();
                
                // עדכן גרף הכנסות
                const monthlyRevenueDisplay = document.getElementById('monthly-revenue-display');
                const revenueActivePages = document.getElementById('revenue-active-pages');
                const revenueInactivePages = document.getElementById('revenue-inactive-pages');
                const revenuePotential = document.getElementById('revenue-potential');
                
                if (monthlyRevenueDisplay) monthlyRevenueDisplay.textContent = `₪${monthlyRevenue}`;
                if (revenueActivePages) revenueActivePages.textContent = activePages.toString();
                if (revenueInactivePages) revenueInactivePages.textContent = inactivePages.toString();
                if (revenuePotential) revenuePotential.textContent = `₪${potentialRevenue}`;
                
                // שמור את הנתונים לשימוש בפונקציות אחרות
                window.allPagesData = allPages;
                
                // עדכן פעילות לפי התקופה שנבחרה
                updateActivityChart(allPages);
                
                const weeklyRevenue = weeklyActivePages * 39;
                
                const weeklyPagesCreatedEl = document.getElementById('weekly-pages-created');
                const weeklyPagesActivatedEl = document.getElementById('weekly-pages-activated');
                const weeklyRevenueDisplay = document.getElementById('weekly-revenue-display');
                
                if (weeklyPagesCreatedEl) weeklyPagesCreatedEl.textContent = weeklyPagesCreated.toString();
                if (weeklyPagesActivatedEl) weeklyPagesActivatedEl.textContent = weeklyActivePages.toString();
                if (weeklyRevenueDisplay) weeklyRevenueDisplay.textContent = `₪${weeklyRevenue}`;
                
                // עדכן סטטיסטיקות משתמשים
                // קבל את מספר המשתמשים הכולל במערכת
                const usersResponse = await fetch('/api/users');
                const allUsers = await usersResponse.json();
                const totalUsersInSystem = allUsers.length;
                
                console.log('📊 updateAnalyticsCharts - totalUsersInSystem:', totalUsersInSystem);
                console.log('📊 updateAnalyticsCharts - activePages:', activePages);
                console.log('📊 updateAnalyticsCharts - monthlyRevenue:', monthlyRevenue);
                
                // עדכן את הדשבורד העליון
                await updateDashboardCards();
                
                const activeUsers = 1; // רק המנהל מחובר כרגע
                const inactiveUsers = Math.max(0, totalUsersInSystem - activeUsers); // משתמשים לא מחוברים
                const conversionRate = totalPages > 0 ? Math.round((activePages / totalPages) * 100) : 0;
                
                const totalUsersCount = document.getElementById('total-users-count');
                const activeUsersCount = document.getElementById('active-users-count');
                const inactiveUsersCount = document.getElementById('inactive-users-count');
                const conversionRateDisplay = document.getElementById('conversion-rate-display');
                
                if (totalUsersCount) totalUsersCount.textContent = totalUsersInSystem.toString();
                if (activeUsersCount) activeUsersCount.textContent = activeUsers.toString();
                if (inactiveUsersCount) inactiveUsersCount.textContent = inactiveUsers.toString();
                if (conversionRateDisplay) conversionRateDisplay.textContent = `${conversionRate}%`;
                
            } catch (error) {
                console.error('Error updating analytics charts:', error);
            }
        }
        function changeActivityPeriod(period) {
            currentActivityPeriod = period;
            
            // עדכן את עיצוב הכפתורים
            document.getElementById('daily-btn').className = 'px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md transition-colors';
            document.getElementById('weekly-btn').className = 'px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md transition-colors';
            document.getElementById('monthly-btn').className = 'px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md transition-colors';
            
            if (period === 'daily') {
                document.getElementById('daily-btn').className = 'px-3 py-1 text-sm font-medium bg-white text-gray-900 shadow-sm rounded-md transition-colors';
            } else if (period === 'weekly') {
                document.getElementById('weekly-btn').className = 'px-3 py-1 text-sm font-medium bg-white text-gray-900 shadow-sm rounded-md transition-colors';
            } else if (period === 'monthly') {
                document.getElementById('monthly-btn').className = 'px-3 py-1 text-sm font-medium bg-white text-gray-900 shadow-sm rounded-md transition-colors';
            }
            
            // עדכן את הגרף
            updateActivityChart(window.allPagesData || []);
        }
        function updateActivityChart(allPages) {
            const now = new Date();
            let periodAgo, periodLabel, createdLabel, activatedLabel;
            
            if (currentActivityPeriod === 'daily') {
                periodAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                periodLabel = 'היום';
                createdLabel = 'דפים שנוצרו היום';
                activatedLabel = 'דפים שהופעלו היום';
            } else if (currentActivityPeriod === 'weekly') {
                periodAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                periodLabel = 'השבוע';
                createdLabel = 'דפים שנוצרו השבוע';
                activatedLabel = 'דפים שהופעלו השבוע';
            } else {
                periodAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                periodLabel = 'החודש';
                createdLabel = 'דפים שנוצרו החודש';
                activatedLabel = 'דפים שהופעלו החודש';
            }
            
            const pagesCreated = allPages.filter(page => {
                const pageDate = new Date(page.created_at || Date.now());
                return pageDate >= periodAgo;
            }).length;
            
            const pagesActivated = allPages.filter(page => {
                const pageDate = new Date(page.created_at || Date.now());
                const pageSubscription = localStorage.getItem(`page_subscription_${page.fileName}`);
                return pageDate >= periodAgo && pageSubscription;
            }).length;
            
            // עדכן את התוכן בגרף
            const chartContainer = document.getElementById('weekly-activity-chart');
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-blue-500 rounded-full ml-2"></div>
                                <span class="text-sm text-gray-600">${createdLabel}</span>
                            </div>
                            <span class="text-lg font-semibold text-blue-600" id="period-pages-created">${pagesCreated}</span>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full ml-2"></div>
                                <span class="text-sm text-gray-600">${activatedLabel}</span>
                            </div>
                            <span class="text-lg font-semibold text-green-600" id="period-pages-activated">${pagesActivated}</span>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-purple-500 rounded-full ml-2"></div>
                                <span class="text-sm text-gray-600">הכנסות ${periodLabel}</span>
                            </div>
                            <span class="text-lg font-semibold text-purple-600">₪${pagesActivated * 39}</span>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-orange-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-orange-500 rounded-full ml-2"></div>
                                <span class="text-sm text-gray-600">שיעור המרה ${periodLabel}</span>
                            </div>
                            <span class="text-lg font-semibold text-orange-600">${pagesCreated > 0 ? Math.round((pagesActivated / pagesCreated) * 100) : 0}%</span>
                        </div>
                    </div>
                `;
            }
        }

        async function loadRecentActivity(allPages) {
            try {
                const recentActivityContainer = document.getElementById('recent-activity');
                recentActivityContainer.innerHTML = '';
                
                // צור רשימת פעילויות כולל יצירת דפים ופרסום
                const activities = [];
                
                // הוסף פעילות יצירת דפים
                allPages.forEach(page => {
                    activities.push({
                        type: 'created',
                        page: page,
                        date: new Date(page.created_at),
                        timestamp: new Date(page.created_at).getTime()
                    });
                });
                
                // הוסף פעילות פרסום דפים (מנויים)
                const subscriptionKeys = Object.keys(localStorage).filter(key => key.includes('page_subscription'));
                subscriptionKeys.forEach(key => {
                    try {
                        const subscription = JSON.parse(localStorage.getItem(key));
                        if (subscription && subscription.isActive) {
                            // מצא את הדף המתאים
                            const page = allPages.find(p => 
                                p.fileName === subscription.pageId || 
                                p.id === subscription.pageId ||
                                key.includes(p.fileName) ||
                                key.includes(p.id)
                            );
                            
                            if (page) {
                                activities.push({
                                    type: 'published',
                                    page: page,
                                    subscription: subscription,
                                    date: new Date(subscription.startDate || subscription.endDate),
                                    timestamp: new Date(subscription.startDate || subscription.endDate).getTime()
                                });
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing subscription:', e);
                    }
                });
                
                // מיון כל הפעילויות לפי תאריך (החדשים ביותר ראשון)
                activities.sort((a, b) => b.timestamp - a.timestamp);
                
                // הצג את 10 הפעילויות האחרונות
                const recentActivities = activities.slice(0, 10);
                
                if (recentActivities.length === 0) {
                    recentActivityContainer.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            <p>אין פעילות אחרונה</p>
                        </div>
                    `;
                    return;
                }
                
                recentActivities.forEach((activity, index) => {
                    const timeAgo = getTimeAgo(activity.date);
                    const activityItem = document.createElement('div');
                    activityItem.className = 'flex items-center';
                    
                    // בחר אייקון וטקסט לפי סוג הפעילות
                    let iconBg, iconColor, activityText;
                    if (activity.type === 'published') {
                        iconBg = 'bg-green-100';
                        iconColor = 'text-green-600';
                        activityText = 'דף פורסם';
                    } else {
                        iconBg = 'bg-blue-100';
                        iconColor = 'text-blue-600';
                        activityText = 'דף חדש נוצר';
                    }
                    
                    activityItem.innerHTML = `
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 ${iconBg} rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    ${activity.type === 'published' ? 
                                        `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>` :
                                        `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>`
                                    }
                                </svg>
                            </div>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-900">${activityText}</p>
                            <p class="text-sm text-gray-500">${activity.page.title || 'דף נחיתה'}</p>
                        </div>
                        <div class="mr-auto text-sm text-gray-500">${timeAgo}</div>
                    `;
                    
                    recentActivityContainer.appendChild(activityItem);
                });
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'לפני רגע';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `לפני ${minutes} דקות`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `לפני ${hours} שעות`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `לפני ${days} ימים`;
            }
        }

        function toggleUserStatus(userId) {
            console.log('Toggling user status for:', userId);
            showSuccess('סטטוס המשתמש עודכן בהצלחה');
            loadUsersData(); // רענן את הרשימה
        }

        function deleteUser(userId) {
            if (confirm('האם אתה בטוח שברצונך למחוק את המשתמש?')) {
                console.log('Deleting user:', userId);
                showSuccess('המשתמש נמחק בהצלחה');
                loadUsersData(); // רענן את הרשימה
            }
        }

        async function viewUserPages(userId) {
            try {
                // קבל את כל הדפים של המשתמש
                const response = await fetch(`/api/pages/${userId}`);
                const data = await response.json();
                // תמוך בשני פורמטים: {pages: []} או []
                const userPages = Array.isArray(data) ? data : (data.pages || []);
                
                console.log('User pages:', userPages);
                
                // פתח מודל עם רשימת הדפים
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-900">דפים של המשתמש</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${userPages.map((page, index) => {
                                    const fileName = page.fileName || page.name || '';
                                    const pageTitle = page.title || page.name || 'דף נחיתה';
                                    const isActive = page.isActive === true ? 
                                        '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-2">פעיל</span>' :
                                        '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mr-2">לא פעיל</span>';
                                    return `
                                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-indigo-400 transition">
                                        <h4 class="font-medium text-gray-900 mb-2 flex items-center flex-wrap gap-2">
                                            ${pageTitle}
                                            ${isActive}
                                        </h4>
                                        <p class="text-sm text-gray-600 mb-2">${fileName}</p>
                                        <p class="text-xs text-gray-500 mb-3">סוג: ${page.pageType || 'other'}</p>
                                        <div class="flex gap-2 flex-wrap">
                                            <button onclick="viewUserPage('${fileName}', '${userId}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-sm font-medium transition">
                                                👁️ צפה
                                            </button>
                                            <button onclick="editUserPage('${fileName}', '${userId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-medium transition">
                                                ✏️ ערוך
                                            </button>
                                            ${page.isActive === true ? 
                                                `<button onclick="deactivateUserPage('${fileName}', '${userId}')" class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1.5 rounded text-sm font-medium transition">
                                                    ⏸️ בטל הפעלה
                                                </button>` :
                                                `<button onclick="activateUserPage('${fileName}', '${userId}')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded text-sm font-medium transition">
                                                    ▶️ הפעל
                                                </button>`
                                            }
                                            <button onclick="deleteUserPage('${fileName}', '${userId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm font-medium transition">
                                                🗑️ מחק
                                            </button>
                                        </div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                            ${userPages.length === 0 ? '<p class="text-gray-500 text-center">אין דפים למשתמש הזה</p>' : ''}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error loading user pages:', error);
                alert('שגיאה בטעינת דפי המשתמש');
            }
        }

        function editUserPage(fileName, userId = null) {
            // פתח את עורך הדפים עם הדף של המשתמש
            const targetUserId = userId || currentUser.id;
            const cleanFileName = fileName.replace('_html', '').replace('.html', '');
            window.open(`/page-creator/page-creator.html?edit=${cleanFileName}&userId=${targetUserId}`, '_blank');
        }

        function viewUserPage(fileName, userId) {
            // צפה בדף של המשתמש (כמנהל)
            const cleanFileName = fileName.replace('_html', '').replace('.html', '');
            const pageUrl = `/pages/${userId}/${cleanFileName}_html`;
            console.log('👁️ Admin viewing user page:', pageUrl);
            window.open(pageUrl, '_blank');
        }

        async function activateUserPage(fileName, userId) {
            // הפעל דף של משתמש (כמנהל)
            const cleanFileName = fileName.replace('_html', '').replace('.html', '');
            try {
                const response = await fetch('/api/subscription/activate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        pageId: cleanFileName
                    })
                });
                
                if (response.ok) {
                    alert('הדף הופעל בהצלחה!');
                    viewUserPages(userId); // רענן את הרשימה
                    updateDashboardCards(); // עדכן את הדשבורד
                } else {
                    const error = await response.json();
                    alert('שגיאה בהפעלת הדף: ' + (error.error || 'שגיאה לא ידועה'));
                }
            } catch (error) {
                console.error('Error activating page:', error);
                alert('שגיאה בהפעלת הדף');
            }
        }

        async function deactivateUserPage(fileName, userId) {
            // בטל הפעלה של דף של משתמש (כמנהל)
            const cleanFileName = fileName.replace('_html', '').replace('.html', '');
            if (!confirm('האם אתה בטוח שברצונך לבטל את הפעלת הדף?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/subscription/deactivate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        pageId: cleanFileName
                    })
                });
                
                if (response.ok) {
                    alert('הפעלת הדף בוטלה בהצלחה!');
                    viewUserPages(userId); // רענן את הרשימה
                    updateDashboardCards(); // עדכן את הדשבורד
                } else {
                    const error = await response.json();
                    alert('שגיאה בביטול הפעלה: ' + (error.error || 'שגיאה לא ידועה'));
                }
            } catch (error) {
                console.error('Error deactivating page:', error);
                alert('שגיאה בביטול הפעלה');
            }
        }

        async function deleteUserPage(fileName, userId) {
            if (confirm('האם אתה בטוח שברצונך למחוק את הדף?')) {
                try {
                    const response = await fetch(`/api/delete-page`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ fileName, userId })
                    });
                    
                    if (response.ok) {
                        alert('הדף נמחק בהצלחה');
                        viewUserPages(userId); // רענן את הרשימה
                    } else {
                        alert('שגיאה במחיקת הדף');
                    }
                } catch (error) {
                    console.error('Error deleting page:', error);
                    alert('שגיאה במחיקת הדף');
                }
            }
        }

        
        // --- פונקציות סיכום חשבון ---
        async function updateAccountSummary() {
            console.log('=== updateAccountSummary called ===');
            
            if (!currentUser || !currentUser.id) {
                console.log('No current user, skipping account summary update');
                return;
            }
            
            try {
                // קבל את הדפים מהשרת (כמו ב-loadProjects)
                console.log('Fetching pages from server...');
                const response = await fetch(`/api/pages/${currentUser.id}`);
                const serverData = await response.json();
                const serverPages = serverData.pages || [];
                console.log('Server pages:', serverPages);
                
                // קבל גם דפים מקומיים
                const localData = JSON.parse(localStorage.getItem('autopage_data') || '{}');
                const localPages = localData.pages || [];
                console.log('Local pages:', localPages);
                
                // שלב את הדפים מהשרת והדפים המקומיים
                const allPages = [...serverPages, ...localPages];
                console.log('All pages combined:', allPages);
                
                // חשב מנויים פעילים
                let activeSubscriptions = 0;
                let totalRevenue = 0;
                
                console.log('Checking subscriptions for pages...');
                allPages.forEach((page, index) => {
                    // השתמש באותו מפתח כמו ב-loadProjects - project.id
                    const pageKey = page.id || `local_${page.fileName}`;
                    const pageSubscription = localStorage.getItem(`page_subscription_${pageKey}`);
                    console.log(`Page ${index + 1}: ${pageKey}, subscription:`, pageSubscription);
                    
                    if (pageSubscription) {
                        const subscription = JSON.parse(pageSubscription);
                        console.log(`Subscription data:`, subscription);
                        if (subscription.isActive) {
                            activeSubscriptions++;
                            totalRevenue += 39;
                            console.log(`Active subscription found for: ${pageKey}`);
                        }
                    }
                });
                
                console.log(`Total active subscriptions: ${activeSubscriptions}`);
                
                // עדכן את הסיכום
                document.getElementById('account-total-pages').textContent = allPages.length;
                document.getElementById('account-active-pages').textContent = activeSubscriptions;
                
                // עדכן את התצוגות המקדימות הקטנות
                document.getElementById('total-pages-icon').textContent = allPages.length;
                document.getElementById('active-pages-icon').textContent = activeSubscriptions;
                
                // חשב חיוב חודשי (₪39 לכל דף פעיל בלבד)
                const monthlyCharge = activeSubscriptions * 39;
                document.getElementById('account-monthly-charge').textContent = `₪${monthlyCharge}`;
                document.getElementById('monthly-charge-amount').textContent = monthlyCharge;
                
                // עדכן זמן עדכון אחרון
                const lastUpdateTime = new Date().toLocaleString('he-IL');
                
                // עדכן את המודל רק אם המשתמש ביקש זאת במפורש
                // הוסר רענון אוטומטי שגרם לבעיות
                
                console.log('Account Summary Updated:', {
                    totalPages: allPages.length,
                    activePages: activeSubscriptions,
                    activeSubscriptions,
                    monthlyCharge,
                    serverPages: serverPages.length,
                    localPages: localPages.length
                });
                
            } catch (error) {
                console.error('Error updating account summary:', error);
            }
        }
        function updatePagesBreakdown(pages) {
            const pagesBreakdown = document.getElementById('pages-breakdown');
            if (!pagesBreakdown) return;
            
            pagesBreakdown.innerHTML = '';
            
            if (pages.length === 0) {
                pagesBreakdown.innerHTML = '<div class="text-sm text-gray-500 text-center py-2">אין דפים שפורסמו</div>';
                return;
            }
            
            // מיון הדפים לפי תאריך (החדש ביותר ראשון)
            const sortedPages = pages.sort((a, b) => {
                const dateA = new Date(a.created_at || a.fileName.split('_').pop() || Date.now());
                const dateB = new Date(b.created_at || b.fileName.split('_').pop() || Date.now());
                return dateB - dateA;
            });
            
            sortedPages.forEach((page, index) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'flex items-center justify-between p-2 bg-white rounded border border-gray-200';
                
                // חלץ תאריך מהשם או השתמש בתאריך נוכחי
                let publishDate;
                try {
                    // נסה לחלץ תאריך מהשם
                    const timestampMatch = page.fileName.match(/(\d{13})/);
                    if (timestampMatch) {
                        publishDate = new Date(parseInt(timestampMatch[1]));
                    } else {
                        publishDate = new Date(page.created_at || Date.now());
                    }
                } catch (error) {
                    publishDate = new Date();
                }
                
                const formattedDate = publishDate.toLocaleDateString('he-IL', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // נקה את שם הדף
                let cleanPageName = page.title || page.fileName || 'דף נחיתה';
                
                // Remove timestamp patterns (13-digit numbers)
                cleanPageName = cleanPageName.replace(/\d{13}/g, '');
                
                // Remove other number patterns at the end
                cleanPageName = cleanPageName.replace(/_\d+$/g, '');
                cleanPageName = cleanPageName.replace(/\d+$/g, '');
                
                // Clean up underscores and extra spaces
                cleanPageName = cleanPageName.replace(/_+/g, ' ').trim();
                cleanPageName = cleanPageName.replace(/\s+/g, ' ');
                
                // If title is empty after cleaning, use a default
                if (!cleanPageName || cleanPageName.length < 2) {
                    cleanPageName = 'דף נחיתה';
                }
                
                pageDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                            <span class="text-xs font-semibold text-indigo-600">${index + 1}</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-800">${cleanPageName}</div>
                            <div class="text-xs text-gray-500">פורסם: ${formattedDate}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-semibold text-green-600">₪39</div>
                        <div class="text-xs text-gray-500">דף שפורסם</div>
                    </div>
                `;
                
                pagesBreakdown.appendChild(pageDiv);
            });
        }
        function createTestSubscriptions() {
            console.log('Creating test subscriptions...');
            
            // קבל את הדפים מהשרת
            fetch(`/api/pages/${currentUser.id}`)
                .then(response => response.json())
                .then(serverData => {
                    const serverPages = serverData.pages || [];
                    
                    // צור מנויים לדפים הראשונים (עד 3)
                    serverPages.slice(0, 3).forEach((page, index) => {
                        const pageKey = `local_${page.fileName}`; // אותו מפתח כמו ב-loadProjects
                        const subscriptionData = {
                            isActive: true,
                            createdAt: new Date().toISOString(),
                            userId: currentUser.id,
                            pageId: pageKey
                        };
                        
                        localStorage.setItem(`page_subscription_${pageKey}`, JSON.stringify(subscriptionData));
                        console.log(`Created subscription for: ${pageKey}`);
                        
                        // שמור גם בשרת ב-metadata.json
                        const pageIdForServer = page.fileName.replace('_html', '');
                        fetch('/api/subscription/activate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: currentUser.id,
                                pageId: pageIdForServer
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log(`✅ Subscription saved to server for: ${pageKey}`);
                        })
                        .catch(error => {
                            console.error('Error saving subscription to server:', error);
                        });
                    });
                    
                    // עדכן את המודל רק אם המשתמש ביקש זאת במפורש
                    // הוסר רענון אוטומטי שגרם לבעיות
                    
                    showSuccess('נוצרו 3 מנויים לדפים הראשונים');
                })
                .catch(error => {
                    console.error('Error creating test subscriptions:', error);
                    showError('שגיאה ביצירת מנויים');
                });
        }
        // פונקציה לסנכרן מנויים מ-localStorage לשרת
        async function syncSubscriptionsToServer() {
            console.log('🔄 Syncing subscriptions from localStorage to server...');
            try {
                // קבל את כל המפתחות של מנויים
                const subscriptionKeys = Object.keys(localStorage).filter(key => key.startsWith('page_subscription_'));
                console.log(`Found ${subscriptionKeys.length} subscriptions in localStorage`);
                
                let syncedCount = 0;
                let errorCount = 0;
                
                for (const key of subscriptionKeys) {
                    try {
                        const subscriptionData = JSON.parse(localStorage.getItem(key));
                        if (subscriptionData && subscriptionData.isActive === true) {
                            // נסה לחלץ userId ו-pageId
                            let userId = subscriptionData.userId;
                            let pageId = subscriptionData.pageId;
                            
                            // אם pageId מתחיל ב-local_, הסר את זה
                            if (pageId && pageId.startsWith('local_')) {
                                pageId = pageId.replace('local_', '');
                            }
                            
                            // אם אין userId, נסה לקחת מהמפתח או מהמשתמש הנוכחי
                            if (!userId && currentUser) {
                                userId = currentUser.id;
                            }
                            
                            if (userId && pageId) {
                                // נסה להפעיל את הדף בשרת
                                const response = await fetch('/api/subscription/activate', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        userId: userId,
                                        pageId: pageId
                                    })
                                });
                                
                                if (response.ok) {
                                    syncedCount++;
                                    console.log(`✅ Synced subscription: ${pageId} for user ${userId}`);
                                } else {
                                    errorCount++;
                                    const error = await response.json();
                                    console.warn(`⚠️ Failed to sync ${pageId}:`, error);
                                }
                            } else {
                                console.warn(`⚠️ Missing userId or pageId for subscription:`, subscriptionData);
                            }
                        }
                    } catch (error) {
                        errorCount++;
                        console.error(`Error syncing subscription ${key}:`, error);
                    }
                }
                
                console.log(`✅ Sync complete: ${syncedCount} synced, ${errorCount} errors`);
                if (syncedCount > 0) {
                    // עדכן את הדשבורד אחרי הסנכרון
                    setTimeout(() => {
                        updateDashboardCards();
                    }, 500);
                }
            } catch (error) {
                console.error('Error syncing subscriptions:', error);
            }
        }
        
        // --- לוגיקת דשבורד (מתוקנת) ---
        async function showDashboard() {
            console.log("=== SHOW DASHBOARD ===");
            console.log("currentUser:", currentUser);
            
            if (!currentUser) {
                console.error("currentUser לא מוגדר ב-showDashboard!");
                return;
            }
            
            // Prevent multiple simultaneous loads
            if (isDashboardLoading) {
                console.log("Dashboard already loading, skipping...");
                return;
            }
            isDashboardLoading = true;
            
            loginView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            document.body.classList.add('bg-gray-50');
            
            // המתן שה-DOM יטען לחלוטין לפני כל דבר
            setTimeout(() => {
            // בדוק סטטוס מנהל
                console.log('🔍 showDashboard - calling checkAdminStatus()...');
            checkAdminStatus();
                console.log('🔍 showDashboard - after checkAdminStatus, isAdmin:', isAdmin);
            
            // עדכן את המודל רק אם המשתמש ביקש זאת במפורש
            // הוסר רענון אוטומטי שגרם לבעיות
            
            // טען נתוני מנוי
            loadSubscriptionData();
                
                // אם המשתמש הוא מנהל, טען נתוני דשבורד מנהל גם בדף הראשי
                // בדוק שוב אחרי checkAdminStatus כדי לוודא ש-isAdmin מעודכן
                const ADMIN_USER_ID = 'fae06b49-1239-4ba5-93db-244ce2851fb4';
                const userIsAdmin = currentUser && currentUser.id === ADMIN_USER_ID;
                console.log('🔍 Checking admin status in showDashboard:', {
                    userId: currentUser?.id,
                    adminId: ADMIN_USER_ID,
                    isAdmin: userIsAdmin,
                    currentIsAdmin: isAdmin,
                    hasCurrentUser: !!currentUser
                });
                
                // תמיד טען את הנתונים אם המשתמש הוא מנהל
                if (userIsAdmin) {
                    console.log('🔧 Admin user detected, updating dashboard...');
                    
                    // בדוק שהאלמנטים קיימים
                    const dashboardTotalUsers = document.getElementById('dashboard-total-users');
                    const dashboardMonthlyRevenue = document.getElementById('dashboard-monthly-revenue');
                    const dashboardActivePages = document.getElementById('dashboard-active-pages');
                    const dashboardInactivePages = document.getElementById('dashboard-inactive-pages');
                    
                    console.log('🔍 Checking if dashboard elements exist:', {
                        dashboardTotalUsers: !!dashboardTotalUsers,
                        dashboardMonthlyRevenue: !!dashboardMonthlyRevenue,
                        dashboardActivePages: !!dashboardActivePages,
                        dashboardInactivePages: !!dashboardInactivePages
                    });
                    
                    // סנכרן מנויים מ-localStorage לשרת לפני טעינת הנתונים
                    syncSubscriptionsToServer().then(() => {
                        // אם האלמנטים לא קיימים, המתן עוד קצת
                        if (!dashboardTotalUsers || !dashboardMonthlyRevenue || !dashboardActivePages || !dashboardInactivePages) {
                            console.warn('⚠️ Dashboard elements not found yet, waiting...');
                            setTimeout(async () => {
                                await updateDashboardCards();
                                await loadFinanceData();
                                await loadAnalyticsData();
                                await updateDashboardCards();
                                console.log('✅ Dashboard updated after waiting');
                            }, 500);
                        } else {
                            // האלמנטים קיימים - עדכן מיד
                            updateDashboardCards().then(() => {
                                setTimeout(async () => {
                                    await loadFinanceData();
                                    await loadAnalyticsData();
                                    await updateDashboardCards();
                                    console.log('✅ Dashboard fully updated');
                                }, 300);
                            });
                        }
                    });
                } else {
                    console.log('👤 User is not admin, skipping finance data load');
                    console.log('👤 Current user ID:', currentUser?.id);
                    console.log('👤 Admin user ID:', ADMIN_USER_ID);
                    console.log('👤 userIsAdmin:', userIsAdmin);
                    console.log('👤 isAdmin variable:', isAdmin);
                }
            }, 100); // המתן 100ms שה-DOM יטען

            if (!currentUser || !currentUser.id) {
                console.error("Invalid user object:", currentUser);
                showError("שגיאה בזיהוי המשתמש. נסה להתחבר מחדש.");
                return;
            }

            // חלץ נתונים
            const userData = extractUserData(currentUser);
            
            // הצג בממשק מיידית (לפני בדיקת הפרופיל)
            const nameElement = document.getElementById('user-name');
            const avatarElement = document.getElementById('user-avatar');
            
            if (nameElement && avatarElement) {
                nameElement.textContent = userData.name;
                avatarElement.src = userData.avatar;
                avatarElement.onerror = function() {
                    this.src = 'https://placehold.co/80x80/E2E8F0/4A5568?text=' + encodeURIComponent(userData.name.charAt(0));
                };
                console.log("✅ UI Updated immediately with:", userData);
            } else {
                console.error("UI elements not found:", { nameElement, avatarElement });
            }

            // כעת נטפל בפרופיל ברקע
            try {
                let { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (profileError && profileError.code !== 'PGRST116') {
                    console.error("Profile fetch error:", profileError);
                }

                // אם אין פרופיל או הפרופיל ריק, צור/עדכן
                if (!profile) {
                    console.log("Creating new profile...");
                    await supabaseClient
                        .from('profiles')
                        .upsert({
                            id: currentUser.id,
                            display_name: userData.name,
                            avatar_url: userData.avatar,
                        });
                } else if (!profile.display_name || profile.display_name === 'משתמש') {
                    console.log("Updating existing profile...");
                    await supabaseClient
                        .from('profiles')
                        .update({
                            display_name: userData.name,
                            avatar_url: userData.avatar,
                        })
                        .eq('id', currentUser.id);
                }
            } catch (err) {
                console.error("Profile operations error:", err);
                // לא חשוב - הUI כבר מעודכן
            }
            
            // המתן קצת לפני טעינת הפרויקטים
            setTimeout(() => {
            loadProjects();
            isDashboardLoading = false; // Release lock after projects loaded
            }, 200);
            console.log("======================");
        }
        
        // --- Helper Functions ---
        async function detectPageType(project) {
            // PRIORITY 1: Check if pageType is already in project metadata (from server)
            if (project.pageType === 'onlineStore' || project.pageType === 'store') {
                console.log(`✅ Using metadata pageType: store (from ${project.fileName})`);
                return 'store';
            }
            if (project.pageType === 'event') {
                console.log(`✅ Using metadata pageType: event (from ${project.fileName})`);
                return 'event';
            }
            if (project.pageType === 'messageInBottle') {
                console.log(`✅ Using metadata pageType: messageInBottle (from ${project.fileName})`);
                return 'messageInBottle';
            }
            
            // Detect page type based on name, metadata, or content
            const name = (project.name || '').toLowerCase();
            const fileName = (project.fileName || project.local_file || '').toLowerCase();
            const description = (project.description || '').toLowerCase();
            
            // Message in Bottle keywords
            const messageInBottleKeywords = ['מסר בבקבוק', 'message in bottle', 'בקבוק', 'bottle'];
            const isMessageInBottleByName = messageInBottleKeywords.some(keyword => 
                name.includes(keyword) || fileName.includes(keyword) || description.includes(keyword)
            );
            
            // Event page keywords (הזמנה, חתונה, אירוע)
            const eventKeywords = ['חתונה', 'אירוע', 'הזמנה', 'בר מצווה', 'בת מצווה', 'חינה', 'ברית', 'wedding', 'event'];
            const isEventByName = eventKeywords.some(keyword => 
                name.includes(keyword) || fileName.includes(keyword) || description.includes(keyword)
            );
            
            // Store page keywords - EXPANDED LIST
            const storeKeywords = [
                'חנות', 'מוצר', 'קטלוג', 'ממתק', 'מכירה', 'קניה', 'מחיר', 'עגלה',
                'store', 'shop', 'product', 'catalog', 'buy', 'cart', 'price',
                'sweet', 'candy', 'food', 'bakery', 'מאפה', 'קונדיטוריה'
            ];
            const isStoreByName = storeKeywords.some(keyword => 
                name.includes(keyword) || fileName.includes(keyword) || description.includes(keyword)
            );
            
            // Try to detect by checking page content (only if HTML file exists)
            let isStoreByContent = false;
            let isEventByContent = false;
            let isMessageInBottleByContent = false;
            
            // Skip content checking for pages without HTML files
            if (project.hasHtmlFile !== false) {
                try {
                    // Fetch the page to check its content
                    const pageUrl = `/users/${project.userId || currentUser?.id}/${fileName}`;
                    const response = await fetch(pageUrl);
                    if (response.ok) {
                    const htmlContent = await response.text();
                    const lowerContent = htmlContent.toLowerCase();
                    
                    // Check for store indicators in content
                    const hasAddToCart = lowerContent.includes('addtocart') || 
                                        lowerContent.includes('הוסף לעגלה') ||
                                        lowerContent.includes('add to cart');
                    const hasCartElement = lowerContent.includes('cart-sidebar') || 
                                          lowerContent.includes('shopping-cart') ||
                                          lowerContent.includes('עגלת קניות');
                    const hasPrice = (lowerContent.match(/₪\d+/g) || []).length > 3;
                    
                    isStoreByContent = hasAddToCart || hasCartElement || (hasPrice && lowerContent.includes('product'));
                    
                    // Check for Message in Bottle indicators
                    const hasBottleIcon = lowerContent.includes('🍾') || lowerContent.includes('bottle');
                    const hasMessageForm = lowerContent.includes('שלח הודעה') && lowerContent.includes('response-form');
                    const hasMessageBottleText = lowerContent.includes('מסר בבקבוק') || lowerContent.includes('message in bottle');
                    const hasPostDetails = lowerContent.includes('פרטי הפוסט') && lowerContent.includes('edit-toggle');
                    const hasEditToggle = lowerContent.includes('ערוך פרטי הפוסט');
                    const hasHiddenBotInfo = lowerContent.includes('hidden info for bot only');
                    const hasBottleTitle = lowerContent.includes('🍾') && (lowerContent.includes('h1') || lowerContent.includes('title'));
                    isMessageInBottleByContent = hasBottleIcon || hasMessageForm || hasMessageBottleText || hasPostDetails || hasHiddenBotInfo || hasEditToggle || hasBottleTitle;
                    
                    // Check for event indicators
                    const hasRSVP = lowerContent.includes('rsvp') || lowerContent.includes('אישור הגעה');
                    const hasEventDate = lowerContent.includes('תאריך האירוע') || lowerContent.includes('event date');
                    
                    isEventByContent = hasRSVP || hasEventDate;
                    
                    console.log('🔍 Page type detection:', {
                        fileName,
                        isMessageInBottleByName,
                        isMessageInBottleByContent,
                        isStoreByName,
                        isStoreByContent,
                        isEventByName,
                        isEventByContent,
                        hasAddToCart,
                        hasCartElement,
                        hasBottleIcon,
                        hasMessageForm
                    });
                    }
                } catch (error) {
                    console.log('Could not fetch page content for type detection:', error);
                }
            } else {
                console.log('⏩ Skipping content check for page without HTML file:', fileName);
            }
            
            // PRIORITY 2: Content-based detection
            if (isMessageInBottleByContent || isMessageInBottleByName) {
                console.log(`✅ Detected messageInBottle from ${isMessageInBottleByContent ? 'content' : 'name'}`);
                return 'messageInBottle';
            }
            if (isEventByContent || isEventByName) {
                console.log(`✅ Detected event from ${isEventByContent ? 'content' : 'name'}`);
                return 'event';
            }
            if (isStoreByContent || isStoreByName) {
                console.log(`✅ Detected store from ${isStoreByContent ? 'content' : 'name'}`);
                return 'store';
            }
            
            console.log(`ℹ️ No specific type detected for ${fileName}, defaulting to 'other'`);
            return 'other';
        }
        
        function getManageButtonText(pageType, hasAppointments) {
            switch(pageType) {
                case 'event': return 'ניהול מוזמנים';
                case 'store': 
                case 'onlineStore': return 'ניהול חנות';
                case 'course': return 'ניהול קורסים';
                case 'workshop': return 'ניהול נרשמים';
                case 'messageInBottle': return 'ניהול הודעות';
                case 'serviceProvider': 
                    return hasAppointments ? 'ניהול תורים' : 'ניהול';
                default: return 'ניהול';
            }
        }
        
        function getManageUrl(pageType, fileName, userId) {
            switch(pageType) {
                case 'event': return `/event-admin.html?page=${fileName}&userId=${userId}`;
                case 'store':
                case 'onlineStore': return `/page-management.html?page=${fileName}&userId=${userId}`;
                case 'course': return `/course-management.html?pageId=${fileName}&userId=${userId}`;
                case 'workshop': return `/leads-admin.html?page=${fileName}&userId=${userId}`;
                case 'messageInBottle': return `/messages-management.html?page=${fileName}&userId=${userId}`;
                default: return `/leads-admin.html?page=${fileName}&userId=${userId}`;
            }
        }
        
        // --- פרויקטים ---
        async function loadProjects() {
            // Prevent concurrent calls - CRITICAL for Edge performance
            if (isLoadingProjects) {
                console.log('⚠️ loadProjects already running, skipping...');
                return;
            }
            isLoadingProjects = true;
            
            // Edge: Force timeout after 5 seconds
            const isEdgeBrowser = navigator.userAgent.indexOf('Edg') > -1;
            if (isEdgeBrowser) {
                setTimeout(() => {
                    if (isLoadingProjects) {
                        console.error('⏰ loadProjects timeout - forcing unlock');
                        isLoadingProjects = false;
                    }
                }, window.EDGE_TIMEOUT || 5000);
            }
            
            console.log('loadProjects התחיל');
            console.log('currentUser:', currentUser);
            
            const projectsList = document.getElementById('projects-list');
            if (!projectsList) {
                console.error('לא נמצא projects-list element');
                isLoadingProjects = false;
                return;
            }
            
            if (!currentUser) {
                console.error('currentUser לא מוגדר!');
                projectsList.innerHTML = '<div class="text-center py-16 col-span-full">שגיאה: משתמש לא מחובר</div>';
                isLoadingProjects = false;
                return;
            }
            projectsList.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-8">
                    <div class="gen-loader">
                        <div class="inner one"></div>
                        <div class="inner two"></div>
                        <div class="inner three"></div>
                    </div>
                    <p class="gen-text">טוען דפים...</p>
                </div>
            `;
            console.log('הוספתי loader');
            
            projects = []; // Reset global projects array
            let supabaseError = null;
            
            // נסה לטעון מ-Supabase
            try {
                console.log('מנסה לטעון מ-Supabase...');
                const { data: supabaseProjects, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (!error && supabaseProjects) {
                    projects = supabaseProjects;
                    console.log('נטענו מ-Supabase:', projects.length, 'פרויקטים');
                    
                    // Try to enrich Supabase projects with pageType from local API
                    try {
                        const localResponse = await fetch(`/api/pages/${currentUser.id}`);
                        const localData = await localResponse.json();
                        
                        if (localData.pages && localData.pages.length > 0) {
                            // Create a map of fileName -> pageType
                            const pageTypeMap = {};
                            localData.pages.forEach(page => {
                                if (page.pageType) {
                                    pageTypeMap[page.fileName] = page.pageType;
                                }
                            });
                            
                            // Enrich Supabase projects with pageType
                            projects.forEach(project => {
                                // Try to match by various fields
                                let matchingPageType = pageTypeMap[project.local_file] || 
                                                      pageTypeMap[project.id];
                                
                                // If no match, try fuzzy matching by name
                                if (!matchingPageType) {
                                    const projectName = (project.name || '').toLowerCase();
                                    for (const [fileName, pageType] of Object.entries(pageTypeMap)) {
                                        const cleanFileName = fileName.replace(/_html$/, '').replace(/\.html$/, '').replace(/_/g, ' ').toLowerCase();
                                        if (projectName.includes(cleanFileName) || cleanFileName.includes(projectName)) {
                                            matchingPageType = pageType;
                                            console.log(`🔍 Fuzzy matched: "${projectName}" ↔ "${cleanFileName}" → ${pageType}`);
                                            break;
                                        }
                                    }
                                }
                                
                                // If still no match and it's a store-like name, default to 'store'
                                if (!matchingPageType) {
                                    const projectName = (project.name || '').toLowerCase();
                                    const storeKeywords = ['ממתק', 'שוקולד', 'חנות', 'מכירה', 'store', 'shop', 'sweet', 'שעונ'];
                                    if (storeKeywords.some(kw => projectName.includes(kw))) {
                                        matchingPageType = 'store';
                                        console.log(`🏪 Auto-detected as store by name: ${project.name}`);
                                    }
                                }
                                
                                if (matchingPageType) {
                                    project.pageType = matchingPageType;
                                    console.log(`✅ Enriched project with pageType: ${matchingPageType} for ${project.name}`);
                                }
                            });
                        }
                    } catch (enrichErr) {
                        console.log('Could not enrich with local pageTypes:', enrichErr);
                    }
                } else {
                    console.log('שגיאה ב-Supabase:', error);
                    supabaseError = error;
                }
            } catch (err) {
                console.log('שגיאה ב-Supabase, עובר לנתונים מקומיים:', err);
                supabaseError = err;
            }
            
            // אם Supabase נכשל, טען מקומית
            if (supabaseError || projects.length === 0) {
                try {
                    console.log('מנסה לטעון נתונים מקומיים...');
                    const localResponse = await fetch(`/api/pages/${currentUser.id}`);
                    const localData = await localResponse.json();
                    
                    if (localData.pages && localData.pages.length > 0) {
                        // המר דפים מקומיים לפורמט Supabase
                        projects = localData.pages.map(page => {
                            // חלץ שם נקי מתוך שם הקובץ
                            let cleanName = page.title || 'דף נחיתה';
                            
                            // DISABLED: Removed multiple fetch requests that caused Edge to freeze
                            // Instead, we extract title from filename only
                            // This prevents dozens of simultaneous HTTP requests
                            
                            // אם יש שם קובץ עם timestamp, נסה לחלץ שם יותר טוב
                            if (page.fileName && page.fileName.includes('_')) {
                                const namePart = page.fileName.split('_')[0];
                                if (namePart && namePart !== 'page' && namePart !== 'דף' && namePart.length > 2) {
                                    cleanName = decodeURIComponent(namePart);
                                }
                            }
                            
                            const projectObj = {
                            id: `local_${page.fileName}`,
                                name: cleanName,
                                description: 'דף נחיתה מקצועי',
                            html_content: null, // נטען בנפרד
                            template_type: 'local',
                            status: 'completed',
                            created_at: new Date().toISOString(),
                            local_file: page.fileName,
                            local_url: page.url,
                                user_id: currentUser.id,
                                userId: currentUser.id,
                                pageType: page.pageType // CRITICAL: Pass pageType from server!
                            };
                            
                            console.log(`✅ Local page loaded with pageType: ${page.pageType} for ${page.fileName}`);
                            
                            return projectObj;
                        });
                        console.log('נטענו דפים מקומיים:', projects.length);
                    }
                } catch (localErr) {
                    console.error('שגיאה בטעינת דפים מקומיים:', localErr);
                    console.log('מציג הודעה ריקה...');
                }
            }
            
            console.log('סיימתי לטעון, יש', projects.length, 'פרויקטים');
            
            // אם יש שגיאה מ-Supabase אבל יש דפים מקומיים, נמשיך
            // אם אין דפים בכלל, נציג הודעה ריקה
            
            if (projects && projects.length > 0) {
                console.log('מציג', projects.length, 'פרויקטים');
                projectsList.innerHTML = '';
                
                projects.forEach((project, index) => {
                    console.log(`מציג פרויקט ${index + 1}:`, project.name);
                    
                    // Use pageType from server (already detected and saved)
                    const pageType = project.pageType || 'other';
                    const manageButtonText = getManageButtonText(pageType);
                    console.log(`📋 Page type: ${pageType} → Button text: "${manageButtonText}" for ${project.name}`);
                    console.log(`🔍 Full project data:`, project);
                    
                    // Special logging for messageInBottle
                    if (pageType === 'messageInBottle') {
                        console.log(`🍾 MESSAGE IN BOTTLE DETECTED! Should show "ניהול הודעות" and "השהה" buttons`);
                        console.log(`🍾 Project details:`, {
                            name: project.name,
                            fileName: project.fileName,
                            pageType: project.pageType
                        });
                    } else if (!project.pageType) {
                        console.log(`⚠️ No pageType in project metadata - might need auto-detection`);
                        
                        // Try to auto-detect and update metadata for messageInBottle pages
                        if (project.fileName && (project.fileName.includes('1761578919863') || 
                            project.name.includes('דף נחיתה') ||
                            project.name.includes('מסר בבקבוק'))) {
                            console.log(`🔍 Attempting auto-detection for suspicious page: ${project.fileName}`);
                            autoDetectAndUpdateMessageBottle(project);
                        }
                    } else {
                        console.log(`📋 Page type detected as: ${pageType} for ${project.name}`);
                    }
                    
                    const creationDate = new Date(project.created_at).toLocaleDateString('he-IL');
                    const projectCard = document.createElement('div');
                    projectCard.className = 'bg-white p-4 rounded-xl border border-gray-200 shadow-md hover:shadow-lg hover:border-indigo-400 hover:-translate-y-1 transition-all duration-300 flex flex-col overflow-hidden backdrop-blur-sm bg-white/95';
        projectCard.style.minHeight = '450px';
        projectCard.style.maxHeight = '450px';
        projectCard.style.display = 'flex';
        projectCard.style.flexDirection = 'column';
        projectCard.style.position = 'relative';
                    projectCard.setAttribute('data-project-id', project.id);
                    
                    const hasHtmlContent = (project.html_content && project.html_content.trim() !== '') || project.local_url;
                    
                    // בדוק אם הדף הזה יש לו מנוי פעיל - USE project.id!
                    const storageKey = `page_subscription_${project.id}`;
                    const pageSubscription = localStorage.getItem(storageKey);
                    const hasPageSubscription = pageSubscription && JSON.parse(pageSubscription).isActive;
                    
                    console.log(`📄 Page ID: ${project.id}`);
                    console.log(`🔑 Storage key: ${storageKey}`);
                    console.log(`📦 Subscription data: ${pageSubscription}`);
                    console.log(`✅ Has active subscription: ${hasPageSubscription}`);
                    
                    // דפים חדשים מתחילים ללא מנוי (אין מנוי ב-localStorage)
                    const finalHasSubscription = hasPageSubscription;
                    
                    const statusBadge = finalHasSubscription ? 
                        '<span class="status-badge status-completed">מנוי פעיל</span>' :
                        '<span class="status-badge status-processing">מנוי לא פעיל</span>';
                    
                    // קבל את כתובת הדף
                    const pageUrl = project.local_url || (project.html_content ? '#' : '');
        const actionButtons = `
            <div class="flex items-center justify-between gap-2 w-full">
                <div class="flex items-center gap-2 flex-wrap flex-1">
                    ${(() => {
                        console.log(`🔍 Button logic for ${project.name}:`, {
                            hasHtmlContent,
                            finalHasSubscription,
                            pageType,
                            isMessageInBottle: pageType === 'messageInBottle'
                        });
                        
                        if (hasHtmlContent && finalHasSubscription) {
                            console.log(`✅ Showing VIEW button for ${project.name}`);
                            return `<button onclick="viewProject('${project.id}')" class="bg-green-500 text-white px-3 py-2 rounded text-sm font-medium hover:bg-green-600 transition shadow-sm" style="min-width: 60px;">
                                צפה
                            </button>`;
                        } else if (pageType === 'messageInBottle') {
                            console.log(`🍾 Showing PAUSE button for messageInBottle: ${project.name}`);
                            return `<button onclick="toggleMessageBottleStatus('${project.id}')" id="status-btn-${project.id}" class="bg-green-600 text-white px-3 py-2 rounded text-sm font-medium hover:bg-green-700 transition shadow-sm" style="min-width: 60px;">
                                ⏸️ השהה
                            </button>`;
                        } else if (hasHtmlContent && !finalHasSubscription) {
                            console.log(`⚠️ Showing SUBSCRIPTION button for ${project.name}`);
                            return `<button onclick="openPageSubscriptionModal('${project.id}')" class="bg-yellow-500 text-white px-3 py-2 rounded text-sm font-medium hover:bg-yellow-600 transition shadow-sm" style="min-width: 80px;">
                            הפעל מנוי
                            </button>`;
                        } else {
                            console.log(`❌ No button for ${project.name}`);
                            return '';
                    }
                    })()}
                    ${pageUrl && finalHasSubscription ?
                        `<button onclick="copyToClipboard('${window.location.origin}${pageUrl}')" class="bg-purple-500 text-white px-3 py-2 rounded text-sm font-medium hover:bg-purple-600 transition shadow-sm" style="min-width: 60px;">
                            העתק קישור
                        </button>` : ''
                    }
                </div>
                
                <!-- כפתור תפריט -->
                <div class="relative dropdown-container">
                    <button onclick="toggleDropdown(event, '${project.id}')" class="bg-gray-700 text-white px-3 py-2 rounded text-sm font-medium hover:bg-gray-800 transition shadow-sm flex items-center gap-1" style="min-width: 60px;">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                    </svg>
                </button>
                    
                    <!-- תפריט נפתח -->
                    <div id="dropdown-${project.id}" class="dropdown-menu hidden absolute left-0 bottom-full mb-2 bg-white rounded-lg shadow-xl border border-gray-200 py-1 z-50" style="min-width: 150px;">
                        <button onclick="editProject('${project.id}')" class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        ערוך
                        </button>
                        ${pageType === 'messageInBottle' ? 
                            `<button onclick="editMessageInBottlePost('${project.id}')" class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-green-50 flex items-center gap-2">
                                <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                🍾 שנה פוסט
                            </button>` : ''
                        }
                        ${hasHtmlContent ?
                            `<button data-action="manage" data-page-type="${pageType}" onclick="manageProject('${project.id}', '${pageType}')" class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                                <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <span class="manage-button-text">${manageButtonText}</span>
                            </button>` : ''
                        }
                        ${!project.pageType || project.pageType === 'other' ? 
                            `<button onclick="autoDetectAndUpdateMessageBottle(${JSON.stringify(project).replace(/"/g, '&quot;')})" class="w-full text-right px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2 border-t border-gray-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                🔍 זהה סוג דף
                            </button>` : ''
                        }
                        <button onclick="deleteProject('${project.id}')" class="w-full text-right px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 border-t border-gray-100">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        מחק
                        </button>
                    </div>
                </div>
            </div>
        `;
                    
                    projectCard.innerHTML = `
                            <!-- תצוגה מקדימה של האתר -->
                        <div class="relative rounded-t-xl overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100" style="height: 200px; flex-shrink: 0;">
                                ${pageUrl ? `
                        <!-- תצוגה מקדימה עם iframe - מצד לצד עד הקצוות -->
                                        <iframe 
                                            src="${window.location.origin}${pageUrl}" 
                            class="absolute inset-0 w-full h-full border-0"
                                            style="pointer-events: none; transform: scale(0.6) translateX(65%); transform-origin: top left; width: 166.67%; height: 166.67%;"
                                            title="תצוגה מקדימה של ${project.name}"
                                            loading="lazy"
                                            importance="low"
                            sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-downloads allow-modals allow-top-navigation allow-presentation">
                                        </iframe>
                                ` : `
                                    <!-- תצוגה מקדימה סטטית -->
                                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-purple-500/10"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="text-center">
                                            <div class="w-16 h-16 bg-white/90 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg border-2 border-indigo-200">
                                                <span class="text-2xl font-bold text-indigo-600">${project.name.charAt(0)}</span>
                                            </div>
                                            <div class="text-sm font-medium text-gray-700 bg-white/90 px-3 py-1 rounded-full shadow-sm border border-gray-200">
                                                אין תוכן
                                            </div>
                                        </div>
                                    </div>
                                `}
                                ${finalHasSubscription ? `
                                    <div class="absolute top-3 right-3">
                                        <div class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            זמין לצפייה
                                        </div>
                                    </div>
                                ` : `
                                    <div class="absolute top-3 right-3">
                                        <div class="bg-amber-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                            ממתין
                                        </div>
                                    </div>
                                `}
                            </div>
                            
                        <!-- תוכן הכרטיס -->
                        <div class="p-4 flex-1 flex flex-col" style="min-height: 0; overflow: hidden;">
                            <!-- כותרת וסטטוס -->
                            <div class="mb-3 flex-shrink-0">
                                    <h3 class="font-semibold text-lg text-gray-800 mb-2" style="min-height: 24px;">${project.name}</h3>
                                <p class="text-sm text-gray-500 mb-3 line-clamp-2" style="min-height: 32px;">${project.description || 'דף נחיתה מקצועי'}</p>
                                <div class="flex items-center justify-between text-xs text-gray-400 mb-2">
                                    <span>נוצר: ${creationDate}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                            
                        </div>
                        
                        <!-- פס כפתורים בתחתית -->
                        <div class="border-t border-gray-100 bg-gray-50 px-4 py-3 rounded-b-xl flex-shrink-0" style="min-height: 70px; display: flex; align-items: center;">
                            <div class="flex items-center justify-center gap-2 flex-wrap w-full">${actionButtons}</div>
                        </div>
                    `;
                    console.log(`מוסיף כרטיס ${index + 1} ל-DOM`);
                    projectsList.appendChild(projectCard);
                });
                console.log('סיימתי להוסיף כרטיסים');
                
                // עדכן את המודל רק אם המשתמש ביקש זאת במפורש
                // הוסר רענון אוטומטי שגרם לבעיות
            } else {
                 projectsList.innerHTML = `
                    <div class="text-center py-16 col-span-full">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                        <h3 class="mt-2 text-lg font-medium text-gray-900">עדיין אין דפי נחיתה</h3>
                        <p class="mt-1 text-sm text-gray-500">הגיע הזמן ליצור את דף הנחיתה הראשון שלך.</p>
                        <div class="mt-6">
                            <button onclick="goToFullApp()" class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-bold hover:bg-indigo-700 transition-transform transform hover:scale-105 flex items-center gap-2 mx-auto">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span>צור דף חדש</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Release lock after loading completes
            isLoadingProjects = false;
        }

        async function viewProject(projectId) {
            console.log('👁️ viewProject called with:', projectId);
            
            try {
            // בדוק אם זה דף מקומי
            if (projectId.startsWith('local_')) {
                const fileName = projectId.replace('local_', '');
                    
                    if (!currentUser || !currentUser.id) {
                        console.error('❌ currentUser not defined!');
                        alert('שגיאה: משתמש לא מחובר');
                        return;
                    }
                    
                const url = `/pages/${currentUser.id}/${fileName}`;
                    console.log('🌐 Opening URL:', url);
                
                // פתח בחלון חדש
                const newWindow = window.open(url, '_blank');
                    if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                        console.warn('⚠️ Popup blocked, trying same tab');
                        window.location.href = url;
                    } else {
                        console.log('✅ Page opened in new tab');
                    }
                    return;
                }
            } catch (error) {
                console.error('❌ Error in viewProject:', error);
                alert('שגיאה בפתיחת הדף: ' + error.message);
                return;
            }
            
            // דף מ-Supabase
            try {
                const { data: project, error } = await supabaseClient.from('projects').select('html_content, name').eq('id', projectId).single();
                if (error || !project) return showError('שגיאה בטעינת הפרויקט.');
                if (!project.html_content) return showError('לא נמצא תוכן HTML לפרויקט זה.');

                // פתח בחלון חדש
                const newWindow = window.open("");
                if (newWindow) {
                    newWindow.document.write(project.html_content);
                    newWindow.document.close();
                    newWindow.document.title = project.name || 'דף נחיתה';
                } else {
                    showError('פתיחת חלון חדש נכשלה. בדוק חוסם פופ-אפים.');
                }
            } catch (err) {
                console.error('Error viewing project:', err);
                showError('שגיאה בטעינת הפרויקט.');
            }
        }

        function editProject(projectId) {
            window.location.href = `/page-creator?edit=${projectId}&redirectUrl=${encodeURIComponent(window.location.href)}`;
        }

        function updateManagementButton(projectCard, pageType, hasAppointments) {
            const manageButton = projectCard.querySelector('[data-action="manage"]');
            if (manageButton) {
                if (pageType === 'store' || pageType === 'onlineStore') {
                    manageButton.textContent = '🛒 ניהול חנות';
                } else if (pageType === 'event') {
                    manageButton.textContent = '🎉 ניהול מוזמנים';
                } else if (pageType === 'serviceProvider' && hasAppointments) {
                    manageButton.textContent = '📅 ניהול תורים';
                } else {
                    manageButton.textContent = '⚙️ ניהול';
                }
            }
        }

        function getManagementButtonText(project) {
            // First check if pageType was auto-detected
            if (project.pageType === 'store' || project.pageType === 'onlineStore') {
                return 'ניהול חנות';
            }
            if (project.pageType === 'event') {
                return 'ניהול מוזמנים';
            }
            if (project.pageType === 'serviceProvider' && project.hasAppointments) {
                return 'ניהול תורים';
            }
            
            // Fallback: Detect page type from name or description  
            const name = (project.name || '').toLowerCase();
            const desc = (project.description || '').toLowerCase();
            const fileName = (project.local_file || project.id || '').toLowerCase();
            const combined = name + ' ' + desc + ' ' + fileName;
            
            // Store detection - ALL products/shops
            if (combined.includes('חנות') || combined.includes('מוצר') || combined.includes('קניה') || 
                combined.includes('store') || combined.includes('shop') || combined.includes('מקרוני') ||
                combined.includes('צעצוע') || combined.includes('ספרים') || combined.includes('ממתק') ||
                combined.includes('פיצ') || combined.includes('pizza') || combined.includes('מסעד') ||
                combined.includes('בייגל') || combined.includes('bagel') || combined.includes('מאפה') ||
                combined.includes('לחם') || combined.includes('קפה') || combined.includes('משקה') ||
                combined.includes('בגד') || combined.includes('נעל') || combined.includes('אופנה') ||
                combined.includes('אלקטרוניקה') || combined.includes('מחשב') || combined.includes('טלפון') ||
                combined.includes('יהלומי') || combined.includes('יהלום') || combined.includes('תכשיט') || combined.includes('שעון') ||
                combined.includes('זהב') || combined.includes('כסף') || combined.includes('jewelry') ||
                combined.includes('מכולת') || combined.includes('סופר') || combined.includes('market') ||
                combined.includes('וילונות') || combined.includes('רהיט') || combined.includes('עיצוב פנים') ||
                combined.includes('צמח') || combined.includes('פרח') || combined.includes('גינה') ||
                combined.includes('candy') || combined.includes('sweet') || combined.includes('chocolate')) {
                return 'ניהול חנות';
            }
            // Event detection - EXPANDED
            if (combined.includes('אירוע') || combined.includes('כנס') || combined.includes('מפגש') || 
                combined.includes('מוזמן') || combined.includes('חתונה') || combined.includes('בר מצוה') ||
                combined.includes('בת מצוה') || combined.includes('הזמנה') || combined.includes('event') ||
                combined.includes('wedding') || combined.includes('invitation') || combined.includes('חינה') ||
                combined.includes('מסיבה') || combined.includes('יום הולדת')) {
                return 'ניהול מוזמנים';
            }
            // Course detection
            if (combined.includes('קורס') || combined.includes('לימוד') || combined.includes('הדרכה') ||
                combined.includes('course') || combined.includes('workshop')) {
                return 'ניהול קורס';
            }
            // Default
            return 'ניהול';
        }
        
        function toggleDropdown(event, projectId) {
            event.stopPropagation();
            
            // סגור כל התפריטים הפתוחים
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                if (menu.id !== `dropdown-${projectId}`) {
                    menu.classList.remove('show');
                }
            });
            
            // פתח/סגור את התפריט הנוכחי
            const dropdown = document.getElementById(`dropdown-${projectId}`);
            dropdown.classList.toggle('show');
        }

        // פונקציה לעריכת פוסט מסר בבקבוק
        function editMessageInBottlePost(projectId) {
            // מצא את הפרויקט
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                alert('לא נמצא הפרויקט');
                return;
            }

            // צור חלון עריכה
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">🍾 עריכת פוסט</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">שם</label>
                            <input type="text" id="edit-post-name" value="${project.name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">שירות/בקשה</label>
                            <textarea id="edit-post-request" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="מה אתה מציע או מחפש?">${project.description || ''}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">אזור</label>
                            <input type="text" id="edit-post-area" value="${project.area || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="תל אביב, נתניה...">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">מחיר</label>
                                <input type="number" id="edit-post-price" value="${project.price || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">סוג</label>
                                <select id="edit-post-price-type" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="כללי" ${project.priceType === 'כללי' ? 'selected' : ''}>כללי</option>
                                    <option value="שעתי" ${project.priceType === 'שעתי' ? 'selected' : ''}>שעתי</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveMessageInBottlePost('${projectId}')" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
                            💾 שמור שינויים
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600">
                            ❌ בטל
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // פונקציה לשמירת שינויים בפוסט מסר בבקבוק
        async function saveMessageInBottlePost(projectId) {
            const name = document.getElementById('edit-post-name').value;
            const request = document.getElementById('edit-post-request').value;
            const area = document.getElementById('edit-post-area').value;
            const price = document.getElementById('edit-post-price').value;
            const priceType = document.getElementById('edit-post-price-type').value;

            if (!name || !request || !area) {
                alert('נא למלא את כל השדות החובה');
                return;
            }

            try {
                // עדכן את הפרויקט במערכת
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    project.name = name;
                    project.description = request;
                    project.area = area;
                    project.price = price;
                    project.priceType = priceType;
                }

                // שמור ב-localStorage
                const projectsKey = `projects_${currentUser.id}`;
                localStorage.setItem(projectsKey, JSON.stringify(projects));

                // סגור את החלון
                document.querySelector('.fixed').remove();
                
                // רענן את התצוגה
                await loadProjects();
                
                alert('הפוסט עודכן בהצלחה! 🎉');
                
            } catch (error) {
                console.error('Error saving post:', error);
                alert('שגיאה בשמירת השינויים');
            }
        }
        
        async function manageProject(projectId, detectedPageType = null) {
            console.log('🔍 manageProject called with:', projectId, 'pageType:', detectedPageType);
            
            // חלץ את שם הקובץ והמשתמש
            const fileName = projectId.startsWith('local_') ? projectId.replace('local_', '') : projectId;
            
            // מצא את הפרויקט כדי לקבל את ה-userId שלו
            const project = projects.find(p => p.id === projectId);
            
            console.log('📦 Project object:', project);
            
            // Try to get userId from multiple sources
            let userId = currentUser?.id;
            if (!userId && project?.userId) {
                userId = project.userId;
            }
            if (!userId && project?.user_id) {
                userId = project.user_id;
            }
            // If still no userId, extract from URL
            if (!userId && project?.local_url) {
                const urlMatch = project.local_url.match(/\/pages\/([^\/]+)\//);
                if (urlMatch) {
                    userId = urlMatch[1];
                }
            }
            
            console.log('👤 userId:', userId, '📄 fileName:', fileName);
            
            if (!userId) {
                alert('שגיאה: לא ניתן לזהות את המשתמש.');
                return;
            }
            
            // Use detected page type or load from metadata
            let pageType = detectedPageType || project?.pageType;
            let hasAppointments = project?.hasAppointments || false;
            
            if (!pageType || !hasAppointments) {
                try {
                    const metadataUrl = `/pages/${userId}/${fileName}_data/metadata.json`;
                    const response = await fetch(metadataUrl);
                    if (response.ok) {
                        const metadata = await response.json();
                        if (!pageType) {
                            pageType = metadata.pageType;
                            console.log('📋 Loaded pageType from metadata:', pageType);
                        }
                        // Check if page has appointments system
                        hasAppointments = metadata.appointments !== undefined || metadata.hasAppointments === true;
                        console.log('📅 hasAppointments:', hasAppointments);
                    }
                } catch (err) {
                    console.log('⚠️ No metadata, using default');
                }
            }
            
            // Determine management URL based on pageType
            let managementUrl;
            
            console.log('🔍 FINAL pageType for routing:', pageType, 'Type:', typeof pageType, 'hasAppointments:', hasAppointments);
            
            if (pageType === 'event') {
                // דף אירוע/הזמנה → ניהול מוזמנים
                managementUrl = `/event-guests.html?eventId=${fileName}&userId=${userId}`;
                console.log('🎉 Opening EVENT management (guests)');
            } else if (pageType === 'store' || pageType === 'onlineStore') {
                // דף חנות → ניהול חנות
                managementUrl = `/page-management.html?page=${fileName}&userId=${userId}`;
                console.log('🛒 Opening STORE management for:', fileName);
            } else if (pageType === 'messageInBottle') {
                // מסר בבקבוק → ניהול הודעות
                managementUrl = `/messages-management.html?page=${fileName}&userId=${userId}`;
                console.log('🍾 Opening MESSAGES management for:', fileName);
            } else if (pageType === 'serviceProvider' && hasAppointments) {
                // נותן שירות עם תורים → ניהול תורים
                const pageName = encodeURIComponent(fileName.replace(/_html$/, '').replace(/_/g, ' '));
                managementUrl = `/appointments-admin.html?userId=${userId}&pageId=${fileName}&pageName=${pageName}`;
                console.log('📅 Opening APPOINTMENTS management for:', fileName);
            } else {
                // דפים אחרים → ניהול לידים
                managementUrl = `/leads-admin.html?page=${fileName}&userId=${userId}`;
                console.log('📋 Opening LEADS management (pageType was:', pageType, ')');
            }
            
            console.log('🌐 Opening:', managementUrl);
            
            // Open in new tab
            const newWindow = window.open(managementUrl, '_blank');
            
            // Fallback: if popup blocked, open in same tab
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                console.warn('⚠️ Popup blocked, opening in same tab');
                window.location.href = managementUrl;
            }
        }
        
        // סגור תפריטים כשלוחצים מחוץ להם
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown-container')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        async function cleanOrphanedData() {
            if (!confirm('נ§¹ ׳”׳׳ ׳׳ ׳§׳•׳× ׳ ׳×׳•׳ ׳™׳ ׳™׳×׳•׳׳™׳ (׳§׳ ׳™׳•׳× ׳•׳׳•׳–׳׳ ׳™׳ ׳׳“׳₪׳™׳ ׳©׳ ׳׳—׳§׳•)?')) return;
            
            try {
                const response = await fetch('/api/clean-orphaned-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentUser.id
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showSuccess(data.message);
                    console.log('✅ Cleaned:', data);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'שגיאה בניקוי נתונים');
                }
            } catch (error) {
                console.error('Error cleaning data:', error);
                showError('שגיאה בניקוי נתונים: ' + error.message);
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את דף הנחיתה? הפעולה לא ניתנת לביטול.')) return;
            
            try {
                // בדוק אם זה דף מקומי
                if (projectId.startsWith('local_')) {
                    const fileName = projectId.replace('local_', '');
                    console.log('Deleting local file:', fileName);
                    
                    // מחק מהשרת המקומי
                    const response = await fetch(`/api/delete-page`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            fileName: fileName
                        })
                    });
                    
                    if (response.ok) {
                        showSuccess('הדף נמחק בהצלחה');
                        loadProjects(); // רענן את הרשימה
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'שגיאה במחיקת הדף המקומי');
                    }
                    return;
                }
                
                // דף מ-Supabase
                const { error } = await supabaseClient.from('projects').delete().eq('id', projectId);
                if (error) throw error;
                
                showSuccess('הדף נמחק בהצלחה');
                loadProjects(); // רענן את הרשימה
            } catch (error) {
                console.error('Error deleting project:', error);
                showError('שגיאה במחיקת הפרויקט: ' + error.message);
            }
        }

        async function signOut() {  
            // Clear all intervals to prevent memory leaks
            if (subscriptionTimer) {
                clearInterval(subscriptionTimer);
                subscriptionTimer = null;
            }
            if (adminTimeInterval) {
                clearInterval(adminTimeInterval);
                adminTimeInterval = null;
            }
            
            // Clear user data
            clearCurrentUser();
            currentUser = null;
            subscriptionData = null;
            isAdmin = false;
            
            // Sign out from Supabase
            await supabaseClient.auth.signOut();  
        }

        function goToFullApp() {  
            window.location.href = '/page-creator?redirectUrl=' + encodeURIComponent(window.location.href);  
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('הכתובת הועתקה ללוח');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showError('שגיאה בהעתקת הכתובת');
            });
        }
        // --- Event Listeners ---
        // Admin panel event listeners - with null checks
        if (adminPanelBtn) {
        adminPanelBtn.addEventListener('click', openAdminPanel);
        }
        if (closeAdminPanel) {
        closeAdminPanel.addEventListener('click', closeAdminPanelHandler);
        }
        
        // Account summary button
        const accountSummaryBtn = document.getElementById('account-summary-btn');
        if (accountSummaryBtn) {
            accountSummaryBtn.addEventListener('click', openAccountSummaryModal);
        }

        // Admin tab switching - with null checks
        const dashboardTab = document.getElementById('dashboard-tab');
        const usersTab = document.getElementById('users-tab');
        const financeTab = document.getElementById('finance-tab');
        const analyticsTab = document.getElementById('analytics-tab');
        const settingsTab = document.getElementById('settings-tab');
        
        if (dashboardTab) {
            dashboardTab.addEventListener('click', () => switchAdminTab('dashboard', 'דשבורד'));
        }
        if (usersTab) {
            usersTab.addEventListener('click', () => switchAdminTab('users', 'ניהול משתמשים'));
        }
        if (financeTab) {
            financeTab.addEventListener('click', () => switchAdminTab('finance', 'ניהול כספים'));
        }
        if (analyticsTab) {
            analyticsTab.addEventListener('click', () => switchAdminTab('analytics', 'סטטיסטיקות'));
        }
        if (settingsTab) {
            settingsTab.addEventListener('click', () => switchAdminTab('settings', 'הגדרות'));
        }

        function switchAdminTab(tabName, title) {
            try {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all sidebar tabs
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.remove('text-white', 'bg-indigo-600');
                tab.classList.add('text-gray-700', 'hover:bg-gray-50', 'hover:text-gray-900');
            });
            
            // Show selected tab content
                const tabContent = document.getElementById(`${tabName}-content`);
                if (tabContent) {
                    tabContent.classList.remove('hidden');
                } else {
                    console.error(`Tab content not found: ${tabName}-content`);
                }
            
            // Add active class to selected tab
            const selectedTab = document.getElementById(`${tabName}-tab`);
                if (selectedTab) {
            selectedTab.classList.add('text-white', 'bg-indigo-600');
            selectedTab.classList.remove('text-gray-700', 'hover:bg-gray-50', 'hover:text-gray-900');
                } else {
                    console.error(`Tab not found: ${tabName}-tab`);
                }
            
            // Update page title
            if (adminPageTitle) {
                adminPageTitle.textContent = title;
                }
            } catch (error) {
                console.error('Error switching admin tab:', error);
            }
        }
        // --- מאזינים לאירועים ---
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            if (event === 'SIGNED_OUT') {
                currentUser = null;
                clearCurrentUser();
                isAdmin = false;
                isDashboardLoading = false; // Reset dashboard lock
                dashboardView.classList.add('hidden');
                loginView.classList.remove('hidden');
                document.body.classList.remove('bg-gray-50');
                if (!document.getElementById('googleSignInBtn').onclick) {
                   initGoogleSignIn();
                }
            } else if (event === 'SIGNED_IN' && session) {
                // Only update if not already showing dashboard
                if (dashboardView.classList.contains('hidden')) {
                currentUser = session.user;
                saveCurrentUser(currentUser);
                setTimeout(() => {
                showDashboard();
                }, 100);
                } else {
                    console.log('Dashboard already shown, skipping SIGNED_IN handler');
                }
            }
        });
        
        // Stav Chat Functions - SYNCED WITH MARKETPLACE
        function toggleStavChat() {
            const chatWindow = document.getElementById('stavChatWindow');
            chatWindow.classList.toggle('active');
            if (chatWindow.classList.contains('active')) {
                document.getElementById('stavChatInput').focus();
            }
        }
        
        // Search live pages for Stav (same as marketplace) - FORCE LIVE DATA
        // 🏷️ SMART CATEGORY MAPPING - Maps search terms to broader categories
        const stavCategoryMapping = {
            // שירותים
            'נגרות': ['נגר', 'carpenter', 'עבודות עץ', 'נגרות', 'רהיטים', 'ארון', 'מטבח', 'ארונות'],
            'אינסטלציה': ['אינסטלטור', 'plumber', 'אינסטלציה', 'שרברב', 'ברז', 'צנרת', 'צינור', 'פיצוץ', 'נזילה', 'איסטלטור', 'אנסטלטור'],
            'חשמל': ['חשמלאי', 'electrician', 'חשמל', 'תאורה', 'בזק', 'קצר'],
            'מספרה': ['מספרה', 'תספורת', 'מעצב שיער', 'עיצוב שיער', 'ספר', 'barber', 'להסתפר', 'הסתפרות', 'מסתפר'],
            // צעצועים וילדים
            'צעצועים': ['צעצוע', 'toy', 'משחק', 'צעצועים', 'משחקים', 'ילדים'],
            'בובות': ['בובה', 'doll', 'בובות'],
            'משחקים': ['משחק', 'game', 'משחקים', 'משחקי', 'לוח'],
            // אופנה ואקססוריז
            'שעונים': ['שעון', 'watch', 'שעונים', 'שעוני', 'זמן', 'time'],
            'תכשיטים': ['תכשיט', 'jewelry', 'תכשיטים', 'שרשרת', 'צמיד', 'טבעת', 'עגיל'],
            // יופי וטיפוח
            'לק': ['לק', 'nail polish', 'ציפורניים', 'מניקור', 'לק גל']
        };
        
        // 🔍 Expand search terms with category synonyms
        function expandStavSearchTerms(searchTerm) {
            const expanded = [searchTerm.toLowerCase()];
            
            // Check each category
            for (const [category, synonyms] of Object.entries(stavCategoryMapping)) {
                // If search term matches category or any synonym
                if (searchTerm.toLowerCase() === category.toLowerCase() || 
                    synonyms.some(syn => searchTerm.toLowerCase().includes(syn.toLowerCase()) || 
                                        syn.toLowerCase().includes(searchTerm.toLowerCase()))) {
                    // Add all synonyms to search
                    expanded.push(...synonyms);
                    console.log(`🏷️ Expanded "${searchTerm}" with category "${category}":`, synonyms);
                    break;
                }
            }
            
            return [...new Set(expanded)]; // Remove duplicates
        }

        async function searchLivePagesStav(query) {
            const searchTerm = query.toLowerCase();
            const results = [];
            
            console.log(`🔍 Stav FORCING LIVE DATA SEARCH for: "${searchTerm}"`);
            
            // 🎯 Expand search terms with synonyms
            const expandedTerms = expandStavSearchTerms(searchTerm);
            console.log(`🔍 Expanded search terms:`, expandedTerms);
            
            try {
                // ALWAYS get fresh pages from server
                const response = await fetch('/api/pages/all');
                console.log('🔍 Stav fetch response status:', response.status);
                
                if (!response.ok) {
                    console.error('🔍 Stav fetch failed:', response.status, response.statusText);
                    return results;
                }
                
                const data = await response.json();
                const freshPages = data.pages || [];
                
                console.log(`🔍 Stav got ${freshPages.length} fresh pages from server`);
                
                for (const page of freshPages) {
                    try {
                        const pageUrl = `/users/${page.userId}/${page.pageId}_html`;
                        console.log(`🔍 Stav fetching LIVE page: ${pageUrl}`);
                        const response = await fetch(pageUrl);
                        if (response.ok) {
                            const html = await response.text();
                            const htmlLower = html.toLowerCase();
                            
                            // Check if ANY of the expanded search terms appears in page content
                            const found = expandedTerms.some(term => htmlLower.includes(term));
                            console.log(`🔍 Stav LIVE Page "${page.title}": ${found ? 'FOUND' : 'NOT FOUND'}`);
                            
                            // Also extract live product data
                            const liveProducts = extractLiveProductsStav(html);
                            if (liveProducts.length > 0) {
                                console.log(`💰 Stav LIVE Products found in "${page.title}":`, liveProducts);
                            }
                            
                            if (found) {
                                // Add live product data to page
                                page.liveProducts = liveProducts;
                                results.push(page);
                            }
                        } else {
                            console.log(`🔍 Stav page fetch failed: ${pageUrl} - ${response.status}`);
                        }
                    } catch (error) {
                        console.error('Error searching live page:', error);
                    }
                }
                
                console.log(`🔍 Stav found ${results.length} LIVE pages for "${searchTerm}"`);
                return results;
            } catch (error) {
                console.error('🔍 Stav searchLivePagesStav error:', error);
                return results;
            }
        }
        // Smart Stav - Send everything to N8N
        // 🧠 CONVERSATION CONTEXT MEMORY (global variable)
        if (!window.stavConversationContext) {
            window.stavConversationContext = {
                lastSearchCategory: null,     // Last category user searched for (e.g., "צעצוע")
                lastShownPages: [],          // Last pages we showed
                rejectedCategories: [],      // Categories user said "no" to
                conversationHistory: [],     // Full conversation history
                recommendedPage: null,       // Page we recommended for user to visit
                userLocation: null,          // User's area/location
                shownPagesByCategory: {},    // Track shown pages per category
                socialNeeds: [],             // Track social needs (friends, sports, etc.)
                urgentRequests: [],          // Track urgent/immediate requests
                preferredServices: []        // Track what user prefers
            };
        }

        // 🎯 Smart Category Management Functions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function selectRandomPages(pages, category, maxCount = 3) {
            const context = window.stavConversationContext;
            
            // Initialize category tracking if needed
            if (!context.shownPagesByCategory[category]) {
                context.shownPagesByCategory[category] = [];
            }
            
            // Filter out already shown pages
            const unshownPages = pages.filter(page => 
                !context.shownPagesByCategory[category].includes(page.pageId || page.fileName)
            );
            
            // If we've shown all pages, reset the list
            if (unshownPages.length === 0 && pages.length > 0) {
                context.shownPagesByCategory[category] = [];
                return selectRandomPages(pages, category, maxCount);
            }
            
            // Shuffle and select random pages
            const shuffled = shuffleArray(unshownPages);
            const selected = shuffled.slice(0, maxCount);
            
            // Mark these pages as shown
            selected.forEach(page => {
                context.shownPagesByCategory[category].push(page.pageId || page.fileName);
            });
            
            console.log(`🎯 Selected ${selected.length} random pages for category "${category}"`);
            return selected;
        }

        function categorizePages(pages) {
            const categories = {
                babysitter: [],
                sports: [],
                social: [],
                services: [],
                urgent: [],
                messageInBottle: [],
                regular: []
            };
            
            pages.forEach(page => {
                const content = (page.name + ' ' + page.description + ' ' + page.request || '').toLowerCase();
                
                // Categorize by content
                if (content.includes('בייביסיטר') || content.includes('babysitter')) {
                    categories.babysitter.push(page);
                } else if (content.includes('כדור') || content.includes('ספורט') || content.includes('ריצה') || content.includes('חדר כושר')) {
                    categories.sports.push(page);
                } else if (content.includes('חבר') || content.includes('בילוי') || content.includes('קפה') || content.includes('קולנוע')) {
                    categories.social.push(page);
                } else if (content.includes('דחוף') || content.includes('עכשיו') || content.includes('זמין') || content.includes('נתקע')) {
                    categories.urgent.push(page);
                }
                
                // Separate by page type
                if (page.pageType === 'messageInBottle') {
                    categories.messageInBottle.push(page);
                } else {
                    categories.regular.push(page);
                }
                
                // General services
                categories.services.push(page);
            });
            
            return categories;
        }

        function smartPageSelection(allPages, userMessage, maxTotal = 4) {
            const categories = categorizePages(allPages);
            const context = window.stavConversationContext;
            const message = userMessage.toLowerCase();
            
            let selectedPages = [];
            
            // Detect user needs
            const isUrgent = message.includes('דחוף') || message.includes('עכשיו') || message.includes('נתקע');
            const isSocial = message.includes('בודד') || message.includes('חבר') || message.includes('לבד');
            const isSports = message.includes('כדור') || message.includes('ספורט');
            
            // Priority 1: Urgent requests - prefer messageInBottle
            if (isUrgent) {
                const urgentBottles = categories.messageInBottle.filter(page => 
                    (page.request || '').toLowerCase().includes('זמין') || 
                    (page.request || '').toLowerCase().includes('עכשיו')
                );
                selectedPages.push(...selectRandomPages(urgentBottles, 'urgent_bottles', 2));
                selectedPages.push(...selectRandomPages(categories.urgent, 'urgent_regular', 1));
            }
            
            // Priority 2: Social needs
            if (isSocial) {
                selectedPages.push(...selectRandomPages(categories.social, 'social', 2));
                selectedPages.push(...selectRandomPages(categories.messageInBottle.filter(page => 
                    (page.request || '').toLowerCase().includes('חבר')
                ), 'social_bottles', 2));
            }
            
            // Priority 3: Sports
            if (isSports) {
                selectedPages.push(...selectRandomPages(categories.sports, 'sports', 2));
            }
            
            // Priority 4: Specific services (babysitter, etc.)
            if (message.includes('בייביסיטר')) {
                selectedPages.push(...selectRandomPages(categories.babysitter, 'babysitter', 2));
            }
            
            // If no specific category, mix everything
            if (selectedPages.length === 0) {
                // Mix: 1-2 messageInBottle + 1-2 regular
                selectedPages.push(...selectRandomPages(categories.messageInBottle, 'general_bottles', 2));
                selectedPages.push(...selectRandomPages(categories.regular, 'general_regular', 2));
            }
            
            // Remove duplicates and limit total
            const uniquePages = selectedPages.filter((page, index, self) => 
                index === self.findIndex(p => (p.pageId || p.fileName) === (page.pageId || page.fileName))
            );
            
            return uniquePages.slice(0, maxTotal);
        }

        // 🧹 Clean user message from filler words before sending to n8n
        function cleanUserMessage(message) {
            let cleaned = message;
            
            // 🎯 QUESTION PATTERNS - Extract the entity from questions
            const questionPatterns = [
                { pattern: /מה (הטלפון|המייל|הכתובת|המחיר|המחירים) של (.+)/i, entityIndex: 2 },
                { pattern: /איפה (נמצא|נמצאת|ממוקם|ממוקמת) (.+)/i, entityIndex: 2 },
                { pattern: /(יש לי|יש לך|יש ל)(.*) (טלפון|מייל|כתובת|מחיר|מחירים)/i, entityIndex: 2 },
                { pattern: /איך (אפשר ליצור קשר|ליצור קשר|להתקשר) (ל|עם|אל) (.+)/i, entityIndex: 3 },
            ];
            
            for (const { pattern, entityIndex } of questionPatterns) {
                const match = message.match(pattern);
                if (match && match[entityIndex]) {
                    cleaned = match[entityIndex].trim();
                    console.log(`❓ Question detected: "${message}" → extracted entity: "${cleaned}"`);
                    break;
                }
            }
            
            // If no question pattern matched, use regular filler removal
            if (cleaned === message) {
                const fillerWords = /^(אולי|בערך|כאילו|בקירוב|אני|אנחנו|את|אתה|אתם|הם|היא|הוא|מחפש|מחפשת|מחפשים|רוצה|רוצים|צריך|צריכה|תן|תני|תראה|תראי|תציג|תעזור|עזרו|לי|לנו|משהו|דבר|עניין|איזה|איזו|יש)\s+/gi;
                cleaned = message.replace(fillerWords, '').trim();
            }
            
            // 🎯 SEMANTIC MAPPING - Map related words to searchable terms
            const semanticMap = {
                'מטבחים': 'נגר',
                'מטבח': 'נגר',
                'ארון': 'נגר',
                'ארונות': 'נגר',
                'רהיטים': 'נגר',
                'רהיט': 'נגר',
                'שולחן': 'נגר',
                'כיסא': 'נגר',
                'כיסאות': 'נגר',
                'מיטה': 'נגר',
                'ספה': 'נגר',
                'מאמנת אישית': 'מאמנת',
                'מאמן אישי': 'מאמן',
                'אימון אישי': 'אימון',
                'כושר': 'אימון',
                'ציפורניים': 'לק',
                'מניקור': 'לק',
                'פדיקור': 'לק'
            };
            
            // Check if cleaned message matches any semantic mapping
            for (const [key, value] of Object.entries(semanticMap)) {
                if (cleaned.includes(key)) {
                    console.log(`🎯 Semantic mapping: "${key}" → "${value}"`);
                    cleaned = cleaned.replace(key, value);
                }
            }
            
            if (cleaned !== message) {
                console.log('🧹 Cleaning & Mapping:', message, '→', cleaned);
            }
            return cleaned || message;
        }

        async function sendStavMessage() {
            try {
                const input = document.getElementById('stavChatInput');
                let userMessage = input.value.trim();
                
                console.log('🚀 sendStavMessage called with:', userMessage);
                
                if (!userMessage) return;
                
                // 🧹 CRITICAL: Clean message FIRST, before everything!
                const originalMessage = userMessage;
                userMessage = cleanUserMessage(userMessage);
                console.log('✨ After cleaning:', originalMessage, '→', userMessage);
                
                // Display ORIGINAL user message (not cleaned) so user sees what they typed
                addStavMessage(originalMessage, true);
                input.value = '';
                
                console.log('✅ User message displayed, continuing...');
                
                // 🧠 ADD TO CONTEXT MEMORY
                window.stavConversationContext.conversationHistory.push({
                    role: 'user',
                    message: userMessage,
                    timestamp: new Date()
                });
                
                // Show typing indicator
                addStavMessage('🤖 סתיו מקלידה<span class="typing-dots">...</span>', false);
                
                // Get ALL pages from ALL users (including messageInBottle for Stav)
                console.log('🤖 Fetching ALL pages (including messageInBottle) for Stav');
                
                const pagesResponse = await fetch('/api/pages/all');
                const pagesData = await pagesResponse.json();
                const allPages = pagesData.pages || [];
                
                console.log(`📚 Got ${allPages.length} pages from ALL users (including messageInBottle)`, allPages);
                
                // 🧠 SMART DECISION: Is this a greeting, negation, follow-up question, or product search?
                const greetings = ['היי', 'שלום', 'הי', 'hello', 'מה שלומך', 'בוקר טוב', 'ערב טוב'];
                const conversations = ['אני', 'שמי', 'קוראים לי', 'תודה', 'מעולה', 'נהדר', 'כן', 'אוקיי', 'עצוב', 'שמח', 'רע לי', 'טוב לי', 'כועס', 'עייף'];
                const knowledgeQuestions = ['מה גודל', 'מה זה', 'איך', 'למה', 'מתי', 'איפה', 'מי', 'מה המשמעות', 'ספר לי', 'תסביר', 'מה קורה', 'מי זה', 'מה היה', 'מה יהיה', 'איך עושים', 'מדוע', 'באיזה', 'מהו', 'מהי', 'האם', 'האם יש', 'תגיד לי', 'אתה יודע', 'מכיר', 'מכירה', 'את מכיר', 'את מכירה', 'אתה מכיר'];
                const recommendations = ['המליצי', 'תמליצי', 'מה המלצה', 'מה כדאי', 'איזה מוצר', 'רוצה משהו', 'מחפש משהו', 'מה את ממליצה', 'מה אתה ממליץ', 'את ממליצה', 'אתה ממליץ', 'תמליץ לי', 'מה יש', 'מה יש לכם'];
                const interactiveRequests = ['תקבע', 'קבע', 'תקבעי', 'תציג', 'הצג', 'הציגי', 'תראה', 'תראי', 'רשימה', 'רשימת', 'כל ה', 'הכל', 'תמליץ', 'תמליצי', 'המליצי', 'המלץ', 'המלצה', 'הצע', 'הציעי', 'הצעה', 'מה יש', 'מה יש לך', 'מה את יכולה', 'מה אתה יכול', 'מה אפשר', 'חניות', 'חנויות', 'כל החניות', 'כל החנויות', 'כל הדפים', 'תראה לי את כל', 'הצג את כל', 'תמליצי על', 'תמליץ על', 'המלצה על', 'המליצי על', 'המלץ על', 'מה המוצר', 'איזה מוצר', 'מוצר', 'המוצר'];
                const budgetQueries = ['עד', 'עד ל', 'מתחת ל', 'פחות מ', 'לא יותר מ', 'מקסימום', 'מקס', 'תקציב'];
                
                // 🆕 NEGATION & REJECTION detection
                const negations = ['לא', 'זה לא', 'לא טוב', 'משהו אחר', 'לא רוצה', 'לא מתאים', 'לא בשבילי'];
                const followUpQuestions = ['יש עוד', 'ויש עוד', 'עוד אופציות', 'עוד חניות', 'תראה לי עוד', 'מה עוד', 'עוד משהו', 'תראי לי', 'תראה לי', 'איזה עוד', 'מה עוד יש', 'יש עוד דפים', 'עוד', 'תראי', 'תראה', 'עוד מוצרים', 'יש עוד מוצרים', 'תראי עוד מוצרים'];
                
                const isGreeting = greetings.some(g => userMessage.toLowerCase().includes(g));
                const isConversation = conversations.some(c => userMessage.toLowerCase().includes(c));
                const isKnowledgeQuestion = knowledgeQuestions.some(k => userMessage.toLowerCase().includes(k));
                const isRecommendation = recommendations.some(r => userMessage.toLowerCase().includes(r));
                const isNegation = negations.some(n => userMessage.toLowerCase().includes(n));
                const isFollowUpQuestion = followUpQuestions.some(f => userMessage.toLowerCase().includes(f));
                
                // 🤝 DETECT SOCIAL/LONELINESS REQUESTS
                const socialKeywords = ['בודד', 'לבד', 'אין לי חברים', 'מחפש חברים', 'חברה', 'בילוי', 'שותף', 'קבוצה', 'כדורסל', 'כדורגל', 'ספורט', 'ריצה', 'חדר כושר', 'קולנוע', 'קפה'];
                const isSocialRequest = socialKeywords.some(keyword => userMessage.toLowerCase().includes(keyword));
                const isInteractiveRequest = interactiveRequests.some(i => userMessage.toLowerCase().includes(i));
                const hasBudget = budgetQueries.some(b => userMessage.toLowerCase().includes(b));
                
                // 💰 PRICE COMPARISON DETECTION - זיהוי השוואת מחירים
                const priceQueries = ['הכי זול', 'הכי יקר', 'הזול', 'היקר', 'זול ביותר', 'יקר ביותר', 'מחיר הכי', 'הזול ביותר', 'היקר ביותר', 'המחיר של', 'כמה עולה', 'מחירים', 'מחיר', 'מה המחיר', 'בכמה', 'כמה זה עולה', 'מוצר הכי זול', 'מוצר זול', 'מוצר יקר', 'איזה הכי', 'מה הכי', 'המוצר הזול', 'המוצר היקר', 'המוצר הכי זול', 'המוצר הכי יקר'];
                const isPriceQuery = priceQueries.some(q => userMessage.toLowerCase().includes(q));
                console.log('נ’° Is price query?', isPriceQuery, '| search term:', userMessage);
                
                // ✅ CHECK if user is confirming to visit a recommended page (e.g., "כן", "אוקיי", "בטח")
                const confirmations = ['כן', 'בטח', 'אוקיי', 'אוקי', 'ok', 'yes', 'יאללה', 'בוא', 'תראה', 'תראי', 'הצג', 'הציגי'];
                const isConfirmation = confirmations.some(c => userMessage.toLowerCase().trim() === c || userMessage.toLowerCase().includes(c));
                
                // 🌐 IF USER CONFIRMED and we have a recommended page - OPEN IT!
                if (isConfirmation && window.stavConversationContext.recommendedPage) {
                    console.log('✅ USER CONFIRMED - Opening recommended page:', window.stavConversationContext.recommendedPage);
                    
                    const recommendedPage = window.stavConversationContext.recommendedPage;
                    
                    // Show a confirmation message
                    addStavMessage(`✅ **פותח את "${recommendedPage.title}"...**`, false);
                    
                    // Show the preview with animation
                    const chatMessages = document.getElementById('stavChatMessages');
                    if (chatMessages) {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'stav-message bot';
                        previewDiv.style.cssText = `
                            margin: 16px 0;
                            border: 2px solid #e5e7eb;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            width: 100%;
                            max-width: 100%;
                            height: 500px;
                            opacity: 0;
                            transform: translateY(20px);
                            transition: all 0.5s ease;
                        `;
                        
                        previewDiv.innerHTML = 
                            '<div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">' +
                                '<span>🌐</span>' +
                                '<span>' + recommendedPage.title + '</span>' +
                            '</div>' +
                            '<div style="position: relative; height: 450px; overflow: hidden;">' +
                                '<iframe src="' + recommendedPage.url + '" style="width: 200%; height: 900px; border: none; transform: scale(0.5); transform-origin: top right; position: absolute; top: 0; right: 0; opacity: 0; transition: opacity 0.8s ease;" sandbox="allow-same-origin allow-scripts allow-popups allow-forms" onload="this.style.opacity=\'1\';"></iframe>' +
                            '</div>';
                        
                        chatMessages.appendChild(previewDiv);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        setTimeout(() => {
                            previewDiv.style.opacity = '1';
                            previewDiv.style.transform = 'translateY(0)';
                        }, 100);
                    }
                    
                    // Clear the recommended page from context
                    window.stavConversationContext.recommendedPage = null;
                    
                    return; // STOP HERE
                }
                
                // Check if this looks like a product search (has product keywords)
                const productKeywords = ['צעצוע', 'שעון', 'תכשיט', 'לק', 'טכנולוגיה', 'קורס', 'מוצר', 'קנה', 'למכור', 'מחיר', 'מתנה', 'גבר', 'אישה', 'ילד', 'בעל', 'אשתי', 'נגר', 'נגריה', 'עץ', 'רהיט', 'רהיטים', 'ארון', 'ארונות', 'שולחן', 'כיסא', 'כיסאות', 'מיטה', 'ספה', 'מטבח', 'מטבחים', 'מאמן', 'מאמנת', 'אימון', 'ספורט', 'כושר', 'שירות', 'חנות', 'עסק', 'ממתק', 'שוקולד', 'ציפורניים', 'מניקור', 'פדיקור'];
                const hasProductKeyword = productKeywords.some(k => userMessage.toLowerCase().includes(k));
                
                // 🧠 HANDLE NEGATION (e.g., "לק זה לא מתנה לילד")
                if (isNegation && hasProductKeyword) {
                    console.log('❌ NEGATION detected - user is rejecting a category');
                    
                    // Extract what user is rejecting
                    const rejectedCategories = productKeywords.filter(k => userMessage.toLowerCase().includes(k));
                    console.log('🚫 User rejected:', rejectedCategories);
                    
                    // Add to rejected list
                    window.stavConversationContext.rejectedCategories.push(...rejectedCategories);
                    
                    // Send to N8N to understand context and suggest alternatives
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'negation',
                                context: {
                                    lastSearchCategory: window.stavConversationContext.lastSearchCategory,
                                    rejectedCategories: window.stavConversationContext.rejectedCategories,
                                    conversationHistory: window.stavConversationContext.conversationHistory.slice(-5)  // Last 5 messages
                                },
                                pages: allPages,  // 🎯 שליחת כל הדפים עם כל הפרטים
                                availablePagesCount: allPages.length,
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        removeStavTypingIndicator();
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // 🔍 FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            
                            // 🔍 FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            
                            // 🔍 FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            // 🎯 Extract response field
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : (n8nData.message || 'אוקיי! אז איזה סוג מתנה את מחפשת?');
                            addStavMessage(botResponse, false);
                            
                            // If N8N returned specific pages, display them
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = allPages.find(p => p.title.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage) {
                                        const pageUrl = matchingPage.url;
                                        const previewHtml = `
                                            <div class="page-preview-container" style="margin-top: 15px; text-align: right; direction: rtl;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px 12px 0 0; font-weight: 600;">
                                                    📄 ${matchingPage.title}
                                                </div>
                                                <iframe src="${pageUrl}" style="width: 100%; height: 300px; border: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>
                                            </div>
                                        `;
                                        addStavMessage(previewHtml, false);
                                    }
                                }
                            }
                        } else {
                            addStavMessage('אוקיי! אז איזה סוג מתנה את מחפשת?', false);
                        }
                    } catch (error) {
                        console.error('N8N error:', error);
                        removeStavTypingIndicator();
                        addStavMessage('אוקיי! אז איזה סוג מתנה את מחפשת?', false);
                    }
                    return; // STOP HERE
                }
                
                // 🤝 HANDLE SOCIAL/LONELINESS REQUESTS - Special handling for social needs!
                if (isSocialRequest) {
                    console.log('🤝 SOCIAL REQUEST detected - handling with empathy and smart suggestions');
                    
                    // 🎯 Smart page selection focusing on social and messageInBottle pages
                    const smartSelectedPages = smartPageSelection(allPages, userMessage, 8);
                    console.log(`🤝 Social request - selected ${smartSelectedPages.length} pages from ${allPages.length} total`);
                    
                    // Update context with social needs
                    const context = window.stavConversationContext;
                    context.socialNeeds.push(userMessage);
                    
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'social',
                                pages: smartSelectedPages,
                                allPagesCount: allPages.length,
                                context: {
                                    socialNeeds: context.socialNeeds,
                                    userLocation: context.userLocation,
                                    conversationHistory: context.conversationHistory.slice(-5)
                                },
                                specialInstructions: 'This is a social/loneliness request. Be empathetic and focus on messageInBottle pages for social connections.',
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        removeStavTypingIndicator();
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // Parse n8n response (same logic as other handlers)
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : 'אני מבינה שזה לא קל... מאיפה אתה? אני אחפש לך אנשים נחמדים באזור שלך 💙';
                            addStavMessage(botResponse, false);
                            
                            // Display suggested pages if any
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = smartSelectedPages.find(p => p.title?.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage) {
                                        displayPagePreview(matchingPage);
                                    }
                                }
                            }
                        } else {
                            console.error('N8N social request failed:', n8nResponse.status);
                            addStavMessage('אני מבינה שזה לא קל... בואי נחפש יחד אנשים נחמדים באזור שלך! מאיפה את? 💙', false);
                        }
                    } catch (error) {
                        console.error('Error sending social request to N8N:', error);
                        removeStavTypingIndicator();
                        addStavMessage('אני מבינה שזה לא קל... בואי נחפש יחד אנשים נחמדים באזור שלך! מאיפה את? 💙', false);
                    }
                    return; // STOP HERE
                }
                
                // 🤖 HANDLE INTERACTIVE REQUESTS (e.g., "תקבע לי תור", "תציג רשימה") - Send to N8N!
                // ⚠️ BUT NOT if it's a price query or product recommendation - those should be handled locally!
                if (isInteractiveRequest && !isPriceQuery && !isRecommendation) {
                    console.log('🤖 INTERACTIVE REQUEST detected - sending to N8N');
                    
                    // 🎯 Smart page selection for interactive requests
                    const smartSelectedPages = smartPageSelection(allPages, userMessage, 6);
                    console.log(`🎯 Interactive request - selected ${smartSelectedPages.length} pages from ${allPages.length} total`);
                    
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'interactive',
                                pages: smartSelectedPages,  // 🎯 שליחת בחירה חכמה במקום כל הדפים
                                allPagesCount: allPages.length,  // מספר כל הדפים לקונטקסט
                                availablePagesCount: allPages.length,
                                context: {
                                    lastSearchCategory: window.stavConversationContext.lastSearchCategory,
                                    lastShownPages: window.stavConversationContext.lastShownPages.map(p => p.title),
                                    conversationHistory: window.stavConversationContext.conversationHistory
                                }
                            })
                        });
                        
                        removeStavTypingIndicator(); // ✅ Remove typing indicator BEFORE showing response
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // 🔍 FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            
                            // 🔍 FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            
                            // 🔍 FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            console.log('📥 N8N Response:', n8nData);
                            // 🎯 Extract response field
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : (n8nData.message || 'מצטערת, לא הצלחתי להבין. אפשר לנסח אחרת?');
                            addStavMessage(botResponse, false);
                            
                            // If N8N returned specific pages, display them
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = allPages.find(p => p.title.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage) {
                                        const pageUrl = matchingPage.url;
                                        const previewHtml = `
                                            <div class="page-preview-container" style="margin-top: 15px; text-align: right; direction: rtl;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px 12px 0 0; font-weight: 600;">
                                                    📄 ${matchingPage.title}
                                                </div>
                                                <iframe src="${pageUrl}" style="width: 100%; height: 300px; border: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>
                                            </div>
                                        `;
                                        addStavMessage(previewHtml, false);
                                    }
                                }
                            }
                        } else {
                            console.error('❌ N8N Response not OK:', n8nResponse.status);
                            addStavMessage('מצטערת, יש לי בעיה קטנה. תנסה שוב?', false);
                        }
                    } catch (error) {
                        console.error('❌ N8N error:', error);
                        removeStavTypingIndicator(); // ✅ Remove typing indicator on error too
                        removeStavTypingIndicator();
                        addStavMessage('מצטערת, יש לי בעיה קטנה. תנסה שוב?', false);
                    }
                    return; // STOP HERE
                }
                
                // 💰 HANDLE BUDGET QUERIES (e.g., "מתנה לילד עד 50 שח") - Send to N8N with budget info!
                if (hasBudget) {
                    console.log('💰 BUDGET QUERY detected - sending to N8N');
                    
                    // Extract budget from message (e.g., "עד 50 שח" -> 50)
                    const budgetMatch = userMessage.match(/(\d+)\s*(שח|ש"ח|ש״ח|₪)?/);
                    const budget = budgetMatch ? parseInt(budgetMatch[1]) : null;
                    console.log('💰 Extracted budget:', budget);
                    
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'budget',
                                budget: budget,
                                pages: allPages,  // 🎯 שליחת כל הדפים עם כל הפרטים
                                availablePagesCount: allPages.length,
                                context: {
                                    lastSearchCategory: window.stavConversationContext.lastSearchCategory,
                                    lastShownPages: window.stavConversationContext.lastShownPages.map(p => p.title),
                                    conversationHistory: window.stavConversationContext.conversationHistory
                                }
                            })
                        });
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // 🔍 FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            
                            // 🔍 FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            
                            // 🔍 FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            // 🎯 Extract response field
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : (n8nData.message || 'מחפש מוצרים בתקציב שלך...');
                            addStavMessage(botResponse, false);
                            
                            // If N8N returned specific pages, display them
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = allPages.find(p => p.title.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage) {
                                        const pageUrl = matchingPage.url;
                                        const previewHtml = `
                                            <div class="page-preview-container" style="margin-top: 15px; text-align: right; direction: rtl;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px 12px 0 0; font-weight: 600;">
                                                    📄 ${matchingPage.title}
                                                </div>
                                                <iframe src="${pageUrl}" style="width: 100%; height: 300px; border: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>
                                            </div>
                                        `;
                                        addStavMessage(previewHtml, false);
                                    }
                                }
                            }
                        } else {
                            addStavMessage('מחפש מוצרים בתקציב שלך...', false);
                        }
                    } catch (error) {
                        console.error('N8N error:', error);
                        removeStavTypingIndicator();
                        addStavMessage('מחפש מוצרים בתקציב שלך...', false);
                    }
                    return; // STOP HERE
                }
                
                // 🧠 HANDLE FOLLOW-UP QUESTIONS (e.g., "ויש עוד חניות?")
                if (isFollowUpQuestion) {
                    console.log('💬 FOLLOW-UP QUESTION detected - sending to N8N with context');
                    
                    // Send to N8N with full context
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'followup',
                                context: {
                                    lastSearchCategory: window.stavConversationContext.lastSearchCategory,
                                    lastShownPages: window.stavConversationContext.lastShownPages.map(p => p.title),
                                    conversationHistory: window.stavConversationContext.conversationHistory.slice(-5)
                                },
                                pages: allPages,  // 🎯 שליחת כל הדפים עם כל הפרטים
                                availablePagesCount: allPages.length,
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        removeStavTypingIndicator();
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // 🔍 FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            
                            // 🔍 FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            
                            // 🔍 FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            // 🎯 Extract response field
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : (n8nData.message || 'כן! יש עוד אפשרויות 😊');
                            addStavMessage(botResponse, false);
                            
                            // If N8N returned specific pages, display them
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = allPages.find(p => p.title.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage && !window.stavConversationContext.lastShownPages.includes(matchingPage)) {
                                        const pageUrl = matchingPage.url;
                                        const previewHtml = `
                                            <div class="page-preview-container" style="margin-top: 15px; text-align: right; direction: rtl;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px 12px 0 0; font-weight: 600;">
                                                    📄 ${matchingPage.title}
                                                </div>
                                                <iframe src="${pageUrl}" style="width: 100%; height: 300px; border: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>
                                            </div>
                                        `;
                                        addStavMessage(previewHtml, false);
                                        window.stavConversationContext.lastShownPages.push(matchingPage);
                                    }
                                }
                            }
                        } else {
                            addStavMessage('כן! יש עוד אפשרויות 😊', false);
                        }
                    } catch (error) {
                        console.error('N8N error:', error);
                        removeStavTypingIndicator();
                        addStavMessage('כן! יש עוד אפשרויות 😊', false);
                    }
                    return; // STOP HERE
                }
                
                // If it's a RECOMMENDATION query without specific product - Send to N8N for smart suggestions!
                if (isRecommendation && !hasProductKeyword) {
                    console.log('💡 Recommendation query detected - sending to N8N for smart suggestions');
                    
                    // 🎯 Smart page selection for recommendations
                    const smartSelectedPages = smartPageSelection(allPages, userMessage, 8);
                    console.log(`🎯 Recommendation - selected ${smartSelectedPages.length} pages from ${allPages.length} total`);
                    
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'recommendation',
                                pages: smartSelectedPages,  // 🎯 שליחת בחירה חכמה
                                allPagesCount: allPages.length,  // מספר כל הדפים
                                availablePagesCount: allPages.length,
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        removeStavTypingIndicator();
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // 🔍 FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            
                            // 🔍 FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            
                            // 🔍 FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            // 🎯 Extract response field
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : (n8nData.message || 'אשמח לעזור! מה תחום העניין?');
                            addStavMessage(botResponse, false);
                            
                            // If N8N returned specific pages, display them
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = allPages.find(p => p.title.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage) {
                                        // Display page preview
                                        const pageUrl = matchingPage.url;
                                        const previewHtml = `
                                            <div class="page-preview-container" style="margin-top: 15px; text-align: right; direction: rtl;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px 12px 0 0; font-weight: 600;">
                                                    📄 ${matchingPage.title}
                                                </div>
                                                <iframe src="${pageUrl}" style="width: 100%; height: 300px; border: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>
                                            </div>
                                        `;
                                        addStavMessage(previewHtml, false);
                                    }
                                }
                            }
                        } else {
                            addStavMessage('אשמח לעזור! מה תחום העניין?', false);
                        }
                    } catch (error) {
                        console.error('N8N error:', error);
                        removeStavTypingIndicator();
                        addStavMessage('אשמח לעזור! מה תחום העניין?', false);
                    }
                    return; // STOP HERE
                }
                
                // If it's a greeting OR general conversation OR knowledge question (and NOT a product search!)
                if ((isGreeting || isConversation || isKnowledgeQuestion) && !hasProductKeyword && !isRecommendation) {
                    // GREETING - Send to N8N for friendly response
                    console.log('👋 This is a greeting - sending to N8N');
                    
                    // 🎯 For greetings, send a smaller sample of pages
                    const smartSelectedPages = smartPageSelection(allPages, userMessage, 4);
                    console.log(`🎯 Greeting - selected ${smartSelectedPages.length} pages from ${allPages.length} total`);
                    
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,  // 🎯 userMessage is already cleaned!
                                originalMessage: originalMessage,  // שמירת המקור למקרה הצורך
                                type: 'greeting',
                                pages: smartSelectedPages,  // 🎯 שליחת בחירה חכמה במקום כל הדפים
                                allPagesCount: allPages.length,  // מספר כל הדפים לקונטקסט
                                availablePagesCount: allPages.length,
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        removeStavTypingIndicator();
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            console.log('🔍 Raw n8nData:', n8nData, 'Type:', typeof n8nData);
                            
                            // 🔍 FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                console.log('🔍 n8nData is array, taking first element...');
                                n8nData = n8nData[0];
                                console.log('✅ After taking first element:', n8nData);
                            }
                            
                            // 🔍 FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                console.log('🔍 Found output field, extracting...');
                                n8nData = n8nData.output;
                                console.log('✅ After extracting output:', n8nData);
                            }
                            
                            // 🔍 FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    console.log('🔍 Parsing n8nData as JSON string...');
                                    n8nData = JSON.parse(n8nData);
                                    console.log('✅ Parsed n8nData:', n8nData);
                                } catch (e) {
                                    console.warn('❌ Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            // 🎯 CRITICAL FIX: Always extract response field if it exists
                            console.log('🔍 [GREETING] n8nData type:', typeof n8nData);
                            console.log('🔍 [GREETING] n8nData value:', n8nData);
                            console.log('🔍 [GREETING] n8nData.response:', n8nData?.response);
                            
                            let botResponse;
                            
                            // If n8nData is a string that's JSON, parse it
                            if (typeof n8nData === 'string') {
                                if (n8nData.trim().startsWith('{')) {
                                    try {
                                        console.log('🔍 [GREETING] Parsing string as JSON...');
                                        n8nData = JSON.parse(n8nData);
                                        console.log('🔍 [GREETING] Parsed n8nData:', n8nData);
                                    } catch (e) {
                                        console.warn('❌ [GREETING] Failed to parse:', e);
                                    }
                                }
                            }
                            
                            // Now extract response
                            if (typeof n8nData === 'object' && n8nData !== null && n8nData.response) {
                                botResponse = n8nData.response;
                                console.log('✅ [GREETING] Extracted response:', botResponse);
                            } else if (typeof n8nData === 'string') {
                                botResponse = n8nData;
                                console.log('✅ [GREETING] Using string as-is:', botResponse);
                            } else {
                                botResponse = n8nData?.message || 'שלום! איך אני יכולה לעזור לך? 😊';
                                console.log('✅ [GREETING] Using fallback:', botResponse);
                            }
                            
                            console.log('🤖 [GREETING] Final botResponse to display:', botResponse);
                            console.log('🤖 [GREETING] botResponse type:', typeof botResponse);
                            addStavMessage(botResponse, false);
                            stavFirstReplySent = true;
                        } else {
                            addStavMessage(stavLocalFallbackReply(originalMessage || userMessage), false);
                            stavFirstReplySent = true;
                        }
                    } catch (error) {
                        console.error('N8N error:', error);
                        removeStavTypingIndicator();
                        addStavMessage(stavLocalFallbackReply(originalMessage || userMessage), false);
                        stavFirstReplySent = true;
                    }
                    return; // STOP HERE - Don't search for pages
                }
                
                // NOT A GREETING - SMART SEARCH with recommendations!
                console.log('🔍 SMART SEARCH for:', userMessage);
                
                // 🧠 CHECK IF USER IS ASKING ABOUT THE LAST PAGE (e.g., "מה המחירים שם")
                const contextReferences = ['שם', 'שמה', 'בדף הזה', 'באותו', 'שהראית', 'שהצגת', 'בו', 'בה', 'כאן', 'פה', 'בזה', 'בחנות הזו', 'באותה חנות'];
                const isContextReference = contextReferences.some(ref => userMessage.toLowerCase().includes(ref));
                
                if (isContextReference && window.stavConversationContext.lastShownPages.length > 0) {
                    console.log('🧠 CONTEXT REFERENCE detected - User is asking about:', window.stavConversationContext.lastShownPages[0].title);
                    console.log('🧠 Last search category was:', window.stavConversationContext.lastSearchCategory);
                    
                    // Use the last shown page's category as the search term!
                    const lastPage = window.stavConversationContext.lastShownPages[0];
                    const searchTerm = window.stavConversationContext.lastSearchCategory || lastPage.title.toLowerCase();
                    
                    console.log(`🧠 Using context: "${userMessage}" → Searching for "${searchTerm}"`);
                    
                    // Continue with the search using the context-based search term
                    // (The rest of the code will use this searchTerm)
                }
                
                // 🧠 If context reference, use the last search category instead!
                let searchTerm;
                if (isContextReference && window.stavConversationContext.lastSearchCategory) {
                    searchTerm = window.stavConversationContext.lastSearchCategory;
                    console.log(`🧠 Using last search category: "${searchTerm}"`);
                } else {
                    searchTerm = userMessage.toLowerCase(); // userMessage is already cleaned by cleanUserMessage()
                    console.log(`🔍 Using search term: "${searchTerm}"`);
                }
                
                let relevantPages = []; // Changed from const to let for filtering
                
                // 💰 PRICE COMPARISON DETECTION - זיהוי השוואת מחירים (using isPriceQuery from line 4262)
                console.log('💰 Is price query?', isPriceQuery, '| search term:', searchTerm);
                
                // 💰 IF THIS IS A PRICE QUERY - We'll still do search first to find relevant pages!
                if (isPriceQuery) {
                    console.log('💰 PRICE QUERY DETECTED - Will search for relevant pages FIRST, then compare prices');
                    // We'll do price comparison AFTER we find relevant pages based on the category
                }
                
                // 🎯 SMART KEYWORD MAPPING - מילות מפתח לקטגוריות
                // ⚠️ ORDER MATTERS! More specific queries FIRST (e.g., "מתנה לילד" before "מתנה")
                // ⚠️ DON'T include price words like "זול", "יקר" - they are price queries, not categories!
                const smartKeywords = {
                    'מתנה לילד': ['צעצוע', 'משחק'],        // ⭐ Must be BEFORE "מתנה"
                    'מתנה לילדים': ['צעצוע', 'משחק'],      // ⭐ Must be BEFORE "מתנה"
                    'מתנה לבן': ['צעצוע', 'משחק'],         // ⭐ Must be BEFORE "מתנה"
                    'מתנה לבת': ['צעצוע', 'משחק', 'לק'],  // ⭐ Must be BEFORE "מתנה"
                    'מתנה': ['שעון', 'תכשיט', 'צעצוע', 'לק', 'טכנולוגיה'], // General "gift"
                    'מתנות': ['שעון', 'תכשיט', 'צעצוע', 'לק', 'טכנולוגיה'],
                    'אישה': ['לק', 'תכשיט', 'שעון'],
                    'נשים': ['לק', 'תכשיט', 'שעון'],
                    'גבר': ['שעון', 'טכנולוגיה', 'אביזר'],
                    'גברים': ['שעון', 'טכנולוגיה', 'אביזר'],
                    'ילד': ['צעצוע', 'משחק', 'לימוד'],        // ⭐ ילד → צעצוע
                    'ילדים': ['צעצוע', 'משחק', 'לימוד'],      // ⭐ ילדים → צעצוע
                    'ילדה': ['צעצוע', 'משחק', 'לימוד', 'לק'], // ⭐ ילדה → צעצוע
                    'ילדות': ['צעצוע', 'משחק', 'לימוד', 'לק'], // ⭐ ילדות → צעצוע
                    'לילד': ['צעצוע', 'משחק'],                 // ⭐ לילד → צעצוע
                    'לילדים': ['צעצוע', 'משחק'],              // ⭐ לילדים → צעצוע
                    'מוצר לילד': ['צעצוע', 'משחק'],
                    'מוצר לילדים': ['צעצוע', 'משחק'],
                    'משחק': ['צעצוע'],
                    'משחקים': ['צעצוע'],
                    'צעצועים': ['צעצוע'], // צעצועים → צעצוע
                    'צעצועי': ['צעצוע'], // צעצועי → צעצוע
                    'שירות': ['שרות', 'קורס', 'לק'], // שירותים מקצועיים
                    'שרות': ['שירות', 'קורס', 'לק'], // שרותים → שירות
                    'שירותים': ['שירות', 'שרות', 'קורס', 'לק'],
                    'שרותים': ['שירות', 'שרות', 'קורס', 'לק'],
                    'ספר': ['מספרה', 'תספורת', 'עיצוב שיער'], // מחפש ספר → מספרה
                    'תספורת': ['מספרה', 'תספורת', 'עיצוב שיער'],
                    'מספרה': ['מספרה', 'תספורת', 'עיצוב שיער'],
                    'מעצב שיער': ['מספרה', 'תספורת', 'עיצוב שיער'],
                    'עיצוב שיער': ['מספרה', 'תספורת', 'מעצב שיער'],
                    // 🪚 נגרות ומטבח
                    'נגר': ['נגר', 'נגרות', 'עץ', 'ארון'],
                    'נגרות': ['נגר', 'נגרות', 'עץ', 'ארון'],
                    'ארון': ['נגר', 'נגרות', 'ארון', 'מטבח'],
                    'ארון מטבח': ['נגר', 'נגרות', 'מטבח', 'ארון'],
                    'מטבח': ['נגר', 'נגרות', 'מטבח', 'ארון'],
                    'ארונות': ['נגר', 'נגרות', 'ארון', 'מטבח'],
                    // 🚰 אינסטלטור וצנרת
                    'אינסטלטור': ['אינסטלטור', 'צנרת', 'צינור', 'אינסטלציה'],
                    'איסטלטור': ['אינסטלטור', 'צנרת', 'צינור'], // תיקון שגיאת כתיב
                    'אנסטלטור': ['אינסטלטור', 'צנרת', 'צינור'], // תיקון שגיאת כתיב
                    'צנרת': ['אינסטלטור', 'צנרת', 'צינור'],
                    'צינור': ['אינסטלטור', 'צנרת', 'צינור'],
                    'פיצוץ': ['אינסטלטור', 'צנרת', 'צינור'], // פיצוץ בצינור
                    'נזילה': ['אינסטלטור', 'צנרת', 'צינור'],
                    'בעיה בצינור': ['אינסטלטור', 'צנרת', 'צינור'],
                    'נזילת מים': ['אינסטלטור', 'צנרת', 'צינור'],
                    // ⚡ חשמלאי
                    'חשמלאי': ['חשמלאי', 'חשמל', 'תאורה'],
                    'חשמל': ['חשמלאי', 'חשמל', 'תאורה'],
                    'קצר': ['חשמלאי', 'חשמל'], // קצר חשמלי
                    'בעיה בחשמל': ['חשמלאי', 'חשמל'],
                    'תאורה': ['חשמלאי', 'חשמל', 'תאורה'],
                    // 🎁 מתנות מורחבות
                    'מתנה לאישה': ['לק', 'תכשיט', 'שעון'],
                    'מתנה לגבר': ['שעון', 'טכנולוגיה'],
                    'מתנה ליום הולדת': ['שעון', 'תכשיט', 'צעצוע', 'לק'],
                    'מתנה לחג': ['שעון', 'תכשיט', 'צעצוע', 'לק']
                };
                
                // Check if this is a SMART query (like "מתנה")
                // ⚠️ IMPORTANT: Use FIRST match only (most specific wins!)
                let isSmartQuery = false;
                let smartCategories = [];
                
                for (const [keyword, categories] of Object.entries(smartKeywords)) {
                    if (searchTerm.includes(keyword)) {
                        isSmartQuery = true;
                        smartCategories = [...categories]; // Replace, don't append!
                        console.log(`🎯 Smart query detected: "${keyword}" → Looking for:`, categories);
                        break; // ⭐ STOP after first match! (most specific)
                    }
                }
                
                // Smart search with variations (MORE VARIATIONS!)
                let searchVariations = [
                    searchTerm,
                    searchTerm.replace(/ים$/, ''), // Remove plural: צעצועים → צעצוע
                    searchTerm.replace(/ות$/, ''), // Remove feminine plural
                    searchTerm.replace(/י$/, ''), // Remove possessive: צעצועי → צעצוע
                    searchTerm.replace(/ה$/, ''), // Remove definite article: צעצועה → צעצוע
                    searchTerm + 'ים', // Add plural: צעצוע → צעצועים
                    searchTerm + 'ות', // Add feminine plural
                    searchTerm + 'י', // Add possessive: צעצוע → צעצועי
                    searchTerm + 'ה', // Add definite article
                ];
                
                // Remove duplicates
                searchVariations = [...new Set(searchVariations)];
                
                // If smart query, ADD the smart categories to search
                if (isSmartQuery) {
                    searchVariations = [...searchVariations, ...smartCategories];
                    console.log('🎯 Smart query detected - Extended search terms:', searchVariations);
                }
                
                console.log('🔍 All search variations:', searchVariations);
                
                // Search through all real pages (INCLUDING product content!)
                // Even for PRICE queries, we need to find relevant pages first!
                for (const page of allPages) {
                    let matchScore = 0;
                    let matchReasons = [];
                    
                    // Try to fetch LIVE HTML content to search products
                    try {
                        const pageResponse = await fetch(page.url);
                        if (pageResponse.ok) {
                            const html = await pageResponse.text();
                            const liveProducts = extractLiveProductsStav(html);
                            
                            console.log(`📦 "${page.title}" has ${liveProducts.length} products:`, liveProducts.map(p => p.name));
                            
                            // Search in PRODUCTS (most important!)
                            for (const variation of searchVariations) {
                                for (const product of liveProducts) {
                                    if (product.name.toLowerCase().includes(variation)) {
                                        matchScore += 15; // Products get HIGHEST score!
                                        matchReasons.push(`product "${product.name}" contains "${variation}"`);
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.log(`⚠️ Could not fetch products for "${page.title}"`);
                    }
                    
                    // Also search in title, description, and pageType
                    for (const variation of searchVariations) {
                        const titleMatch = page.title.toLowerCase().includes(variation);
                        const descMatch = page.description && page.description.toLowerCase().includes(variation);
                        const pageTypeMatch = page.pageType && page.pageType.toLowerCase().includes(variation);
                        
                        if (titleMatch) {
                            matchScore += 10;
                            matchReasons.push(`title contains "${variation}"`);
                        }
                        if (descMatch) {
                            matchScore += 5;
                            matchReasons.push(`description contains "${variation}"`);
                        }
                        if (pageTypeMatch) {
                            matchScore += 8;
                            matchReasons.push(`pageType contains "${variation}"`);
                        }
                    }
                    
                    if (matchScore > 0) {
                        page.matchScore = matchScore;
                        page.matchReasons = matchReasons;
                        relevantPages.push(page);
                        console.log(`   ✅ "${page.title}": score=${matchScore}, reasons:`, matchReasons);
                    } else {
                        console.log(`   ❌ "${page.title}": no match`);
                    }
                }
                
                // 💰 IF PRICE QUERY with NO category - Use ALL pages
                if (isPriceQuery && relevantPages.length === 0) {
                    console.log('💰 Price query with no specific category - using ALL pages');
                    relevantPages = allPages;
                }
                
                // 🎯 SMART FILTERING - סינון לפי הקשר
                // אם שאלו על "ילד/ילדים", סנן שעונים, תכשיטים, ולק (לא מתאים לילדים!)
                if (searchTerm.includes('ילד') || searchTerm.includes('מוצר לילד') || searchTerm.includes('מתנה לילד')) {
                    console.log('🎯 Smart filter: Removing watches/jewelry/nail polish for kids');
                    relevantPages = relevantPages.filter(page => {
                        const title = page.title.toLowerCase();
                        const isWatch = title.includes('שעון');
                        const isJewelry = title.includes('תכשיט') || title.includes('יהלום');
                        const isNailPolish = title.includes('לק');
                        
                        if (isWatch || isJewelry || isNailPolish) {
                            console.log(`   🚫 Filtered out "${page.title}" - not suitable for kids`);
                            return false;
                        }
                        return true;
                    });
                }
                
                // Sort by match score (highest first)
                relevantPages.sort((a, b) => b.matchScore - a.matchScore);
                
                // Remove typing indicator NOW
                removeStavTypingIndicator();
                
                console.log(`✅ סתיו מצאה ${relevantPages.length} דפים אמיתיים (אחרי סינון)`);
                
                // 💰 PRICE COMPARISON LOGIC - השוואת מחירים
                if (isPriceQuery && relevantPages.length > 0) {
                    console.log('💰 Running PRICE COMPARISON...');
                    console.log('💰 Relevant pages for price comparison:', relevantPages.map(p => p.title));
                    
                    // 🧠 UPDATE CONTEXT MEMORY
                    window.stavConversationContext.lastSearchCategory = searchTerm;
                    window.stavConversationContext.lastShownPages = relevantPages.slice(0, 5);  // Save top 5 pages
                    console.log('🧠 Context updated (price comparison):', window.stavConversationContext);
                    
                    // Collect ALL products from ALL pages
                    let allProducts = [];
                    for (const page of relevantPages) {
                        try {
                            console.log(`💰 Fetching products from: ${page.title} (${page.url})`);
                            const pageResponse = await fetch(page.url);
                            if (pageResponse.ok) {
                                const html = await pageResponse.text();
                                console.log(`💰 Fetched HTML (length: ${html.length}), now extracting products...`);
                                const liveProducts = extractLiveProductsStav(html);
                                console.log(`💰 Extracted ${liveProducts.length} products from ${page.title}:`, liveProducts);
                                
                                // Add page info to each product
                                liveProducts.forEach(product => {
                                    product.pageName = page.title;
                                    product.pageUrl = page.url;
                                });
                                
                                allProducts = [...allProducts, ...liveProducts];
                            }
                        } catch (error) {
                            console.error(`Error fetching ${page.title}:`, error);
                        }
                    }
                    
                    // 🧠 SMART CATEGORY EXTRACTION - Extract category from user's question
                    const categoryKeywords = ['צעצוע', 'צעצועים', 'תכשיט', 'תכשיטים', 'שעון', 'שעונים', 'טכנולוגיה', 'קורס', 'קורסים', 'לק', 'מתנה', 'מתנות', 'שירות', 'שרות', 'שרותים', 'שירותים'];
                    let categoryFilter = null;
                    for (const keyword of categoryKeywords) {
                        if (searchTerm.includes(keyword)) {
                            categoryFilter = keyword.replace('ים', '').replace('ות', ''); // Remove plural endings
                            console.log(`🎯 Category filter detected: "${categoryFilter}" from search term "${searchTerm}"`);
                            break;
                        }
                    }
                    
                    // Filter products with valid prices
                    let productsWithPrices = allProducts.filter(p => p.price && !isNaN(parseFloat(p.price)));
                    console.log(`💰 Total products with prices (before category filter): ${productsWithPrices.length}`, productsWithPrices.map(p => p.name));
                    
                    // 🎯 FILTER BY CATEGORY if detected - STRICT FILTERING!
                    if (categoryFilter) {
                        const originalCount = productsWithPrices.length;
                        
                        // 🚫 EXCLUSION LIST - Categories to EXCLUDE
                        const exclusions = {
                            'צעצוע': ['תכשיט', 'לק', 'שעון', 'טכנולוגי', 'קורס', 'שירות', 'שרות'],
                            'תכשיט': ['צעצוע', 'לק', 'קורס', 'טכנולוגי', 'שירות', 'שרות'],
                            'שעון': ['צעצוע', 'תכשיט', 'לק', 'קורס', 'שירות', 'שרות'],
                            'טכנולוגיה': ['צעצוע', 'תכשיט', 'לק', 'שעון', 'קורס', 'שירות', 'שרות'],
                            'קורס': ['צעצוע', 'תכשיט', 'לק', 'שעון', 'טכנולוגי', 'שירות', 'שרות'],
                            'לק': ['צעצוע', 'תכשיט', 'שעון', 'טכנולוגי', 'קורס', 'שירות', 'שרות'],
                            'שירות': ['צעצוע', 'תכשיט', 'שעון', 'טכנולוגי', 'קורס', 'לק'],
                            'שרות': ['צעצוע', 'תכשיט', 'שעון', 'טכנולוגי', 'קורס', 'לק']
                        };
                        
                        productsWithPrices = productsWithPrices.filter(product => {
                            const productName = product.name.toLowerCase();
                            const pageName = product.pageName.toLowerCase();
                            const fullText = `${productName} ${pageName}`;
                            
                            // ✅ Must INCLUDE the category
                            const includesCategory = fullText.includes(categoryFilter.toLowerCase());
                            
                            // 🚫 Must NOT include excluded categories
                            let hasExclusion = false;
                            if (exclusions[categoryFilter]) {
                                for (const excludeWord of exclusions[categoryFilter]) {
                                    if (fullText.includes(excludeWord.toLowerCase())) {
                                        hasExclusion = true;
                                        console.log(`❌ Product "${product.name}" from "${product.pageName}" EXCLUDED (found "${excludeWord}")`);
                                        break;
                                    }
                                }
                            }
                            
                            const matches = includesCategory && !hasExclusion;
                            if (matches) {
                                console.log(`✅ Product "${product.name}" from "${product.pageName}" MATCHES category "${categoryFilter}"`);
                            }
                            return matches;
                        });
                        console.log(`🎯 After STRICT category filter "${categoryFilter}": ${productsWithPrices.length} products (was ${originalCount})`);
                    }
                    
                    if (productsWithPrices.length > 0) {
                        // Sort by price
                        productsWithPrices.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                        
                        const cheapest = productsWithPrices[0];
                        const mostExpensive = productsWithPrices[productsWithPrices.length - 1];
                        console.log(`💰 Price range: ${cheapest.price} (cheapest: ${cheapest.name}) to ${mostExpensive.price} (most expensive: ${mostExpensive.name})`);
                        
                        // Determine what user wants
                        const wantsCheapest = searchTerm.includes('זול') || searchTerm.includes('הזול');
                        const wantsExpensive = searchTerm.includes('יקר') || searchTerm.includes('היקר');
                        
                        // 🤖 CONVERSATIONAL RESPONSE - Talk like a friend!
                        let priceMessage = '';
                        
                        if (wantsCheapest) {
                            priceMessage += `🤖 **יש לי "${cheapest.name}" במחיר ₪${cheapest.price}** - זה המוצר הכי זול במרקט!\n\n`;
                            priceMessage += `📍 הוא נמצא ב**${cheapest.pageName.replace(/_\d{13}(_html)?$/, '').replace(/_/g, ' ')}**\n\n`;
                            priceMessage += `💡 **רוצה שאחפש לך עוד משהו?** או רוצה לראות את הדף?`;
                        } else if (wantsExpensive) {
                            priceMessage += `🤖 **יש לי "${mostExpensive.name}" במחיר ₪${mostExpensive.price}** - זה המוצר הכי יקר במרקט!\n\n`;
                            priceMessage += `📍 הוא נמצא ב**${mostExpensive.pageName.replace(/_\d{13}(_html)?$/, '').replace(/_/g, ' ')}**\n\n`;
                            priceMessage += `💡 **רוצה שאחפש לך עוד משהו?** או רוצה לראות את הדף?`;
                        } else {
                            priceMessage += `🤖 **מצאתי ${productsWithPrices.length} מוצרים ב-${relevantPages.length} חנויות!**\n\n`;
                            priceMessage += `🥇 **הכי זול:** ${cheapest.name} - ₪${cheapest.price}\n`;
                            priceMessage += `💎 **הכי יקר:** ${mostExpensive.name} - ₪${mostExpensive.price}\n\n`;
                            priceMessage += `💡 **רוצה לראות את המוצרים? או שאחפש לך משהו אחר?**`;
                        }
                        
                        addStavMessage(priceMessage, false);
                        
                        // 💾 SAVE the recommended page in context so we can open it if user says "yes"
                        // ⚠️ IMPORTANT: Save the page of the ACTUAL product we recommended (cheapest or most expensive)
                        const recommendedProduct = wantsCheapest ? cheapest : (wantsExpensive ? mostExpensive : cheapest);
                        window.stavConversationContext.recommendedPage = {
                            title: recommendedProduct.pageName,
                            url: recommendedProduct.pageUrl,
                            pageId: null // We don't have pageId in the product object
                        };
                        console.log('💾 Saved recommended page for product:', recommendedProduct.name, 'at', window.stavConversationContext.recommendedPage);
                        
                        return; // STOP HERE - We showed price comparison
                    }
                }
                
                // Show REAL pages with FULL DATA
                if (relevantPages.length > 0) {
                    console.log('📱 מציגה דפים אמיתיים עם נתונים מלאים');
                    
                    // 🎁 SMART MESSAGE for recommendations
                    let smartMessage = '';
                    if (isSmartQuery && searchTerm.includes('מתנה')) {
                        smartMessage = `\n\n💡 **מצאתי כמה אופציות מעולות למתנה!**\n\n`;
                        smartMessage += `🎁 **רוצה לצמצם את החיפוש?**\n`;
                        smartMessage += `• מתנה לגבר או לאישה?\n`;
                        smartMessage += `• באיזה תקציב? (זול / בינוני / יקר)\n`;
                        smartMessage += `• איזה סוג מתנה? (אופנה / טכנולוגיה / יופי)\n\n`;
                    }
                    
                    // 🎯 Show ALL relevant pages (or top 3 if more than 3)
                    const pagesToShow = relevantPages.slice(0, 3); // Show up to 3 pages
                    
                    // 🧠 UPDATE CONTEXT MEMORY
                    window.stavConversationContext.lastSearchCategory = searchTerm;
                    window.stavConversationContext.lastShownPages = pagesToShow;
                    console.log('🧠 Context updated:', window.stavConversationContext);
                    
                    const pageCountMessage = pagesToShow.length === 1 
                        ? `🎯 **מצאתי את הדף המושלם בשבילך!**\n` 
                        : `🎯 **מצאתי ${pagesToShow.length} דפים מתאימים!**\n`;
                    addStavMessage(smartMessage + pageCountMessage, false);
                    
                    // 🎯 Fetch LIVE page content for ALL pages to show
                    for (let i = 0; i < pagesToShow.length; i++) {
                        const currentPage = pagesToShow[i];
                        try {
                            const pageResponse = await fetch(currentPage.url);
                            if (pageResponse.ok) {
                                const html = await pageResponse.text();
                                const liveProducts = extractLiveProductsStav(html);
                                
                                console.log(`💰 Live products from ${currentPage.title}:`, liveProducts);
                                
                                // Build rich message with live data
                                let richMessage = `\n\n🏪 **${currentPage.title}**\n`;
                                if (currentPage.description) {
                                    richMessage += `${currentPage.description}\n`;
                                }
                                
                                // Add live products
                                if (liveProducts.length > 0) {
                                    richMessage += `\n💎 **מוצרים זמינים:**\n`;
                                    liveProducts.slice(0, 5).forEach(product => {
                                        richMessage += `• ${product.name}`;
                                        if (product.price) {
                                            richMessage += ` - ₪${product.price}`;
                                        }
                                        richMessage += `\n`;
                                    });
                                    if (liveProducts.length > 5) {
                                        richMessage += `ועוד ${liveProducts.length - 5} מוצרים...\n`;
                                    }
                                }
                                
                                richMessage += `\n🔗 [צפה בדף המלא](${currentPage.url})\n`;
                                
                                // 🎬 Delayed display for smooth animation
                                await new Promise(resolve => setTimeout(resolve, 800 * i)); // Wait before showing next card (slower)
                                
                                addStavMessage(richMessage, false);
                                
                                // Add animated preview for ALL pages (up to 3)
                                if (i < 3) {  // Show preview for up to 3 pages
                                    const chatMessages = document.getElementById('stavChatMessages');
                                    if (chatMessages) {
                                        const previewDiv = document.createElement('div');
                                        previewDiv.className = 'stav-message bot';
                                        previewDiv.style.cssText = `
                                            margin: 16px 0;
                                            border: 2px solid #e5e7eb;
                                            border-radius: 12px;
                                            overflow: hidden;
                                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                            width: 100%;
                                            max-width: 100%;
                                            height: 350px;
                                            opacity: 0;
                                            transform: translateY(40px) scale(0.9);
                                            transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
                                        `;
                                        
                                        const pageUrl = currentPage.url;
                                        const pageTitle = currentPage.title;
                                        previewDiv.innerHTML = 
                                            '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">' +
                                                '<span>🎁</span>' +
                                                '<span>' + pageTitle + '</span>' +
                                            '</div>' +
                                            '<div style="position: relative; height: 300px; overflow: hidden; background: #f9fafb;">' +
                                                '<div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);"></div>' +
                                                '<iframe src="' + pageUrl + '" style="width: 100%; height: 100%; border: none; transform: scale(0.7); transform-origin: top center; opacity: 0; transition: opacity 0.8s ease;" sandbox="allow-same-origin allow-scripts allow-popups allow-forms" onload="this.style.opacity=1"></iframe>' +
                                            '</div>';
                                        
                                        chatMessages.appendChild(previewDiv);
                                        
                                        // 🌊 Smooth scroll with animation
                                        chatMessages.scrollTo({
                                            top: chatMessages.scrollHeight,
                                            behavior: 'smooth'
                                        });
                                        
                                        // 🎬 Animate in with bounce effect (slower, more elegant)
                                        setTimeout(() => {
                                            previewDiv.style.opacity = '1';
                                            previewDiv.style.transform = 'translateY(0) scale(1)';
                                        }, 300); // Slower, more elegant
                                    }
                                }
                            }
                        } catch (error) {
                            console.error(`Error fetching live page data for ${currentPage.title}:`, error);
                            // Fallback to basic display
                            let fallbackMessage = `\n\n🏪 **${currentPage.title}**\n`;
                            if (currentPage.description) {
                                fallbackMessage += `${currentPage.description}\n`;
                            }
                            fallbackMessage += `\n🔗 [צפה בדף](${currentPage.url})\n`;
                            addStavMessage(fallbackMessage, false);
                        }
                    }
                } else {
                    // NO PAGES FOUND - Tell user clearly
                    console.log('❌ לא נמצאו דפים רלוונטיים');
                    console.log('📚 כל הדפים:', allPages.map(p => p.title));
                    
                    const availablePagesList = allPages.length > 0 
                        ? `\n\nהדפים הזמינים כרגע:\n${allPages.slice(0, 5).map(p => `• ${p.title}`).join('\n')}\n${allPages.length > 5 ? `\nועוד ${allPages.length - 5} דפים...\n` : ''}`
                        : '\n\n⚠️ אין דפים זמינים במערכת כרגע.';
                    
                    addStavMessage(`\n\n🔍 **לא מצאתי דפים עם "${userMessage}" במערכת.**${availablePagesList}\n\nאולי תרצה לחפש משהו אחר? 😊`, false);
                }
                
            } catch (error) {
                console.error('❌ Error in Stav chat:', error);
                removeStavTypingIndicator();
                addStavMessage('סליחה, קרתה שגיאה. נסה שוב! 😊', false);
            }
        }
        
        // Extract live products from HTML - SMART PRODUCT DETECTION
        function extractLiveProductsStav(html) {
            const products = [];
            
            console.log('🔍 Stav extractLiveProductsStav called, HTML length:', html.length);
            console.log('📄 First 500 chars of HTML:', html.substring(0, 500));
            
            // ⛔ SMART EXCLUSIONS - דברים שהם לא מוצרים!
            const excludePatterns = [
                'נגישות', 'אודות', 'צור קשר', 'דף הבית', 'עלינו', 'תקנון', 'מדיניות', 
                'פרטיות', 'תנאים', 'שירות', 'משלוחים', 'החזרות', 'איך להזמין',
                'גלרי', 'המוצרים', 'תיאור', 'המיוחדים', 'הכל על', 'כל הזכויות',
                'זכויות יוצרים', 'ברוכים הבאים', 'לקוחות', 'שאלות', 'תשובות'
            ];
            
            // 🎯 ONLY look for products inside product galleries!
            // Pattern 1: Look for product-grid or product-gallery sections
            const galleryMatch = html.match(/<div[^>]*class="[^"]*(?:product-grid|gallery|store-items)[^"]*"[^>]*>([\s\S]*?)<\/div>/gi);
            
            if (galleryMatch && galleryMatch.length > 0) {
                console.log('✅ Found product gallery sections:', galleryMatch.length);
                
                galleryMatch.forEach(gallery => {
                    // Inside gallery, look for product items
                    // ⚡ NEW: Support both "product-item" AND "product-card"!
                    const itemPattern = /<div[^>]*class="[^"]*(?:product-item|product-card|gallery-item|store-item)[^"]*"[^>]*>([\s\S]*?)<\/div>/gi;
                    let itemMatch;
                    
                    while ((itemMatch = itemPattern.exec(gallery)) !== null) {
                        const itemHtml = itemMatch[1];
                        
                        // Extract product name (h3 or h4 inside item)
                        // ⚡ NEW: Also look for class="product-name"!
                        let nameMatch = itemHtml.match(/<h[34][^>]*class="[^"]*product-name[^"]*"[^>]*>([^<]+)<\/h[34]>/i);
                        if (!nameMatch) {
                            nameMatch = itemHtml.match(/<h[34][^>]*>([^<]+)<\/h[34]>/i);
                        }
                        
                        // Extract price
                        // ⚡ NEW: Also look for class="product-price"!
                        let priceMatch = itemHtml.match(/<[^>]*class="[^"]*product-price[^"]*"[^>]*>.*?₪(\d+(?:[.,]\d+)?)/i);
                        if (!priceMatch) {
                            priceMatch = itemHtml.match(/₪(\d+(?:[.,]\d+)?)|(\d+(?:[.,]\d+)?)\s*₪/);
                        }
                        
                        if (nameMatch && priceMatch) {
                            const name = nameMatch[1].trim();
                            const price = parseFloat((priceMatch[1] || priceMatch[2]).replace(',', '.'));
                            
                            // Check if NOT excluded
                            const isExcluded = excludePatterns.some(pattern => 
                                name.toLowerCase().includes(pattern.toLowerCase())
                            );
                            
                            if (!isExcluded && name.length > 2 && name.length < 100 && price > 0) {
                                products.push({ name, price });
                                console.log(`   📦 Found product: "${name}" - ₪${price}`);
                            }
                        }
                    }
                });
            } else {
                console.log('⚠️ No product gallery found, trying fallback patterns...');
                
                // FALLBACK: If no gallery structure, look for items with both name AND price nearby
                // ⚡ NEW: Also look for "product-card"!
                const fallbackPattern = /<div[^>]*class="[^"]*(?:item|product-card|product-item)[^"]*"[^>]*>([\s\S]*?)<\/div>/gi;
                let fallbackMatch;
                
                while ((fallbackMatch = fallbackPattern.exec(html)) !== null) {
                    const itemHtml = fallbackMatch[1];
                    
                    // ⚡ NEW: Look for product-name class first!
                    let nameMatch = itemHtml.match(/<h[3-6][^>]*class="[^"]*product-name[^"]*"[^>]*>([^<]+)<\/h[3-6]>/i);
                    if (!nameMatch) {
                        nameMatch = itemHtml.match(/<h[3-6][^>]*>([^<]+)<\/h[3-6]>/i);
                    }
                    
                    // ⚡ NEW: Look for product-price class first!
                    let priceMatch = itemHtml.match(/<[^>]*class="[^"]*product-price[^"]*"[^>]*>.*?₪(\d+(?:[.,]\d+)?)/i);
                    if (!priceMatch) {
                        priceMatch = itemHtml.match(/₪(\d+(?:[.,]\d+)?)|(\d+(?:[.,]\d+)?)\s*₪/);
                    }
                    
                    if (nameMatch && priceMatch) {
                        const name = nameMatch[1].trim();
                        const price = parseFloat((priceMatch[1] || priceMatch[2]).replace(',', '.'));
                        
                        const isExcluded = excludePatterns.some(pattern => 
                            name.toLowerCase().includes(pattern.toLowerCase())
                        );
                        
                        if (!isExcluded && name.length > 2 && name.length < 100 && price > 0) {
                            products.push({ name, price });
                            console.log(`   📦 Fallback found product: "${name}" - ₪${price}`);
                        }
                    }
                }
            }
            
            console.log(`✅ Stav extractLiveProductsStav found ${products.length} REAL products:`, products);
            return products;
        }
        
        function addStavMessage(message, isUser = false) {
            const messagesDiv = document.getElementById('stavChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `stav-message ${isUser ? 'user' : 'bot'}`;
            
            // 🎬 Add entrance animation (slower, more elegant)
            messageDiv.style.cssText = `
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            `;
            
            if (isUser) {
                messageDiv.textContent = message;
            } else {
                // Convert markdown-style links to clickable links
                let processedMessage = message.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea; text-decoration: underline;">$1</a>');
                
                // Add animated typing effect for bot messages
                messageDiv.innerHTML = '<span class="typing-text"></span>';
                messagesDiv.appendChild(messageDiv);
                
                // Animate typing effect
                const typingSpan = messageDiv.querySelector('.typing-text');
                let i = 0;
                const typeMessage = () => {
                    if (i < processedMessage.length) {
                        typingSpan.innerHTML += processedMessage.charAt(i);
                        i++;
                        setTimeout(typeMessage, 50); // 50ms delay between characters
                    }
                };
                typeMessage();
                
                // Fix image URLs to be absolute and add error handling
                processedMessage = processedMessage.replace(/src="([^"]+)"/g, (match, src) => {
                    let fullSrc = src;
                    if (src.startsWith('/')) {
                        fullSrc = `${window.location.origin}${src}`;
                    }
                    return `src="${fullSrc}" onerror="this.style.display='none'" onload="this.style.display='block'"`;
                });
                
                messageDiv.innerHTML = processedMessage;
            }
            
            messagesDiv.appendChild(messageDiv);
            
            // 🎬 Trigger entrance animation (slower)
            setTimeout(() => {
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            }, 100);
            
            // 🌊 Smooth scroll instead of instant jump (with more delay)
            setTimeout(() => {
                messagesDiv.scrollTo({
                    top: messagesDiv.scrollHeight,
                    behavior: 'smooth'
                });
            }, 400);
        }
        
        function removeStavTypingIndicator() {
            const messagesDiv = document.getElementById('stavChatMessages');
            const typingMessage = messagesDiv.querySelector('.stav-message.bot:last-child');
            if (typingMessage && typingMessage.innerHTML.includes('מקלידה')) {
                typingMessage.remove();
            }
        }
        
        function removeStavTypingIndicator() {
            const messagesDiv = document.getElementById('stavChatMessages');
            if (messagesDiv.lastChild && messagesDiv.lastChild.textContent.includes('מקלידה')) {
                messagesDiv.removeChild(messagesDiv.lastChild);
            }
        }
        // Extract product info from description and HTML content
        async function extractProductInfo(description, keyword, pageUrl = null) {
            if (!description) return null;
            
            const desc = description.toLowerCase();
            const keywordLower = keyword.toLowerCase();
            
            // Look for price patterns - more comprehensive
            const pricePatterns = [
                /(\d+)\s*₪/g,
                /(\d+)\s*שקל/g,
                /(\d+)\s*ש"ח/g,
                /מחיר[:\s]*(\d+)/g,
                /(\d+)\s*-\s*(\d+)\s*₪/g,
                /מחיר[:\s]*(\d+)\s*-\s*(\d+)/g,
                /(\d+)\s*למאה/g,
                /(\d+)\s*למטה/g,
                /(\d+)\s*למעלה/g
            ];
            
            let price = null;
            for (const pattern of pricePatterns) {
                const match = pattern.exec(desc);
                if (match) {
                    if (match[2]) {
                        price = `${match[1]}-${match[2]}₪`;
                    } else {
                        price = `${match[1]}₪`;
                    }
                    break;
                }
            }
            
            // Look for location patterns
            const locationPatterns = [
                /מיקום[:\s]*([^,.\n]{2,50})/g,
                /כתובת[:\s]*([^,.\n]{2,50})/g,
                /נמצא[:\s]*([^,.\n]{2,50})/g,
                /ב[:\s]*([^,.\n]{2,50})/g
            ];
            
            let location = null;
            for (const pattern of locationPatterns) {
                const match = pattern.exec(desc);
                if (match && match[1] && match[1].length > 2) {
                    location = match[1].trim();
                    break;
                }
            }
            
            // Look for product name patterns - more specific
            let productName = null;
            if (keywordLower === 'שעון') {
                const watchPatterns = [
                    /שעון\s+([^,.\n]{2,30})/g,
                    /([^,.\n]{2,30})\s*שעון/g,
                    /שעון\s+([א-ת\s]{2,30})/g,
                    /([א-ת\s]{2,30})\s*שעון\s+([א-ת\s]{2,30})/g
                ];
                for (const pattern of watchPatterns) {
                    const match = pattern.exec(desc);
                    if (match && match[1] && match[1].length > 2) {
                        productName = match[1].trim();
                        break;
                    }
                }
            } else if (keywordLower === 'תכשיט') {
                const jewelryPatterns = [
                    /תכשיט\s+([^,.\n]{2,30})/g,
                    /([^,.\n]{2,30})\s*תכשיט/g,
                    /([^,.\n]{2,30})\s*זהב/g,
                    /([^,.\n]{2,30})\s*כסף/g
                ];
                for (const pattern of jewelryPatterns) {
                    const match = pattern.exec(desc);
                    if (match && match[1] && match[1].length > 2) {
                        productName = match[1].trim();
                        break;
                    }
                }
            } else if (keywordLower === 'צעצוע') {
                const toyPatterns = [
                    /צעצוע\s+([^,.\n]{2,30})/g,
                    /([^,.\n]{2,30})\s*צעצוע/g,
                    /([^,.\n]{2,30})\s*משחק/g
                ];
                for (const pattern of toyPatterns) {
                    const match = pattern.exec(desc);
                    if (match && match[1] && match[1].length > 2) {
                        productName = match[1].trim();
                        break;
                    }
                }
            }
            
            // If we have a page URL, try to fetch the HTML content to find more prices
            if (pageUrl && (!price || !productName)) {
                try {
                    console.log('🔍 Fetching HTML for:', pageUrl);
                    const response = await fetch(pageUrl);
                    const html = await response.text();
                    const htmlLower = html.toLowerCase();
                    
                    console.log('📄 HTML length:', html.length);
                    
                    // Look for prices in HTML content
                    if (!price) {
                        console.log('💰 Looking for prices in HTML...');
                        const htmlPricePatterns = [
                            /<p class="product-price[^"]*"[^>]*>₪(\d+(?:,\d+)?)<\/p>/g,
                            /class="product-price[^"]*"[^>]*>₪(\d+(?:,\d+)?)/g,
                            /₪\s*(\d+(?:,\d+)?)/g,
                            /(\d+(?:,\d+)?)\s*₪/g
                        ];
                        
                        for (const pattern of htmlPricePatterns) {
                            const matches = [...html.matchAll(pattern)];
                            console.log('🔍 Pattern matches:', pattern, matches.length);
                            if (matches.length > 0) {
                                // Get the first price found
                                const firstPrice = matches[0][1] || matches[0][0].match(/(\d+(?:,\d+)?)/)?.[1];
                                console.log('💰 Found price:', firstPrice);
                                if (firstPrice) {
                                    price = `₪${firstPrice}`;
                                    break;
                                }
                            }
                        }
                        
                        // If still no price, try a simpler approach
                        if (!price) {
                            console.log('🔍 Trying simple price search...');
                            const simplePriceMatch = html.match(/₪\s*(\d+(?:,\d+)?)/);
                            console.log('💰 Simple match result:', simplePriceMatch);
                            if (simplePriceMatch) {
                                price = `₪${simplePriceMatch[1]}`;
                            }
                        }
                        
                        console.log('💰 Final price found:', price);
                    }
                    
                    // Look for product names in HTML content
                    if (!productName && keywordLower === 'שעון') {
                        const watchPatterns = [
                            /שעון\s+([^<>{}\n]{2,30})/g,
                            /([^<>{}\n]{2,30})\s*שעון/g,
                            /<h[1-6][^>]*>.*?שעון\s+([^<]{2,30})/g,
                            /class="[^"]*product-name[^"]*"[^>]*>([^<]+)/g,
                            /<h3[^>]*>([^<]*שעון[^<]*)<\/h3>/g
                        ];
                        
                        for (const pattern of watchPatterns) {
                            const matches = [...html.matchAll(pattern)];
                            if (matches.length > 0) {
                                productName = matches[0][1].trim();
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.log('Could not fetch HTML content:', error);
                }
            }
            
            if (productName || price || location) {
                return {
                    name: productName || `${keyword} מיוחד`,
                    price: price || 'מחיר לפי בקשה',
                    location: location || 'מיקום לא צוין'
                };
            }
            
            return null;
        }

        // Smart search function for Stav chat
        let lastSearchContext = null; // Remember last search context
        let lastSearchResults = []; // Remember last search results
        
        // Add event listener for Enter key
        document.getElementById('stavChatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendStavMessage();
            }
        });
        
        // Add event listener for button click
        document.getElementById('stav-chat-btn').addEventListener('click', toggleStavChat);
    </script>

    <!-- Account Summary Modal -->
    <div id="account-summary-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">סיכום חשבון</h3>
                    <button onclick="closeAccountSummaryModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="text-sm text-gray-500">עדכון אחרון: <span id="modal-last-update"></span></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-medium text-blue-600">דפים שנוצרו</p>
                                <p class="text-2xl font-bold text-blue-800" id="modal-account-total-pages">0</p>
                            </div>
                            <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <!-- תצוגה מקדימה קטנה -->
                        <div class="relative bg-white rounded-lg overflow-hidden shadow-sm border border-blue-200 h-24">
                            <div id="modal-total-pages-preview" class="absolute inset-0 bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-1">
                                        <span class="text-white text-sm font-bold" id="modal-total-pages-icon">0</span>
                                    </div>
                                    <div class="text-xs text-blue-700 font-medium">דפים</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-medium text-green-600">דפים פעילים</p>
                                <p class="text-2xl font-bold text-green-800" id="modal-account-active-pages">0</p>
                            </div>
                            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <!-- תצוגה מקדימה קטנה -->
                        <div class="relative bg-white rounded-lg overflow-hidden shadow-sm border border-green-200 h-24">
                            <div id="modal-active-pages-preview" class="absolute inset-0 bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-1">
                                        <span class="text-white text-sm font-bold" id="modal-active-pages-icon">0</span>
                                    </div>
                                    <div class="text-xs text-green-700 font-medium">פעילים</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-medium text-purple-600">חיוב חודשי</p>
                                <p class="text-2xl font-bold text-purple-800" id="modal-account-monthly-charge">₪0</p>
                            </div>
                            <svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <!-- תצוגה מקדימה קטנה -->
                        <div class="relative bg-white rounded-lg overflow-hidden shadow-sm border border-purple-200 h-24">
                            <div id="modal-monthly-charge-preview" class="absolute inset-0 bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-1">
                                        <span class="text-white text-xs font-bold">₪</span>
                                    </div>
                                    <div class="text-xs text-purple-700 font-medium" id="modal-monthly-charge-amount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="closeAccountSummaryModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-medium transition-colors">
                        סגור
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
