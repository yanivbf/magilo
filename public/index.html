<!DOCTYPE html>
<html lang="he" dir="rtl">
    <!-- ğŸš€ VERSION: 2025-01-26-FIX-BOT-JSON ğŸš€ -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPage - ×“×£ ×›× ×™×¡×”</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rubik', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }
        
        .loading-dots {
            display: inline-block;
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        /* Generation Loading Animation Styles */
        .gen-loader {
            width: 60px; 
            height: 60px;
            border-radius: 50%;
            perspective: 800px;
            margin: 0 auto 20px;
        }
        
        .gen-loader .inner {
            position: absolute;
            box-sizing: border-box;
            width: 100%; 
            height: 100%;
            border-radius: 50%;
        }
        
        .gen-loader .inner.one {
            left: 0%; 
            top: 0%;
            animation: rotate-one 1.5s linear infinite;
            border-bottom: 3px solid #8b5cf6;
        }
        
        .gen-loader .inner.two {
            right: 0%; 
            top: 0%;
            animation: rotate-two 1.5s linear infinite;
            border-right: 3px solid #ec4899;
        }
        
        .gen-loader .inner.three {
            right: 0%; 
            bottom: 0%;
            animation: rotate-three 1.5s linear infinite;
            border-top: 3px solid #3b82f6;
        }
        
        @keyframes rotate-one { 
            0% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(0deg); } 
            100% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(360deg); } 
        }
        
        @keyframes rotate-two { 
            0% { transform: rotateX(50deg) rotateY(10deg) rotateZ(0deg); } 
            100% { transform: rotateX(50deg) rotateY(10deg) rotateZ(360deg); } 
        }
        
        @keyframes rotate-three { 
            0% { transform: rotateX(35deg) rotateY(55deg) rotateZ(0deg); } 
            100% { transform: rotateX(35deg) rotateY(55deg) rotateZ(360deg); } 
        }
        
        .gen-text {
            text-align: center;
            font-weight: 500;
            color: #6b7280;
            margin-top: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .debug {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: right;
            max-height: 150px;
            overflow-y: auto;
            word-break: break-all;
        }
        .project-saved-indicator {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .status-badge {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }

        /* Tooltip styles */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            animation: fadeIn 0.2s ease-in-out;
        }
        
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            margin-bottom: 1px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(5px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-processing {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        /* Dropdown Menu Styles */
        .dropdown-menu {
            min-width: 180px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }
        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Stav Chat Styles */
        .stav-chat-window {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .stav-chat-window.active {
            display: flex;
        }
        
        .stav-chat-container {
            width: 95%;
            max-width: 1400px;
            height: 90%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .stav-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stav-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
        }
        
        .stav-message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .stav-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .stav-message.bot {
            background: white;
            color: #333;
            margin-left: auto;
            margin-right: 0;
            text-align: right !important;
            direction: rtl !important;
            display: block !important;
            width: 100% !important;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 12px 16px !important;
            text-align: right !important;
            align-self: flex-end !important;
            max-width: none !important;
        }
        
        .typing-text {
            display: inline-block;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .stav-chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }
        
        .stav-chat-input input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .stav-chat-input input:focus {
            border-color: #667eea;
        }
        
        .stav-chat-input button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .stav-chat-input button:hover {
            background: #5a67d8;
        }
        
        .typing-dots {
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0; }
            30% { opacity: 1; }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 transition-all duration-500">

    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">

        <div id="login-view" class="w-full max-w-6xl mx-auto hidden">
            <div class="bg-white rounded-2xl shadow-2xl flex flex-col md:flex-row-reverse overflow-hidden">
                <div class="w-full md:w-1/2 p-8 sm:p-12 flex flex-col justify-center">
                    <h1 class="text-4xl md:text-5xl font-bold text-indigo-700 mb-4 leading-tight">×“×£ × ×—×™×ª×” ×× ×¦×—.<br/>×‘×œ×—×™×¦×ª ×›×¤×ª×•×¨.</h1>
                    <p class="text-gray-800 text-lg leading-relaxed mb-6">
                        ×ª×¤×¡×™×§ ×œ×‘×–×‘×– ×–××Ÿ ×•×›×¡×£. ×”×‘×•×˜ ×”×—×›× ×©×œ AutoPage ×™×‘× ×” ×œ×š ×“×£ × ×—×™×ª×” ××§×¦×•×¢×™ ×©×××™×¨ ×’×•×œ×©×™× ×œ×œ×§×•×—×•×ª - ×ª×•×š ×“×§×•×ª, ×‘×œ×™ ×¦×•×¨×š ×‘×§×•×“ ××• ×™×“×¢ ×‘×¢×™×¦×•×‘.
                    </p>
                     <ul class="space-y-4 text-gray-700 mb-8 text-base">
                        <li class="flex items-center gap-3">âœ¨ <b>×™×¦×™×¨×” ××™×™×“×™×ª:</b> ×¢× ×” ×¢×œ ×›××” ×©××œ×•×ª ×•×”×“×£ ×©×œ×š ×‘××•×•×™×¨.</li>
                        <li class="flex items-center gap-3">ğŸ¨ <b>×¢×™×¦×•×‘ ×™×•×§×¨×ª×™:</b> ×‘×—×¨ ××ª×•×š ×ª×‘× ×™×•×ª ×©× ×¨××•×ª ×›××™×œ×• ×¢×•×¦×‘×• ×‘×¡×˜×•×“×™×•.</li>
                        <li class="flex items-center gap-3">ğŸš€ <b>××•×›×Ÿ ×œ×¦××™×—×”:</b> ×—×™×‘×•×¨ ×§×œ ×œ×•×•××˜×¡××¤, ××™××™×™×œ ×•× ×™×”×•×œ ×œ×™×“×™×.</li>
                        <li class="flex items-center gap-3">ğŸ’¡ <b>24/7 ×‘×©×‘×™×œ×š:</b> ×”×‘×•×˜ ×¢×•× ×” ×œ×’×•×œ×©×™× ×’× ×›×©××ª×” ×™×©×Ÿ.</li>
                    </ul>
                    
                    <!-- Auth Tabs -->
                    <div class="flex mb-6 border-b border-gray-200">
                        <button id="loginTab" class="flex-1 py-3 px-4 text-center font-medium text-indigo-600 border-b-2 border-indigo-600" onclick="showAuthTab('login')">
                            ×”×ª×—×‘×¨×•×ª
                        </button>
                        <button id="registerTab" class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700" onclick="showAuthTab('register')">
                            ×”×¨×©××”
                        </button>
                    </div>

                    <!-- Login Form -->
                    <div id="loginForm" class="auth-form">
                        <div class="mb-4">
                            <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">××™××™×™×œ:</label>
                            <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="×”×›× ×¡ ××ª ×”××™××™×™×œ ×©×œ×š">
                        </div>
                        <div class="mb-4">
                            <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">×¡×™×¡××”:</label>
                            <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="×”×›× ×¡ ××ª ×”×¡×™×¡××” ×©×œ×š">
                        </div>
                        <button onclick="loginWithEmail()" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-indigo-700 transition-transform transform hover:scale-105 mb-3">
                            ×”×ª×—×‘×¨
                        </button>
                        <button onclick="resetPassword()" class="w-full text-indigo-600 py-2 px-4 font-medium hover:text-indigo-800 transition">
                            ×©×›×—×ª ×¡×™×¡××”?
                        </button>
                    </div>

                    <!-- Register Form -->
                    <div id="registerForm" class="auth-form hidden">
                        <div class="mb-4">
                            <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-2">××™××™×™×œ:</label>
                            <input type="email" id="registerEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="×”×›× ×¡ ××ª ×”××™××™×™×œ ×©×œ×š">
                        </div>
                        <div class="mb-4">
                            <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-2">×¡×™×¡××”:</label>
                            <input type="password" id="registerPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="×”×›× ×¡ ×¡×™×¡××” ×—×“×©×”">
                        </div>
                        <div class="mb-4">
                            <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">××™×©×•×¨ ×¡×™×¡××”:</label>
                            <input type="password" id="confirmPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="×”×›× ×¡ ×©×•×‘ ××ª ×”×¡×™×¡××”">
                        </div>
                        <button onclick="registerWithEmail()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-green-700 transition-transform transform hover:scale-105 mb-3">
                            ×”×¨×©×
                        </button>
                    </div>

                    <!-- Divider -->
                    <div class="flex items-center my-6">
                        <div class="flex-1 border-t border-gray-300"></div>
                        <span class="px-4 text-gray-500 text-sm">××•</span>
                        <div class="flex-1 border-t border-gray-300"></div>
                    </div>
                    
                    <button id="googleSignInBtn" class="w-full bg-red-600 text-white py-4 px-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 hover:bg-red-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:bg-gray-400">
                        <svg class="w-6 h-6" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span>×”×ª×—×‘×¨ ×¢× Google</span>
                    </button>
                    <div id="loading" class="mt-4 flex items-center justify-center gap-2 text-gray-500 hidden">
                        <div class="loader"></div>
                        <span>××ª×—×‘×¨...</span>
                    </div>
                    <div id="error-message" class="bg-red-100 text-red-700 p-3 rounded-lg mt-4 hidden"></div>
                    <div id="success-message" class="bg-green-100 text-green-700 p-3 rounded-lg mt-4 hidden"></div>
                </div>
                
                <aside class="relative bg-slate-100 p-4 w-full md:w-1/2 hidden md:flex items-center justify-center">
                    <div id="slides-container" class="relative w-full max-w-md h-[480px] overflow-hidden rounded-xl shadow-lg">
                        </div>
                    <button id="prev" class="absolute top-1/2 -translate-y-1/2 right-7 bg-white/90 hover:bg-white rounded-full w-9 h-9 grid place-items-center shadow z-10">â€¹</button>
                    <button id="next" class="absolute top-1/2 -translate-y-1/2 left-7 bg-white/90 hover:bg-white rounded-full w-9 h-9 grid place-items-center shadow z-10">â€º</button>
                    <div id="dots" class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-2 z-10"></div>
                </aside>
            </div>
        </div>


        <div id="dashboard-view" class="w-full max-w-5xl hidden">
            <div class="bg-slate-50 p-4 rounded-2xl shadow-2xl">
                <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ×¨××©×™×™× -->
                <div class="flex justify-end gap-4 mb-1">
                    <button id="account-summary-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <svg class="w-5 h-5 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        ×¡×™×›×•× ×—×©×‘×•×Ÿ
                    </button>
                    <a href="/marketplace.html" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Marketplace
                    </a>
                    <button id="stav-chat-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        ğŸ¤– ×¡×ª×™×•
                    </button>
                    <button id="admin-panel-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors hidden">
                        <svg class="w-5 h-5 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31-2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        ×¤×× ×œ ×× ×”×œ
                    </button>
                </div>
                
                <!-- User info and logout button -->
                <div class="flex items-center justify-between mb-1 pb-1 border-b border-gray-200">
                    <div class="flex items-center gap-2">
                        <img id="user-avatar" src="https://placehold.co/80x80/E2E8F0/4A5568?text=U" alt="×ª××•× ×ª ×¤×¨×•×¤×™×œ" class="w-8 h-8 rounded-full object-cover">
                        <div class="text-right">
                            <div id="user-name" class="font-semibold text-gray-700 text-xs">
                                <span class="loading-dots">×˜×•×¢×Ÿ</span>
                            </div>
                            <div id="subscription-status" class="text-xs text-gray-500">
                                <span id="subscription-badge" class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <span id="subscription-text">××©×ª××© ×¨×©×•×</span>
                                </span>
                            </div>
                        </div>
                        <button onclick="signOut()" title="×”×ª× ×ª×§" class="text-gray-500 hover:text-red-600 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>
                </div>

                <div id="projects-section">
                    <div class="flex justify-between items-center mb-1">
                         <h2 class="text-2xl font-bold text-gray-800">×“×¤×™ ×”× ×—×™×ª×” ×©×œ×™</h2>
                        <button onclick="goToFullApp()" class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-bold hover:bg-indigo-700 transition-transform transform hover:scale-105 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span>×“×£ ×—×“×©</span>
                        </button>
                    </div>
                    <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Subscription Modal -->
    <div id="page-subscription-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">×”×¤×¢×œ ×× ×•×™ ×œ×¦×¤×™×™×” ×‘×“×£</h3>
                        <p class="text-gray-600">×”×¤×¢×œ ×× ×•×™ ×—×•×“×©×™ ×‘-â‚ª39 ×œ×¦×¤×™×™×” ×‘×“×£ ×–×”</p>
                    </div>
                
                <div class="space-y-4 mb-6">
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">×’×™×©×” ××œ××” ×œ×“×£</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">×§×™×©×•×¨ ×§×‘×•×¢ ×œ×“×£</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">×¢×“×›×•× ×™× ××•×˜×•××˜×™×™×</span>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-indigo-600 mb-1">â‚ª39</div>
                        <div class="text-sm text-gray-500">×œ×—×•×“×©</div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="closePageSubscriptionModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-300 transition">
                        ×‘×™×˜×•×œ
                    </button>
                        <button onclick="processPageSubscription()" class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-indigo-700 transition">
                            ×”×¤×¢×œ ×× ×•×™
                        </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subscription-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">×× ×•×™ AutoPage Pro</h3>
                    <p class="text-gray-600">×”×ª×—×œ ×× ×•×™ ×—×•×“×©×™ ×‘-â‚ª39 ×•×§×‘×œ ×’×™×©×” ××œ××”</p>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">×™×¦×™×¨×ª ×“×¤×™× ×œ×œ× ×”×’×‘×œ×”</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">×§×™×©×•×¨ ×§×‘×•×¢ ×œ×“×£ ×©×œ×š</span>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-sm text-gray-700">×ª××™×›×” ×˜×›× ×™×ª 24/7</span>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-indigo-600 mb-1">â‚ª39</div>
                        <div class="text-sm text-gray-500">×œ×—×•×“×©</div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeSubscriptionModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-300 transition">
                        ×‘×™×˜×•×œ
                    </button>
                    <button onclick="processSubscription()" class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-indigo-700 transition">
                        ×”×ª×—×œ ×× ×•×™
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="fixed inset-0 bg-gray-100 z-50 hidden">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <div class="w-64 bg-white shadow-lg border-l border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h1 class="text-xl font-bold text-gray-800">×¤×× ×œ ×× ×”×œ</h1>
                        <button id="close-admin-panel" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <nav class="mt-6">
                    <div class="px-3 space-y-1">
                        <button id="dashboard-tab" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-white bg-indigo-600">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v1H8V5z"></path>
                            </svg>
                            ×“×©×‘×•×¨×“
                        </button>
                        
                        <button id="users-tab" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            ××©×ª××©×™×
                        </button>
                        
                        <button id="finance-tab" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                            ×›×¡×¤×™×
                        </button>
                        
                        <button id="analytics-tab" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            ×¡×˜×˜×™×¡×˜×™×§×•×ª
                        </button>
                        
                        <button id="settings-tab" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-50 hover:text-gray-900">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            ×”×’×“×¨×•×ª
                        </button>

                        <a href="/marketplace.html" target="_blank" class="w-full flex items-center px-3 py-2 text-sm font-medium rounded-md text-indigo-700 bg-indigo-50 hover:bg-indigo-100 hover:text-indigo-900 mt-2">
                            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h5l2 3h8a1 1 0 011 1v11a2 2 0 01-2 2H5a2 2 0 01-2-2V4z"/>
                            </svg>
                            Marketplace
                        </a>
                    </div>
                </nav>
            </div>
            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Top Bar -->
                <header class="bg-white shadow-sm border-b border-gray-200">
                    <div class="px-6 py-4">
                        <div class="flex items-center justify-between">
                            <h2 id="admin-page-title" class="text-2xl font-semibold text-gray-800">×“×©×‘×•×¨×“</h2>
                            <div class="flex items-center space-x-4">
                                <div class="text-sm text-gray-500">
                                    <span id="admin-current-time"></span>
                                </div>
                                <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                    A
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
                
                <!-- Content Area -->
                <main class="flex-1 overflow-y-auto bg-gray-50 p-6">

                    <!-- Dashboard Content -->
                    <div id="dashboard-content" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">××©×ª××©×™× ×‘××¢×¨×›×ª</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="dashboard-total-users">0</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">×”×›× ×¡×•×ª ×—×•×“×©×™×•×ª</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="dashboard-monthly-revenue">â‚ª0</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">×“×¤×™× ×¤×¢×™×œ×™×</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="dashboard-active-pages">0</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-amber-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">×“×¤×™× ×œ× ×¤×¢×™×œ×™×</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="dashboard-inactive-pages">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">×¤×¢×™×œ×•×ª ××—×¨×•× ×”</h3>
                                </div>
                                <div class="p-6 max-h-96 overflow-y-auto">
                                    <div id="recent-activity" class="space-y-4">
                                        <!-- ×¤×¢×™×œ×•×ª ×××™×ª×™×ª ×ª×™×˜×¢×Ÿ ×›××Ÿ -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">×¡×˜×˜×™×¡×˜×™×§×•×ª ××”×™×¨×•×ª</h3>
                                </div>
                                <div class="p-6">
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium text-gray-500">××©×ª××©×™× ×—×“×©×™× ×”×©×‘×•×¢</span>
                                            <span class="text-sm font-semibold text-gray-900" id="weekly-new-users">1</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium text-gray-500">×“×¤×™× ×©× ×•×¦×¨×• ×”×©×‘×•×¢</span>
                                            <span class="text-sm font-semibold text-gray-900" id="weekly-new-pages">0</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium text-gray-500">×”×›× ×¡×•×ª ×”×©×‘×•×¢</span>
                                            <span class="text-sm font-semibold text-gray-900" id="weekly-revenue">â‚ª0</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium text-gray-500">×©×™×¢×•×¨ ×”××¨×”</span>
                                            <span class="text-sm font-semibold text-gray-900" id="conversion-rate">100%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Management Content -->
                    <div id="users-content" class="tab-content hidden">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-medium text-gray-900">× ×™×”×•×œ ××©×ª××©×™×</h3>
                                    <button class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">
                                        ××©×ª××© ×—×“×©
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">××©×ª××©</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">××™××™×™×œ</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×ª××¨×™×š ×”×¦×˜×¨×¤×•×ª</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×× ×•×™</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¤×¢×•×œ×•×ª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Finance Management Content -->
                    <div id="finance-content" class="tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">×”×›× ×¡×•×ª ×—×•×“×©×™×•×ª</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="monthly-revenue">â‚ª2,450</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">××©×ª××©×™× ××—×•×‘×¨×™×</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="active-users">1</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="mr-4">
                                        <p class="text-sm font-medium text-gray-500">×“×¤×™× ×©× ×•×¦×¨×•</p>
                                        <p class="text-2xl font-semibold text-gray-900" id="total-pages">47</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">×”×™×¡×˜×•×¨×™×™×ª ×ª×©×œ×•××™×</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">××©×ª××©</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¡×›×•×</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×ª××¨×™×š</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¡×˜×˜×•×¡</th>
                                        </tr>
                                    </thead>
                                    <tbody id="payments-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Payments will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Content -->
                    <div id="analytics-content" class="tab-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">×¡×˜×˜×•×¡ ×“×¤×™×</h3>
                                </div>
                                <div class="p-6">
                                    <div id="pages-status-chart" class="h-64 flex items-center justify-center">
                                        <div class="text-center">
                                            <div class="w-32 h-32 mx-auto mb-4 relative">
                                                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                                                    <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                                                    <circle id="pages-progress" cx="50" cy="50" r="40" stroke="#10b981" stroke-width="8" fill="none" 
                                                            stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"/>
                                                </svg>
                                                <div class="absolute inset-0 flex items-center justify-center">
                                                    <span id="pages-percentage" class="text-2xl font-bold text-gray-700">0%</span>
                                                </div>
                                            </div>
                                            <div class="space-y-2">
                                                <div class="flex items-center justify-between text-sm">
                                                    <span class="text-gray-600">×“×¤×™× ×¤×¢×™×œ×™×</span>
                                                    <span id="active-pages-count" class="font-medium">0</span>
                                                </div>
                                                <div class="flex items-center justify-between text-sm">
                                                    <span class="text-gray-600">×“×¤×™× ×œ× ×¤×¢×™×œ×™×</span>
                                                    <span id="inactive-pages-count" class="font-medium">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">×”×›× ×¡×•×ª ×—×•×“×©×™×•×ª</h3>
                                </div>
                                <div class="p-6">
                                    <div id="revenue-chart" class="h-64 flex items-center justify-center">
                                        <div class="text-center">
                                            <div class="text-4xl font-bold text-green-600 mb-2" id="monthly-revenue-display">â‚ª0</div>
                                            <div class="text-sm text-gray-500 mb-4">×”×›× ×¡×•×ª ×”×—×•×“×©</div>
                                            <div class="space-y-3">
                                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                                    <span class="text-sm text-gray-600">×“×¤×™× ×¤×¢×™×œ×™×</span>
                                                    <span id="revenue-active-pages" class="font-medium text-green-600">0</span>
                                                </div>
                                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                    <span class="text-sm text-gray-600">×“×¤×™× ×œ× ×¤×¢×™×œ×™×</span>
                                                    <span id="revenue-inactive-pages" class="font-medium text-gray-600">0</span>
                                                </div>
                                                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                                    <span class="text-sm text-gray-600">×¤×•×˜× ×¦×™××œ ×”×›× ×¡×•×ª</span>
                                                    <span id="revenue-potential" class="font-medium text-blue-600">â‚ª0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-lg font-medium text-gray-900">×¤×¢×™×œ×•×ª</h3>
                                        <div class="flex bg-gray-100 rounded-lg p-1">
                                            <button id="daily-btn" class="px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md transition-colors" onclick="changeActivityPeriod('daily')">×™×•××™</button>
                                            <button id="weekly-btn" class="px-3 py-1 text-sm font-medium bg-white text-gray-900 shadow-sm rounded-md transition-colors" onclick="changeActivityPeriod('weekly')">×©×‘×•×¢×™</button>
                                            <button id="monthly-btn" class="px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md transition-colors" onclick="changeActivityPeriod('monthly')">×—×•×“×©×™</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div id="weekly-activity-chart" class="h-64">
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-blue-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">×“×¤×™× ×©× ×•×¦×¨×• ×”×©×‘×•×¢</span>
                                                </div>
                                                <span id="weekly-pages-created" class="font-bold text-blue-600">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-green-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">×“×¤×™× ×©×”×•×¤×¢×œ×• ×”×©×‘×•×¢</span>
                                                </div>
                                                <span id="weekly-pages-activated" class="font-bold text-green-600">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-purple-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">×”×›× ×¡×•×ª ×”×©×‘×•×¢</span>
                                                </div>
                                                <span id="weekly-revenue-display" class="font-bold text-purple-600">â‚ª0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                <div class="p-6 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">×¡×˜×˜×™×¡×˜×™×§×•×ª ××©×ª××©×™×</h3>
                                </div>
                                <div class="p-6">
                                    <div id="users-stats-chart" class="h-64">
                                        <div class="space-y-4">
                                            <div class="flex items-center justify-between p-4 bg-indigo-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-indigo-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">×¡×”"×› ××©×ª××©×™× ××—×•×‘×¨×™×</span>
                                                </div>
                                                <span id="total-users-count" class="font-bold text-indigo-600">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-green-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">××©×ª××©×™× ××—×•×‘×¨×™×</span>
                                                </div>
                                                <span id="active-users-count" class="font-bold text-green-600">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-4 bg-amber-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-amber-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">××©×ª××©×™× ×œ× ××—×•×‘×¨×™×</span>
                                                </div>
                                                <span id="inactive-users-count" class="font-bold text-amber-600">0</span>
                                            </div>
                                            <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg">
                                                <div class="flex items-center">
                                                    <div class="w-3 h-3 bg-red-500 rounded-full ml-2"></div>
                                                    <span class="text-sm text-gray-600">×©×™×¢×•×¨ ×”××¨×”</span>
                                                </div>
                                                <span id="conversion-rate-display" class="font-bold text-red-600">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Content -->
                    <div id="settings-content" class="tab-content hidden">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">×”×’×“×¨×•×ª ××¢×¨×›×ª</h3>
                            </div>
                            <div class="p-6">
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">×©× ×”××¢×¨×›×ª</label>
                                        <input type="text" value="AutoPage" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">××™××™×™×œ ×× ×”×œ</label>
                                        <input type="email" value="admin@autopage.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">×”×’×“×¨×•×ª ××‘×˜×—×”</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" checked class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="mr-2 text-sm text-gray-700">×“×•×¨×© ××™××•×ª ×“×•-×©×œ×‘×™</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="mr-2 text-sm text-gray-700">×”×’×‘×œ ××¡×¤×¨ × ×™×¡×™×•× ×•×ª ×”×ª×—×‘×¨×•×ª</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">× ×™×§×•×™ × ×ª×•× ×™×</label>
                                        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                                            <p class="text-sm text-gray-700 mb-3">
                                                ğŸ§¹ × ×§×” × ×ª×•× ×™× ×™×ª×•××™× (×§× ×™×•×ª ×•××•×–×× ×™× ××“×¤×™× ×©× ××—×§×•)
                                            </p>
                                            <button onclick="cleanOrphanedData()" class="bg-yellow-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-yellow-700">
                                                ğŸ—‘ï¸ × ×§×” × ×ª×•× ×™× ×™×ª×•××™×
                                            </button>
                                        </div>
                                    </div>
                                    <div class="flex justify-end">
                                        <button class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700">
                                            ×©××•×¨ ×”×’×“×¨×•×ª
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Stav Chat Window -->
    <div class="stav-chat-window" id="stavChatWindow">
        <div class="stav-chat-container">
            <div class="stav-chat-header">
                <h2>ğŸ¤– ×¡×ª×™×•</h2>
                <button onclick="toggleStavChat()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
            </div>
        <div class="stav-chat-messages" id="stavChatMessages">
            <div class="stav-message bot">
                ×©×œ×•×! ğŸ˜Š ××™×š ×× ×™ ×™×›×•×œ×” ×œ×¢×–×•×¨ ×œ×š?
            </div>
        </div>
            <div class="stav-chat-input">
                <input type="text" id="stavChatInput" placeholder="×›×ª×•×‘ ×”×•×“×¢×”...">
                <button onclick="sendStavMessage()">×©×œ×—</button>
            </div>
        </div>
    </div>

    <!-- Responsive overrides for Stav chat -->
    <style>
        .stav-chat-window { z-index: 9999; position: fixed; right: 24px; bottom: 24px; }
        .stav-chat-window.fullscreen { inset: 0 !important; right: 0 !important; left: 0 !important; top: 0 !important; bottom: 0 !important; width: 100vw !important; height: 100vh !important; margin: 0 !important; padding: 0 !important; }
        .stav-chat-container { display: flex !important; flex-direction: column !important; }
        .stav-chat-window.fullscreen .stav-chat-container { width: 100% !important; max-width: none !important; height: 100% !important; margin: 0 !important; border-radius: 0 !important; }
        .stav-chat-header { flex: 0 0 auto !important; }
        .stav-chat-messages { flex: 1 1 auto !important; overflow-y: auto !important; }
        .stav-chat-input { flex: 0 0 auto !important; }
        @media (max-width: 640px) {
            .stav-chat-window { left: 4vw; right: 4vw; bottom: calc(16px + env(safe-area-inset-bottom)); }
            .stav-chat-container { width: 100%; max-height: min(70vh, 560px); border-radius: 16px; overflow: hidden; }
            .stav-chat-messages { max-height: none !important; }
            .stav-chat-input { padding-bottom: max(8px, env(safe-area-inset-bottom)); }
        }
    </style>
    <script>
        // --- Local fallback logic to avoid repeating the same greeting and answer simple queries ---
        let stavFirstReplySent = false;
        function stavLocalFallbackReply(message) {
            try {
                const raw = (message || '').toString();
                const msg = raw.trim();
                const lower = msg.toLowerCase();

                // Greetings
                if (/^(×”×™×™|×”×™|×©×œ×•×)[!\s\u200f\u200e]*$/i.test(msg)) {
                    return stavFirstReplySent
                        ? '×”×™×™! ×›××Ÿ ×œ×¢×–×•×¨. ×¢×œ ××” ×ª×¨×¦×” ×œ×©×•×—×—?'
                        : '×”×™×™! ğŸ˜Š ××™×š ×× ×™ ×™×›×•×œ×” ×œ×¢×–×•×¨ ×œ×š?';
                }

                // Introductions / names
                if (/(×× ×™|×§×•×¨××™× ×œ×™)\s*×™× ×™×‘/i.test(msg)) {
                    return '×”×™×™ ×™× ×™×‘! ğŸ˜Š × ×¢×™× ×œ×”×›×™×¨! ××™×š ××¤×©×¨ ×œ×¢×–×•×¨?';
                }

                // Simple general knowledge example
                if (/××”\s+×’×•×“×œ\s+(×›×“×•×¨\s*×”××¨×¥|×”××¨×¥)/i.test(lower)) {
                    return '×§×•×˜×¨ ×›×“×•×¨ ×”××¨×¥ ×‘×¢×¨×š 12,742 ×§×´× (×¨×“×™×•×¡ ~6,371 ×§×´×).';
                }

                // Default helpful prompt
                return '×§×™×‘×œ×ª×™! ×¡×¤×¨/×™ ×§×¦×ª ×™×•×ª×¨ ××” ××ª/×” ××—×¤×©/×ª, ×•××›×•×•×Ÿ ××•×ª×š.';
            } catch (_) {
                return '×”×‘× ×ª×™! ××™×š ××•×›×œ ×œ×¢×–×•×¨?';
            }
        }
        // === AUTO-OPEN STAV FROM MARKETPLACE ===
        // Check if we came from marketplace with a pending message
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('openStav') === 'true' && window.innerWidth >= 768) { // don't auto-open on small screens
                const pendingMessage = localStorage.getItem('stavPendingMessage');
                if (pendingMessage) {
                    // Open Stav chat
                    setTimeout(() => {
                        toggleStavChat();
                        // Set the message and send it
                        const stavInput = document.getElementById('stavChatInput');
                        if (stavInput) {
                            stavInput.value = pendingMessage;
                            localStorage.removeItem('stavPendingMessage');
                            setTimeout(() => {
                                sendStavMessage();
                            }, 500);
                        }
                    }, 300);
                }
            }
        });

        // Force fullscreen when chat opens
        window.addEventListener('DOMContentLoaded', function() {
            const win = document.getElementById('stavChatWindow');
            if (win) {
                const origToggle = window.toggleStavChat;
                window.toggleStavChat = function() {
                    if (typeof origToggle === 'function') origToggle();
                    win.classList.add('fullscreen');
                }
            }
        });

        // --- Performance Optimization for Edge ---
        // Keep console.log enabled for debugging (commented out the disabling)
        // const isEdge = navigator.userAgent.indexOf('Edg') > -1;
        // if (isEdge) {
        //     // Completely disable console in Edge
        //     console.log = function() {};
        //     console.info = function() {};
        //     console.debug = function() {};
        //     console.warn = function() {};
        //     
        //     // Add timeout protection for all async operations
        //     window.EDGE_TIMEOUT = 5000; // 5 seconds max for any operation
        //     
        //     // Disable all animations in Edge
        //     document.documentElement.style.setProperty('--animation-duration', '0s');
        // }
        
        // --- ×”×’×“×¨×•×ª ---
        const supabaseUrl = 'https://osoqfadqohqcauawzmmq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zb3FmYWRxb2hxY2F1YXd6bW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2OTIzMjMsImV4cCI6MjA3MzI2ODMyM30.TBLmKIntYGSfBm2StItfWm87-ebojV_NbaKNcYNWMPg';
        const googleClientId = '589919062235-o6ohhnon54a12dav2lg24goh1m4ks43p.apps.googleusercontent.com';

        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);
        let currentUser = null;
        let subscriptionData = null;
        let subscriptionTimer = null;
        let currentPageForSubscription = null;
        let projects = []; // Global projects array for manageProject access

        // --- Admin Variables ---
        const ADMIN_USER_ID = 'fae06b49-1239-4ba5-93db-244ce2851fb4'; // ×”×× ×”×œ ×”× ×•×›×—×™
        let isAdmin = false;
        let adminTimeInterval = null; // Prevent memory leak from multiple intervals
        let isDashboardLoading = false; // Prevent multiple simultaneous dashboard loads
        let loadProjectsTimeout = null; // Debounce loadProjects calls
        let isLoadingProjects = false; // Prevent concurrent loadProjects calls

        // --- User Session Management ---
        function saveCurrentUser(user) {
            if (user) {
                sessionStorage.setItem('currentUser', JSON.stringify(user));
            }
        }

        function loadCurrentUser() {
            try {
                const stored = sessionStorage.getItem('currentUser');
                return stored ? JSON.parse(stored) : null;
            } catch (error) {
                console.error('Error loading user from session:', error);
                return null;
            }
        }

        function clearCurrentUser() {
            sessionStorage.removeItem('currentUser');
        }

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const adminPanel = document.getElementById('admin-panel');
        const closeAdminPanel = document.getElementById('close-admin-panel');
        const adminPageTitle = document.getElementById('admin-page-title');
        const adminCurrentTime = document.getElementById('admin-current-time');
        
        // --- Subscription Functions ---
        function openSubscriptionModal() {
            document.getElementById('subscription-modal').classList.remove('hidden');
        }

        function closeSubscriptionModal() {
            document.getElementById('subscription-modal').classList.add('hidden');
        }

        async function processSubscription() {
            if (!currentUser) {
                showError('×¢×œ×™×š ×œ×”×™×•×ª ××—×•×‘×¨ ×›×“×™ ×œ×¨×›×•×© ×× ×•×™');
                return;
            }

            // ×¡×™××•×œ×¦×™×” ×©×œ ×ª×©×œ×•× - ×‘×¤×•×¢×œ ×›××Ÿ ×™×”×™×” ×©×™×œ×•×‘ ×¢× ××¢×¨×›×ª ×ª×©×œ×•××™×
            try {
                // ×™×¦×™×¨×ª ×× ×•×™ ×—×“×©
                const subscriptionEndDate = new Date();
                subscriptionEndDate.setMonth(subscriptionEndDate.getMonth() + 1);

                subscriptionData = {
                    userId: currentUser.id,
                    startDate: new Date().toISOString(),
                    endDate: subscriptionEndDate.toISOString(),
                    isActive: true,
                    pageUrl: `${window.location.origin}/pages/${currentUser.id}/landing.html`
                };

                // ×©××™×¨×” ×‘-localStorage (×‘×¤×•×¢×œ ×™×”×™×” ×‘×‘×¡×™×¡ × ×ª×•× ×™×)
                localStorage.setItem(`subscription_${currentUser.id}`, JSON.stringify(subscriptionData));

                closeSubscriptionModal();
                // updateSubscriptionUI(); // ×œ× × ×“×¨×© ×™×•×ª×¨
                startSubscriptionCountdown();
                
                showSuccess('×”×× ×•×™ ×”×•×¤×¢×œ ×‘×”×¦×œ×—×”!');
                
            } catch (error) {
                console.error('Subscription error:', error);
                showError('×©×’×™××” ×‘×”×¤×¢×œ×ª ×”×× ×•×™');
            }
        }

        function updateSubscriptionUI() {
            // ×”×¤×•× ×§×¦×™×” ×”×–×• ×›×‘×¨ ×œ× × ×“×¨×©×ª ×›×™ ×”×¡×¨× ×• ××ª ×”××œ×× ×˜×™× ××”×“×£ ×”×¨××©×™
            // ×›×œ ×”×× ×•×™×™× ×”× ×¤×¨×˜×™×™× ×œ×›×œ ×“×£
            console.log('updateSubscriptionUI called - no longer needed');
        }

        function startSubscriptionCountdown() {
            if (!subscriptionData || !subscriptionData.isActive) return;

            const subscriptionCountdown = document.getElementById('subscription-countdown');
            
            function updateCountdown() {
                const now = new Date().getTime();
                const endDate = new Date(subscriptionData.endDate).getTime();
                const timeLeft = endDate - now;

                if (timeLeft <= 0) {
                    // ×”×× ×•×™ ×¤×’
                    subscriptionData.isActive = false;
                    localStorage.setItem(`subscription_${currentUser.id}`, JSON.stringify(subscriptionData));
                    // updateSubscriptionUI(); // ×œ× × ×“×¨×© ×™×•×ª×¨
                    showError('×”×× ×•×™ ×©×œ×š ×¤×’. ×× × ×—×“×© ××ª ×”×× ×•×™ ×œ×”××©×š ×”×©×™××•×©.');
                    // Clear interval when subscription expires
                    if (subscriptionTimer) {
                        clearInterval(subscriptionTimer);
                        subscriptionTimer = null;
                    }
                    return;
                }

                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));

                subscriptionCountdown.textContent = `× ×•×ª×¨×•: ${days} ×™××™×, ${hours} ×©×¢×•×ª, ${minutes} ×“×§×•×ª`;
            }

            updateCountdown();
            // Clear previous interval to prevent memory leak
            if (subscriptionTimer) {
                clearInterval(subscriptionTimer);
            }
            subscriptionTimer = setInterval(updateCountdown, 60000); // ×¢×“×›×•×Ÿ ×›×œ ×“×§×”
        }

        function loadSubscriptionData() {
            if (!currentUser) return;
            
            const stored = localStorage.getItem(`subscription_${currentUser.id}`);
            if (stored) {
                subscriptionData = JSON.parse(stored);
                
                // ×‘×“×•×§ ×× ×”×× ×•×™ ×¢×“×™×™×Ÿ ×¤×¢×™×œ
                const now = new Date().getTime();
                const endDate = new Date(subscriptionData.endDate).getTime();
                
                if (now > endDate) {
                    subscriptionData.isActive = false;
                    localStorage.setItem(`subscription_${currentUser.id}`, JSON.stringify(subscriptionData));
                }
            }
            
            // updateSubscriptionUI(); // ×œ× × ×“×¨×© ×™×•×ª×¨
        }

        // --- Page Subscription Functions ---
        function openPageSubscriptionModal(pageId) {
            console.log('Opening subscription modal for page:', pageId);
            currentPageForSubscription = pageId;
            document.getElementById('page-subscription-modal').classList.remove('hidden');
        }

        function closePageSubscriptionModal() {
            document.getElementById('page-subscription-modal').classList.add('hidden');
            currentPageForSubscription = null;
        }

        // --- Account Summary Modal Functions ---
        function openAccountSummaryModal() {
            document.getElementById('account-summary-modal').classList.remove('hidden');
            // ×¢×“×›×Ÿ ××ª ×”× ×ª×•× ×™× ×‘××•×“×œ ×¢× × ×ª×•× ×™× ×××™×ª×™×™×
            updateModalAccountSummary();
        }

        function closeAccountSummaryModal() {
            document.getElementById('account-summary-modal').classList.add('hidden');
        }

        async function updateModalAccountSummary() {
            console.log('=== updateModalAccountSummary called ===');
            console.log('Current user:', currentUser);
            
            if (!currentUser || !currentUser.id) {
                console.log('No current user, skipping modal update');
                return;
            }

            try {
                // ×§×‘×œ ××ª ×”×“×¤×™× ××”×©×¨×ª (×›××• ×‘-loadProjects)
                console.log('Fetching pages from server...');
                const response = await fetch(`/api/pages/${currentUser.id}`);
                const serverData = await response.json();
                const serverPages = serverData.pages || [];
                console.log('Server pages for modal:', serverPages);
                
                // ×§×‘×œ ×’× ×“×¤×™× ××§×•××™×™×
                const localData = JSON.parse(localStorage.getItem('autopage_data') || '{}');
                const localPages = localData.pages || [];
                console.log('Local pages for modal:', localPages);
                
                // ×©×œ×‘ ××ª ×”× ×ª×•× ×™×
                const allPages = [...serverPages, ...localPages];
                console.log('All pages for modal:', allPages);

                // ×¡×¤×•×¨ ×× ×•×™×™× ×¤×¢×™×œ×™× - ×‘×“×•×§ ×’× localStorage ×•×’× ×”×©×¨×ª
                // ××©×ª××© ×‘-localStorage ×›×™ ×¢×“×™×™×Ÿ ×œ× ×›×œ ×”×× ×•×™×™× ××¡×•× ×›×¨× ×™× ×œ×©×¨×ª
                let activeSubscriptions = 0;
                allPages.forEach(page => {
                    // ×‘×“×•×§ ×ª×—×™×œ×” ××ª localStorage (×›×™ ×¢×“×™×™×Ÿ ×œ× ×›×œ ×”×× ×•×™×™× ××¡×•× ×›×¨× ×™×)
                    const pageKey = `local_${page.fileName}`;
                    const pageSubscription = localStorage.getItem(`page_subscription_${pageKey}`);
                    
                    let isActive = false;
                    
                    // ×‘×“×•×§ localStorage ×ª×—×™×œ×” (×›×™ ×”×× ×•×™×™× ×¢×“×™×™×Ÿ ×©×)
                    if (pageSubscription) {
                        try {
                            const subscriptionData = JSON.parse(pageSubscription);
                            if (subscriptionData && subscriptionData.isActive === true) {
                                isActive = true;
                            }
                        } catch (e) {
                            console.error('Error parsing subscription:', e);
                        }
                    }
                    
                    // ×× localStorage ×œ× × ××¦×, ×‘×“×•×§ ××ª ×”×©×¨×ª
                    if (!isActive && page.isActive === true) {
                        isActive = true;
                    }
                    
                    if (isActive) {
                        activeSubscriptions++;
                    }
                });

                console.log(`Modal - Total pages: ${allPages.length}, Active subscriptions: ${activeSubscriptions}`);
                console.log('Modal - Pages with isActive:', allPages.map(p => ({ 
                    fileName: p.fileName, 
                    isActive: p.isActive, 
                    type: typeof p.isActive 
                })));

                // ×—×©×‘ ×—×™×•×‘ ×—×•×“×©×™ (â‚ª39 ×œ×›×œ ×“×£ ×¤×¢×™×œ ×‘×œ×‘×“)
                const monthlyCharge = activeSubscriptions * 39;
                const lastUpdateTime = new Date().toLocaleString('he-IL');

                // ×¢×“×›×Ÿ ××ª ×”××•×“×œ
                document.getElementById('modal-account-total-pages').textContent = allPages.length;
                document.getElementById('modal-account-active-pages').textContent = activeSubscriptions;
                document.getElementById('modal-account-monthly-charge').textContent = `â‚ª${monthlyCharge}`;
                document.getElementById('modal-last-update').textContent = lastUpdateTime;

                // ×¢×“×›×Ÿ ××ª ×”×ª×¦×•×’×•×ª ×”××§×“×™××•×ª ×”×§×˜× ×•×ª
                document.getElementById('modal-total-pages-icon').textContent = allPages.length;
                document.getElementById('modal-active-pages-icon').textContent = activeSubscriptions;
                document.getElementById('modal-monthly-charge-amount').textContent = monthlyCharge;

                console.log('Modal Account Summary Updated:', {
                    totalPages: allPages.length,
                    activePages: activeSubscriptions,
                    monthlyCharge,
                    serverPages: serverPages.length,
                    localPages: localPages.length
                });

            } catch (error) {
                console.error('Error updating modal account summary:', error);
                // ×”×¦×’ × ×ª×•× ×™× ×‘×¨×™×¨×ª ××—×“×œ
                document.getElementById('modal-account-total-pages').textContent = '0';
                document.getElementById('modal-account-active-pages').textContent = '0';
                document.getElementById('modal-account-monthly-charge').textContent = 'â‚ª0';
                document.getElementById('modal-last-update').textContent = new Date().toLocaleString('he-IL');
            }
        }

        async function processPageSubscription() {
            console.log('ğŸ”” Processing subscription for:', currentPageForSubscription);
            console.log('ğŸ‘¤ Current user:', currentUser);
            
            if (!currentUser || !currentPageForSubscription) {
                showError('×©×’×™××” ×‘×¤×¨×˜×™ ×”×× ×•×™');
                return;
            }

            try {
                // ×™×¦×™×¨×ª ×× ×•×™ ×œ×“×£ ×¡×¤×¦×™×¤×™
                const subscriptionEndDate = new Date();
                subscriptionEndDate.setMonth(subscriptionEndDate.getMonth() + 1);

                const pageSubscriptionData = {
                    pageId: currentPageForSubscription,
                    userId: currentUser.id,
                    startDate: new Date().toISOString(),
                    endDate: subscriptionEndDate.toISOString(),
                    isActive: true
                };

                // ×©××™×¨×” ×‘-localStorage
                const storageKey = `page_subscription_${currentPageForSubscription}`;
                localStorage.setItem(storageKey, JSON.stringify(pageSubscriptionData));
                console.log('âœ… Subscription saved to localStorage with key:', storageKey);
                console.log('ğŸ“¦ Subscription data:', pageSubscriptionData);
                
                // ×‘×“×•×§ ×©×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”
                const savedData = localStorage.getItem(storageKey);
                console.log('ğŸ” Verification - data saved?', savedData !== null);

                closePageSubscriptionModal();
                
                // ×¢×“×›×Ÿ ××ª ×”×›×¨×˜×™×¡ ××™×™×“×™×ª
                console.log('ğŸ”„ Looking for project card:', currentPageForSubscription);
                const projectCard = document.querySelector(`[data-project-id="${currentPageForSubscription}"]`);
                console.log('ğŸ“Œ Project card found:', projectCard !== null);
                
                if (projectCard) {
                    // ××¦× ××ª ××–×•×¨ ×”×›×¤×ª×•×¨×™× - ×¢×“×›× ×• ××ª ×”-selector
                    const actionButtonsDiv = projectCard.querySelector('.flex.items-center.justify-between');
                    console.log('ğŸ”˜ Action buttons div found:', actionButtonsDiv !== null);
                    
                    if (actionButtonsDiv) {
                        // ××¦× ××ª ×”×›×¤×ª×•×¨ ×”×¦×”×•×‘ "×”×¤×¢×œ ×× ×•×™" ×•×”×—×œ×£ ××•×ª×• ×‘×›×¤×ª×•×¨ ×™×¨×•×§ "×¦×¤×”"
                        const subscribeBtn = actionButtonsDiv.querySelector('button.bg-yellow-500');
                        if (subscribeBtn) {
                            subscribeBtn.outerHTML = `
                                <button onclick="viewProject('${currentPageForSubscription}')" class="bg-green-500 text-white px-3 py-2 rounded text-sm font-medium hover:bg-green-600 transition shadow-sm" style="min-width: 60px;">
                                    ×¦×¤×”
                                </button>`;
                            console.log('âœ… Button updated successfully!');
                        }
                        
                        // ×¢×“×›×Ÿ ××ª ×”×ª×’ ×©×œ ×”×¡×˜×˜×•×¡
                        const statusBadge = projectCard.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.className = 'status-badge status-completed';
                            statusBadge.textContent = '×× ×•×™ ×¤×¢×™×œ';
                        }
                        
                        // ×¢×“×›×Ÿ ××ª ×”×ª×’ ×‘×¤×™× ×” ×©×œ ×”×ª××•× ×”
                        const cornerBadge = projectCard.querySelector('.absolute.top-3.right-3 > div');
                        if (cornerBadge) {
                            cornerBadge.className = 'bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1';
                            cornerBadge.innerHTML = `
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                ×–××™×Ÿ ×œ×¦×¤×™×™×”`;
                        }
                    }
                }
                
                showSuccess('×”×× ×•×™ ×œ×“×£ ×”×•×¤×¢×œ ×‘×”×¦×œ×—×”! ×›×¢×ª × ×™×ª×Ÿ ×œ×¦×¤×•×ª ×‘×“×£');
                
                // ×¨×¢× ×Ÿ ××ª ×”×“×©×‘×•×¨×“ ×œ××—×¨ ×©× ×™×”
                setTimeout(() => {
                    console.log('ğŸ”„ Reloading projects...');
                    loadProjects();
                }, 1000);
                
            } catch (error) {
                console.error('âŒ Page subscription error:', error);
                showError('×©×’×™××” ×‘×”×¤×¢×œ×ª ×”×× ×•×™ ×œ×“×£');
            }
        }
        
        // --- ×œ×•×’×™×§×ª ××™××•×ª ---
        window.onload = async function() {
            console.log("=== PAGE LOAD CHECK ===");
            
            // ×‘×“×•×§ ×× ×—×–×¨× ×• ××™×¦×™×¨×ª ×“×£ ×—×“×©
            const urlParams = new URLSearchParams(window.location.search);
            const fromCreator = urlParams.get('fromCreator');
            if (fromCreator === 'true') {
                // × ×§×” ××ª ×”×¤×¨××˜×¨ ××”-URL
                window.history.replaceState({}, document.title, window.location.pathname);
                // ×¢×“×›×Ÿ ××ª ×”××•×“×œ ×× ×”×•× ×¤×ª×•×— (×¨×§ ×× ×‘×××ª ×¦×¨×™×š)
                // ×”×•×¡×¨ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×©×’×¨× ×œ×‘×¢×™×•×ª
            }
            
            // × ×¡×” ×œ×˜×¢×•×Ÿ ××©×ª××© ×-sessionStorage
            const savedUser = loadCurrentUser();
            if (savedUser) {
                console.log("Found saved user in session:", savedUser.email);
                currentUser = savedUser;
                // ×”××ª×Ÿ ×§×¦×ª ×œ×¤× ×™ ×”×¦×’×ª ×”×“×©×‘×•×¨×“
                setTimeout(() => {
                showDashboard();
                }, 100);
                return;
            }
            
            console.log("Supabase URL:", supabaseUrl);
            console.log("Supabase Key:", supabaseKey ? 'Present' : 'Missing');
            
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                console.log("Session data:", session);
                console.log("Session error:", error);
                
                if (session && session.user) {
                    console.log("Found existing session!");
                    console.log("User ID:", session.user.id);
                    console.log("User email:", session.user.email);
                    currentUser = session.user;
                    saveCurrentUser(currentUser);
                    setTimeout(() => {
                    showDashboard();
                    }, 100);
                } else {
                    console.log("No session found, showing login");
                    loginView.classList.remove('hidden');
                    initGoogleSignIn();
                }
            } catch (err) {
                console.error("Error checking session:", err);
                loginView.classList.remove('hidden');
                initGoogleSignIn();
            }
        };

        function initCarousel() {
            const DEMOS = [
                {src:'https://images.pexels.com/photos/1779487/pexels-photo-1779487.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'×“×£ × ×—×™×ª×” ×œ×¢×¡×§'},
                {src:'https://images.pexels.com/photos/262978/pexels-photo-262978.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'×ª×¤×¨×™×˜ ×œ××¡×¢×“×”'},
                {src:'https://images.pexels.com/photos/374631/pexels-photo-374631.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'×§×˜×œ×•×’ ××•×¦×¨×™×'},
                {src:'https://images.pexels.com/photos/5077063/pexels-photo-5077063.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'×¤×•×¡×˜ ×©×™×•×•×§×™'},
                {src:'https://images.pexels.com/photos/4050315/pexels-photo-4050315.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'×›×¨×˜×™×¡ ×‘×™×§×•×¨ ×“×™×’×™×˜×œ×™'},
                {src:'https://images.pexels.com/photos/326503/pexels-photo-326503.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1', caption:'××ª×¨ ×ª×“××™×ª'}
            ];
            const slidesContainer = document.getElementById('slides-container');
            if (slidesContainer) {
                const dotsC = document.getElementById('dots');
                const prevBtn = document.getElementById('prev');
                const nextBtn = document.getElementById('next');
                const count = DEMOS.length;
                let i = 0;
                let timer;
                slidesContainer.innerHTML = DEMOS.map((d) => `
                    <figure class="absolute inset-0 w-full h-full transition-opacity duration-700 ease-in-out opacity-0">
                        <img loading="lazy" src="${d.src}" alt="${d.caption}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https.placehold.co/800x600/cccccc/ffffff?text=Image+Not+Found';">
                        <figcaption class="absolute bottom-3 right-3 bg-white/85 px-3 py-1 rounded text-xs font-medium text-gray-700 shadow">${d.caption}</figcaption>
                    </figure>
                `).join('');
                const slides = Array.from(slidesContainer.children);
                dotsC.innerHTML = DEMOS.map(() => '<button class="w-2.5 h-2.5 rounded-full bg-white/60 transition-colors"></button>').join('');
                const dots = [...dotsC.children];
                function setDot() { dots.forEach((d, j) => { d.className = 'w-2.5 h-2.5 rounded-full transition-colors ' + (j === i ? 'bg-white shadow' : 'bg-white/60'); }); }
                function go(n) { i = (n + count) % count; slides.forEach((slide, index) => { slide.classList.toggle('opacity-100', index === i); }); setDot(); }
                function reset() { clearInterval(timer); auto(); }
                function auto() { timer = setInterval(() => go(i + 1), 5000); }
                prevBtn.onclick = () => { go(i - 1); reset(); };
                nextBtn.onclick = () => { go(i + 1); reset(); };
                dots.forEach((d, idx) => d.onclick = () => { go(idx); reset(); });
                go(0);
                auto();
            }
        }

        // --- ×¤×•× ×§×¦×™×•×ª ××™××•×ª ×¨×’×™×œ ---
        function showAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.className = 'flex-1 py-3 px-4 text-center font-medium text-indigo-600 border-b-2 border-indigo-600';
                registerTab.className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.className = 'flex-1 py-3 px-4 text-center font-medium text-indigo-600 border-b-2 border-indigo-600';
                loginTab.className = 'flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-gray-700';
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }
        async function loginWithEmail() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            console.log("=== LOGIN ATTEMPT ===");
            console.log("Email:", email);
            
            if (!email || !password) {
                showError('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }
            
            showLoading(true);
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                console.log("Login response:", { data, error });
                
                if (error) {
                    console.error("Login error:", error);
                    showError('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + error.message);
                } else if (data && data.user) {
                    console.log("Login successful!");
                    console.log("User ID:", data.user.id);
                    currentUser = data.user;
                    saveCurrentUser(currentUser);
                    setTimeout(() => {
                    showDashboard();
                    }, 100);
                } else {
                    console.error("No user data in response");
                    showError('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª');
                }
            } catch (error) {
                console.error("Login exception:", error);
                showError('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª');
            } finally {
                showLoading(false);
            }
        }

        async function registerWithEmail() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!email || !password || !confirmPassword) {
                showError('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('×”×¡×™×¡×××•×ª ××™× ×Ÿ ×ª×•×××•×ª');
                return;
            }
            
            if (password.length < 6) {
                showError('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×');
                return;
            }
            
            showLoading(true);
            
            try {
                console.log("=== REGISTRATION ATTEMPT ===");
                console.log("Email:", email);
                
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: email.split('@')[0],
                            full_name: email.split('@')[0]
                        }
                    }
                });
                
                console.log("Registration response:", { data, error });
                
                if (error) {
                    console.error("Registration error:", error);
                    showError('×©×’×™××” ×‘×”×¨×©××”: ' + error.message);
                } else if (data && data.user) {
                    console.log("Registration successful!");
                    console.log("User ID:", data.user.id);
                    showSuccess('×”×¨×©××” ×‘×•×¦×¢×” ×‘×”×¦×œ×—×”! ×‘×“×•×§ ××ª ×”××™××™×™×œ ×©×œ×š ×œ××™×©×•×¨ ×”×—×©×‘×•×Ÿ.');
                    // ×¢×‘×¨ ×œ×˜×‘ ×”×ª×—×‘×¨×•×ª
                    showAuthTab('login');
                    // × ×§×” ××ª ×”×©×“×•×ª
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    console.error("No user data in registration response");
                    showError('×©×’×™××” ×‘×”×¨×©××”');
                }
            } catch (error) {
                showError('×©×’×™××” ×‘×”×¨×©××”');
            } finally {
                showLoading(false);
            }
        }

        async function resetPassword() {
            const email = document.getElementById('loginEmail').value;
            
            if (!email) {
                showError('×× × ×”×›× ×¡ ××ª ×”××™××™×™×œ ×©×œ×š ×ª×—×™×œ×”');
                return;
            }
            
            showLoading(true);
            
            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/reset-password'
                });
                
                if (error) {
                    showError('×©×’×™××” ×‘×©×œ×™×—×ª ××™××™×™×œ ×©×—×–×•×¨: ' + error.message);
                } else {
                    showSuccess('× ×©×œ×— ××™××™×™×œ ×©×—×–×•×¨ ×¡×™×¡××”. ×‘×“×•×§ ××ª ×ª×™×‘×ª ×”×“×•××¨ ×©×œ×š.');
                }
            } catch (error) {
                showError('×©×’×™××” ×‘×©×œ×™×—×ª ××™××™×™×œ ×©×—×–×•×¨');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            if (show) {
                loadingEl.classList.remove('hidden');
            } else {
                loadingEl.classList.add('hidden');
            }
        }

        function showSuccess(message) {
            // ×™×¦×™×¨×ª ×”×•×“×¢×ª ×”×¦×œ×—×” ×–×× ×™×ª
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        function initGoogleSignIn() {
            console.log("=== INIT GOOGLE SIGNIN ===");
            if (typeof google === 'undefined') {
                console.log("Google not loaded yet, retrying...");
                setTimeout(initGoogleSignIn, 100);
                return;
            }
            
            console.log("Google loaded, initializing...");
            initCarousel();
            google.accounts.id.initialize({
                client_id: googleClientId,
                callback: handleGoogleResponse,
                auto_select: false,
                cancel_on_tap_outside: false,
            });
            
            // Use renderButton instead of prompt() - more reliable
            const buttonDiv = document.getElementById('googleSignInBtn');
            
            // Hide the custom button and create a wrapper for Google's button
            buttonDiv.style.display = 'none';
            const googleButtonWrapper = document.createElement('div');
            googleButtonWrapper.id = 'google-button-wrapper';
            googleButtonWrapper.style.width = '100%';
            buttonDiv.parentNode.insertBefore(googleButtonWrapper, buttonDiv.nextSibling);
            
            // Render Google's official button
            google.accounts.id.renderButton(
                googleButtonWrapper,
                {
                    theme: 'filled_blue',
                    size: 'large',
                    width: buttonDiv.offsetWidth || 350,
                    text: 'signin_with',
                    locale: 'he',
                    logo_alignment: 'left'
                }
            );
            
            console.log("Google Sign-In button rendered");
        }

        async function handleGoogleResponse(response) {
            console.log("=== GOOGLE RESPONSE ===");
            console.log("Google credential:", response.credential);
            
            // Show loading immediately
            showLoading(true);
            const googleButtonWrapper = document.getElementById('google-button-wrapper');
            if (googleButtonWrapper) {
                googleButtonWrapper.style.display = 'none';
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithIdToken({
                    provider: 'google',
                    token: response.credential,
                });
                
                console.log("Google sign-in response:", { data, error });
                
                if (error) {
                    console.error("Supabase auth error:", error);
                    showError('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×¢× Google: ' + error.message);
                    showLoading(false);
                    if (googleButtonWrapper) {
                        googleButtonWrapper.style.display = 'block';
                    }
                } else if (data && data.user) {
                    currentUser = data.user;
                    saveCurrentUser(currentUser);
                    console.log("âœ… Google login successful!");
                    console.log("User ID:", currentUser.id);
                    console.log("User email:", currentUser.email);
                    console.log("User metadata:", currentUser?.user_metadata);
                    
                    // ×©××•×¨ ××©×ª××© ×‘×©×¨×ª ×¢× × ×ª×•× ×™ Google ×”×××™×ª×™×™×
                    try {
                        const userExtracted = extractUserData(currentUser);
                        const response = await fetch(`/api/user/${currentUser.id}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: currentUser.email || '',
                                name: userExtracted.name,
                                avatar: userExtracted.avatar
                            })
                        });
                        if (response.ok) {
                            console.log('âœ… User data saved to server');
                        }
                    } catch (err) {
                        console.error('Error saving user to server:', err);
                    }
                    
                    showSuccess('×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”! ×˜×•×¢×Ÿ ××ª ×”×“×©×‘×•×¨×“...');
                    setTimeout(() => {
                    showDashboard();
                    }, 800);
                } else {
                    console.error("No user data in Google response");
                    showError('×©×’×™××”: ×œ× ×”×ª×§×‘×œ×• × ×ª×•× ×™ ××©×ª××© ×-Google');
                    showLoading(false);
                    if (googleButtonWrapper) {
                        googleButtonWrapper.style.display = 'block';
                    }
                }
            } catch (err) {
                console.error("Google sign-in exception:", err);
                showError('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + (err.message || '× ×¡×” ×©×•×‘'));
                showLoading(false);
                if (googleButtonWrapper) {
                    googleButtonWrapper.style.display = 'block';
                }
            }
        }
        
        // ×¤×•× ×§×¦×™×” ×—×›××” ×œ×—×™×œ×•×¥ × ×ª×•× ×™×
        function extractUserData(user) {
            console.log("=== EXTRACTING USER DATA ===");
            console.log("Raw user object:", user);
            console.log("User metadata:", user.user_metadata);
            console.log("User email:", user.email);
            
            // ×—×™×œ×•×¥ ×©× - × ×¡×” ×›××” ××¤×©×¨×•×™×•×ª
            let name = '××©×ª××© ×¨×©×•×';
            
            // ×‘×“×•×§ user_metadata
            if (user.user_metadata) {
                if (user.user_metadata.name) name = user.user_metadata.name;
                else if (user.user_metadata.full_name) name = user.user_metadata.full_name;
                else if (user.user_metadata.display_name) name = user.user_metadata.display_name;
                else if (user.user_metadata.first_name || user.user_metadata.last_name) {
                    name = `${user.user_metadata.first_name || ''} ${user.user_metadata.last_name || ''}`.trim();
                }
            }
            
            // ×× ×œ× ××¦×× ×• ×©×, × ×¡×” ××”××™××™×™×œ
            if (name === '××©×ª××© ×¨×©×•×' && user.email) {
                const emailName = user.email.split('@')[0];
                name = emailName.charAt(0).toUpperCase() + emailName.slice(1);
            }
            
            // ×—×™×œ×•×¥ ×ª××•× ×” - × ×¡×” ×›××” ××¤×©×¨×•×™×•×ª
            let avatar = null;
            if (user.user_metadata?.avatar_url) avatar = user.user_metadata.avatar_url;
            else if (user.user_metadata?.picture) avatar = user.user_metadata.picture;
            else if (user.user_metadata?.picture_url) avatar = user.user_metadata.picture_url;
            else avatar = 'https://placehold.co/80x80/E2E8F0/4A5568?text=' + encodeURIComponent(name.charAt(0));
            
            console.log("Extracted name:", name);
            console.log("Extracted avatar:", avatar);
            console.log("========================");
            
            return { name, avatar };
        }
        
        // --- Admin Functions ---
        function checkAdminStatus() {
            isAdmin = currentUser && currentUser.id === ADMIN_USER_ID;
            console.log('Checking admin status:', { 
                currentUser: currentUser?.email, 
                userId: currentUser?.id, 
                adminId: ADMIN_USER_ID, 
                isAdmin 
            });
            if (isAdmin) {
                adminPanelBtn.classList.remove('hidden');
                console.log('Admin panel button shown');
            } else {
                adminPanelBtn.classList.add('hidden');
                console.log('Admin panel button hidden');
            }
        }

        async function openAdminPanel() {
            adminPanel.classList.remove('hidden');
            // ×”××ª×Ÿ ×©×”×¤×× ×œ ×™×™×˜×¢×Ÿ ×œ×¤× ×™ ×©×× ×¡×™× ×œ×¢×“×›×Ÿ × ×ª×•× ×™×
            await new Promise(resolve => setTimeout(resolve, 50));
            // ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“ ×”×¢×œ×™×•×Ÿ ××™×“
            updateAdminTime();
            // Clear previous interval to prevent memory leak
            if (adminTimeInterval) {
                clearInterval(adminTimeInterval);
            }
            adminTimeInterval = setInterval(updateAdminTime, 1000); // ×¢×“×›×Ÿ ×›×œ ×©× ×™×™×”
            // ×˜×¢×Ÿ ××ª ×›×œ ×”× ×ª×•× ×™× (×–×” ×™×§×¨× ×œ-updateDashboardCards ×¤× ×™××™×ª)
            await loadAdminData();
        }

        function closeAdminPanelHandler() {
            adminPanel.classList.add('hidden');
            // Clear interval when closing to prevent memory leak
            if (adminTimeInterval) {
                clearInterval(adminTimeInterval);
                adminTimeInterval = null;
            }
        }

        function updateAdminTime() {
            if (adminCurrentTime) {
                const now = new Date();
                adminCurrentTime.textContent = now.toLocaleString('he-IL');
            }
        }

        async function loadAdminData() {
            console.log('Loading admin data...', { isAdmin, currentUser: currentUser?.email, userId: currentUser?.id });
            if (!isAdmin) {
                console.log('User is not admin, skipping admin data load');
                return;
            }
            
            try {
                // ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“ ×”×¢×œ×™×•×Ÿ ××™×“
                await updateDashboardCards();
                
                // ×˜×¢×Ÿ × ×ª×•× ×™ ××©×ª××©×™×
                console.log('Loading users data...');
                await loadUsersData();
                
                // ×˜×¢×Ÿ × ×ª×•× ×™ ×›×¡×¤×™×
                console.log('Loading finance data...');
                await loadFinanceData();
                
                // ×˜×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
                console.log('Loading analytics data...');
                await loadAnalyticsData();
                
                // ×¢×“×›×Ÿ ×©×•×‘ ××ª ×”×“×©×‘×•×¨×“ ××—×¨×™ ×©×”×›×œ × ×˜×¢×Ÿ
                await updateDashboardCards();
                
                // ×¨×¢× ×Ÿ ××ª ×”×“×©×‘×•×¨×“ ×”×¨××©×™
                console.log('Loading projects...');
                await loadProjects();
                
                // ×¢×“×›×Ÿ ×©×•×‘ ××ª ×”×“×©×‘×•×¨×“ ××—×¨×™ ×©×”×›×œ × ×˜×¢×Ÿ
                await updateDashboardCards();
                
                console.log('Admin data loaded successfully');
            } catch (error) {
                console.error('Error loading admin data:', error);
                // Show error to user
                if (adminPanel && !adminPanel.classList.contains('hidden')) {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
                    errorMsg.textContent = '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×× ×”×œ. × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.';
                    const mainContent = adminPanel.querySelector('main');
                    if (mainContent) {
                        mainContent.insertBefore(errorMsg, mainContent.firstChild);
                        setTimeout(() => errorMsg.remove(), 5000);
                    }
                }
            }
        }

        async function loadUsersData() {
            try {
                // ×˜×¢×Ÿ ××ª ×›×œ ×”××©×ª××©×™× ××”×©×¨×ª
                const response = await fetch('/api/users');
                const serverUsers = await response.json();
                
                console.log('Server users:', serverUsers);
                
                const usersTableBody = document.getElementById('users-table-body');
                usersTableBody.innerHTML = '';

                // ×˜×¢×Ÿ ××ª ×›×œ ×”×“×¤×™× ×›×“×™ ×œ×—×©×‘ ×× ×•×™×™× ×××™×ª×™×™×
                const allPagesResponse = await fetch('/api/all-pages');
                const allPages = await allPagesResponse.json();
                
                console.log('All pages for subscription calculation:', allPages);

                // ×”×¦×’ ××ª ×›×œ ×”××©×ª××©×™× ××”×©×¨×ª (×›×•×œ×œ ×”×× ×”×œ ×× ×”×•× ×§×™×™×)
                serverUsers.forEach(user => {
                    // ×—×©×‘ ×× ×•×™×™× ×¤×¢×™×œ×™× ×××™×ª×™×™× ×œ××©×ª××©
                    let activeSubscriptions = 0;
                    let totalRevenue = 0;
                    
                    // ××¦× ××ª ×›×œ ×”×“×¤×™× ×©×œ ×”××©×ª××© ×”×–×”
                    const userPages = allPages.filter(page => page.userId === user.id);
                    
                    userPages.forEach(page => {
                        // ×”×©×ª××© ×‘-isActive ××”×©×¨×ª (×-metadata.json) ×‘××§×•× localStorage
                        const isActive = page.isActive === true;
                        
                        if (isActive) {
                                    activeSubscriptions++;
                                    totalRevenue += 39;
                        }
                    });
                    
                    // ×¢×“×›×Ÿ ××ª ×”× ×ª×•× ×™×
                    user.activeSubscriptions = activeSubscriptions;
                    user.totalRevenue = totalRevenue;
                    user.subscription_status = activeSubscriptions > 0 ? 'active' : 'inactive';
                    user.totalPages = userPages.length;
                    
                    console.log(`User ${user.email}: ${activeSubscriptions} active subscriptions, status: ${user.subscription_status}`);
                    console.log(`User pages:`, userPages.map(p => ({ fileName: p.fileName, isActive: p.isActive })));
                    
                    // ×¦×•×¨ ××ª ×”×©×•×¨×”
                    const row = createUserRow(user);
                    usersTableBody.appendChild(row);
                });

                console.log('Loaded users:', serverUsers.length, 'from server');

            } catch (error) {
                console.error('Error loading users:', error);
                loadLocalUsersData();
            }
        }
        function loadLocalUsersData() {
            // ×˜×¢×Ÿ × ×ª×•× ×™× ××§×•××™×™×
            const usersTableBody = document.getElementById('users-table-body');
            usersTableBody.innerHTML = '';

            // ×§×‘×œ ××ª ×›×œ ×”××©×ª××©×™× ×-localStorage
            const localData = JSON.parse(localStorage.getItem('autopage_data') || '{}');
            const pages = localData.pages || [];
            
            // ×—×©×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××©×ª××©
            let totalPages = pages.length;
            let activeSubscriptions = 0;
            let totalRevenue = 0;
            
            // ×—×©×‘ ×× ×•×™×™× ×¤×¢×™×œ×™× ×××™×ª×™×™×
            activeSubscriptions = 0;
            totalRevenue = 0;
            
            pages.forEach(page => {
                // ×‘×“×•×§ ×× ×™×© ×× ×•×™ ×¤×¢×™×œ ×œ×“×£ ×”×–×” - × ×¡×” ×›××” ××¤×ª×—×•×ª
                let pageSubscription = null;
                
                // 1. × ×¡×” ×¢× ×©× ×”×§×•×‘×¥ ×”××œ×
                pageSubscription = localStorage.getItem(`page_subscription_${page.fileName}`);
                
                // 2. × ×¡×” ×¢× ×©× ×§×•×‘×¥ ×œ×œ× ×¡×™×•××ª
                if (!pageSubscription) {
                    const fileNameWithoutExt = page.fileName.replace('.html', '');
                    pageSubscription = localStorage.getItem(`page_subscription_${fileNameWithoutExt}`);
                }
                
                // 3. × ×¡×” ×¢× ID ×©×œ ×”×“×£
                if (!pageSubscription) {
                    pageSubscription = localStorage.getItem(`page_subscription_${page.id || page.fileName}`);
                }
                
                // 4. × ×¡×” ×¢× ×›×œ ×”××¤×ª×—×•×ª ×”×§×™×™××™×
                if (!pageSubscription) {
                    const allKeys = Object.keys(localStorage).filter(key => key.includes('page_subscription'));
                    for (const key of allKeys) {
                        const keyValue = localStorage.getItem(key);
                        try {
                            const sub = JSON.parse(keyValue);
                            // ×‘×“×•×§ ×× ×–×” ×”×× ×•×™ ×©×œ ×”×“×£ ×”×–×”
                            if (sub.pageId === page.fileName || 
                                sub.pageId === page.id || 
                                key.includes(page.fileName) ||
                                key.includes(page.id)) {
                                pageSubscription = keyValue;
                                break;
                            }
                        } catch (e) {
                            // ×”××©×š ×œ×—×¤×©
                        }
                    }
                }
                
                if (pageSubscription) {
                    try {
                        const subscription = JSON.parse(pageSubscription);
                        if (subscription.isActive) {
                            activeSubscriptions++;
                            totalRevenue += 39;
                        }
                    } catch (e) {
                        console.error('Error parsing subscription:', e);
                    }
                }
            });
            
            // ×”×•×¡×£ ××ª ×”××©×ª××© ×”× ×•×›×—×™ ×¢× × ×ª×•× ×™× ×××™×ª×™×™×
            if (currentUser) {
                const isCurrentAdmin = currentUser.id === ADMIN_USER_ID;
                const row = createUserRow({
                    id: currentUser.id,
                    email: currentUser.email,
                    full_name: currentUser.user_metadata?.full_name || (isCurrentAdmin ? '×× ×”×œ' : '××©×ª××©'),
                    created_at: new Date().toISOString(),
                    subscription_status: activeSubscriptions > 0 ? 'active' : 'inactive',
                    totalPages: totalPages,
                    activeSubscriptions: activeSubscriptions,
                    totalRevenue: totalRevenue,
                    isAdmin: isCurrentAdmin
                });
                usersTableBody.appendChild(row);
            }

            console.log('User Data:', {
                totalPages,
                activeSubscriptions,
                totalRevenue,
                user: currentUser?.user_metadata?.full_name,
                isAdmin: isAdmin,
                userId: currentUser?.id,
                adminId: ADMIN_USER_ID
            });
        }

        function createUserRow(user) {
            const row = document.createElement('tr');
            row.setAttribute('data-user-id', user.id);
            const joinDate = new Date(user.created_at).toLocaleDateString('he-IL');
            // ×‘×“×•×§ ×× ×”××©×ª××© ××—×•×‘×¨ - ×¨×§ ×”××©×ª××© ×”× ×•×›×—×™ ××—×•×‘×¨ (×›×™ ×× ×—× ×• ×‘×××©×§ ×”×× ×”×œ)
            // "××—×•×‘×¨" ×¤×™×¨×•×©×• ×©×”××©×ª××© ×”×–×” ×”×•× ×–×” ×©×¤×ª×•×— ×‘×××©×§ ×”×× ×”×œ ×›×¨×’×¢
            const isConnected = user.id === currentUser?.id;
            // ×‘××§×¨×” ×©×œ ×××©×§ ×× ×”×œ, ×¨×§ ×”××©×ª××© ×”× ×•×›×—×™ (×”×× ×”×œ) ××—×•×‘×¨
            // ×›×œ ×”××©×ª××©×™× ×”××—×¨×™× ×œ× ××—×•×‘×¨×™× ×›×¨×’×¢
            const statusBadge = isConnected ? 
                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">××—×•×‘×¨</span>' :
                '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">×œ× ××—×•×‘×¨</span>';

            // ×‘×“×•×§ ×× ×–×” ×”×× ×”×œ
            const isCurrentAdmin = user.id === currentUser?.id || user.isAdmin;
            const adminBadge = isCurrentAdmin ? 
                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 mr-2">×× ×”×œ</span>' : '';

            // ×”×•×¡×£ ××™×“×¢ × ×•×¡×£ ×¢×œ ×”××©×ª××©
            const additionalInfo = user.totalPages ? 
                `<div class="text-xs text-gray-400 mt-1">
                    ×“×¤×™×: ${user.totalPages} | ×× ×•×™×™× ×¤×¢×™×œ×™×: ${user.activeSubscriptions || 0} | ×”×›× ×¡×•×ª: â‚ª${user.totalRevenue || 0}
                </div>` : '';

            // ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” - ×× ×”×œ ×™×›×•×œ ×œ×©×œ×•×˜ ×‘×›×œ ×”××©×ª××©×™×
            const actionButtons = isCurrentAdmin ? 
                `<span class="text-gray-400 text-sm">×× ×”×œ ×”××¢×¨×›×ª</span>` :
                `<button onclick="toggleUserStatus('${user.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                    ${isConnected ? '× ×ª×§' : '×”×ª×—×‘×¨'}
                </button>
                <button onclick="viewUserPages('${user.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                    ×“×¤×™×
                </button>
                <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">
                    ××—×§
                </button>`;

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <div class="h-10 w-10 rounded-full ${isCurrentAdmin ? 'bg-red-600' : 'bg-indigo-600'} flex items-center justify-center text-white font-bold">
                                ${user.full_name.charAt(0)}
                            </div>
                        </div>
                        <div class="mr-4">
                            <div class="text-sm font-medium text-gray-900 flex items-center">
                                ${user.full_name}
                                ${adminBadge}
                            </div>
                            <div class="text-sm text-gray-500">${user.id}</div>
                            ${additionalInfo}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.email}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${joinDate}</td>
                <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    ${actionButtons}
                </td>
            `;
            return row;
        }

        // ×¤×•× ×§×¦×™×” ××¨×›×–×™×ª ×œ×¢×“×›×•×Ÿ ×”×“×©×‘×•×¨×“ ×”×¢×œ×™×•×Ÿ - × ×§×¨××ª ××›×œ ×”××§×•××•×ª
        async function updateDashboardCards() {
            console.log('ğŸ¯ updateDashboardCards() called - UPDATING ALL DASHBOARD CARDS');
            try {
                // ×§×‘×œ ××ª ×›×œ ×”×“×¤×™×
                const pagesResponse = await fetch('/api/all-pages');
                if (!pagesResponse.ok) {
                    throw new Error(`Failed to fetch pages: ${pagesResponse.status}`);
                }
                const allPages = await pagesResponse.json();
                
                // ×§×‘×œ ××ª ×›×œ ×”××©×ª××©×™×
                const usersResponse = await fetch('/api/users');
                if (!usersResponse.ok) {
                    throw new Error(`Failed to fetch users: ${usersResponse.status}`);
                }
                const allUsers = await usersResponse.json();
                
                // ×—×©×‘ × ×ª×•× ×™×
                const totalUsers = allUsers.length;
                const totalPages = allPages.length;
                let activePages = 0;
                let inactivePages = 0;
                
                allPages.forEach(page => {
                    // ×‘×“×•×§ ×× ×”×“×£ ×¤×¢×™×œ - ×¨×§ ×× isActive ××•×’×“×¨ ×‘××¤×•×¨×© ×›-true
                    const isActive = page.isActive === true;
                    if (isActive) {
                        activePages++;
                    } else {
                        // ×›×œ ×“×£ ×©×œ× ×¤×¢×™×œ ×‘××¤×•×¨×© × ×—×©×‘ ×œ× ×¤×¢×™×œ
                        inactivePages++;
                    }
                });
                
                // ×œ×•×’ ××¤×•×¨×˜ ×œ×‘×“×™×§×”
                console.log('ğŸ“Š Page Status Breakdown:', {
                    total: allPages.length,
                    active: activePages,
                    inactive: inactivePages,
                    pagesWithIsActive: allPages.filter(p => p.isActive !== undefined).length,
                    pagesWithIsActiveTrue: allPages.filter(p => p.isActive === true).length,
                    pagesWithIsActiveFalse: allPages.filter(p => p.isActive === false).length,
                    pagesWithIsActiveUndefined: allPages.filter(p => p.isActive === undefined).length,
                    samplePages: allPages.slice(0, 3).map(p => ({ 
                        fileName: p.fileName, 
                        isActive: p.isActive, 
                        type: typeof p.isActive 
                    }))
                });
                
                const monthlyRevenue = activePages * 39;
                
                console.log('ğŸ“Š Dashboard Data:', {
                    totalUsers,
                    totalPages,
                    activePages,
                    inactivePages,
                    monthlyRevenue
                });
                
                // ×¢×“×›×Ÿ ××ª ×›×œ ×”××œ×× ×˜×™×
                const dashboardTotalUsers = document.getElementById('dashboard-total-users');
                const dashboardMonthlyRevenue = document.getElementById('dashboard-monthly-revenue');
                const dashboardActivePages = document.getElementById('dashboard-active-pages');
                const dashboardInactivePages = document.getElementById('dashboard-inactive-pages');
                
                if (dashboardTotalUsers) {
                    dashboardTotalUsers.textContent = totalUsers.toString();
                    console.log('âœ… Updated dashboard-total-users:', totalUsers);
                } else {
                    console.error('âŒ dashboard-total-users element NOT FOUND!');
                }
                
                if (dashboardMonthlyRevenue) {
                    dashboardMonthlyRevenue.textContent = `â‚ª${monthlyRevenue}`;
                    console.log('âœ… Updated dashboard-monthly-revenue:', monthlyRevenue);
                } else {
                    console.error('âŒ dashboard-monthly-revenue element NOT FOUND!');
                }
                
                if (dashboardActivePages) {
                    dashboardActivePages.textContent = activePages.toString();
                    console.log('âœ… Updated dashboard-active-pages:', activePages);
                } else {
                    console.error('âŒ dashboard-active-pages element NOT FOUND!');
                }
                
                if (dashboardInactivePages) {
                    dashboardInactivePages.textContent = inactivePages.toString();
                    console.log('âœ… Updated dashboard-inactive-pages:', inactivePages);
                } else {
                    console.error('âŒ dashboard-inactive-pages element NOT FOUND!');
                    // × ×¡×” ×œ××¦×•× ××ª ×”××œ×× ×˜ ×‘×“×¨×›×™× ××—×¨×•×ª
                    const altElement = document.querySelector('#dashboard-inactive-pages');
                    if (altElement) {
                        altElement.textContent = inactivePages.toString();
                        console.log('âœ… Found dashboard-inactive-pages via querySelector');
                    }
                }
                
            } catch (error) {
                console.error('âŒ Error in updateDashboardCards:', error);
            }
        }

        async function loadFinanceData() {
            console.log('ğŸš€ loadFinanceData() called');
            // ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“ ×”×¢×œ×™×•×Ÿ ××™×“
            await updateDashboardCards();
            
            // ×˜×¢×Ÿ × ×ª×•× ×™× ×××™×ª×™×™× ××”×©×¨×ª
            try {
                console.log('ğŸ“¡ Fetching /api/all-pages...');
                // ×§×‘×œ ××ª ×›×œ ×”×“×¤×™× ×‘××¢×¨×›×ª ××”×©×¨×ª
                const response = await fetch('/api/all-pages');
                if (!response.ok) {
                    console.error('âŒ Failed to fetch /api/all-pages:', response.status, response.statusText);
                    throw new Error(`Failed to fetch: ${response.status}`);
                }
                const allPages = await response.json();
                console.log('âœ… Received allPages:', allPages.length, 'pages');
                
                console.log('ğŸ“Š All pages in system:', allPages.length);
                console.log('ğŸ“Š Pages with isActive:', allPages.filter(p => p.isActive !== undefined).length);
                console.log('ğŸ“Š Pages with isActive=true:', allPages.filter(p => p.isActive === true).length);
                console.log('ğŸ“Š Pages with isActive=false:', allPages.filter(p => p.isActive === false).length);
                console.log('ğŸ“Š Pages with isActive undefined:', allPages.filter(p => p.isActive === undefined).length);
                
                // ×œ×•×’ ××¤×•×¨×˜ ×©×œ ×›×œ ×”×“×¤×™× ×¢× isActive
                console.log('ğŸ“‹ All pages with isActive status:');
                allPages.forEach((p, index) => {
                    console.log(`  ${index + 1}. ${p.fileName} | userId: ${p.userId} | isActive: ${p.isActive} (type: ${typeof p.isActive})`);
                });
                
                // ×§×‘×œ ××ª ××¡×¤×¨ ×”××©×ª××©×™× ×”×›×•×œ×œ ×‘××¢×¨×›×ª
                console.log('ğŸ“¡ Fetching /api/users...');
                const usersResponse = await fetch('/api/users');
                if (!usersResponse.ok) {
                    console.error('âŒ Failed to fetch /api/users:', usersResponse.status, usersResponse.statusText);
                    throw new Error(`Failed to fetch users: ${usersResponse.status}`);
                }
                const users = await usersResponse.json();
                const totalUsersInSystem = users.length;
                console.log('âœ… Received users:', totalUsersInSystem, 'users');
                
                console.log('ğŸ‘¥ Total users in system:', totalUsersInSystem);
                console.log('ğŸ‘¥ Users:', users.map(u => ({ id: u.id, email: u.email, pages: u.totalPages })));
                
                // ×—×©×‘ ×× ×•×™×™× ×¤×¢×™×œ×™× ×•×œ× ×¤×¢×™×œ×™×
                // ×‘×“×•×§ localStorage ×©×œ ×”××©×ª××© ×”× ×•×›×—×™ (×”×× ×”×œ) ×œ×× ×•×™×™× ×¤×¢×™×œ×™×
                const totalPages = allPages.length;
                
                let activeSubscriptions = 0;
                let inactivePages = 0;
                
                // ×‘×“×•×§ ×›×œ ×“×£ - ×”×× ×™×© ×× ×•×™ ×¤×¢×™×œ (×-metadata.json ×‘×©×¨×ª)
                allPages.forEach(page => {
                    // ×”×©×ª××© ×‘-isActive ××”×©×¨×ª (×-metadata.json) ×‘××§×•× localStorage
                    // ×‘×“×•×§ ×’× ×× isActive ×œ× ××•×’×“×¨ (undefined) - × ×—×©×‘ ×›×œ× ×¤×¢×™×œ
                    const isActive = page.isActive === true;
                    
                    // ×œ×•×’ ××¤×•×¨×˜ ×œ×›×œ ×”×“×¤×™×
                    console.log(`ğŸ“„ Page: ${page.fileName} | isActive: ${page.isActive} | type: ${typeof page.isActive} | will count as: ${isActive ? 'ACTIVE' : 'INACTIVE'}`);
                    
                    if (isActive) {
                        console.log(`âœ… Active page: ${page.fileName} (userId: ${page.userId})`);
                            activeSubscriptions++;
                        } else {
                        inactivePages++;
                    }
                });
                const monthlyRevenue = activeSubscriptions * 39; // â‚ª39 ×œ×›×œ ×“×£ ×¤×¢×™×œ ×‘×œ×‘×“
                
                console.log('Finance Data:', {
                    totalPages,
                    totalUsersInSystem,
                    activeSubscriptions,
                    inactivePages,
                    monthlyRevenue,
                    pages: allPages.map(p => ({ name: p.title, fileName: p.fileName, userId: p.userId, isActive: p.isActive }))
                });
                
                // ×œ×•×’ × ×•×¡×£ ×œ×‘×“×™×§×”
                console.log('Active pages details:', allPages.filter(p => p.isActive === true).map(p => ({ 
                    fileName: p.fileName, 
                    userId: p.userId, 
                    isActive: p.isActive 
                })));
                
                // ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“
                const monthlyRevenueEl = document.getElementById('monthly-revenue');
                const activeUsersEl = document.getElementById('active-users');
                const totalPagesEl = document.getElementById('total-pages');
                
                if (monthlyRevenueEl) monthlyRevenueEl.textContent = `â‚ª${monthlyRevenue}`;
                if (activeUsersEl) activeUsersEl.textContent = totalUsersInSystem.toString();
                if (totalPagesEl) totalPagesEl.textContent = totalPages.toString();
                
                // ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“ ×”×¢×œ×™×•×Ÿ - ×›×‘×¨ × ×¢×©×” ×‘-updateDashboardCards ×‘×ª×—×™×œ×ª ×”×¤×•× ×§×¦×™×”
                
                // ×œ×•×’ ×¡×™×›×•×
                console.log('ğŸ“Š Dashboard Summary:', {
                    totalUsers: totalUsersInSystem,
                    activePages: activeSubscriptions,
                    inactivePages: inactivePages,
                    monthlyRevenue: monthlyRevenue,
                    totalPages: totalPages
                });
                
            } catch (error) {
                console.error('âŒ Error loading finance data:', error);
                console.error('Error stack:', error.stack);
                // × ×ª×•× ×™× ×“××• ×‘××§×¨×” ×©×œ ×©×’×™××”
                const monthlyRevenueEl = document.getElementById('monthly-revenue');
                const activeUsersEl = document.getElementById('active-users');
                const totalPagesEl = document.getElementById('total-pages');
                
                if (monthlyRevenueEl) monthlyRevenueEl.textContent = 'â‚ª0';
                if (activeUsersEl) activeUsersEl.textContent = '1';
                if (totalPagesEl) totalPagesEl.textContent = '0';
                
                // ×¢×“×›×Ÿ ×’× ××ª ×”×“×©×‘×•×¨×“ ×”×¨××©×™
                const dashboardTotalUsers = document.getElementById('dashboard-total-users');
                const dashboardMonthlyRevenue = document.getElementById('dashboard-monthly-revenue');
                const dashboardActivePages = document.getElementById('dashboard-active-pages');
                const dashboardInactivePages = document.getElementById('dashboard-inactive-pages');
                
                if (dashboardTotalUsers) dashboardTotalUsers.textContent = '0';
                if (dashboardMonthlyRevenue) dashboardMonthlyRevenue.textContent = 'â‚ª0';
                if (dashboardActivePages) dashboardActivePages.textContent = '0';
                if (dashboardInactivePages) dashboardInactivePages.textContent = '0';
            }

            // ×˜×¢×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×ª×©×œ×•××™×
            const paymentsTableBody = document.getElementById('payments-table-body');
            paymentsTableBody.innerHTML = '';

            // ×¦×•×¨ ×ª×©×œ×•××™× ×××™×ª×™×™× ×¢×œ ×‘×¡×™×¡ ×”×“×¤×™× ×¢× ×× ×•×™×™× ×¤×¢×™×œ×™×
            const allPagesResponse = await fetch('/api/all-pages');
            const allPages = await allPagesResponse.json();
            
            const realPayments = [];
            
            allPages.forEach((page, index) => {
                // ×‘×“×•×§ ×× ×™×© ×× ×•×™ ×¤×¢×™×œ ×œ×“×£ ×”×–×”
                const pageSubscription = localStorage.getItem(`page_subscription_${page.fileName}`);
                if (pageSubscription) {
                    const subscription = JSON.parse(pageSubscription);
                    if (subscription.isActive) {
                        // ×¨×§ ×“×¤×™× ×¢× ×× ×•×™ ×¤×¢×™×œ × ×—×©×‘×™× ×›×ª×©×œ×•×
                        realPayments.push({
                            user: currentUser?.user_metadata?.full_name || '××©×ª××©',
                            amount: 'â‚ª39',
                            date: new Date(subscription.purchaseDate || page.created_at || Date.now() - (index * 86400000)).toLocaleDateString('he-IL'),
                            status: 'completed',
                            pageName: page.title || '×“×£ × ×—×™×ª×”'
                        });
                    }
                }
            });
            
            console.log('Real Payments:', realPayments);
            
            // ×× ××™×Ÿ ×ª×©×œ×•××™×, ×”×•×¡×£ ×”×•×“×¢×”
            const demoPayments = realPayments.length > 0 ? realPayments : [{
                user: '××™×Ÿ ×ª×©×œ×•××™×',
                amount: 'â‚ª0',
                date: '-',
                status: 'none',
                pageName: '××™×Ÿ ×“×¤×™× ×¢× ×× ×•×™ ×¤×¢×™×œ'
            }];

            demoPayments.forEach(payment => {
                const row = document.createElement('tr');
                let statusBadge;
                
                if (payment.status === 'completed') {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">×”×•×©×œ×</span>';
                } else if (payment.status === 'none') {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">××™×Ÿ × ×ª×•× ×™×</span>';
                } else {
                    statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">×××ª×™×Ÿ</span>';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.user}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.amount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${payment.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                `;
                paymentsTableBody.appendChild(row);
            });
        }
        async function loadAnalyticsData() {
            // ×˜×¢×Ÿ × ×ª×•× ×™× ×××™×ª×™×™× ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª
            try {
                const response = await fetch('/api/all-pages');
                const allPages = await response.json();
                
                // ×—×©×‘ ×“×¤×™× ×©× ×•×¦×¨×• ×”×©×‘×•×¢
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                const weeklyPages = allPages.filter(page => {
                    const pageDate = new Date(page.created_at || Date.now());
                    return pageDate >= weekAgo;
                }).length;
                
                // ×—×©×‘ ×× ×•×™×™× ×¤×¢×™×œ×™× ×”×©×‘×•×¢ - ×¨×§ ×“×¤×™× ×©× ×•×¦×¨×• ×”×©×‘×•×¢ ×•×™×© ×œ×”× ×× ×•×™ ×¤×¢×™×œ
                let weeklyActiveSubscriptions = 0;
                let weeklyRevenue = 0;
                
                allPages.forEach(page => {
                    const pageDate = new Date(page.created_at || Date.now());
                    const isWeekly = pageDate >= weekAgo;
                    
                    // ×”×©×ª××© ×‘-isActive ××”×©×¨×ª (×-metadata.json)
                    const isActive = page.isActive === true;
                    
                    if (isWeekly && isActive) {
                            weeklyActiveSubscriptions++;
                            weeklyRevenue += 39;
                    }
                });
                
                console.log('Analytics Data:', {
                    weeklyPages,
                    weeklyActiveSubscriptions,
                    weeklyRevenue,
                    totalPages: allPages.length
                });
                
                // ×¢×“×›×Ÿ ××ª ×”×¡×˜×˜×™×¡×˜×™×§×•×ª
                const weeklyNewUsers = document.getElementById('weekly-new-users');
                const weeklyNewPages = document.getElementById('weekly-new-pages');
                const weeklyRevenueEl = document.getElementById('weekly-revenue');
                const conversionRate = document.getElementById('conversion-rate');
                
                // ××©×ª××©×™× ××—×•×‘×¨×™× - ×›×¨×’×¢ ×¨×§ ×”×× ×”×œ ××—×•×‘×¨
                const totalUsers = 1; // ×¨×§ ×”×× ×”×œ ××—×•×‘×¨ ×›×¨×’×¢
                
                if (weeklyNewUsers) weeklyNewUsers.textContent = "1"; // ××©×ª××© ×—×“×© ×”×©×‘×•×¢ (×”×× ×”×œ)
                if (weeklyNewPages) weeklyNewPages.textContent = weeklyPages.toString();
                if (weeklyRevenueEl) weeklyRevenueEl.textContent = `â‚ª${weeklyRevenue}`;
                
                // ×—×©×‘ ×©×™×¢×•×¨ ×”××¨×” - ×“×¤×™× ×¤×¢×™×œ×™× ××ª×•×š ×¡×”"×› ×“×¤×™×
                // ×¡×¤×•×¨ ×“×¤×™× ×¤×¢×™×œ×™× ×œ×¤×™ isActive ××”×©×¨×ª (×-metadata.json)
                const totalActiveSubscriptions = allPages.filter(page => page.isActive === true).length;
                const conversionRateValue = allPages.length > 0 ? Math.round((totalActiveSubscriptions / allPages.length) * 100) : 0;
                if (conversionRate) conversionRate.textContent = `${conversionRateValue}%`;
                
                // ×˜×¢×Ÿ ×¤×¢×™×œ×•×ª ×××™×ª×™×ª
                await loadRecentActivity(allPages);
                
                // ×¢×“×›×Ÿ ×’×¨×¤×™×
                await updateAnalyticsCharts(allPages, totalUsers);
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
            }
        }

        // ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×ª×§×•×¤×ª ×”×¤×¢×™×œ×•×ª ×”× ×•×›×—×™×ª
        let currentActivityPeriod = 'weekly';

        async function updateAnalyticsCharts(allPages, totalUsers) {
            try {
                // ×—×©×‘ × ×ª×•× ×™× ×œ×’×¨×¤×™× - ×‘×“×•×§ localStorage ×œ×× ×•×™×™× ×¤×¢×™×œ×™×
                const totalPages = allPages.length;
                let activePages = 0;
                let inactivePages = 0;
                let weeklyActivePages = 0;
                
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                
                // ×‘×“×•×§ ×›×œ ×“×£ - ×”×× ×™×© ×× ×•×™ ×¤×¢×™×œ (×-metadata.json ×‘×©×¨×ª)
                allPages.forEach(page => {
                    // ×”×©×ª××© ×‘-isActive ××”×©×¨×ª (×-metadata.json) ×‘××§×•× localStorage
                    const isActive = page.isActive === true;
                    const pageDate = new Date(page.created_at || Date.now());
                    const isWeekly = pageDate >= weekAgo;
                    
                    if (isActive) {
                            activePages++;
                            // ×‘×“×•×§ ×× ×–×” ×”×©×‘×•×¢
                        if (isWeekly) {
                                weeklyActivePages++;
                        }
                    } else {
                        inactivePages++;
                    }
                });
                
                const percentage = totalPages > 0 ? Math.round((activePages / totalPages) * 100) : 0;
                const monthlyRevenue = activePages * 39;
                const potentialRevenue = totalPages * 39;
                
                // ×¢×“×›×Ÿ ×’×¨×£ ×¡×˜×˜×•×¡ ×“×¤×™×
                const pagesProgress = document.getElementById('pages-progress');
                const pagesPercentage = document.getElementById('pages-percentage');
                const activePagesCount = document.getElementById('active-pages-count');
                const inactivePagesCount = document.getElementById('inactive-pages-count');
                
                if (pagesProgress) {
                    const circumference = 251.2; // 2 * Ï€ * 40
                    const offset = circumference - (percentage / 100) * circumference;
                    pagesProgress.style.strokeDashoffset = offset;
                }
                
                if (pagesPercentage) pagesPercentage.textContent = `${percentage}%`;
                if (activePagesCount) activePagesCount.textContent = activePages.toString();
                if (inactivePagesCount) inactivePagesCount.textContent = inactivePages.toString();
                
                // ×¢×“×›×Ÿ ×’×¨×£ ×”×›× ×¡×•×ª
                const monthlyRevenueDisplay = document.getElementById('monthly-revenue-display');
                const revenueActivePages = document.getElementById('revenue-active-pages');
                const revenueInactivePages = document.getElementById('revenue-inactive-pages');
                const revenuePotential = document.getElementById('revenue-potential');
                
                if (monthlyRevenueDisplay) monthlyRevenueDisplay.textContent = `â‚ª${monthlyRevenue}`;
                if (revenueActivePages) revenueActivePages.textContent = activePages.toString();
                if (revenueInactivePages) revenueInactivePages.textContent = inactivePages.toString();
                if (revenuePotential) revenuePotential.textContent = `â‚ª${potentialRevenue}`;
                
                // ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×œ×©×™××•×© ×‘×¤×•× ×§×¦×™×•×ª ××—×¨×•×ª
                window.allPagesData = allPages;
                
                // ×¢×“×›×Ÿ ×¤×¢×™×œ×•×ª ×œ×¤×™ ×”×ª×§×•×¤×” ×©× ×‘×—×¨×”
                updateActivityChart(allPages);
                
                const weeklyRevenue = weeklyActivePages * 39;
                
                const weeklyPagesCreatedEl = document.getElementById('weekly-pages-created');
                const weeklyPagesActivatedEl = document.getElementById('weekly-pages-activated');
                const weeklyRevenueDisplay = document.getElementById('weekly-revenue-display');
                
                if (weeklyPagesCreatedEl) weeklyPagesCreatedEl.textContent = weeklyPagesCreated.toString();
                if (weeklyPagesActivatedEl) weeklyPagesActivatedEl.textContent = weeklyActivePages.toString();
                if (weeklyRevenueDisplay) weeklyRevenueDisplay.textContent = `â‚ª${weeklyRevenue}`;
                
                // ×¢×“×›×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××©×ª××©×™×
                // ×§×‘×œ ××ª ××¡×¤×¨ ×”××©×ª××©×™× ×”×›×•×œ×œ ×‘××¢×¨×›×ª
                const usersResponse = await fetch('/api/users');
                const allUsers = await usersResponse.json();
                const totalUsersInSystem = allUsers.length;
                
                console.log('ğŸ“Š updateAnalyticsCharts - totalUsersInSystem:', totalUsersInSystem);
                console.log('ğŸ“Š updateAnalyticsCharts - activePages:', activePages);
                console.log('ğŸ“Š updateAnalyticsCharts - monthlyRevenue:', monthlyRevenue);
                
                // ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“ ×”×¢×œ×™×•×Ÿ
                await updateDashboardCards();
                
                const activeUsers = 1; // ×¨×§ ×”×× ×”×œ ××—×•×‘×¨ ×›×¨×’×¢
                const inactiveUsers = Math.max(0, totalUsersInSystem - activeUsers); // ××©×ª××©×™× ×œ× ××—×•×‘×¨×™×
                const conversionRate = totalPages > 0 ? Math.round((activePages / totalPages) * 100) : 0;
                
                const totalUsersCount = document.getElementById('total-users-count');
                const activeUsersCount = document.getElementById('active-users-count');
                const inactiveUsersCount = document.getElementById('inactive-users-count');
                const conversionRateDisplay = document.getElementById('conversion-rate-display');
                
                if (totalUsersCount) totalUsersCount.textContent = totalUsersInSystem.toString();
                if (activeUsersCount) activeUsersCount.textContent = activeUsers.toString();
                if (inactiveUsersCount) inactiveUsersCount.textContent = inactiveUsers.toString();
                if (conversionRateDisplay) conversionRateDisplay.textContent = `${conversionRate}%`;
                
            } catch (error) {
                console.error('Error updating analytics charts:', error);
            }
        }
        function changeActivityPeriod(period) {
            currentActivityPeriod = period;
            
            // ×¢×“×›×Ÿ ××ª ×¢×™×¦×•×‘ ×”×›×¤×ª×•×¨×™×
            document.getElementById('daily-btn').className = 'px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md transition-colors';
            document.getElementById('weekly-btn').className = 'px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md transition-colors';
            document.getElementById('monthly-btn').className = 'px-3 py-1 text-sm font-medium text-gray-600 hover:text-gray-900 rounded-md transition-colors';
            
            if (period === 'daily') {
                document.getElementById('daily-btn').className = 'px-3 py-1 text-sm font-medium bg-white text-gray-900 shadow-sm rounded-md transition-colors';
            } else if (period === 'weekly') {
                document.getElementById('weekly-btn').className = 'px-3 py-1 text-sm font-medium bg-white text-gray-900 shadow-sm rounded-md transition-colors';
            } else if (period === 'monthly') {
                document.getElementById('monthly-btn').className = 'px-3 py-1 text-sm font-medium bg-white text-gray-900 shadow-sm rounded-md transition-colors';
            }
            
            // ×¢×“×›×Ÿ ××ª ×”×’×¨×£
            updateActivityChart(window.allPagesData || []);
        }
        function updateActivityChart(allPages) {
            const now = new Date();
            let periodAgo, periodLabel, createdLabel, activatedLabel;
            
            if (currentActivityPeriod === 'daily') {
                periodAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                periodLabel = '×”×™×•×';
                createdLabel = '×“×¤×™× ×©× ×•×¦×¨×• ×”×™×•×';
                activatedLabel = '×“×¤×™× ×©×”×•×¤×¢×œ×• ×”×™×•×';
            } else if (currentActivityPeriod === 'weekly') {
                periodAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                periodLabel = '×”×©×‘×•×¢';
                createdLabel = '×“×¤×™× ×©× ×•×¦×¨×• ×”×©×‘×•×¢';
                activatedLabel = '×“×¤×™× ×©×”×•×¤×¢×œ×• ×”×©×‘×•×¢';
            } else {
                periodAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                periodLabel = '×”×—×•×“×©';
                createdLabel = '×“×¤×™× ×©× ×•×¦×¨×• ×”×—×•×“×©';
                activatedLabel = '×“×¤×™× ×©×”×•×¤×¢×œ×• ×”×—×•×“×©';
            }
            
            const pagesCreated = allPages.filter(page => {
                const pageDate = new Date(page.created_at || Date.now());
                return pageDate >= periodAgo;
            }).length;
            
            const pagesActivated = allPages.filter(page => {
                const pageDate = new Date(page.created_at || Date.now());
                const pageSubscription = localStorage.getItem(`page_subscription_${page.fileName}`);
                return pageDate >= periodAgo && pageSubscription;
            }).length;
            
            // ×¢×“×›×Ÿ ××ª ×”×ª×•×›×Ÿ ×‘×’×¨×£
            const chartContainer = document.getElementById('weekly-activity-chart');
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-blue-500 rounded-full ml-2"></div>
                                <span class="text-sm text-gray-600">${createdLabel}</span>
                            </div>
                            <span class="text-lg font-semibold text-blue-600" id="period-pages-created">${pagesCreated}</span>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full ml-2"></div>
                                <span class="text-sm text-gray-600">${activatedLabel}</span>
                            </div>
                            <span class="text-lg font-semibold text-green-600" id="period-pages-activated">${pagesActivated}</span>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-purple-500 rounded-full ml-2"></div>
                                <span class="text-sm text-gray-600">×”×›× ×¡×•×ª ${periodLabel}</span>
                            </div>
                            <span class="text-lg font-semibold text-purple-600">â‚ª${pagesActivated * 39}</span>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-orange-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-orange-500 rounded-full ml-2"></div>
                                <span class="text-sm text-gray-600">×©×™×¢×•×¨ ×”××¨×” ${periodLabel}</span>
                            </div>
                            <span class="text-lg font-semibold text-orange-600">${pagesCreated > 0 ? Math.round((pagesActivated / pagesCreated) * 100) : 0}%</span>
                        </div>
                    </div>
                `;
            }
        }

        async function loadRecentActivity(allPages) {
            try {
                const recentActivityContainer = document.getElementById('recent-activity');
                recentActivityContainer.innerHTML = '';
                
                // ×¦×•×¨ ×¨×©×™××ª ×¤×¢×™×œ×•×™×•×ª ×›×•×œ×œ ×™×¦×™×¨×ª ×“×¤×™× ×•×¤×¨×¡×•×
                const activities = [];
                
                // ×”×•×¡×£ ×¤×¢×™×œ×•×ª ×™×¦×™×¨×ª ×“×¤×™×
                allPages.forEach(page => {
                    activities.push({
                        type: 'created',
                        page: page,
                        date: new Date(page.created_at),
                        timestamp: new Date(page.created_at).getTime()
                    });
                });
                
                // ×”×•×¡×£ ×¤×¢×™×œ×•×ª ×¤×¨×¡×•× ×“×¤×™× (×× ×•×™×™×)
                const subscriptionKeys = Object.keys(localStorage).filter(key => key.includes('page_subscription'));
                subscriptionKeys.forEach(key => {
                    try {
                        const subscription = JSON.parse(localStorage.getItem(key));
                        if (subscription && subscription.isActive) {
                            // ××¦× ××ª ×”×“×£ ×”××ª××™×
                            const page = allPages.find(p => 
                                p.fileName === subscription.pageId || 
                                p.id === subscription.pageId ||
                                key.includes(p.fileName) ||
                                key.includes(p.id)
                            );
                            
                            if (page) {
                                activities.push({
                                    type: 'published',
                                    page: page,
                                    subscription: subscription,
                                    date: new Date(subscription.startDate || subscription.endDate),
                                    timestamp: new Date(subscription.startDate || subscription.endDate).getTime()
                                });
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing subscription:', e);
                    }
                });
                
                // ××™×•×Ÿ ×›×œ ×”×¤×¢×™×œ×•×™×•×ª ×œ×¤×™ ×ª××¨×™×š (×”×—×“×©×™× ×‘×™×•×ª×¨ ×¨××©×•×Ÿ)
                activities.sort((a, b) => b.timestamp - a.timestamp);
                
                // ×”×¦×’ ××ª 10 ×”×¤×¢×™×œ×•×™×•×ª ×”××—×¨×•× ×•×ª
                const recentActivities = activities.slice(0, 10);
                
                if (recentActivities.length === 0) {
                    recentActivityContainer.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            <p>××™×Ÿ ×¤×¢×™×œ×•×ª ××—×¨×•× ×”</p>
                        </div>
                    `;
                    return;
                }
                
                recentActivities.forEach((activity, index) => {
                    const timeAgo = getTimeAgo(activity.date);
                    const activityItem = document.createElement('div');
                    activityItem.className = 'flex items-center';
                    
                    // ×‘×—×¨ ××™×™×§×•×Ÿ ×•×˜×§×¡×˜ ×œ×¤×™ ×¡×•×’ ×”×¤×¢×™×œ×•×ª
                    let iconBg, iconColor, activityText;
                    if (activity.type === 'published') {
                        iconBg = 'bg-green-100';
                        iconColor = 'text-green-600';
                        activityText = '×“×£ ×¤×•×¨×¡×';
                    } else {
                        iconBg = 'bg-blue-100';
                        iconColor = 'text-blue-600';
                        activityText = '×“×£ ×—×“×© × ×•×¦×¨';
                    }
                    
                    activityItem.innerHTML = `
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 ${iconBg} rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    ${activity.type === 'published' ? 
                                        `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>` :
                                        `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>`
                                    }
                                </svg>
                            </div>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-900">${activityText}</p>
                            <p class="text-sm text-gray-500">${activity.page.title || '×“×£ × ×—×™×ª×”'}</p>
                        </div>
                        <div class="mr-auto text-sm text-gray-500">${timeAgo}</div>
                    `;
                    
                    recentActivityContainer.appendChild(activityItem);
                });
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return '×œ×¤× ×™ ×¨×’×¢';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `×œ×¤× ×™ ${minutes} ×“×§×•×ª`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `×œ×¤× ×™ ${hours} ×©×¢×•×ª`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `×œ×¤× ×™ ${days} ×™××™×`;
            }
        }

        function toggleUserStatus(userId) {
            console.log('Toggling user status for:', userId);
            showSuccess('×¡×˜×˜×•×¡ ×”××©×ª××© ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
            loadUsersData(); // ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××”
        }

        function deleteUser(userId) {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××©×ª××©?')) {
                console.log('Deleting user:', userId);
                showSuccess('×”××©×ª××© × ××—×§ ×‘×”×¦×œ×—×”');
                loadUsersData(); // ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××”
            }
        }

        async function viewUserPages(userId) {
            try {
                // ×§×‘×œ ××ª ×›×œ ×”×“×¤×™× ×©×œ ×”××©×ª××©
                const response = await fetch(`/api/pages/${userId}`);
                const data = await response.json();
                // ×ª××•×š ×‘×©× ×™ ×¤×•×¨××˜×™×: {pages: []} ××• []
                const userPages = Array.isArray(data) ? data : (data.pages || []);
                
                console.log('User pages:', userPages);
                
                // ×¤×ª×— ××•×“×œ ×¢× ×¨×©×™××ª ×”×“×¤×™×
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-900">×“×¤×™× ×©×œ ×”××©×ª××©</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${userPages.map((page, index) => {
                                    const fileName = page.fileName || page.name || '';
                                    const pageTitle = page.title || page.name || '×“×£ × ×—×™×ª×”';
                                    const isActive = page.isActive === true ? 
                                        '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-2">×¤×¢×™×œ</span>' :
                                        '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 mr-2">×œ× ×¤×¢×™×œ</span>';
                                    return `
                                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:border-indigo-400 transition">
                                        <h4 class="font-medium text-gray-900 mb-2 flex items-center flex-wrap gap-2">
                                            ${pageTitle}
                                            ${isActive}
                                        </h4>
                                        <p class="text-sm text-gray-600 mb-2">${fileName}</p>
                                        <p class="text-xs text-gray-500 mb-3">×¡×•×’: ${page.pageType || 'other'}</p>
                                        <div class="flex gap-2 flex-wrap">
                                            <button onclick="viewUserPage('${fileName}', '${userId}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-sm font-medium transition">
                                                ğŸ‘ï¸ ×¦×¤×”
                                            </button>
                                            <button onclick="editUserPage('${fileName}', '${userId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-medium transition">
                                                âœï¸ ×¢×¨×•×š
                                            </button>
                                            ${page.isActive === true ? 
                                                `<button onclick="deactivateUserPage('${fileName}', '${userId}')" class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1.5 rounded text-sm font-medium transition">
                                                    â¸ï¸ ×‘×˜×œ ×”×¤×¢×œ×”
                                                </button>` :
                                                `<button onclick="activateUserPage('${fileName}', '${userId}')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded text-sm font-medium transition">
                                                    â–¶ï¸ ×”×¤×¢×œ
                                                </button>`
                                            }
                                            <button onclick="deleteUserPage('${fileName}', '${userId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm font-medium transition">
                                                ğŸ—‘ï¸ ××—×§
                                            </button>
                                        </div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                            ${userPages.length === 0 ? '<p class="text-gray-500 text-center">××™×Ÿ ×“×¤×™× ×œ××©×ª××© ×”×–×”</p>' : ''}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error loading user pages:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×“×¤×™ ×”××©×ª××©');
            }
        }

        function editUserPage(fileName, userId = null) {
            // ×¤×ª×— ××ª ×¢×•×¨×š ×”×“×¤×™× ×¢× ×”×“×£ ×©×œ ×”××©×ª××©
            const targetUserId = userId || currentUser.id;
            const cleanFileName = fileName.replace('_html', '').replace('.html', '');
            window.open(`/page-creator/page-creator.html?edit=${cleanFileName}&userId=${targetUserId}`, '_blank');
        }

        function viewUserPage(fileName, userId) {
            // ×¦×¤×” ×‘×“×£ ×©×œ ×”××©×ª××© (×›×× ×”×œ)
            const cleanFileName = fileName.replace('_html', '').replace('.html', '');
            const pageUrl = `/pages/${userId}/${cleanFileName}_html`;
            console.log('ğŸ‘ï¸ Admin viewing user page:', pageUrl);
            window.open(pageUrl, '_blank');
        }

        async function activateUserPage(fileName, userId) {
            // ×”×¤×¢×œ ×“×£ ×©×œ ××©×ª××© (×›×× ×”×œ)
            const cleanFileName = fileName.replace('_html', '').replace('.html', '');
            try {
                const response = await fetch('/api/subscription/activate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        pageId: cleanFileName
                    })
                });
                
                if (response.ok) {
                    alert('×”×“×£ ×”×•×¤×¢×œ ×‘×”×¦×œ×—×”!');
                    viewUserPages(userId); // ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××”
                    updateDashboardCards(); // ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“
                } else {
                    const error = await response.json();
                    alert('×©×’×™××” ×‘×”×¤×¢×œ×ª ×”×“×£: ' + (error.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
                }
            } catch (error) {
                console.error('Error activating page:', error);
                alert('×©×’×™××” ×‘×”×¤×¢×œ×ª ×”×“×£');
            }
        }

        async function deactivateUserPage(fileName, userId) {
            // ×‘×˜×œ ×”×¤×¢×œ×” ×©×œ ×“×£ ×©×œ ××©×ª××© (×›×× ×”×œ)
            const cleanFileName = fileName.replace('_html', '').replace('.html', '');
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×˜×œ ××ª ×”×¤×¢×œ×ª ×”×“×£?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/subscription/deactivate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        pageId: cleanFileName
                    })
                });
                
                if (response.ok) {
                    alert('×”×¤×¢×œ×ª ×”×“×£ ×‘×•×˜×œ×” ×‘×”×¦×œ×—×”!');
                    viewUserPages(userId); // ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××”
                    updateDashboardCards(); // ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“
                } else {
                    const error = await response.json();
                    alert('×©×’×™××” ×‘×‘×™×˜×•×œ ×”×¤×¢×œ×”: ' + (error.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
                }
            } catch (error) {
                console.error('Error deactivating page:', error);
                alert('×©×’×™××” ×‘×‘×™×˜×•×œ ×”×¤×¢×œ×”');
            }
        }

        async function deleteUserPage(fileName, userId) {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×“×£?')) {
                try {
                    const response = await fetch(`/api/delete-page`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ fileName, userId })
                    });
                    
                    if (response.ok) {
                        alert('×”×“×£ × ××—×§ ×‘×”×¦×œ×—×”');
                        viewUserPages(userId); // ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××”
                    } else {
                        alert('×©×’×™××” ×‘××—×™×§×ª ×”×“×£');
                    }
                } catch (error) {
                    console.error('Error deleting page:', error);
                    alert('×©×’×™××” ×‘××—×™×§×ª ×”×“×£');
                }
            }
        }

        
        // --- ×¤×•× ×§×¦×™×•×ª ×¡×™×›×•× ×—×©×‘×•×Ÿ ---
        async function updateAccountSummary() {
            console.log('=== updateAccountSummary called ===');
            
            if (!currentUser || !currentUser.id) {
                console.log('No current user, skipping account summary update');
                return;
            }
            
            try {
                // ×§×‘×œ ××ª ×”×“×¤×™× ××”×©×¨×ª (×›××• ×‘-loadProjects)
                console.log('Fetching pages from server...');
                const response = await fetch(`/api/pages/${currentUser.id}`);
                const serverData = await response.json();
                const serverPages = serverData.pages || [];
                console.log('Server pages:', serverPages);
                
                // ×§×‘×œ ×’× ×“×¤×™× ××§×•××™×™×
                const localData = JSON.parse(localStorage.getItem('autopage_data') || '{}');
                const localPages = localData.pages || [];
                console.log('Local pages:', localPages);
                
                // ×©×œ×‘ ××ª ×”×“×¤×™× ××”×©×¨×ª ×•×”×“×¤×™× ×”××§×•××™×™×
                const allPages = [...serverPages, ...localPages];
                console.log('All pages combined:', allPages);
                
                // ×—×©×‘ ×× ×•×™×™× ×¤×¢×™×œ×™×
                let activeSubscriptions = 0;
                let totalRevenue = 0;
                
                console.log('Checking subscriptions for pages...');
                allPages.forEach((page, index) => {
                    // ×”×©×ª××© ×‘××•×ª×• ××¤×ª×— ×›××• ×‘-loadProjects - project.id
                    const pageKey = page.id || `local_${page.fileName}`;
                    const pageSubscription = localStorage.getItem(`page_subscription_${pageKey}`);
                    console.log(`Page ${index + 1}: ${pageKey}, subscription:`, pageSubscription);
                    
                    if (pageSubscription) {
                        const subscription = JSON.parse(pageSubscription);
                        console.log(`Subscription data:`, subscription);
                        if (subscription.isActive) {
                            activeSubscriptions++;
                            totalRevenue += 39;
                            console.log(`Active subscription found for: ${pageKey}`);
                        }
                    }
                });
                
                console.log(`Total active subscriptions: ${activeSubscriptions}`);
                
                // ×¢×“×›×Ÿ ××ª ×”×¡×™×›×•×
                document.getElementById('account-total-pages').textContent = allPages.length;
                document.getElementById('account-active-pages').textContent = activeSubscriptions;
                
                // ×¢×“×›×Ÿ ××ª ×”×ª×¦×•×’×•×ª ×”××§×“×™××•×ª ×”×§×˜× ×•×ª
                document.getElementById('total-pages-icon').textContent = allPages.length;
                document.getElementById('active-pages-icon').textContent = activeSubscriptions;
                
                // ×—×©×‘ ×—×™×•×‘ ×—×•×“×©×™ (â‚ª39 ×œ×›×œ ×“×£ ×¤×¢×™×œ ×‘×œ×‘×“)
                const monthlyCharge = activeSubscriptions * 39;
                document.getElementById('account-monthly-charge').textContent = `â‚ª${monthlyCharge}`;
                document.getElementById('monthly-charge-amount').textContent = monthlyCharge;
                
                // ×¢×“×›×Ÿ ×–××Ÿ ×¢×“×›×•×Ÿ ××—×¨×•×Ÿ
                const lastUpdateTime = new Date().toLocaleString('he-IL');
                
                // ×¢×“×›×Ÿ ××ª ×”××•×“×œ ×¨×§ ×× ×”××©×ª××© ×‘×™×§×© ×–××ª ×‘××¤×•×¨×©
                // ×”×•×¡×¨ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×©×’×¨× ×œ×‘×¢×™×•×ª
                
                console.log('Account Summary Updated:', {
                    totalPages: allPages.length,
                    activePages: activeSubscriptions,
                    activeSubscriptions,
                    monthlyCharge,
                    serverPages: serverPages.length,
                    localPages: localPages.length
                });
                
            } catch (error) {
                console.error('Error updating account summary:', error);
            }
        }
        function updatePagesBreakdown(pages) {
            const pagesBreakdown = document.getElementById('pages-breakdown');
            if (!pagesBreakdown) return;
            
            pagesBreakdown.innerHTML = '';
            
            if (pages.length === 0) {
                pagesBreakdown.innerHTML = '<div class="text-sm text-gray-500 text-center py-2">××™×Ÿ ×“×¤×™× ×©×¤×•×¨×¡××•</div>';
                return;
            }
            
            // ××™×•×Ÿ ×”×“×¤×™× ×œ×¤×™ ×ª××¨×™×š (×”×—×“×© ×‘×™×•×ª×¨ ×¨××©×•×Ÿ)
            const sortedPages = pages.sort((a, b) => {
                const dateA = new Date(a.created_at || a.fileName.split('_').pop() || Date.now());
                const dateB = new Date(b.created_at || b.fileName.split('_').pop() || Date.now());
                return dateB - dateA;
            });
            
            sortedPages.forEach((page, index) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'flex items-center justify-between p-2 bg-white rounded border border-gray-200';
                
                // ×—×œ×¥ ×ª××¨×™×š ××”×©× ××• ×”×©×ª××© ×‘×ª××¨×™×š × ×•×›×—×™
                let publishDate;
                try {
                    // × ×¡×” ×œ×—×œ×¥ ×ª××¨×™×š ××”×©×
                    const timestampMatch = page.fileName.match(/(\d{13})/);
                    if (timestampMatch) {
                        publishDate = new Date(parseInt(timestampMatch[1]));
                    } else {
                        publishDate = new Date(page.created_at || Date.now());
                    }
                } catch (error) {
                    publishDate = new Date();
                }
                
                const formattedDate = publishDate.toLocaleDateString('he-IL', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // × ×§×” ××ª ×©× ×”×“×£
                let cleanPageName = page.title || page.fileName || '×“×£ × ×—×™×ª×”';
                
                // Remove timestamp patterns (13-digit numbers)
                cleanPageName = cleanPageName.replace(/\d{13}/g, '');
                
                // Remove other number patterns at the end
                cleanPageName = cleanPageName.replace(/_\d+$/g, '');
                cleanPageName = cleanPageName.replace(/\d+$/g, '');
                
                // Clean up underscores and extra spaces
                cleanPageName = cleanPageName.replace(/_+/g, ' ').trim();
                cleanPageName = cleanPageName.replace(/\s+/g, ' ');
                
                // If title is empty after cleaning, use a default
                if (!cleanPageName || cleanPageName.length < 2) {
                    cleanPageName = '×“×£ × ×—×™×ª×”';
                }
                
                pageDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                            <span class="text-xs font-semibold text-indigo-600">${index + 1}</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-800">${cleanPageName}</div>
                            <div class="text-xs text-gray-500">×¤×•×¨×¡×: ${formattedDate}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-semibold text-green-600">â‚ª39</div>
                        <div class="text-xs text-gray-500">×“×£ ×©×¤×•×¨×¡×</div>
                    </div>
                `;
                
                pagesBreakdown.appendChild(pageDiv);
            });
        }
        function createTestSubscriptions() {
            console.log('Creating test subscriptions...');
            
            // ×§×‘×œ ××ª ×”×“×¤×™× ××”×©×¨×ª
            fetch(`/api/pages/${currentUser.id}`)
                .then(response => response.json())
                .then(serverData => {
                    const serverPages = serverData.pages || [];
                    
                    // ×¦×•×¨ ×× ×•×™×™× ×œ×“×¤×™× ×”×¨××©×•× ×™× (×¢×“ 3)
                    serverPages.slice(0, 3).forEach((page, index) => {
                        const pageKey = `local_${page.fileName}`; // ××•×ª×• ××¤×ª×— ×›××• ×‘-loadProjects
                        const subscriptionData = {
                            isActive: true,
                            createdAt: new Date().toISOString(),
                            userId: currentUser.id,
                            pageId: pageKey
                        };
                        
                        localStorage.setItem(`page_subscription_${pageKey}`, JSON.stringify(subscriptionData));
                        console.log(`Created subscription for: ${pageKey}`);
                        
                        // ×©××•×¨ ×’× ×‘×©×¨×ª ×‘-metadata.json
                        const pageIdForServer = page.fileName.replace('_html', '');
                        fetch('/api/subscription/activate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: currentUser.id,
                                pageId: pageIdForServer
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log(`âœ… Subscription saved to server for: ${pageKey}`);
                        })
                        .catch(error => {
                            console.error('Error saving subscription to server:', error);
                        });
                    });
                    
                    // ×¢×“×›×Ÿ ××ª ×”××•×“×œ ×¨×§ ×× ×”××©×ª××© ×‘×™×§×© ×–××ª ×‘××¤×•×¨×©
                    // ×”×•×¡×¨ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×©×’×¨× ×œ×‘×¢×™×•×ª
                    
                    showSuccess('× ×•×¦×¨×• 3 ×× ×•×™×™× ×œ×“×¤×™× ×”×¨××©×•× ×™×');
                })
                .catch(error => {
                    console.error('Error creating test subscriptions:', error);
                    showError('×©×’×™××” ×‘×™×¦×™×¨×ª ×× ×•×™×™×');
                });
        }
        // ×¤×•× ×§×¦×™×” ×œ×¡× ×›×¨×Ÿ ×× ×•×™×™× ×-localStorage ×œ×©×¨×ª
        async function syncSubscriptionsToServer() {
            console.log('ğŸ”„ Syncing subscriptions from localStorage to server...');
            try {
                // ×§×‘×œ ××ª ×›×œ ×”××¤×ª×—×•×ª ×©×œ ×× ×•×™×™×
                const subscriptionKeys = Object.keys(localStorage).filter(key => key.startsWith('page_subscription_'));
                console.log(`Found ${subscriptionKeys.length} subscriptions in localStorage`);
                
                let syncedCount = 0;
                let errorCount = 0;
                
                for (const key of subscriptionKeys) {
                    try {
                        const subscriptionData = JSON.parse(localStorage.getItem(key));
                        if (subscriptionData && subscriptionData.isActive === true) {
                            // × ×¡×” ×œ×—×œ×¥ userId ×•-pageId
                            let userId = subscriptionData.userId;
                            let pageId = subscriptionData.pageId;
                            
                            // ×× pageId ××ª×—×™×œ ×‘-local_, ×”×¡×¨ ××ª ×–×”
                            if (pageId && pageId.startsWith('local_')) {
                                pageId = pageId.replace('local_', '');
                            }
                            
                            // ×× ××™×Ÿ userId, × ×¡×” ×œ×§×—×ª ××”××¤×ª×— ××• ××”××©×ª××© ×”× ×•×›×—×™
                            if (!userId && currentUser) {
                                userId = currentUser.id;
                            }
                            
                            if (userId && pageId) {
                                // × ×¡×” ×œ×”×¤×¢×™×œ ××ª ×”×“×£ ×‘×©×¨×ª
                                const response = await fetch('/api/subscription/activate', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        userId: userId,
                                        pageId: pageId
                                    })
                                });
                                
                                if (response.ok) {
                                    syncedCount++;
                                    console.log(`âœ… Synced subscription: ${pageId} for user ${userId}`);
                                } else {
                                    errorCount++;
                                    const error = await response.json();
                                    console.warn(`âš ï¸ Failed to sync ${pageId}:`, error);
                                }
                            } else {
                                console.warn(`âš ï¸ Missing userId or pageId for subscription:`, subscriptionData);
                            }
                        }
                    } catch (error) {
                        errorCount++;
                        console.error(`Error syncing subscription ${key}:`, error);
                    }
                }
                
                console.log(`âœ… Sync complete: ${syncedCount} synced, ${errorCount} errors`);
                if (syncedCount > 0) {
                    // ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“ ××—×¨×™ ×”×¡× ×›×¨×•×Ÿ
                    setTimeout(() => {
                        updateDashboardCards();
                    }, 500);
                }
            } catch (error) {
                console.error('Error syncing subscriptions:', error);
            }
        }
        
        // --- ×œ×•×’×™×§×ª ×“×©×‘×•×¨×“ (××ª×•×§× ×ª) ---
        async function showDashboard() {
            console.log("=== SHOW DASHBOARD ===");
            console.log("currentUser:", currentUser);
            
            if (!currentUser) {
                console.error("currentUser ×œ× ××•×’×“×¨ ×‘-showDashboard!");
                return;
            }
            
            // Prevent multiple simultaneous loads
            if (isDashboardLoading) {
                console.log("Dashboard already loading, skipping...");
                return;
            }
            isDashboardLoading = true;
            
            loginView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            document.body.classList.add('bg-gray-50');
            
            // ×”××ª×Ÿ ×©×”-DOM ×™×˜×¢×Ÿ ×œ×—×œ×•×˜×™×Ÿ ×œ×¤× ×™ ×›×œ ×“×‘×¨
            setTimeout(() => {
            // ×‘×“×•×§ ×¡×˜×˜×•×¡ ×× ×”×œ
                console.log('ğŸ” showDashboard - calling checkAdminStatus()...');
            checkAdminStatus();
                console.log('ğŸ” showDashboard - after checkAdminStatus, isAdmin:', isAdmin);
            
            // ×¢×“×›×Ÿ ××ª ×”××•×“×œ ×¨×§ ×× ×”××©×ª××© ×‘×™×§×© ×–××ª ×‘××¤×•×¨×©
            // ×”×•×¡×¨ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×©×’×¨× ×œ×‘×¢×™×•×ª
            
            // ×˜×¢×Ÿ × ×ª×•× ×™ ×× ×•×™
            loadSubscriptionData();
                
                // ×× ×”××©×ª××© ×”×•× ×× ×”×œ, ×˜×¢×Ÿ × ×ª×•× ×™ ×“×©×‘×•×¨×“ ×× ×”×œ ×’× ×‘×“×£ ×”×¨××©×™
                // ×‘×“×•×§ ×©×•×‘ ××—×¨×™ checkAdminStatus ×›×“×™ ×œ×•×•×“× ×©-isAdmin ××¢×•×“×›×Ÿ
                const ADMIN_USER_ID = 'fae06b49-1239-4ba5-93db-244ce2851fb4';
                const userIsAdmin = currentUser && currentUser.id === ADMIN_USER_ID;
                console.log('ğŸ” Checking admin status in showDashboard:', {
                    userId: currentUser?.id,
                    adminId: ADMIN_USER_ID,
                    isAdmin: userIsAdmin,
                    currentIsAdmin: isAdmin,
                    hasCurrentUser: !!currentUser
                });
                
                // ×ª××™×“ ×˜×¢×Ÿ ××ª ×”× ×ª×•× ×™× ×× ×”××©×ª××© ×”×•× ×× ×”×œ
                if (userIsAdmin) {
                    console.log('ğŸ”§ Admin user detected, updating dashboard...');
                    
                    // ×‘×“×•×§ ×©×”××œ×× ×˜×™× ×§×™×™××™×
                    const dashboardTotalUsers = document.getElementById('dashboard-total-users');
                    const dashboardMonthlyRevenue = document.getElementById('dashboard-monthly-revenue');
                    const dashboardActivePages = document.getElementById('dashboard-active-pages');
                    const dashboardInactivePages = document.getElementById('dashboard-inactive-pages');
                    
                    console.log('ğŸ” Checking if dashboard elements exist:', {
                        dashboardTotalUsers: !!dashboardTotalUsers,
                        dashboardMonthlyRevenue: !!dashboardMonthlyRevenue,
                        dashboardActivePages: !!dashboardActivePages,
                        dashboardInactivePages: !!dashboardInactivePages
                    });
                    
                    // ×¡× ×›×¨×Ÿ ×× ×•×™×™× ×-localStorage ×œ×©×¨×ª ×œ×¤× ×™ ×˜×¢×™× ×ª ×”× ×ª×•× ×™×
                    syncSubscriptionsToServer().then(() => {
                        // ×× ×”××œ×× ×˜×™× ×œ× ×§×™×™××™×, ×”××ª×Ÿ ×¢×•×“ ×§×¦×ª
                        if (!dashboardTotalUsers || !dashboardMonthlyRevenue || !dashboardActivePages || !dashboardInactivePages) {
                            console.warn('âš ï¸ Dashboard elements not found yet, waiting...');
                            setTimeout(async () => {
                                await updateDashboardCards();
                                await loadFinanceData();
                                await loadAnalyticsData();
                                await updateDashboardCards();
                                console.log('âœ… Dashboard updated after waiting');
                            }, 500);
                        } else {
                            // ×”××œ×× ×˜×™× ×§×™×™××™× - ×¢×“×›×Ÿ ××™×“
                            updateDashboardCards().then(() => {
                                setTimeout(async () => {
                                    await loadFinanceData();
                                    await loadAnalyticsData();
                                    await updateDashboardCards();
                                    console.log('âœ… Dashboard fully updated');
                                }, 300);
                            });
                        }
                    });
                } else {
                    console.log('ğŸ‘¤ User is not admin, skipping finance data load');
                    console.log('ğŸ‘¤ Current user ID:', currentUser?.id);
                    console.log('ğŸ‘¤ Admin user ID:', ADMIN_USER_ID);
                    console.log('ğŸ‘¤ userIsAdmin:', userIsAdmin);
                    console.log('ğŸ‘¤ isAdmin variable:', isAdmin);
                }
            }, 100); // ×”××ª×Ÿ 100ms ×©×”-DOM ×™×˜×¢×Ÿ

            if (!currentUser || !currentUser.id) {
                console.error("Invalid user object:", currentUser);
                showError("×©×’×™××” ×‘×–×™×”×•×™ ×”××©×ª××©. × ×¡×” ×œ×”×ª×—×‘×¨ ××—×“×©.");
                return;
            }

            // ×—×œ×¥ × ×ª×•× ×™×
            const userData = extractUserData(currentUser);
            
            // ×”×¦×’ ×‘×××©×§ ××™×™×“×™×ª (×œ×¤× ×™ ×‘×“×™×§×ª ×”×¤×¨×•×¤×™×œ)
            const nameElement = document.getElementById('user-name');
            const avatarElement = document.getElementById('user-avatar');
            
            if (nameElement && avatarElement) {
                nameElement.textContent = userData.name;
                avatarElement.src = userData.avatar;
                avatarElement.onerror = function() {
                    this.src = 'https://placehold.co/80x80/E2E8F0/4A5568?text=' + encodeURIComponent(userData.name.charAt(0));
                };
                console.log("âœ… UI Updated immediately with:", userData);
            } else {
                console.error("UI elements not found:", { nameElement, avatarElement });
            }

            // ×›×¢×ª × ×˜×¤×œ ×‘×¤×¨×•×¤×™×œ ×‘×¨×§×¢
            try {
                let { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (profileError && profileError.code !== 'PGRST116') {
                    console.error("Profile fetch error:", profileError);
                }

                // ×× ××™×Ÿ ×¤×¨×•×¤×™×œ ××• ×”×¤×¨×•×¤×™×œ ×¨×™×§, ×¦×•×¨/×¢×“×›×Ÿ
                if (!profile) {
                    console.log("Creating new profile...");
                    await supabaseClient
                        .from('profiles')
                        .upsert({
                            id: currentUser.id,
                            display_name: userData.name,
                            avatar_url: userData.avatar,
                        });
                } else if (!profile.display_name || profile.display_name === '××©×ª××©') {
                    console.log("Updating existing profile...");
                    await supabaseClient
                        .from('profiles')
                        .update({
                            display_name: userData.name,
                            avatar_url: userData.avatar,
                        })
                        .eq('id', currentUser.id);
                }
            } catch (err) {
                console.error("Profile operations error:", err);
                // ×œ× ×—×©×•×‘ - ×”UI ×›×‘×¨ ××¢×•×“×›×Ÿ
            }
            
            // ×”××ª×Ÿ ×§×¦×ª ×œ×¤× ×™ ×˜×¢×™× ×ª ×”×¤×¨×•×™×§×˜×™×
            setTimeout(() => {
            loadProjects();
            isDashboardLoading = false; // Release lock after projects loaded
            }, 200);
            console.log("======================");
        }
        
        // --- Helper Functions ---
        async function detectPageType(project) {
            // PRIORITY 1: Check if pageType is already in project metadata (from server)
            if (project.pageType === 'onlineStore' || project.pageType === 'store') {
                console.log(`âœ… Using metadata pageType: store (from ${project.fileName})`);
                return 'store';
            }
            if (project.pageType === 'event') {
                console.log(`âœ… Using metadata pageType: event (from ${project.fileName})`);
                return 'event';
            }
            if (project.pageType === 'messageInBottle') {
                console.log(`âœ… Using metadata pageType: messageInBottle (from ${project.fileName})`);
                return 'messageInBottle';
            }
            
            // Detect page type based on name, metadata, or content
            const name = (project.name || '').toLowerCase();
            const fileName = (project.fileName || project.local_file || '').toLowerCase();
            const description = (project.description || '').toLowerCase();
            
            // Message in Bottle keywords
            const messageInBottleKeywords = ['××¡×¨ ×‘×‘×§×‘×•×§', 'message in bottle', '×‘×§×‘×•×§', 'bottle'];
            const isMessageInBottleByName = messageInBottleKeywords.some(keyword => 
                name.includes(keyword) || fileName.includes(keyword) || description.includes(keyword)
            );
            
            // Event page keywords (×”×–×× ×”, ×—×ª×•× ×”, ××™×¨×•×¢)
            const eventKeywords = ['×—×ª×•× ×”', '××™×¨×•×¢', '×”×–×× ×”', '×‘×¨ ××¦×•×•×”', '×‘×ª ××¦×•×•×”', '×—×™× ×”', '×‘×¨×™×ª', 'wedding', 'event'];
            const isEventByName = eventKeywords.some(keyword => 
                name.includes(keyword) || fileName.includes(keyword) || description.includes(keyword)
            );
            
            // Store page keywords - EXPANDED LIST
            const storeKeywords = [
                '×—× ×•×ª', '××•×¦×¨', '×§×˜×œ×•×’', '×××ª×§', '××›×™×¨×”', '×§× ×™×”', '××—×™×¨', '×¢×’×œ×”',
                'store', 'shop', 'product', 'catalog', 'buy', 'cart', 'price',
                'sweet', 'candy', 'food', 'bakery', '×××¤×”', '×§×•× ×“×™×˜×•×¨×™×”'
            ];
            const isStoreByName = storeKeywords.some(keyword => 
                name.includes(keyword) || fileName.includes(keyword) || description.includes(keyword)
            );
            
            // Try to detect by checking page content (only if HTML file exists)
            let isStoreByContent = false;
            let isEventByContent = false;
            let isMessageInBottleByContent = false;
            
            // Skip content checking for pages without HTML files
            if (project.hasHtmlFile !== false) {
                try {
                    // Fetch the page to check its content
                    const pageUrl = `/users/${project.userId || currentUser?.id}/${fileName}`;
                    const response = await fetch(pageUrl);
                    if (response.ok) {
                    const htmlContent = await response.text();
                    const lowerContent = htmlContent.toLowerCase();
                    
                    // Check for store indicators in content
                    const hasAddToCart = lowerContent.includes('addtocart') || 
                                        lowerContent.includes('×”×•×¡×£ ×œ×¢×’×œ×”') ||
                                        lowerContent.includes('add to cart');
                    const hasCartElement = lowerContent.includes('cart-sidebar') || 
                                          lowerContent.includes('shopping-cart') ||
                                          lowerContent.includes('×¢×’×œ×ª ×§× ×™×•×ª');
                    const hasPrice = (lowerContent.match(/â‚ª\d+/g) || []).length > 3;
                    
                    isStoreByContent = hasAddToCart || hasCartElement || (hasPrice && lowerContent.includes('product'));
                    
                    // Check for Message in Bottle indicators
                    const hasBottleIcon = lowerContent.includes('ğŸ¾') || lowerContent.includes('bottle');
                    const hasMessageForm = lowerContent.includes('×©×œ×— ×”×•×“×¢×”') && lowerContent.includes('response-form');
                    const hasMessageBottleText = lowerContent.includes('××¡×¨ ×‘×‘×§×‘×•×§') || lowerContent.includes('message in bottle');
                    const hasPostDetails = lowerContent.includes('×¤×¨×˜×™ ×”×¤×•×¡×˜') && lowerContent.includes('edit-toggle');
                    const hasEditToggle = lowerContent.includes('×¢×¨×•×š ×¤×¨×˜×™ ×”×¤×•×¡×˜');
                    const hasHiddenBotInfo = lowerContent.includes('hidden info for bot only');
                    const hasBottleTitle = lowerContent.includes('ğŸ¾') && (lowerContent.includes('h1') || lowerContent.includes('title'));
                    isMessageInBottleByContent = hasBottleIcon || hasMessageForm || hasMessageBottleText || hasPostDetails || hasHiddenBotInfo || hasEditToggle || hasBottleTitle;
                    
                    // Check for event indicators
                    const hasRSVP = lowerContent.includes('rsvp') || lowerContent.includes('××™×©×•×¨ ×”×’×¢×”');
                    const hasEventDate = lowerContent.includes('×ª××¨×™×š ×”××™×¨×•×¢') || lowerContent.includes('event date');
                    
                    isEventByContent = hasRSVP || hasEventDate;
                    
                    console.log('ğŸ” Page type detection:', {
                        fileName,
                        isMessageInBottleByName,
                        isMessageInBottleByContent,
                        isStoreByName,
                        isStoreByContent,
                        isEventByName,
                        isEventByContent,
                        hasAddToCart,
                        hasCartElement,
                        hasBottleIcon,
                        hasMessageForm
                    });
                    }
                } catch (error) {
                    console.log('Could not fetch page content for type detection:', error);
                }
            } else {
                console.log('â© Skipping content check for page without HTML file:', fileName);
            }
            
            // PRIORITY 2: Content-based detection
            if (isMessageInBottleByContent || isMessageInBottleByName) {
                console.log(`âœ… Detected messageInBottle from ${isMessageInBottleByContent ? 'content' : 'name'}`);
                return 'messageInBottle';
            }
            if (isEventByContent || isEventByName) {
                console.log(`âœ… Detected event from ${isEventByContent ? 'content' : 'name'}`);
                return 'event';
            }
            if (isStoreByContent || isStoreByName) {
                console.log(`âœ… Detected store from ${isStoreByContent ? 'content' : 'name'}`);
                return 'store';
            }
            
            console.log(`â„¹ï¸ No specific type detected for ${fileName}, defaulting to 'other'`);
            return 'other';
        }
        
        function getManageButtonText(pageType) {
            switch(pageType) {
                case 'event': return '× ×™×”×•×œ ××•×–×× ×™×';
                case 'store': 
                case 'onlineStore': return '× ×™×”×•×œ ×—× ×•×ª';
                case 'course': return '× ×™×”×•×œ ×§×•×¨×¡×™×';
                case 'workshop': return '× ×™×”×•×œ × ×¨×©××™×';
                case 'messageInBottle': return '× ×™×”×•×œ ×”×•×“×¢×•×ª';
                default: return '× ×™×”×•×œ';
            }
        }
        
        function getManageUrl(pageType, fileName, userId) {
            switch(pageType) {
                case 'event': return `/event-admin.html?page=${fileName}&userId=${userId}`;
                case 'store':
                case 'onlineStore': return `/page-management.html?page=${fileName}&userId=${userId}`;
                case 'course': return `/course-management.html?pageId=${fileName}&userId=${userId}`;
                case 'workshop': return `/leads-admin.html?page=${fileName}&userId=${userId}`;
                case 'messageInBottle': return `/messages-management.html?page=${fileName}&userId=${userId}`;
                default: return `/leads-admin.html?page=${fileName}&userId=${userId}`;
            }
        }
        
        // --- ×¤×¨×•×™×§×˜×™× ---
        async function loadProjects() {
            // Prevent concurrent calls - CRITICAL for Edge performance
            if (isLoadingProjects) {
                console.log('âš ï¸ loadProjects already running, skipping...');
                return;
            }
            isLoadingProjects = true;
            
            // Edge: Force timeout after 5 seconds
            const isEdgeBrowser = navigator.userAgent.indexOf('Edg') > -1;
            if (isEdgeBrowser) {
                setTimeout(() => {
                    if (isLoadingProjects) {
                        console.error('â° loadProjects timeout - forcing unlock');
                        isLoadingProjects = false;
                    }
                }, window.EDGE_TIMEOUT || 5000);
            }
            
            console.log('loadProjects ×”×ª×—×™×œ');
            console.log('currentUser:', currentUser);
            
            const projectsList = document.getElementById('projects-list');
            if (!projectsList) {
                console.error('×œ× × ××¦× projects-list element');
                isLoadingProjects = false;
                return;
            }
            
            if (!currentUser) {
                console.error('currentUser ×œ× ××•×’×“×¨!');
                projectsList.innerHTML = '<div class="text-center py-16 col-span-full">×©×’×™××”: ××©×ª××© ×œ× ××—×•×‘×¨</div>';
                isLoadingProjects = false;
                return;
            }
            projectsList.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-8">
                    <div class="gen-loader">
                        <div class="inner one"></div>
                        <div class="inner two"></div>
                        <div class="inner three"></div>
                    </div>
                    <p class="gen-text">×˜×•×¢×Ÿ ×“×¤×™×...</p>
                </div>
            `;
            console.log('×”×•×¡×¤×ª×™ loader');
            
            projects = []; // Reset global projects array
            let supabaseError = null;
            
            // × ×¡×” ×œ×˜×¢×•×Ÿ ×-Supabase
            try {
                console.log('×× ×¡×” ×œ×˜×¢×•×Ÿ ×-Supabase...');
                const { data: supabaseProjects, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (!error && supabaseProjects) {
                    projects = supabaseProjects;
                    console.log('× ×˜×¢× ×• ×-Supabase:', projects.length, '×¤×¨×•×™×§×˜×™×');
                    
                    // Try to enrich Supabase projects with pageType from local API
                    try {
                        const localResponse = await fetch(`/api/pages/${currentUser.id}`);
                        const localData = await localResponse.json();
                        
                        if (localData.pages && localData.pages.length > 0) {
                            // Create a map of fileName -> pageType
                            const pageTypeMap = {};
                            localData.pages.forEach(page => {
                                if (page.pageType) {
                                    pageTypeMap[page.fileName] = page.pageType;
                                }
                            });
                            
                            // Enrich Supabase projects with pageType
                            projects.forEach(project => {
                                // Try to match by various fields
                                let matchingPageType = pageTypeMap[project.local_file] || 
                                                      pageTypeMap[project.id];
                                
                                // If no match, try fuzzy matching by name
                                if (!matchingPageType) {
                                    const projectName = (project.name || '').toLowerCase();
                                    for (const [fileName, pageType] of Object.entries(pageTypeMap)) {
                                        const cleanFileName = fileName.replace(/_html$/, '').replace(/\.html$/, '').replace(/_/g, ' ').toLowerCase();
                                        if (projectName.includes(cleanFileName) || cleanFileName.includes(projectName)) {
                                            matchingPageType = pageType;
                                            console.log(`ğŸ” Fuzzy matched: "${projectName}" â†” "${cleanFileName}" â†’ ${pageType}`);
                                            break;
                                        }
                                    }
                                }
                                
                                // If still no match and it's a store-like name, default to 'store'
                                if (!matchingPageType) {
                                    const projectName = (project.name || '').toLowerCase();
                                    const storeKeywords = ['×××ª×§', '×©×•×§×•×œ×“', '×—× ×•×ª', '××›×™×¨×”', 'store', 'shop', 'sweet', '×©×¢×•× '];
                                    if (storeKeywords.some(kw => projectName.includes(kw))) {
                                        matchingPageType = 'store';
                                        console.log(`ğŸª Auto-detected as store by name: ${project.name}`);
                                    }
                                }
                                
                                if (matchingPageType) {
                                    project.pageType = matchingPageType;
                                    console.log(`âœ… Enriched project with pageType: ${matchingPageType} for ${project.name}`);
                                }
                            });
                        }
                    } catch (enrichErr) {
                        console.log('Could not enrich with local pageTypes:', enrichErr);
                    }
                } else {
                    console.log('×©×’×™××” ×‘-Supabase:', error);
                    supabaseError = error;
                }
            } catch (err) {
                console.log('×©×’×™××” ×‘-Supabase, ×¢×•×‘×¨ ×œ× ×ª×•× ×™× ××§×•××™×™×:', err);
                supabaseError = err;
            }
            
            // ×× Supabase × ×›×©×œ, ×˜×¢×Ÿ ××§×•××™×ª
            if (supabaseError || projects.length === 0) {
                try {
                    console.log('×× ×¡×” ×œ×˜×¢×•×Ÿ × ×ª×•× ×™× ××§×•××™×™×...');
                    const localResponse = await fetch(`/api/pages/${currentUser.id}`);
                    const localData = await localResponse.json();
                    
                    if (localData.pages && localData.pages.length > 0) {
                        // ×”××¨ ×“×¤×™× ××§×•××™×™× ×œ×¤×•×¨××˜ Supabase
                        projects = localData.pages.map(page => {
                            // ×—×œ×¥ ×©× × ×§×™ ××ª×•×š ×©× ×”×§×•×‘×¥
                            let cleanName = page.title || '×“×£ × ×—×™×ª×”';
                            
                            // DISABLED: Removed multiple fetch requests that caused Edge to freeze
                            // Instead, we extract title from filename only
                            // This prevents dozens of simultaneous HTTP requests
                            
                            // ×× ×™×© ×©× ×§×•×‘×¥ ×¢× timestamp, × ×¡×” ×œ×—×œ×¥ ×©× ×™×•×ª×¨ ×˜×•×‘
                            if (page.fileName && page.fileName.includes('_')) {
                                const namePart = page.fileName.split('_')[0];
                                if (namePart && namePart !== 'page' && namePart !== '×“×£' && namePart.length > 2) {
                                    cleanName = decodeURIComponent(namePart);
                                }
                            }
                            
                            const projectObj = {
                            id: `local_${page.fileName}`,
                                name: cleanName,
                                description: '×“×£ × ×—×™×ª×” ××§×¦×•×¢×™',
                            html_content: null, // × ×˜×¢×Ÿ ×‘× ×¤×¨×“
                            template_type: 'local',
                            status: 'completed',
                            created_at: new Date().toISOString(),
                            local_file: page.fileName,
                            local_url: page.url,
                                user_id: currentUser.id,
                                userId: currentUser.id,
                                pageType: page.pageType // CRITICAL: Pass pageType from server!
                            };
                            
                            console.log(`âœ… Local page loaded with pageType: ${page.pageType} for ${page.fileName}`);
                            
                            return projectObj;
                        });
                        console.log('× ×˜×¢× ×• ×“×¤×™× ××§×•××™×™×:', projects.length);
                    }
                } catch (localErr) {
                    console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×“×¤×™× ××§×•××™×™×:', localErr);
                    console.log('××¦×™×’ ×”×•×“×¢×” ×¨×™×§×”...');
                }
            }
            
            console.log('×¡×™×™××ª×™ ×œ×˜×¢×•×Ÿ, ×™×©', projects.length, '×¤×¨×•×™×§×˜×™×');
            
            // ×× ×™×© ×©×’×™××” ×-Supabase ××‘×œ ×™×© ×“×¤×™× ××§×•××™×™×, × ××©×™×š
            // ×× ××™×Ÿ ×“×¤×™× ×‘×›×œ×œ, × ×¦×™×’ ×”×•×“×¢×” ×¨×™×§×”
            
            if (projects && projects.length > 0) {
                console.log('××¦×™×’', projects.length, '×¤×¨×•×™×§×˜×™×');
                projectsList.innerHTML = '';
                
                projects.forEach((project, index) => {
                    console.log(`××¦×™×’ ×¤×¨×•×™×§×˜ ${index + 1}:`, project.name);
                    
                    // Use pageType from server (already detected and saved)
                    const pageType = project.pageType || 'other';
                    const manageButtonText = getManageButtonText(pageType);
                    console.log(`ğŸ“‹ Page type: ${pageType} â†’ Button text: "${manageButtonText}" for ${project.name}`);
                    console.log(`ğŸ” Full project data:`, project);
                    
                    // Special logging for messageInBottle
                    if (pageType === 'messageInBottle') {
                        console.log(`ğŸ¾ MESSAGE IN BOTTLE DETECTED! Should show "× ×™×”×•×œ ×”×•×“×¢×•×ª" and "×”×©×”×”" buttons`);
                        console.log(`ğŸ¾ Project details:`, {
                            name: project.name,
                            fileName: project.fileName,
                            pageType: project.pageType
                        });
                    } else if (!project.pageType) {
                        console.log(`âš ï¸ No pageType in project metadata - might need auto-detection`);
                        
                        // Try to auto-detect and update metadata for messageInBottle pages
                        if (project.fileName && (project.fileName.includes('1761578919863') || 
                            project.name.includes('×“×£ × ×—×™×ª×”') ||
                            project.name.includes('××¡×¨ ×‘×‘×§×‘×•×§'))) {
                            console.log(`ğŸ” Attempting auto-detection for suspicious page: ${project.fileName}`);
                            autoDetectAndUpdateMessageBottle(project);
                        }
                    } else {
                        console.log(`ğŸ“‹ Page type detected as: ${pageType} for ${project.name}`);
                    }
                    
                    const creationDate = new Date(project.created_at).toLocaleDateString('he-IL');
                    const projectCard = document.createElement('div');
                    projectCard.className = 'bg-white p-4 rounded-xl border border-gray-200 shadow-md hover:shadow-lg hover:border-indigo-400 hover:-translate-y-1 transition-all duration-300 flex flex-col overflow-hidden backdrop-blur-sm bg-white/95';
        projectCard.style.minHeight = '450px';
        projectCard.style.maxHeight = '450px';
        projectCard.style.display = 'flex';
        projectCard.style.flexDirection = 'column';
        projectCard.style.position = 'relative';
                    projectCard.setAttribute('data-project-id', project.id);
                    
                    const hasHtmlContent = (project.html_content && project.html_content.trim() !== '') || project.local_url;
                    
                    // ×‘×“×•×§ ×× ×”×“×£ ×”×–×” ×™×© ×œ×• ×× ×•×™ ×¤×¢×™×œ - USE project.id!
                    const storageKey = `page_subscription_${project.id}`;
                    const pageSubscription = localStorage.getItem(storageKey);
                    const hasPageSubscription = pageSubscription && JSON.parse(pageSubscription).isActive;
                    
                    console.log(`ğŸ“„ Page ID: ${project.id}`);
                    console.log(`ğŸ”‘ Storage key: ${storageKey}`);
                    console.log(`ğŸ“¦ Subscription data: ${pageSubscription}`);
                    console.log(`âœ… Has active subscription: ${hasPageSubscription}`);
                    
                    // ×“×¤×™× ×—×“×©×™× ××ª×—×™×œ×™× ×œ×œ× ×× ×•×™ (××™×Ÿ ×× ×•×™ ×‘-localStorage)
                    const finalHasSubscription = hasPageSubscription;
                    
                    const statusBadge = finalHasSubscription ? 
                        '<span class="status-badge status-completed">×× ×•×™ ×¤×¢×™×œ</span>' :
                        '<span class="status-badge status-processing">×× ×•×™ ×œ× ×¤×¢×™×œ</span>';
                    
                    // ×§×‘×œ ××ª ×›×ª×•×‘×ª ×”×“×£
                    const pageUrl = project.local_url || (project.html_content ? '#' : '');
        const actionButtons = `
            <div class="flex items-center justify-between gap-2 w-full">
                <div class="flex items-center gap-2 flex-wrap flex-1">
                    ${(() => {
                        console.log(`ğŸ” Button logic for ${project.name}:`, {
                            hasHtmlContent,
                            finalHasSubscription,
                            pageType,
                            isMessageInBottle: pageType === 'messageInBottle'
                        });
                        
                        if (hasHtmlContent && finalHasSubscription) {
                            console.log(`âœ… Showing VIEW button for ${project.name}`);
                            return `<button onclick="viewProject('${project.id}')" class="bg-green-500 text-white px-3 py-2 rounded text-sm font-medium hover:bg-green-600 transition shadow-sm" style="min-width: 60px;">
                                ×¦×¤×”
                            </button>`;
                        } else if (pageType === 'messageInBottle') {
                            console.log(`ğŸ¾ Showing PAUSE button for messageInBottle: ${project.name}`);
                            return `<button onclick="toggleMessageBottleStatus('${project.id}')" id="status-btn-${project.id}" class="bg-green-600 text-white px-3 py-2 rounded text-sm font-medium hover:bg-green-700 transition shadow-sm" style="min-width: 60px;">
                                â¸ï¸ ×”×©×”×”
                            </button>`;
                        } else if (hasHtmlContent && !finalHasSubscription) {
                            console.log(`âš ï¸ Showing SUBSCRIPTION button for ${project.name}`);
                            return `<button onclick="openPageSubscriptionModal('${project.id}')" class="bg-yellow-500 text-white px-3 py-2 rounded text-sm font-medium hover:bg-yellow-600 transition shadow-sm" style="min-width: 80px;">
                            ×”×¤×¢×œ ×× ×•×™
                            </button>`;
                        } else {
                            console.log(`âŒ No button for ${project.name}`);
                            return '';
                    }
                    })()}
                    ${pageUrl && finalHasSubscription ?
                        `<button onclick="copyToClipboard('${window.location.origin}${pageUrl}')" class="bg-purple-500 text-white px-3 py-2 rounded text-sm font-medium hover:bg-purple-600 transition shadow-sm" style="min-width: 60px;">
                            ×”×¢×ª×§ ×§×™×©×•×¨
                        </button>` : ''
                    }
                </div>
                
                <!-- ×›×¤×ª×•×¨ ×ª×¤×¨×™×˜ -->
                <div class="relative dropdown-container">
                    <button onclick="toggleDropdown(event, '${project.id}')" class="bg-gray-700 text-white px-3 py-2 rounded text-sm font-medium hover:bg-gray-800 transition shadow-sm flex items-center gap-1" style="min-width: 60px;">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                    </svg>
                </button>
                    
                    <!-- ×ª×¤×¨×™×˜ × ×¤×ª×— -->
                    <div id="dropdown-${project.id}" class="dropdown-menu hidden absolute left-0 bottom-full mb-2 bg-white rounded-lg shadow-xl border border-gray-200 py-1 z-50" style="min-width: 150px;">
                        <button onclick="editProject('${project.id}')" class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        ×¢×¨×•×š
                        </button>
                        ${pageType === 'messageInBottle' ? 
                            `<button onclick="editMessageInBottlePost('${project.id}')" class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-green-50 flex items-center gap-2">
                                <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                ğŸ¾ ×©× ×” ×¤×•×¡×˜
                            </button>` : ''
                        }
                        ${hasHtmlContent ?
                            `<button data-action="manage" data-page-type="${pageType}" onclick="manageProject('${project.id}', '${pageType}')" class="w-full text-right px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 flex items-center gap-2">
                                <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <span class="manage-button-text">${manageButtonText}</span>
                            </button>` : ''
                        }
                        ${!project.pageType || project.pageType === 'other' ? 
                            `<button onclick="autoDetectAndUpdateMessageBottle(${JSON.stringify(project).replace(/"/g, '&quot;')})" class="w-full text-right px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2 border-t border-gray-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                ğŸ” ×–×”×” ×¡×•×’ ×“×£
                            </button>` : ''
                        }
                        <button onclick="deleteProject('${project.id}')" class="w-full text-right px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 border-t border-gray-100">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        ××—×§
                        </button>
                    </div>
                </div>
            </div>
        `;
                    
                    projectCard.innerHTML = `
                            <!-- ×ª×¦×•×’×” ××§×“×™××” ×©×œ ×”××ª×¨ -->
                        <div class="relative rounded-t-xl overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100" style="height: 200px; flex-shrink: 0;">
                                ${pageUrl ? `
                        <!-- ×ª×¦×•×’×” ××§×“×™××” ×¢× iframe - ××¦×“ ×œ×¦×“ ×¢×“ ×”×§×¦×•×•×ª -->
                                        <iframe 
                                            src="${window.location.origin}${pageUrl}" 
                            class="absolute inset-0 w-full h-full border-0"
                                            style="pointer-events: none; transform: scale(0.6) translateX(65%); transform-origin: top left; width: 166.67%; height: 166.67%;"
                                            title="×ª×¦×•×’×” ××§×“×™××” ×©×œ ${project.name}"
                                            loading="lazy"
                                            importance="low"
                            sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-downloads allow-modals allow-top-navigation allow-presentation">
                                        </iframe>
                                ` : `
                                    <!-- ×ª×¦×•×’×” ××§×“×™××” ×¡×˜×˜×™×ª -->
                                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-purple-500/10"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="text-center">
                                            <div class="w-16 h-16 bg-white/90 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg border-2 border-indigo-200">
                                                <span class="text-2xl font-bold text-indigo-600">${project.name.charAt(0)}</span>
                                            </div>
                                            <div class="text-sm font-medium text-gray-700 bg-white/90 px-3 py-1 rounded-full shadow-sm border border-gray-200">
                                                ××™×Ÿ ×ª×•×›×Ÿ
                                            </div>
                                        </div>
                                    </div>
                                `}
                                ${finalHasSubscription ? `
                                    <div class="absolute top-3 right-3">
                                        <div class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            ×–××™×Ÿ ×œ×¦×¤×™×™×”
                                        </div>
                                    </div>
                                ` : `
                                    <div class="absolute top-3 right-3">
                                        <div class="bg-amber-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                            ×××ª×™×Ÿ
                                        </div>
                                    </div>
                                `}
                            </div>
                            
                        <!-- ×ª×•×›×Ÿ ×”×›×¨×˜×™×¡ -->
                        <div class="p-4 flex-1 flex flex-col" style="min-height: 0; overflow: hidden;">
                            <!-- ×›×•×ª×¨×ª ×•×¡×˜×˜×•×¡ -->
                            <div class="mb-3 flex-shrink-0">
                                    <h3 class="font-semibold text-lg text-gray-800 mb-2" style="min-height: 24px;">${project.name}</h3>
                                <p class="text-sm text-gray-500 mb-3 line-clamp-2" style="min-height: 32px;">${project.description || '×“×£ × ×—×™×ª×” ××§×¦×•×¢×™'}</p>
                                <div class="flex items-center justify-between text-xs text-gray-400 mb-2">
                                    <span>× ×•×¦×¨: ${creationDate}</span>
                                    ${statusBadge}
                                </div>
                            </div>
                            
                        </div>
                        
                        <!-- ×¤×¡ ×›×¤×ª×•×¨×™× ×‘×ª×—×ª×™×ª -->
                        <div class="border-t border-gray-100 bg-gray-50 px-4 py-3 rounded-b-xl flex-shrink-0" style="min-height: 70px; display: flex; align-items: center;">
                            <div class="flex items-center justify-center gap-2 flex-wrap w-full">${actionButtons}</div>
                        </div>
                    `;
                    console.log(`××•×¡×™×£ ×›×¨×˜×™×¡ ${index + 1} ×œ-DOM`);
                    projectsList.appendChild(projectCard);
                });
                console.log('×¡×™×™××ª×™ ×œ×”×•×¡×™×£ ×›×¨×˜×™×¡×™×');
                
                // ×¢×“×›×Ÿ ××ª ×”××•×“×œ ×¨×§ ×× ×”××©×ª××© ×‘×™×§×© ×–××ª ×‘××¤×•×¨×©
                // ×”×•×¡×¨ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×©×’×¨× ×œ×‘×¢×™×•×ª
            } else {
                 projectsList.innerHTML = `
                    <div class="text-center py-16 col-span-full">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                        <h3 class="mt-2 text-lg font-medium text-gray-900">×¢×“×™×™×Ÿ ××™×Ÿ ×“×¤×™ × ×—×™×ª×”</h3>
                        <p class="mt-1 text-sm text-gray-500">×”×’×™×¢ ×”×–××Ÿ ×œ×™×¦×•×¨ ××ª ×“×£ ×”× ×—×™×ª×” ×”×¨××©×•×Ÿ ×©×œ×š.</p>
                        <div class="mt-6">
                            <button onclick="goToFullApp()" class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-bold hover:bg-indigo-700 transition-transform transform hover:scale-105 flex items-center gap-2 mx-auto">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span>×¦×•×¨ ×“×£ ×—×“×©</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Release lock after loading completes
            isLoadingProjects = false;
        }

        async function viewProject(projectId) {
            console.log('ğŸ‘ï¸ viewProject called with:', projectId);
            
            try {
            // ×‘×“×•×§ ×× ×–×” ×“×£ ××§×•××™
            if (projectId.startsWith('local_')) {
                const fileName = projectId.replace('local_', '');
                    
                    if (!currentUser || !currentUser.id) {
                        console.error('âŒ currentUser not defined!');
                        alert('×©×’×™××”: ××©×ª××© ×œ× ××—×•×‘×¨');
                        return;
                    }
                    
                const url = `/pages/${currentUser.id}/${fileName}`;
                    console.log('ğŸŒ Opening URL:', url);
                
                // ×¤×ª×— ×‘×—×œ×•×Ÿ ×—×“×©
                const newWindow = window.open(url, '_blank');
                    if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                        console.warn('âš ï¸ Popup blocked, trying same tab');
                        window.location.href = url;
                    } else {
                        console.log('âœ… Page opened in new tab');
                    }
                    return;
                }
            } catch (error) {
                console.error('âŒ Error in viewProject:', error);
                alert('×©×’×™××” ×‘×¤×ª×™×—×ª ×”×“×£: ' + error.message);
                return;
            }
            
            // ×“×£ ×-Supabase
            try {
                const { data: project, error } = await supabaseClient.from('projects').select('html_content, name').eq('id', projectId).single();
                if (error || !project) return showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×¨×•×™×§×˜.');
                if (!project.html_content) return showError('×œ× × ××¦× ×ª×•×›×Ÿ HTML ×œ×¤×¨×•×™×§×˜ ×–×”.');

                // ×¤×ª×— ×‘×—×œ×•×Ÿ ×—×“×©
                const newWindow = window.open("");
                if (newWindow) {
                    newWindow.document.write(project.html_content);
                    newWindow.document.close();
                    newWindow.document.title = project.name || '×“×£ × ×—×™×ª×”';
                } else {
                    showError('×¤×ª×™×—×ª ×—×œ×•×Ÿ ×—×“×© × ×›×©×œ×”. ×‘×“×•×§ ×—×•×¡× ×¤×•×¤-××¤×™×.');
                }
            } catch (err) {
                console.error('Error viewing project:', err);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×¨×•×™×§×˜.');
            }
        }

        function editProject(projectId) {
            window.location.href = `/page-creator?edit=${projectId}&redirectUrl=${encodeURIComponent(window.location.href)}`;
        }

        function updateManagementButton(projectCard, pageType) {
            const manageButton = projectCard.querySelector('[data-action="manage"]');
            if (manageButton) {
                if (pageType === 'store' || pageType === 'onlineStore') {
                    manageButton.textContent = 'ğŸ›’ × ×™×”×•×œ ×—× ×•×ª';
                } else if (pageType === 'event') {
                    manageButton.textContent = 'ğŸ‰ × ×™×”×•×œ ××•×–×× ×™×';
                } else {
                    manageButton.textContent = 'âš™ï¸ × ×™×”×•×œ';
                }
            }
        }

        function getManagementButtonText(project) {
            // First check if pageType was auto-detected
            if (project.pageType === 'store' || project.pageType === 'onlineStore') {
                return '× ×™×”×•×œ ×—× ×•×ª';
            }
            if (project.pageType === 'event') {
                return '× ×™×”×•×œ ××•×–×× ×™×';
            }
            
            // Fallback: Detect page type from name or description  
            const name = (project.name || '').toLowerCase();
            const desc = (project.description || '').toLowerCase();
            const fileName = (project.local_file || project.id || '').toLowerCase();
            const combined = name + ' ' + desc + ' ' + fileName;
            
            // Store detection - ALL products/shops
            if (combined.includes('×—× ×•×ª') || combined.includes('××•×¦×¨') || combined.includes('×§× ×™×”') || 
                combined.includes('store') || combined.includes('shop') || combined.includes('××§×¨×•× ×™') ||
                combined.includes('×¦×¢×¦×•×¢') || combined.includes('×¡×¤×¨×™×') || combined.includes('×××ª×§') ||
                combined.includes('×¤×™×¦') || combined.includes('pizza') || combined.includes('××¡×¢×“') ||
                combined.includes('×‘×™×™×’×œ') || combined.includes('bagel') || combined.includes('×××¤×”') ||
                combined.includes('×œ×—×') || combined.includes('×§×¤×”') || combined.includes('××©×§×”') ||
                combined.includes('×‘×’×“') || combined.includes('× ×¢×œ') || combined.includes('××•×¤× ×”') ||
                combined.includes('××œ×§×˜×¨×•× ×™×§×”') || combined.includes('××—×©×‘') || combined.includes('×˜×œ×¤×•×Ÿ') ||
                combined.includes('×™×”×œ×•××™') || combined.includes('×™×”×œ×•×') || combined.includes('×ª×›×©×™×˜') || combined.includes('×©×¢×•×Ÿ') ||
                combined.includes('×–×”×‘') || combined.includes('×›×¡×£') || combined.includes('jewelry') ||
                combined.includes('××›×•×œ×ª') || combined.includes('×¡×•×¤×¨') || combined.includes('market') ||
                combined.includes('×•×™×œ×•× ×•×ª') || combined.includes('×¨×”×™×˜') || combined.includes('×¢×™×¦×•×‘ ×¤× ×™×') ||
                combined.includes('×¦××—') || combined.includes('×¤×¨×—') || combined.includes('×’×™× ×”') ||
                combined.includes('candy') || combined.includes('sweet') || combined.includes('chocolate')) {
                return '× ×™×”×•×œ ×—× ×•×ª';
            }
            // Event detection - EXPANDED
            if (combined.includes('××™×¨×•×¢') || combined.includes('×›× ×¡') || combined.includes('××¤×’×©') || 
                combined.includes('××•×–××Ÿ') || combined.includes('×—×ª×•× ×”') || combined.includes('×‘×¨ ××¦×•×”') ||
                combined.includes('×‘×ª ××¦×•×”') || combined.includes('×”×–×× ×”') || combined.includes('event') ||
                combined.includes('wedding') || combined.includes('invitation') || combined.includes('×—×™× ×”') ||
                combined.includes('××¡×™×‘×”') || combined.includes('×™×•× ×”×•×œ×“×ª')) {
                return '× ×™×”×•×œ ××•×–×× ×™×';
            }
            // Course detection
            if (combined.includes('×§×•×¨×¡') || combined.includes('×œ×™××•×“') || combined.includes('×”×“×¨×›×”') ||
                combined.includes('course') || combined.includes('workshop')) {
                return '× ×™×”×•×œ ×§×•×¨×¡';
            }
            // Default
            return '× ×™×”×•×œ';
        }
        
        function toggleDropdown(event, projectId) {
            event.stopPropagation();
            
            // ×¡×’×•×¨ ×›×œ ×”×ª×¤×¨×™×˜×™× ×”×¤×ª×•×—×™×
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                if (menu.id !== `dropdown-${projectId}`) {
                    menu.classList.remove('show');
                }
            });
            
            // ×¤×ª×—/×¡×’×•×¨ ××ª ×”×ª×¤×¨×™×˜ ×”× ×•×›×—×™
            const dropdown = document.getElementById(`dropdown-${projectId}`);
            dropdown.classList.toggle('show');
        }

        // ×¤×•× ×§×¦×™×” ×œ×¢×¨×™×›×ª ×¤×•×¡×˜ ××¡×¨ ×‘×‘×§×‘×•×§
        function editMessageInBottlePost(projectId) {
            // ××¦× ××ª ×”×¤×¨×•×™×§×˜
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                alert('×œ× × ××¦× ×”×¤×¨×•×™×§×˜');
                return;
            }

            // ×¦×•×¨ ×—×œ×•×Ÿ ×¢×¨×™×›×”
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">ğŸ¾ ×¢×¨×™×›×ª ×¤×•×¡×˜</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">×©×</label>
                            <input type="text" id="edit-post-name" value="${project.name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">×©×™×¨×•×ª/×‘×§×©×”</label>
                            <textarea id="edit-post-request" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="××” ××ª×” ××¦×™×¢ ××• ××—×¤×©?">${project.description || ''}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">××–×•×¨</label>
                            <input type="text" id="edit-post-area" value="${project.area || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="×ª×œ ××‘×™×‘, × ×ª× ×™×”...">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">××—×™×¨</label>
                                <input type="number" id="edit-post-price" value="${project.price || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">×¡×•×’</label>
                                <select id="edit-post-price-type" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="×›×œ×œ×™" ${project.priceType === '×›×œ×œ×™' ? 'selected' : ''}>×›×œ×œ×™</option>
                                    <option value="×©×¢×ª×™" ${project.priceType === '×©×¢×ª×™' ? 'selected' : ''}>×©×¢×ª×™</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveMessageInBottlePost('${projectId}')" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
                            ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600">
                            âŒ ×‘×˜×œ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ×¤×•× ×§×¦×™×” ×œ×©××™×¨×ª ×©×™× ×•×™×™× ×‘×¤×•×¡×˜ ××¡×¨ ×‘×‘×§×‘×•×§
        async function saveMessageInBottlePost(projectId) {
            const name = document.getElementById('edit-post-name').value;
            const request = document.getElementById('edit-post-request').value;
            const area = document.getElementById('edit-post-area').value;
            const price = document.getElementById('edit-post-price').value;
            const priceType = document.getElementById('edit-post-price-type').value;

            if (!name || !request || !area) {
                alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”');
                return;
            }

            try {
                // ×¢×“×›×Ÿ ××ª ×”×¤×¨×•×™×§×˜ ×‘××¢×¨×›×ª
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    project.name = name;
                    project.description = request;
                    project.area = area;
                    project.price = price;
                    project.priceType = priceType;
                }

                // ×©××•×¨ ×‘-localStorage
                const projectsKey = `projects_${currentUser.id}`;
                localStorage.setItem(projectsKey, JSON.stringify(projects));

                // ×¡×’×•×¨ ××ª ×”×—×œ×•×Ÿ
                document.querySelector('.fixed').remove();
                
                // ×¨×¢× ×Ÿ ××ª ×”×ª×¦×•×’×”
                await loadProjects();
                
                alert('×”×¤×•×¡×˜ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”! ğŸ‰');
                
            } catch (error) {
                console.error('Error saving post:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”×©×™× ×•×™×™×');
            }
        }
        
        async function manageProject(projectId, detectedPageType = null) {
            console.log('ğŸ” manageProject called with:', projectId, 'pageType:', detectedPageType);
            
            // ×—×œ×¥ ××ª ×©× ×”×§×•×‘×¥ ×•×”××©×ª××©
            const fileName = projectId.startsWith('local_') ? projectId.replace('local_', '') : projectId;
            
            // ××¦× ××ª ×”×¤×¨×•×™×§×˜ ×›×“×™ ×œ×§×‘×œ ××ª ×”-userId ×©×œ×•
            const project = projects.find(p => p.id === projectId);
            
            console.log('ğŸ“¦ Project object:', project);
            
            // Try to get userId from multiple sources
            let userId = currentUser?.id;
            if (!userId && project?.userId) {
                userId = project.userId;
            }
            if (!userId && project?.user_id) {
                userId = project.user_id;
            }
            // If still no userId, extract from URL
            if (!userId && project?.local_url) {
                const urlMatch = project.local_url.match(/\/pages\/([^\/]+)\//);
                if (urlMatch) {
                    userId = urlMatch[1];
                }
            }
            
            console.log('ğŸ‘¤ userId:', userId, 'ğŸ“„ fileName:', fileName);
            
            if (!userId) {
                alert('×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××ª ×”××©×ª××©.');
                return;
            }
            
            // Use detected page type or load from metadata
            let pageType = detectedPageType || project?.pageType;
            
            if (!pageType) {
                try {
                    const metadataUrl = `/pages/${userId}/${fileName}_data/metadata.json`;
                    const response = await fetch(metadataUrl);
                    if (response.ok) {
                        const metadata = await response.json();
                        pageType = metadata.pageType;
                        console.log('ğŸ“‹ Loaded pageType from metadata:', pageType);
                    }
                } catch (err) {
                    console.log('âš ï¸ No metadata, using default');
                }
            }
            
            // Determine management URL based on pageType
            let managementUrl;
            
            console.log('ğŸ” FINAL pageType for routing:', pageType, 'Type:', typeof pageType);
            
            if (pageType === 'event') {
                // ×“×£ ××™×¨×•×¢/×”×–×× ×” â†’ × ×™×”×•×œ ××•×–×× ×™×
                managementUrl = `/event-guests.html?eventId=${fileName}&userId=${userId}`;
                console.log('ğŸ‰ Opening EVENT management (guests)');
            } else if (pageType === 'store' || pageType === 'onlineStore') {
                // ×“×£ ×—× ×•×ª â†’ × ×™×”×•×œ ×—× ×•×ª
                managementUrl = `/page-management.html?page=${fileName}&userId=${userId}`;
                console.log('ğŸ›’ Opening STORE management for:', fileName);
            } else if (pageType === 'messageInBottle') {
                // ××¡×¨ ×‘×‘×§×‘×•×§ â†’ × ×™×”×•×œ ×”×•×“×¢×•×ª
                managementUrl = `/messages-management.html?page=${fileName}&userId=${userId}`;
                console.log('ğŸ¾ Opening MESSAGES management for:', fileName);
            } else {
                // ×“×¤×™× ××—×¨×™× â†’ × ×™×”×•×œ ×œ×™×“×™×
                managementUrl = `/leads-admin.html?page=${fileName}&userId=${userId}`;
                console.log('ğŸ“‹ Opening LEADS management (pageType was:', pageType, ')');
            }
            
            console.log('ğŸŒ Opening:', managementUrl);
            
            // Open in new tab
            const newWindow = window.open(managementUrl, '_blank');
            
            // Fallback: if popup blocked, open in same tab
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                console.warn('âš ï¸ Popup blocked, opening in same tab');
                window.location.href = managementUrl;
            }
        }
        
        // ×¡×’×•×¨ ×ª×¤×¨×™×˜×™× ×›×©×œ×•×—×¦×™× ××—×•×¥ ×œ×”×
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown-container')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        async function cleanOrphanedData() {
            if (!confirm('ğŸ§¹ ×”×× ×œ× ×§×•×ª × ×ª×•× ×™× ×™×ª×•××™× (×§× ×™×•×ª ×•××•×–×× ×™× ××“×¤×™× ×©× ××—×§×•)?')) return;
            
            try {
                const response = await fetch('/api/clean-orphaned-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentUser.id
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showSuccess(data.message);
                    console.log('âœ… Cleaned:', data);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '×©×’×™××” ×‘× ×™×§×•×™ × ×ª×•× ×™×');
                }
            } catch (error) {
                console.error('Error cleaning data:', error);
                showError('×©×’×™××” ×‘× ×™×§×•×™ × ×ª×•× ×™×: ' + error.message);
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×“×£ ×”× ×—×™×ª×”? ×”×¤×¢×•×œ×” ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) return;
            
            try {
                // ×‘×“×•×§ ×× ×–×” ×“×£ ××§×•××™
                if (projectId.startsWith('local_')) {
                    const fileName = projectId.replace('local_', '');
                    console.log('Deleting local file:', fileName);
                    
                    // ××—×§ ××”×©×¨×ª ×”××§×•××™
                    const response = await fetch(`/api/delete-page`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            fileName: fileName
                        })
                    });
                    
                    if (response.ok) {
                        showSuccess('×”×“×£ × ××—×§ ×‘×”×¦×œ×—×”');
                        loadProjects(); // ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××”
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '×©×’×™××” ×‘××—×™×§×ª ×”×“×£ ×”××§×•××™');
                    }
                    return;
                }
                
                // ×“×£ ×-Supabase
                const { error } = await supabaseClient.from('projects').delete().eq('id', projectId);
                if (error) throw error;
                
                showSuccess('×”×“×£ × ××—×§ ×‘×”×¦×œ×—×”');
                loadProjects(); // ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××”
            } catch (error) {
                console.error('Error deleting project:', error);
                showError('×©×’×™××” ×‘××—×™×§×ª ×”×¤×¨×•×™×§×˜: ' + error.message);
            }
        }

        async function signOut() {  
            // Clear all intervals to prevent memory leaks
            if (subscriptionTimer) {
                clearInterval(subscriptionTimer);
                subscriptionTimer = null;
            }
            if (adminTimeInterval) {
                clearInterval(adminTimeInterval);
                adminTimeInterval = null;
            }
            
            // Clear user data
            clearCurrentUser();
            currentUser = null;
            subscriptionData = null;
            isAdmin = false;
            
            // Sign out from Supabase
            await supabaseClient.auth.signOut();  
        }

        function goToFullApp() {  
            window.location.href = '/page-creator?redirectUrl=' + encodeURIComponent(window.location.href);  
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('×”×›×ª×•×‘×ª ×”×•×¢×ª×§×” ×œ×œ×•×—');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showError('×©×’×™××” ×‘×”×¢×ª×§×ª ×”×›×ª×•×‘×ª');
            });
        }
        // --- Event Listeners ---
        // Admin panel event listeners - with null checks
        if (adminPanelBtn) {
        adminPanelBtn.addEventListener('click', openAdminPanel);
        }
        if (closeAdminPanel) {
        closeAdminPanel.addEventListener('click', closeAdminPanelHandler);
        }
        
        // Account summary button
        const accountSummaryBtn = document.getElementById('account-summary-btn');
        if (accountSummaryBtn) {
            accountSummaryBtn.addEventListener('click', openAccountSummaryModal);
        }

        // Admin tab switching - with null checks
        const dashboardTab = document.getElementById('dashboard-tab');
        const usersTab = document.getElementById('users-tab');
        const financeTab = document.getElementById('finance-tab');
        const analyticsTab = document.getElementById('analytics-tab');
        const settingsTab = document.getElementById('settings-tab');
        
        if (dashboardTab) {
            dashboardTab.addEventListener('click', () => switchAdminTab('dashboard', '×“×©×‘×•×¨×“'));
        }
        if (usersTab) {
            usersTab.addEventListener('click', () => switchAdminTab('users', '× ×™×”×•×œ ××©×ª××©×™×'));
        }
        if (financeTab) {
            financeTab.addEventListener('click', () => switchAdminTab('finance', '× ×™×”×•×œ ×›×¡×¤×™×'));
        }
        if (analyticsTab) {
            analyticsTab.addEventListener('click', () => switchAdminTab('analytics', '×¡×˜×˜×™×¡×˜×™×§×•×ª'));
        }
        if (settingsTab) {
            settingsTab.addEventListener('click', () => switchAdminTab('settings', '×”×’×“×¨×•×ª'));
        }

        function switchAdminTab(tabName, title) {
            try {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all sidebar tabs
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.remove('text-white', 'bg-indigo-600');
                tab.classList.add('text-gray-700', 'hover:bg-gray-50', 'hover:text-gray-900');
            });
            
            // Show selected tab content
                const tabContent = document.getElementById(`${tabName}-content`);
                if (tabContent) {
                    tabContent.classList.remove('hidden');
                } else {
                    console.error(`Tab content not found: ${tabName}-content`);
                }
            
            // Add active class to selected tab
            const selectedTab = document.getElementById(`${tabName}-tab`);
                if (selectedTab) {
            selectedTab.classList.add('text-white', 'bg-indigo-600');
            selectedTab.classList.remove('text-gray-700', 'hover:bg-gray-50', 'hover:text-gray-900');
                } else {
                    console.error(`Tab not found: ${tabName}-tab`);
                }
            
            // Update page title
            if (adminPageTitle) {
                adminPageTitle.textContent = title;
                }
            } catch (error) {
                console.error('Error switching admin tab:', error);
            }
        }
        // --- ×××–×™× ×™× ×œ××™×¨×•×¢×™× ---
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            if (event === 'SIGNED_OUT') {
                currentUser = null;
                clearCurrentUser();
                isAdmin = false;
                isDashboardLoading = false; // Reset dashboard lock
                dashboardView.classList.add('hidden');
                loginView.classList.remove('hidden');
                document.body.classList.remove('bg-gray-50');
                if (!document.getElementById('googleSignInBtn').onclick) {
                   initGoogleSignIn();
                }
            } else if (event === 'SIGNED_IN' && session) {
                // Only update if not already showing dashboard
                if (dashboardView.classList.contains('hidden')) {
                currentUser = session.user;
                saveCurrentUser(currentUser);
                setTimeout(() => {
                showDashboard();
                }, 100);
                } else {
                    console.log('Dashboard already shown, skipping SIGNED_IN handler');
                }
            }
        });
        
        // Stav Chat Functions - SYNCED WITH MARKETPLACE
        function toggleStavChat() {
            const chatWindow = document.getElementById('stavChatWindow');
            chatWindow.classList.toggle('active');
            if (chatWindow.classList.contains('active')) {
                document.getElementById('stavChatInput').focus();
            }
        }
        
        // Search live pages for Stav (same as marketplace) - FORCE LIVE DATA
        async function searchLivePagesStav(query) {
            const searchTerm = query.toLowerCase();
            const results = [];
            
            console.log(`ğŸ” Stav FORCING LIVE DATA SEARCH for: "${searchTerm}"`);
            
            try {
                // ALWAYS get fresh pages from server
                const response = await fetch('/api/pages/all');
                console.log('ğŸ” Stav fetch response status:', response.status);
                
                if (!response.ok) {
                    console.error('ğŸ” Stav fetch failed:', response.status, response.statusText);
                    return results;
                }
                
                const data = await response.json();
                const freshPages = data.pages || [];
                
                console.log(`ğŸ” Stav got ${freshPages.length} fresh pages from server`);
                
                for (const page of freshPages) {
                    try {
                        const pageUrl = `/users/${page.userId}/${page.pageId}_html`;
                        console.log(`ğŸ” Stav fetching LIVE page: ${pageUrl}`);
                        const response = await fetch(pageUrl);
                        if (response.ok) {
                            const html = await response.text();
                            const htmlLower = html.toLowerCase();
                            
                            // Check if search term appears in page content
                            const found = htmlLower.includes(searchTerm);
                            console.log(`ğŸ” Stav LIVE Page "${page.title}": ${found ? 'FOUND' : 'NOT FOUND'}`);
                            
                            // Also extract live product data
                            const liveProducts = extractLiveProductsStav(html);
                            if (liveProducts.length > 0) {
                                console.log(`ğŸ’° Stav LIVE Products found in "${page.title}":`, liveProducts);
                            }
                            
                            if (found) {
                                // Add live product data to page
                                page.liveProducts = liveProducts;
                                results.push(page);
                            }
                        } else {
                            console.log(`ğŸ” Stav page fetch failed: ${pageUrl} - ${response.status}`);
                        }
                    } catch (error) {
                        console.error('Error searching live page:', error);
                    }
                }
                
                console.log(`ğŸ” Stav found ${results.length} LIVE pages for "${searchTerm}"`);
                return results;
            } catch (error) {
                console.error('ğŸ” Stav searchLivePagesStav error:', error);
                return results;
            }
        }
        // Smart Stav - Send everything to N8N
        // ğŸ§  CONVERSATION CONTEXT MEMORY (global variable)
        if (!window.stavConversationContext) {
            window.stavConversationContext = {
                lastSearchCategory: null,     // Last category user searched for (e.g., "×¦×¢×¦×•×¢")
                lastShownPages: [],          // Last pages we showed
                rejectedCategories: [],      // Categories user said "no" to
                conversationHistory: [],     // Full conversation history
                recommendedPage: null,       // Page we recommended for user to visit
                userLocation: null,          // User's area/location
                shownPagesByCategory: {},    // Track shown pages per category
                socialNeeds: [],             // Track social needs (friends, sports, etc.)
                urgentRequests: [],          // Track urgent/immediate requests
                preferredServices: []        // Track what user prefers
            };
        }

        // ğŸ¯ Smart Category Management Functions
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function selectRandomPages(pages, category, maxCount = 3) {
            const context = window.stavConversationContext;
            
            // Initialize category tracking if needed
            if (!context.shownPagesByCategory[category]) {
                context.shownPagesByCategory[category] = [];
            }
            
            // Filter out already shown pages
            const unshownPages = pages.filter(page => 
                !context.shownPagesByCategory[category].includes(page.pageId || page.fileName)
            );
            
            // If we've shown all pages, reset the list
            if (unshownPages.length === 0 && pages.length > 0) {
                context.shownPagesByCategory[category] = [];
                return selectRandomPages(pages, category, maxCount);
            }
            
            // Shuffle and select random pages
            const shuffled = shuffleArray(unshownPages);
            const selected = shuffled.slice(0, maxCount);
            
            // Mark these pages as shown
            selected.forEach(page => {
                context.shownPagesByCategory[category].push(page.pageId || page.fileName);
            });
            
            console.log(`ğŸ¯ Selected ${selected.length} random pages for category "${category}"`);
            return selected;
        }

        function categorizePages(pages) {
            const categories = {
                babysitter: [],
                sports: [],
                social: [],
                services: [],
                urgent: [],
                messageInBottle: [],
                regular: []
            };
            
            pages.forEach(page => {
                const content = (page.name + ' ' + page.description + ' ' + page.request || '').toLowerCase();
                
                // Categorize by content
                if (content.includes('×‘×™×™×‘×™×¡×™×˜×¨') || content.includes('babysitter')) {
                    categories.babysitter.push(page);
                } else if (content.includes('×›×“×•×¨') || content.includes('×¡×¤×•×¨×˜') || content.includes('×¨×™×¦×”') || content.includes('×—×“×¨ ×›×•×©×¨')) {
                    categories.sports.push(page);
                } else if (content.includes('×—×‘×¨') || content.includes('×‘×™×œ×•×™') || content.includes('×§×¤×”') || content.includes('×§×•×œ× ×•×¢')) {
                    categories.social.push(page);
                } else if (content.includes('×“×—×•×£') || content.includes('×¢×›×©×™×•') || content.includes('×–××™×Ÿ') || content.includes('× ×ª×§×¢')) {
                    categories.urgent.push(page);
                }
                
                // Separate by page type
                if (page.pageType === 'messageInBottle') {
                    categories.messageInBottle.push(page);
                } else {
                    categories.regular.push(page);
                }
                
                // General services
                categories.services.push(page);
            });
            
            return categories;
        }

        function smartPageSelection(allPages, userMessage, maxTotal = 4) {
            const categories = categorizePages(allPages);
            const context = window.stavConversationContext;
            const message = userMessage.toLowerCase();
            
            let selectedPages = [];
            
            // Detect user needs
            const isUrgent = message.includes('×“×—×•×£') || message.includes('×¢×›×©×™×•') || message.includes('× ×ª×§×¢');
            const isSocial = message.includes('×‘×•×“×“') || message.includes('×—×‘×¨') || message.includes('×œ×‘×“');
            const isSports = message.includes('×›×“×•×¨') || message.includes('×¡×¤×•×¨×˜');
            
            // Priority 1: Urgent requests - prefer messageInBottle
            if (isUrgent) {
                const urgentBottles = categories.messageInBottle.filter(page => 
                    (page.request || '').toLowerCase().includes('×–××™×Ÿ') || 
                    (page.request || '').toLowerCase().includes('×¢×›×©×™×•')
                );
                selectedPages.push(...selectRandomPages(urgentBottles, 'urgent_bottles', 2));
                selectedPages.push(...selectRandomPages(categories.urgent, 'urgent_regular', 1));
            }
            
            // Priority 2: Social needs
            if (isSocial) {
                selectedPages.push(...selectRandomPages(categories.social, 'social', 2));
                selectedPages.push(...selectRandomPages(categories.messageInBottle.filter(page => 
                    (page.request || '').toLowerCase().includes('×—×‘×¨')
                ), 'social_bottles', 2));
            }
            
            // Priority 3: Sports
            if (isSports) {
                selectedPages.push(...selectRandomPages(categories.sports, 'sports', 2));
            }
            
            // Priority 4: Specific services (babysitter, etc.)
            if (message.includes('×‘×™×™×‘×™×¡×™×˜×¨')) {
                selectedPages.push(...selectRandomPages(categories.babysitter, 'babysitter', 2));
            }
            
            // If no specific category, mix everything
            if (selectedPages.length === 0) {
                // Mix: 1-2 messageInBottle + 1-2 regular
                selectedPages.push(...selectRandomPages(categories.messageInBottle, 'general_bottles', 2));
                selectedPages.push(...selectRandomPages(categories.regular, 'general_regular', 2));
            }
            
            // Remove duplicates and limit total
            const uniquePages = selectedPages.filter((page, index, self) => 
                index === self.findIndex(p => (p.pageId || p.fileName) === (page.pageId || page.fileName))
            );
            
            return uniquePages.slice(0, maxTotal);
        }

        // ğŸ§¹ Clean user message from filler words before sending to n8n
        function cleanUserMessage(message) {
            let cleaned = message;
            
            // ğŸ¯ QUESTION PATTERNS - Extract the entity from questions
            const questionPatterns = [
                { pattern: /××” (×”×˜×œ×¤×•×Ÿ|×”××™×™×œ|×”×›×ª×•×‘×ª|×”××—×™×¨|×”××—×™×¨×™×) ×©×œ (.+)/i, entityIndex: 2 },
                { pattern: /××™×¤×” (× ××¦×|× ××¦××ª|×××•×§×|×××•×§××ª) (.+)/i, entityIndex: 2 },
                { pattern: /(×™×© ×œ×™|×™×© ×œ×š|×™×© ×œ)(.*) (×˜×œ×¤×•×Ÿ|××™×™×œ|×›×ª×•×‘×ª|××—×™×¨|××—×™×¨×™×)/i, entityIndex: 2 },
                { pattern: /××™×š (××¤×©×¨ ×œ×™×¦×•×¨ ×§×©×¨|×œ×™×¦×•×¨ ×§×©×¨|×œ×”×ª×§×©×¨) (×œ|×¢×|××œ) (.+)/i, entityIndex: 3 },
            ];
            
            for (const { pattern, entityIndex } of questionPatterns) {
                const match = message.match(pattern);
                if (match && match[entityIndex]) {
                    cleaned = match[entityIndex].trim();
                    console.log(`â“ Question detected: "${message}" â†’ extracted entity: "${cleaned}"`);
                    break;
                }
            }
            
            // If no question pattern matched, use regular filler removal
            if (cleaned === message) {
                const fillerWords = /^(××•×œ×™|×‘×¢×¨×š|×›××™×œ×•|×‘×§×™×¨×•×‘|×× ×™|×× ×—× ×•|××ª|××ª×”|××ª×|×”×|×”×™×|×”×•×|××—×¤×©|××—×¤×©×ª|××—×¤×©×™×|×¨×•×¦×”|×¨×•×¦×™×|×¦×¨×™×š|×¦×¨×™×›×”|×ª×Ÿ|×ª× ×™|×ª×¨××”|×ª×¨××™|×ª×¦×™×’|×ª×¢×–×•×¨|×¢×–×¨×•|×œ×™|×œ× ×•|××©×”×•|×“×‘×¨|×¢× ×™×™×Ÿ|××™×–×”|××™×–×•|×™×©)\s+/gi;
                cleaned = message.replace(fillerWords, '').trim();
            }
            
            // ğŸ¯ SEMANTIC MAPPING - Map related words to searchable terms
            const semanticMap = {
                '××˜×‘×—×™×': '× ×’×¨',
                '××˜×‘×—': '× ×’×¨',
                '××¨×•×Ÿ': '× ×’×¨',
                '××¨×•× ×•×ª': '× ×’×¨',
                '×¨×”×™×˜×™×': '× ×’×¨',
                '×¨×”×™×˜': '× ×’×¨',
                '×©×•×œ×—×Ÿ': '× ×’×¨',
                '×›×™×¡×': '× ×’×¨',
                '×›×™×¡××•×ª': '× ×’×¨',
                '××™×˜×”': '× ×’×¨',
                '×¡×¤×”': '× ×’×¨',
                '×××× ×ª ××™×©×™×ª': '×××× ×ª',
                '××××Ÿ ××™×©×™': '××××Ÿ',
                '××™××•×Ÿ ××™×©×™': '××™××•×Ÿ',
                '×›×•×©×¨': '××™××•×Ÿ',
                '×¦×™×¤×•×¨× ×™×™×': '×œ×§',
                '×× ×™×§×•×¨': '×œ×§',
                '×¤×“×™×§×•×¨': '×œ×§'
            };
            
            // Check if cleaned message matches any semantic mapping
            for (const [key, value] of Object.entries(semanticMap)) {
                if (cleaned.includes(key)) {
                    console.log(`ğŸ¯ Semantic mapping: "${key}" â†’ "${value}"`);
                    cleaned = cleaned.replace(key, value);
                }
            }
            
            if (cleaned !== message) {
                console.log('ğŸ§¹ Cleaning & Mapping:', message, 'â†’', cleaned);
            }
            return cleaned || message;
        }

        async function sendStavMessage() {
            try {
                const input = document.getElementById('stavChatInput');
                let userMessage = input.value.trim();
                
                console.log('ğŸš€ sendStavMessage called with:', userMessage);
                
                if (!userMessage) return;
                
                // ğŸ§¹ CRITICAL: Clean message FIRST, before everything!
                const originalMessage = userMessage;
                userMessage = cleanUserMessage(userMessage);
                console.log('âœ¨ After cleaning:', originalMessage, 'â†’', userMessage);
                
                // Display ORIGINAL user message (not cleaned) so user sees what they typed
                addStavMessage(originalMessage, true);
                input.value = '';
                
                console.log('âœ… User message displayed, continuing...');
                
                // ğŸ§  ADD TO CONTEXT MEMORY
                window.stavConversationContext.conversationHistory.push({
                    role: 'user',
                    message: userMessage,
                    timestamp: new Date()
                });
                
                // Show typing indicator
                addStavMessage('ğŸ¤– ×¡×ª×™×• ××§×œ×™×“×”<span class="typing-dots">...</span>', false);
                
                // Get ALL pages from ALL users (including messageInBottle for Stav)
                console.log('ğŸ¤– Fetching ALL pages (including messageInBottle) for Stav');
                
                const pagesResponse = await fetch('/api/pages/all');
                const pagesData = await pagesResponse.json();
                const allPages = pagesData.pages || [];
                
                console.log(`ğŸ“š Got ${allPages.length} pages from ALL users (including messageInBottle)`, allPages);
                
                // ğŸ§  SMART DECISION: Is this a greeting, negation, follow-up question, or product search?
                const greetings = ['×”×™×™', '×©×œ×•×', '×”×™', 'hello', '××” ×©×œ×•××š', '×‘×•×§×¨ ×˜×•×‘', '×¢×¨×‘ ×˜×•×‘'];
                const conversations = ['×× ×™', '×©××™', '×§×•×¨××™× ×œ×™', '×ª×•×“×”', '××¢×•×œ×”', '× ×”×“×¨', '×›×Ÿ', '××•×§×™×™', '×¢×¦×•×‘', '×©××—', '×¨×¢ ×œ×™', '×˜×•×‘ ×œ×™', '×›×•×¢×¡', '×¢×™×™×£'];
                const knowledgeQuestions = ['××” ×’×•×“×œ', '××” ×–×”', '××™×š', '×œ××”', '××ª×™', '××™×¤×”', '××™', '××” ×”××©××¢×•×ª', '×¡×¤×¨ ×œ×™', '×ª×¡×‘×™×¨', '××” ×§×•×¨×”', '××™ ×–×”', '××” ×”×™×”', '××” ×™×”×™×”', '××™×š ×¢×•×©×™×', '××“×•×¢', '×‘××™×–×”', '××”×•', '××”×™', '×”××', '×”×× ×™×©', '×ª×’×™×“ ×œ×™', '××ª×” ×™×•×“×¢', '××›×™×¨', '××›×™×¨×”', '××ª ××›×™×¨', '××ª ××›×™×¨×”', '××ª×” ××›×™×¨'];
                const recommendations = ['×”××œ×™×¦×™', '×ª××œ×™×¦×™', '××” ×”××œ×¦×”', '××” ×›×“××™', '××™×–×” ××•×¦×¨', '×¨×•×¦×” ××©×”×•', '××—×¤×© ××©×”×•', '××” ××ª ×××œ×™×¦×”', '××” ××ª×” ×××œ×™×¥', '××ª ×××œ×™×¦×”', '××ª×” ×××œ×™×¥', '×ª××œ×™×¥ ×œ×™', '××” ×™×©', '××” ×™×© ×œ×›×'];
                const interactiveRequests = ['×ª×§×‘×¢', '×§×‘×¢', '×ª×§×‘×¢×™', '×ª×¦×™×’', '×”×¦×’', '×”×¦×™×’×™', '×ª×¨××”', '×ª×¨××™', '×¨×©×™××”', '×¨×©×™××ª', '×›×œ ×”', '×”×›×œ', '×ª××œ×™×¥', '×ª××œ×™×¦×™', '×”××œ×™×¦×™', '×”××œ×¥', '×”××œ×¦×”', '×”×¦×¢', '×”×¦×™×¢×™', '×”×¦×¢×”', '××” ×™×©', '××” ×™×© ×œ×š', '××” ××ª ×™×›×•×œ×”', '××” ××ª×” ×™×›×•×œ', '××” ××¤×©×¨', '×—× ×™×•×ª', '×—× ×•×™×•×ª', '×›×œ ×”×—× ×™×•×ª', '×›×œ ×”×—× ×•×™×•×ª', '×›×œ ×”×“×¤×™×', '×ª×¨××” ×œ×™ ××ª ×›×œ', '×”×¦×’ ××ª ×›×œ', '×ª××œ×™×¦×™ ×¢×œ', '×ª××œ×™×¥ ×¢×œ', '×”××œ×¦×” ×¢×œ', '×”××œ×™×¦×™ ×¢×œ', '×”××œ×¥ ×¢×œ', '××” ×”××•×¦×¨', '××™×–×” ××•×¦×¨', '××•×¦×¨', '×”××•×¦×¨'];
                const budgetQueries = ['×¢×“', '×¢×“ ×œ', '××ª×—×ª ×œ', '×¤×—×•×ª ×', '×œ× ×™×•×ª×¨ ×', '××§×¡×™××•×', '××§×¡', '×ª×§×¦×™×‘'];
                
                // ğŸ†• NEGATION & REJECTION detection
                const negations = ['×œ×', '×–×” ×œ×', '×œ× ×˜×•×‘', '××©×”×• ××—×¨', '×œ× ×¨×•×¦×”', '×œ× ××ª××™×', '×œ× ×‘×©×‘×™×œ×™'];
                const followUpQuestions = ['×™×© ×¢×•×“', '×•×™×© ×¢×•×“', '×¢×•×“ ××•×¤×¦×™×•×ª', '×¢×•×“ ×—× ×™×•×ª', '×ª×¨××” ×œ×™ ×¢×•×“', '××” ×¢×•×“', '×¢×•×“ ××©×”×•', '×ª×¨××™ ×œ×™', '×ª×¨××” ×œ×™', '××™×–×” ×¢×•×“', '××” ×¢×•×“ ×™×©', '×™×© ×¢×•×“ ×“×¤×™×', '×¢×•×“', '×ª×¨××™', '×ª×¨××”', '×¢×•×“ ××•×¦×¨×™×', '×™×© ×¢×•×“ ××•×¦×¨×™×', '×ª×¨××™ ×¢×•×“ ××•×¦×¨×™×'];
                
                const isGreeting = greetings.some(g => userMessage.toLowerCase().includes(g));
                const isConversation = conversations.some(c => userMessage.toLowerCase().includes(c));
                const isKnowledgeQuestion = knowledgeQuestions.some(k => userMessage.toLowerCase().includes(k));
                const isRecommendation = recommendations.some(r => userMessage.toLowerCase().includes(r));
                const isNegation = negations.some(n => userMessage.toLowerCase().includes(n));
                const isFollowUpQuestion = followUpQuestions.some(f => userMessage.toLowerCase().includes(f));
                
                // ğŸ¤ DETECT SOCIAL/LONELINESS REQUESTS
                const socialKeywords = ['×‘×•×“×“', '×œ×‘×“', '××™×Ÿ ×œ×™ ×—×‘×¨×™×', '××—×¤×© ×—×‘×¨×™×', '×—×‘×¨×”', '×‘×™×œ×•×™', '×©×•×ª×£', '×§×‘×•×¦×”', '×›×“×•×¨×¡×œ', '×›×“×•×¨×’×œ', '×¡×¤×•×¨×˜', '×¨×™×¦×”', '×—×“×¨ ×›×•×©×¨', '×§×•×œ× ×•×¢', '×§×¤×”'];
                const isSocialRequest = socialKeywords.some(keyword => userMessage.toLowerCase().includes(keyword));
                const isInteractiveRequest = interactiveRequests.some(i => userMessage.toLowerCase().includes(i));
                const hasBudget = budgetQueries.some(b => userMessage.toLowerCase().includes(b));
                
                // ğŸ’° PRICE COMPARISON DETECTION - ×–×™×”×•×™ ×”×©×•×•××ª ××—×™×¨×™×
                const priceQueries = ['×”×›×™ ×–×•×œ', '×”×›×™ ×™×§×¨', '×”×–×•×œ', '×”×™×§×¨', '×–×•×œ ×‘×™×•×ª×¨', '×™×§×¨ ×‘×™×•×ª×¨', '××—×™×¨ ×”×›×™', '×”×–×•×œ ×‘×™×•×ª×¨', '×”×™×§×¨ ×‘×™×•×ª×¨', '×”××—×™×¨ ×©×œ', '×›××” ×¢×•×œ×”', '××—×™×¨×™×', '××—×™×¨', '××” ×”××—×™×¨', '×‘×›××”', '×›××” ×–×” ×¢×•×œ×”', '××•×¦×¨ ×”×›×™ ×–×•×œ', '××•×¦×¨ ×–×•×œ', '××•×¦×¨ ×™×§×¨', '××™×–×” ×”×›×™', '××” ×”×›×™', '×”××•×¦×¨ ×”×–×•×œ', '×”××•×¦×¨ ×”×™×§×¨', '×”××•×¦×¨ ×”×›×™ ×–×•×œ', '×”××•×¦×¨ ×”×›×™ ×™×§×¨'];
                const isPriceQuery = priceQueries.some(q => userMessage.toLowerCase().includes(q));
                console.log('ğŸ’° Is price query?', isPriceQuery, '| search term:', userMessage);
                
                // âœ… CHECK if user is confirming to visit a recommended page (e.g., "×›×Ÿ", "××•×§×™×™", "×‘×˜×—")
                const confirmations = ['×›×Ÿ', '×‘×˜×—', '××•×§×™×™', '××•×§×™', 'ok', 'yes', '×™××œ×œ×”', '×‘×•×', '×ª×¨××”', '×ª×¨××™', '×”×¦×’', '×”×¦×™×’×™'];
                const isConfirmation = confirmations.some(c => userMessage.toLowerCase().trim() === c || userMessage.toLowerCase().includes(c));
                
                // ğŸŒ IF USER CONFIRMED and we have a recommended page - OPEN IT!
                if (isConfirmation && window.stavConversationContext.recommendedPage) {
                    console.log('âœ… USER CONFIRMED - Opening recommended page:', window.stavConversationContext.recommendedPage);
                    
                    const recommendedPage = window.stavConversationContext.recommendedPage;
                    
                    // Show a confirmation message
                    addStavMessage(`âœ… **×¤×•×ª×— ××ª "${recommendedPage.title}"...**`, false);
                    
                    // Show the preview with animation
                    const chatMessages = document.getElementById('stavChatMessages');
                    if (chatMessages) {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'stav-message bot';
                        previewDiv.style.cssText = `
                            margin: 16px 0;
                            border: 2px solid #e5e7eb;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            width: 100%;
                            max-width: 100%;
                            height: 500px;
                            opacity: 0;
                            transform: translateY(20px);
                            transition: all 0.5s ease;
                        `;
                        
                        previewDiv.innerHTML = 
                            '<div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">' +
                                '<span>ğŸŒ</span>' +
                                '<span>' + recommendedPage.title + '</span>' +
                            '</div>' +
                            '<div style="position: relative; height: 450px; overflow: hidden;">' +
                                '<iframe src="' + recommendedPage.url + '" style="width: 200%; height: 900px; border: none; transform: scale(0.5); transform-origin: top right; position: absolute; top: 0; right: 0; opacity: 0; transition: opacity 0.8s ease;" sandbox="allow-same-origin allow-scripts allow-popups allow-forms" onload="this.style.opacity=\'1\';"></iframe>' +
                            '</div>';
                        
                        chatMessages.appendChild(previewDiv);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        
                        setTimeout(() => {
                            previewDiv.style.opacity = '1';
                            previewDiv.style.transform = 'translateY(0)';
                        }, 100);
                    }
                    
                    // Clear the recommended page from context
                    window.stavConversationContext.recommendedPage = null;
                    
                    return; // STOP HERE
                }
                
                // Check if this looks like a product search (has product keywords)
                const productKeywords = ['×¦×¢×¦×•×¢', '×©×¢×•×Ÿ', '×ª×›×©×™×˜', '×œ×§', '×˜×›× ×•×œ×•×’×™×”', '×§×•×¨×¡', '××•×¦×¨', '×§× ×”', '×œ××›×•×¨', '××—×™×¨', '××ª× ×”', '×’×‘×¨', '××™×©×”', '×™×œ×“', '×‘×¢×œ', '××©×ª×™', '× ×’×¨', '× ×’×¨×™×”', '×¢×¥', '×¨×”×™×˜', '×¨×”×™×˜×™×', '××¨×•×Ÿ', '××¨×•× ×•×ª', '×©×•×œ×—×Ÿ', '×›×™×¡×', '×›×™×¡××•×ª', '××™×˜×”', '×¡×¤×”', '××˜×‘×—', '××˜×‘×—×™×', '××××Ÿ', '×××× ×ª', '××™××•×Ÿ', '×¡×¤×•×¨×˜', '×›×•×©×¨', '×©×™×¨×•×ª', '×—× ×•×ª', '×¢×¡×§', '×××ª×§', '×©×•×§×•×œ×“', '×¦×™×¤×•×¨× ×™×™×', '×× ×™×§×•×¨', '×¤×“×™×§×•×¨'];
                const hasProductKeyword = productKeywords.some(k => userMessage.toLowerCase().includes(k));
                
                // ğŸ§  HANDLE NEGATION (e.g., "×œ×§ ×–×” ×œ× ××ª× ×” ×œ×™×œ×“")
                if (isNegation && hasProductKeyword) {
                    console.log('âŒ NEGATION detected - user is rejecting a category');
                    
                    // Extract what user is rejecting
                    const rejectedCategories = productKeywords.filter(k => userMessage.toLowerCase().includes(k));
                    console.log('ğŸš« User rejected:', rejectedCategories);
                    
                    // Add to rejected list
                    window.stavConversationContext.rejectedCategories.push(...rejectedCategories);
                    
                    // Send to N8N to understand context and suggest alternatives
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'negation',
                                context: {
                                    lastSearchCategory: window.stavConversationContext.lastSearchCategory,
                                    rejectedCategories: window.stavConversationContext.rejectedCategories,
                                    conversationHistory: window.stavConversationContext.conversationHistory.slice(-5)  // Last 5 messages
                                },
                                pages: allPages,  // ğŸ¯ ×©×œ×™×—×ª ×›×œ ×”×“×¤×™× ×¢× ×›×œ ×”×¤×¨×˜×™×
                                availablePagesCount: allPages.length,
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        removeStavTypingIndicator();
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // ğŸ” FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            
                            // ğŸ” FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            
                            // ğŸ” FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            // ğŸ¯ Extract response field
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : (n8nData.message || '××•×§×™×™! ××– ××™×–×” ×¡×•×’ ××ª× ×” ××ª ××—×¤×©×ª?');
                            addStavMessage(botResponse, false);
                            
                            // If N8N returned specific pages, display them
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = allPages.find(p => p.title.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage) {
                                        const pageUrl = matchingPage.url;
                                        const previewHtml = `
                                            <div class="page-preview-container" style="margin-top: 15px; text-align: right; direction: rtl;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px 12px 0 0; font-weight: 600;">
                                                    ğŸ“„ ${matchingPage.title}
                                                </div>
                                                <iframe src="${pageUrl}" style="width: 100%; height: 300px; border: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>
                                            </div>
                                        `;
                                        addStavMessage(previewHtml, false);
                                    }
                                }
                            }
                        } else {
                            addStavMessage('××•×§×™×™! ××– ××™×–×” ×¡×•×’ ××ª× ×” ××ª ××—×¤×©×ª?', false);
                        }
                    } catch (error) {
                        console.error('N8N error:', error);
                        removeStavTypingIndicator();
                        addStavMessage('××•×§×™×™! ××– ××™×–×” ×¡×•×’ ××ª× ×” ××ª ××—×¤×©×ª?', false);
                    }
                    return; // STOP HERE
                }
                
                // ğŸ¤ HANDLE SOCIAL/LONELINESS REQUESTS - Special handling for social needs!
                if (isSocialRequest) {
                    console.log('ğŸ¤ SOCIAL REQUEST detected - handling with empathy and smart suggestions');
                    
                    // ğŸ¯ Smart page selection focusing on social and messageInBottle pages
                    const smartSelectedPages = smartPageSelection(allPages, userMessage, 8);
                    console.log(`ğŸ¤ Social request - selected ${smartSelectedPages.length} pages from ${allPages.length} total`);
                    
                    // Update context with social needs
                    const context = window.stavConversationContext;
                    context.socialNeeds.push(userMessage);
                    
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'social',
                                pages: smartSelectedPages,
                                allPagesCount: allPages.length,
                                context: {
                                    socialNeeds: context.socialNeeds,
                                    userLocation: context.userLocation,
                                    conversationHistory: context.conversationHistory.slice(-5)
                                },
                                specialInstructions: 'This is a social/loneliness request. Be empathetic and focus on messageInBottle pages for social connections.',
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        removeStavTypingIndicator();
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // Parse n8n response (same logic as other handlers)
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : '×× ×™ ××‘×™× ×” ×©×–×” ×œ× ×§×œ... ×××™×¤×” ××ª×”? ×× ×™ ××—×¤×© ×œ×š ×× ×©×™× × ×—××“×™× ×‘××–×•×¨ ×©×œ×š ğŸ’™';
                            addStavMessage(botResponse, false);
                            
                            // Display suggested pages if any
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = smartSelectedPages.find(p => p.title?.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage) {
                                        displayPagePreview(matchingPage);
                                    }
                                }
                            }
                        } else {
                            console.error('N8N social request failed:', n8nResponse.status);
                            addStavMessage('×× ×™ ××‘×™× ×” ×©×–×” ×œ× ×§×œ... ×‘×•××™ × ×—×¤×© ×™×—×“ ×× ×©×™× × ×—××“×™× ×‘××–×•×¨ ×©×œ×š! ×××™×¤×” ××ª? ğŸ’™', false);
                        }
                    } catch (error) {
                        console.error('Error sending social request to N8N:', error);
                        removeStavTypingIndicator();
                        addStavMessage('×× ×™ ××‘×™× ×” ×©×–×” ×œ× ×§×œ... ×‘×•××™ × ×—×¤×© ×™×—×“ ×× ×©×™× × ×—××“×™× ×‘××–×•×¨ ×©×œ×š! ×××™×¤×” ××ª? ğŸ’™', false);
                    }
                    return; // STOP HERE
                }
                
                // ğŸ¤– HANDLE INTERACTIVE REQUESTS (e.g., "×ª×§×‘×¢ ×œ×™ ×ª×•×¨", "×ª×¦×™×’ ×¨×©×™××”") - Send to N8N!
                // âš ï¸ BUT NOT if it's a price query or product recommendation - those should be handled locally!
                if (isInteractiveRequest && !isPriceQuery && !isRecommendation) {
                    console.log('ğŸ¤– INTERACTIVE REQUEST detected - sending to N8N');
                    
                    // ğŸ¯ Smart page selection for interactive requests
                    const smartSelectedPages = smartPageSelection(allPages, userMessage, 6);
                    console.log(`ğŸ¯ Interactive request - selected ${smartSelectedPages.length} pages from ${allPages.length} total`);
                    
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'interactive',
                                pages: smartSelectedPages,  // ğŸ¯ ×©×œ×™×—×ª ×‘×—×™×¨×” ×—×›××” ×‘××§×•× ×›×œ ×”×“×¤×™×
                                allPagesCount: allPages.length,  // ××¡×¤×¨ ×›×œ ×”×“×¤×™× ×œ×§×•× ×˜×§×¡×˜
                                availablePagesCount: allPages.length,
                                context: {
                                    lastSearchCategory: window.stavConversationContext.lastSearchCategory,
                                    lastShownPages: window.stavConversationContext.lastShownPages.map(p => p.title),
                                    conversationHistory: window.stavConversationContext.conversationHistory
                                }
                            })
                        });
                        
                        removeStavTypingIndicator(); // âœ… Remove typing indicator BEFORE showing response
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // ğŸ” FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            
                            // ğŸ” FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            
                            // ğŸ” FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            console.log('ğŸ“¥ N8N Response:', n8nData);
                            // ğŸ¯ Extract response field
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : (n8nData.message || '××¦×˜×¢×¨×ª, ×œ× ×”×¦×œ×—×ª×™ ×œ×”×‘×™×Ÿ. ××¤×©×¨ ×œ× ×¡×— ××—×¨×ª?');
                            addStavMessage(botResponse, false);
                            
                            // If N8N returned specific pages, display them
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = allPages.find(p => p.title.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage) {
                                        const pageUrl = matchingPage.url;
                                        const previewHtml = `
                                            <div class="page-preview-container" style="margin-top: 15px; text-align: right; direction: rtl;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px 12px 0 0; font-weight: 600;">
                                                    ğŸ“„ ${matchingPage.title}
                                                </div>
                                                <iframe src="${pageUrl}" style="width: 100%; height: 300px; border: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>
                                            </div>
                                        `;
                                        addStavMessage(previewHtml, false);
                                    }
                                }
                            }
                        } else {
                            console.error('âŒ N8N Response not OK:', n8nResponse.status);
                            addStavMessage('××¦×˜×¢×¨×ª, ×™×© ×œ×™ ×‘×¢×™×” ×§×˜× ×”. ×ª× ×¡×” ×©×•×‘?', false);
                        }
                    } catch (error) {
                        console.error('âŒ N8N error:', error);
                        removeStavTypingIndicator(); // âœ… Remove typing indicator on error too
                        removeStavTypingIndicator();
                        addStavMessage('××¦×˜×¢×¨×ª, ×™×© ×œ×™ ×‘×¢×™×” ×§×˜× ×”. ×ª× ×¡×” ×©×•×‘?', false);
                    }
                    return; // STOP HERE
                }
                
                // ğŸ’° HANDLE BUDGET QUERIES (e.g., "××ª× ×” ×œ×™×œ×“ ×¢×“ 50 ×©×—") - Send to N8N with budget info!
                if (hasBudget) {
                    console.log('ğŸ’° BUDGET QUERY detected - sending to N8N');
                    
                    // Extract budget from message (e.g., "×¢×“ 50 ×©×—" -> 50)
                    const budgetMatch = userMessage.match(/(\d+)\s*(×©×—|×©"×—|×©×´×—|â‚ª)?/);
                    const budget = budgetMatch ? parseInt(budgetMatch[1]) : null;
                    console.log('ğŸ’° Extracted budget:', budget);
                    
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'budget',
                                budget: budget,
                                pages: allPages,  // ğŸ¯ ×©×œ×™×—×ª ×›×œ ×”×“×¤×™× ×¢× ×›×œ ×”×¤×¨×˜×™×
                                availablePagesCount: allPages.length,
                                context: {
                                    lastSearchCategory: window.stavConversationContext.lastSearchCategory,
                                    lastShownPages: window.stavConversationContext.lastShownPages.map(p => p.title),
                                    conversationHistory: window.stavConversationContext.conversationHistory
                                }
                            })
                        });
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // ğŸ” FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            
                            // ğŸ” FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            
                            // ğŸ” FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            // ğŸ¯ Extract response field
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : (n8nData.message || '××—×¤×© ××•×¦×¨×™× ×‘×ª×§×¦×™×‘ ×©×œ×š...');
                            addStavMessage(botResponse, false);
                            
                            // If N8N returned specific pages, display them
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = allPages.find(p => p.title.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage) {
                                        const pageUrl = matchingPage.url;
                                        const previewHtml = `
                                            <div class="page-preview-container" style="margin-top: 15px; text-align: right; direction: rtl;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px 12px 0 0; font-weight: 600;">
                                                    ğŸ“„ ${matchingPage.title}
                                                </div>
                                                <iframe src="${pageUrl}" style="width: 100%; height: 300px; border: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>
                                            </div>
                                        `;
                                        addStavMessage(previewHtml, false);
                                    }
                                }
                            }
                        } else {
                            addStavMessage('××—×¤×© ××•×¦×¨×™× ×‘×ª×§×¦×™×‘ ×©×œ×š...', false);
                        }
                    } catch (error) {
                        console.error('N8N error:', error);
                        removeStavTypingIndicator();
                        addStavMessage('××—×¤×© ××•×¦×¨×™× ×‘×ª×§×¦×™×‘ ×©×œ×š...', false);
                    }
                    return; // STOP HERE
                }
                
                // ğŸ§  HANDLE FOLLOW-UP QUESTIONS (e.g., "×•×™×© ×¢×•×“ ×—× ×™×•×ª?")
                if (isFollowUpQuestion) {
                    console.log('ğŸ’¬ FOLLOW-UP QUESTION detected - sending to N8N with context');
                    
                    // Send to N8N with full context
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'followup',
                                context: {
                                    lastSearchCategory: window.stavConversationContext.lastSearchCategory,
                                    lastShownPages: window.stavConversationContext.lastShownPages.map(p => p.title),
                                    conversationHistory: window.stavConversationContext.conversationHistory.slice(-5)
                                },
                                pages: allPages,  // ğŸ¯ ×©×œ×™×—×ª ×›×œ ×”×“×¤×™× ×¢× ×›×œ ×”×¤×¨×˜×™×
                                availablePagesCount: allPages.length,
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        removeStavTypingIndicator();
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // ğŸ” FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            
                            // ğŸ” FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            
                            // ğŸ” FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            // ğŸ¯ Extract response field
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : (n8nData.message || '×›×Ÿ! ×™×© ×¢×•×“ ××¤×©×¨×•×™×•×ª ğŸ˜Š');
                            addStavMessage(botResponse, false);
                            
                            // If N8N returned specific pages, display them
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = allPages.find(p => p.title.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage && !window.stavConversationContext.lastShownPages.includes(matchingPage)) {
                                        const pageUrl = matchingPage.url;
                                        const previewHtml = `
                                            <div class="page-preview-container" style="margin-top: 15px; text-align: right; direction: rtl;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px 12px 0 0; font-weight: 600;">
                                                    ğŸ“„ ${matchingPage.title}
                                                </div>
                                                <iframe src="${pageUrl}" style="width: 100%; height: 300px; border: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>
                                            </div>
                                        `;
                                        addStavMessage(previewHtml, false);
                                        window.stavConversationContext.lastShownPages.push(matchingPage);
                                    }
                                }
                            }
                        } else {
                            addStavMessage('×›×Ÿ! ×™×© ×¢×•×“ ××¤×©×¨×•×™×•×ª ğŸ˜Š', false);
                        }
                    } catch (error) {
                        console.error('N8N error:', error);
                        removeStavTypingIndicator();
                        addStavMessage('×›×Ÿ! ×™×© ×¢×•×“ ××¤×©×¨×•×™×•×ª ğŸ˜Š', false);
                    }
                    return; // STOP HERE
                }
                
                // If it's a RECOMMENDATION query without specific product - Send to N8N for smart suggestions!
                if (isRecommendation && !hasProductKeyword) {
                    console.log('ğŸ’¡ Recommendation query detected - sending to N8N for smart suggestions');
                    
                    // ğŸ¯ Smart page selection for recommendations
                    const smartSelectedPages = smartPageSelection(allPages, userMessage, 8);
                    console.log(`ğŸ¯ Recommendation - selected ${smartSelectedPages.length} pages from ${allPages.length} total`);
                    
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,
                                type: 'recommendation',
                                pages: smartSelectedPages,  // ğŸ¯ ×©×œ×™×—×ª ×‘×—×™×¨×” ×—×›××”
                                allPagesCount: allPages.length,  // ××¡×¤×¨ ×›×œ ×”×“×¤×™×
                                availablePagesCount: allPages.length,
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        removeStavTypingIndicator();
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            
                            // ğŸ” FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                n8nData = n8nData[0];
                            }
                            
                            // ğŸ” FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                n8nData = n8nData.output;
                            }
                            
                            // ğŸ” FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    n8nData = JSON.parse(n8nData);
                                } catch (e) {
                                    console.warn('Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            // ğŸ¯ Extract response field
                            const botResponse = (typeof n8nData === 'object' && n8nData.response) ? n8nData.response : (n8nData.message || '××©××— ×œ×¢×–×•×¨! ××” ×ª×—×•× ×”×¢× ×™×™×Ÿ?');
                            addStavMessage(botResponse, false);
                            
                            // If N8N returned specific pages, display them
                            if (n8nData.pages && n8nData.pages.length > 0) {
                                for (const suggestedPage of n8nData.pages) {
                                    const matchingPage = allPages.find(p => p.title.includes(suggestedPage.title) || p.pageId === suggestedPage.pageId);
                                    if (matchingPage) {
                                        // Display page preview
                                        const pageUrl = matchingPage.url;
                                        const previewHtml = `
                                            <div class="page-preview-container" style="margin-top: 15px; text-align: right; direction: rtl;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 12px 12px 0 0; font-weight: 600;">
                                                    ğŸ“„ ${matchingPage.title}
                                                </div>
                                                <iframe src="${pageUrl}" style="width: 100%; height: 300px; border: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></iframe>
                                            </div>
                                        `;
                                        addStavMessage(previewHtml, false);
                                    }
                                }
                            }
                        } else {
                            addStavMessage('××©××— ×œ×¢×–×•×¨! ××” ×ª×—×•× ×”×¢× ×™×™×Ÿ?', false);
                        }
                    } catch (error) {
                        console.error('N8N error:', error);
                        removeStavTypingIndicator();
                        addStavMessage('××©××— ×œ×¢×–×•×¨! ××” ×ª×—×•× ×”×¢× ×™×™×Ÿ?', false);
                    }
                    return; // STOP HERE
                }
                
                // If it's a greeting OR general conversation OR knowledge question (and NOT a product search!)
                if ((isGreeting || isConversation || isKnowledgeQuestion) && !hasProductKeyword && !isRecommendation) {
                    // GREETING - Send to N8N for friendly response
                    console.log('ğŸ‘‹ This is a greeting - sending to N8N');
                    
                    // ğŸ¯ For greetings, send a smaller sample of pages
                    const smartSelectedPages = smartPageSelection(allPages, userMessage, 4);
                    console.log(`ğŸ¯ Greeting - selected ${smartSelectedPages.length} pages from ${allPages.length} total`);
                    
                    const n8nWebhook = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
                    
                    try {
                        const n8nResponse = await fetch(n8nWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userMessage,  // ğŸ¯ userMessage is already cleaned!
                                originalMessage: originalMessage,  // ×©××™×¨×ª ×”××§×•×¨ ×œ××§×¨×” ×”×¦×•×¨×š
                                type: 'greeting',
                                pages: smartSelectedPages,  // ğŸ¯ ×©×œ×™×—×ª ×‘×—×™×¨×” ×—×›××” ×‘××§×•× ×›×œ ×”×“×¤×™×
                                allPagesCount: allPages.length,  // ××¡×¤×¨ ×›×œ ×”×“×¤×™× ×œ×§×•× ×˜×§×¡×˜
                                availablePagesCount: allPages.length,
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        removeStavTypingIndicator();
                        
                        if (n8nResponse.ok) {
                            let n8nData = await n8nResponse.json();
                            console.log('ğŸ” Raw n8nData:', n8nData, 'Type:', typeof n8nData);
                            
                            // ğŸ” FIX: If n8nData is an array, take the first element
                            if (Array.isArray(n8nData) && n8nData.length > 0) {
                                console.log('ğŸ” n8nData is array, taking first element...');
                                n8nData = n8nData[0];
                                console.log('âœ… After taking first element:', n8nData);
                            }
                            
                            // ğŸ” FIX: If there's an "output" field, use it
                            if (n8nData && n8nData.output) {
                                console.log('ğŸ” Found output field, extracting...');
                                n8nData = n8nData.output;
                                console.log('âœ… After extracting output:', n8nData);
                            }
                            
                            // ğŸ” FIX: Parse if n8nData is a JSON string
                            if (typeof n8nData === 'string' && n8nData.trim().startsWith('{')) {
                                try {
                                    console.log('ğŸ” Parsing n8nData as JSON string...');
                                    n8nData = JSON.parse(n8nData);
                                    console.log('âœ… Parsed n8nData:', n8nData);
                                } catch (e) {
                                    console.warn('âŒ Failed to parse n8nData as JSON:', e);
                                }
                            }
                            
                            // ğŸ¯ CRITICAL FIX: Always extract response field if it exists
                            console.log('ğŸ” [GREETING] n8nData type:', typeof n8nData);
                            console.log('ğŸ” [GREETING] n8nData value:', n8nData);
                            console.log('ğŸ” [GREETING] n8nData.response:', n8nData?.response);
                            
                            let botResponse;
                            
                            // If n8nData is a string that's JSON, parse it
                            if (typeof n8nData === 'string') {
                                if (n8nData.trim().startsWith('{')) {
                                    try {
                                        console.log('ğŸ” [GREETING] Parsing string as JSON...');
                                        n8nData = JSON.parse(n8nData);
                                        console.log('ğŸ” [GREETING] Parsed n8nData:', n8nData);
                                    } catch (e) {
                                        console.warn('âŒ [GREETING] Failed to parse:', e);
                                    }
                                }
                            }
                            
                            // Now extract response
                            if (typeof n8nData === 'object' && n8nData !== null && n8nData.response) {
                                botResponse = n8nData.response;
                                console.log('âœ… [GREETING] Extracted response:', botResponse);
                            } else if (typeof n8nData === 'string') {
                                botResponse = n8nData;
                                console.log('âœ… [GREETING] Using string as-is:', botResponse);
                            } else {
                                botResponse = n8nData?.message || '×©×œ×•×! ××™×š ×× ×™ ×™×›×•×œ×” ×œ×¢×–×•×¨ ×œ×š? ğŸ˜Š';
                                console.log('âœ… [GREETING] Using fallback:', botResponse);
                            }
                            
                            console.log('ğŸ¤– [GREETING] Final botResponse to display:', botResponse);
                            console.log('ğŸ¤– [GREETING] botResponse type:', typeof botResponse);
                            addStavMessage(botResponse, false);
                            stavFirstReplySent = true;
                        } else {
                            addStavMessage(stavLocalFallbackReply(originalMessage || userMessage), false);
                            stavFirstReplySent = true;
                        }
                    } catch (error) {
                        console.error('N8N error:', error);
                        removeStavTypingIndicator();
                        addStavMessage(stavLocalFallbackReply(originalMessage || userMessage), false);
                        stavFirstReplySent = true;
                    }
                    return; // STOP HERE - Don't search for pages
                }
                
                // NOT A GREETING - SMART SEARCH with recommendations!
                console.log('ğŸ” SMART SEARCH for:', userMessage);
                
                // ğŸ§  CHECK IF USER IS ASKING ABOUT THE LAST PAGE (e.g., "××” ×”××—×™×¨×™× ×©×")
                const contextReferences = ['×©×', '×©××”', '×‘×“×£ ×”×–×”', '×‘××•×ª×•', '×©×”×¨××™×ª', '×©×”×¦×’×ª', '×‘×•', '×‘×”', '×›××Ÿ', '×¤×”', '×‘×–×”', '×‘×—× ×•×ª ×”×–×•', '×‘××•×ª×” ×—× ×•×ª'];
                const isContextReference = contextReferences.some(ref => userMessage.toLowerCase().includes(ref));
                
                if (isContextReference && window.stavConversationContext.lastShownPages.length > 0) {
                    console.log('ğŸ§  CONTEXT REFERENCE detected - User is asking about:', window.stavConversationContext.lastShownPages[0].title);
                    console.log('ğŸ§  Last search category was:', window.stavConversationContext.lastSearchCategory);
                    
                    // Use the last shown page's category as the search term!
                    const lastPage = window.stavConversationContext.lastShownPages[0];
                    const searchTerm = window.stavConversationContext.lastSearchCategory || lastPage.title.toLowerCase();
                    
                    console.log(`ğŸ§  Using context: "${userMessage}" â†’ Searching for "${searchTerm}"`);
                    
                    // Continue with the search using the context-based search term
                    // (The rest of the code will use this searchTerm)
                }
                
                // ğŸ§  If context reference, use the last search category instead!
                let searchTerm;
                if (isContextReference && window.stavConversationContext.lastSearchCategory) {
                    searchTerm = window.stavConversationContext.lastSearchCategory;
                    console.log(`ğŸ§  Using last search category: "${searchTerm}"`);
                } else {
                    searchTerm = userMessage.toLowerCase(); // userMessage is already cleaned by cleanUserMessage()
                    console.log(`ğŸ” Using search term: "${searchTerm}"`);
                }
                
                let relevantPages = []; // Changed from const to let for filtering
                
                // ğŸ’° PRICE COMPARISON DETECTION - ×–×™×”×•×™ ×”×©×•×•××ª ××—×™×¨×™× (using isPriceQuery from line 4262)
                console.log('ğŸ’° Is price query?', isPriceQuery, '| search term:', searchTerm);
                
                // ğŸ’° IF THIS IS A PRICE QUERY - We'll still do search first to find relevant pages!
                if (isPriceQuery) {
                    console.log('ğŸ’° PRICE QUERY DETECTED - Will search for relevant pages FIRST, then compare prices');
                    // We'll do price comparison AFTER we find relevant pages based on the category
                }
                
                // ğŸ¯ SMART KEYWORD MAPPING - ××™×œ×•×ª ××¤×ª×— ×œ×§×˜×’×•×¨×™×•×ª
                // âš ï¸ ORDER MATTERS! More specific queries FIRST (e.g., "××ª× ×” ×œ×™×œ×“" before "××ª× ×”")
                // âš ï¸ DON'T include price words like "×–×•×œ", "×™×§×¨" - they are price queries, not categories!
                const smartKeywords = {
                    '××ª× ×” ×œ×™×œ×“': ['×¦×¢×¦×•×¢', '××©×—×§'],        // â­ Must be BEFORE "××ª× ×”"
                    '××ª× ×” ×œ×™×œ×“×™×': ['×¦×¢×¦×•×¢', '××©×—×§'],      // â­ Must be BEFORE "××ª× ×”"
                    '××ª× ×” ×œ×‘×Ÿ': ['×¦×¢×¦×•×¢', '××©×—×§'],         // â­ Must be BEFORE "××ª× ×”"
                    '××ª× ×” ×œ×‘×ª': ['×¦×¢×¦×•×¢', '××©×—×§', '×œ×§'],  // â­ Must be BEFORE "××ª× ×”"
                    '××ª× ×”': ['×©×¢×•×Ÿ', '×ª×›×©×™×˜', '×¦×¢×¦×•×¢', '×œ×§', '×˜×›× ×•×œ×•×’×™×”'], // General "gift"
                    '××ª× ×•×ª': ['×©×¢×•×Ÿ', '×ª×›×©×™×˜', '×¦×¢×¦×•×¢', '×œ×§', '×˜×›× ×•×œ×•×’×™×”'],
                    '××™×©×”': ['×œ×§', '×ª×›×©×™×˜', '×©×¢×•×Ÿ'],
                    '× ×©×™×': ['×œ×§', '×ª×›×©×™×˜', '×©×¢×•×Ÿ'],
                    '×’×‘×¨': ['×©×¢×•×Ÿ', '×˜×›× ×•×œ×•×’×™×”', '××‘×™×–×¨'],
                    '×’×‘×¨×™×': ['×©×¢×•×Ÿ', '×˜×›× ×•×œ×•×’×™×”', '××‘×™×–×¨'],
                    '×™×œ×“': ['×¦×¢×¦×•×¢', '××©×—×§', '×œ×™××•×“'],        // â­ ×™×œ×“ â†’ ×¦×¢×¦×•×¢
                    '×™×œ×“×™×': ['×¦×¢×¦×•×¢', '××©×—×§', '×œ×™××•×“'],      // â­ ×™×œ×“×™× â†’ ×¦×¢×¦×•×¢
                    '×™×œ×“×”': ['×¦×¢×¦×•×¢', '××©×—×§', '×œ×™××•×“', '×œ×§'], // â­ ×™×œ×“×” â†’ ×¦×¢×¦×•×¢
                    '×™×œ×“×•×ª': ['×¦×¢×¦×•×¢', '××©×—×§', '×œ×™××•×“', '×œ×§'], // â­ ×™×œ×“×•×ª â†’ ×¦×¢×¦×•×¢
                    '×œ×™×œ×“': ['×¦×¢×¦×•×¢', '××©×—×§'],                 // â­ ×œ×™×œ×“ â†’ ×¦×¢×¦×•×¢
                    '×œ×™×œ×“×™×': ['×¦×¢×¦×•×¢', '××©×—×§'],              // â­ ×œ×™×œ×“×™× â†’ ×¦×¢×¦×•×¢
                    '××•×¦×¨ ×œ×™×œ×“': ['×¦×¢×¦×•×¢', '××©×—×§'],
                    '××•×¦×¨ ×œ×™×œ×“×™×': ['×¦×¢×¦×•×¢', '××©×—×§'],
                    '××©×—×§': ['×¦×¢×¦×•×¢'],
                    '××©×—×§×™×': ['×¦×¢×¦×•×¢'],
                    '×¦×¢×¦×•×¢×™×': ['×¦×¢×¦×•×¢'], // ×¦×¢×¦×•×¢×™× â†’ ×¦×¢×¦×•×¢
                    '×¦×¢×¦×•×¢×™': ['×¦×¢×¦×•×¢'], // ×¦×¢×¦×•×¢×™ â†’ ×¦×¢×¦×•×¢
                    '×©×™×¨×•×ª': ['×©×¨×•×ª', '×§×•×¨×¡', '×œ×§'], // ×©×™×¨×•×ª×™× ××§×¦×•×¢×™×™×
                    '×©×¨×•×ª': ['×©×™×¨×•×ª', '×§×•×¨×¡', '×œ×§'], // ×©×¨×•×ª×™× â†’ ×©×™×¨×•×ª
                    '×©×™×¨×•×ª×™×': ['×©×™×¨×•×ª', '×©×¨×•×ª', '×§×•×¨×¡', '×œ×§'],
                    '×©×¨×•×ª×™×': ['×©×™×¨×•×ª', '×©×¨×•×ª', '×§×•×¨×¡', '×œ×§'],
                    '×¡×¤×¨': ['××¡×¤×¨×”', '×ª×¡×¤×•×¨×ª'], // ××—×¤×© ×¡×¤×¨ â†’ ××¡×¤×¨×”
                    '×ª×¡×¤×•×¨×ª': ['××¡×¤×¨×”', '××¡×¤×¨×”'],
                    '××¡×¤×¨×”': ['××¡×¤×¨×”']
                };
                
                // Check if this is a SMART query (like "××ª× ×”")
                // âš ï¸ IMPORTANT: Use FIRST match only (most specific wins!)
                let isSmartQuery = false;
                let smartCategories = [];
                
                for (const [keyword, categories] of Object.entries(smartKeywords)) {
                    if (searchTerm.includes(keyword)) {
                        isSmartQuery = true;
                        smartCategories = [...categories]; // Replace, don't append!
                        console.log(`ğŸ¯ Smart query detected: "${keyword}" â†’ Looking for:`, categories);
                        break; // â­ STOP after first match! (most specific)
                    }
                }
                
                // Smart search with variations (MORE VARIATIONS!)
                let searchVariations = [
                    searchTerm,
                    searchTerm.replace(/×™×$/, ''), // Remove plural: ×¦×¢×¦×•×¢×™× â†’ ×¦×¢×¦×•×¢
                    searchTerm.replace(/×•×ª$/, ''), // Remove feminine plural
                    searchTerm.replace(/×™$/, ''), // Remove possessive: ×¦×¢×¦×•×¢×™ â†’ ×¦×¢×¦×•×¢
                    searchTerm.replace(/×”$/, ''), // Remove definite article: ×¦×¢×¦×•×¢×” â†’ ×¦×¢×¦×•×¢
                    searchTerm + '×™×', // Add plural: ×¦×¢×¦×•×¢ â†’ ×¦×¢×¦×•×¢×™×
                    searchTerm + '×•×ª', // Add feminine plural
                    searchTerm + '×™', // Add possessive: ×¦×¢×¦×•×¢ â†’ ×¦×¢×¦×•×¢×™
                    searchTerm + '×”', // Add definite article
                ];
                
                // Remove duplicates
                searchVariations = [...new Set(searchVariations)];
                
                // If smart query, ADD the smart categories to search
                if (isSmartQuery) {
                    searchVariations = [...searchVariations, ...smartCategories];
                    console.log('ğŸ¯ Smart query detected - Extended search terms:', searchVariations);
                }
                
                console.log('ğŸ” All search variations:', searchVariations);
                
                // Search through all real pages (INCLUDING product content!)
                // Even for PRICE queries, we need to find relevant pages first!
                for (const page of allPages) {
                    let matchScore = 0;
                    let matchReasons = [];
                    
                    // Try to fetch LIVE HTML content to search products
                    try {
                        const pageResponse = await fetch(page.url);
                        if (pageResponse.ok) {
                            const html = await pageResponse.text();
                            const liveProducts = extractLiveProductsStav(html);
                            
                            console.log(`ğŸ“¦ "${page.title}" has ${liveProducts.length} products:`, liveProducts.map(p => p.name));
                            
                            // Search in PRODUCTS (most important!)
                            for (const variation of searchVariations) {
                                for (const product of liveProducts) {
                                    if (product.name.toLowerCase().includes(variation)) {
                                        matchScore += 15; // Products get HIGHEST score!
                                        matchReasons.push(`product "${product.name}" contains "${variation}"`);
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.log(`âš ï¸ Could not fetch products for "${page.title}"`);
                    }
                    
                    // Also search in title, description, and pageType
                    for (const variation of searchVariations) {
                        const titleMatch = page.title.toLowerCase().includes(variation);
                        const descMatch = page.description && page.description.toLowerCase().includes(variation);
                        const pageTypeMatch = page.pageType && page.pageType.toLowerCase().includes(variation);
                        
                        if (titleMatch) {
                            matchScore += 10;
                            matchReasons.push(`title contains "${variation}"`);
                        }
                        if (descMatch) {
                            matchScore += 5;
                            matchReasons.push(`description contains "${variation}"`);
                        }
                        if (pageTypeMatch) {
                            matchScore += 8;
                            matchReasons.push(`pageType contains "${variation}"`);
                        }
                    }
                    
                    if (matchScore > 0) {
                        page.matchScore = matchScore;
                        page.matchReasons = matchReasons;
                        relevantPages.push(page);
                        console.log(`   âœ… "${page.title}": score=${matchScore}, reasons:`, matchReasons);
                    } else {
                        console.log(`   âŒ "${page.title}": no match`);
                    }
                }
                
                // ğŸ’° IF PRICE QUERY with NO category - Use ALL pages
                if (isPriceQuery && relevantPages.length === 0) {
                    console.log('ğŸ’° Price query with no specific category - using ALL pages');
                    relevantPages = allPages;
                }
                
                // ğŸ¯ SMART FILTERING - ×¡×™× ×•×Ÿ ×œ×¤×™ ×”×§×©×¨
                // ×× ×©××œ×• ×¢×œ "×™×œ×“/×™×œ×“×™×", ×¡× ×Ÿ ×©×¢×•× ×™×, ×ª×›×©×™×˜×™×, ×•×œ×§ (×œ× ××ª××™× ×œ×™×œ×“×™×!)
                if (searchTerm.includes('×™×œ×“') || searchTerm.includes('××•×¦×¨ ×œ×™×œ×“') || searchTerm.includes('××ª× ×” ×œ×™×œ×“')) {
                    console.log('ğŸ¯ Smart filter: Removing watches/jewelry/nail polish for kids');
                    relevantPages = relevantPages.filter(page => {
                        const title = page.title.toLowerCase();
                        const isWatch = title.includes('×©×¢×•×Ÿ');
                        const isJewelry = title.includes('×ª×›×©×™×˜') || title.includes('×™×”×œ×•×');
                        const isNailPolish = title.includes('×œ×§');
                        
                        if (isWatch || isJewelry || isNailPolish) {
                            console.log(`   ğŸš« Filtered out "${page.title}" - not suitable for kids`);
                            return false;
                        }
                        return true;
                    });
                }
                
                // Sort by match score (highest first)
                relevantPages.sort((a, b) => b.matchScore - a.matchScore);
                
                // Remove typing indicator NOW
                removeStavTypingIndicator();
                
                console.log(`âœ… ×¡×ª×™×• ××¦××” ${relevantPages.length} ×“×¤×™× ×××™×ª×™×™× (××—×¨×™ ×¡×™× ×•×Ÿ)`);
                
                // ğŸ’° PRICE COMPARISON LOGIC - ×”×©×•×•××ª ××—×™×¨×™×
                if (isPriceQuery && relevantPages.length > 0) {
                    console.log('ğŸ’° Running PRICE COMPARISON...');
                    console.log('ğŸ’° Relevant pages for price comparison:', relevantPages.map(p => p.title));
                    
                    // ğŸ§  UPDATE CONTEXT MEMORY
                    window.stavConversationContext.lastSearchCategory = searchTerm;
                    window.stavConversationContext.lastShownPages = relevantPages.slice(0, 5);  // Save top 5 pages
                    console.log('ğŸ§  Context updated (price comparison):', window.stavConversationContext);
                    
                    // Collect ALL products from ALL pages
                    let allProducts = [];
                    for (const page of relevantPages) {
                        try {
                            console.log(`ğŸ’° Fetching products from: ${page.title} (${page.url})`);
                            const pageResponse = await fetch(page.url);
                            if (pageResponse.ok) {
                                const html = await pageResponse.text();
                                console.log(`ğŸ’° Fetched HTML (length: ${html.length}), now extracting products...`);
                                const liveProducts = extractLiveProductsStav(html);
                                console.log(`ğŸ’° Extracted ${liveProducts.length} products from ${page.title}:`, liveProducts);
                                
                                // Add page info to each product
                                liveProducts.forEach(product => {
                                    product.pageName = page.title;
                                    product.pageUrl = page.url;
                                });
                                
                                allProducts = [...allProducts, ...liveProducts];
                            }
                        } catch (error) {
                            console.error(`Error fetching ${page.title}:`, error);
                        }
                    }
                    
                    // ğŸ§  SMART CATEGORY EXTRACTION - Extract category from user's question
                    const categoryKeywords = ['×¦×¢×¦×•×¢', '×¦×¢×¦×•×¢×™×', '×ª×›×©×™×˜', '×ª×›×©×™×˜×™×', '×©×¢×•×Ÿ', '×©×¢×•× ×™×', '×˜×›× ×•×œ×•×’×™×”', '×§×•×¨×¡', '×§×•×¨×¡×™×', '×œ×§', '××ª× ×”', '××ª× ×•×ª', '×©×™×¨×•×ª', '×©×¨×•×ª', '×©×¨×•×ª×™×', '×©×™×¨×•×ª×™×'];
                    let categoryFilter = null;
                    for (const keyword of categoryKeywords) {
                        if (searchTerm.includes(keyword)) {
                            categoryFilter = keyword.replace('×™×', '').replace('×•×ª', ''); // Remove plural endings
                            console.log(`ğŸ¯ Category filter detected: "${categoryFilter}" from search term "${searchTerm}"`);
                            break;
                        }
                    }
                    
                    // Filter products with valid prices
                    let productsWithPrices = allProducts.filter(p => p.price && !isNaN(parseFloat(p.price)));
                    console.log(`ğŸ’° Total products with prices (before category filter): ${productsWithPrices.length}`, productsWithPrices.map(p => p.name));
                    
                    // ğŸ¯ FILTER BY CATEGORY if detected - STRICT FILTERING!
                    if (categoryFilter) {
                        const originalCount = productsWithPrices.length;
                        
                        // ğŸš« EXCLUSION LIST - Categories to EXCLUDE
                        const exclusions = {
                            '×¦×¢×¦×•×¢': ['×ª×›×©×™×˜', '×œ×§', '×©×¢×•×Ÿ', '×˜×›× ×•×œ×•×’×™', '×§×•×¨×¡', '×©×™×¨×•×ª', '×©×¨×•×ª'],
                            '×ª×›×©×™×˜': ['×¦×¢×¦×•×¢', '×œ×§', '×§×•×¨×¡', '×˜×›× ×•×œ×•×’×™', '×©×™×¨×•×ª', '×©×¨×•×ª'],
                            '×©×¢×•×Ÿ': ['×¦×¢×¦×•×¢', '×ª×›×©×™×˜', '×œ×§', '×§×•×¨×¡', '×©×™×¨×•×ª', '×©×¨×•×ª'],
                            '×˜×›× ×•×œ×•×’×™×”': ['×¦×¢×¦×•×¢', '×ª×›×©×™×˜', '×œ×§', '×©×¢×•×Ÿ', '×§×•×¨×¡', '×©×™×¨×•×ª', '×©×¨×•×ª'],
                            '×§×•×¨×¡': ['×¦×¢×¦×•×¢', '×ª×›×©×™×˜', '×œ×§', '×©×¢×•×Ÿ', '×˜×›× ×•×œ×•×’×™', '×©×™×¨×•×ª', '×©×¨×•×ª'],
                            '×œ×§': ['×¦×¢×¦×•×¢', '×ª×›×©×™×˜', '×©×¢×•×Ÿ', '×˜×›× ×•×œ×•×’×™', '×§×•×¨×¡', '×©×™×¨×•×ª', '×©×¨×•×ª'],
                            '×©×™×¨×•×ª': ['×¦×¢×¦×•×¢', '×ª×›×©×™×˜', '×©×¢×•×Ÿ', '×˜×›× ×•×œ×•×’×™', '×§×•×¨×¡', '×œ×§'],
                            '×©×¨×•×ª': ['×¦×¢×¦×•×¢', '×ª×›×©×™×˜', '×©×¢×•×Ÿ', '×˜×›× ×•×œ×•×’×™', '×§×•×¨×¡', '×œ×§']
                        };
                        
                        productsWithPrices = productsWithPrices.filter(product => {
                            const productName = product.name.toLowerCase();
                            const pageName = product.pageName.toLowerCase();
                            const fullText = `${productName} ${pageName}`;
                            
                            // âœ… Must INCLUDE the category
                            const includesCategory = fullText.includes(categoryFilter.toLowerCase());
                            
                            // ğŸš« Must NOT include excluded categories
                            let hasExclusion = false;
                            if (exclusions[categoryFilter]) {
                                for (const excludeWord of exclusions[categoryFilter]) {
                                    if (fullText.includes(excludeWord.toLowerCase())) {
                                        hasExclusion = true;
                                        console.log(`âŒ Product "${product.name}" from "${product.pageName}" EXCLUDED (found "${excludeWord}")`);
                                        break;
                                    }
                                }
                            }
                            
                            const matches = includesCategory && !hasExclusion;
                            if (matches) {
                                console.log(`âœ… Product "${product.name}" from "${product.pageName}" MATCHES category "${categoryFilter}"`);
                            }
                            return matches;
                        });
                        console.log(`ğŸ¯ After STRICT category filter "${categoryFilter}": ${productsWithPrices.length} products (was ${originalCount})`);
                    }
                    
                    if (productsWithPrices.length > 0) {
                        // Sort by price
                        productsWithPrices.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                        
                        const cheapest = productsWithPrices[0];
                        const mostExpensive = productsWithPrices[productsWithPrices.length - 1];
                        console.log(`ğŸ’° Price range: ${cheapest.price} (cheapest: ${cheapest.name}) to ${mostExpensive.price} (most expensive: ${mostExpensive.name})`);
                        
                        // Determine what user wants
                        const wantsCheapest = searchTerm.includes('×–×•×œ') || searchTerm.includes('×”×–×•×œ');
                        const wantsExpensive = searchTerm.includes('×™×§×¨') || searchTerm.includes('×”×™×§×¨');
                        
                        // ğŸ¤– CONVERSATIONAL RESPONSE - Talk like a friend!
                        let priceMessage = '';
                        
                        if (wantsCheapest) {
                            priceMessage += `ğŸ¤– **×™×© ×œ×™ "${cheapest.name}" ×‘××—×™×¨ â‚ª${cheapest.price}** - ×–×” ×”××•×¦×¨ ×”×›×™ ×–×•×œ ×‘××¨×§×˜!\n\n`;
                            priceMessage += `ğŸ“ ×”×•× × ××¦× ×‘**${cheapest.pageName.replace(/_\d{13}(_html)?$/, '').replace(/_/g, ' ')}**\n\n`;
                            priceMessage += `ğŸ’¡ **×¨×•×¦×” ×©××—×¤×© ×œ×š ×¢×•×“ ××©×”×•?** ××• ×¨×•×¦×” ×œ×¨××•×ª ××ª ×”×“×£?`;
                        } else if (wantsExpensive) {
                            priceMessage += `ğŸ¤– **×™×© ×œ×™ "${mostExpensive.name}" ×‘××—×™×¨ â‚ª${mostExpensive.price}** - ×–×” ×”××•×¦×¨ ×”×›×™ ×™×§×¨ ×‘××¨×§×˜!\n\n`;
                            priceMessage += `ğŸ“ ×”×•× × ××¦× ×‘**${mostExpensive.pageName.replace(/_\d{13}(_html)?$/, '').replace(/_/g, ' ')}**\n\n`;
                            priceMessage += `ğŸ’¡ **×¨×•×¦×” ×©××—×¤×© ×œ×š ×¢×•×“ ××©×”×•?** ××• ×¨×•×¦×” ×œ×¨××•×ª ××ª ×”×“×£?`;
                        } else {
                            priceMessage += `ğŸ¤– **××¦××ª×™ ${productsWithPrices.length} ××•×¦×¨×™× ×‘-${relevantPages.length} ×—× ×•×™×•×ª!**\n\n`;
                            priceMessage += `ğŸ¥‡ **×”×›×™ ×–×•×œ:** ${cheapest.name} - â‚ª${cheapest.price}\n`;
                            priceMessage += `ğŸ’ **×”×›×™ ×™×§×¨:** ${mostExpensive.name} - â‚ª${mostExpensive.price}\n\n`;
                            priceMessage += `ğŸ’¡ **×¨×•×¦×” ×œ×¨××•×ª ××ª ×”××•×¦×¨×™×? ××• ×©××—×¤×© ×œ×š ××©×”×• ××—×¨?**`;
                        }
                        
                        addStavMessage(priceMessage, false);
                        
                        // ğŸ’¾ SAVE the recommended page in context so we can open it if user says "yes"
                        // âš ï¸ IMPORTANT: Save the page of the ACTUAL product we recommended (cheapest or most expensive)
                        const recommendedProduct = wantsCheapest ? cheapest : (wantsExpensive ? mostExpensive : cheapest);
                        window.stavConversationContext.recommendedPage = {
                            title: recommendedProduct.pageName,
                            url: recommendedProduct.pageUrl,
                            pageId: null // We don't have pageId in the product object
                        };
                        console.log('ğŸ’¾ Saved recommended page for product:', recommendedProduct.name, 'at', window.stavConversationContext.recommendedPage);
                        
                        return; // STOP HERE - We showed price comparison
                    }
                }
                
                // Show REAL pages with FULL DATA
                if (relevantPages.length > 0) {
                    console.log('ğŸ“± ××¦×™×’×” ×“×¤×™× ×××™×ª×™×™× ×¢× × ×ª×•× ×™× ××œ××™×');
                    
                    // ğŸ SMART MESSAGE for recommendations
                    let smartMessage = '';
                    if (isSmartQuery && searchTerm.includes('××ª× ×”')) {
                        smartMessage = `\n\nğŸ’¡ **××¦××ª×™ ×›××” ××•×¤×¦×™×•×ª ××¢×•×œ×•×ª ×œ××ª× ×”!**\n\n`;
                        smartMessage += `ğŸ **×¨×•×¦×” ×œ×¦××¦× ××ª ×”×—×™×¤×•×©?**\n`;
                        smartMessage += `â€¢ ××ª× ×” ×œ×’×‘×¨ ××• ×œ××™×©×”?\n`;
                        smartMessage += `â€¢ ×‘××™×–×” ×ª×§×¦×™×‘? (×–×•×œ / ×‘×™× ×•× ×™ / ×™×§×¨)\n`;
                        smartMessage += `â€¢ ××™×–×” ×¡×•×’ ××ª× ×”? (××•×¤× ×” / ×˜×›× ×•×œ×•×’×™×” / ×™×•×¤×™)\n\n`;
                    }
                    
                    // ğŸ¯ Show ALL relevant pages (or top 3 if more than 3)
                    const pagesToShow = relevantPages.slice(0, 3); // Show up to 3 pages
                    
                    // ğŸ§  UPDATE CONTEXT MEMORY
                    window.stavConversationContext.lastSearchCategory = searchTerm;
                    window.stavConversationContext.lastShownPages = pagesToShow;
                    console.log('ğŸ§  Context updated:', window.stavConversationContext);
                    
                    const pageCountMessage = pagesToShow.length === 1 
                        ? `ğŸ¯ **××¦××ª×™ ××ª ×”×“×£ ×”××•×©×œ× ×‘×©×‘×™×œ×š!**\n` 
                        : `ğŸ¯ **××¦××ª×™ ${pagesToShow.length} ×“×¤×™× ××ª××™××™×!**\n`;
                    addStavMessage(smartMessage + pageCountMessage, false);
                    
                    // ğŸ¯ Fetch LIVE page content for ALL pages to show
                    for (let i = 0; i < pagesToShow.length; i++) {
                        const currentPage = pagesToShow[i];
                        try {
                            const pageResponse = await fetch(currentPage.url);
                            if (pageResponse.ok) {
                                const html = await pageResponse.text();
                                const liveProducts = extractLiveProductsStav(html);
                                
                                console.log(`ğŸ’° Live products from ${currentPage.title}:`, liveProducts);
                                
                                // Build rich message with live data
                                let richMessage = `\n\nğŸª **${currentPage.title}**\n`;
                                if (currentPage.description) {
                                    richMessage += `${currentPage.description}\n`;
                                }
                                
                                // Add live products
                                if (liveProducts.length > 0) {
                                    richMessage += `\nğŸ’ **××•×¦×¨×™× ×–××™× ×™×:**\n`;
                                    liveProducts.slice(0, 5).forEach(product => {
                                        richMessage += `â€¢ ${product.name}`;
                                        if (product.price) {
                                            richMessage += ` - â‚ª${product.price}`;
                                        }
                                        richMessage += `\n`;
                                    });
                                    if (liveProducts.length > 5) {
                                        richMessage += `×•×¢×•×“ ${liveProducts.length - 5} ××•×¦×¨×™×...\n`;
                                    }
                                }
                                
                                richMessage += `\nğŸ”— [×¦×¤×” ×‘×“×£ ×”××œ×](${currentPage.url})\n`;
                                
                                // ğŸ¬ Delayed display for smooth animation
                                await new Promise(resolve => setTimeout(resolve, 800 * i)); // Wait before showing next card (slower)
                                
                                addStavMessage(richMessage, false);
                                
                                // Add animated preview for ALL pages (up to 3)
                                if (i < 3) {  // Show preview for up to 3 pages
                                    const chatMessages = document.getElementById('stavChatMessages');
                                    if (chatMessages) {
                                        const previewDiv = document.createElement('div');
                                        previewDiv.className = 'stav-message bot';
                                        previewDiv.style.cssText = `
                                            margin: 16px 0;
                                            border: 2px solid #e5e7eb;
                                            border-radius: 12px;
                                            overflow: hidden;
                                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                            width: 100%;
                                            max-width: 100%;
                                            height: 350px;
                                            opacity: 0;
                                            transform: translateY(40px) scale(0.9);
                                            transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
                                        `;
                                        
                                        const pageUrl = currentPage.url;
                                        const pageTitle = currentPage.title;
                                        previewDiv.innerHTML = 
                                            '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">' +
                                                '<span>ğŸ</span>' +
                                                '<span>' + pageTitle + '</span>' +
                                            '</div>' +
                                            '<div style="position: relative; height: 300px; overflow: hidden; background: #f9fafb;">' +
                                                '<div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);"></div>' +
                                                '<iframe src="' + pageUrl + '" style="width: 100%; height: 100%; border: none; transform: scale(0.7); transform-origin: top center; opacity: 0; transition: opacity 0.8s ease;" sandbox="allow-same-origin allow-scripts allow-popups allow-forms" onload="this.style.opacity=1"></iframe>' +
                                            '</div>';
                                        
                                        chatMessages.appendChild(previewDiv);
                                        
                                        // ğŸŒŠ Smooth scroll with animation
                                        chatMessages.scrollTo({
                                            top: chatMessages.scrollHeight,
                                            behavior: 'smooth'
                                        });
                                        
                                        // ğŸ¬ Animate in with bounce effect (slower, more elegant)
                                        setTimeout(() => {
                                            previewDiv.style.opacity = '1';
                                            previewDiv.style.transform = 'translateY(0) scale(1)';
                                        }, 300); // Slower, more elegant
                                    }
                                }
                            }
                        } catch (error) {
                            console.error(`Error fetching live page data for ${currentPage.title}:`, error);
                            // Fallback to basic display
                            let fallbackMessage = `\n\nğŸª **${currentPage.title}**\n`;
                            if (currentPage.description) {
                                fallbackMessage += `${currentPage.description}\n`;
                            }
                            fallbackMessage += `\nğŸ”— [×¦×¤×” ×‘×“×£](${currentPage.url})\n`;
                            addStavMessage(fallbackMessage, false);
                        }
                    }
                } else {
                    // NO PAGES FOUND - Tell user clearly
                    console.log('âŒ ×œ× × ××¦××• ×“×¤×™× ×¨×œ×•×•× ×˜×™×™×');
                    console.log('ğŸ“š ×›×œ ×”×“×¤×™×:', allPages.map(p => p.title));
                    
                    const availablePagesList = allPages.length > 0 
                        ? `\n\n×”×“×¤×™× ×”×–××™× ×™× ×›×¨×’×¢:\n${allPages.slice(0, 5).map(p => `â€¢ ${p.title}`).join('\n')}\n${allPages.length > 5 ? `\n×•×¢×•×“ ${allPages.length - 5} ×“×¤×™×...\n` : ''}`
                        : '\n\nâš ï¸ ××™×Ÿ ×“×¤×™× ×–××™× ×™× ×‘××¢×¨×›×ª ×›×¨×’×¢.';
                    
                    addStavMessage(`\n\nğŸ” **×œ× ××¦××ª×™ ×“×¤×™× ×¢× "${userMessage}" ×‘××¢×¨×›×ª.**${availablePagesList}\n\n××•×œ×™ ×ª×¨×¦×” ×œ×—×¤×© ××©×”×• ××—×¨? ğŸ˜Š`, false);
                }
                
            } catch (error) {
                console.error('âŒ Error in Stav chat:', error);
                removeStavTypingIndicator();
                addStavMessage('×¡×œ×™×—×”, ×§×¨×ª×” ×©×’×™××”. × ×¡×” ×©×•×‘! ğŸ˜Š', false);
            }
        }
        
        // Extract live products from HTML - SMART PRODUCT DETECTION
        function extractLiveProductsStav(html) {
            const products = [];
            
            console.log('ğŸ” Stav extractLiveProductsStav called, HTML length:', html.length);
            console.log('ğŸ“„ First 500 chars of HTML:', html.substring(0, 500));
            
            // â›” SMART EXCLUSIONS - ×“×‘×¨×™× ×©×”× ×œ× ××•×¦×¨×™×!
            const excludePatterns = [
                '× ×’×™×©×•×ª', '××•×“×•×ª', '×¦×•×¨ ×§×©×¨', '×“×£ ×”×‘×™×ª', '×¢×œ×™× ×•', '×ª×§× ×•×Ÿ', '××“×™× ×™×•×ª', 
                '×¤×¨×˜×™×•×ª', '×ª× ××™×', '×©×™×¨×•×ª', '××©×œ×•×—×™×', '×”×—×–×¨×•×ª', '××™×š ×œ×”×–××™×Ÿ',
                '×’×œ×¨×™', '×”××•×¦×¨×™×', '×ª×™××•×¨', '×”××™×•×—×“×™×', '×”×›×œ ×¢×œ', '×›×œ ×”×–×›×•×™×•×ª',
                '×–×›×•×™×•×ª ×™×•×¦×¨×™×', '×‘×¨×•×›×™× ×”×‘××™×', '×œ×§×•×—×•×ª', '×©××œ×•×ª', '×ª×©×•×‘×•×ª'
            ];
            
            // ğŸ¯ ONLY look for products inside product galleries!
            // Pattern 1: Look for product-grid or product-gallery sections
            const galleryMatch = html.match(/<div[^>]*class="[^"]*(?:product-grid|gallery|store-items)[^"]*"[^>]*>([\s\S]*?)<\/div>/gi);
            
            if (galleryMatch && galleryMatch.length > 0) {
                console.log('âœ… Found product gallery sections:', galleryMatch.length);
                
                galleryMatch.forEach(gallery => {
                    // Inside gallery, look for product items
                    // âš¡ NEW: Support both "product-item" AND "product-card"!
                    const itemPattern = /<div[^>]*class="[^"]*(?:product-item|product-card|gallery-item|store-item)[^"]*"[^>]*>([\s\S]*?)<\/div>/gi;
                    let itemMatch;
                    
                    while ((itemMatch = itemPattern.exec(gallery)) !== null) {
                        const itemHtml = itemMatch[1];
                        
                        // Extract product name (h3 or h4 inside item)
                        // âš¡ NEW: Also look for class="product-name"!
                        let nameMatch = itemHtml.match(/<h[34][^>]*class="[^"]*product-name[^"]*"[^>]*>([^<]+)<\/h[34]>/i);
                        if (!nameMatch) {
                            nameMatch = itemHtml.match(/<h[34][^>]*>([^<]+)<\/h[34]>/i);
                        }
                        
                        // Extract price
                        // âš¡ NEW: Also look for class="product-price"!
                        let priceMatch = itemHtml.match(/<[^>]*class="[^"]*product-price[^"]*"[^>]*>.*?â‚ª(\d+(?:[.,]\d+)?)/i);
                        if (!priceMatch) {
                            priceMatch = itemHtml.match(/â‚ª(\d+(?:[.,]\d+)?)|(\d+(?:[.,]\d+)?)\s*â‚ª/);
                        }
                        
                        if (nameMatch && priceMatch) {
                            const name = nameMatch[1].trim();
                            const price = parseFloat((priceMatch[1] || priceMatch[2]).replace(',', '.'));
                            
                            // Check if NOT excluded
                            const isExcluded = excludePatterns.some(pattern => 
                                name.toLowerCase().includes(pattern.toLowerCase())
                            );
                            
                            if (!isExcluded && name.length > 2 && name.length < 100 && price > 0) {
                                products.push({ name, price });
                                console.log(`   ğŸ“¦ Found product: "${name}" - â‚ª${price}`);
                            }
                        }
                    }
                });
            } else {
                console.log('âš ï¸ No product gallery found, trying fallback patterns...');
                
                // FALLBACK: If no gallery structure, look for items with both name AND price nearby
                // âš¡ NEW: Also look for "product-card"!
                const fallbackPattern = /<div[^>]*class="[^"]*(?:item|product-card|product-item)[^"]*"[^>]*>([\s\S]*?)<\/div>/gi;
                let fallbackMatch;
                
                while ((fallbackMatch = fallbackPattern.exec(html)) !== null) {
                    const itemHtml = fallbackMatch[1];
                    
                    // âš¡ NEW: Look for product-name class first!
                    let nameMatch = itemHtml.match(/<h[3-6][^>]*class="[^"]*product-name[^"]*"[^>]*>([^<]+)<\/h[3-6]>/i);
                    if (!nameMatch) {
                        nameMatch = itemHtml.match(/<h[3-6][^>]*>([^<]+)<\/h[3-6]>/i);
                    }
                    
                    // âš¡ NEW: Look for product-price class first!
                    let priceMatch = itemHtml.match(/<[^>]*class="[^"]*product-price[^"]*"[^>]*>.*?â‚ª(\d+(?:[.,]\d+)?)/i);
                    if (!priceMatch) {
                        priceMatch = itemHtml.match(/â‚ª(\d+(?:[.,]\d+)?)|(\d+(?:[.,]\d+)?)\s*â‚ª/);
                    }
                    
                    if (nameMatch && priceMatch) {
                        const name = nameMatch[1].trim();
                        const price = parseFloat((priceMatch[1] || priceMatch[2]).replace(',', '.'));
                        
                        const isExcluded = excludePatterns.some(pattern => 
                            name.toLowerCase().includes(pattern.toLowerCase())
                        );
                        
                        if (!isExcluded && name.length > 2 && name.length < 100 && price > 0) {
                            products.push({ name, price });
                            console.log(`   ğŸ“¦ Fallback found product: "${name}" - â‚ª${price}`);
                        }
                    }
                }
            }
            
            console.log(`âœ… Stav extractLiveProductsStav found ${products.length} REAL products:`, products);
            return products;
        }
        
        function addStavMessage(message, isUser = false) {
            const messagesDiv = document.getElementById('stavChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `stav-message ${isUser ? 'user' : 'bot'}`;
            
            // ğŸ¬ Add entrance animation (slower, more elegant)
            messageDiv.style.cssText = `
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            `;
            
            if (isUser) {
                messageDiv.textContent = message;
            } else {
                // Convert markdown-style links to clickable links
                let processedMessage = message.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea; text-decoration: underline;">$1</a>');
                
                // Add animated typing effect for bot messages
                messageDiv.innerHTML = '<span class="typing-text"></span>';
                messagesDiv.appendChild(messageDiv);
                
                // Animate typing effect
                const typingSpan = messageDiv.querySelector('.typing-text');
                let i = 0;
                const typeMessage = () => {
                    if (i < processedMessage.length) {
                        typingSpan.innerHTML += processedMessage.charAt(i);
                        i++;
                        setTimeout(typeMessage, 50); // 50ms delay between characters
                    }
                };
                typeMessage();
                
                // Fix image URLs to be absolute and add error handling
                processedMessage = processedMessage.replace(/src="([^"]+)"/g, (match, src) => {
                    let fullSrc = src;
                    if (src.startsWith('/')) {
                        fullSrc = `${window.location.origin}${src}`;
                    }
                    return `src="${fullSrc}" onerror="this.style.display='none'" onload="this.style.display='block'"`;
                });
                
                messageDiv.innerHTML = processedMessage;
            }
            
            messagesDiv.appendChild(messageDiv);
            
            // ğŸ¬ Trigger entrance animation (slower)
            setTimeout(() => {
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            }, 100);
            
            // ğŸŒŠ Smooth scroll instead of instant jump (with more delay)
            setTimeout(() => {
                messagesDiv.scrollTo({
                    top: messagesDiv.scrollHeight,
                    behavior: 'smooth'
                });
            }, 400);
        }
        
        function removeStavTypingIndicator() {
            const messagesDiv = document.getElementById('stavChatMessages');
            const typingMessage = messagesDiv.querySelector('.stav-message.bot:last-child');
            if (typingMessage && typingMessage.innerHTML.includes('××§×œ×™×“×”')) {
                typingMessage.remove();
            }
        }
        
        function removeStavTypingIndicator() {
            const messagesDiv = document.getElementById('stavChatMessages');
            if (messagesDiv.lastChild && messagesDiv.lastChild.textContent.includes('××§×œ×™×“×”')) {
                messagesDiv.removeChild(messagesDiv.lastChild);
            }
        }
        // Extract product info from description and HTML content
        async function extractProductInfo(description, keyword, pageUrl = null) {
            if (!description) return null;
            
            const desc = description.toLowerCase();
            const keywordLower = keyword.toLowerCase();
            
            // Look for price patterns - more comprehensive
            const pricePatterns = [
                /(\d+)\s*â‚ª/g,
                /(\d+)\s*×©×§×œ/g,
                /(\d+)\s*×©"×—/g,
                /××—×™×¨[:\s]*(\d+)/g,
                /(\d+)\s*-\s*(\d+)\s*â‚ª/g,
                /××—×™×¨[:\s]*(\d+)\s*-\s*(\d+)/g,
                /(\d+)\s*×œ×××”/g,
                /(\d+)\s*×œ××˜×”/g,
                /(\d+)\s*×œ××¢×œ×”/g
            ];
            
            let price = null;
            for (const pattern of pricePatterns) {
                const match = pattern.exec(desc);
                if (match) {
                    if (match[2]) {
                        price = `${match[1]}-${match[2]}â‚ª`;
                    } else {
                        price = `${match[1]}â‚ª`;
                    }
                    break;
                }
            }
            
            // Look for location patterns
            const locationPatterns = [
                /××™×§×•×[:\s]*([^,.\n]{2,50})/g,
                /×›×ª×•×‘×ª[:\s]*([^,.\n]{2,50})/g,
                /× ××¦×[:\s]*([^,.\n]{2,50})/g,
                /×‘[:\s]*([^,.\n]{2,50})/g
            ];
            
            let location = null;
            for (const pattern of locationPatterns) {
                const match = pattern.exec(desc);
                if (match && match[1] && match[1].length > 2) {
                    location = match[1].trim();
                    break;
                }
            }
            
            // Look for product name patterns - more specific
            let productName = null;
            if (keywordLower === '×©×¢×•×Ÿ') {
                const watchPatterns = [
                    /×©×¢×•×Ÿ\s+([^,.\n]{2,30})/g,
                    /([^,.\n]{2,30})\s*×©×¢×•×Ÿ/g,
                    /×©×¢×•×Ÿ\s+([×-×ª\s]{2,30})/g,
                    /([×-×ª\s]{2,30})\s*×©×¢×•×Ÿ\s+([×-×ª\s]{2,30})/g
                ];
                for (const pattern of watchPatterns) {
                    const match = pattern.exec(desc);
                    if (match && match[1] && match[1].length > 2) {
                        productName = match[1].trim();
                        break;
                    }
                }
            } else if (keywordLower === '×ª×›×©×™×˜') {
                const jewelryPatterns = [
                    /×ª×›×©×™×˜\s+([^,.\n]{2,30})/g,
                    /([^,.\n]{2,30})\s*×ª×›×©×™×˜/g,
                    /([^,.\n]{2,30})\s*×–×”×‘/g,
                    /([^,.\n]{2,30})\s*×›×¡×£/g
                ];
                for (const pattern of jewelryPatterns) {
                    const match = pattern.exec(desc);
                    if (match && match[1] && match[1].length > 2) {
                        productName = match[1].trim();
                        break;
                    }
                }
            } else if (keywordLower === '×¦×¢×¦×•×¢') {
                const toyPatterns = [
                    /×¦×¢×¦×•×¢\s+([^,.\n]{2,30})/g,
                    /([^,.\n]{2,30})\s*×¦×¢×¦×•×¢/g,
                    /([^,.\n]{2,30})\s*××©×—×§/g
                ];
                for (const pattern of toyPatterns) {
                    const match = pattern.exec(desc);
                    if (match && match[1] && match[1].length > 2) {
                        productName = match[1].trim();
                        break;
                    }
                }
            }
            
            // If we have a page URL, try to fetch the HTML content to find more prices
            if (pageUrl && (!price || !productName)) {
                try {
                    console.log('ğŸ” Fetching HTML for:', pageUrl);
                    const response = await fetch(pageUrl);
                    const html = await response.text();
                    const htmlLower = html.toLowerCase();
                    
                    console.log('ğŸ“„ HTML length:', html.length);
                    
                    // Look for prices in HTML content
                    if (!price) {
                        console.log('ğŸ’° Looking for prices in HTML...');
                        const htmlPricePatterns = [
                            /<p class="product-price[^"]*"[^>]*>â‚ª(\d+(?:,\d+)?)<\/p>/g,
                            /class="product-price[^"]*"[^>]*>â‚ª(\d+(?:,\d+)?)/g,
                            /â‚ª\s*(\d+(?:,\d+)?)/g,
                            /(\d+(?:,\d+)?)\s*â‚ª/g
                        ];
                        
                        for (const pattern of htmlPricePatterns) {
                            const matches = [...html.matchAll(pattern)];
                            console.log('ğŸ” Pattern matches:', pattern, matches.length);
                            if (matches.length > 0) {
                                // Get the first price found
                                const firstPrice = matches[0][1] || matches[0][0].match(/(\d+(?:,\d+)?)/)?.[1];
                                console.log('ğŸ’° Found price:', firstPrice);
                                if (firstPrice) {
                                    price = `â‚ª${firstPrice}`;
                                    break;
                                }
                            }
                        }
                        
                        // If still no price, try a simpler approach
                        if (!price) {
                            console.log('ğŸ” Trying simple price search...');
                            const simplePriceMatch = html.match(/â‚ª\s*(\d+(?:,\d+)?)/);
                            console.log('ğŸ’° Simple match result:', simplePriceMatch);
                            if (simplePriceMatch) {
                                price = `â‚ª${simplePriceMatch[1]}`;
                            }
                        }
                        
                        console.log('ğŸ’° Final price found:', price);
                    }
                    
                    // Look for product names in HTML content
                    if (!productName && keywordLower === '×©×¢×•×Ÿ') {
                        const watchPatterns = [
                            /×©×¢×•×Ÿ\s+([^<>{}\n]{2,30})/g,
                            /([^<>{}\n]{2,30})\s*×©×¢×•×Ÿ/g,
                            /<h[1-6][^>]*>.*?×©×¢×•×Ÿ\s+([^<]{2,30})/g,
                            /class="[^"]*product-name[^"]*"[^>]*>([^<]+)/g,
                            /<h3[^>]*>([^<]*×©×¢×•×Ÿ[^<]*)<\/h3>/g
                        ];
                        
                        for (const pattern of watchPatterns) {
                            const matches = [...html.matchAll(pattern)];
                            if (matches.length > 0) {
                                productName = matches[0][1].trim();
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.log('Could not fetch HTML content:', error);
                }
            }
            
            if (productName || price || location) {
                return {
                    name: productName || `${keyword} ××™×•×—×“`,
                    price: price || '××—×™×¨ ×œ×¤×™ ×‘×§×©×”',
                    location: location || '××™×§×•× ×œ× ×¦×•×™×Ÿ'
                };
            }
            
            return null;
        }

        // Smart search function for Stav chat
        let lastSearchContext = null; // Remember last search context
        let lastSearchResults = []; // Remember last search results
        
        // Add event listener for Enter key
        document.getElementById('stavChatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendStavMessage();
            }
        });
        
        // Add event listener for button click
        document.getElementById('stav-chat-btn').addEventListener('click', toggleStavChat);
    </script>

    <!-- Account Summary Modal -->
    <div id="account-summary-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900">×¡×™×›×•× ×—×©×‘×•×Ÿ</h3>
                    <button onclick="closeAccountSummaryModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mb-4">
                    <div class="text-sm text-gray-500">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: <span id="modal-last-update"></span></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-medium text-blue-600">×“×¤×™× ×©× ×•×¦×¨×•</p>
                                <p class="text-2xl font-bold text-blue-800" id="modal-account-total-pages">0</p>
                            </div>
                            <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <!-- ×ª×¦×•×’×” ××§×“×™××” ×§×˜× ×” -->
                        <div class="relative bg-white rounded-lg overflow-hidden shadow-sm border border-blue-200 h-24">
                            <div id="modal-total-pages-preview" class="absolute inset-0 bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-1">
                                        <span class="text-white text-sm font-bold" id="modal-total-pages-icon">0</span>
                                    </div>
                                    <div class="text-xs text-blue-700 font-medium">×“×¤×™×</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-medium text-green-600">×“×¤×™× ×¤×¢×™×œ×™×</p>
                                <p class="text-2xl font-bold text-green-800" id="modal-account-active-pages">0</p>
                            </div>
                            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <!-- ×ª×¦×•×’×” ××§×“×™××” ×§×˜× ×” -->
                        <div class="relative bg-white rounded-lg overflow-hidden shadow-sm border border-green-200 h-24">
                            <div id="modal-active-pages-preview" class="absolute inset-0 bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-1">
                                        <span class="text-white text-sm font-bold" id="modal-active-pages-icon">0</span>
                                    </div>
                                    <div class="text-xs text-green-700 font-medium">×¤×¢×™×œ×™×</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-medium text-purple-600">×—×™×•×‘ ×—×•×“×©×™</p>
                                <p class="text-2xl font-bold text-purple-800" id="modal-account-monthly-charge">â‚ª0</p>
                            </div>
                            <svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <!-- ×ª×¦×•×’×” ××§×“×™××” ×§×˜× ×” -->
                        <div class="relative bg-white rounded-lg overflow-hidden shadow-sm border border-purple-200 h-24">
                            <div id="modal-monthly-charge-preview" class="absolute inset-0 bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-1">
                                        <span class="text-white text-xs font-bold">â‚ª</span>
                                    </div>
                                    <div class="text-xs text-purple-700 font-medium" id="modal-monthly-charge-amount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="closeAccountSummaryModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-medium transition-colors">
                        ×¡×’×•×¨
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
