<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ממשק ניהול תורים - AutoPage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            text-align: right;
            background: #f5f7fa;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .appointment-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border-right: 5px solid #8b5cf6;
        }
        .appointment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .appointment-card.pending { border-right-color: #f59e0b; }
        .appointment-card.confirmed { border-right-color: #10b981; }
        .appointment-card.completed { border-right-color: #6b7280; }
        .appointment-card.cancelled { border-right-color: #ef4444; }
        
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-confirmed { background: #d1fae5; color: #065f46; }
        .status-completed { background: #e5e7eb; color: #374151; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
        
        .calendar-day {
            background: white;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e5e7eb;
        }
        .calendar-day:hover {
            border-color: #8b5cf6;
            transform: translateY(-2px);
        }
        .calendar-day.selected {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }
        .calendar-day.today {
            border-color: #3b82f6;
            font-weight: bold;
        }
        
        .time-slot {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }
        .time-slot:hover {
            border-color: #8b5cf6;
        }
        .time-slot.available {
            background: #d1fae5;
            border-color: #10b981;
        }
        .time-slot.booked {
            background: #fee2e2;
            border-color: #ef4444;
            cursor: not-allowed;
        }
        .time-slot.break {
            background: #fef3c7;
            border-color: #f59e0b;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">📅 ניהול תורים</h1>
                        <p class="text-gray-600" id="business-name">טוען...</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="window.location.href='/management-hub.html'" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                            🏠 חזרה למרכז הניהול
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <h3 id="totalAppointments">0</h3>
                    <p>סה"כ תורים</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                    <h3 id="todayAppointments">0</h3>
                    <p>תורים היום</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #047857 100%);">
                    <h3 id="confirmedAppointments">0</h3>
                    <p>תורים מאושרים</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <h3 id="pendingAppointments">0</h3>
                    <p>ממתינים לאישור</p>
                </div>
            </div>

            <!-- Calendar and Schedule -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Calendar -->
                <div class="lg:col-span-1 bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4">📅 לוח שנה</h2>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <button onclick="previousWeek()" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">◀</button>
                            <span id="current-week" class="font-bold"></span>
                            <button onclick="nextWeek()" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">▶</button>
                        </div>
                        <div id="calendar-days" class="grid grid-cols-1 gap-2">
                            <!-- Days will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Working Hours Settings -->
                    <div class="mt-6 border-t pt-4">
                        <h3 class="font-bold mb-3">⚙️ הגדרות שעות עבודה</h3>
                        <div class="space-y-2">
                            <div>
                                <label class="text-sm">שעת התחלה (ברירת מחדל):</label>
                                <input type="time" id="work-start" class="w-full border rounded px-2 py-1" value="09:00">
                            </div>
                            <div>
                                <label class="text-sm">שעת סיום (ברירת מחדל):</label>
                                <input type="time" id="work-end" class="w-full border rounded px-2 py-1" value="17:00">
                            </div>
                            <button onclick="updateWorkingHours()" class="w-full bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                                שמור שעות עבודה
                            </button>
                        </div>
                        
                        <!-- Special Hours for Selected Day -->
                        <div class="mt-4 p-3 bg-blue-50 rounded">
                            <h4 class="font-semibold text-sm mb-2">🕐 שעות מיוחדות ליום זה</h4>
                            <p class="text-xs text-gray-600 mb-2">הגדר שעות עבודה שונות ליום הנבחר (למשל: שישי חצי יום)</p>
                            <div class="space-y-2">
                                <div class="flex gap-2">
                                    <input type="time" id="special-start" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="התחלה">
                                    <input type="time" id="special-end" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="סיום">
                                </div>
                                <button onclick="setSpecialHours()" class="w-full bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                    הגדר שעות מיוחדות
                                </button>
                                <button onclick="clearSpecialHours()" class="w-full bg-gray-400 text-white px-3 py-1 rounded text-sm hover:bg-gray-500">
                                    מחק שעות מיוחדות
                                </button>
                            </div>
                            <div id="special-hours-display" class="mt-2 text-xs text-gray-600"></div>
                        </div>
                    </div>
                    
                    <!-- Add Break -->
                    <div class="mt-6 border-t pt-4">
                        <h3 class="font-bold mb-3">☕ הוסף הפסקה</h3>
                        <div class="space-y-2">
                            <input type="time" id="break-start" class="w-full border rounded px-2 py-1" placeholder="התחלה">
                            <input type="time" id="break-end" class="w-full border rounded px-2 py-1" placeholder="סיום">
                            <button onclick="addBreak()" class="w-full bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                                הוסף הפסקה
                            </button>
                        </div>
                        <div id="breaks-list" class="mt-3 space-y-1">
                            <!-- Breaks will be listed here -->
                        </div>
                    </div>
                </div>

                <!-- Schedule for Selected Day -->
                <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4">🕐 סידור יום <span id="selected-date-display"></span></h2>
                    
                    <!-- Time Slots -->
                    <div id="time-slots" class="mb-6">
                        <!-- Time slots will be populated here -->
                    </div>
                    
                    <!-- Appointments List -->
                    <h3 class="text-xl font-bold mb-4 mt-8">📋 תורים ליום זה</h3>
                    <div id="appointments-list">
                        <p class="text-gray-500">בחר תאריך כדי לראות תורים</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedDate = new Date();
        let currentWeekStart = new Date();
        let appointments = [];
        let breaks = [];
        let workingHours = { start: '09:00', end: '17:00' };
        let specialHours = {}; // { 'YYYY-MM-DD': { start: 'HH:MM', end: 'HH:MM' } }
        let pageInfo = {};

        function getPageInfo() {
            const params = new URLSearchParams(window.location.search);
            return {
                page: params.get('page'),
                userId: params.get('userId')
            };
        }

        async function loadAppointments() {
            pageInfo = getPageInfo();
            if (!pageInfo.page || !pageInfo.userId) {
                console.warn('⚠️ Missing page or userId');
                // Still render empty calendar with today's date
                updateStatistics();
                renderCalendar();
                renderBreaks();
                selectDate(selectedDate);
                return;
            }

            try {
                const response = await fetch(`/api/appointments/${pageInfo.userId}/${pageInfo.page}`);
                const data = await response.json();
                appointments = data.appointments || [];
                
                // Load settings
                breaks = JSON.parse(localStorage.getItem(`breaks_${pageInfo.page}`) || '[]');
                specialHours = JSON.parse(localStorage.getItem(`specialHours_${pageInfo.page}`) || '{}');
                const savedHours = localStorage.getItem(`workingHours_${pageInfo.page}`);
                if (savedHours) {
                    workingHours = JSON.parse(savedHours);
                    document.getElementById('work-start').value = workingHours.start;
                    document.getElementById('work-end').value = workingHours.end;
                }
                
                updateStatistics();
                renderCalendar();
                renderBreaks();
                selectDate(selectedDate);
            } catch (error) {
                console.error('❌ Error loading appointments:', error);
                // Still render empty calendar even on error
                updateStatistics();
                renderCalendar();
                renderBreaks();
                selectDate(selectedDate);
            }
        }

        function updateStatistics() {
            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = appointments.filter(a => a.date === today);
            const confirmed = appointments.filter(a => a.status === 'confirmed');
            const pending = appointments.filter(a => a.status === 'pending');
            
            document.getElementById('totalAppointments').textContent = appointments.length;
            document.getElementById('todayAppointments').textContent = todayAppointments.length;
            document.getElementById('confirmedAppointments').textContent = confirmed.length;
            document.getElementById('pendingAppointments').textContent = pending.length;
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-days');
            container.innerHTML = '';
            
            const today = new Date();
            const weekDays = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + i);
                weekDays.push(date);
            }
            
            const weekStart = weekDays[0].toLocaleDateString('he-IL', { day: 'numeric', month: 'short' });
            const weekEnd = weekDays[6].toLocaleDateString('he-IL', { day: 'numeric', month: 'short' });
            document.getElementById('current-week').textContent = `${weekStart} - ${weekEnd}`;
            
            weekDays.forEach(date => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                const isToday = date.toDateString() === today.toDateString();
                const isSelected = date.toDateString() === selectedDate.toDateString();
                
                if (isToday) dayDiv.classList.add('today');
                if (isSelected) dayDiv.classList.add('selected');
                
                const dayName = date.toLocaleDateString('he-IL', { weekday: 'short' });
                const dayNum = date.getDate();
                const monthName = date.toLocaleDateString('he-IL', { month: 'short' });
                
                const dateStr = date.toISOString().split('T')[0];
                const dayAppointments = appointments.filter(a => a.date === dateStr);
                
                dayDiv.innerHTML = `
                    <div class="text-xs text-gray-500">${dayName}</div>
                    <div class="text-2xl font-bold">${dayNum}</div>
                    <div class="text-xs text-gray-500">${monthName}</div>
                    ${dayAppointments.length > 0 ? `<div class="text-xs mt-1 text-purple-600">${dayAppointments.length} תורים</div>` : ''}
                `;
                
                dayDiv.onclick = () => selectDate(date);
                container.appendChild(dayDiv);
            });
        }

        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderCalendar();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderCalendar();
        }

        function selectDate(date) {
            selectedDate = new Date(date);
            renderCalendar();
            updateSpecialHoursDisplay();
            renderTimeSlots();
            renderAppointments();
            
            const displayDate = date.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('selected-date-display').textContent = displayDate;
        }

        function renderTimeSlots() {
            const container = document.getElementById('time-slots');
            container.innerHTML = '';
            
            // Check if there are special hours for this day
            const dateStr = selectedDate.toISOString().split('T')[0];
            const hours = specialHours[dateStr] || workingHours;
            
            const [startHour, startMin] = hours.start.split(':').map(Number);
            const [endHour, endMin] = hours.end.split(':').map(Number);
            
            const dayAppointments = appointments.filter(a => a.date === dateStr);
            
            for (let hour = startHour; hour < endHour; hour++) {
                for (let min = 0; min < 60; min += 30) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                    
                    // Check if time is in break
                    const isBreak = breaks.some(b => {
                        const breakDate = new Date(b.date);
                        return breakDate.toDateString() === selectedDate.toDateString() &&
                               timeStr >= b.start && timeStr < b.end;
                    });
                    
                    // Check if time is booked
                    const isBooked = dayAppointments.some(a => a.time === timeStr);
                    
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'time-slot';
                    
                    if (isBreak) {
                        slotDiv.classList.add('break');
                        slotDiv.innerHTML = `<span>${timeStr}</span> <span class="text-xs">☕ הפסקה</span>`;
                    } else if (isBooked) {
                        slotDiv.classList.add('booked');
                        const appointment = dayAppointments.find(a => a.time === timeStr);
                        slotDiv.innerHTML = `<span>${timeStr}</span> <span class="text-xs">🔴 תפוס - ${appointment.customerName}</span>`;
                    } else {
                        slotDiv.classList.add('available');
                        slotDiv.innerHTML = `<span>${timeStr}</span> <span class="text-xs">🟢 פנוי</span>`;
                    }
                    
                    container.appendChild(slotDiv);
                }
            }
        }

        function renderAppointments() {
            const container = document.getElementById('appointments-list');
            const dateStr = selectedDate.toISOString().split('T')[0];
            const dayAppointments = appointments.filter(a => a.date === dateStr);
            
            if (dayAppointments.length === 0) {
                container.innerHTML = '<p class="text-gray-500">אין תורים ליום זה</p>';
                return;
            }
            
            dayAppointments.sort((a, b) => a.time.localeCompare(b.time));
            
            container.innerHTML = dayAppointments.map(appointment => `
                <div class="appointment-card ${appointment.status}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-lg font-bold">${appointment.customerName}</h3>
                            <p class="text-gray-600">📞 ${appointment.phone}</p>
                            ${appointment.email ? `<p class="text-gray-600">📧 ${appointment.email}</p>` : ''}
                        </div>
                        <span class="status-badge status-${appointment.status}">
                            ${appointment.status === 'pending' ? 'ממתין' : appointment.status === 'confirmed' ? 'מאושר' : appointment.status === 'completed' ? 'הושלם' : 'בוטל'}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">
                        <p>🕐 ${appointment.time}</p>
                        ${appointment.service ? `<p>💼 ${appointment.service}</p>` : ''}
                        ${appointment.notes ? `<p>📝 ${appointment.notes}</p>` : ''}
                    </div>
                    <div class="flex gap-2">
                        ${appointment.status === 'pending' ? `
                            <button onclick="updateAppointmentStatus('${appointment.id}', 'confirmed')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                ✅ אשר
                            </button>
                        ` : ''}
                        ${appointment.status === 'confirmed' ? `
                            <button onclick="updateAppointmentStatus('${appointment.id}', 'completed')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                ✓ סמן כהושלם
                            </button>
                        ` : ''}
                        <button onclick="updateAppointmentStatus('${appointment.id}', 'cancelled')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                            ❌ בטל
                        </button>
                        <a href="https://wa.me/${appointment.phone.replace(/\D/g, '')}" target="_blank" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                            💬 WhatsApp
                        </a>
                    </div>
                </div>
            `).join('');
        }

        async function updateAppointmentStatus(appointmentId, newStatus) {
            try {
                const response = await fetch(`/api/appointments/${appointmentId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    const appointment = appointments.find(a => a.id === appointmentId);
                    if (appointment) {
                        appointment.status = newStatus;
                        updateStatistics();
                        renderAppointments();
                        alert('✅ סטטוס התור עודכן בהצלחה');
                    }
                } else {
                    alert('❌ שגיאה בעדכון סטטוס');
                }
            } catch (error) {
                console.error('Error updating appointment:', error);
                alert('❌ שגיאה בעדכון סטטוס');
            }
        }

        function updateWorkingHours() {
            workingHours.start = document.getElementById('work-start').value;
            workingHours.end = document.getElementById('work-end').value;
            localStorage.setItem(`workingHours_${pageInfo.page}`, JSON.stringify(workingHours));
            renderTimeSlots();
            alert('✅ שעות העבודה עודכנו');
        }

        function setSpecialHours() {
            const start = document.getElementById('special-start').value;
            const end = document.getElementById('special-end').value;
            
            if (!start || !end) {
                alert('אנא בחר שעות התחלה וסיום');
                return;
            }
            
            const dateStr = selectedDate.toISOString().split('T')[0];
            specialHours[dateStr] = { start, end };
            localStorage.setItem(`specialHours_${pageInfo.page}`, JSON.stringify(specialHours));
            
            updateSpecialHoursDisplay();
            renderTimeSlots();
            alert('✅ שעות מיוחדות נשמרו ליום זה');
        }

        function clearSpecialHours() {
            const dateStr = selectedDate.toISOString().split('T')[0];
            delete specialHours[dateStr];
            localStorage.setItem(`specialHours_${pageInfo.page}`, JSON.stringify(specialHours));
            
            document.getElementById('special-start').value = '';
            document.getElementById('special-end').value = '';
            updateSpecialHoursDisplay();
            renderTimeSlots();
            alert('✅ שעות מיוחדות נמחקו');
        }

        function updateSpecialHoursDisplay() {
            const dateStr = selectedDate.toISOString().split('T')[0];
            const display = document.getElementById('special-hours-display');
            
            if (specialHours[dateStr]) {
                const { start, end } = specialHours[dateStr];
                display.innerHTML = `<strong>שעות מיוחדות ליום זה:</strong> ${start} - ${end}`;
                display.className = 'mt-2 text-xs text-green-700 font-semibold';
                document.getElementById('special-start').value = start;
                document.getElementById('special-end').value = end;
            } else {
                display.innerHTML = 'אין שעות מיוחדות ליום זה (משתמש בשעות ברירת המחדל)';
                display.className = 'mt-2 text-xs text-gray-600';
                document.getElementById('special-start').value = '';
                document.getElementById('special-end').value = '';
            }
        }

        function addBreak() {
            const start = document.getElementById('break-start').value;
            const end = document.getElementById('break-end').value;
            
            if (!start || !end) {
                alert('אנא בחר שעות התחלה וסיום');
                return;
            }
            
            breaks.push({
                id: Date.now().toString(),
                date: selectedDate.toISOString(),
                start,
                end
            });
            
            localStorage.setItem(`breaks_${pageInfo.page}`, JSON.stringify(breaks));
            renderBreaks();
            renderTimeSlots();
            
            document.getElementById('break-start').value = '';
            document.getElementById('break-end').value = '';
        }

        function renderBreaks() {
            const container = document.getElementById('breaks-list');
            const dateStr = selectedDate.toISOString().split('T')[0];
            const dayBreaks = breaks.filter(b => new Date(b.date).toISOString().split('T')[0] === dateStr);
            
            if (dayBreaks.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500">אין הפסקות</p>';
                return;
            }
            
            container.innerHTML = dayBreaks.map(b => `
                <div class="flex justify-between items-center bg-yellow-50 px-2 py-1 rounded text-sm">
                    <span>${b.start} - ${b.end}</span>
                    <button onclick="removeBreak('${b.id}')" class="text-red-500 hover:text-red-700">🗑️</button>
                </div>
            `).join('');
        }

        function removeBreak(breakId) {
            breaks = breaks.filter(b => b.id !== breakId);
            localStorage.setItem(`breaks_${pageInfo.page}`, JSON.stringify(breaks));
            renderBreaks();
            renderTimeSlots();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set current week to start from today
            const today = new Date();
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
            
            // Set selected date to TODAY
            selectedDate = new Date(today);
            
            loadAppointments();
        });
    </script>
</body>
</html>

