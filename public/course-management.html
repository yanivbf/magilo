<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול קורסים - AutoPage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Heebo', sans-serif;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .purchase-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .purchase-item:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #10b981;
            color: white;
        }
        
        .badge-pending {
            background: #f59e0b;
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-white to-blue-50 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <a href="/management-hub.html" class="text-purple-600 hover:text-purple-800 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                    </a>
                    <h1 class="text-2xl font-bold text-gray-800">🎓 ניהול קורסים</h1>
                </div>
                <div>
                    <button id="export-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                        📥 ייצוא לאקסל
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        
        <!-- Page Info -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 id="page-title" class="text-2xl font-bold text-gray-800 mb-2">טוען...</h2>
                    <p class="text-gray-600">דף קורסים דיגיטליים</p>
                </div>
                <div class="text-left">
                    <a id="view-page-btn" href="#" target="_blank" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold inline-flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        צפה בדף
                    </a>
            </div>
        </div>
    </div>

        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
                <div class="text-sm opacity-90 mb-1">סה"כ רכישות</div>
                <div id="total-purchases" class="text-4xl font-bold">0</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="text-sm opacity-90 mb-1">הכנסות כוללות</div>
                <div id="total-revenue" class="text-4xl font-bold">₪0</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="text-sm opacity-90 mb-1">קורסים פעילים</div>
                <div id="active-courses" class="text-4xl font-bold">0</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="text-sm opacity-90 mb-1">ממוצע רכישה</div>
                <div id="avg-purchase" class="text-4xl font-bold">₪0</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex flex-wrap gap-4">
                <input type="text" id="search-input" placeholder="חפש לפי שם, אימייל, קורס..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="all">כל הסטטוסים</option>
                    <option value="completed">הושלם</option>
                    <option value="pending">בהמתנה</option>
                </select>
                <select id="sort-by" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="date-desc">תאריך (חדש לישן)</option>
                    <option value="date-asc">תאריך (ישן לחדש)</option>
                    <option value="amount-desc">סכום (גבוה לנמוך)</option>
                    <option value="amount-asc">סכום (נמוך לגבוה)</option>
                </select>
            </div>
            </div>

        <!-- Purchases List -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">📦 רכישות אחרונות</h3>
            <div id="purchases-container" class="space-y-4">
                <!-- Purchases will be loaded here -->
                <div class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">📚</div>
                    <p class="text-lg">טוען רכישות...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const pageId = urlParams.get('pageId');
        const userId = urlParams.get('userId');

        let allPurchases = [];

        async function loadPurchases() {
            try {
                console.log('📦 Loading purchases for:', { pageId, userId });
                
                // Load purchases from localStorage (cart purchases)
                const cartPurchases = JSON.parse(localStorage.getItem(`course_purchases_${pageId}`) || '[]');
                
                // Also try to fetch from server
                const response = await fetch(`/api/leads/${userId}/${pageId}`);
                const serverPurchases = response.ok ? await response.json() : [];
                
                // Combine both sources
                allPurchases = [...cartPurchases, ...serverPurchases];
                
                console.log('✅ Loaded purchases:', allPurchases);
                
                displayPurchases();
                updateStatistics();
            } catch (error) {
                console.error('❌ Error loading purchases:', error);
                document.getElementById('purchases-container').innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <div class="text-6xl mb-4">⚠️</div>
                        <p class="text-lg">שגיאה בטעינת הרכישות</p>
                    </div>
                `;
            }
        }

        function displayPurchases() {
            const container = document.getElementById('purchases-container');
            
            if (allPurchases.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4">🎓</div>
                        <p class="text-lg font-semibold">עדיין לא נרכשו קורסים</p>
                        <p class="text-sm mt-2">הרכישות יופיעו כאן ברגע שלקוחות ירכשו קורסים מהדף שלך</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allPurchases.map(purchase => `
                <div class="purchase-item">
                    <div class="flex flex-wrap items-start justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="text-3xl">👤</div>
                        <div>
                                    <h4 class="font-bold text-lg text-gray-800">${purchase.name || purchase.customerName || 'לקוח'}</h4>
                                    <p class="text-sm text-gray-600">${purchase.email || purchase.customerEmail || '-'}</p>
                                    ${purchase.phone ? `<p class="text-sm text-gray-600">📱 ${purchase.phone}</p>` : ''}
                        </div>
                    </div>
                            
                            <div class="mt-3 space-y-2">
                                ${purchase.items ? purchase.items.map(item => `
                                    <div class="flex items-center gap-2 text-sm">
                                        <span class="text-2xl">📚</span>
                                        <span class="font-semibold text-purple-700">${item.name}</span>
                                        <span class="text-gray-500">×${item.quantity || 1}</span>
                                        <span class="text-green-600 font-bold">₪${item.price}</span>
                                    </div>
                                `).join('') : `
                                    <div class="flex items-center gap-2 text-sm">
                                        <span class="text-2xl">📚</span>
                                        <span class="font-semibold text-purple-700">${purchase.courseName || 'קורס'}</span>
                                        <span class="text-green-600 font-bold">₪${purchase.amount || purchase.price || 0}</span>
                            </div>
                                `}
                    </div>
                </div>
                        
                        <div class="text-left">
                            <div class="text-2xl font-bold text-green-600 mb-2">
                                ₪${purchase.totalAmount || purchase.amount || purchase.price || 0}
                        </div>
                            <div class="text-xs text-gray-500 mb-2">
                                ${new Date(purchase.date || purchase.timestamp || Date.now()).toLocaleString('he-IL')}
                        </div>
                            <span class="badge ${purchase.status === 'completed' ? 'badge-success' : 'badge-pending'}">
                                ${purchase.status === 'completed' ? '✅ הושלם' : '⏳ בהמתנה'}
                            </span>
                    </div>
                </div>
                    
                    ${purchase.message ? `
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <p class="text-sm text-gray-600"><strong>הודעה:</strong> ${purchase.message}</p>
                            </div>
                        ` : ''}
                </div>
            `).join('');
        }

        function updateStatistics() {
            const totalPurchases = allPurchases.length;
            const totalRevenue = allPurchases.reduce((sum, p) => sum + (parseFloat(p.totalAmount || p.amount || p.price || 0)), 0);
            const uniqueCourses = new Set(allPurchases.flatMap(p => p.items ? p.items.map(i => i.name) : [p.courseName])).size;
            const avgPurchase = totalPurchases > 0 ? (totalRevenue / totalPurchases).toFixed(0) : 0;

            document.getElementById('total-purchases').textContent = totalPurchases;
            document.getElementById('total-revenue').textContent = '₪' + totalRevenue.toFixed(0);
            document.getElementById('active-courses').textContent = uniqueCourses;
            document.getElementById('avg-purchase').textContent = '₪' + avgPurchase;
        }

        // Export to Excel
        document.getElementById('export-btn').addEventListener('click', () => {
            const csv = [
                ['שם', 'אימייל', 'טלפון', 'קורס', 'סכום', 'תאריך', 'סטטוס'].join(','),
                ...allPurchases.map(p => [
                    p.name || p.customerName || '',
                    p.email || p.customerEmail || '',
                    p.phone || '',
                    p.items ? p.items.map(i => i.name).join('; ') : (p.courseName || ''),
                    p.totalAmount || p.amount || p.price || 0,
                    new Date(p.date || p.timestamp || Date.now()).toLocaleDateString('he-IL'),
                    p.status || 'completed'
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `course-purchases-${Date.now()}.csv`;
            link.click();
        });

        // Search and filter
        document.getElementById('search-input').addEventListener('input', displayPurchases);
        document.getElementById('status-filter').addEventListener('change', displayPurchases);
        document.getElementById('sort-by').addEventListener('change', displayPurchases);

        // Load page info
        fetch(`/api/pages/${userId}`)
            .then(res => res.json())
            .then(pages => {
                const page = pages.find(p => p.id === pageId);
                if (page) {
                    document.getElementById('page-title').textContent = page.title;
                    document.getElementById('view-page-btn').href = `/pages/${userId}/${pageId}`;
                }
            });

        // Initialize
        loadPurchases();
    </script>
</body>
</html>
