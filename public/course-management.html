<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ממשק ניהול קורסים - AutoPage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            text-align: right;
            background: #f5f7fa;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .purchase-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border-right: 5px solid #8b5cf6;
        }
        .purchase-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .lead-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border-right: 5px solid #3b82f6;
        }
        .lead-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
            margin-left: 10px;
        }
        .tab-btn:hover {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }
        .tab-btn.active {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-2">📚 ממשק ניהול קורסים דיגיטליים</h1>
                    <p class="text-purple-100" id="courseName">טוען...</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="window.location.href='/management-hub.html'" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-semibold hover:bg-purple-50 transition">
                        ← חזרה למרכז הניהול
                    </button>
                    <button onclick="exportData()" class="bg-purple-700 text-white px-6 py-2 rounded-lg font-semibold hover:bg-purple-800 transition">
                        📥 ייצא נתונים
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto p-6">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h3 id="totalRevenue">₪0</h3>
                <p>💰 סך הכנסות</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <h3 id="totalPurchases">0</h3>
                <p>🛒 רכישות קורסים</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <h3 id="totalLeads">0</h3>
                <p>📝 נרשמים / לידים</p>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h3 id="totalStudents">0</h3>
                <p>👥 סה"כ סטודנטים</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex flex-wrap gap-3 mb-6">
                <button class="tab-btn active" onclick="switchTab('purchases')">
                    🛒 רכישות קורסים
                </button>
                <button class="tab-btn" onclick="switchTab('leads')">
                    📝 נרשמים / לידים
                </button>
                <button class="tab-btn" onclick="switchTab('students')">
                    👥 כל הסטודנטים
                </button>
                <button class="tab-btn" onclick="switchTab('analytics')">
                    📊 ניתוח נתונים
                </button>
            </div>

            <!-- Purchases Tab -->
            <div id="purchases-tab" class="tab-content active">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">🛒 רכישות קורסים</h2>
                <div id="purchasesList"></div>
            </div>

            <!-- Leads Tab -->
            <div id="leads-tab" class="tab-content">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">📝 נרשמים / לידים</h2>
                <div id="leadsList"></div>
            </div>

            <!-- Students Tab -->
            <div id="students-tab" class="tab-content">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">👥 כל הסטודנטים</h2>
                <div id="studentsList"></div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">📊 ניתוח נתונים</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-6 rounded-xl border-2 border-purple-200">
                        <h3 class="text-xl font-bold mb-4 text-purple-800">💰 פילוח הכנסות</h3>
                        <div id="revenueBreakdown"></div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-xl border-2 border-blue-200">
                        <h3 class="text-xl font-bold mb-4 text-blue-800">📈 שיעור המרה</h3>
                        <div id="conversionRate"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let pageId = '';
        let userId = '';
        let purchases = [];
        let leads = [];

        // Get URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            pageId = params.get('pageId');
            userId = params.get('userId');
            
            if (!pageId || !userId) {
                alert('חסרים פרמטרים בכתובת URL');
                window.location.href = '/management-hub.html';
                return false;
            }
            return true;
        }

        // Load data
        async function loadData() {
            if (!getUrlParams()) return;

            try {
                // Load purchases
                const purchasesRes = await fetch(`/api/purchases?pageId=${pageId}&userId=${userId}`);
                if (purchasesRes.ok) {
                    purchases = await purchasesRes.json();
                }

                // Load leads
                const leadsRes = await fetch(`/api/leads?pageId=${pageId}&userId=${userId}`);
                if (leadsRes.ok) {
                    leads = await leadsRes.json();
                }

                // Update UI
                updateStatistics();
                renderPurchases();
                renderLeads();
                renderStudents();
                renderAnalytics();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Update statistics
        function updateStatistics() {
            const totalRevenue = purchases.reduce((sum, p) => sum + (p.totalPrice || 0), 0);
            const uniqueStudents = new Set([
                ...purchases.map(p => p.email),
                ...leads.map(l => l.email)
            ]).size;

            document.getElementById('totalRevenue').textContent = `₪${totalRevenue.toLocaleString()}`;
            document.getElementById('totalPurchases').textContent = purchases.length;
            document.getElementById('totalLeads').textContent = leads.length;
            document.getElementById('totalStudents').textContent = uniqueStudents;
        }

        // Render purchases
        function renderPurchases() {
            const container = document.getElementById('purchasesList');
            if (purchases.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">אין רכישות עדיין</p>';
                return;
            }

            container.innerHTML = purchases.map(purchase => `
                <div class="purchase-card">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${purchase.name}</h3>
                            <p class="text-gray-600">${purchase.email}</p>
                            ${purchase.phone ? `<p class="text-gray-600">📱 ${purchase.phone}</p>` : ''}
                        </div>
                        <div class="text-left">
                            <p class="text-2xl font-bold text-purple-600">₪${purchase.totalPrice}</p>
                            <p class="text-sm text-gray-500">${new Date(purchase.timestamp).toLocaleDateString('he-IL')}</p>
                        </div>
                    </div>
                    <div class="border-t pt-3">
                        <p class="font-semibold text-gray-700 mb-2">📚 קורסים שנרכשו:</p>
                        ${purchase.items.map(item => `
                            <div class="flex justify-between items-center bg-purple-50 p-2 rounded mb-2">
                                <span class="text-gray-800">${item.name}</span>
                                <span class="font-semibold text-purple-600">₪${item.price}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Render leads
        function renderLeads() {
            const container = document.getElementById('leadsList');
            if (leads.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">אין נרשמים עדיין</p>';
                return;
            }

            container.innerHTML = leads.map(lead => `
                <div class="lead-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${lead.name}</h3>
                            <p class="text-gray-600">📧 ${lead.email}</p>
                            ${lead.phone ? `<p class="text-gray-600">📱 ${lead.phone}</p>` : ''}
                            ${lead.message ? `<p class="text-gray-700 mt-2 bg-blue-50 p-3 rounded">${lead.message}</p>` : ''}
                        </div>
                        <div class="text-left">
                            <p class="text-sm text-gray-500">${new Date(lead.timestamp).toLocaleDateString('he-IL')}</p>
                            <p class="text-sm text-gray-500">${new Date(lead.timestamp).toLocaleTimeString('he-IL')}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render students (combined)
        function renderStudents() {
            const container = document.getElementById('studentsList');
            
            // Combine and deduplicate by email
            const studentsMap = new Map();
            
            purchases.forEach(p => {
                if (!studentsMap.has(p.email)) {
                    studentsMap.set(p.email, {
                        name: p.name,
                        email: p.email,
                        phone: p.phone,
                        hasPurchased: true,
                        hasRegistered: false,
                        totalSpent: 0,
                        courses: []
                    });
                }
                const student = studentsMap.get(p.email);
                student.totalSpent += p.totalPrice;
                student.courses.push(...p.items.map(i => i.name));
            });

            leads.forEach(l => {
                if (!studentsMap.has(l.email)) {
                    studentsMap.set(l.email, {
                        name: l.name,
                        email: l.email,
                        phone: l.phone,
                        hasPurchased: false,
                        hasRegistered: true,
                        totalSpent: 0,
                        courses: []
                    });
                } else {
                    studentsMap.get(l.email).hasRegistered = true;
                }
            });

            const students = Array.from(studentsMap.values());

            if (students.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">אין סטודנטים עדיין</p>';
                return;
            }

            container.innerHTML = students.map(student => `
                <div class="purchase-card">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800">${student.name}</h3>
                            <p class="text-gray-600">📧 ${student.email}</p>
                            ${student.phone ? `<p class="text-gray-600">📱 ${student.phone}</p>` : ''}
                            <div class="flex gap-2 mt-2">
                                ${student.hasPurchased ? '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">✅ רכש קורסים</span>' : ''}
                                ${student.hasRegistered ? '<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">📝 נרשם</span>' : ''}
                            </div>
                            ${student.courses.length > 0 ? `
                                <div class="mt-3">
                                    <p class="font-semibold text-gray-700 mb-1">📚 קורסים:</p>
                                    ${student.courses.map(c => `<span class="inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm mr-1 mb-1">${c}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        ${student.hasPurchased ? `
                            <div class="text-left">
                                <p class="text-2xl font-bold text-green-600">₪${student.totalSpent}</p>
                                <p class="text-sm text-gray-500">סה"כ הוצאה</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Render analytics
        function renderAnalytics() {
            const totalRevenue = purchases.reduce((sum, p) => sum + (p.totalPrice || 0), 0);
            const avgPurchase = purchases.length > 0 ? (totalRevenue / purchases.length).toFixed(0) : 0;
            const conversionRate = leads.length > 0 ? ((purchases.length / (purchases.length + leads.length)) * 100).toFixed(1) : 0;

            document.getElementById('revenueBreakdown').innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">סך הכנסות:</span>
                        <span class="text-2xl font-bold text-purple-600">₪${totalRevenue.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">ממוצע לרכישה:</span>
                        <span class="text-xl font-semibold text-purple-600">₪${avgPurchase}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-700">מספר רכישות:</span>
                        <span class="text-xl font-semibold text-purple-600">${purchases.length}</span>
                    </div>
                </div>
            `;

            document.getElementById('conversionRate').innerHTML = `
                <div class="space-y-3">
                    <div class="text-center">
                        <div class="text-5xl font-bold text-blue-600 mb-2">${conversionRate}%</div>
                        <p class="text-gray-600">שיעור המרה מנרשמים לרוכשים</p>
                    </div>
                    <div class="border-t pt-3 space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-700">נרשמים:</span>
                            <span class="font-semibold text-blue-600">${leads.length}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-700">רוכשים:</span>
                            <span class="font-semibold text-green-600">${purchases.length}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Export data
        function exportData() {
            const data = {
                purchases,
                leads,
                statistics: {
                    totalRevenue: purchases.reduce((sum, p) => sum + (p.totalPrice || 0), 0),
                    totalPurchases: purchases.length,
                    totalLeads: leads.length
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `course-data-${pageId}-${Date.now()}.json`;
            a.click();
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>




