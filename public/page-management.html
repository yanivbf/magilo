<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×“×£ - AutoPage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            text-align: right;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .purchase-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-right: 4px solid #007bff;
        }
        .purchase-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .purchase-item p {
            margin: 5px 0;
            color: #666;
        }
        .status-completed {
            color: #28a745;
            font-weight: bold;
        }
        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }
        .status-cancelled {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">× ×™×”×•×œ ×“×£</h1>
                        <p class="text-gray-600" id="page-info">×˜×•×¢×Ÿ ××™×“×¢...</p>
                    </div>
                    <div class="flex space-x-4 gap-2">
                        <button onclick="refreshData()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                            ğŸ”„ ×¨×¢× ×Ÿ × ×ª×•× ×™×
                        </button>
                        <button onclick="exportData()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                            ğŸ“Š ×™×™×¦× × ×ª×•× ×™×
                        </button>
                        <button onclick="window.close()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                            âœ• ×¡×’×•×¨
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Date Filter -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex items-center justify-between gap-4 flex-wrap">
                    <div class="flex items-center gap-2">
                        <label class="font-medium text-gray-700">×¡×™× ×•×Ÿ ×ª××¨×™×›×™×:</label>
                        <button onclick="filterByPeriod('today')" id="filter-today" class="filter-btn bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600">
                            ×”×™×•×
                        </button>
                        <button onclick="filterByPeriod('week')" id="filter-week" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
                            ×”×©×‘×•×¢
                        </button>
                        <button onclick="filterByPeriod('month')" id="filter-month" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
                            ×”×—×•×“×©
                        </button>
                        <button onclick="filterByPeriod('year')" id="filter-year" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
                            ×”×©× ×”
                        </button>
                        <button onclick="filterByPeriod('all')" id="filter-all" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-gray-300">
                            ×”×›×œ
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="exportToPDF()" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 flex items-center gap-2">
                            ğŸ“„ ×™×™×¦× PDF
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                    <h3 id="totalSales">â‚ª0</h3>
                    <p>×¡×”"×› ××›×™×¨×•×ª</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalOrders">0</h3>
                    <p>×¡×”"×› ×”×–×× ×•×ª</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalCustomers">0</h3>
                    <p>×¡×”"×› ×œ×§×•×—×•×ª</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgOrderValue">â‚ª0</h3>
                    <p>×¢×¨×š ×”×–×× ×” ×××•×¦×¢</p>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Daily Sales Chart -->
                <div class="chart-container">
                    <h3 class="text-xl font-bold mb-4">××›×™×¨×•×ª ×™×•××™×•×ª</h3>
                    <canvas id="dailySalesChart" width="400" height="200"></canvas>
                </div>

                <!-- Monthly Sales Chart -->
                <div class="chart-container">
                    <h3 class="text-xl font-bold mb-4">××›×™×¨×•×ª ×—×•×“×©×™×•×ª</h3>
                    <canvas id="monthlySalesChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Tabs for different views -->
            <div class="mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex gap-4">
                        <button onclick="switchTab('orders')" id="tab-orders" class="tab-button border-b-2 border-blue-500 text-blue-600 py-3 px-4 font-medium">
                            ğŸ“¦ ×”×–×× ×•×ª
                        </button>
                        <button onclick="switchTab('customers')" id="tab-customers" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-4 font-medium">
                            ğŸ‘¥ ××•×¢×“×•×Ÿ ×œ×§×•×—×•×ª
                        </button>
                        <button onclick="switchTab('products')" id="tab-products" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-4 font-medium">
                            ğŸ† ××•×¦×¨×™×
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="content-orders" class="tab-content">
                <div class="chart-container">
                    <h3 class="text-xl font-bold mb-4">×”×–×× ×•×ª ××—×¨×•× ×•×ª</h3>
                    <div id="recentPurchases">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-4">ğŸ“¦</div>
                            <p>×˜×•×¢×Ÿ ×”×–×× ×•×ª...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="content-customers" class="tab-content hidden">
                <div class="chart-container">
                    <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                        <span>ğŸ‘¥ ××•×¢×“×•×Ÿ ×œ×§×•×—×•×ª</span>
                        <button onclick="exportCustomers()" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600">
                            ğŸ“¥ ×™×™×¦× ×œ×œ×§×•×—×•×ª
                        </button>
                    </h3>
                    <div id="customersList">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-4">ğŸ‘¥</div>
                            <p>×˜×•×¢×Ÿ ×œ×§×•×—×•×ª...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="content-products" class="tab-content hidden">
                <div class="chart-container">
                    <h3 class="text-xl font-bold mb-4">××•×¦×¨×™× ×¤×•×¤×•×œ×¨×™×™×</h3>
                    <div id="topProducts">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-4">ğŸ†</div>
                            <p>×˜×•×¢×Ÿ ××•×¦×¨×™×...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let pageData = {};
        let analyticsData = {};
        let allAnalyticsData = {}; // Store all data before filtering
        let currentPage = '';
        let currentUserId = '';
        let currentFilter = 'today';

        // Get page info from URL
        function getPageInfoFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            currentPage = urlParams.get('page');
            currentUserId = urlParams.get('userId');
            return { page: currentPage, userId: currentUserId };
        }

        // Load page data
        async function loadPageData() {
            const { page, userId } = getPageInfoFromUrl();
            if (!page || !userId) {
                alert('××™×“×¢ ×—×¡×¨ - ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”×“×£');
                return;
            }

            // Update page info
            document.getElementById('page-info').textContent = `×“×£: ${page} | ××©×ª××©: ${userId}`;

            try {
                // Try to load analytics (for stores)
                const analyticsResponse = await fetch(`/api/analytics/page/${page}?userId=${userId}`);
                const analytics = await analyticsResponse.json();
                
                // Try to load leads (for landing pages)
                const leadsResponse = await fetch(`/api/leads/page/${page}?userId=${userId}`);
                const leadsData = await leadsResponse.json();
                
                // Determine page type based on data
                const isStore = (analytics.totalOrders || 0) > 0 || (analytics.recentPurchases || []).length > 0;
                const isLeadPage = (leadsData.totalLeads || 0) > 0 || (leadsData.leads || []).length > 0;
                
                console.log('Page type detection:', { isStore, isLeadPage });
                
                if (isStore || (!isStore && !isLeadPage)) {
                    // Store or default to store view
                    allAnalyticsData = analytics;
                    document.getElementById('tab-orders').textContent = 'ğŸ“¦ ×”×–×× ×•×ª';
                    document.getElementById('tab-customers').textContent = 'ğŸ‘¥ ××•×¢×“×•×Ÿ ×œ×§×•×—×•×ª';
                } else {
                    // Lead page
                    allAnalyticsData = {
                        ...analytics,
                        recentPurchases: (leadsData.leads || []).map(lead => ({
                            id: lead.id,
                            customerName: lead.name,
                            customerPhone: lead.phone,
                            customerAddress: lead.email,
                            total: 0,
                            createdAt: lead.createdAt,
                            status: lead.status,
                            products: [{ name: lead.message || '×¤× ×™×™×”', quantity: 1 }]
                        })),
                        totalOrders: leadsData.totalLeads || 0,
                        totalSales: 0,
                        totalCustomers: leadsData.totalLeads || 0,
                        averageOrderValue: 0
                    };
                    document.getElementById('tab-orders').textContent = 'ğŸ“‹ ×¤× ×™×•×ª';
                    document.getElementById('tab-customers').textContent = 'ğŸ‘¥ ×œ×™×“×™×';
                }
                
                // Apply current filter
                filterByPeriod(currentFilter);
            } catch (error) {
                console.error('Error loading page data:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×“×£');
            }
        }
        
        // Filter data by period
        function filterByPeriod(period) {
            currentFilter = period;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById('filter-' + period).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('filter-' + period).classList.add('bg-blue-500', 'text-white');
            
            // Get date range
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case 'all':
                    startDate = new Date(0); // From beginning
                    break;
            }
            
            // Filter purchases
            const filteredPurchases = (allAnalyticsData.recentPurchases || []).filter(p => {
                return new Date(p.createdAt) >= startDate;
            });
            
            // Recalculate analytics with filtered data
            analyticsData = {
                ...allAnalyticsData,
                recentPurchases: filteredPurchases,
                totalSales: filteredPurchases.reduce((sum, p) => sum + p.total, 0),
                totalOrders: filteredPurchases.length,
                totalCustomers: new Set(filteredPurchases.map(p => p.customerPhone || p.customerName)).size,
                averageOrderValue: filteredPurchases.length > 0 ? 
                    filteredPurchases.reduce((sum, p) => sum + p.total, 0) / filteredPurchases.length : 0
            };
            
            updateUI();
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Hide all content tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected content
            document.getElementById('content-' + tabName).classList.remove('hidden');
            
            // Add active state to selected button
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.add('border-blue-500', 'text-blue-600');
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
        }

        // Update UI with data
        function updateUI() {
            // Update stats
            document.getElementById('totalSales').textContent = 'â‚ª' + (analyticsData.totalSales || 0).toLocaleString();
            document.getElementById('totalOrders').textContent = analyticsData.totalOrders || 0;
            document.getElementById('totalCustomers').textContent = analyticsData.totalCustomers || 0;
            document.getElementById('avgOrderValue').textContent = 'â‚ª' + (analyticsData.averageOrderValue || 0).toFixed(0);

            // Update recent purchases
            updateRecentPurchases();
            
            // Update customers list
            updateCustomersList();
            
            // Update top products
            updateTopProducts();
            
            // Update charts
            updateCharts();
        }

        // Update recent purchases
        function updateRecentPurchases() {
            const container = document.getElementById('recentPurchases');
            const purchases = analyticsData.recentPurchases || [];
            
            if (purchases.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">ğŸ“¦</div>
                        <p>××™×Ÿ ×”×–×× ×•×ª ×¢×“×™×™×Ÿ</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = purchases.map(purchase => `
                <div class="purchase-item">
                    <div class="flex justify-between items-start mb-2">
                        <h4>×”×–×× ×” #${purchase.id.substring(0, 8)}</h4>
                        <span class="status-${purchase.status} px-2 py-1 rounded text-xs">${getStatusText(purchase.status)}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <p><strong>ğŸ‘¤ ×œ×§×•×—:</strong> ${purchase.customerName || '×œ× ×–××™×Ÿ'}</p>
                        <p><strong>ğŸ“ ×˜×œ×¤×•×Ÿ:</strong> ${purchase.customerPhone || '×œ× ×–××™×Ÿ'}</p>
                        <p class="col-span-2"><strong>ğŸ“ ×›×ª×•×‘×ª:</strong> ${purchase.customerAddress || '××™×¡×•×£ ×¢×¦××™'}</p>
                        <p><strong>ğŸ’° ×¡×›×•×:</strong> â‚ª${purchase.total}</p>
                        <p><strong>ğŸ“… ×ª××¨×™×š:</strong> ${new Date(purchase.createdAt).toLocaleDateString('he-IL')}</p>
                        <p class="col-span-2"><strong>ğŸ›ï¸ ××•×¦×¨×™×:</strong> ${purchase.products.map(p => `${p.name} (x${p.quantity})`).join(', ')}</p>
                        ${purchase.shipping ? '<p class="col-span-2"><strong>ğŸšš ××©×œ×•×—:</strong> ×›×Ÿ (+35â‚ª)</p>' : '<p class="col-span-2"><strong>ğŸ“¦ ××™×¡×•×£:</strong> ×¢×¦××™</p>'}
                    </div>
                </div>
            `).join('');
        }

        // Update customers list
        function updateCustomersList() {
            const container = document.getElementById('customersList');
            const purchases = analyticsData.recentPurchases || [];
            
            // Group purchases by customer
            const customersMap = {};
            purchases.forEach(purchase => {
                const key = purchase.customerPhone || purchase.customerName || 'unknown';
                if (!customersMap[key]) {
                    customersMap[key] = {
                        name: purchase.customerName || '×œ× ×–××™×Ÿ',
                        phone: purchase.customerPhone || '×œ× ×–××™×Ÿ',
                        address: purchase.customerAddress || '×œ× ×–××™×Ÿ',
                        totalSpent: 0,
                        orderCount: 0,
                        lastOrder: purchase.createdAt,
                        purchases: []
                    };
                }
                customersMap[key].totalSpent += purchase.total;
                customersMap[key].orderCount++;
                customersMap[key].purchases.push(purchase);
                
                // Keep latest order date
                if (new Date(purchase.createdAt) > new Date(customersMap[key].lastOrder)) {
                    customersMap[key].lastOrder = purchase.createdAt;
                }
            });
            
            const customers = Object.values(customersMap);
            
            if (customers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">ğŸ‘¥</div>
                        <p>××™×Ÿ ×œ×§×•×—×•×ª ×¢×“×™×™×Ÿ</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">×©×</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">×˜×œ×¤×•×Ÿ</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">×›×ª×•×‘×ª</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">×”×–×× ×•×ª</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">×¡×”"×› ×”×•×¦×™×</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">×”×–×× ×” ××—×¨×•× ×”</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${customers.map(customer => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${customer.name}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">
                                        <a href="tel:${customer.phone}" class="text-blue-600 hover:underline">${customer.phone}</a>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${customer.address}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${customer.orderCount}</td>
                                    <td class="px-4 py-3 text-sm font-semibold text-green-600">â‚ª${customer.totalSpent.toLocaleString()}</td>
                                    <td class="px-4 py-3 text-sm text-gray-700">${new Date(customer.lastOrder).toLocaleDateString('he-IL')}</td>
                                    <td class="px-4 py-3 text-sm">
                                        <button onclick="callCustomer('${customer.phone}')" class="text-blue-600 hover:text-blue-800 mr-2" title="×”×ª×§×©×¨">ğŸ“</button>
                                        <button onclick="whatsappCustomer('${customer.phone}')" class="text-green-600 hover:text-green-800" title="WhatsApp">ğŸ’¬</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Update top products
        function updateTopProducts() {
            const container = document.getElementById('topProducts');
            const products = analyticsData.topProducts || [];
            
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">ğŸ†</div>
                        <p>××™×Ÿ ××•×¦×¨×™× ×¢×“×™×™×Ÿ</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = products.slice(0, 10).map((product, index) => `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg mb-2">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">${getRankEmoji(index + 1)}</span>
                        <div>
                            <h4 class="font-bold">${product.name}</h4>
                            <p class="text-sm text-gray-600">${product.sales} ×™×—×™×“×•×ª × ××›×¨×•</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">â‚ª${product.revenue.toLocaleString()}</p>
                        <p class="text-sm text-gray-600">×”×›× ×¡×•×ª</p>
                    </div>
                </div>
            `).join('');
        }

        // Update charts
        function updateCharts() {
            updateDailySalesChart();
            updateMonthlySalesChart();
        }

        // Update daily sales chart
        function updateDailySalesChart() {
            const canvas = document.getElementById('dailySalesChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const dailySales = analyticsData.dailySales || {};
            const dates = Object.keys(dailySales).sort();
            const values = dates.map(date => dailySales[date]);
            
            if (dates.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('××™×Ÿ × ×ª×•× ×™×', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Draw simple bar chart
            const maxValue = Math.max(...values);
            const barWidth = canvas.width / dates.length;
            
            ctx.fillStyle = '#007bff';
            dates.forEach((date, index) => {
                const barHeight = (values[index] / maxValue) * (canvas.height - 40);
                ctx.fillRect(index * barWidth, canvas.height - barHeight - 20, barWidth - 2, barHeight);
            });
            
            // Draw labels
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            dates.forEach((date, index) => {
                ctx.fillText(date.substring(5), index * barWidth + barWidth / 2, canvas.height - 5);
            });
        }

        // Update monthly sales chart
        function updateMonthlySalesChart() {
            const canvas = document.getElementById('monthlySalesChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const monthlySales = analyticsData.monthlySales || {};
            const months = Object.keys(monthlySales).sort();
            const values = months.map(month => monthlySales[month]);
            
            if (months.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('××™×Ÿ × ×ª×•× ×™×', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Draw simple bar chart
            const maxValue = Math.max(...values);
            const barWidth = canvas.width / months.length;
            
            ctx.fillStyle = '#28a745';
            months.forEach((month, index) => {
                const barHeight = (values[index] / maxValue) * (canvas.height - 40);
                ctx.fillRect(index * barWidth, canvas.height - barHeight - 20, barWidth - 2, barHeight);
            });
            
            // Draw labels
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            months.forEach((month, index) => {
                ctx.fillText(month, index * barWidth + barWidth / 2, canvas.height - 5);
            });
        }

        // Helper functions
        function getStatusText(status) {
            const statusMap = {
                'completed': '×”×•×©×œ×',
                'pending': '×××ª×™×Ÿ',
                'cancelled': '×‘×•×˜×œ'
            };
            return statusMap[status] || status;
        }

        function getRankEmoji(rank) {
            const emojis = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ'];
            return emojis[rank - 1] || 'ğŸ†';
        }

        function showError(message) {
            alert('×©×’×™××”: ' + message);
        }

        function refreshData() {
            loadPageData();
        }

        function exportData() {
            const dataStr = JSON.stringify(analyticsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `page-analytics-${currentPage}.json`;
            link.click();
        }
        
        function exportCustomers() {
            const purchases = analyticsData.recentPurchases || [];
            const customersMap = {};
            
            purchases.forEach(purchase => {
                const key = purchase.customerPhone || purchase.customerName || 'unknown';
                if (!customersMap[key]) {
                    customersMap[key] = {
                        name: purchase.customerName || '×œ× ×–××™×Ÿ',
                        phone: purchase.customerPhone || '×œ× ×–××™×Ÿ',
                        address: purchase.customerAddress || '×œ× ×–××™×Ÿ',
                        totalSpent: 0,
                        orderCount: 0
                    };
                }
                customersMap[key].totalSpent += purchase.total;
                customersMap[key].orderCount++;
            });
            
            const customers = Object.values(customersMap);
            const csvContent = '×©×,×˜×œ×¤×•×Ÿ,×›×ª×•×‘×ª,×”×–×× ×•×ª,×¡×”"×›\n' + 
                customers.map(c => `"${c.name}","${c.phone}","${c.address}",${c.orderCount},${c.totalSpent}`).join('\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `customers-${currentPage}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function callCustomer(phone) {
            window.location.href = `tel:${phone}`;
        }
        
        function whatsappCustomer(phone) {
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            const message = encodeURIComponent('×©×œ×•×! ×ª×•×“×” ×©×§× ×™×ª ××¦×œ× ×• ğŸ˜Š');
            window.open(`https://wa.me/972${cleanPhone.substring(1)}?text=${message}`, '_blank');
        }
        
        // Export to PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add Hebrew font support (basic)
            doc.setLanguage('he');
            
            // Title
            doc.setFontSize(20);
            doc.text(`Store Report - ${currentPage}`, 105, 20, { align: 'center' });
            
            // Period
            doc.setFontSize(12);
            const periodText = {
                'today': 'Today',
                'week': 'Last 7 Days',
                'month': 'This Month',
                'year': 'This Year',
                'all': 'All Time'
            }[currentFilter];
            doc.text(`Period: ${periodText}`, 105, 30, { align: 'center' });
            doc.text(`Generated: ${new Date().toLocaleString('he-IL')}`, 105, 37, { align: 'center' });
            
            // Stats
            let y = 50;
            doc.setFontSize(14);
            doc.text('Summary Statistics:', 20, y);
            y += 10;
            doc.setFontSize(11);
            doc.text(`Total Sales: ILS ${analyticsData.totalSales || 0}`, 20, y);
            y += 7;
            doc.text(`Total Orders: ${analyticsData.totalOrders || 0}`, 20, y);
            y += 7;
            doc.text(`Total Customers: ${analyticsData.totalCustomers || 0}`, 20, y);
            y += 7;
            doc.text(`Average Order Value: ILS ${(analyticsData.averageOrderValue || 0).toFixed(2)}`, 20, y);
            y += 15;
            
            // Orders
            doc.setFontSize(14);
            doc.text('Recent Orders:', 20, y);
            y += 10;
            
            const purchases = analyticsData.recentPurchases || [];
            doc.setFontSize(9);
            
            purchases.slice(0, 20).forEach((purchase, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.text(`Order #${purchase.id.substring(0, 8)}`, 20, y);
                y += 5;
                doc.text(`Customer: ${purchase.customerName || 'N/A'}`, 25, y);
                y += 5;
                doc.text(`Phone: ${purchase.customerPhone || 'N/A'}`, 25, y);
                y += 5;
                doc.text(`Address: ${purchase.customerAddress || 'Pickup'}`, 25, y);
                y += 5;
                doc.text(`Total: ILS ${purchase.total}`, 25, y);
                y += 5;
                doc.text(`Date: ${new Date(purchase.createdAt).toLocaleDateString('he-IL')}`, 25, y);
                y += 5;
                doc.text(`Products: ${purchase.products.map(p => `${p.name} (x${p.quantity})`).join(', ')}`, 25, y);
                y += 10;
            });
            
            // Save
            const periodName = periodText.replace(/ /g, '_');
            doc.save(`store-report-${currentPage}-${periodName}-${Date.now()}.pdf`);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPageData();
            
            // Refresh data every 30 seconds
            setInterval(loadPageData, 30000);
        });
    </script>
</body>
</html>

