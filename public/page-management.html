<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×××©×§ × ×™×”×•×œ ×“×¤×™× - AutoPage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            text-align: right;
            background: #f5f7fa;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .order-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border-right: 5px solid #8b5cf6;
        }
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .order-card.new { border-right-color: #3b82f6; }
        .order-card.processing { border-right-color: #f59e0b; }
        .order-card.shipped { border-right-color: #8b5cf6; }
        .order-card.completed { border-right-color: #10b981; }
        
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-new { background: #dbeafe; color: #1e40af; }
        .status-processing { background: #fef3c7; color: #92400e; }
        .status-shipped { background: #ede9fe; color: #5b21b6; }
        .status-completed { background: #d1fae5; color: #065f46; }
        
        .customer-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.3s;
            cursor: pointer;
        }
        .customer-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
            margin-left: 10px;
        }
        .tab-btn:hover {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }
        .tab-btn.active {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }
        
        .tab-content {
            scroll-margin-top: 20px;
        }
        
        .category-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            width: 100%;
            text-align: center;
        }
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }
        .category-card:nth-child(2) {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        .category-card:nth-child(3) {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
        }
        .category-card:nth-child(4) {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .category-card:nth-child(5) {
            background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
        }
        
        .category-card-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            width: 100%;
            text-align: center;
        }
        .category-card-small:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }
        .category-card-small:nth-child(2) {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .modal-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            display: none;
            z-index: 99999;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }
        .modal-fullscreen.active {
            display: block !important;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .modal-header {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10001;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-radius: 0 !important;
        }
        .modal-body {
            padding: 0;
            background: #f9fafb;
            min-height: calc(100vh - 90px);
        }
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 32px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1;
        }
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            margin-left: 8px;
        }
        .filter-btn:hover {
            border-color: #8b5cf6;
        }
        .filter-btn.active {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }
        
        select, input[type="text"], input[type="date"], input[type="number"] {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 0.9rem;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-primary { background: #8b5cf6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">ğŸ“„ ×××©×§ × ×™×”×•×œ ×“×¤×™×</h1>
                        <p class="text-gray-600" id="store-name">AutoPage Store</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="window.location.href='/'" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                            ğŸ  ×“×£ ×”×‘×™×ª
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard - Statistics First -->
        <div id="tab-stats">
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Key Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <h3 id="totalSales">â‚ª0</h3>
                        <p>×¡×”"×› ××›×™×¨×•×ª</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalOrders">0</h3>
                        <p>×¡×”"×› ×”×–×× ×•×ª</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalCustomers">0</h3>
                        <p>×¡×”"×› ×œ×§×•×—×•×ª</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="avgOrderValue">â‚ª0</h3>
                        <p>×¢×¨×š ×”×–×× ×” ×××•×¦×¢</p>
                    </div>
                </div>

            </main>
            
            <!-- Quick Access Buttons -->
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">× ×™×”×•×œ ×“×¤×™×</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                    <!-- Stats Extended Card -->
                    <button onclick="openModal('stats')" class="category-card-small" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="text-5xl mb-3">ğŸ“Š</div>
                        <h3 class="text-xl font-bold">×¡×˜×˜×™×¡×˜×™×§×•×ª</h3>
                        </button>
                    
                    <!-- Orders Card -->
                    <button onclick="openModal('orders')" class="category-card-small">
                        <div class="text-5xl mb-3">ğŸ“¦</div>
                        <h3 class="text-xl font-bold">×”×–×× ×•×ª</h3>
                        </button>
                    
                    <!-- Customers Card -->
                    <button onclick="openModal('customers')" class="category-card-small" style="background: linear-gradient(135deg, #10b981 0%, #047857 100%);">
                        <div class="text-5xl mb-3">ğŸ‘¥</div>
                        <h3 class="text-xl font-bold">×œ×§×•×—×•×ª</h3>
                        </button>
                    
                    <!-- Finance Card -->
                    <button onclick="openModal('finance')" class="category-card-small" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <div class="text-5xl mb-3">ğŸ’°</div>
                        <h3 class="text-xl font-bold">×›×¡×¤×™×</h3>
                        </button>
                    
                    <!-- Export Card -->
                    <button onclick="openModal('export')" class="category-card-small" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);">
                        <div class="text-5xl mb-3">ğŸ“¥</div>
                        <h3 class="text-xl font-bold">×“×•×—×•×ª ×›×¡×¤×™×</h3>
                        <p class="text-sm text-pink-100 mt-1">×œ×”×•×¨×“×”</p>
                        </button>
                    </div>
                </div>
            </div>
            
        <!-- Hidden Content for Modals -->
        <div id="tab-stats-modal" style="display: none;">
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Key Stats (Copy) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card">
                        <h3 id="totalSales-modal">â‚ª0</h3>
                    <p>×¡×”"×› ××›×™×¨×•×ª</p>
                </div>
                <div class="stat-card">
                        <h3 id="totalOrders-modal">0</h3>
                    <p>×¡×”"×› ×”×–×× ×•×ª</p>
                </div>
                <div class="stat-card">
                        <h3 id="totalCustomers-modal">0</h3>
                    <p>×¡×”"×› ×œ×§×•×—×•×ª</p>
                </div>
                <div class="stat-card">
                        <h3 id="avgOrderValue-modal">â‚ª0</h3>
                    <p>×¢×¨×š ×”×–×× ×” ×××•×¦×¢</p>
                </div>
            </div>

                <!-- Charts & Graphs -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">ğŸ“ˆ ××›×™×¨×•×ª</h3>
                            <div class="flex gap-2">
                                <button class="filter-btn active" data-period="daily" onclick="filterSales('daily', event)">×™×•××™</button>
                                <button class="filter-btn" data-period="weekly" onclick="filterSales('weekly', event)">×©×‘×•×¢×™</button>
                                <button class="filter-btn" data-period="monthly" onclick="filterSales('monthly', event)">×—×•×“×©×™</button>
                            </div>
                        </div>
                        <div id="sales-chart-modal" class="space-y-2"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-xl font-bold mb-4">ğŸ† ××•×¦×¨×™× ×¤×•×¤×•×œ×¨×™×™×</h3>
                        <div id="popular-products-modal" class="space-y-3"></div>
                    </div>
                </div>
            </main>
                </div>

        <div id="tab-orders" style="display: none;">
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Quick Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4 border-r-4 border-blue-500">
                        <div class="text-2xl font-bold text-blue-700" id="orders-new">0</div>
                        <div class="text-sm text-blue-600">×”×–×× ×•×ª ×—×“×©×•×ª</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 border-r-4 border-yellow-500">
                        <div class="text-2xl font-bold text-yellow-700" id="orders-processing">0</div>
                        <div class="text-sm text-yellow-600">×‘×˜×™×¤×•×œ</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 border-r-4 border-purple-500">
                        <div class="text-2xl font-bold text-purple-700" id="orders-shipped">0</div>
                        <div class="text-sm text-purple-600">× ×©×œ×—</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 border-r-4 border-green-500">
                        <div class="text-2xl font-bold text-green-700" id="orders-completed">0</div>
                        <div class="text-sm text-green-600">×”×•×©×œ×</div>
                </div>
            </div>

                <!-- Filters -->
                <div class="bg-white rounded-lg shadow p-4 mb-6 flex flex-wrap gap-3 items-center">
                    <button class="filter-btn active" data-status="all" onclick="filterOrders('all')">×”×›×œ</button>
                    <button class="filter-btn" data-status="new" onclick="filterOrders('new')">ğŸ†• ×—×“×©</button>
                    <button class="filter-btn" data-status="processing" onclick="filterOrders('processing')">âš™ï¸ ×‘×˜×™×¤×•×œ</button>
                    <button class="filter-btn" data-status="shipped" onclick="filterOrders('shipped')">ğŸšš × ×©×œ×—</button>
                    <button class="filter-btn" data-status="completed" onclick="filterOrders('completed')">âœ… ×”×•×©×œ×</button>
                    <div class="mr-auto flex gap-2">
                        <input type="text" id="search-order" placeholder="×—×¤×© ×”×–×× ×”..." class="w-64">
                        <input type="date" id="filter-date">
                </div>
            </div>

                <!-- Orders List -->
                <div id="orders-list" class="space-y-4">
                    <p class="text-center text-gray-500 py-12">×˜×•×¢×Ÿ ×”×–×× ×•×ª...</p>
                        </div>
            </main>
                    </div>

        <!-- Tab: Customers (Hidden - For Modal Only) -->
        <div id="tab-customers" style="display: none;">
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-4">ğŸ“£ ×©×œ×— ×”×•×“×¢×” ×œ×œ×§×•×—×•×ª</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block mb-2 font-semibold">×¡×•×’ ×”×•×“×¢×”:</label>
                            <select id="message-type" class="w-full">
                                <option value="all">×›×œ ×”×œ×§×•×—×•×ª</option>
                                <option value="top">×œ×§×•×—×•×ª VIP (5+ ×§× ×™×•×ª)</option>
                                <option value="recent">×§× ×• ×‘×—×•×“×© ×”××—×¨×•×Ÿ</option>
                                <option value="inactive">×œ× ×§× ×• 3+ ×—×•×“×©×™×</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">×ª×•×›×Ÿ ×”×”×•×“×¢×”:</label>
                            <textarea id="message-content" class="w-full border-2 border-gray-300 rounded-lg p-3" rows="4" placeholder="×”×™! ×™×© ×œ× ×• ××‘×¦×¢ ××™×•×—×“ ×¨×§ ×‘×©×‘×™×œ×š..."></textarea>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="sendMessage('sms')" class="action-btn btn-primary">ğŸ“± ×©×œ×— SMS</button>
                            <button onclick="sendMessage('email')" class="action-btn btn-success">ğŸ“§ ×©×œ×— ××™×™×œ</button>
                            <button onclick="sendMessage('whatsapp')" class="action-btn btn-success">ğŸ’¬ ×©×œ×— WhatsApp</button>
                        </div>
                </div>
            </div>

                <!-- Customers List -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold mb-4">ğŸ‘¥ ×¨×©×™××ª ×œ×§×•×—×•×ª</h2>
                    <div class="mb-4">
                        <input type="text" id="search-customer" placeholder="×—×¤×© ×œ×§×•×—..." class="w-full">
                        </div>
                    <div id="customers-list" class="space-y-3">
                        <p class="text-center text-gray-500 py-8">×˜×•×¢×Ÿ ×œ×§×•×—×•×ª...</p>
                    </div>
                </div>
            </main>
            </div>

        <!-- Tab: Finance (Hidden - For Modal Only) -->
        <div id="tab-finance" style="display: none;">
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="text-sm mb-2">ğŸ’° ×”×›× ×¡×•×ª</div>
                        <div class="text-3xl font-bold" id="finance-revenue">â‚ª0</div>
                        </div>
                    <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="text-sm mb-2">ğŸ’¸ ×”×•×¦××•×ª</div>
                        <div class="text-3xl font-bold" id="finance-expenses">â‚ª0</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="text-sm mb-2">ğŸ“Š ×¨×•×•×— × ×§×™</div>
                        <div class="text-3xl font-bold" id="finance-profit">â‚ª0</div>
                </div>
            </div>

                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">â• ×”×•×¡×£ ×”×•×¦××”</h3>
                    <form id="expense-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">×©× ×”×”×•×¦××” *</label>
                                <input type="text" id="expense-desc" placeholder="×œ×“×•×’××”: ×—×•××¨×™ ×’×œ×, ××¨×™×–×•×ª..." class="w-full" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">×¡×›×•× *</label>
                                <input type="number" id="expense-amount" placeholder="0.00" step="0.01" class="w-full" required>
                            </div>
    </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">×§×˜×’×•×¨×™×” *</label>
                                <select id="expense-category" class="w-full" required>
                                    <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
                                    <option value="inventory">ğŸ“¦ ××œ××™ ×•×—×•××¨×™ ×’×œ×</option>
                                    <option value="marketing">ğŸ“¢ ×©×™×•×•×§ ×•×¤×¨×¡×•×</option>
                                    <option value="shipping">ğŸšš ××©×œ×•×—×™× ×•×”×•×‘×œ×”</option>
                                    <option value="rent">ğŸ¢ ×©×›×™×¨×•×ª ×•××—×–×§×”</option>
                                    <option value="salary">ğŸ’¼ ×©×›×¨ ×¢×•×‘×“×™×</option>
                                    <option value="utilities">âš¡ ×—×©××œ ×•××™×</option>
                                    <option value="packaging">ğŸ“¦ ××¨×™×–×•×ª</option>
                                    <option value="other">ğŸ“Œ ××—×¨</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">×ª××¨×™×š</label>
                                <input type="date" id="expense-date" class="w-full" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">×ª×™××•×¨ × ×•×¡×£</label>
                            <textarea id="expense-notes" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..." class="w-full" rows="2"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">ğŸ“ ×¦×¨×£ ×—×©×‘×•× ×™×ª / ×§×‘×œ×” (×ª××•× ×” ××• PDF)</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-500 transition-colors cursor-pointer" onclick="document.getElementById('expense-file').click()">
                                <div id="file-preview" class="text-gray-500">
                                    <div class="text-4xl mb-2">ğŸ“</div>
                                    <div>×œ×—×¥ ×œ×”×¢×œ××ª ×§×•×‘×¥</div>
                                    <div class="text-xs mt-1">JPG, PNG, PDF - ×¢×“ 5MB</div>
                                </div>
                                <input type="file" id="expense-file" accept="image/*,.pdf" class="hidden" onchange="previewFile(this)">
                            </div>
                        </div>
                        
                        <button type="submit" class="action-btn btn-primary w-full md:w-auto">ğŸ’¾ ×©××•×¨ ×”×•×¦××”</button>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-xl font-bold mb-4">ğŸ“‹ ×¨×©×™××ª ×”×•×¦××•×ª</h3>
                    <div id="expenses-list" class="space-y-2"></div>
                </div>
            </main>
        </div>

        <!-- Tab: Export (Hidden - For Modal Only) -->
        <div id="tab-export" style="display: none;">
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-lg shadow p-8">
                    <h2 class="text-2xl font-bold mb-6">ğŸ“¥ ×™×™×¦×•× × ×ª×•× ×™× ×œ×¨×©×•×™×•×ª ×”××¡</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block mb-2 font-semibold">×ª××¨×™×š ×”×ª×—×œ×”:</label>
                            <input type="date" id="export-start-date" class="w-full">
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold">×ª××¨×™×š ×¡×™×•×:</label>
                            <input type="date" id="export-end-date" class="w-full">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button onclick="exportData('excel')" class="bg-green-600 text-white p-6 rounded-lg hover:bg-green-700 transition">
                            <div class="text-4xl mb-2">ğŸ“Š</div>
                            <div class="font-bold text-lg">Excel</div>
                            <div class="text-sm opacity-90">×§×•×‘×¥ .xlsx</div>
                        </button>
                        <button onclick="exportData('csv')" class="bg-blue-600 text-white p-6 rounded-lg hover:bg-blue-700 transition">
                            <div class="text-4xl mb-2">ğŸ“„</div>
                            <div class="font-bold text-lg">CSV</div>
                            <div class="text-sm opacity-90">×§×•×‘×¥ .csv</div>
                        </button>
                        <button onclick="exportData('pdf')" class="bg-red-600 text-white p-6 rounded-lg hover:bg-red-700 transition">
                            <div class="text-4xl mb-2">ğŸ“‘</div>
                            <div class="font-bold text-lg">PDF</div>
                            <div class="text-sm opacity-90">×“×•×— PDF</div>
                        </button>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-bold text-blue-900 mb-2">ğŸ’¡ ××” ×›×•×œ×œ ×”×§×•×‘×¥?</h4>
                        <ul class="text-blue-800 space-y-1 text-sm">
                            <li>âœ“ ×›×œ ×”×”×–×× ×•×ª ×‘×ª×§×•×¤×” ×©× ×‘×—×¨×”</li>
                            <li>âœ“ ×¤×™×¨×•×˜ ××œ× ×©×œ ×›×œ ×¢×¡×§×” (××•×¦×¨×™×, ×¡×›×•××™×, ×ª××¨×™×›×™×)</li>
                            <li>âœ“ ×¤×™×¨×•×˜ ×”×•×¦××•×ª</li>
                            <li>âœ“ ×—×™×©×•×‘ ×¨×•×•×— × ×§×™</li>
                            <li>âœ“ ××•×›×Ÿ ×œ×”×’×©×” ×œ×¨×©×•×™×•×ª ×”××¡</li>
                        </ul>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">×¤×¨×˜×™ ×”×–×× ×”</h2>
                <button onclick="closeOrderModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
            </div>
            <div id="order-details"></div>
        </div>
    </div>

    <script>
        // Error handling for Edge compatibility
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            e.preventDefault();
        });

        let allOrders = [];
        let allCustomers = [];
        let currentFilter = 'all';
        let pageInfo = {};
        let expenses = [];

        function getPageInfo() {
            const urlParams = new URLSearchParams(window.location.search);
            pageInfo = {
                page: urlParams.get('page'),
                userId: urlParams.get('userId')
            };
            console.log('ğŸ“‹ Page info from URL:', pageInfo);
            return pageInfo;
        }

        async function loadStoreData() {
            console.log('ğŸ” loadStoreData called');
            const info = getPageInfo();
            
            if (!info.page || !info.userId) {
                console.warn('âš ï¸ Missing page or userId in URL!');
                const totalSalesEl = document.getElementById('totalSales');
                const totalOrdersEl = document.getElementById('totalOrders');
                const totalCustomersEl = document.getElementById('totalCustomers');
                const avgOrderValueEl = document.getElementById('avgOrderValue');
                
                if (totalSalesEl) totalSalesEl.textContent = 'â‚ª0';
                if (totalOrdersEl) totalOrdersEl.textContent = '0';
                if (totalCustomersEl) totalCustomersEl.textContent = '0';
                if (avgOrderValueEl) avgOrderValueEl.textContent = 'â‚ª0';
                return;
            }

            console.log(`ğŸ“Š Fetching analytics for: ${info.page}`);
            
            try {
                const apiUrl = `/api/analytics/page/${info.page}?userId=${info.userId}`;
                console.log('ğŸŒ API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                console.log('âœ… Analytics data received:', data);
                
                // Update stats - with null checks for Edge compatibility
                const totalSalesEl = document.getElementById('totalSales');
                const totalOrdersEl = document.getElementById('totalOrders');
                const totalCustomersEl = document.getElementById('totalCustomers');
                const avgOrderValueEl = document.getElementById('avgOrderValue');
                
                if (totalSalesEl) totalSalesEl.textContent = 'â‚ª' + (data.totalSales || 0).toLocaleString('he-IL');
                if (totalOrdersEl) totalOrdersEl.textContent = data.totalOrders || 0;
                if (totalCustomersEl) totalCustomersEl.textContent = data.totalCustomers || 0;
                if (avgOrderValueEl) avgOrderValueEl.textContent = 'â‚ª' + (data.averageOrderValue || 0).toFixed(0);
                
                // Update modal stats too (for when opening stats modal)
                const totalSalesModalEl = document.getElementById('totalSales-modal');
                const totalOrdersModalEl = document.getElementById('totalOrders-modal');
                const totalCustomersModalEl = document.getElementById('totalCustomers-modal');
                const avgOrderValueModalEl = document.getElementById('avgOrderValue-modal');
                
                if (totalSalesModalEl) totalSalesModalEl.textContent = 'â‚ª' + (data.totalSales || 0).toLocaleString('he-IL');
                if (totalOrdersModalEl) totalOrdersModalEl.textContent = data.totalOrders || 0;
                if (totalCustomersModalEl) totalCustomersModalEl.textContent = data.totalCustomers || 0;
                if (avgOrderValueModalEl) avgOrderValueModalEl.textContent = 'â‚ª' + (data.averageOrderValue || 0).toFixed(0);
                
                // Store orders and customers
                allOrders = data.purchases || data.recentPurchases || [];
                allCustomers = data.customers || [];
                
                // Render orders and customers
                renderOrders(allOrders);
                renderCustomers(allCustomers);
                updateOrderStats();
                updateFinanceData(data);
                renderPopularProducts(data.topProducts || []);
                filterSales('daily'); // Default to daily sales
                loadExpenses();
                
                console.log('âœ… Dashboard updated with analytics');
            } catch (error) {
                console.error('âŒ Error loading analytics:', error);
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-list');
            if (!container) return;
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">××™×Ÿ ×”×–×× ×•×ª ×¢×“×™×™×Ÿ</p>';
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-card ${order.status}" data-status="${order.status}" data-order-id="${order.id}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="font-bold text-lg">${order.customerName}</div>
                            <div class="text-sm text-gray-600">${order.customerPhone || ''}</div>
                            <div class="text-xs text-gray-500">${new Date(order.createdAt).toLocaleString('he-IL')}</div>
                    </div>
                        <div class="text-left">
                            <div class="text-2xl font-bold text-purple-600">â‚ª${order.total}</div>
                            <span class="status-badge status-${order.status}">${getStatusText(order.status)}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="text-sm font-semibold mb-1">××•×¦×¨×™×:</div>
                        ${order.products.map(p => `<div class="text-sm text-gray-700">â€¢ ${p.name} (${p.quantity}x)</div>`).join('')}
                    </div>
                    ${order.customerAddress && order.customerAddress !== '×œ× ×¦×•×™×Ÿ' ? 
                        `<div class="text-sm text-gray-600 mb-3">ğŸ“ ${order.customerAddress}</div>` : ''}
                    <div class="flex gap-2">
                        <button onclick="updateOrderStatus('${order.id}', 'processing')" class="action-btn btn-warning text-xs">âš™ï¸ ×‘×˜×™×¤×•×œ</button>
                        <button onclick="updateOrderStatus('${order.id}', 'shipped')" class="action-btn btn-primary text-xs">ğŸšš × ×©×œ×—</button>
                        <button onclick="updateOrderStatus('${order.id}', 'completed')" class="action-btn btn-success text-xs">âœ… ×”×•×©×œ×</button>
                        <button onclick="viewOrderDetails('${order.id}')" class="action-btn bg-gray-500 text-white text-xs">ğŸ‘ï¸ ×¤×¨×˜×™×</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCustomers(customers) {
            const container = document.getElementById('customers-list');
            if (!container) return;
            
            if (!customers || customers.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">××™×Ÿ ×œ×§×•×—×•×ª ×¢×“×™×™×Ÿ</p>';
                return;
            }

            container.innerHTML = customers.map(customer => `
                <div class="customer-card">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-bold text-lg mb-2">${customer.name}</div>
                            <div class="space-y-1 text-sm text-gray-600">
                                ${customer.phone ? `<div>ğŸ“± ${customer.phone}</div>` : ''}
                                ${customer.email ? `<div>ğŸ“§ ${customer.email}</div>` : ''}
                                ${customer.address ? `<div>ğŸ“ ${customer.address}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-left ml-4">
                            <div class="text-xl font-bold text-purple-600">â‚ª${customer.totalSpent.toLocaleString('he-IL')}</div>
                            <div class="text-xs text-gray-500">${customer.purchaseCount} ×§× ×™×•×ª</div>
                            ${customer.purchaseCount >= 5 ? '<div class="text-xs font-bold text-yellow-600">â­ VIP</div>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateOrderStats() {
            const stats = {
                new: allOrders.filter(o => o.status === 'new').length,
                processing: allOrders.filter(o => o.status === 'processing').length,
                shipped: allOrders.filter(o => o.status === 'shipped').length,
                completed: allOrders.filter(o => o.status === 'completed').length
            };
            
            const ordersNewEl = document.getElementById('orders-new');
            const ordersProcessingEl = document.getElementById('orders-processing');
            const ordersShippedEl = document.getElementById('orders-shipped');
            const ordersCompletedEl = document.getElementById('orders-completed');
            
            if (ordersNewEl) ordersNewEl.textContent = stats.new;
            if (ordersProcessingEl) ordersProcessingEl.textContent = stats.processing;
            if (ordersShippedEl) ordersShippedEl.textContent = stats.shipped;
            if (ordersCompletedEl) ordersCompletedEl.textContent = stats.completed;
        }

        function loadExpenses() {
            const stored = localStorage.getItem('expenses_' + (pageInfo.page || ''));
            if (stored) {
                expenses = JSON.parse(stored);
                renderExpenses();
                updateFinanceData();
            }
        }

        function renderExpenses() {
            const container = document.getElementById('expenses-list');
            if (!container) return;
            
            if (expenses.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">××™×Ÿ ×”×•×¦××•×ª</p>';
                return;
            }
            
            container.innerHTML = expenses.map((exp, i) => {
                const categoryIcon = {
                    'inventory': 'ğŸ“¦',
                    'marketing': 'ğŸ“¢',
                    'shipping': 'ğŸšš',
                    'rent': 'ğŸ¢',
                    'salary': 'ğŸ’¼',
                    'utilities': 'âš¡',
                    'packaging': 'ğŸ“¦',
                    'other': 'ğŸ“Œ'
                }[exp.category] || 'ğŸ“Œ';
                
                return `
                <div class="bg-gradient-to-r from-white to-gray-50 rounded-xl p-4 shadow-sm hover:shadow-md transition-all border-r-4 border-red-500">
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">${categoryIcon}</span>
                                <div class="font-bold text-lg">${exp.desc}</div>
                            </div>
                            <div class="text-sm text-gray-600 mb-1">${getCategoryName(exp.category)}</div>
                            ${exp.notes ? `<div class="text-xs text-gray-500 italic">${exp.notes}</div>` : ''}
                            ${exp.date ? `<div class="text-xs text-gray-400 mt-1">ğŸ“… ${new Date(exp.date).toLocaleDateString('he-IL')}</div>` : ''}
                        </div>
                        
                        <div class="flex items-center gap-3">
                            ${exp.fileUrl ? `
                                <div class="text-center">
                                    ${exp.fileUrl.endsWith('.pdf') ? `
                                        <a href="${exp.fileUrl}" target="_blank" class="block p-2 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">
                                            <div class="text-3xl">ğŸ“„</div>
                                            <div class="text-xs text-gray-600 mt-1">PDF</div>
                                        </a>
                                    ` : `
                                        <a href="${exp.fileUrl}" target="_blank" class="block">
                                            <img src="${exp.fileUrl}" class="w-16 h-16 object-cover rounded-lg border-2 border-purple-300 hover:border-purple-500 transition-colors cursor-pointer">
                                        </a>
                                    `}
                                </div>
                            ` : ''}
                            <div class="text-right">
                                <div class="font-bold text-2xl text-red-600">â‚ª${parseFloat(exp.amount).toFixed(2)}</div>
                                <button onclick="deleteExpense(${i})" class="mt-2 px-3 py-1 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors text-sm font-semibold">ğŸ—‘ï¸ ××—×§</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function getCategoryName(category) {
            const names = {
                'inventory': '××œ××™ ×•×—×•××¨×™ ×’×œ×',
                'marketing': '×©×™×•×•×§ ×•×¤×¨×¡×•×',
                'shipping': '××©×œ×•×—×™× ×•×”×•×‘×œ×”',
                'rent': '×©×›×™×¨×•×ª ×•××—×–×§×”',
                'salary': '×©×›×¨ ×¢×•×‘×“×™×',
                'utilities': '×—×©××œ ×•××™×',
                'packaging': '××¨×™×–×•×ª',
                'other': '××—×¨'
            };
            return names[category] || category;
        }

        function updateFinanceData(data) {
            const revenue = (data && data.totalSales) ? data.totalSales : allOrders.reduce((sum, o) => sum + o.total, 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            const profit = revenue - totalExpenses;
            
            const financeRevenueEl = document.getElementById('finance-revenue');
            const financeExpensesEl = document.getElementById('finance-expenses');
            const financeProfitEl = document.getElementById('finance-profit');
            
            if (financeRevenueEl) financeRevenueEl.textContent = 'â‚ª' + revenue.toLocaleString('he-IL');
            if (financeExpensesEl) financeExpensesEl.textContent = 'â‚ª' + totalExpenses.toLocaleString('he-IL');
            if (financeProfitEl) financeProfitEl.textContent = 'â‚ª' + profit.toLocaleString('he-IL');
        }

        function renderPopularProducts(products) {
            const containers = ['popular-products', 'popular-products-modal'];
            
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                if (!products || products.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 py-4">××™×Ÿ × ×ª×•× ×™×</p>';
                return;
            }

                container.innerHTML = products.slice(0, 5).map((p, i) => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="font-bold text-purple-600">#${i + 1}</div>
                        <div>
                                <div class="font-semibold">${p.name}</div>
                                <div class="text-xs text-gray-500">${p.count} × ××›×¨×•</div>
                        </div>
                    </div>
                        <div class="font-bold">â‚ª${p.revenue.toLocaleString('he-IL')}</div>
                </div>
            `).join('');
            });
        }
        
        function filterSales(period, event) {
            // Update button states
            document.querySelectorAll('[data-period]').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Group sales by period
            const salesByPeriod = {};
            allOrders.forEach(order => {
                const date = new Date(order.createdAt);
                let key;
                
                if (period === 'daily') {
                    key = date.toLocaleDateString('he-IL');
                } else if (period === 'weekly') {
                    const week = getWeekNumber(date);
                    key = `×©×‘×•×¢ ${week}, ${date.getFullYear()}`;
                } else { // monthly
                    key = date.toLocaleDateString('he-IL', { year: 'numeric', month: 'long' });
                }
                
                if (!salesByPeriod[key]) {
                    salesByPeriod[key] = 0;
                }
                salesByPeriod[key] += order.total;
            });
            
            // Render sales chart
            const container = document.getElementById('sales-chart-modal');
            if (!container) return;
            
            const entries = Object.entries(salesByPeriod).sort((a, b) => {
                // Sort by date (most recent first)
                return b[0].localeCompare(a[0]);
            }).slice(0, 10);
            
            if (entries.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">××™×Ÿ ××›×™×¨×•×ª ×¢×“×™×™×Ÿ</p>';
                return;
            }
            
            container.innerHTML = entries.map(([period, total]) => `
                <div class="flex justify-between items-center p-3 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg hover:from-purple-100 hover:to-blue-100 transition-colors">
                    <div class="font-semibold">${period}</div>
                    <div class="font-bold text-2xl text-purple-600">â‚ª${total.toLocaleString('he-IL')}</div>
                </div>
            `).join('');
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function getStatusText(status) {
            const texts = {
                new: 'ğŸ†• ×—×“×©',
                processing: 'âš™ï¸ ×‘×˜×™×¤×•×œ',
                shipped: 'ğŸšš × ×©×œ×—',
                completed: 'âœ… ×”×•×©×œ×'
            };
            return texts[status] || status;
        }

        async function updateOrderStatus(orderId, newStatus) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            try {
                const response = await fetch(`/api/order/${orderId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    order.status = newStatus;
                    filterOrders(currentFilter);
                    updateOrderStats();
                    alert(`âœ… ×”×–×× ×” ×¢×•×“×›× ×” ×œ: ${getStatusText(newStatus)}`);
                } else {
                    alert('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×–×× ×”');
                }
            } catch (error) {
                console.error('Error updating order:', error);
                alert('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×–×× ×”');
            }
        }

        function filterOrders(status) {
            currentFilter = status;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.status === status) {
                    btn.classList.add('active');
                }
            });
            
            let filtered = status === 'all' ? allOrders : allOrders.filter(o => o.status === status);
            
            const search = document.getElementById('search-order')?.value?.toLowerCase();
            if (search) {
                filtered = filtered.filter(o => 
                    o.customerName.toLowerCase().includes(search) ||
                    o.customerPhone?.includes(search) ||
                    o.id.includes(search)
                );
            }
            
            const dateFilter = document.getElementById('filter-date')?.value;
            if (dateFilter) {
                filtered = filtered.filter(o => 
                    new Date(o.createdAt).toISOString().split('T')[0] === dateFilter
                );
            }
            
            renderOrders(filtered);
        }

        function viewOrderDetails(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            const modal = document.getElementById('order-modal');
            const details = document.getElementById('order-details');
            
            details.innerHTML = `
                <div class="space-y-4">
                    <div><strong>××¡×¤×¨ ×”×–×× ×”:</strong> ${order.id}</div>
                    <div><strong>×ª××¨×™×š:</strong> ${new Date(order.createdAt).toLocaleString('he-IL')}</div>
                    <div><strong>×œ×§×•×—:</strong> ${order.customerName}</div>
                    <div><strong>ğŸ“± ×˜×œ×¤×•×Ÿ:</strong> ${order.customerPhone || '×œ× ×¦×•×™×Ÿ'}</div>
                    <div><strong>ğŸ“§ ××™××™×™×œ:</strong> ${order.customerEmail || '×œ× ×¦×•×™×Ÿ'}</div>
                    <div><strong>ğŸ“ ×›×ª×•×‘×ª:</strong> ${order.customerAddress || '×œ× ×¦×•×™×Ÿ'}</div>
                    <div><strong>×¡×˜×˜×•×¡:</strong> <span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></div>
                    <div class="border-t pt-4">
                        <strong>××•×¦×¨×™×:</strong>
                        ${order.products.map(p => `
                            <div class="flex justify-between py-2 border-b">
                                <div>${p.name} Ã— ${p.quantity}</div>
                                <div>â‚ª${p.price * p.quantity}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-xl font-bold text-left">×¡×”"×›: â‚ª${order.total}</div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.remove('active');
        }

        function sendMessage(type) {
            const messageType = document.getElementById('message-type').value;
            const content = document.getElementById('message-content').value;
            
            if (!content) {
                alert('×× × ×›×ª×•×‘ ×”×•×“×¢×”');
                return;
            }
            
            alert(`×©×•×œ×— ${type} ×œ${messageType === 'all' ? '×›×œ ×”×œ×§×•×—×•×ª' : messageType}...\n\n×ª×•×›×Ÿ: ${content}`);
        }

        async function addExpense(event) {
            if (event) event.preventDefault();
            
            const desc = document.getElementById('expense-desc').value;
            const amount = document.getElementById('expense-amount').value;
            const category = document.getElementById('expense-category').value;
            const date = document.getElementById('expense-date').value;
            const notes = document.getElementById('expense-notes').value;
            const fileInput = document.getElementById('expense-file');
            
            if (!desc || !amount || !category) {
                alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”');
                return;
            }
            
            let fileUrl = null;
            let fileName = null;
            
            // Upload file if exists
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('×”×§×•×‘×¥ ×’×“×•×œ ××“×™! ××§×¡×™××•× 5MB');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('userId', pageInfo.userId);
                formData.append('storeId', pageInfo.page.replace('_html', ''));
                
                try {
                    const response = await fetch('/api/upload-expense-file', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        fileUrl = data.url;
                        fileName = data.fileName;
                        console.log('âœ… File uploaded:', fileUrl);
                    } else {
                        alert('×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥');
                        return;
                    }
                } catch (error) {
                    console.error('Error uploading file:', error);
                    alert('×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥');
                    return;
                }
            }
            
            const expense = {
                id: Date.now(),
                desc,
                amount: parseFloat(amount),
                category,
                date: date || new Date().toISOString(),
                notes,
                fileUrl,
                fileName,
                createdAt: new Date().toISOString()
            };
            
            expenses.push(expense);
            localStorage.setItem('expenses_' + (pageInfo.page || ''), JSON.stringify(expenses));
            
            renderExpenses();
            updateFinanceData();
            
            // Clear form
            document.getElementById('expense-form').reset();
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('file-preview').innerHTML = `
                <div class="text-4xl mb-2">ğŸ“</div>
                <div>×œ×—×¥ ×œ×”×¢×œ××ª ×§×•×‘×¥</div>
                <div class="text-xs mt-1">JPG, PNG, PDF - ×¢×“ 5MB</div>
            `;
            
            alert('âœ… ×”×”×•×¦××” × ×©××¨×” ×‘×”×¦×œ×—×”!');
        }
        
        function previewFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const preview = document.getElementById('file-preview');
            const fileType = file.type;
            const fileName = file.name;
            
            if (fileType.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" class="max-h-32 mx-auto rounded-lg mb-2">
                        <div class="text-sm font-semibold">${fileName}</div>
                        <div class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</div>
                    `;
                };
                reader.readAsDataURL(file);
            } else if (fileType === 'application/pdf') {
                preview.innerHTML = `
                    <div class="text-5xl mb-2">ğŸ“„</div>
                    <div class="text-sm font-semibold">${fileName}</div>
                    <div class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</div>
                `;
            }
        }

        async function deleteExpense(index) {
            if (!confirm('×œ××—×•×§ ×”×•×¦××” ×–×•?')) return;
            
            const expense = expenses[index];
            
            // Delete file from server if exists
            if (expense.fileUrl) {
                try {
                    const response = await fetch('/api/delete-expense-file', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            fileUrl: expense.fileUrl,
                            userId: pageInfo.userId,
                            storeId: pageInfo.page.replace('_html', '')
                        })
                    });
                    
                    if (response.ok) {
                        console.log('âœ… Expense file deleted from server');
                    }
                } catch (error) {
                    console.warn('âš ï¸ Could not delete expense file:', error);
                }
            }
            
            expenses.splice(index, 1);
            localStorage.setItem('expenses_' + (pageInfo.page || ''), JSON.stringify(expenses));
            renderExpenses();
            updateFinanceData();
        }

        function exportData(format) {
            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;
            
            if (!startDate || !endDate) {
                alert('×× × ×‘×—×¨ ×ª××¨×™×›×™×');
                return;
            }
            
            alert(`××™×™×¦× × ×ª×•× ×™× ×œ-${format}\n×-${startDate} ×¢×“ ${endDate}`);
        }

        function switchTab(tabName, event) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            const targetSection = document.getElementById('tab-' + tabName);
            if (targetSection) {
                try {
                    targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch (e) {
                    targetSection.scrollIntoView();
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const userAgent = navigator.userAgent;
            const isEdge = userAgent.indexOf('Edg') !== -1;
            const isChrome = userAgent.indexOf('Chrome') !== -1 && !isEdge;
            console.log('Browser detected:', { isEdge, isChrome, userAgent });
            
            // Check page type and redirect if needed
            const info = getPageInfo();
            if (info.page && info.userId) {
                try {
                    const response = await fetch(`/api/analytics/page/${info.page}?userId=${info.userId}`);
                    const data = await response.json();
                    const pageType = data.metadata?.pageType || 'store';
                    
                    console.log('ğŸ“‹ Page type detected:', pageType);
                    console.log('ğŸ“‹ Metadata:', data.metadata);
                    
                    // ×‘×“×•×§ ×× ×™×© ×ª×•×¨×™× ×‘×“×£ (×’× landing pages ×™×›×•×œ×™× ×œ×”×™×•×ª ×‘×¢×œ×™ ××§×¦×•×¢)
                    const hasAppointments = data.metadata?.appointments || data.appointments;
                    console.log('ğŸ“… Has appointments:', hasAppointments);
                    
                    if (pageType === 'serviceProvider' || pageType === 'appointment') {
                        // Redirect to appointments manager
                        window.location.href = `/appointments-manager.html?page=${info.page}&userId=${info.userId}`;
                        return;
                    }
                    
                    if (pageType === 'course' || pageType === 'onlineCourse') {
                        // Redirect to course management
                        window.location.href = `/course-management.html?pageId=${info.page}&userId=${info.userId}`;
                        return;
                    }
                    
                    if (pageType === 'realEstate') {
                        // Redirect to leads management (same as events)
                        console.log('ğŸ  Real estate page - redirecting to leads management');
                        window.location.href = `/leads-manager.html?page=${info.page}&userId=${info.userId}`;
                        return;
                    }
                    
                    if (pageType === 'landing' || pageType === 'general') {
                        // Landing pages with appointments â†’ appointments manager
                        // Landing pages without appointments â†’ leads management
                        if (hasAppointments) {
                            console.log('ğŸ“… Landing page with appointments - redirecting to appointments manager');
                            window.location.href = `/appointments-manager.html?page=${info.page}&userId=${info.userId}`;
                        } else {
                            console.log('ğŸ“„ Landing/Brand page - redirecting to leads management');
                            window.location.href = `/leads-manager.html?page=${info.page}&userId=${info.userId}`;
                        }
                        return;
                    }
                    
                    if (pageType === 'event') {
                        // Event pages â†’ leads management
                        console.log('ğŸ‰ Event page - redirecting to leads management');
                        window.location.href = `/leads-manager.html?page=${info.page}&userId=${info.userId}`;
                        return;
                    }
                    
                    if (pageType === 'messageInBottle') {
                        // Message in a Bottle pages â†’ leads management
                        console.log('ğŸ¾ Message in a Bottle page - redirecting to leads management');
                        window.location.href = `/leads-management.html?page=${info.page}&userId=${info.userId}`;
                        return;
                    }
                } catch (error) {
                    console.warn('âš ï¸ Could not detect page type:', error);
                }
            }
            
            loadStoreData();
            
            // Add expense form submit handler
            document.getElementById('expense-form')?.addEventListener('submit', addExpense);
            
            // Set default date for expense
            const expenseDateInput = document.getElementById('expense-date');
            if (expenseDateInput) {
                expenseDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            document.getElementById('search-order')?.addEventListener('input', () => filterOrders(currentFilter));
            document.getElementById('filter-date')?.addEventListener('change', () => filterOrders(currentFilter));
            document.getElementById('search-customer')?.addEventListener('input', (e) => {
                const search = e.target.value.toLowerCase();
                const filtered = allCustomers.filter(c => 
                    c.name.toLowerCase().includes(search) ||
                    c.phone?.includes(search) ||
                    c.email?.toLowerCase().includes(search)
                );
                renderCustomers(filtered);
            });
        });
        
        // Modal Functions
        function openModal(category) {
            const modal = document.getElementById('modal-' + category);
            // For stats, use the extended modal content
            const contentId = category === 'stats' ? 'tab-stats-modal' : 'tab-' + category;
            const content = document.getElementById(contentId);
            const modalBody = modal.querySelector('.modal-body');
            
            // Clone content into modal
            modalBody.innerHTML = '';
            const clonedContent = content.cloneNode(true);
            clonedContent.style.display = 'block';
            modalBody.appendChild(clonedContent);
            
            // Show modal fullscreen
            modal.classList.add('active');
            modal.style.display = 'block';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.zIndex = '99999';
            document.body.style.overflow = 'hidden';
            
            console.log('âœ… Opened fullscreen modal:', category);
        }
        
        function closeModal(category) {
            const modal = document.getElementById('modal-' + category);
            modal.classList.remove('active');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // No overlay click to close - only ESC or close button
        
        // Close modal on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-fullscreen').forEach(m => {
                    m.classList.remove('active');
                    m.style.display = 'none';
                });
                document.body.style.overflow = 'auto';
            }
        });
    </script>
    
    <!-- Modal Containers (Fullscreen) -->
    <div id="modal-stats" class="modal-fullscreen">
        <div class="modal-header">
            <h2 class="text-3xl font-bold">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ××•×¨×—×‘×•×ª</h2>
            <button onclick="closeModal('stats')" class="modal-close">Ã—</button>
        </div>
        <div class="modal-body"></div>
    </div>
    
    <div id="modal-orders" class="modal-fullscreen">
        <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
            <h2 class="text-3xl font-bold">ğŸ“¦ × ×™×”×•×œ ×”×–×× ×•×ª</h2>
            <button onclick="closeModal('orders')" class="modal-close">Ã—</button>
        </div>
        <div class="modal-body"></div>
    </div>
    
    <div id="modal-customers" class="modal-fullscreen">
        <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #047857 100%);">
            <h2 class="text-3xl font-bold">ğŸ‘¥ ××•×¢×“×•×Ÿ ×œ×§×•×—×•×ª</h2>
            <button onclick="closeModal('customers')" class="modal-close">Ã—</button>
        </div>
        <div class="modal-body"></div>
    </div>
    
    <div id="modal-finance" class="modal-fullscreen">
        <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <h2 class="text-3xl font-bold">ğŸ’° × ×™×”×•×œ ×›×¡×¤×™×</h2>
            <button onclick="closeModal('finance')" class="modal-close">Ã—</button>
        </div>
        <div class="modal-body"></div>
    </div>
    
    <div id="modal-export" class="modal-fullscreen">
        <div class="modal-header" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);">
            <h2 class="text-3xl font-bold">ğŸ“¥ ×“×•×—×•×ª ×›×¡×¤×™× ×œ×”×•×¨×“×”</h2>
            <button onclick="closeModal('export')" class="modal-close">Ã—</button>
        </div>
        <div class="modal-body"></div>
    </div>
    
</body>
</html>

