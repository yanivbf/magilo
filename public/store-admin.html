<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×—× ×•×ª - ×¤×× ×œ × ×™×”×•×œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Heebo', sans-serif;
        }
        
        .order-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .order-card.pending {
            border-left-color: #f59e0b;
            background-color: #fffbeb;
        }
        
        .order-card.processing {
            border-left-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .order-card.shipped {
            border-left-color: #8b5cf6;
            background-color: #f5f3ff;
        }
        
        .order-card.delivered {
            border-left-color: #10b981;
            background-color: #f0fdf4;
        }
        
        .order-card.cancelled {
            border-left-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .order-card:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .stat-card.amber {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .stat-card.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .tab-button {
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .tab-button.active {
            background-color: #667eea;
            color: white;
        }
        
        .tab-button:not(.active):hover {
            background-color: #f3f4f6;
        }
        
        .product-mini {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .product-mini img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .status-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .status-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50 no-print">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ›’ × ×™×”×•×œ ×—× ×•×ª</h1>
                    <span id="page-title" class="text-lg text-gray-600"></span>
                </div>
                <div class="flex gap-3">
                    <button onclick="refreshData()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                        ğŸ”„ ×¨×¢× ×Ÿ
                    </button>
                    <button onclick="window.print()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                        ğŸ–¨ï¸ ×”×“×¤×¡
                    </button>
                    <button onclick="exportOrders()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                        ğŸ“Š ×™×™×¦× ×œ××§×¡×œ
                    </button>
                    <button onclick="goBackToPage()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition">
                        â† ×—×–×•×¨ ×œ×—× ×•×ª
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8 no-print">
            <div class="stat-card">
                <div class="text-sm opacity-90 mb-2">×¡×”"×› ×”×–×× ×•×ª</div>
                <div class="text-3xl font-bold" id="total-orders">0</div>
            </div>
            <div class="stat-card amber">
                <div class="text-sm opacity-90 mb-2">×××ª×™× ×•×ª ×œ×˜×™×¤×•×œ</div>
                <div class="text-3xl font-bold" id="pending-orders">0</div>
            </div>
            <div class="stat-card blue">
                <div class="text-sm opacity-90 mb-2">×‘×˜×™×¤×•×œ</div>
                <div class="text-3xl font-bold" id="processing-orders">0</div>
            </div>
            <div class="stat-card purple">
                <div class="text-sm opacity-90 mb-2">× ×©×œ×—×•</div>
                <div class="text-3xl font-bold" id="shipped-orders">0</div>
            </div>
            <div class="stat-card green">
                <div class="text-sm opacity-90 mb-2">×”×•×©×œ××•</div>
                <div class="text-3xl font-bold" id="delivered-orders">0</div>
            </div>
        </div>

        <!-- Revenue Card -->
        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-xl shadow-lg p-6 mb-8 text-white no-print">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm opacity-90 mb-1">×¡×”"×› ×”×›× ×¡×•×ª</div>
                    <div class="text-4xl font-bold" id="total-revenue">â‚ª0</div>
                </div>
                <div class="text-6xl opacity-50">ğŸ’°</div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8 no-print">
            <div class="flex gap-3 flex-wrap">
                <button class="tab-button active" onclick="filterOrders('all')" data-filter="all">
                    ×”×›×œ
                </button>
                <button class="tab-button" onclick="filterOrders('today')" data-filter="today">
                    ×”×™×•×
                </button>
                <button class="tab-button" onclick="filterOrders('week')" data-filter="week">
                    ×”×©×‘×•×¢
                </button>
                <button class="tab-button" onclick="filterOrders('pending')" data-filter="pending">
                    â³ ×××ª×™× ×•×ª
                </button>
                <button class="tab-button" onclick="filterOrders('processing')" data-filter="processing">
                    ğŸ”„ ×‘×˜×™×¤×•×œ
                </button>
                <button class="tab-button" onclick="filterOrders('shipped')" data-filter="shipped">
                    ğŸ“¦ × ×©×œ×—×•
                </button>
                <button class="tab-button" onclick="filterOrders('delivered')" data-filter="delivered">
                    âœ… ×”×•×©×œ××•
                </button>
            </div>
            
            <div class="mt-4 flex gap-3">
                <input type="date" id="filter-date" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterByDate()">
                <input type="text" id="search-input" placeholder="×—×¤×© ×œ×¤×™ ×©×, ×˜×œ×¤×•×Ÿ, ××•×¦×¨ ××• ××¡×¤×¨ ×”×–×× ×”..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" oninput="searchOrders()">
            </div>
        </div>

        <!-- Orders List -->
        <div id="orders-container" class="space-y-4">
            <!-- Orders will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
            <div class="text-6xl mb-4">ğŸ›’</div>
            <h3 class="text-2xl font-bold text-gray-700 mb-2">××™×Ÿ ×”×–×× ×•×ª ×œ×”×¦×’×”</h3>
            <p class="text-gray-600">×”×”×–×× ×•×ª ×©×™×ª×§×‘×œ×• ×™×•×¤×™×¢×• ×›××Ÿ</p>
        </div>
    </div>

    <script>
        let allOrders = [];
        let filteredOrders = [];
        let currentFilter = 'all';
        let userId = '';
        let pageId = '';
        let pageName = '';

        // Get userId and pageId from URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            userId = params.get('userId') || '';
            pageId = params.get('pageId') || '';
            pageName = params.get('pageName') || '×”×—× ×•×ª ×©×œ×™';
            
            document.getElementById('page-title').textContent = `(${decodeURIComponent(pageName)})`;
            
            if (!userId || !pageId) {
                console.warn('×—×¡×¨×™× ×¤×¨×˜×™ ×“×£. ×˜×•×¢×Ÿ × ×ª×•× ×™× ×œ×“×•×’××”.');
                loadSampleData();
                return false;
            }
            return true;
        }

        // Load sample data for demo
        function loadSampleData() {
            allOrders = [
                {
                    id: 'ORD-001',
                    date: new Date().toISOString().split('T')[0],
                    time: '10:30',
                    customer: {
                        name: '×“× ×™ ×›×”×Ÿ',
                        phone: '0501234567',
                        email: 'dani@example.com',
                        address: '×¨×—×•×‘ ×”×¨×¦×œ 15, ×ª×œ ××‘×™×‘'
                    },
                    items: [
                        { name: '××•×–× ×™×•×ª ××œ×—×•×˜×™×•×ª', price: 299, quantity: 1, image: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=100' },
                        { name: '×›×‘×œ USB-C', price: 39, quantity: 2, image: 'https://images.unsplash.com/photo-1613040809024-b445388c2c88?w=100' }
                    ],
                    total: 377,
                    status: 'pending',
                    shipping: 'delivery',
                    notes: '×œ×©×œ×•×— ×‘×©×¢×•×ª ×”×¢×¨×‘'
                },
                {
                    id: 'ORD-002',
                    date: new Date().toISOString().split('T')[0],
                    time: '14:15',
                    customer: {
                        name: '××™×›×œ ×œ×•×™',
                        phone: '0529876543',
                        email: 'michal@example.com',
                        address: '××™×¡×•×£ ×¢×¦××™'
                    },
                    items: [
                        { name: '×©×¢×•×Ÿ ×—×›×', price: 399, quantity: 1, image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=100' }
                    ],
                    total: 399,
                    status: 'processing',
                    shipping: 'pickup',
                    notes: ''
                },
                {
                    id: 'ORD-003',
                    date: new Date(Date.now() - 86400000).toISOString().split('T')[0],
                    time: '09:00',
                    customer: {
                        name: '×™×•×¡×™ ××‘×¨×”×',
                        phone: '0531112222',
                        email: 'yossi@example.com',
                        address: '×¨×—×•×‘ ×‘×Ÿ ×’×•×¨×™×•×Ÿ 8, ×—×™×¤×”'
                    },
                    items: [
                        { name: '×¨××§×•×œ × ×™×™×“', price: 179, quantity: 1, image: 'https://images.unsplash.com/photo-1585386959984-a4155224a1ad?w=100' },
                        { name: '××•×–× ×™×•×ª ×’×™×™××™× ×’', price: 279, quantity: 1, image: 'https://images.unsplash.com/photo-1583394838336-acd977736f90?w=100' }
                    ],
                    total: 458,
                    status: 'shipped',
                    shipping: 'delivery',
                    trackingNumber: 'IL123456789',
                    notes: ''
                }
            ];
            
            filterOrders(currentFilter);
            updateStatistics();
        }

        // Load orders from server
        async function loadOrders() {
            if (!getUrlParams()) return;
            
            try {
                const response = await fetch(`/api/orders/${userId}/${pageId}`);
                if (!response.ok) {
                    console.warn('No orders endpoint, loading sample data');
                    loadSampleData();
                    return;
                }
                
                const data = await response.json();
                allOrders = data.orders || [];
                
                // Sort by date and time (newest first)
                allOrders.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                    const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                    return dateB - dateA;
                });
                
                filterOrders(currentFilter);
                updateStatistics();
            } catch (error) {
                console.error('Error loading orders:', error);
                loadSampleData();
            }
        }

        // Update statistics
        function updateStatistics() {
            const total = allOrders.length;
            const pending = allOrders.filter(o => o.status === 'pending' || !o.status).length;
            const processing = allOrders.filter(o => o.status === 'processing').length;
            const shipped = allOrders.filter(o => o.status === 'shipped').length;
            const delivered = allOrders.filter(o => o.status === 'delivered').length;
            
            const revenue = allOrders
                .filter(o => o.status !== 'cancelled')
                .reduce((sum, o) => sum + (o.total || 0), 0);
            
            document.getElementById('total-orders').textContent = total;
            document.getElementById('pending-orders').textContent = pending;
            document.getElementById('processing-orders').textContent = processing;
            document.getElementById('shipped-orders').textContent = shipped;
            document.getElementById('delivered-orders').textContent = delivered;
            document.getElementById('total-revenue').textContent = `â‚ª${revenue.toLocaleString()}`;
        }

        // Filter orders
        function filterOrders(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() - 7);
            
            filteredOrders = allOrders.filter(order => {
                const orderDate = new Date(order.date);
                orderDate.setHours(0, 0, 0, 0);
                
                switch(filter) {
                    case 'today':
                        return orderDate.getTime() === today.getTime();
                    case 'week':
                        return orderDate >= weekStart && orderDate <= today;
                    case 'pending':
                        return order.status === 'pending' || !order.status;
                    case 'processing':
                        return order.status === 'processing';
                    case 'shipped':
                        return order.status === 'shipped';
                    case 'delivered':
                        return order.status === 'delivered';
                    case 'cancelled':
                        return order.status === 'cancelled';
                    default:
                        return true;
                }
            });
            
            renderOrders();
        }

        // Filter by date
        function filterByDate() {
            const dateInput = document.getElementById('filter-date').value;
            if (!dateInput) {
                filterOrders(currentFilter);
                return;
            }
            
            filteredOrders = allOrders.filter(order => order.date === dateInput);
            renderOrders();
        }

        // Search orders
        function searchOrders() {
            const query = document.getElementById('search-input').value.toLowerCase();
            if (!query) {
                filterOrders(currentFilter);
                return;
            }
            
            filteredOrders = allOrders.filter(order => {
                const customerName = (order.customer?.name || '').toLowerCase();
                const customerPhone = order.customer?.phone || '';
                const orderId = (order.id || '').toLowerCase();
                const items = (order.items || []).map(i => i.name.toLowerCase()).join(' ');
                
                return customerName.includes(query) ||
                       customerPhone.includes(query) ||
                       orderId.includes(query) ||
                       items.includes(query);
            });
            
            renderOrders();
        }

        // Render orders
        function renderOrders() {
            const container = document.getElementById('orders-container');
            const emptyState = document.getElementById('empty-state');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            const statusTexts = {
                'pending': '×××ª×™× ×” ×œ×˜×™×¤×•×œ',
                'processing': '×‘×˜×™×¤×•×œ',
                'shipped': '× ×©×œ×—×”',
                'delivered': '×”×•×©×œ××”',
                'cancelled': '×‘×•×˜×œ×”'
            };
            
            const statusIcons = {
                'pending': 'â³',
                'processing': 'ğŸ”„',
                'shipped': 'ğŸ“¦',
                'delivered': 'âœ…',
                'cancelled': 'âŒ'
            };
            
            const hebrewDays = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            
            container.innerHTML = filteredOrders.map(order => {
                const status = order.status || 'pending';
                const statusText = statusTexts[status] || '×××ª×™× ×”';
                const statusIcon = statusIcons[status] || 'â³';
                
                const date = new Date(order.date);
                const dayName = hebrewDays[date.getDay()];
                const formattedDate = `${dayName}, ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                
                const itemsHtml = (order.items || []).map(item => `
                    <div class="product-mini">
                        ${item.image ? `<img src="${item.image}" alt="${item.name}" onerror="this.style.display='none'">` : ''}
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">${item.name}</div>
                            <div class="text-sm text-gray-600">×›××•×ª: ${item.quantity} Ã— â‚ª${item.price}</div>
                        </div>
                        <div class="font-bold text-gray-800">â‚ª${item.price * item.quantity}</div>
                    </div>
                `).join('');
                
                const shippingText = order.shipping === 'pickup' ? 'ğŸ  ××™×¡×•×£ ×¢×¦××™' : 'ğŸšš ××©×œ×•×— ×œ×›×ª×•×‘×ª';
                
                return `
                    <div class="order-card ${status} bg-white rounded-xl shadow-md p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-xl font-bold text-gray-800">${order.customer?.name || '×œ×§×•×—'}</h3>
                                    <span class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">${order.id || '×œ×œ× ××¡×¤×¨'}</span>
                                </div>
                                <div class="flex items-center gap-2 text-gray-600">
                                    <span>ğŸ“… ${formattedDate}</span>
                                    ${order.time ? `<span>â€¢</span><span>ğŸ• ${order.time}</span>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <select class="status-select" onchange="updateStatus('${order.id}', this.value)" ${status === 'cancelled' ? 'disabled' : ''}>
                                    <option value="pending" ${status === 'pending' ? 'selected' : ''}>â³ ×××ª×™× ×”</option>
                                    <option value="processing" ${status === 'processing' ? 'selected' : ''}>ğŸ”„ ×‘×˜×™×¤×•×œ</option>
                                    <option value="shipped" ${status === 'shipped' ? 'selected' : ''}>ğŸ“¦ × ×©×œ×—×”</option>
                                    <option value="delivered" ${status === 'delivered' ? 'selected' : ''}>âœ… ×”×•×©×œ××”</option>
                                    <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>âŒ ×‘×•×˜×œ×”</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Customer Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
                            ${order.customer?.phone ? `
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">ğŸ“</span>
                                    <a href="tel:${order.customer.phone}" class="text-blue-600 hover:underline">${order.customer.phone}</a>
                                </div>
                            ` : ''}
                            ${order.customer?.email ? `
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500">âœ‰ï¸</span>
                                    <a href="mailto:${order.customer.email}" class="text-blue-600 hover:underline">${order.customer.email}</a>
                                </div>
                            ` : ''}
                            <div class="flex items-center gap-2 md:col-span-2">
                                <span class="text-gray-500">${shippingText}</span>
                                ${order.shipping !== 'pickup' && order.customer?.address ? `
                                    <span class="text-gray-700">${order.customer.address}</span>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Products -->
                        <div class="mb-4">
                            <div class="text-sm font-semibold text-gray-600 mb-2">××•×¦×¨×™×:</div>
                            ${itemsHtml}
                        </div>
                        
                        <!-- Total -->
                        <div class="flex justify-between items-center p-3 bg-gradient-to-r from-gray-100 to-gray-50 rounded-lg mb-4">
                            <span class="text-lg font-bold text-gray-800">×¡×”"×› ×œ×ª×©×œ×•×:</span>
                            <span class="text-2xl font-bold text-green-600">â‚ª${order.total || 0}</span>
                        </div>
                        
                        ${order.trackingNumber ? `
                            <div class="bg-purple-50 rounded-lg p-3 mb-4">
                                <div class="text-sm text-purple-600 font-semibold mb-1">ğŸ“¦ ××¡×¤×¨ ××¢×§×‘:</div>
                                <div class="text-purple-800 font-mono">${order.trackingNumber}</div>
                            </div>
                        ` : ''}
                        
                        ${order.notes ? `
                            <div class="bg-yellow-50 rounded-lg p-3 mb-4">
                                <div class="text-sm text-yellow-700 font-semibold mb-1">ğŸ“ ×”×¢×¨×•×ª:</div>
                                <div class="text-gray-700">${order.notes}</div>
                            </div>
                        ` : ''}
                        
                        <div class="flex gap-2 no-print">
                            <button onclick="contactCustomer('${order.customer?.phone || ''}')" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                                ğŸ’¬ WhatsApp
                            </button>
                            ${status === 'processing' ? `
                                <button onclick="promptTrackingNumber('${order.id}')" class="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition">
                                    ğŸ“¦ ×”×•×¡×£ ××¡×¤×¨ ××¢×§×‘
                                </button>
                            ` : ''}
                            <button onclick="printOrder('${order.id}')" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                ğŸ–¨ï¸
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update order status
        async function updateStatus(orderId, newStatus) {
            try {
                // Try to update on server
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                // Update local data regardless of server response
                const order = allOrders.find(o => o.id === orderId);
                if (order) {
                    order.status = newStatus;
                }
                
                filterOrders(currentFilter);
                updateStatistics();
                
                showToast(`×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×œ: ${getStatusText(newStatus)}`);
            } catch (error) {
                console.error('Error updating status:', error);
                // Still update locally for demo
                const order = allOrders.find(o => o.id === orderId);
                if (order) {
                    order.status = newStatus;
                }
                filterOrders(currentFilter);
                updateStatistics();
                showToast(`×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×œ: ${getStatusText(newStatus)}`);
            }
        }

        function getStatusText(status) {
            const texts = {
                'pending': '×××ª×™× ×” ×œ×˜×™×¤×•×œ',
                'processing': '×‘×˜×™×¤×•×œ',
                'shipped': '× ×©×œ×—×”',
                'delivered': '×”×•×©×œ××”',
                'cancelled': '×‘×•×˜×œ×”'
            };
            return texts[status] || status;
        }

        // Prompt for tracking number
        function promptTrackingNumber(orderId) {
            const trackingNumber = prompt('×”×–×Ÿ ××¡×¤×¨ ××¢×§×‘ ×œ××©×œ×•×—:');
            if (trackingNumber) {
                const order = allOrders.find(o => o.id === orderId);
                if (order) {
                    order.trackingNumber = trackingNumber;
                    order.status = 'shipped';
                    filterOrders(currentFilter);
                    updateStatistics();
                    showToast('××¡×¤×¨ ×”××¢×§×‘ × ×•×¡×£ ×•×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×œ× ×©×œ×—');
                }
            }
        }

        // Print single order
        function printOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>×”×–×× ×” ${order.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .info { margin: 10px 0; }
                        .items { margin: 20px 0; }
                        .item { padding: 10px; background: #f5f5f5; margin: 5px 0; }
                        .total { font-size: 20px; font-weight: bold; margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <h1>×”×–×× ×” ××¡×¤×¨: ${order.id}</h1>
                    <div class="info"><strong>×œ×§×•×—:</strong> ${order.customer?.name}</div>
                    <div class="info"><strong>×˜×œ×¤×•×Ÿ:</strong> ${order.customer?.phone}</div>
                    <div class="info"><strong>×›×ª×•×‘×ª:</strong> ${order.customer?.address || '××™×¡×•×£ ×¢×¦××™'}</div>
                    <div class="info"><strong>×ª××¨×™×š:</strong> ${order.date}</div>
                    <div class="items">
                        <strong>××•×¦×¨×™×:</strong>
                        ${(order.items || []).map(i => `<div class="item">${i.name} Ã— ${i.quantity} = â‚ª${i.price * i.quantity}</div>`).join('')}
                    </div>
                    <div class="total">×¡×”"×›: â‚ª${order.total}</div>
                    ${order.notes ? `<div class="info"><strong>×”×¢×¨×•×ª:</strong> ${order.notes}</div>` : ''}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Export orders to CSV
        function exportOrders() {
            const headers = ['××¡×¤×¨ ×”×–×× ×”', '×ª××¨×™×š', '×œ×§×•×—', '×˜×œ×¤×•×Ÿ', '××™××™×™×œ', '×›×ª×•×‘×ª', '××•×¦×¨×™×', '×¡×”"×›', '×¡×˜×˜×•×¡'];
            const rows = allOrders.map(o => [
                o.id,
                o.date,
                o.customer?.name || '',
                o.customer?.phone || '',
                o.customer?.email || '',
                o.customer?.address || '',
                (o.items || []).map(i => `${i.name}(${i.quantity})`).join('; '),
                o.total,
                getStatusText(o.status)
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('×”×§×•×‘×¥ ×”×•×¨×“ ×‘×”×¦×œ×—×”');
        }

        // Contact customer via WhatsApp
        function contactCustomer(phone) {
            if (!phone) {
                alert('×œ× × ××¦× ××¡×¤×¨ ×˜×œ×¤×•×Ÿ');
                return;
            }
            
            const cleanPhone = phone.replace(/[^0-9]/g, '');
            const israelPhone = cleanPhone.startsWith('0') ? '972' + cleanPhone.substring(1) : cleanPhone;
            window.open(`https://wa.me/${israelPhone}`, '_blank');
        }

        // Refresh data
        function refreshData() {
            loadOrders();
            showToast('×”× ×ª×•× ×™× ×¢×•×“×›× ×•');
        }

        // Go back to page
        function goBackToPage() {
            window.history.back();
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 no-print';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Auto-refresh every 60 seconds
        setInterval(refreshData, 60000);

        // Load orders on page load
        loadOrders();
    </script>
</body>
</html>




