<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPage Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .page-card {
            transition: all 0.3s ease;
        }
        .page-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .ai-bot-bubble {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .ai-bot-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        .ai-chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .ai-chat-window.active {
            display: flex;
        }
        
        .ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .ai-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .ai-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }
        
        .ai-message.bot {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }
        
        .ai-chat-input {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        .ai-chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .ai-chat-input button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
        }
        
        .typing-dots {
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0; }
            30% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Hero Header with Purple Background -->
    <div class="hero-gradient text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            <div class="text-center">
                <h1 class="text-4xl md:text-6xl font-bold mb-4">AutoPage Marketplace</h1>
                <p class="text-xl md:text-2xl mb-8 opacity-90">××¦× ××ª ×”×“×£ ×”××•×©×œ× ×©×œ×š</p>
                
                <!-- Search Bar -->
                <div class="max-w-2xl mx-auto mb-8">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="×—×¤×© ×“×¤×™×, ×¢×¡×§×™×, ×©×™×¨×•×ª×™×..." 
                               class="w-full px-6 py-4 text-gray-900 text-lg rounded-full focus:ring-4 focus:ring-white focus:ring-opacity-50 focus:outline-none">
                        <button onclick="searchPages()" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Create Page Button -->
                <div class="flex justify-center gap-4">
                    <button onclick="goToFullApp()" class="bg-white text-indigo-600 px-8 py-4 rounded-full font-bold text-lg hover:bg-gray-100 transition-all transform hover:scale-105 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        ×¦×•×¨ ×“×£ ×¢×›×©×™×•
                    </button>
                </div>
                
                <!-- View Toggle Buttons -->
                <div class="flex justify-center gap-2 mt-4">
                    <button id="grid-view-btn" onclick="setView('grid')" class="p-3 rounded-full bg-white bg-opacity-20 text-white hover:bg-opacity-30 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                        </svg>
                    </button>
                    <button id="table-view-btn" onclick="setView('table')" class="p-3 rounded-full bg-white bg-opacity-20 text-white hover:bg-opacity-30 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Buttons -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="filterByType('all')" class="px-6 py-3 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-all">×”×›×œ</button>
                <button onclick="filterByType('store')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-all">ğŸª ×—× ×•×™×•×ª</button>
                <button onclick="filterByType('event')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-all">ğŸ‰ ××™×¨×•×¢×™×</button>
                <button onclick="filterByType('course')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-all">ğŸ“ ×§×•×¨×¡×™×</button>
                <button onclick="filterByType('serviceProvider')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-all">ğŸ”§ ×‘×¢×œ×™ ××§×¦×•×¢</button>
            </div>
            <div class="text-center mt-4">
                <p id="pages-count" class="text-gray-600">×˜×•×¢×Ÿ ×“×¤×™×...</p>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
        <div class="text-lg text-gray-600">×˜×•×¢×Ÿ ×“×¤×™×...</div>
    </div>

    <!-- Pages Grid -->
    <div id="pages-grid" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Pages will be loaded here -->
    </div>
    
    <!-- Pages Table -->
    <div id="pages-table" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×ª××•× ×”</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×›×•×ª×¨×ª</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¡×•×’</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×ª×™××•×¨</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×ª××¨×™×š ×™×¦×™×¨×”</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Table rows will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- AI Search Bot -->
    <div class="ai-bot-bubble" onclick="toggleAIChat()" title="×¢×–×¨×” ×—×›××”">
        ğŸ¤–
    </div>

    <div class="ai-chat-window" id="aiChatWindow">
        <div class="ai-chat-header">
            <span>ğŸ¤– ×”×¢×•×–×¨×ª ×”×—×›××”</span>
            <button onclick="toggleAIChat()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message bot">
                ×©×œ×•×! ğŸ˜Š ××™×š ×× ×™ ×™×›×•×œ×” ×œ×¢×–×•×¨ ×œ×š?
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="aiChatInput" placeholder="×›×ª×•×‘ ×”×•×“×¢×”...">
            <button onclick="sendAIMessage()">×©×œ×—</button>
        </div>
    </div>

    <script>
        const AI_WEBHOOK = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
        
        function toggleAIChat() {
            const chatWindow = document.getElementById('aiChatWindow');
            chatWindow.classList.toggle('active');
            
            if (chatWindow.classList.contains('active')) {
                document.getElementById('aiChatInput').focus();
            }
        }
        
        function addAIMessage(message, isUser = false) {
            const messagesDiv = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${isUser ? 'user' : 'bot'}`;
            
            if (isUser) {
                messageDiv.textContent = message;
            } else {
                // Convert markdown-style links to clickable links
                let processedMessage = message.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea; text-decoration: underline;">$1</a>');
                
                // Fix image URLs to be absolute and add error handling
                processedMessage = processedMessage.replace(/src="([^"]+)"/g, (match, src) => {
                    let fullSrc = src;
                    if (src.startsWith('/')) {
                        fullSrc = `${window.location.origin}${src}`;
                    }
                    return `src="${fullSrc}" onerror="this.style.display='none'" onload="this.style.display='block'"`;
                });
                
                messageDiv.innerHTML = processedMessage;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const messagesDiv = document.getElementById('aiChatMessages');
            if (messagesDiv.lastChild && messagesDiv.lastChild.textContent.includes('××§×œ×™×“×”')) {
                messagesDiv.removeChild(messagesDiv.lastChild);
            }
        }
        
        // Global variables
        let allPages = [];
        let filteredPages = [];
        let currentType = 'all';
        let currentView = 'grid';
        
        // Load pages on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadPages();
        });
        
        // Search functionality
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPages();
            }
        });
        
        async function loadPages() {
            try {
                const response = await fetch('/api/public-pages');
                const data = await response.json();
                
                // Handle both array and object with pages property
                allPages = Array.isArray(data) ? data : (data.pages || []);
                filteredPages = [...allPages];
                
                console.log('Loaded pages:', allPages);
                console.log('Page types:', [...new Set(allPages.map(p => p.pageType))]);
                
                displayPages();
                updatePagesCount();
                
                // Hide loading state
                document.getElementById('loading-state').style.display = 'none';
            } catch (error) {
                console.error('Error loading pages:', error);
                document.getElementById('loading-state').innerHTML = `
                    <div class="text-red-500 text-lg">×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ×“×¤×™×. ×‘×“×§×™ ×©×”×©×¨×ª ×¨×¥ ×•×¢×“×›× ×™ ××ª ×”×“×¤×“×¤×Ÿ.</div>
                `;
            }
        }
        
        function filterByType(type) {
            currentType = type;
            
            // Update button styles
            document.querySelectorAll('button[onclick^="filterByType"]').forEach(btn => {
                btn.className = 'px-6 py-3 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-all';
            });
            event.target.className = 'px-6 py-3 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-all';
            
            console.log('Filtering by type:', type);
            console.log('All pages:', allPages);
            console.log('Page types found:', [...new Set(allPages.map(p => p.pageType))]);
            
            if (type === 'all') {
                filteredPages = [...allPages];
            } else {
                filteredPages = allPages.filter(page => {
                    console.log(`Page: ${page.title}, pageType: ${page.pageType}, matches: ${page.pageType === type}`);
                    return page.pageType === type;
                });
            }
            
            console.log('Filtered pages:', filteredPages);
            displayPages();
            updatePagesCount();
        }
        
        function searchPages() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredPages = [...allPages];
            } else {
                filteredPages = allPages.filter(page => 
                    page.title.toLowerCase().includes(searchTerm) ||
                    (page.description && page.description.toLowerCase().includes(searchTerm))
                );
            }
            
            displayPages();
            updatePagesCount();
        }
        
        function displayPages() {
            if (currentView === 'grid') {
                displayGrid();
            } else {
                displayTable();
            }
        }
        
        function displayGrid() {
            const grid = document.getElementById('pages-grid');
            const table = document.getElementById('pages-table');
            
            grid.classList.remove('hidden');
            table.classList.add('hidden');
            
            grid.innerHTML = '';
            
            if (filteredPages.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">×œ× × ××¦××• ×“×¤×™×</div>';
                return;
            }
            
            filteredPages.forEach(page => {
                const pageCard = createPageCard(page);
                grid.appendChild(pageCard);
            });
        }
        
        function displayTable() {
            const grid = document.getElementById('pages-grid');
            const table = document.getElementById('pages-table');
            const tbody = document.getElementById('table-body');
            
            grid.classList.add('hidden');
            table.classList.remove('hidden');
            
            tbody.innerHTML = '';
            
            if (filteredPages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">×œ× × ××¦××• ×“×¤×™×</td></tr>';
                return;
            }
            
            filteredPages.forEach(page => {
                const row = createTableRow(page);
                tbody.appendChild(row);
            });
        }
        
        function setView(view) {
            currentView = view;
            
            // Update button styles
            document.getElementById('grid-view-btn').className = view === 'grid' ? 
                'p-3 rounded-full bg-white bg-opacity-30 text-white hover:bg-opacity-40 transition-all' :
                'p-3 rounded-full bg-white bg-opacity-20 text-white hover:bg-opacity-30 transition-all';
            document.getElementById('table-view-btn').className = view === 'table' ? 
                'p-3 rounded-full bg-white bg-opacity-30 text-white hover:bg-opacity-40 transition-all' :
                'p-3 rounded-full bg-white bg-opacity-20 text-white hover:bg-opacity-30 transition-all';
            
            displayPages();
        }
        
        function createPageCard(page) {
            const card = document.createElement('div');
            card.className = 'page-card bg-white rounded-lg shadow-md overflow-hidden';
            
            const typeIcons = {
                'store': 'ğŸª',
                'event': 'ğŸ‰',
                'course': 'ğŸ“',
                'serviceProvider': 'ğŸ”§',
                'other': 'ğŸ“„'
            };
            
            const icon = typeIcons[page.pageType] || 'ğŸ“„';
            const typeName = getTypeName(page.pageType);
            
            // Fix image URL - convert relative paths to absolute
            let imageUrl = page.thumbnail || '';
            if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                imageUrl = `/output/${page.userId}/${imageUrl}`;
            }
            
            
            // Use /users/ route like in the main interface
            const pageUrl = `/users/${page.userId}/${page.pageId}_html`;
            
            // Try to find a screenshot image - only for courses
            const screenshotUrl = page.pageType === 'course' ? page.thumbnail : null;
            
            card.innerHTML = `
                <!-- ×ª×¦×•×’×” ××§×“×™××” ×©×œ ×”××ª×¨ -->
                <div class="relative rounded-t-xl overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100" style="height: 200px; flex-shrink: 0;">
                    ${screenshotUrl ? `
                        <!-- ×ª×¦×•×’×” ××§×“×™××” ×¢× ×ª××•× ×” -->
                        <img 
                            src="${screenshotUrl}" 
                            alt="${page.title}"
                            class="w-full h-full object-cover"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        />
                        <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 hidden items-center justify-center">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-white/90 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg border-2 border-indigo-200">
                                    <span class="text-2xl font-bold text-indigo-600">${icon}</span>
                                </div>
                                <div class="text-sm font-medium text-gray-700 bg-white/90 px-3 py-1 rounded-full shadow-sm border border-gray-200">
                                    ${typeName}
                                </div>
                            </div>
                        </div>
                    ` : `
                        <!-- ×ª×¦×•×’×” ××§×“×™××” ×¢× iframe -->
                        <div class="absolute inset-2 bg-white rounded-lg overflow-hidden shadow-lg border border-gray-300">
                            <iframe 
                                src="${window.location.origin}${pageUrl}" 
                                class="w-full h-full border-0"
                                style="pointer-events: none; transform: scale(0.6) translateX(65%); transform-origin: top left; width: 166.67%; height: 166.67%;"
                                title="×ª×¦×•×’×” ××§×“×™××” ×©×œ ${page.title}"
                                loading="lazy"
                                importance="low"
                                sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-downloads allow-modals allow-top-navigation allow-presentation">
                            </iframe>
                        </div>
                    `}
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">${page.title}</h3>
                    <p class="text-gray-600 mb-4">${page.description || '×œ×œ× ×ª×™××•×¨'}</p>
                    <div class="flex items-center justify-between">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                            ${icon} ${typeName}
                        </span>
                        <a href="/view/${page.userId}/${page.pageId}_html" target="_blank" 
                           class="text-indigo-600 hover:text-indigo-800 font-medium">
                            ×¦×¤×” ×‘×“×£ â†’
                        </a>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function createTableRow(page) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const typeIcons = {
                'store': 'ğŸª',
                'event': 'ğŸ‰',
                'course': 'ğŸ“',
                'serviceProvider': 'ğŸ”§',
                'other': 'ğŸ“„'
            };
            
            const icon = typeIcons[page.pageType] || 'ğŸ“„';
            const typeName = getTypeName(page.pageType);
            
            // Fix image URL
            let imageUrl = page.thumbnail || '';
            if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                imageUrl = `/output/${page.userId}/${imageUrl}`;
            }
            
            const createdDate = new Date(page.created_at).toLocaleDateString('he-IL');
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex-shrink-0 h-16 w-16">
                        ${pageUrl ? `
                            <div class="h-16 w-16 rounded-lg overflow-hidden border border-gray-300 bg-white">
                                <iframe 
                                    src="${window.location.origin}${pageUrl}" 
                                    class="w-full h-full border-0"
                                    style="pointer-events: none; transform: scale(0.3) translateX(100%); transform-origin: top left; width: 333.33%; height: 333.33%;"
                                    title="×ª×¦×•×’×” ××§×“×™××” ×©×œ ${page.title}"
                                    loading="lazy"
                                    importance="low"
                                    sandbox="allow-same-origin allow-scripts allow-popups allow-forms">
                                </iframe>
                            </div>
                        ` : `
                            <div class="h-16 w-16 rounded-lg bg-gray-200 flex items-center justify-center text-2xl">${icon}</div>
                        `}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${page.title}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                        ${icon} ${typeName}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-500 max-w-xs truncate">${page.description || '×œ×œ× ×ª×™××•×¨'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${createdDate}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="/view/${page.userId}/${page.pageId}_html" target="_blank" 
                       class="text-indigo-600 hover:text-indigo-900">
                        ×¦×¤×” ×‘×“×£
                    </a>
                </td>
            `;
            
            return row;
        }
        
        function getTypeName(type) {
            const names = {
                'store': '×—× ×•×ª',
                'event': '××™×¨×•×¢',
                'course': '×§×•×¨×¡',
                'serviceProvider': '×‘×¢×œ ××§×¦×•×¢',
                'other': '××—×¨'
            };
            return names[type] || '××—×¨';
        }
        
        function updatePagesCount() {
            const count = filteredPages.length;
            const total = allPages.length;
            document.getElementById('pages-count').textContent = 
                `××¦×™×’ ${count} ××ª×•×š ${total} ×“×¤×™×`;
        }
        
        
        // Smart search functionality - ENABLED for real page results
        async function handleSmartSearch(message) {
            const lowerMessage = message.toLowerCase();
            
            // Quick responses for greetings
            if (lowerMessage.includes('×©×œ×•×') || lowerMessage.includes('×”×™×™') || lowerMessage.includes('×”×™') || lowerMessage.includes('×”×™×™×™')) {
                return {
                    message: '×©×œ×•×! ğŸ˜Š ××™×š ×× ×™ ×™×›×•×œ×” ×œ×¢×–×•×¨ ×œ×š ×‘××¨×§×˜?',
                    action: { type: 'none' }
                };
            }
            
            // Quick responses for thanks
            if (lowerMessage.includes('×ª×•×“×”') || lowerMessage.includes('×ª×•×“×” ×¨×‘×”')) {
                return {
                    message: '×‘×›×™×£! ğŸ˜Š ×™×© ×¢×•×“ ××©×”×• ×©×× ×™ ×™×›×•×œ×” ×œ×¢×–×•×¨ ×œ×š?',
                    action: { type: 'none' }
                };
            }
            
            // Check for specific keywords and search
            const keywords = {
                '×œ×§': 'serviceProvider',
                '×× ×™×§×•×¨': 'serviceProvider', 
                '×¤×“×™×§×•×¨': 'serviceProvider',
                '×¦×¢×¦×•×¢': 'store',
                '×™×œ×“': 'store',
                '×—× ×•×ª': 'store',
                '×§×•×¨×¡': 'course',
                '×œ×™××•×“': 'course',
                '××™×¨×•×¢': 'event',
                '×—×ª×•× ×”': 'event'
            };
            
            for (const [keyword, type] of Object.entries(keywords)) {
                if (lowerMessage.includes(keyword)) {
                    const matchingPages = allPages.filter(page => page.pageType === type);
                    
                    if (matchingPages.length > 0) {
                        let response = `××¦××ª×™ ${matchingPages.length} ×“×¤×™× ×¨×œ×•×•× ×˜×™×™×:\n\n`;
                        
                        matchingPages.slice(0, 3).forEach(page => {
                            const pageUrl = `/users/${page.userId}/${page.pageId}_html`;
                            // Use real page preview with iframe
                            const emoji = page.pageType === 'store' ? 'ğŸª' : page.pageType === 'event' ? 'ğŸ‰' : page.pageType === 'course' ? 'ğŸ“' : page.pageType === 'serviceProvider' ? 'ğŸ”§' : 'ğŸ“„';
                            response += `â€¢ **${page.title}** ${emoji}\n`;
                            response += `  [ğŸ‘ï¸ ×¦×¤×” ×‘×“×£](${pageUrl})\n`;
                            response += `  <div style="margin: 8px 0; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: fadeInUp 0.6s ease-out, pulse 2s infinite; position: relative; width: 100%; height: 200px;">`;
                            response += `    <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c); animation: shimmer 2s infinite;"></div>`;
                            response += `    <iframe src="${pageUrl}" style="width: 200%; height: 400px; border: none; transform: scale(0.5); transform-origin: top left; transition: all 0.3s ease; position: absolute; top: 0; left: 0;" sandbox="allow-same-origin allow-scripts allow-popups allow-forms" onload="this.style.opacity='1';" onerror="this.style.display='none'"></iframe>`;
                            response += `  </div>\n\n`;
                        });
                        
                        if (matchingPages.length > 3) {
                            response += `×•×¢×•×“ ${matchingPages.length - 3} ×“×¤×™×...`;
                        }
                        
                        return {
                            message: response,
                            action: { type: 'change_category_and_highlight', category: type, highlight_pages: matchingPages.slice(0, 3).map(p => p.pageId) }
                        };
                    }
                }
            }
            
            // Search by title
            const matchingPages = allPages.filter(page => 
                page.title.toLowerCase().includes(lowerMessage)
            );
            
            if (matchingPages.length > 0) {
                let response = `××¦××ª×™ ${matchingPages.length} ×“×¤×™× ×¢× "${message}":\n\n`;
                
                matchingPages.slice(0, 3).forEach(page => {
                    const pageUrl = `/users/${page.userId}/${page.pageId}_html`;
                    // Use real page preview with iframe
                    const emoji = page.pageType === 'store' ? 'ğŸª' : page.pageType === 'event' ? 'ğŸ‰' : page.pageType === 'course' ? 'ğŸ“' : page.pageType === 'serviceProvider' ? 'ğŸ”§' : 'ğŸ“„';
                    response += `â€¢ **${page.title}** ${emoji}\n`;
                    response += `  [ğŸ‘ï¸ ×¦×¤×” ×‘×“×£](${pageUrl})\n`;
                    response += `  <div style="margin: 8px 0; border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: fadeInUp 0.6s ease-out, pulse 2s infinite; position: relative; width: 100%; height: 200px;">`;
                    response += `    <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c); animation: shimmer 2s infinite;"></div>`;
                    response += `    <iframe src="${pageUrl}" style="width: 200%; height: 400px; border: none; transform: scale(0.5); transform-origin: top left; transition: all 0.3s ease; position: absolute; top: 0; left: 0;" sandbox="allow-same-origin allow-scripts allow-popups allow-forms" onload="this.style.opacity='1';" onerror="this.style.display='none'"></iframe>`;
                    response += `  </div>\n\n`;
                });
                
                if (matchingPages.length > 3) {
                    response += `×•×¢×•×“ ${matchingPages.length - 3} ×“×¤×™×...`;
                }
                
                return {
                    message: response,
                    action: { type: 'change_category_and_highlight', category: matchingPages[0].pageType, highlight_pages: matchingPages.slice(0, 3).map(p => p.pageId) }
                };
            }
            
            return null; // No quick response, send to N8N
        }
        
        
        // Enhanced sendAIMessage with smart search
        async function sendAIMessageEnhanced() {
            try {
                const input = document.getElementById('aiChatInput');
                const userMessage = input.value.trim();
                
                if (!userMessage) return;
                
                // Display user message
                addAIMessage(userMessage, true);
                input.value = '';
                
                // Show typing indicator
                addAIMessage('ğŸ¤– ×¡×ª×™×• ××§×œ×™×“×”<span class="typing-dots">...</span>', false);
                
                // Make sure we have pages loaded
                if (allPages.length === 0) {
                    await loadPages();
                }
                
                // Try smart search first for real page results
                const smartResult = await handleSmartSearch(userMessage);
                if (smartResult) {
                    // Remove typing indicator
                    removeTypingIndicator();
                    
                    // Display smart search result
                    addAIMessage(smartResult.message, false);
                    
                    // Execute action if any
                    if (smartResult.action && smartResult.action.type !== 'none') {
                        await executeAction(smartResult.action);
                    }
                    
                    return; // Don't send to N8N
                }
                
                // If no smart search result, send to N8N
                
                // Continue with original AI logic...
                const allPagesContext = allPages.map(page => ({
                    title: page.title,
                    description: page.description,
                    pageType: page.pageType,
                    userId: page.userId,
                    pageId: page.pageId
                }));
                
                // Send to N8N with enhanced context
                const response = await fetch(AI_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_message: userMessage,
                        pageContent: {
                            pages: allPagesContext
                        },
                        contextText: `××ª×” ×¡×ª×™×•, ×¢×•×–×¨×ª ×—×›××” ×‘××¨×§×˜×¤×œ×™×™×¡. ××ª×” ×™×›×•×œ×” ×œ×¢× ×•×ª ×¢×œ ×›×œ ×©××œ×” - ×‘×¨×›×•×ª, ×©××œ×•×ª ×›×œ×œ×™×•×ª, ×•×’× ×œ×¢×–×•×¨ ×œ××¦×•× ×“×¤×™× ×‘××¨×§×˜. ×× ××™×©×”×• ××•××¨ "×”×™×™" ××• "×©×œ×•×" - ×¢× ×” ×‘×‘×¨×›×” ×™×“×™×“×•×ª×™×ª. ×× ××™×©×”×• ××—×¤×© ××©×”×• ×‘××¨×§×˜ - ×—×¤×© ×‘×“×¤×™× ×”×–××™× ×™×.`,
                        businessText: `Business: AutoPage Marketplace\nPhone: N/A\nEmail: N/A\nAddress: N/A`,
                        page_type: "marketplace"
                    })
                });
                
                // Check response and get data
                if (!response.ok) {
                    throw new Error('×©×’×™××ª ×ª×§×©×•×¨×ª');
                }
                
                const data = await response.json();
                console.log('ğŸ¤– Bot response:', data);
                
                // Remove typing indicator immediately
                removeTypingIndicator();
                
                // Extract message from response
                let botMessage = data.message || data.output || '×¡×œ×™×—×”, ×œ× ×”×‘× ×ª×™...';
                
                // Handle nested JSON response
                if (typeof botMessage === 'string' && botMessage.startsWith('{')) {
                    try {
                        const parsedMessage = JSON.parse(botMessage);
                        botMessage = parsedMessage.message || botMessage;
                    } catch (e) {
                        // Keep original message if parsing fails
                    }
                }
                
                if (typeof botMessage === 'object') {
                    botMessage = botMessage.message || JSON.stringify(botMessage);
                }
                
                // Display bot response
                addAIMessage(botMessage, false);
                
                // Handle actions
                if (data.action === 'change_category' && data.category) {
                    await executeAction({ type: 'change_category', category: data.category });
                } else if (data.action === 'scroll_to_page' && data.page_id) {
                    await executeAction({ type: 'scroll_to_page', page_id: data.page_id });
                } else if (data.action === 'show_page' && data.page_id) {
                    // Open page in new tab
                    const page = allPages.find(p => p.pageId === data.page_id);
                    if (page) {
                        const pageUrl = `/users/${page.userId}/${page.pageId}_html`;
                        window.open(pageUrl, '_blank');
                    }
                } else {
                    console.log('â„¹ï¸ No action to perform or action is "none"');
                }
            } catch (error) {
                console.error('âŒ Error in sendAIMessage:', error);
                // Remove typing indicator
                removeTypingIndicator();
                addAIMessage('×¡×œ×™×—×”, ×§×¨×ª×” ×©×’×™××”. × ×¡×” ×©×•×‘!', false);
            }
        }
        
        // Execute actions
        async function executeAction(action) {
            if (action.type === 'change_category') {
                console.log('ğŸ·ï¸ Changing to category:', action.category);
                
                // Map category names
                const categoryMap = {
                    'store': 'store',
                    'stores': 'store',
                    '×—× ×•×ª': 'store',
                    '×—× ×•×™×•×ª': 'store',
                    'event': 'event',
                    'events': 'event',
                    '××™×¨×•×¢': 'event',
                    '××™×¨×•×¢×™×': 'event',
                    'course': 'course',
                    'courses': 'course',
                    '×§×•×¨×¡': 'course',
                    '×§×•×¨×¡×™×': 'course',
                    'serviceProvider': 'serviceProvider',
                    'service': 'serviceProvider',
                    '×‘×¢×œ×™ ××§×¦×•×¢': 'serviceProvider',
                    'all': 'all',
                    '×”×›×œ': 'all'
                };
                
                const mappedCategory = categoryMap[action.category.toLowerCase()] || action.category;
                console.log('ğŸ“‚ Mapped category:', mappedCategory);
                
                // Update UI buttons - use the existing filterByType function
                filterByType(mappedCategory);
                
                // Scroll to top to see results
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    console.log('âœ… Category changed to:', mappedCategory);
                    console.log('ğŸ“Š New filteredPages length:', filteredPages.length);
                    
                    // Show success message
                    addAIMessage(`âœ… ×¢×‘×¨×ª×™ ×œ×§×˜×’×•×¨×™×™×ª ${getTypeName(mappedCategory)}! ××¦× ${filteredPages.length} ×“×¤×™×.`, false);
                }, 100);
            } else if (action.type === 'change_category_and_highlight') {
                console.log('ğŸ·ï¸ Changing to category and highlighting pages:', action.category, action.highlight_pages);
                
                // Map category names
                const categoryMap = {
                    'store': 'store',
                    'stores': 'store',
                    '×—× ×•×ª': 'store',
                    '×—× ×•×™×•×ª': 'store',
                    'event': 'event',
                    'events': 'event',
                    '××™×¨×•×¢': 'event',
                    '××™×¨×•×¢×™×': 'event',
                    'course': 'course',
                    'courses': 'course',
                    '×§×•×¨×¡': 'course',
                    '×§×•×¨×¡×™×': 'course',
                    'serviceProvider': 'serviceProvider',
                    'service': 'serviceProvider',
                    '×‘×¢×œ×™ ××§×¦×•×¢': 'serviceProvider',
                    'all': 'all',
                    '×”×›×œ': 'all'
                };
                
                const mappedCategory = categoryMap[action.category.toLowerCase()] || action.category;
                console.log('ğŸ“‚ Mapped category:', mappedCategory);
                
                // Update UI buttons - use the existing filterByType function
                filterByType(mappedCategory);
                
                // Scroll to top and highlight pages
                setTimeout(() => {
                    // Highlight matching pages first
                    if (action.highlight_pages && action.highlight_pages.length > 0) {
                        action.highlight_pages.forEach((pageId, index) => {
                            const pageCard = document.querySelector(`[data-page-id="${pageId}"]`);
                            if (pageCard) {
                                pageCard.style.outline = '3px solid #667eea';
                                pageCard.style.transform = 'scale(1.05)';
                                pageCard.style.transition = 'all 0.3s ease';
                                pageCard.style.boxShadow = '0 10px 25px rgba(102, 126, 234, 0.3)';
                                
                                // Scroll to first highlighted page with delay
                                if (index === 0) {
                                    setTimeout(() => {
                                        pageCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }, 200);
                                }
                                
                                setTimeout(() => {
                                    pageCard.style.outline = '';
                                    pageCard.style.transform = '';
                                    pageCard.style.boxShadow = '';
                                }, 5000);
                            }
                        });
                    }
                    
                    console.log('âœ… Category changed to:', mappedCategory);
                    console.log('ğŸ“Š New filteredPages length:', filteredPages.length);
                    
                    // Show success message
                    addAIMessage(`âœ… ×¢×‘×¨×ª×™ ×œ×§×˜×’×•×¨×™×™×ª ${getTypeName(mappedCategory)}! ××¦× ${filteredPages.length} ×“×¤×™×.`, false);
                }, 100);
            } else if (action.type === 'scroll_to_page' && action.page_id) {
                console.log('ğŸ” Looking for page card with ID:', action.page_id);
                
                // Find the page card and scroll to it
                setTimeout(() => {
                    const pageCard = document.querySelector(`[data-page-id="${action.page_id}"]`);
                    if (pageCard) {
                        pageCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        pageCard.style.outline = '3px solid #667eea';
                        pageCard.style.transform = 'scale(1.05)';
                        pageCard.style.transition = 'all 0.3s ease';
                        pageCard.style.boxShadow = '0 10px 25px rgba(102, 126, 234, 0.3)';
                        
                        setTimeout(() => {
                            pageCard.style.outline = '';
                            pageCard.style.transform = '';
                            pageCard.style.boxShadow = '';
                        }, 3000);
                    } else {
                        console.error('âŒ Page card not found for:', action.page_id);
                        addAIMessage('ğŸ” ××¦××ª×™ ××ª ×”×“×£ ××‘×œ ×œ× ×”×¦×œ×—×ª×™ ×œ×’×œ×•×œ ××œ×™×•. ×—×¤×© ××•×ª×• ×‘×¨×©×™××” ×œ××¢×œ×”!', false);
                    }
                }, 500);
            } else if (action.type === 'show_page' && action.page_id) {
                // Open page in new tab
                const page = allPages.find(p => p.pageId === action.page_id);
                if (page) {
                    const pageUrl = `/users/${page.userId}/${page.pageId}_html`;
                    window.open(pageUrl, '_blank');
                }
            }
        }
        
        // Function to extract prices from page content
        async function extractPricesFromPage(page) {
            try {
                const pageUrl = `/users/${page.userId}/${page.pageId}_html`;
                const response = await fetch(pageUrl);
                if (!response.ok) return null;
                
                const htmlContent = await response.text();
                const priceRegex = /â‚ª\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/g;
                const prices = [];
                let match;
                
                while ((match = priceRegex.exec(htmlContent)) !== null) {
                    prices.push(match[0]);
                }
                
                return prices.length > 0 ? prices : null;
            } catch (error) {
                console.error('Error extracting prices:', error);
                return null;
            }
        }
        
        // Enhanced search with price information - DISABLED, everything goes to N8N
        async function searchWithPrices(message) {
            // Everything goes to N8N now
            return null;
        }
        
        // Fix the filterByCategory function
        function filterByCategory(category) {
            currentType = category;
            
            if (category === 'all') {
                filteredPages = [...allPages];
            } else {
                filteredPages = allPages.filter(page => page.pageType === category);
            }
            
            displayPages();
            updatePagesCount();
        }
        
        // Replace the original sendAIMessage with enhanced version
        window.sendAIMessage = sendAIMessageEnhanced;
        
        // Allow Enter key in chat input
        document.getElementById('aiChatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAIMessage();
            }
        });
        
        // Go to full app function
        function goToFullApp() {
            window.location.href = '/';
        }
    </script>
</body>
</html>