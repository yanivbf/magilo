<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPage - גלה דפים מדהימים</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rubik', sans-serif;
        }
        
        /* AI Search Bot Bubble */
        .ai-bot-bubble {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            font-size: 32px;
        }
        
        .ai-bot-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
        }
        
        .ai-bot-bubble:active {
            transform: scale(0.95);
        }
        
        /* AI Chat Window */
        .ai-chat-window {
            position: fixed;
            bottom: 120px;
            left: 30px;
            width: 400px;
            max-width: calc(100vw - 60px);
            height: 500px;
            max-height: calc(100vh - 180px);
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
        }
        
        .ai-chat-window.active {
            display: flex;
        }
        
        .ai-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .ai-message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .ai-message.user {
            background: #667eea;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .ai-message.bot {
            background: #f3f4f6;
            color: #1f2937;
            align-self: flex-start;
        }
        
        .ai-chat-input-area {
            padding: 15px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }
        
        .ai-chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            outline: none;
            font-family: 'Rubik', sans-serif;
        }
        
        .ai-chat-input:focus {
            border-color: #667eea;
        }
        
        .ai-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .ai-send-btn:hover {
            transform: scale(1.05);
        }
        
        .ai-send-btn:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 640px) {
            .ai-bot-bubble {
                width: 60px;
                height: 60px;
                bottom: 20px;
                left: 20px;
                font-size: 28px;
            }
            
            .ai-chat-window {
                bottom: 100px;
                left: 20px;
                width: calc(100vw - 40px);
            }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            transition: all 0.3s ease, outline 0s, transform 0.3s;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        .category-badge {
            transition: all 0.2s ease;
        }
        .category-badge:hover {
            transform: scale(1.05);
        }
        .search-bar {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Hero Section -->
    <div class="gradient-bg text-white py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-6">AutoPage</h1>
            <p class="text-xl md:text-2xl mb-8 text-purple-100">גלה דפים מדהימים, חנויות ושירותים</p>
            
            <!-- Create Page Button -->
            <div class="mb-6">
                <a href="/" class="inline-flex items-center gap-3 bg-white text-purple-600 px-8 py-4 rounded-full font-bold text-lg hover:bg-purple-50 transition-all transform hover:scale-105 shadow-2xl">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>צור דף משלך עכשיו</span>
                </a>
            </div>
            
            <!-- Search Bar -->
            <div class="max-w-3xl mx-auto search-bar rounded-full shadow-2xl p-2 flex items-center">
                <button onclick="searchPages()" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-full font-semibold transition">
                    חפש
                </button>
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="חפש חנויות, שירותים, אירועים..." 
                    class="flex-1 px-6 py-3 rounded-full text-gray-800 focus:outline-none text-lg"
                />
            </div>
        </div>
    </div>

    <!-- Category Filters -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-8 mb-12">
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">סינון לפי קטגוריה</h3>
            <div class="flex flex-wrap gap-3" id="category-filters">
                <button onclick="filterByCategory('all')" class="category-badge px-6 py-2 rounded-full bg-purple-600 text-white font-medium shadow-md" data-category="all">
                    🌐 כל הדפים
                </button>
                <button onclick="filterByCategory('store')" class="category-badge px-6 py-2 rounded-full bg-white text-gray-700 border-2 border-gray-200 font-medium hover:border-purple-400" data-category="store">
                    🛍️ חנויות
                </button>
                <button onclick="filterByCategory('serviceProvider')" class="category-badge px-6 py-2 rounded-full bg-white text-gray-700 border-2 border-gray-200 font-medium hover:border-purple-400" data-category="serviceProvider">
                    🔧 בעלי מקצוע
                </button>
                <button onclick="filterByCategory('course')" class="category-badge px-6 py-2 rounded-full bg-white text-gray-700 border-2 border-gray-200 font-medium hover:border-purple-400" data-category="course">
                    📚 קורסים
                </button>
                <button onclick="filterByCategory('landing')" class="category-badge px-6 py-2 rounded-full bg-white text-gray-700 border-2 border-gray-200 font-medium hover:border-purple-400" data-category="landing">
                    🚀 דפי נחיתה
                </button>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-20">
        <div class="mb-6 flex items-center justify-between">
            <h2 class="text-2xl font-bold text-gray-800">
                <span id="results-count">Loading...</span>
            </h2>
            <div class="flex items-center gap-2">
                <button onclick="changeView('grid')" id="grid-view-btn" class="p-2 rounded-lg bg-purple-600 text-white">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                    </svg>
                </button>
                <button onclick="changeView('list')" id="list-view-btn" class="p-2 rounded-lg bg-gray-200 text-gray-600">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Pages Grid -->
        <div id="pages-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Pages will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20">
            <div class="text-gray-400 text-6xl mb-4">🔍</div>
            <h3 class="text-2xl font-semibold text-gray-700 mb-2">לא נמצאו דפים</h3>
            <p class="text-gray-500">נסה לשנות את הסינון או מילת החיפוש</p>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-600 border-t-transparent"></div>
            <p class="mt-4 text-gray-600">טוען דפים מדהימים...</p>
        </div>
    </div>

    <script>
        let allPages = [];
        let filteredPages = [];
        let currentCategory = 'all';
        let currentView = 'grid';

        // Load pages on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadPages();
        });

        // Search on Enter key
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPages();
            }
        });

        async function loadPages() {
            try {
                const response = await fetch('/api/public-pages');
                const data = await response.json();
                
                allPages = data.pages || [];
                filteredPages = allPages;
                
                displayPages();
                updateResultsCount();
            } catch (error) {
                console.error('Error loading pages:', error);
                document.getElementById('loading-state').innerHTML = `
                    <div class="text-red-500 text-lg">Failed to load pages. Please try again later.</div>
                `;
            }
        }

        function filterByCategory(category) {
            currentCategory = category;
            
            // Update active button
            document.querySelectorAll('.category-badge').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.className = 'category-badge px-6 py-2 rounded-full bg-purple-600 text-white font-medium shadow-md';
                } else {
                    btn.className = 'category-badge px-6 py-2 rounded-full bg-white text-gray-700 border-2 border-gray-200 font-medium hover:border-purple-400';
                }
            });
            
            // Filter pages
            if (category === 'all') {
                filteredPages = allPages;
            } else {
                filteredPages = allPages.filter(page => page.pageType === category || page.pageType === category + 'Page');
            }
            
            // Apply search if active
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (searchTerm) {
                filteredPages = filteredPages.filter(page => 
                    page.title.toLowerCase().includes(searchTerm) ||
                    (page.description && page.description.toLowerCase().includes(searchTerm))
                );
            }
            
            displayPages();
            updateResultsCount();
        }

        function searchPages() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            // Start with category filter
            if (currentCategory === 'all') {
                filteredPages = allPages;
            } else {
                filteredPages = allPages.filter(page => page.pageType === currentCategory);
            }
            
            // Apply search filter
            if (searchTerm) {
                filteredPages = filteredPages.filter(page => 
                    page.title.toLowerCase().includes(searchTerm) ||
                    (page.description && page.description.toLowerCase().includes(searchTerm)) ||
                    (page.tags && page.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                );
            }
            
            displayPages();
            updateResultsCount();
        }

        function displayPages() {
            const grid = document.getElementById('pages-grid');
            const loading = document.getElementById('loading-state');
            const empty = document.getElementById('empty-state');
            
            loading.classList.add('hidden');
            
            if (filteredPages.length === 0) {
                grid.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            
            grid.classList.remove('hidden');
            empty.classList.add('hidden');
            
            if (currentView === 'grid') {
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';
                grid.innerHTML = filteredPages.map(page => createPageCard(page)).join('');
            } else {
                grid.className = 'space-y-4';
                grid.innerHTML = filteredPages.map(page => createPageListItem(page)).join('');
            }
        }

        function createPageCard(page) {
            const categoryIcons = {
                store: '🛍️',
                serviceProvider: '🔧',
                event: '🎉',
                course: '📚',
                landing: '🚀',
                portfolio: '💼',
                businessCard: '📇'
            };
            
            const icon = categoryIcons[page.pageType] || '📄';
            const categoryName = getCategoryName(page.pageType);
            
            // Determine image source
            const imageHtml = page.thumbnail 
                ? `<img src="${page.thumbnail}" alt="${escapeHtml(page.title)}" class="w-full h-48 object-cover">`
                : `<div class="h-48 bg-gradient-to-br from-purple-400 to-indigo-600 flex items-center justify-center text-white text-6xl">
                        ${icon}
                   </div>`;
            
            return `
                <div class="card bg-white rounded-2xl shadow-lg overflow-hidden" data-page-id="${page.pageId}" data-user-id="${page.userId}">
                    ${imageHtml}
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-3">
                            <span class="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-semibold rounded-full">
                                ${categoryName}
                            </span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2 line-clamp-1">
                            ${escapeHtml(page.title)}
                        </h3>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                            ${escapeHtml(page.description || 'לחץ כדי לחקור דף מדהים זה')}
                        </p>
                        <a href="/pages/${page.userId}/${page.pageId}" 
                           target="_blank"
                           class="block w-full bg-purple-600 hover:bg-purple-700 text-white text-center py-3 rounded-lg font-semibold transition">
                            בקר בדף ←
                        </a>
                    </div>
                </div>
            `;
        }

        function createPageListItem(page) {
            const categoryIcons = {
                store: '🛍️',
                serviceProvider: '🔧',
                event: '🎉',
                course: '📚',
                landing: '🚀'
            };
            
            const icon = categoryIcons[page.pageType] || '📄';
            const categoryName = getCategoryName(page.pageType);
            
            // Determine image source for list view
            const listImageHtml = page.thumbnail 
                ? `<img src="${page.thumbnail}" alt="${escapeHtml(page.title)}" class="w-20 h-20 rounded-xl object-cover flex-shrink-0">`
                : `<div class="w-20 h-20 bg-gradient-to-br from-purple-400 to-indigo-600 rounded-xl flex items-center justify-center text-white text-3xl flex-shrink-0">
                        ${icon}
                   </div>`;
            
            return `
                <div class="card bg-white rounded-xl shadow-md p-6 flex items-center gap-6" data-page-id="${page.pageId}" data-user-id="${page.userId}">
                    ${listImageHtml}
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-lg font-bold text-gray-800 truncate">
                                ${escapeHtml(page.title)}
                            </h3>
                            <span class="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-semibold rounded-full flex-shrink-0">
                                ${categoryName}
                            </span>
                        </div>
                        <p class="text-gray-600 text-sm line-clamp-1">
                            ${escapeHtml(page.description || 'Click to explore this amazing page')}
                        </p>
                    </div>
                    <a href="/pages/${page.userId}/${page.pageId}" 
                       target="_blank"
                       class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition flex-shrink-0">
                        Visit →
                    </a>
                </div>
            `;
        }

        function getCategoryName(type) {
            const names = {
                store: 'Store',
                onlineStore: 'Store',
                serviceProvider: 'Service',
                event: 'Event',
                course: 'Course',
                landing: 'Landing Page',
                portfolio: 'Portfolio',
                businessCard: 'Business Card'
            };
            return names[type] || 'Page';
        }

        function changeView(view) {
            currentView = view;
            
            // Update buttons
            if (view === 'grid') {
                document.getElementById('grid-view-btn').className = 'p-2 rounded-lg bg-purple-600 text-white';
                document.getElementById('list-view-btn').className = 'p-2 rounded-lg bg-gray-200 text-gray-600';
            } else {
                document.getElementById('grid-view-btn').className = 'p-2 rounded-lg bg-gray-200 text-gray-600';
                document.getElementById('list-view-btn').className = 'p-2 rounded-lg bg-purple-600 text-white';
            }
            
            displayPages();
        }

        function updateResultsCount() {
            const count = filteredPages.length;
            const total = allPages.length;
            document.getElementById('results-count').textContent = 
                currentCategory === 'all' 
                    ? `All Pages (${total})` 
                    : `${count} ${count === 1 ? 'Page' : 'Pages'} Found`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    <!-- AI Search Bot -->
    <div class="ai-bot-bubble" onclick="toggleAIChat()" title="עזרה חכמה">
        🤖
    </div>

    <div class="ai-chat-window" id="aiChatWindow">
        <div class="ai-chat-header">
            <span>🤖 עוזר החיפוש החכם</span>
            <button onclick="toggleAIChat()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message bot">
                היי! 👋 אני כאן לעזור לך למצוא בדיוק מה שאתה מחפש במרקטפלייס!<br><br>
                🔍 <strong>אני יכול לחפש לפי:</strong><br>
                • <strong>מיקום:</strong> "נגר בנתניה", "ספר בתל אביב"<br>
                • <strong>מקצוע:</strong> "חשמלאי", "אינסטלטור", "מאמן כושר"<br>
                • <strong>קטגוריה:</strong> "חנויות", "בעלי מקצוע", "קורסים"<br>
                • <strong>חיפוש כללי:</strong> "אני רוצה לקנות שוקולד"<br><br>
                💡 <strong>דוגמה:</strong> "אני מחפש נגר בנתניה" או "ספר בנתניה"
            </div>
        </div>
        <div class="ai-chat-input-area">
            <input type="text" class="ai-chat-input" id="aiChatInput" placeholder="מה אתה מחפש?" onkeypress="if(event.key==='Enter') sendAIMessage()">
            <button class="ai-send-btn" onclick="sendAIMessage()">שלח</button>
        </div>
    </div>

    <script>
        const AI_WEBHOOK = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg';
        
        function toggleAIChat() {
            const chatWindow = document.getElementById('aiChatWindow');
            chatWindow.classList.toggle('active');
            
            if (chatWindow.classList.contains('active')) {
                document.getElementById('aiChatInput').focus();
            }
        }
        
        function addAIMessage(message, isUser = false) {
            const messagesDiv = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${isUser ? 'user' : 'bot'}`;
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function getProfessionSynonyms(profession) {
            const synonymMap = {
                'נגר': ['מסגר', 'עובד עץ', 'בנאי', 'פועל'],
                'חשמלאי': ['חשמל', 'חשמלאות'],
                'אינסטלטור': ['שרברב', 'אינסטלציה', 'מים'],
                'ספר': ['תספורת', 'מספרה', 'ספרות'],
                'קוסמטיקאית': ['יופי', 'קוסמטיקה', 'טיפוח'],
                'מאמן': ['אימון', 'כושר', 'ספורט'],
                'רופא': ['רפואה', 'בריאות', 'טיפול'],
                'מעצב': ['עיצוב', 'דיזיין'],
                'אדריכל': ['אדריכלות', 'בנייה', 'תכנון'],
                'מהנדס': ['הנדסה', 'תכנון'],
                'עורך דין': ['משפטים', 'עורך דין', 'עו"ד'],
                'רואה חשבון': ['חשבונאות', 'כספים'],
                'יועץ': ['ייעוץ', 'עצה'],
                'מטפל': ['טיפול', 'בריאות'],
                'פסיכולוג': ['פסיכולוגיה', 'נפש'],
                'יועץ זוגי': ['זוגיות', 'נישואים'],
                'מנקה': ['ניקיון', 'ניקוי'],
                'גנן': ['גינון', 'גינה'],
                'צלם': ['צילום', 'תמונות'],
                'מוזיקאי': ['מוזיקה', 'נגינה'],
                'שף': ['בישול', 'מטבח'],
                'טבח': ['בישול', 'מטבח'],
                'מלצר': ['מסעדה', 'שירות'],
                'נהג': ['נסיעה', 'הובלה'],
                'שליח': ['משלוח', 'הובלה'],
                'מאבטח': ['אבטחה', 'שמירה'],
                'פארמקיסט': ['רוקח', 'תרופות'],
                'אחות': ['סיעוד', 'בריאות'],
                'פיזיותרפיסט': ['פיזיותרפיה', 'שיקום']
            };
            
            return synonymMap[profession] || [];
        }
        
        function performSmartSearch(location, profession, originalMessage) {
            console.log('🔍 Performing smart search:', { location, profession, originalMessage });
            
            // Filter pages based on location and profession
            let matchingPages = allPages.filter(page => {
                const titleLower = page.title.toLowerCase();
                const descLower = (page.description || '').toLowerCase();
                
                let matches = false;
                
                // Check profession match (including synonyms)
                if (profession) {
                    const professionLower = profession.toLowerCase();
                    const synonyms = getProfessionSynonyms(professionLower);
                    
                    if (titleLower.includes(professionLower) || descLower.includes(professionLower)) {
                        matches = true;
                    } else {
                        // Check synonyms
                        for (const synonym of synonyms) {
                            if (titleLower.includes(synonym) || descLower.includes(synonym)) {
                                matches = true;
                                break;
                            }
                        }
                    }
                }
                
                // Check location match
                if (location) {
                    const locationLower = location.toLowerCase();
                    if (titleLower.includes(locationLower) || descLower.includes(locationLower)) {
                        matches = true;
                    }
                }
                
                return matches;
            });
            
            console.log('📋 Found matching pages:', matchingPages.length);
            
            if (matchingPages.length > 0) {
                // Show results
                let message = `🔍 מצאתי ${matchingPages.length} תוצאות עבור החיפוש שלך:<br><br>`;
                
                matchingPages.slice(0, 5).forEach((page, index) => {
                    message += `${index + 1}. <strong>${page.title}</strong> (${getCategoryName(page.pageType)})<br>`;
                    if (page.description) {
                        message += `   ${page.description.substring(0, 100)}...<br>`;
                    }
                    message += `<br>`;
                });
                
                if (matchingPages.length > 5) {
                    message += `ועוד ${matchingPages.length - 5} תוצאות...<br><br>`;
                }
                
                message += `💡 <strong>טיפ:</strong> לחץ על "הכל" למעלה כדי לראות את כל התוצאות, או צמצם את החיפוש למילים ספציפיות יותר.`;
                
                addAIMessage(message, false);
                
                // Also update the search box and filter
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = originalMessage;
                    searchPages();
                }
                
                // Filter to serviceProvider category if searching for professions
                if (profession && !location) {
                    filterByCategory('serviceProvider');
                }
                
            } else {
                // No results found
                let message = `😔 לא מצאתי תוצאות עבור "${originalMessage}"<br><br>`;
                
                if (profession && location) {
                    message += `💡 <strong>נסה:</strong><br>`;
                    message += `• לחפש רק "${profession}" (ללא מיקום)<br>`;
                    message += `• לחפש רק "${location}" (ללא מקצוע)<br>`;
                    message += `• לחפש מילים נרדפות (למשל: "מסגר" במקום "נגר")<br>`;
                } else if (profession) {
                    message += `💡 <strong>נסה:</strong><br>`;
                    message += `• מילים נרדפות: "מסגר", "עובד עץ", "בנאי"<br>`;
                    message += `• חיפוש כללי: "בעלי מקצוע"<br>`;
                } else if (location) {
                    message += `💡 <strong>נסה:</strong><br>`;
                    message += `• חיפוש כללי: "בעלי מקצוע"<br>`;
                    message += `• חיפוש לפי קטגוריה: לחץ על "בעלי מקצוע" למעלה<br>`;
                }
                
                message += `<br>📞 <strong>אלטרנטיבה:</strong> צור קשר ישירות עם בעלי מקצוע באזור שלך דרך הדפים הקיימים.`;
                
                addAIMessage(message, false);
            }
        }
        
        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const userMessage = input.value.trim();
            
            if (!userMessage) return;
            
            // Display user message
            addAIMessage(userMessage, true);
            input.value = '';
            
            // Show typing indicator
            addAIMessage('⏳ מחפש...', false);
            
            try {
                // Prepare ALL pages data for AI (not just filtered)
                const allPagesContext = allPages.map(page => ({
                    title: page.title,
                    description: page.description,
                    pageType: page.pageType,
                    userId: page.userId,
                    pageId: page.pageId
                }));
                
                const filteredPagesContext = filteredPages.map(page => ({
                    title: page.title,
                    description: page.description,
                    pageType: page.pageType,
                    userId: page.userId,
                    pageId: page.pageId
                }));
                
                console.log('📊 Sending to AI:', {
                    currentCategory: currentCategory,
                    totalPages: allPages.length,
                    filteredPages: filteredPages.length,
                    allPagesContext: allPagesContext
                });
                
                // Enhanced search - extract location and profession from user message
                const locationKeywords = ['תל אביב', 'ירושלים', 'חיפה', 'באר שבע', 'נתניה', 'אשדוד', 'ראשון לציון', 'פתח תקווה', 'בת ים', 'חולון', 'רמלה', 'לוד', 'נהריה', 'אילת', 'הרצליה', 'רמת גן', 'גבעתיים', 'קרית ביאליק', 'קרית אתא', 'רחובות', 'כפר סבא', 'רעננה', 'הוד השרון', 'מגדל העמק', 'עפולה', 'טבריה', 'נצרת', 'אום אל פחם', 'רהט', 'לוד'];
                const professionKeywords = ['נגר', 'חשמלאי', 'אינסטלטור', 'צבע', 'ספר', 'קוסמטיקאית', 'מאמן', 'רופא', 'רופאת שיניים', 'וטרינר', 'מעצב', 'אדריכל', 'מהנדס', 'עורך דין', 'רואה חשבון', 'יועץ', 'מאמן כושר', 'מטפל', 'פסיכולוג', 'יועץ זוגי', 'מסגר', 'בנאי', 'פועל', 'עובד עץ', 'מנקה', 'ניקיון', 'גנן', 'דוגמן', 'צלם', 'מוזיקאי', 'שף', 'טבח', 'מלצר', 'נהג', 'שליח', 'מאבטח', 'פארמקיסט', 'אחות', 'פיזיותרפיסט', 'רופא עיניים', 'רופא ילדים', 'גניקולוג', 'אורטופד', 'קרדיולוג'];
                
                const userMessageLower = userMessage.toLowerCase();
                const foundLocation = locationKeywords.find(loc => userMessageLower.includes(loc.toLowerCase()));
                const foundProfession = professionKeywords.find(prof => userMessageLower.includes(prof.toLowerCase()));
                
                console.log('🔍 Enhanced search analysis:', {
                    foundLocation,
                    foundProfession,
                    userMessage: userMessage
                });

                const response = await fetch(AI_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_message: userMessage,
                        page_type: 'marketplace',
                        current_category: currentCategory,
                        filtered_pages: filteredPagesContext,
                        available_pages: allPagesContext,
                        available_pages_text: allPagesContext.map(p => `כותרת: ${p.title} | סוג: ${p.pageType} | תיאור: ${p.description || 'ללא תיאור'} | ID: ${p.pageId}`).join('\n'),
                        context: `מרקטפלייס - חיפוש דפים. קטגוריה נוכחית: ${currentCategory === 'all' ? 'הכל' : currentCategory}`,
                        search_context: {
                            location: foundLocation,
                            profession: foundProfession,
                            is_specific_search: !!(foundLocation || foundProfession)
                        }
                    })
                });
                
                // Remove typing indicator
                const messages = document.getElementById('aiChatMessages');
                messages.removeChild(messages.lastChild);
                
                if (!response.ok) {
                    throw new Error('שגיאת תקשורת');
                }
                
                const data = await response.json();
                console.log('🤖 Bot response:', data);
                
                // Simple - just like the store bot!
                const botMessage = data.message || 'סליחה, לא הבנתי...';
                addAIMessage(botMessage, false);
                
                const botResponse = data;
                
                // Handle actions
                console.log('🎬 Action to perform:', botResponse.action);
                
                // If no specific page found and we have location/profession, try smart search
                if (!botResponse.action && (foundLocation || foundProfession)) {
                    console.log('🔍 No specific page found, trying smart search...');
                    performSmartSearch(foundLocation, foundProfession, userMessage);
                    return;
                }
                
                if (botResponse.action === 'scroll_to_page' && botResponse.page_id) {
                    console.log('🔍 Looking for page card with ID:', botResponse.page_id);
                    
                    // Find the page card and scroll to it
                    setTimeout(() => {
                        const allCards = document.querySelectorAll('[data-page-id]');
                        console.log('📦 Total cards found:', allCards.length);
                        
                        // Log all card IDs for debugging
                        allCards.forEach((card, index) => {
                            console.log(`Card ${index}: "${card.dataset.pageId}"`);
                        });
                        
                        // Try exact match first
                        let pageCard = document.querySelector(`[data-page-id="${botResponse.page_id}"]`);
                        
                        if (!pageCard) {
                            console.log('⚠️ Exact match not found, trying smart search...');
                            
                            // Extract meaningful parts from the page_id
                            const searchTerms = botResponse.page_id
                                .toLowerCase()
                                .replace(/_html$/, '')
                                .replace(/\.html$/, '')
                                .split('_')
                                .filter(term => term && term.length > 2 && !/^\d+$/.test(term)); // Remove numbers and short terms
                            
                            console.log('🔍 Search terms:', searchTerms);
                            
                            // Try to find by matching any of the terms
                            pageCard = Array.from(allCards).find(card => {
                                const cardId = (card.dataset.pageId || '').toLowerCase();
                                console.log(`Checking: "${cardId}" against terms:`, searchTerms);
                                return searchTerms.some(term => cardId.includes(term));
                            });
                        }
                        
                        if (pageCard) {
                            console.log('✅ Found page card! ID:', pageCard.dataset.pageId);
                            pageCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Highlight the card
                            pageCard.style.outline = '3px solid #667eea';
                            pageCard.style.transform = 'scale(1.05)';
                            pageCard.style.transition = 'all 0.3s ease';
                            
                            setTimeout(() => {
                                pageCard.style.outline = '';
                                pageCard.style.transform = '';
                            }, 3000);
                        } else {
                            console.error('❌ Page card not found for:', botResponse.page_id);
                            console.error('Available cards:', Array.from(allCards).map(c => c.dataset.pageId));
                        }
                    }, 500);
                } else if ((botResponse.action === 'filter_category' || botResponse.action === 'change_category') && botResponse.category) {
                    console.log('🏷️ Changing to category:', botResponse.category);
                    
                    // Map category names
                    const categoryMap = {
                        'store': 'store',
                        'stores': 'store',
                        'חנות': 'store',
                        'חנויות': 'store',
                        'landing': 'landing',
                        'דף נחיתה': 'landing',
                        'דפי נחיתה': 'landing',
                        'course': 'course',
                        'courses': 'course',
                        'קורס': 'course',
                        'קורסים': 'course',
                        'portfolio': 'portfolio',
                        'תיק עבודות': 'portfolio',
                        'all': 'all',
                        'הכל': 'all'
                    };
                    
                    const mappedCategory = categoryMap[botResponse.category.toLowerCase()] || botResponse.category;
                    console.log('📂 Mapped category:', mappedCategory);
                    
                    setTimeout(() => {
                        filterByCategory(mappedCategory);
                        // Scroll to top to see results
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 500);
                } else {
                    console.log('ℹ️ No action to perform or action is "none"');
                }
                
            } catch (error) {
                console.error('AI Error:', error);
                // Remove typing indicator
                const messages = document.getElementById('aiChatMessages');
                if (messages.lastChild && messages.lastChild.textContent.includes('⏳')) {
                    messages.removeChild(messages.lastChild);
                }
                addAIMessage('⚠️ סליחה, נתקלתי בבעיה. נסה שוב בעוד רגע.', false);
            }
        }
    </script>

</body>
</html>

