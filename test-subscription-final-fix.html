<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ ×‘×“×™×§×ª ×ª×™×§×•×Ÿ ×× ×•×™ ×¡×•×¤×™</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { background: #d4edda; border-left: 5px solid #28a745; }
        .error { background: #f8d7da; border-left: 5px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 5px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 5px solid #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .big-button {
            background: #28a745;
            font-size: 1.2em;
            padding: 15px 30px;
            width: 100%;
            margin: 10px 0;
        }
        .big-button:hover { background: #218838; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-item {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ×‘×“×™×§×ª ×ª×™×§×•×Ÿ ×× ×•×™ ×¡×•×¤×™</h1>
    
    <div class="section info">
        <h3>ğŸ“Š ××¦×‘ ××™××•×ª × ×•×›×—×™</h3>
        <div id="auth-status">×˜×•×¢×Ÿ...</div>
    </div>
    
    <div class="section">
        <h3>ğŸ§ª ×‘×“×™×§×•×ª ××”×™×¨×•×ª</h3>
        <div class="grid">
            <div>
                <button onclick="checkAllStorage()">ğŸ’¾ ×‘×“×•×§ ×›×œ ×”-Storage</button>
                <button onclick="simulateLogin()">ğŸ”‘ ×¡×™××•×œ×¦×™×” ×”×ª×—×‘×¨×•×ª</button>
                <button onclick="testSubscriptionAPI()">ğŸ’³ ×‘×“×•×§ API ×× ×•×™</button>
            </div>
            <div>
                <button onclick="fixStorageIssues()">ğŸ”§ ×ª×§×Ÿ ×‘×¢×™×•×ª Storage</button>
                <button onclick="testFullFlow()">ğŸš€ ×‘×“×•×§ ×–×¨×™××” ××œ××”</button>
                <button onclick="clearAndReset()">ğŸ—‘ï¸ × ×§×” ×•×”×ª×—×œ ××—×“×©</button>
            </div>
        </div>
        <div id="test-results" class="status-item">
            ×ª×•×¦××•×ª ×”×‘×“×™×§×•×ª ×™×•×¤×™×¢×• ×›××Ÿ
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ¯ ×‘×“×™×§×ª ×× ×•×™ ××œ××”</h3>
        <button class="big-button" onclick="runFullSubscriptionTest()">
            ğŸš€ ×”×¨×¥ ×‘×“×™×§×ª ×× ×•×™ ××œ××”
        </button>
        <div id="subscription-results" class="status-item">
            ×ª×•×¦××•×ª ×‘×“×™×§×ª ×”×× ×•×™ ×™×•×¤×™×¢×• ×›××Ÿ
        </div>
    </div>
    
    <div class="section">
        <h3>ğŸ“‹ ×œ×•×’ ××¤×•×¨×˜</h3>
        <button onclick="clearLog()">ğŸ—‘ï¸ × ×§×” ×œ×•×’</button>
        <pre id="detailed-log">×”×œ×•×’ ×™×•×¤×™×¢ ×›××Ÿ...</pre>
    </div>

    <script>
        let logEntries = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const entry = `[${timestamp}] ${message}`;
            logEntries.push(entry);
            document.getElementById('detailed-log').textContent = logEntries.join('\n');
            console.log(entry);
        }
        
        function updateAuthStatus() {
            const status = {
                cookies: {},
                storage: {},
                memory: {},
                global: {}
            };
            
            // Check cookies
            try {
                const cookies = document.cookie.split('; ');
                status.cookies.userId = cookies.find(c => c.startsWith('userId='))?.split('=')[1] || null;
                status.cookies.userAuth = cookies.find(c => c.startsWith('userAuth='))?.split('=')[1] || null;
                status.cookies.user_id = cookies.find(c => c.startsWith('user_id='))?.split('=')[1] || null;
            } catch (error) {
                status.cookies.error = error.message;
            }
            
            // Check sessionStorage
            try {
                status.storage.sessionStorage = sessionStorage.getItem('userId');
            } catch (error) {
                status.storage.sessionStorageError = error.message;
            }
            
            // Check localStorage
            try {
                status.storage.localStorage = localStorage.getItem('userId');
            } catch (error) {
                status.storage.localStorageError = error.message;
            }
            
            // Check memory
            try {
                status.memory.autoPageUserId = window._autoPageUserId;
                status.memory.autoPageAuth = window.autoPageAuth?.userId;
            } catch (error) {
                status.memory.error = error.message;
            }
            
            // Find best userId
            const userId = status.cookies.userId || 
                          status.cookies.userAuth || 
                          status.cookies.user_id ||
                          status.storage.sessionStorage ||
                          status.storage.localStorage ||
                          status.memory.autoPageUserId ||
                          status.memory.autoPageAuth;
            
            document.getElementById('auth-status').innerHTML = `
                <strong>ğŸª Cookies:</strong><br>
                &nbsp;&nbsp;userId: ${status.cookies.userId || 'âŒ'}<br>
                &nbsp;&nbsp;userAuth: ${status.cookies.userAuth || 'âŒ'}<br>
                &nbsp;&nbsp;user_id: ${status.cookies.user_id || 'âŒ'}<br>
                <strong>ğŸ’¾ Storage:</strong><br>
                &nbsp;&nbsp;sessionStorage: ${status.storage.sessionStorage || (status.storage.sessionStorageError ? 'ğŸš« ' + status.storage.sessionStorageError : 'âŒ')}<br>
                &nbsp;&nbsp;localStorage: ${status.storage.localStorage || (status.storage.localStorageError ? 'ğŸš« ' + status.storage.localStorageError : 'âŒ')}<br>
                <strong>ğŸ§  Memory:</strong><br>
                &nbsp;&nbsp;_autoPageUserId: ${status.memory.autoPageUserId || 'âŒ'}<br>
                &nbsp;&nbsp;autoPageAuth: ${status.memory.autoPageAuth || 'âŒ'}<br>
                <strong>ğŸ¯ Best userId:</strong> ${userId ? 'âœ… ' + userId : 'âŒ ×œ× × ××¦×'}
            `;
            
            return userId;
        }
        
        function checkAllStorage() {
            log('ğŸ’¾ ×‘×•×“×§ ×›×œ ×©×™×˜×•×ª ×”-Storage...');
            const resultsDiv = document.getElementById('test-results');
            
            const methods = [];
            
            // Test cookies
            try {
                document.cookie = 'test=test; path=/';
                const cookieWorks = document.cookie.includes('test=test');
                document.cookie = 'test=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                methods.push(cookieWorks ? 'âœ… Cookies' : 'âŒ Cookies');
            } catch (error) {
                methods.push('âŒ Cookies: ' + error.message);
            }
            
            // Test sessionStorage
            try {
                sessionStorage.setItem('test', 'test');
                sessionStorage.removeItem('test');
                methods.push('âœ… sessionStorage');
            } catch (error) {
                methods.push('âŒ sessionStorage: ' + error.message);
            }
            
            // Test localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                methods.push('âœ… localStorage');
            } catch (error) {
                methods.push('âŒ localStorage: ' + error.message);
            }
            
            // Test memory
            try {
                window._test = 'test';
                delete window._test;
                methods.push('âœ… Memory');
            } catch (error) {
                methods.push('âŒ Memory: ' + error.message);
            }
            
            const workingCount = methods.filter(m => m.includes('âœ…')).length;
            
            resultsDiv.innerHTML = `
                <strong>×ª×•×¦××•×ª ×‘×“×™×§×ª Storage:</strong><br>
                ${methods.join('<br>')}<br><br>
                <strong>×©×™×˜×•×ª ×¢×•×‘×“×•×ª: ${workingCount}/4</strong>
            `;
            
            if (workingCount >= 2) {
                resultsDiv.className = 'status-item success';
                log(`âœ… ${workingCount}/4 storage methods working`);
            } else {
                resultsDiv.className = 'status-item error';
                log(`âŒ Only ${workingCount}/4 storage methods working`);
            }
        }
        
        function simulateLogin() {
            log('ğŸ”‘ ××“××” ×”×ª×—×‘×¨×•×ª...');
            const testUserId = 'google_111351120503275674259';
            
            // Try to save in all available methods
            const saved = [];
            
            // Cookies
            try {
                document.cookie = `userId=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
                document.cookie = `userAuth=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
                document.cookie = `user_id=${testUserId}; path=/; max-age=2592000; SameSite=Lax`;
                saved.push('Cookies');
            } catch (error) {
                log('âš ï¸ Could not save cookies: ' + error.message);
            }
            
            // sessionStorage
            try {
                sessionStorage.setItem('userId', testUserId);
                saved.push('sessionStorage');
            } catch (error) {
                log('âš ï¸ Could not save to sessionStorage: ' + error.message);
            }
            
            // localStorage
            try {
                localStorage.setItem('userId', testUserId);
                saved.push('localStorage');
            } catch (error) {
                log('âš ï¸ Could not save to localStorage: ' + error.message);
            }
            
            // Memory
            try {
                window._autoPageUserId = testUserId;
                window.autoPageAuth = { userId: testUserId, timestamp: Date.now() };
                saved.push('Memory');
            } catch (error) {
                log('âš ï¸ Could not save to memory: ' + error.message);
            }
            
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = `
                âœ… ×”×ª×—×‘×¨×•×ª ×¡×•××œ×¦×” ×‘×”×¦×œ×—×”!<br>
                ğŸ†” User ID: ${testUserId}<br>
                ğŸ’¾ × ×©××¨ ×‘: ${saved.join(', ')}<br>
                ğŸ“Š ×©×™×˜×•×ª ×–××™× ×•×ª: ${saved.length}/4
            `;
            resultsDiv.className = 'status-item success';
            
            log(`âœ… Login simulated - saved in: ${saved.join(', ')}`);
            updateAuthStatus();
        }
        
        async function testSubscriptionAPI() {
            log('ğŸ’³ ×‘×•×“×§ API ×× ×•×™...');
            const resultsDiv = document.getElementById('test-results');
            
            const userId = updateAuthStatus();
            if (!userId) {
                resultsDiv.innerHTML = 'âŒ ××™×Ÿ userId ×–××™×Ÿ - ×”×¨×¥ ×¡×™××•×œ×¦×™×” ×”×ª×—×‘×¨×•×ª ×§×•×“×';
                resultsDiv.className = 'status-item error';
                return;
            }
            
            try {
                const response = await fetch('/api/subscription/activate-page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify({
                        documentId: 'test-page-id',
                        userId: userId,
                        months: 1
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultsDiv.innerHTML = `
                        âœ… API ×× ×•×™ ×¢×•×‘×“!<br>
                        ğŸ“„ Response: ${JSON.stringify(result, null, 2)}
                    `;
                    resultsDiv.className = 'status-item success';
                    log('âœ… Subscription API test passed');
                } else {
                    resultsDiv.innerHTML = `
                        âš ï¸ API ×”×—×–×™×¨ ×©×’×™××”:<br>
                        ğŸ“„ Status: ${response.status}<br>
                        ğŸ“„ Error: ${result.error || 'Unknown error'}
                    `;
                    resultsDiv.className = 'status-item warning';
                    log(`âš ï¸ API returned error: ${result.error}`);
                }
            } catch (error) {
                resultsDiv.innerHTML = `âŒ ×©×’×™××” ×‘×§×¨×™××” ×œ-API: ${error.message}`;
                resultsDiv.className = 'status-item error';
                log(`âŒ API call failed: ${error.message}`);
            }
        }
        
        function fixStorageIssues() {
            log('ğŸ”§ ××ª×§×Ÿ ×‘×¢×™×•×ª Storage...');
            
            // First simulate login to set up storage
            simulateLogin();
            
            // Then check if everything works
            setTimeout(() => {
                checkAllStorage();
                updateAuthStatus();
            }, 500);
            
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = 'ğŸ”§ ×ª×™×§×•×Ÿ Storage ×”×•×©×œ×! ×‘×“×•×§ ××ª ×”×¡×˜×˜×•×¡ ×œ××¢×œ×”.';
            resultsDiv.className = 'status-item success';
            log('ğŸ”§ Storage issues fixed');
        }
        
        async function testFullFlow() {
            log('ğŸš€ ×‘×•×“×§ ×–×¨×™××” ××œ××”...');
            const resultsDiv = document.getElementById('test-results');
            
            // Step 1: Check storage
            checkAllStorage();
            
            // Step 2: Simulate login
            setTimeout(() => {
                simulateLogin();
                
                // Step 3: Test API
                setTimeout(() => {
                    testSubscriptionAPI();
                }, 500);
            }, 500);
            
            resultsDiv.innerHTML = 'ğŸš€ ×‘×“×™×§×ª ×–×¨×™××” ××œ××” ×”×—×œ×”... ×‘×“×•×§ ××ª ×”×œ×•×’ ×œ××˜×”';
            resultsDiv.className = 'status-item info';
        }
        
        function clearAndReset() {
            log('ğŸ—‘ï¸ ×× ×§×” ×•×××¤×¡ ×”×›×œ...');
            
            // Clear cookies
            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'userAuth=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = 'user_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            // Clear storage
            try { sessionStorage.clear(); } catch (e) {}
            try { localStorage.clear(); } catch (e) {}
            
            // Clear memory
            delete window._autoPageUserId;
            delete window.autoPageAuth;
            
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = 'ğŸ—‘ï¸ ×”×›×œ × ×•×§×”! ×”××¢×¨×›×ª ××•×¤×¡×”.';
            resultsDiv.className = 'status-item warning';
            
            log('ğŸ—‘ï¸ Everything cleared and reset');
            updateAuthStatus();
        }
        
        async function runFullSubscriptionTest() {
            log('ğŸš€ ××¨×™×¥ ×‘×“×™×§×ª ×× ×•×™ ××œ××”...');
            const resultsDiv = document.getElementById('subscription-results');
            
            resultsDiv.innerHTML = 'â³ ×‘×•×“×§ ×× ×•×™... ×× × ×”××ª×Ÿ';
            resultsDiv.className = 'status-item info';
            
            // Step 1: Ensure we have userId
            let userId = updateAuthStatus();
            if (!userId) {
                log('âš ï¸ No userId found, simulating login first');
                simulateLogin();
                userId = updateAuthStatus();
            }
            
            if (!userId) {
                resultsDiv.innerHTML = 'âŒ ×œ× × ×™×ª×Ÿ ×œ×§×‘×œ userId - ×‘×“×•×§ ××ª ×”×’×“×¨×•×ª ×”×“×¤×“×¤×Ÿ';
                resultsDiv.className = 'status-item error';
                return;
            }
            
            // Step 2: Test subscription flow
            try {
                // Simulate going to subscription page
                const pageId = 'test-page-' + Date.now();
                
                log(`ğŸ“„ Testing subscription for page: ${pageId}`);
                
                // Test the API call
                const response = await fetch('/api/subscription/activate-page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify({
                        documentId: pageId,
                        userId: userId,
                        months: 1
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultsDiv.innerHTML = `
                        ğŸ‰ ×‘×“×™×§×ª ×× ×•×™ ×”×•×©×œ××” ×‘×”×¦×œ×—×”!<br><br>
                        <strong>âœ… ×›×œ ×”×©×œ×‘×™× ×¢×‘×¨×•:</strong><br>
                        1. âœ… ×–×™×”×•×™ ××©×ª××© (${userId})<br>
                        2. âœ… ×©××™×¨×” ×‘-Storage<br>
                        3. âœ… ×§×¨×™××” ×œ-API<br>
                        4. âœ… ×”×¤×¢×œ×ª ×× ×•×™<br><br>
                        <strong>ğŸ“Š ×ª×•×¦××”:</strong> ×”××¢×¨×›×ª ××•×›× ×” ×œ×©×™××•×©!
                    `;
                    resultsDiv.className = 'status-item success';
                    log('ğŸ‰ Full subscription test PASSED');
                } else {
                    resultsDiv.innerHTML = `
                        âš ï¸ ×‘×“×™×§×ª ×× ×•×™ × ×›×©×œ×” ×‘-API:<br><br>
                        <strong>âŒ ×©×’×™××”:</strong> ${result.error}<br>
                        <strong>ğŸ“Š Status:</strong> ${response.status}<br>
                        <strong>ğŸ” Debug:</strong> ${JSON.stringify(result.debug || {}, null, 2)}<br><br>
                        <strong>ğŸ’¡ ×”×¦×¢×”:</strong> ${result.suggestRefresh ? '× ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£' : '×‘×“×•×§ ××ª ×”×œ×•×’×™×'}
                    `;
                    resultsDiv.className = 'status-item warning';
                    log(`âš ï¸ Subscription test failed: ${result.error}`);
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    âŒ ×©×’×™××” ×‘×‘×“×™×§×ª ×× ×•×™:<br><br>
                    <strong>Error:</strong> ${error.message}<br>
                    <strong>ğŸ’¡ ×”×¦×¢×”:</strong> ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×•× ×¡×” ×©×•×‘
                `;
                resultsDiv.className = 'status-item error';
                log(`âŒ Subscription test error: ${error.message}`);
            }
        }
        
        function clearLog() {
            logEntries = [];
            document.getElementById('detailed-log').textContent = '×”×œ×•×’ × ×•×§×”...';
        }
        
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×›×œ 3 ×©× ×™×•×ª
        setInterval(updateAuthStatus, 3000);
        
        // ×¢×“×›×•×Ÿ ×¨××©×•× ×™
        updateAuthStatus();
        log('ğŸ”§ Subscription Final Fix Test Page Loaded');
    </script>
</body>
</html>