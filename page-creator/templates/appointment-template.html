<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta name="page-type" content="serviceProvider">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="business-name" content="{{BUSINESS_NAME}}">
    <title>{{BUSINESS_NAME}} - {{BUSINESS_DESCRIPTION}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; }
        
        /* Time Slot Styles */
        .time-slot {
            position: relative;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
        }
        
        .time-slot.available {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            border-color: #4ade80;
            color: #166534;
        }
        
        .time-slot.available:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(74, 222, 128, 0.4);
        }
        
        .time-slot.booked {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .time-slot.break {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
            color: #92400e;
            cursor: not-allowed;
        }
        
        .time {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .status {
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-50">

<!-- Header -->
<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold text-purple-600">{{BUSINESS_NAME}}</h1>
            <nav class="hidden md:flex gap-6">
                <a href="#about" class="text-gray-700 hover:text-purple-600">××•×“×•×ª</a>
                <a href="#services" class="text-gray-700 hover:text-purple-600">×©×™×¨×•×ª×™×</a>
                <a href="#calendar" class="text-gray-700 hover:text-purple-600">×§×‘×™×¢×ª ×ª×•×¨</a>
                <a href="#contact" class="text-gray-700 hover:text-purple-600">×¦×•×¨ ×§×©×¨</a>
            </nav>
        </div>
    </div>
</header>

<!-- Hero Section -->
<section id="home" class="bg-gradient-to-br from-purple-600 to-pink-500 text-white py-20">
    <div class="container mx-auto px-6 text-center">
        <h2 class="text-5xl font-bold mb-6">{{BUSINESS_NAME}}</h2>
        <p class="text-xl mb-8">{{BUSINESS_DESCRIPTION}}</p>
        <a href="#calendar" class="inline-block bg-white text-purple-600 px-8 py-3 rounded-lg font-bold text-lg hover:bg-gray-100 transition">
            ×§×‘×¢/×™ ×ª×•×¨ ×¢×›×©×™×•
        </a>
    </div>
</section>

<!-- About Section -->
<section id="about" class="py-16">
    <div class="container mx-auto px-6">
        <h2 class="text-4xl font-bold text-center mb-8">××•×“×•×ª</h2>
        <div class="max-w-3xl mx-auto text-lg text-gray-700 text-center">
            <p>{{ABOUT_TEXT}}</p>
        </div>
    </div>
</section>

<!-- Services Section -->
<section id="services" class="py-16 bg-white">
    <div class="container mx-auto px-6">
        <h2 class="text-4xl font-bold text-center mb-12">×”×©×™×¨×•×ª×™× ×©×œ× ×•</h2>
        <div id="services-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Services will be injected here -->
        </div>
    </div>
</section>

<!-- Calendar Section -->
<section id="calendar" class="py-16">
    <div class="container mx-auto px-6 max-w-6xl">
        <h2 class="text-4xl font-bold text-center mb-12">ğŸ“… ×§×‘×™×¢×ª ×ª×•×¨</h2>
        
        <!-- Date Selector -->
        <div id="date-selector" class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <div class="flex items-center justify-between mb-4">
                <button id="prev-day" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                    â—€ ×™×•× ×§×•×“×
                </button>
                <div id="selected-date-display" class="text-xl font-bold text-gray-800">
                    <!-- Will show selected date -->
                </div>
                <button id="next-day" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                    ×™×•× ×”×‘× â–¶
                </button>
            </div>
            <div id="quick-date-buttons" class="flex gap-2 justify-center flex-wrap">
                <button class="quick-date-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-purple-100" data-days="0">×”×™×•×</button>
                <button class="quick-date-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-purple-100" data-days="1">××—×¨</button>
                <button class="quick-date-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-purple-100" data-days="2">××—×¨×ª×™×™×</button>
            </div>
        </div>
        
        <!-- Time Slots -->
        <div id="time-slots-container" class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-2xl font-bold mb-4 text-center">×ª×•×¨×™× ×¤× ×•×™×™× ×œ×™×•× <span id="day-name"></span></h3>
            <div id="time-slots-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <!-- Slots will be generated here -->
            </div>
            <div id="no-slots-message" class="hidden text-center py-8">
                <p class="text-red-600 text-lg">××™×Ÿ ×ª×•×¨×™× ×¤× ×•×™×™× ×‘×™×•× ×–×”</p>
                <p class="text-gray-600 mt-2">×× × ×‘×—×¨ ×ª××¨×™×š ××—×¨</p>
            </div>
        </div>
        
        <!-- Confirmation Message -->
        <div id="confirmation-message" class="hidden mt-6 p-6 bg-green-50 border-2 border-green-300 rounded-xl text-center">
            <!-- Will show after slot selection -->
        </div>
        
        <!-- Booking Form -->
        <form id="booking-form" class="bg-white p-6 rounded-xl shadow-lg mt-6 hidden">
            <h3 class="text-2xl font-bold mb-4">×¤×¨×˜×™ ×”×ª×•×¨</h3>
            <input type="hidden" id="appointment-date" name="date">
            <input type="hidden" id="appointment-time" name="time">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="customer-name" name="name" placeholder="×©× ××œ×" required class="px-4 py-3 border-2 rounded-lg focus:border-purple-500 outline-none">
                <input type="tel" id="customer-phone" name="phone" placeholder="×˜×œ×¤×•×Ÿ" required class="px-4 py-3 border-2 rounded-lg focus:border-purple-500 outline-none">
                <input type="email" id="customer-email" name="email" placeholder="××™××™×™×œ (××•×¤×¦×™×•× ×œ×™)" class="px-4 py-3 border-2 rounded-lg focus:border-purple-500 outline-none">
                
                <!-- Service Selector -->
                <div class="col-span-full">
                    <label for="service-selector" class="block text-base font-bold text-gray-800 mb-2">ğŸ’‡ ×‘×—×¨ ×©×™×¨×•×ª:</label>
                    <select id="service-selector" name="service" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-base font-semibold focus:border-purple-500 focus:outline-none" required>
                        <option value="">×‘×—×¨ ×©×™×¨×•×ª</option>
                    </select>
                    <p id="service-info" class="mt-2 text-sm text-gray-600 hidden"></p>
                </div>
            </div>
            
            <textarea id="customer-notes" name="notes" placeholder="×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)" class="w-full px-4 py-3 border-2 rounded-lg mt-4 focus:border-purple-500 outline-none" rows="3"></textarea>
            
            <button type="submit" class="w-full bg-purple-600 text-white py-4 rounded-lg font-bold text-lg mt-4 hover:bg-purple-700 transition">
                ××©×¨ ×ª×•×¨
            </button>
        </form>
    </div>
</section>

<!-- Contact Section -->
<section id="contact" class="py-16 bg-white">
    <div class="container mx-auto px-6 text-center">
        <h2 class="text-4xl font-bold mb-8">×¦×•×¨ ×§×©×¨</h2>
        <div class="max-w-md mx-auto space-y-4">
            <p class="text-xl">ğŸ“ ×˜×œ×¤×•×Ÿ: {{PHONE}}</p>
            <p class="text-xl">ğŸ“§ ××™××™×™×œ: {{EMAIL}}</p>
            <p class="text-xl">ğŸ“ ×›×ª×•×‘×ª: {{ADDRESS}}</p>
        </div>
    </div>
</section>

<!-- Footer -->
<footer class="bg-gray-800 text-white py-8">
    <div class="container mx-auto px-6 text-center">
        <p>Â© {{CURRENT_YEAR}} {{BUSINESS_NAME}} - ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª</p>
    </div>
</footer>

<!-- JavaScript -->
<script>
// Configuration - will be injected from metadata
const USER_ID = '{{USER_ID}}';
const PAGE_ID = '{{PAGE_ID}}';
const WORKING_DAYS = {{WORKING_DAYS}};
const WORKING_HOURS = {{WORKING_HOURS}};
const BREAKS = {{BREAKS}};
const SERVICES = [];

let selectedDate = new Date();
let appointments = [];

// Load services from metadata.json
async function loadServices() {
    try {
        const response = await fetch(`/output/${USER_ID}/${PAGE_ID}_data/metadata.json`);
        if (response.ok) {
            const metadata = await response.json();
            SERVICES.length = 0;
            if (metadata.services && Array.isArray(metadata.services)) {
                SERVICES.push(...metadata.services);
            }
            console.log('âœ… Loaded services:', SERVICES);
            
            // Populate service selector
            const serviceSelector = document.getElementById('service-selector');
            if (serviceSelector && SERVICES.length > 0) {
                while (serviceSelector.options.length > 1) {
                    serviceSelector.remove(1);
                }
                
                SERVICES.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.name;
                    option.textContent = `${service.name} - ${service.duration} ×“×§×•×ª - â‚ª${service.price}`;
                    option.dataset.duration = service.duration;
                    option.dataset.price = service.price;
                    serviceSelector.appendChild(option);
                });
                
                // Show service info when selected
                serviceSelector.addEventListener('change', function() {
                    const serviceInfo = document.getElementById('service-info');
                    if (this.value && serviceInfo) {
                        const selectedOption = this.options[this.selectedIndex];
                        const duration = parseInt(selectedOption.dataset.duration);
                        const price = selectedOption.dataset.price;
                        const slotsNeeded = Math.ceil(duration / 30);
                        const blockedTime = slotsNeeded * 30;
                        let timeInfo = `â±ï¸ ××©×š: <strong>${duration} ×“×§×•×ª</strong>`;
                        if (blockedTime > duration) {
                            timeInfo += ` (×™×—×¡×•× ${blockedTime} ×“×§×•×ª)`;
                        }
                        serviceInfo.innerHTML = `${timeInfo} | ğŸ’° ××—×™×¨: <strong>â‚ª${price}</strong>`;
                        serviceInfo.classList.remove('hidden');
                    } else if (serviceInfo) {
                        serviceInfo.classList.add('hidden');
                    }
                });
                
                // Populate services grid
                const servicesGrid = document.getElementById('services-grid');
                if (servicesGrid) {
                    servicesGrid.innerHTML = SERVICES.map(service => `
                        <div class="bg-gray-50 p-6 rounded-xl shadow-md hover:shadow-lg transition">
                            <h3 class="text-2xl font-bold mb-2">${service.name}</h3>
                            <p class="text-gray-600 mb-2">â±ï¸ ${service.duration} ×“×§×•×ª</p>
                            <p class="text-2xl font-bold text-purple-600">â‚ª${service.price}</p>
                        </div>
                    `).join('');
                }
            }
        }
    } catch (error) {
        console.error('âŒ Failed to load services:', error);
    }
}

// Initialize calendar
async function initCalendar() {
    // Check if in preview mode
    const urlParams = new URLSearchParams(window.location.search);
    const isPreview = urlParams.get('preview') === 'true';
    
    if (!isPreview) {
        await fetchAppointments();
        await loadServices();
    }
    
    // Start with today or next working day
    selectedDate = new Date();
    if (!WORKING_DAYS.includes(selectedDate.getDay())) {
        for (let i = 1; i <= 7; i++) {
            const nextDate = new Date(selectedDate);
            nextDate.setDate(nextDate.getDate() + i);
            if (WORKING_DAYS.includes(nextDate.getDay())) {
                selectedDate = nextDate;
                break;
            }
        }
    }
    
    renderDateSelector();
    renderTimeSlots();
    setupEventListeners();
}

// Fetch appointments from server
async function fetchAppointments() {
    try {
        const response = await fetch(`/api/appointments/${USER_ID}/${PAGE_ID}`);
        if (response.ok) {
            appointments = await response.json();
            console.log('ğŸ“… Loaded appointments:', appointments.length);
        }
    } catch (error) {
        console.error('Failed to fetch appointments:', error);
        appointments = [];
    }
}

// Render date selector
function renderDateSelector() {
    const dateDisplay = document.getElementById('selected-date-display');
    const dayName = document.getElementById('day-name');
    
    if (!dateDisplay || !dayName) return;
    
    const hebrewDays = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
    const hebrewMonths = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
    
    const dayOfWeek = hebrewDays[selectedDate.getDay()];
    const day = selectedDate.getDate();
    const month = hebrewMonths[selectedDate.getMonth()];
    const year = selectedDate.getFullYear();
    
    dateDisplay.textContent = `×™×•× ${dayOfWeek}, ${day} ×‘${month} ${year}`;
    dayName.textContent = dayOfWeek;
}

// Render time slots
function renderTimeSlots() {
    const grid = document.getElementById('time-slots-grid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    // Check if working day
    const isWorkingDay = WORKING_DAYS.includes(selectedDate.getDay());
    if (!isWorkingDay) {
        grid.innerHTML = `
            <div class="col-span-full text-center py-12 bg-red-50 rounded-xl border-2 border-red-200">
                <div class="text-6xl mb-4">ğŸ“…</div>
                <p class="text-xl font-bold text-red-600 mb-2">×™×•× ×–×” ××™× ×• ×™×•× ×¢×‘×•×“×”</p>
                <p class="text-gray-700">×”×©×ª××© ×‘×›×¤×ª×•×¨×™ ×”× ×™×•×•×˜ ×œ××¢×œ×” ×›×“×™ ×œ×‘×—×•×¨ ×ª××¨×™×š ××—×¨</p>
            </div>
        `;
        return;
    }
    
    // Generate time slots (30-minute intervals)
    const [startHour, startMin] = WORKING_HOURS.start.split(':').map(Number);
    const [endHour, endMin] = WORKING_HOURS.end.split(':').map(Number);
    const dateStr = selectedDate.toISOString().split('T')[0];
    const dayAppointments = appointments.filter(apt => apt.date === dateStr);
    
    for (let hour = startHour; hour < endHour; hour++) {
        for (let min = 0; min < 60; min += 30) {
            const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
            const currentTimeMinutes = hour * 60 + min;
            
            // Check if in break time
            const isBreak = BREAKS.some(b => timeStr >= b.start && timeStr < b.end);
            
            // Check if booked (including intermediate slots)
            let isBooked = false;
            let bookedReason = '';
            
            for (const apt of dayAppointments) {
                if (apt.status === 'cancelled') continue;
                
                const [aptHour, aptMin] = apt.time.split(':').map(Number);
                const aptStartMinutes = aptHour * 60 + aptMin;
                
                let aptDuration = apt.duration || 30;
                if (!apt.duration && apt.service) {
                    const aptService = SERVICES.find(s => s.name === apt.service);
                    if (aptService) aptDuration = aptService.duration;
                }
                
                const blockedDuration = Math.ceil(aptDuration / 30) * 30;
                const aptEndMinutes = aptStartMinutes + blockedDuration;
                
                if (currentTimeMinutes >= aptStartMinutes && currentTimeMinutes < aptEndMinutes) {
                    isBooked = true;
                    bookedReason = currentTimeMinutes === aptStartMinutes ? 'start' : 'middle';
                    break;
                }
            }
            
            // Create slot
            const slot = document.createElement('button');
            slot.className = 'time-slot';
            
            if (isBreak) {
                slot.className += ' break';
                slot.disabled = true;
                slot.innerHTML = `<div class="time">${timeStr}</div><div class="status">â˜• ×”×¤×¡×§×”</div>`;
            } else if (isBooked) {
                slot.className += ' booked';
                slot.disabled = true;
                const statusText = bookedReason === 'middle' ? 'â±ï¸ ×‘×××¦×¢ ×ª×•×¨' : 'ğŸ”´ ×ª×¤×•×¡';
                slot.innerHTML = `<div class="time">${timeStr}</div><div class="status">${statusText}</div>`;
            } else {
                // Check if past
                const now = new Date();
                const slotDateTime = new Date(selectedDate);
                slotDateTime.setHours(hour, min, 0, 0);
                
                if (slotDateTime < now) {
                    slot.className += ' booked';
                    slot.disabled = true;
                    slot.innerHTML = `<div class="time">${timeStr}</div><div class="status">âš« ×¢×‘×¨</div>`;
                } else {
                    slot.className += ' available';
                    slot.dataset.time = timeStr;
                    slot.dataset.date = dateStr;
                    
                    const slotHour = parseInt(timeStr.split(':')[0]);
                    const isPopularTime = (slotHour >= 9 && slotHour <= 11) || (slotHour >= 14 && slotHour <= 16);
                    const popularIcon = isPopularTime ? 'â­ ' : '';
                    
                    slot.innerHTML = `<div class="time">${timeStr}</div><div class="status">${popularIcon}ğŸŸ¢ ×¤× ×•×™</div>`;
                    slot.onclick = () => selectTimeSlot(timeStr, dateStr);
                    
                    if (isPopularTime) {
                        slot.style.borderColor = '#f59e0b';
                        slot.style.boxShadow = '0 0 0 2px rgba(245, 158, 11, 0.2)';
                    }
                }
            }
            
            grid.appendChild(slot);
        }
    }
}

// Select time slot
function selectTimeSlot(time, date) {
    document.getElementById('appointment-date').value = date;
    document.getElementById('appointment-time').value = time;
    
    const confirmationMessage = document.getElementById('confirmation-message');
    const bookingForm = document.getElementById('booking-form');
    
    if (confirmationMessage) {
        confirmationMessage.classList.remove('hidden');
        confirmationMessage.innerHTML = `âœ… <strong>× ×‘×—×¨ ×ª×•×¨ ×œ-${time}</strong><br>ğŸ“… ${new Date(date).toLocaleDateString('he-IL')}<br><br>ğŸ‘‡ ×‘×—×¨ ×©×™×¨×•×ª ×•×”×©×œ× ×¤×¨×˜×™× ×‘×˜×•×¤×¡ ×œ××˜×”`;
    }
    
    if (bookingForm) {
        bookingForm.classList.remove('hidden');
        bookingForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// Setup event listeners
function setupEventListeners() {
    // Previous day button
    document.getElementById('prev-day')?.addEventListener('click', () => {
        selectedDate.setDate(selectedDate.getDate() - 1);
        renderDateSelector();
        renderTimeSlots();
    });
    
    // Next day button
    document.getElementById('next-day')?.addEventListener('click', () => {
        selectedDate.setDate(selectedDate.getDate() + 1);
        renderDateSelector();
        renderTimeSlots();
    });
    
    // Quick date buttons
    document.querySelectorAll('.quick-date-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const days = parseInt(btn.dataset.days);
            selectedDate = new Date();
            selectedDate.setDate(selectedDate.getDate() + days);
            renderDateSelector();
            renderTimeSlots();
        });
    });
    
    // Form submission
    document.getElementById('booking-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
            userId: USER_ID,
            pageId: PAGE_ID,
            date: document.getElementById('appointment-date').value,
            time: document.getElementById('appointment-time').value,
            name: document.getElementById('customer-name').value,
            phone: document.getElementById('customer-phone').value,
            email: document.getElementById('customer-email').value || '',
            service: document.getElementById('service-selector').value,
            notes: document.getElementById('customer-notes').value || '',
            status: 'pending'
        };
        
        // Get duration and price from selected service
        const selectedServiceOption = document.getElementById('service-selector').selectedOptions[0];
        if (selectedServiceOption) {
            formData.duration = parseInt(selectedServiceOption.dataset.duration) || 30;
            formData.price = parseFloat(selectedServiceOption.dataset.price) || 0;
        }
        
        try {
            const response = await fetch('/api/appointments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            if (response.ok) {
                alert('âœ… ×”×ª×•×¨ × ×§×‘×¢ ×‘×”×¦×œ×—×”! × ×©×œ×—×” ×”×•×“×¢×” ×œ-WhatsApp');
                await fetchAppointments();
                renderTimeSlots();
                e.target.reset();
                document.getElementById('confirmation-message').classList.add('hidden');
                document.getElementById('booking-form').classList.add('hidden');
            } else {
                alert('âŒ ×©×’×™××” ×‘×§×‘×™×¢×ª ×”×ª×•×¨. ×× × × ×¡×” ×©×•×‘.');
            }
        } catch (error) {
            console.error('Error booking appointment:', error);
            alert('âŒ ×©×’×™××” ×‘×§×‘×™×¢×ª ×”×ª×•×¨. ×× × × ×¡×” ×©×•×‘.');
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initCalendar);
</script>

</body>
</html>

