<!--
<!DOCTYPE html>
<!-- The lang and dir attributes will be set dynamically by JavaScript -->

<html lang="he" dir="rtl">
<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Dashboard - Advanced Page Builder Pro</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Frank+Ruhl+Libre:wght@400;700&family=Heebo:wght@400;700&family=Rubik:wght@400;700;900&family=Arimo:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    

    <style>

        /* General Body and Animation Styles */

            body { 

            font-family: 'Inter', 'Assistant', sans-serif;
    
                background-color: #f0f2f5;
    
        }

        .view { display: none; }

        .view.active { display: block; }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }

        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }

        /* Bot guidance animations */
        @keyframes slideInFromRight { 
            from { opacity: 0; transform: translateX(30px) scale(0.95); } 
            to { opacity: 1; transform: translateX(0) scale(1); } 
        }

        @keyframes slideInFromLeft { 
            from { opacity: 0; transform: translateX(-30px) scale(0.95); } 
            to { opacity: 1; transform: translateX(0) scale(1); } 
        }



        /* Loader Styles */

        .loader { border-top-color: #a78bfa; animation: spin 1s linear infinite; }

        @keyframes spin { to { transform: rotate(360deg); } }

        

        /* Card Styles (Templates & Options) */

        .template-card { 

            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            background-color: white;

            position: relative;

            overflow: hidden;

        }

        .template-card:hover .overlay { opacity: 1; }

        .template-card:hover img { transform: scale(1.05); }

        .template-card img { transition: transform 0.3s ease-in-out; }

        .overlay { transition: opacity 0.3s ease-in-out; }



        .option-card { transition: all 0.3s ease-in-out; }

        .option-card.selected { 

            transform: scale(1.03); 

            box-shadow: 0 0 0 3px #8b5cf6; 

            border-color: #8b5cf6;

        }



        /* AI Assistant Chat Bubble */

        .chat-bubble { 

            max-width: 100%; 

            padding: 12px 18px; 

            border-radius: 20px; 

            line-height: 1.5;

            animation: bubbleIn 0.4s ease-in-out;

            word-wrap: break-word;

            background-color: #eef2ff; 

            color: #4338ca; 

            box-shadow: 0 4px 10px rgba(0,0,0,0.05);

            transition: all 0.3s ease;

        }

        html[dir="rtl"] .chat-bubble { border-bottom-right-radius: 4px; }

        html[dir="ltr"] .chat-bubble { border-bottom-left-radius: 4px; }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-style: italic;
            color: #6b7280;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #8b5cf6;
            animation: bounce 1.4s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { 
                transform: translateY(0); 
            }
            40% { 
                transform: translateY(-10px); 
            }
            60% { 
                transform: translateY(-5px); 
            }
        }

        @keyframes bubbleIn {

            from { opacity: 0; transform: scale(0.8) translateY(10px); }

            to { opacity: 1; transform: scale(1) translateY(0); }

        }



        /* Modal Styles */

        .modal-overlay {

            position: fixed;

            top: 0; left: 0; right: 0; bottom: 0;

            background: rgba(0, 0, 0, 0.5);

            display: flex;

            align-items: center;

            justify-content: center;

            z-index: 1000;

            opacity: 0;

            visibility: hidden;

            transition: opacity 0.3s, visibility 0.3s;

        }

        .modal-overlay.visible { opacity: 1; visibility: visible; }

        .modal-content {

            background: white;

            padding: 2rem;

            border-radius: 1rem;

            box-shadow: 0 10px 25px rgba(0,0,0,0.1);

            text-align: center;

            transform: scale(0.9);

            transition: transform 0.3s;

        }

        .modal-overlay.visible .modal-content { transform: scale(1); }



        /* Form & Editor Styles */

        .form-fieldset {

            border: 1px solid #e5e7eb;

            border-radius: 0.75rem;

            padding: 1.5rem;

            background-color: rgba(255,255,255,0.5);

        }

        .form-legend {

            padding: 0 0.5rem;

            font-weight: 600;

            color: #4c1d95;

        }

        #preview-iframe.editable {

            box-shadow: 0 0 0 4px #8b5cf6;

            border-radius: 8px;

        }
        
        /* Force full width preview */
        #preview-view {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        #preview-container {
            width: 100% !important;
            max-width: 100% !important;
            display: flex !important;
        }
        
        #preview-iframe {
            width: 100% !important;
            max-width: 100% !important;
            min-height: 100% !important;
        }

        .color-picker-wrapper { position: relative; }

        .color-picker-input {

            opacity: 0;

            position: absolute;

            top: 0; left: 0;

            width: 100%; height: 100%;

            cursor: pointer;

        }



        /* Generation Loading Animation Styles */

        .gen-view-container { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }

        .gen-loader {

            width: 80px; height: 80px;

            border-radius: 50%;

            perspective: 800px;

        }

        .gen-loader .inner {

            position: absolute;

            box-sizing: border-box;

            width: 100%; height: 100%;

            border-radius: 50%;

        }

        .gen-loader .inner.one {

            left: 0%; top: 0%;

            animation: rotate-one 1.5s linear infinite;

            border-bottom: 3px solid #8b5cf6;

        }

        .gen-loader .inner.two {

            right: 0%; top: 0%;

            animation: rotate-two 1.5s linear infinite;

            border-right: 3px solid #ec4899;

        }

        .gen-loader .inner.three {

            right: 0%; bottom: 0%;

            animation: rotate-three 1.5s linear infinite;

            border-top: 3px solid #3b82f6;

        }

        @keyframes rotate-one { 0% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(0deg); } 100% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(360deg); } }

        @keyframes rotate-two { 0% { transform: rotateX(50deg) rotateY(10deg) rotateZ(0deg); } 100% { transform: rotateX(50deg) rotateY(10deg) rotateZ(360deg); } }

        @keyframes rotate-three { 0% { transform: rotateX(35deg) rotateY(55deg) rotateZ(0deg); } 100% { transform: rotateX(35deg) rotateY(55deg) rotateZ(360deg); } }

        

        .gen-text {

            font-family: 'Heebo', sans-serif;

            font-weight: 600;

            color: #475569;

            margin-top: 2rem;

            min-height: 2em; /* Reserve space for text */
            
            animation: none; /* הסר כל אנימציה מהבהבה */

        }

        

        /* Floating Edit Toolbar */

        #preview-controls-container {

            position: absolute;

            bottom: 1rem;

            left: 50%;

            transform: translateX(-50%);

            z-index: 50;

            display: flex;

            flex-direction: column;

            align-items: center;

            gap: 0.75rem;

        }

        #tools-fab {

            transition: all 0.3s ease-in-out;

            flex-shrink: 0;

        }

        #tools-fab.active {

            transform: rotate(135deg);

            background-color: #be185d; /* Pink */

        }

        #tools-menu {

            display: flex;

            align-items: center;

            gap: 0.75rem;

            transition: all 0.3s ease-in-out;

        }

        #tools-menu:not(.open) {

            opacity: 0;

            transform: translateY(10px) scale(0.95);

            pointer-events: none;

            height: 0;

        }

        #tools-menu.open {

            opacity: 1;

            transform: translateY(0) scale(1);

            pointer-events: auto;

        }

        .tool-btn {

            background-color: rgba(31, 41, 55, 0.8);

            backdrop-filter: blur(8px);

            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);

        }



        /* Language Selector */

        #language-selector-container {

            position: absolute;

            top: 1.5rem;

            inset-inline-end: 1.5rem; /* Replaces right/left for RTL/LTR support */

            z-index: 20;

        }

        /* Store Management Dashboard Styles */
        .dashboard-nav-btn {
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .dashboard-nav-btn:hover {
            color: #374151;
            background: #f9fafb;
        }

        .dashboard-nav-btn.active {
            color: #8b5cf6;
            border-bottom-color: #8b5cf6;
            background: #f9fafb;
        }

        .dashboard-section {
            min-height: 400px;
        }

        #store-management-dashboard {
            backdrop-filter: blur(4px);
        }

    </style>
</head>
<body class="bg-gray-100">



    <!-- Modal for general messages -->

    <div id="custom-modal" class="modal-overlay">

        <div class="modal-content">

            <p id="modal-message" class="text-lg text-slate-700 mb-6"></p>

                <button id="modal-close-btn" data-translate-key="modal_close_btn" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition"></button>

        </div>

    </div>

    

    <!-- Floating AI Assistant Bubble -->

    <div id="assistant-container" class="fixed bottom-6 inset-inline-end-6 z-20 w-80 hidden">

        <div class="flex items-start gap-3">

            <img src="https://placehold.co/48x48/8b5cf6/ffffff?text=AI" alt="Bot Avatar" class="w-12 h-12 rounded-full flex-shrink-0 shadow-lg cursor-pointer" id="assistant-avatar">

            <div id="guidance-bubble" class="chat-bubble hidden"></div>

        </div>

    </div>





        <div class="min-h-screen flex flex-col items-center justify-center p-4 relative">



        <!-- Language Selector Dropdown -->
    
            <div id="language-selector-container">
    
                <select id="language-selector" onchange="updatePageLanguage(this.value)" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 shadow">
                <option value="he">עברית</option>
    
                <option value="en">English</option>
                <option value="ar">العربية</option>
                <option value="ja">日本語</option>
                <option value="es">Español</option>
    
                 <option value="fr">Français</option>
    
                <option value="de">Deutsch</option>
                <option value="ru">Русский</option>
                <option value="zh">中文</option>
            </select>
    
        </div>



            <div id="type-selection-view" class="view active w-full max-w-7xl">
    
                <div class="bg-white/60 backdrop-blur-xl rounded-2xl shadow-xl p-8 fade-in">
    
                    <div class="text-center mb-10">
    
                        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-700 to-pink-600" data-translate-key="main_title"></h1>
    
                        <p class="text-slate-600 mt-3 text-lg" data-translate-key="main_subtitle"></p>
    
                </div>

                    <div id="template-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
    
                        <!-- Template cards will be injected by JS -->
    
                </div>

            </div>

        </div>
    
    
    
            <div id="form-view" class="view w-full max-w-5xl relative">
    
                 <div class="bg-white/60 backdrop-blur-xl rounded-2xl shadow-xl p-8">
    
                    <div class="text-center mb-8">
    
                        <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-700 to-pink-600"><span data-translate-key="create_page_title"></span> <span id="page-type-title"></span></h1>
    
                        <p class="text-slate-600 mt-2" data-translate-key="form_subtitle"></p>
    
                </div>
    
                    <div>
    
                        <form id="details-form" class="space-y-6">
    
                            
    
                            <fieldset id="basic-details-fieldset" class="form-fieldset">
    
                                <legend class="form-legend" data-translate-key="fieldset_basic_details"></legend>
    
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
    
                                    <div><label for="mainName" id="mainNameLabel" class="block text-sm font-medium text-slate-700"></label><input type="text" id="mainName" name="mainName" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required></div>
    
                                    <div><label for="contactName" data-translate-key="label_contact_name" class="block text-sm font-medium text-slate-700"></label><input type="text" id="contactName" name="contactName" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required></div>
    
                                    <div><label for="email" data-translate-key="label_email" class="block text-sm font-medium text-slate-700"></label><input type="email" id="email" name="email" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required></div>
    
                                    
    
                                    <!-- Phone Number with Country Code -->
    
                                    <div class="sm:col-span-2">
    
                                        <label for="phone" data-translate-key="label_phone" class="block text-sm font-medium text-slate-700"></label>
    
                                        <div class="mt-1 flex rounded-md shadow-sm">
    
                                            <select id="countryCode" name="countryCode" class="block rounded-s-md border-e-0 border-gray-300 bg-gray-50 text-gray-500 focus:ring-purple-500 focus:border-purple-500"></select>
    
                                            <input type="tel" id="phone" name="phone" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-gray-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" required>
    
                                    </div>
    
                                </div>

    
    
                                    <div class="sm:col-span-2"><label for="description" data-translate-key="label_description" class="block text-sm font-medium text-slate-700"></label><textarea id="description" name="description" rows="4" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required spellcheck="false"></textarea></div>
    
                                    <div id="address-field-container" class="sm:col-span-2"><label for="address" data-translate-key="label_address" class="block text-sm font-medium text-slate-700"></label><input type="text" id="address" name="address" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>
    
                                </div>
    
                            </fieldset>
    
    
    
                            <div id="dynamic-fields" class="space-y-6">
    
                                <!-- Dynamic fields will be injected here by JS -->
    
                            </div>
    
                            
    
                            <fieldset id="optional-sections-fieldset" class="form-fieldset" style="display: none;">
    
                                <legend class="form-legend" data-translate-key="fieldset_optional_sections"></legend>
    
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
    
                                    <!-- Checkboxes will be injected here -->
    
                                </div>
    
                            </fieldset>
    
    
    
                            <fieldset id="social-media-fieldset" class="form-fieldset">
    
                                <legend class="form-legend" data-translate-key="fieldset_social_media"></legend>
    
                                 <div class="space-y-4">
    
                                <div>
    
                                        <label for="youtubeLink" class="sr-only">YouTube</label>
    
                                        <div class="flex rounded-md shadow-sm">
    
                                             <span class="inline-flex items-center px-3 rounded-s-md border border-e-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm">
    
                                                <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266-4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816V8l6 4-6 4z" clip-rule="evenodd" /></svg>
    
                                            </span>
    
                                            <input type="url" name="youtubeLink" id="youtubeLink" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-slate-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="https://youtube.com/watch?v=...">
    
                                    </div>
    
                                        <div class="mt-2">
    
                                            <label class="text-sm font-medium text-slate-700" data-translate-key="label_youtube_display"></label>
    
                                            <div class="mt-1 flex gap-x-6">
    
                                                <div class="flex items-center">
    
                                                    <input id="youtube-embed" name="youtubeDisplayMode" type="radio" value="Embed" class="h-4 w-4 border-gray-300 text-purple-600 focus:ring-purple-600" checked>
    
                                                    <label for="youtube-embed" data-translate-key="label_youtube_embed" class="ms-2 block text-sm text-gray-900"></label>
    
                                                </div>
    
                                                <div class="flex items-center">
    
                                                    <input id="youtube-link" name="youtubeDisplayMode" type="radio" value="Link" class="h-4 w-4 border-gray-300 text-purple-600 focus:ring-purple-600">
    
                                                    <label for="youtube-link" data-translate-key="label_youtube_link" class="ms-2 block text-sm text-gray-900"></label>
    
                                                </div>
    
                                            </div>
    
                                        </div>
    
                                    </div>
    
                                <div>
    
                                        <label for="facebookLink" class="sr-only">Facebook</label>
    
                                        <div class="flex rounded-md shadow-sm">
    
                                            <span class="inline-flex items-center px-3 rounded-s-md border border-e-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm">
    
                                                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" /></svg>
    
                                            </span>
    
                                            <input type="url" name="facebookLink" id="facebookLink" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-slate-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="https://facebook.com/your-page">
    
                                    </div>
    
                                    </div>
    
                                <div>
    
                                        <label for="instagramLink" class="sr-only">Instagram</label>
    
                                        <div class="flex rounded-md shadow-sm">
    
                                             <span class="inline-flex items-center px-3 rounded-s-md border border-e-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm">
    
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 16c-3.314 0-6-2.686-6-6s2.686-6 6-6 6 2.686 6 6-2.686 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm6-2a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
    
                                            </span>
    
                                            <input type="url" name="instagramLink" id="instagramLink" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-slate-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="https://instagram.com/your-profile">
    
                                    </div>
    
                                </div>
    
                                    <div>
    
                                        <label for="tiktokLink" class="sr-only">TikTok</label>
    
                                        <div class="flex rounded-md shadow-sm">
    
                                             <span class="inline-flex items-center px-3 rounded-s-md border border-e-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm">
    
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-2.43.05-4.84-.94-6.37-2.96-2.2-2.95-2.2-6.82 0-9.78 1.59-2.1 4.3-3.04 6.66-2.49.12.03.24.05.35.08v4.03c-1.11-.35-2.29-.5-3.43-.5-1.72 0-3.34.7-4.52 1.95-1.24 1.3-1.86 3.02-1.86 4.73 0 3.49 2.72 6.36 6.08 6.36 3.35 0 6.08-2.87 6.08-6.36 0-1.52-.57-2.93-1.56-4.02-.98-1.09-2.38-1.68-3.8-1.68-.24 0-.48.01-.7.03v-4.03z" clip-rule="evenodd" /></svg>
    
                                            </span>
    
                                            <input type="url" name="tiktokLink" id="tiktokLink" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-slate-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="https://tiktok.com/@your-profile">
    
                                    </div>

                                </div>

                                <div>
    
                                        <label for="linkedinLink" class="sr-only">LinkedIn</label>
    
                                        <div class="flex rounded-md shadow-sm">
    
                                             <span class="inline-flex items-center px-3 rounded-s-md border border-e-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm">
    
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
    
                                            </span>
    
                                            <input type="url" name="linkedinLink" id="linkedinLink" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-slate-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="https://linkedin.com/in/your-profile">
    
                                    </div>

                                </div>

                                <div>
    
                                        <label for="twitterLink" class="sr-only">X (Twitter)</label>
    
                                        <div class="flex rounded-md shadow-sm">
    
                                             <span class="inline-flex items-center px-3 rounded-s-md border border-e-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm">
    
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
    
                                            </span>
    
                                            <input type="url" name="twitterLink" id="twitterLink" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-slate-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="https://x.com/your-profile">
    
                                    </div>

                                </div>
    
                            </div>
    
                            </fieldset>
    
    
    
    
    
    
                            <fieldset id="design-style-fieldset" class="form-fieldset">
    
                                <legend class="form-legend" data-translate-key="fieldset_design"></legend>
    
                                <div class="space-y-6">
    
                                    <div>
    
                                        <label class="block text-sm font-medium text-slate-700 mb-2" data-translate-key="label_hero_image"></label>
    
                                        <div class="flex items-center">
    
                                            <input type="checkbox" id="use-as-background" name="useAsBackground" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-600">
    
                                            <label for="use-as-background" data-translate-key="label_use_as_background" class="ms-2 block text-sm text-gray-900"></label>
    
        </div>

                                        <p class="text-xs text-slate-500 mt-1" data-translate-key="note_image_upload"></p>
    
                                </div>
    
                                    <div id="accessibility-field-container">
    
                                        <label class="block text-sm font-medium text-slate-700 mb-2" data-translate-key="label_additional_settings"></label>
    
                                         <div class="flex items-center">
    
                                            <span class="text-sm text-gray-600">✅ נגישות (מרכז), AI Bot (ימין) ו-WhatsApp (שמאל) יופיעו אוטומטית בכל הדפים</span>
                            </div>

                                    </div>
    
    
    
                                    <div>
    
                                        <label for="outputLanguage" class="block text-sm font-medium text-slate-700 mb-2" data-translate-key="label_output_language"></label>
    
                                        <select id="outputLanguage" name="outputLanguage" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 shadow">
    
                                            <option value="he">עברית</option>
    
                                            <option value="en">English</option>
                                            <option value="ar">العربية</option>
                                            <option value="ja">日本語</option>
                                            <option value="es">Español</option>
    
                                            <option value="fr">Français</option>
    
                                            <option value="de">Deutsch</option>
                                            <option value="ru">Русский</option>
                                            <option value="zh">中文</option>
                                        </select>
    
                                    </div>
    
    
    
                                    <div>
    
                                        <label class="block text-sm font-medium text-slate-700 mb-2" data-translate-key="label_design_style"></label>
    
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" data-selection="style">
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Minimalist Pro">
    
                                                <div class="h-24 bg-white rounded-lg p-2 flex items-center justify-center border border-slate-200"><div class="w-6 h-6 bg-slate-400 rounded-full"></div></div>
    
                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_minimalist_pro"></p>
    
                                            </div>
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Midnight">
    
                                                <div class="h-24 bg-slate-900 rounded-lg p-2 flex items-center justify-center"><div class="w-6 h-6 bg-indigo-500 rounded-full shadow-lg shadow-indigo-500/50"></div></div>
    
                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_midnight"></p>
    
                                            </div>
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Claymorphism 3D">
    
                                                <div class="h-24 bg-slate-100 rounded-lg p-2 flex items-center justify-center shadow-[inset_3px_3px_8px_#d1d5db,inset_-3px_-3px_8px_#ffffff]"><div class="w-6 h-6 bg-slate-300 rounded-full shadow-[inset_1px_1px_3px_#d1d5db]"></div></div>
    
                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_claymorphism"></p>
    
                                            </div>
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Retro Magazine">
    
                                                <div class="h-24 bg-amber-50 rounded-lg p-2 flex items-center justify-center border border-amber-300"><div class="w-6 h-6 bg-amber-600 rounded-full"></div></div>
    
                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_retro"></p>
    
                                            </div>
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Aurora UI">
    
                                                <div class="h-24 rounded-lg p-2 flex items-center justify-center bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500"><div class="w-6 h-6 bg-white/60 rounded-full backdrop-blur-sm"></div></div>
    
                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_aurora"></p>
    
                                            </div>
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Bento Grid">

                                                <div class="h-24 rounded-lg p-2 bg-slate-50 flex items-center justify-center border border-slate-200 shadow-sm"><div class="w-6 h-6 bg-slate-400 rounded-full"></div></div>

                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_bento"></p>

                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Modern">
                                                <div class="h-24 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-white rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">מודרני</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Minimalist">
                                                <div class="h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-gray-400 rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">מינימליסטי</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Vintage">
                                                <div class="h-24 bg-gradient-to-br from-amber-600 to-orange-700 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-yellow-400 rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">וינטג'</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Luxury">
                                                <div class="h-24 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-white rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">לוקסוס</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Gothic">
                                                <div class="h-24 bg-gradient-to-br from-gray-800 to-black rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white/10 backdrop-blur-md rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-red-600 rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">גותי</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Neon">
                                                <div class="h-24 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-cyan-400 rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">נאון</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Comic">
                                                <div class="h-24 bg-gradient-to-br from-yellow-300 via-red-400 to-blue-500 rounded-lg p-2 flex items-center justify-center border-4 border-black"><div class="h-12 w-3/4 bg-white rounded-lg border-2 border-black flex items-center justify-center"><div class="h-6 w-6 bg-red-500 rounded-full border-2 border-black"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">קומיקס</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Surreal">
                                                <div class="h-24 bg-gradient-to-br from-amber-200 via-teal-300 to-purple-400 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-gradient-to-r from-yellow-200 to-pink-300 rounded-full flex items-center justify-center transform rotate-12"><div class="h-6 w-6 bg-blue-500 rounded-none transform -rotate-45"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">סוריאליסטי</p>
                                            </div>
    
                                        </div>
    
                                    </div>
    
                                </div>
    
                            </fieldset>
    
    
    
                            <div class="flex gap-4 pt-4">
    
                                <button type="button" id="back-to-type-btn" data-translate-key="btn_back" class="w-1/3 bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg hover:bg-slate-300 transition"></button>
    
                                <button type="submit" class="w-2/3 bg-gradient-to-r from-purple-600 to-pink-500 text-white font-bold py-3 px-8 rounded-lg hover:opacity-90 transition-transform duration-300 hover:scale-105 shadow-lg flex items-center justify-center gap-2">
    
                                    <span id="button-text" data-translate-key="btn_generate"></span>
    
                                    <div id="button-loader" class="loader w-6 h-6 rounded-full border-4 border-white hidden"></div>
    
            </button>
    
                    </div>
    
                        </form>
    
            </div>

                </div>
    
            </div>
    
    
    
            <div id="preview-view" class="view fixed inset-0 z-50 bg-gray-800 p-4 md:p-6 lg:p-8">
    
                 <div id="generation-view" class="absolute inset-0 gen-view-container flex flex-col items-center justify-center text-center p-4 hidden"></div>
    
                 <div id="preview-container" class="w-full h-full hidden flex-col relative">
    
                    <iframe id="preview-iframe" class="w-full h-full border-0 bg-white rounded-lg shadow-2xl transition-all duration-300" title="Preview"></iframe>
    
                    
    
                    <!-- כפתורי שמירה והורדה קבועים -->
                    <div class="fixed top-4 right-4 flex gap-3 z-50">
                        <button id="save-page-btn" class="bg-green-600 text-white font-bold p-3 rounded-full hover:bg-green-700 transition shadow-lg" data-translate-title="tooltip_save_page">
                                <i data-lucide="save" class="w-5 h-5"></i>
    
                            </button>
    
                        <button id="download-page-btn" class="bg-blue-600 text-white font-bold p-3 rounded-full hover:bg-blue-700 transition shadow-lg" data-translate-title="tooltip_back_home">
                            <i data-lucide="home" class="w-5 h-5"></i>
                        </button>
                    </div>
    
                    <div id="preview-controls-container">
                        <div id="tools-menu" class="order-1">
                             <button id="back-to-form-btn" class="tool-btn text-white font-bold p-3 rounded-full hover:bg-gray-700 transition" data-translate-title="tooltip_back_to_form">
    
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
    
                            </button>
    
                            <div id="edit-tools-group" class="flex items-center gap-3">
    
                                 <button id="upload-image-btn" class="tool-btn text-white font-bold p-3 rounded-full hover:bg-gray-700 transition" data-translate-title="tooltip_upload_image">
    
                                    <i data-lucide="image-up" class="w-5 h-5"></i>
    
                                </button>
    
                                <button id="delete-image-btn" class="tool-btn text-red-500 font-bold p-3 rounded-full hover:bg-red-700 hover:text-white transition" data-translate-title="tooltip_delete_image" style="display: none;">
    
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
    
                                </button>
    
                                <div class="color-picker-wrapper tool-btn text-white font-bold p-3 rounded-full hover:bg-gray-700 transition" data-translate-title="tooltip_text_color">
    
                                    <i data-lucide="type" class="w-5 h-5"></i>
    
                                    <input type="color" id="text-color-picker" class="color-picker-input">

                            </div>

                                <div class="color-picker-wrapper tool-btn text-white font-bold p-3 rounded-full hover:bg-gray-700 transition" data-translate-title="tooltip_bg_color">
    
                                    <i data-lucide="palette" class="w-5 h-5"></i>
    
                                    <input type="color" id="bg-color-picker" class="color-picker-input">
    
                                </div>
    
                                 <div id="opacity-control" class="hidden items-center gap-2 tool-btn p-2 rounded-full" data-translate-title="tooltip_opacity">
    
                                    <i data-lucide="layers" class="w-5 h-5 text-white"></i>
                                    <input type="range" id="opacity-slider" min="0" max="1" step="0.05" class="w-24 h-2 bg-gray-500 rounded-lg appearance-none cursor-pointer">
    
                                </div>
    
                            </div>
    
                        </div>
    
                        <button id="tools-fab" class="bg-blue-600 text-white font-bold p-4 rounded-full hover:bg-blue-700 transition shadow-lg order-2">
    
                            <i data-lucide="pencil" class="w-6 h-6"></i>
    
                        </button>
    
                    </div>
    
    
    
            </div>
    
            </div>
    
        </div>
    
        
    
        <input type="file" id="iframe-image-uploader" class="hidden" accept="image/*">
    
    
    
    
    
        <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
        <script>
    
            // --- START OF SCRIPT ---
        // --- I18N DATA & CONFIGURATION ---

        const translations = {

            en: {

                main_title: "Hello! What are we building today?",

                main_subtitle: "Choose the base template that best suits your goal.",

                create_page_title: "Create",

                form_subtitle: "Fill in the details and the smart bot will guide you and build a custom page for you.",

                fieldset_basic_details: "Basic Details",

                label_contact_name: "Contact Person / Role",

                label_email: "Contact Email",

                label_phone: "Phone",

                label_description: "General Description",

                label_address: "Physical Address (Optional)",

                fieldset_optional_sections: "Optional Sections",

                fieldset_social_media: "Social Media (Optional)",

                label_youtube_display: "How to display the video?",

                label_youtube_embed: "Embed in page",

                label_youtube_link: "Link only",


                label_cta_text: "Button Text",

                label_cta_link: "Link (Optional)",

                label_cta_style: "Button Style",

                label_cta_position: "Button Position",

                label_enable_countdown: "Add Countdown Timer",

                label_countdown_text: "Text Before Timer",

                label_countdown_date: "End Date",

                label_countdown_time: "End Time",

                fieldset_design: "Design & Settings",

                label_hero_image: "Main Image Settings",

                label_use_as_background: "Use image as background for the main section",

                note_image_upload: "Note: Personal image upload is done in the editing stage, after page creation.",

                label_additional_settings: "Additional Settings",

                label_add_accessibility: "Add accessibility button to the site",

                label_add_ai_bot: "AI Bot (right) and WhatsApp (left) will appear automatically on all pages",
                label_output_language: "Page Language",

                label_design_style: "Choose a Design Style",

                style_minimalist_pro: "Professional & Clean",

                style_midnight: "Dark & Elegant",

                style_claymorphism: "Claymorphism 3D",

                style_retro_title: "Magazine Headline",

                style_retro: "Retro Magazine",

                style_aurora: "Aurora UI",

                style_bento: "Bento Grid",

                btn_back: "Back",

                btn_generate: "Send to Bot & Build",

                modal_close_btn: "Got it",

                modal_error_style: "Please choose a design style.",

                modal_error_layout: "Please choose a layout for the post.",

                modal_error_clip: "Please choose a clip style.",

                modal_error_edit_mode: "Error: Cannot activate edit mode.",

                modal_error_upload_image: "To replace an image, first click on the image or an area with a background image on the page.",

                modal_error_auth: "You must be logged in to save or upload images.",

                modal_error_save: "Error saving page",

                modal_save_success: "Page saved successfully! Redirecting back to your user area...",

                modal_saving: "Saving...",

                modal_processing_image: "Processing and uploading image...",

                modal_image_success: "Image replaced successfully!",

                modal_image_error: "Error uploading image",

                modal_upload_auth_error: "You must be logged in to upload images.",

                modal_url_error: "Could not get the URL of the uploaded image.",

                gen_text_1: "AutoPage bot is creating your page...",

                gen_text_2: "This may take a few minutes...",

                gen_text_3: "Our advanced AI system is analyzing your requirements...",

                gen_text_4: "Applying premium design patterns...",

                gen_error_title: "Oops, an error occurred",

                gen_error_details: "Error details:",

                tooltip_save_page: "Save Page & Exit",

                tooltip_back_home: "Back to home page",
                tooltip_back_to_form: "Back to form",

                tooltip_upload_image: "Upload/Replace image",

                tooltip_text_color: "Change text color",

                tooltip_bg_color: "Change background color",

                tooltip_opacity: "Background overlay opacity",

            },

            he: {

                main_title: "שלום! מה נבנה היום?",

                main_subtitle: "בחר את תבנית הבסיס המתאימה ביותר למטרה שלך.",

                create_page_title: "יצירת",

                form_subtitle: "מלא את הפרטים והבוט החכם ילווה אותך ויבנה עבורך דף מותאם אישית.",

                fieldset_basic_details: "פרטים בסיסיים",

                label_contact_name: "שם איש קשר / תפקיד",

                label_email: "אימייל ליצירת קשר",

                label_phone: "טלפון",

                label_description: "תיאור כללי",

                label_address: "כתובת פיזית (אופציונלי)",

                fieldset_optional_sections: "מקטעים אופציונליים",

                fieldset_social_media: "מדיה ורשתות חברתיות (אופציונלי)",

                label_youtube_display: "איך להציג את הסרטון?",

                label_youtube_embed: "להטמיע בדף",

                label_youtube_link: "רק קישור",


                label_cta_text: "טקסט הכפתור",

                label_cta_link: "קישור (אופציונלי)",

                label_cta_style: "סגנון הכפתור",

                label_cta_position: "מיקום הכפתור",

                label_enable_countdown: "הוסף שעון ספירה לאחור",

                label_countdown_text: "טקסט לפני השעון",

                label_countdown_date: "תאריך סיום",

                label_countdown_time: "שעת סיום",

                fieldset_design: "עיצוב והגדרות",

                label_hero_image: "הגדרות תמונה ראשית",

                label_use_as_background: "השתמש בתמונה כרקע למקטע הראשי",

                note_image_upload: "הערה: העלאת תמונה אישית מתבצעת בשלב העריכה, לאחר יצירת הדף.",

                label_additional_settings: "הגדרות נוספות",

                label_add_accessibility: "הוסף כפתור נגישות לאתר",

                label_add_ai_bot: "AI Bot (ימין) ו-WhatsApp (שמאל) יופיעו אוטומטית בכל הדפים",
                label_output_language: "שפת הדף",

                label_design_style: "בחירת סגנון עיצוב",

                style_minimalist_pro: "מקצועי ונקי",

                style_midnight: "כהה ואלגנטי",

                style_claymorphism: "קליימורפיזם 3D",

                style_retro_title: "כותרת מגזין",

                style_retro: "רטרו מגזין",

                style_aurora: "Aurora UI",

                style_bento: "Bento Grid",

                btn_back: "חזור",

                btn_generate: "שלח לבוט ובנה",

                modal_close_btn: "הבנתי",

                modal_error_style: "אנא בחר סגנון עיצוב.",

                modal_error_layout: "אנא בחר מבנה לפוסט.",

                modal_error_clip: "אנא בחר סגנון חיתוך.",

                modal_error_edit_mode: "שגיאה: לא ניתן להפעיל את מצב העריכה.",

                modal_error_upload_image: "כדי להחליף תמונה, יש ללחוץ תחילה על התמונה או על אזור עם תמונת רקע בעמוד.",

                modal_error_auth: "עליך להיות מחובר כדי לשמור או להעלות תמונות.",

                modal_error_save: "שגיאה בשמירת הדף",

                modal_save_success: "הדף נשמר בהצלחה! מועבר חזרה לאזור המשתמש...",

                modal_saving: "שומר...",

                modal_processing_image: "מעבד ומעלה תמונה...",

                modal_image_success: "התמונה הוחלפה בהצלחה!",

                modal_image_error: "שגיאה בהעלאת התמונה",

                modal_upload_auth_error: "עליך להיות מחובר כדי להעלות תמונות.",

                modal_url_error: "לא ניתן היה לקבל את כתובת התמונה שהועלתה.",

                gen_text_1: "מערכת ה-AI המתקדמת שלנו מנתחת את הדרישות שלך...",

                gen_text_2: "יוצרת ארכיטקטורת קוד מקצועית...",

                gen_text_3: "מיישמת דפוסי עיצוב פרימיום...",

                gen_text_4: "מסיימת את יצירת המופת שלך...",

                gen_error_title: "אופס, התרחשה שגיאה",

                gen_error_details: "פרטי השגיאה:",

                tooltip_save_page: "שמור וצא",

                tooltip_back_home: "חזור לדף הבית",
                tooltip_back_to_form: "חזור לטופס",

                tooltip_upload_image: "העלה/החלף תמונה",
                
                tooltip_delete_image: "מחק תמונה",

                tooltip_text_color: "שנה צבע טקסט",

                tooltip_bg_color: "שנה צבע רקע",

                tooltip_opacity: "שקיפות שכבת הרקע",

            },

            es: {

                main_title: "¡Hola! ¿Qué construimos hoy?",

                main_subtitle: "Elige la plantilla base que mejor se adapte a tu objetivo.",

                create_page_title: "Crear",

                form_subtitle: "Completa los detalles y el bot inteligente te guiará y construirá una página personalizada para ti.",

                fieldset_basic_details: "Detalles Básicos",

                label_contact_name: "Persona de Contacto / Cargo",

                label_email: "Email de Contacto",

                label_phone: "Teléfono",

                label_description: "Descripción General",

                label_address: "Dirección Física (Opcional)",

                fieldset_optional_sections: "Secciones Opcionales",

                fieldset_social_media: "Redes Sociales (Opcional)",

                label_youtube_display: "¿Cómo mostrar el video?",

                label_youtube_embed: "Incrustar en la página",

                label_youtube_link: "Solo enlace",

                fieldset_design: "Diseño y Ajustes",

                label_hero_image: "Ajustes de Imagen Principal",

                label_use_as_background: "Usar imagen como fondo para la sección principal",

                note_image_upload: "Nota: La carga de imágenes personales se realiza en la etapa de edición, después de la creación de la página.",

                label_additional_settings: "Ajustes Adicionales",

                label_add_accessibility: "Añadir botón de accesibilidad al sitio",

                label_add_ai_bot: "AI Bot (derecha) y WhatsApp (izquierda) aparecerán automáticamente en todas las páginas",
                label_output_language: "Idioma de la Página",

                label_design_style: "Elige un Estilo de Diseño",

                style_minimalist_pro: "Profesional y Limpio",

                style_midnight: "Oscuro y Elegante",

                style_claymorphism: "Claymorphism 3D",

                style_retro_title: "Titular de Revista",

                style_retro: "Revista Retro",

                style_aurora: "UI Aurora",

                style_bento: "Bento Grid",

                btn_back: "Atrás",

                btn_generate: "Enviar al Bot y Construir",

                modal_close_btn: "Entendido",

                modal_error_style: "Por favor, elige un estilo de diseño.",

                modal_error_layout: "Por favor, elige un diseño para la publicación.",

                modal_error_clip: "Por favor, elige un estilo de corte.",

                modal_error_edit_mode: "Error: No se puede activar el modo de edición.",

                modal_error_upload_image: "Para reemplazar una imagen, primero haz clic en la imagen o en un área con una imagen de fondo en la página.",

                 modal_error_auth: "Debes iniciar sesión para guardar o subir imágenes.",

                modal_error_save: "Error al guardar la página",

                modal_save_success: "¡Página guardada con éxito! Redirigiendo a tu área de usuario...",

                modal_saving: "Guardando...",

                modal_processing_image: "Procesando y subiendo imagen...",

                modal_image_success: "¡Imagen reemplazada con éxito!",

                modal_image_error: "Error al subir la imagen",

                modal_upload_auth_error: "Debes iniciar sesión para subir imágenes.",

                modal_url_error: "No se pudo obtener la URL de la imagen subida.",

                gen_text_1: "El bot de AutoPage está creando tu página...",

                gen_text_2: "Esto puede tomar unos minutos...",

                gen_text_3: "Nuestro sistema de IA avanzado está analizando tus requisitos...",

                gen_text_4: "Aplicando patrones de diseño premium...",

                gen_error_title: "Vaya, ocurrió un error",

                gen_error_details: "Detalles del error:",

                tooltip_save_page: "Guardar y Salir",

                tooltip_back_home: "Volver a la página principal",
                tooltip_back_to_form: "Volver al formulario",

                tooltip_upload_image: "Subir/Reemplazar imagen",

                tooltip_text_color: "Cambiar color del texto",

                tooltip_bg_color: "Cambiar color de fondo",

                tooltip_opacity: "Opacidad de la capa de fondo",

            },

            fr: {

                main_title: "Bonjour ! Que construisons-nous aujourd'hui ?",

                main_subtitle: "Choisissez le modèle de base qui correspond le mieux à votre objectif.",

                create_page_title: "Créer",

                form_subtitle: "Remplissez les détails et le bot intelligent vous guidera et construira une page personnalisée pour vous.",

                fieldset_basic_details: "Détails de Base",

                label_contact_name: "Personne à Contacter / Rôle",

                label_email: "E-mail de Contact",

                label_phone: "Téléphone",

                label_description: "Description Générale",

                label_address: "Adresse Physique (Optionnel)",

                fieldset_optional_sections: "Sections Optionnelles",

                fieldset_social_media: "Réseaux Sociaux (Optionnel)",

                label_youtube_display: "Comment afficher la vidéo ?",

                label_youtube_embed: "Intégrer dans la page",

                label_youtube_link: "Lien uniquement",

                fieldset_design: "Design & Paramètres",

                label_hero_image: "Paramètres de l'Image Principale",

                label_use_as_background: "Utiliser l'image comme arrière-plan pour la section principale",

                note_image_upload: "Note : Le téléchargement d'image personnelle se fait à l'étape d'édition, après la création de la page.",

                label_additional_settings: "Paramètres Supplémentaires",

                label_add_accessibility: "Ajouter un bouton d'accessibilité au site",

                label_add_ai_bot: "AI Bot (droite) et WhatsApp (gauche) apparaîtront automatiquement sur toutes les pages",
                label_output_language: "Langue de la Page",

                label_design_style: "Choisissez un Style de Design",

                style_minimalist_pro: "Professionnel & Épuré",

                style_midnight: "Sombre & Élégant",

                style_claymorphism: "Claymorphism 3D",

                style_retro_title: "Titre de Magazine",

                style_retro: "Magazine Rétro",

                style_aurora: "UI Aurora",

                style_bento: "Grille Bento",

                btn_back: "Retour",

                btn_generate: "Envoyer au Bot & Construire",

                modal_close_btn: "J'ai compris",

                modal_error_style: "Veuillez choisir un style de design.",

                modal_error_layout: "Veuillez choisir une mise en page pour la publication.",

                modal_error_clip: "Veuillez choisir un style de découpe.",

                modal_error_edit_mode: "Erreur : Impossible d'activer le mode édition.",

                modal_error_upload_image: "Pour remplacer une image, cliquez d'abord sur l'image ou sur une zone avec une image de fond sur la page.",

                modal_error_auth: "Vous devez être connecté pour enregistrer ou télécharger des images.",

                modal_error_save: "Erreur lors de l'enregistrement de la page",

                modal_save_success: "Page enregistrée avec succès ! Redirection vers votre espace utilisateur...",

                modal_saving: "Enregistrement...",

                modal_processing_image: "Traitement et téléversement de l'image...",

                modal_image_success: "Image remplacée avec succès !",

                modal_image_error: "Erreur lors du téléversement de l'image",

                modal_upload_auth_error: "Vous devez être connecté pour télécharger des images.",

                modal_url_error: "Impossible d'obtenir l'URL de l'image téléchargée.",

                gen_text_1: "Le bot AutoPage crée votre page...",

                gen_text_2: "Cela peut prendre quelques minutes...",

                gen_text_3: "Notre système d'IA avancé analyse vos exigences...",

                gen_text_4: "Application de modèles de design premium...",

                gen_error_title: "Oups, une erreur est survenue",

                gen_error_details: "Détails de l'erreur :",

                tooltip_save_page: "Enregistrer & Quitter",

                tooltip_back_home: "Retour à la page d'accueil",
                tooltip_back_to_form: "Retour au formulaire",

                tooltip_upload_image: "Télécharger/Remplacer l'image",

                tooltip_text_color: "Changer la couleur du texte",

                tooltip_bg_color: "Changer la couleur de fond",

                tooltip_opacity: "Opacité du calque de fond",

            }

        };



        const countries = [

            { name: "Israel (+972)", code: "972" },

            { name: "USA (+1)", code: "1" },

            { name: "UK (+44)", code: "44" },

            { name: "France (+33)", code: "33" },

            { name: "Spain (+34)", code: "34" },

            { name: "Germany (+49)", code: "49" },

        ];
        // --- CORE DATA & CONFIGURATION ---

        const pageTemplates = {

            // 1. דף נחיתה - ראשון
            landing: {

                img: "https://images.unsplash.com/photo-1552664730-d307ca884978?q=80&w=2070&auto=format&fit=crop",

                fields: ['websiteLink', 'branches'],

                structurePrompt: `Build a landing page with only the following sections, in this order: 1. A simple Header containing the provided external links ('Main Link', 'Additional External Link') as text links or small buttons on the side. 2. Hero Section (id="home") with a headline, description, and a central CTA button. 3. Benefits section (id="benefits") with 3 key benefits. 4. Contact form section (id="contact").`,

                t: {

                    en: { title: "Landing Page", label: "Campaign Name", description: "A focused page for conversions and lead collection.", guidance: "<b>Landing Page</b> is a focused page designed to make a visitor perform a single action, like leaving details or making a purchase." },

                    he: { title: "דף נחיתה", label: "שם הקמפיין", description: "דף ממוקד להמרות ואיסוף לידים.", guidance: "<b>דף נחיתה</b> הוא דף ממוקד שנועד לגרום למבקר לבצע פעולה אחת, כמו השארת פרטים או רכישה." },

                    ar: { title: "صفحة هبوط", label: "اسم الحملة", description: "صفحة مركزة للتحويل وجمع العملاء المحتملين.", guidance: "<b>صفحة الهبوط</b> هي صفحة مركزة مصممة لجعل الزائر يقوم بعمل واحد، مثل ترك التفاصيل أو إجراء عملية شراء." },
                    ja: { title: "ランディングページ", label: "キャンペーン名", description: "コンバージョンとリード収集に焦点を当てたページ。", guidance: "<b>ランディングページ</b>は、訪問者が詳細を残したり購入したりするなどの単一のアクションを実行するよう設計された集中ページです。" },
                    es: { title: "Página de Aterrizaje", label: "Nombre de la Campaña", description: "Una página enfocada en conversiones y captación de leads.", guidance: "Una <b>Página de Aterrizaje</b> es una página enfocada diseñada para que un visitante realice una sola acción, como dejar sus datos o realizar una compra." },

                    fr: { title: "Page d'Atterrissage", label: "Nom de la Campagne", description: "Une page ciblée pour les conversions et la collecte de prospects.", guidance: "Une <b>Page d'Atterrissage</b> est une page ciblée conçue pour inciter un visiteur à effectuer une seule action, comme laisser ses coordonnées ou faire un achat." },
                    de: { title: "Landing Page", label: "Kampagnenname", description: "Eine fokussierte Seite für Konversionen und Lead-Sammlung.", guidance: "Eine <b>Landing Page</b> ist eine fokussierte Seite, die darauf ausgelegt ist, einen Besucher zu einer einzigen Aktion zu veranlassen, wie das Hinterlassen von Details oder einen Kauf." },
                    ru: { title: "Целевая Страница", label: "Название Кампании", description: "Сфокусированная страница для конверсий и сбора лидов.", guidance: "<b>Целевая Страница</b> - это сфокусированная страница, предназначенная для того, чтобы посетитель выполнил одно действие, например, оставил данные или совершил покупку." },
                    zh: { title: "着陆页", label: "活动名称", description: "专注于转化和潜在客户收集的页面。", guidance: "<b>着陆页</b>是一个专注的页面，旨在让访问者执行单一操作，如留下详细信息或进行购买。" }
                }

            },

            // דף מוצר - מתמקד במוצר בלבד
            product: {
                img: "https://images.unsplash.com/photo-1560472354-b33ff0c44a43?q=80&w=2126&auto=format&fit=crop",
                fields: ['productDetails', 'productGallery', 'branches'],
                structurePrompt: `Build a product-focused page with only the following sections: 1. Header with product name. 2. Hero section with product image and key features. 3. Product details section with specifications. 4. Gallery section with multiple product images. 5. Purchase section with pricing and CTA. 6. Contact section.`,
                t: {
                    en: { title: "Product Page", label: "Product Name", description: "A focused page showcasing a single product.", guidance: "A <b>Product Page</b> is designed to showcase one specific product with maximum impact and conversion focus." },
                    he: { title: "דף מוצר", label: "שם המוצר", description: "דף ממוקד המציג מוצר יחיד.", guidance: "<b>דף מוצר</b> נועד להציג מוצר ספציפי אחד עם השפעה מקסימלית ומיקוד המרות." }
                }
            },

            general: {

                img: "https://images.unsplash.com/photo-1556761175-5973dc0f32e7?q=80&w=1932&auto=format&fit=crop",

                fields: ['websiteLink', 'branches'],

                 structurePrompt: `Build a brand page with only the following sections, in this order: 1. Header with a logo and navigation. In the navigation, include internal links to relevant sections (About, Services, Contact) and also the provided external links ('Main Link', 'Additional External Link'). If button text is provided, use it. The external links should be prominent, perhaps as buttons. 2. Hero Section (id="home"). 3. About section (id="about"). 4. Services section (id="services"). 5. Contact section (id="contact"). 6. Footer.`,

                t: {

                    en: { title: "Brand Page", label: "Business Name", description: "Showcase your business to the world.", guidance: "A <b>Brand Page</b> is like your expanded digital business card. Its purpose is to present your business, services, and story professionally." },

                    he: { title: "דף תדמית", label: "שם העסק", description: "הצג את העסק שלך לעולם.", guidance: "<b>דף תדמית</b> הוא כמו כרטיס הביקור הדיגיטלי המורחב שלך. מטרתו להציג את העסק, השירותים והסיפור שלך בצורה מקצועית." },

                    ar: { title: "صفحة العلامة التجارية", label: "اسم العمل", description: "اعرض عملك للعالم.", guidance: "<b>صفحة العلامة التجارية</b> مثل بطاقة العمل الرقمية الموسعة. هدفها هو تقديم عملك وخدماتك وقصتك بشكل مهني." },
                    ja: { title: "ブランドページ", label: "ビジネス名", description: "あなたのビジネスを世界に紹介しましょう。", guidance: "<b>ブランドページ</b>は、拡張されたデジタル名刺のようなものです。その目的は、あなたのビジネス、サービス、ストーリーを専門的に提示することです。" },
                     es: { title: "Página de Marca", label: "Nombre del Negocio", description: "Muestra tu negocio al mundo.", guidance: "Una <b>Página de Marca</b> es como tu tarjeta de visita digital ampliada. Su propósito es presentar tu negocio, servicios e historia de manera profesional." },

                    fr: { title: "Page de Marque", label: "Nom de l'Entreprise", description: "Présentez votre entreprise au monde.", guidance: "Une <b>Page de Marque</b> est comme votre carte de visite numérique étendue. Son but est de présenter votre entreprise, vos services et votre histoire de manière professionnelle." },
                    de: { title: "Markenseite", label: "Geschäftsname", description: "Präsentieren Sie Ihr Geschäft der Welt.", guidance: "Eine <b>Markenseite</b> ist wie Ihre erweiterte digitale Visitenkarte. Ihr Zweck ist es, Ihr Geschäft, Ihre Dienstleistungen und Ihre Geschichte professionell zu präsentieren." },
                    ru: { title: "Страница Бренда", label: "Название Бизнеса", description: "Покажите свой бизнес миру.", guidance: "<b>Страница Бренда</b> - это как ваша расширенная цифровая визитная карточка. Её цель - профессионально представить ваш бизнес, услуги и историю." },
                    zh: { title: "品牌页面", label: "企业名称", description: "向世界展示您的企业。", guidance: "<b>品牌页面</b>就像您扩展的数字名片。它的目的是专业地展示您的企业、服务和故事。" }
                }

            },

            post: {

                img: "https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=2071&auto=format&fit=crop",

                fields: ['postLayout'],

                structurePrompt: {

                    base: `...`, 

                    layouts: {

                       "Partial Cover": `...`,

                       "Full Image Background": `...`,

                       "Bold Poster": `...`,

                    }

                },

                t: {

                    en: { title: "Marketing Post", label: "Post Title", description: "A visual post for social media." },

                    he: { title: "פוסט שיווקי", label: "כותרת הפוסט", description: "פוסט ויזואלי לרשתות חברתיות." },

                    ar: { title: "منشور تسويقي", label: "عنوان المنشور", description: "منشور بصري لوسائل التواصل الاجتماعي." },
                    ja: { title: "マーケティング投稿", label: "投稿タイトル", description: "ソーシャルメディア用のビジュアル投稿。" },
                    es: { title: "Publicación de Marketing", label: "Título de la Publicación", description: "Una publicación visual para redes sociales." },

                    fr: { title: "Publication Marketing", label: "Titre de la Publication", description: "Une publication visuelle pour les réseaux sociaux." },
                    de: { title: "Marketing-Beitrag", label: "Beitragstitel", description: "Ein visueller Beitrag für soziale Medien." },
                    ru: { title: "Маркетинговый Пост", label: "Заголовок Поста", description: "Визуальный пост для социальных сетей." },
                    zh: { title: "营销帖子", label: "帖子标题", description: "用于社交媒体的视觉帖子。" }
                }

            },

            restaurantMenu: {

                img: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=2070&auto=format&fit=crop",

                fields: ['menuCategories', 'branches'],

                structurePrompt: `Build a restaurant menu page with the following sections only: 1. Header (id="header") with the business name. 2. Hero section with restaurant atmosphere. 3. Menu categories with items, prices, descriptions, and "Add to Cart" buttons - USE THE EXACT MENU DATA PROVIDED IN THE PROMPT. 4. Cart placeholder (id="cart-placeholder") - DO NOT create actual cart HTML. 5. Delivery information section. 6. Contact details and WhatsApp button.`,

                t: {

                    en: { title: "Restaurant Menu", label: "Restaurant Name", description: "Create a restaurant menu with online ordering.", guidance: "A <b>Restaurant Menu</b> includes categories, items with prices, and online ordering functionality." },

                    he: { title: "תפריט מסעדה", label: "שם המסעדה", description: "צור תפריט מסעדה עם הזמנות מקוונות.", guidance: "<b>תפריט מסעדה</b> כולל קטגוריות, פריטים עם מחירים ופונקציונליות הזמנות מקוונות." },

                    ar: { title: "قائمة المطعم", label: "اسم المطعم", description: "إنشاء قائمة مطعم مع طلب عبر الإنترنت.", guidance: "<b>قائمة المطعم</b> تشمل الفئات والعناصر مع الأسعار ووظائف الطلب عبر الإنترنت." },
                    ja: { title: "レストランメニュー", label: "レストラン名", description: "オンライン注文付きのレストランメニューを作成します。", guidance: "<b>レストランメニュー</b>には、カテゴリー、価格付きアイテム、オンライン注文機能が含まれます。" },
                    es: { title: "Menú de Restaurante", label: "Nombre del Restaurante", description: "Crear un menú de restaurante con pedidos en línea.", guidance: "Un <b>Menú de Restaurante</b> incluye categorías, elementos con precios y funcionalidad de pedidos en línea." },
                    fr: { title: "Menu Restaurant", label: "Nom du Restaurant", description: "Créer un menu de restaurant avec commande en ligne.", guidance: "Un <b>Menu Restaurant</b> inclut des catégories, des éléments avec des prix et une fonctionnalité de commande en ligne." },
                    de: { title: "Restaurant-Menü", label: "Restaurantname", description: "Erstellen Sie ein Restaurant-Menü mit Online-Bestellung.", guidance: "Ein <b>Restaurant-Menü</b> umfasst Kategorien, Artikel mit Preisen und Online-Bestellfunktionalität." },
                    ru: { title: "Меню Ресторана", label: "Название Ресторана", description: "Создать меню ресторана с онлайн-заказом.", guidance: "<b>Меню Ресторана</b> включает категории, элементы с ценами и функциональность онлайн-заказа." },
                    zh: { title: "餐厅菜单", label: "餐厅名称", description: "创建带在线订购功能的餐厅菜单。", guidance: "<b>餐厅菜单</b>包括类别、带价格的商品和在线订购功能。" }
                }

            },

            flyer: {

                img: "https://images.unsplash.com/photo-1555939594-58d7cb561ad1?q=80&w=1887&auto=format&fit=crop",

                fields: [],

                structurePrompt: `Build a marketing flyer/post with the following sections only: 1. Header (id="header") with the business name. 2. Main promotional content with visual elements. 3. Contact details and address as plain text (not links). This is for VISUAL DISPLAY ONLY - no ordering functionality.`,

                t: {

                    en: { title: "Marketing Flyer", label: "Business Name", description: "Create a marketing flyer or promotional post.", guidance: "A <b>Marketing Flyer</b> is designed for visual display and promotion, not for online ordering." },

                    he: { title: "פלאייר שיווקי", label: "שם העסק", description: "צור פלאייר שיווקי או פוסט פרסומי.", guidance: "<b>פלאייר שיווקי</b> נועד לתצוגה ויזואלית ופרסום, לא להזמנות מקוונות." },

                    ar: { title: "قائمة / نشرة", label: "اسم العمل / المطعم", description: "اعرض المنتجات أو الأطباق بصرياً.", guidance: "<b>القائمة أو النشرة</b> مصممة لعرض المعلومات بوضوح ومقروئية، مقسمة إلى فئات وعناصر." },
                    ja: { title: "メニュー / チラシ", label: "ビジネス名 / レストラン名", description: "製品や料理を視覚的に表示します。", guidance: "<b>メニューやチラシ</b>は、情報を明確で読みやすく提示するよう設計されており、カテゴリーとアイテムに分かれています。" },
                    es: { title: "Menú / Folleto", label: "Nombre del Negocio / Restaurante", description: "Muestra productos o platos visualmente.", guidance: "Un <b>Menú o Folleto</b> está diseñado para presentar información de forma clara y legible, dividida en categorías y artículos." },

                    fr: { title: "Menu / Flyer", label: "Nom de l'Entreprise / Restaurant", description: "Affichez des produits ou des plats de manière visuelle.", guidance: "Un <b>Menu ou Flyer</b> est conçu pour présenter des informations de manière claire et lisible, divisé en catégories et articles." },
                    de: { title: "Menü / Flyer", label: "Geschäftsname / Restaurantname", description: "Zeigen Sie Produkte oder Gerichte visuell an.", guidance: "Ein <b>Menü oder Flyer</b> ist darauf ausgelegt, Informationen klar und lesbar zu präsentieren, unterteilt in Kategorien und Artikel." },
                    ru: { title: "Меню / Листовка", label: "Название Бизнеса / Ресторана", description: "Визуально отображайте продукты или блюда.", guidance: "<b>Меню или Листовка</b> предназначены для четкого и разборчивого представления информации, разделенной на категории и элементы." },
                    zh: { title: "菜单 / 传单", label: "企业名称 / 餐厅名称", description: "视觉展示产品或菜肴。", guidance: "<b>菜单或传单</b>旨在清晰易读地呈现信息，分为类别和项目。" }
                }

            },

            product: {

                img: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=1999&auto=format&fit=crop",

                fields: ['pricing'],

                structurePrompt: `Build a product page with the following sections only: 1. Main section (id="home") with a product image, name, price, and a purchase button. 2. Detailed description section (id="description").`,

                t: {

                    en: { title: "Product Page", label: "Product Name", description: "Sell a specific product.", guidance: "A <b>Product Page</b> focuses on a single product, showcasing its features and benefits to lead to a purchase." },

                    he: { title: "דף מוצר", label: "שם המוצר", description: "מכור מוצר ספציפי.", guidance: "<b>דף מוצר</b> מתמקד במוצר אחד, מציג את התכונות והתועלות שלו במטרה להוביל לרכישה." },

                    es: { title: "Página de Producto", label: "Nombre del Producto", description: "Vende un producto específico.", guidance: "Una <b>Página de Producto</b> se centra en un solo producto, mostrando sus características y beneficios para conducir a una compra." },

                    fr: { title: "Page Produit", label: "Nom du Produit", description: "Vendez un produit spécifique.", guidance: "Une <b>Page Produit</b> se concentre sur un seul produit, mettant en valeur ses caractéristiques et avantages pour inciter à l'achat." }

                }

            },

            artist: {

                img: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=2070&auto=format&fit=crop",

                fields: ['websiteLink'],

                structurePrompt: `Build an artist page with the following sections only: 1. Header with internal navigation (Biography, Gallery, Contact) and also the provided external links ('Main Link', 'Additional External Link'). 2. Hero Section (id="home") with a picture and the artist's name. 3. Biography section (id="bio"). 4. Works gallery (id="gallery"). 5. Contact details (id="contact").`,

                t: {

                    en: { title: "Artist Page", label: "Artist Name", description: "Promote yourself and your work.", guidance: "An <b>Artist Page</b> is a digital portfolio, showcasing your creations and personal story." },

                    he: { title: "דף אומן", label: "שם האומן", description: "קדם את עצמך ואת היצירה שלך.", guidance: "<b>דף אומן</b> הוא תיק עבודות דיגיטלי, המציג את היצירות שלך ואת הסיפור האישי שלך." },

                    es: { title: "Página de Artista", label: "Nombre del Artista", description: "Promociónate a ti mismo y a tu trabajo.", guidance: "Una <b>Página de Artista</b> es un portafolio digital, que muestra tus creaciones y tu historia personal." },

                    fr: { title: "Page d'Artiste", label: "Nom de l'Artiste", description: "Faites votre promotion et celle de votre travail.", guidance: "Une <b>Page d'Artiste</b> est un portfolio numérique, présentant vos créations et votre histoire personnelle." }

                }

            },

            businessCard: {

                img: "https://images.unsplash.com/photo-1560250097-0b93528c311a?q=80&w=1887&auto=format&fit=crop",

                fields: [],

                structurePrompt: `Build a digital business card designed as a single central card (id="vcard"). It must contain a picture, name, title, short description, and clear action buttons for contact.`,

                t: {

                    en: { title: "Digital Business Card", label: "Your Name", description: "A personal, focused, and impressive page.", guidance: "A <b>Digital Business Card</b> is a simple and focused page, centralizing all your contact methods in one place." },

                    he: { title: "כרטיס ביקור דיגיטלי", label: "השם שלך", description: "דף אישי, ממוקד ומרשים.", guidance: "<b>כרטיס ביקור דיגיטלי</b> הוא דף פשוט וממוקד, המרכז את כל דרכי יצירת הקשר איתך במקום אחד." },

                    es: { title: "Tarjeta de Visita Digital", label: "Tu Nombre", description: "Una página personal, enfocada e impresionante.", guidance: "Una <b>Tarjeta de Visita Digital</b> es una página simple y enfocada, que centraliza todos tus métodos de contacto en un solo lugar." },

                    fr: { title: "Carte de Visite Numérique", label: "Votre Nom", description: "Une page personnelle, ciblée et impressionnante.", guidance: "Une <b>Carte de Visite Numérique</b> est une page simple et ciblée, centralisant toutes vos méthodes de contact en un seul endroit." }

                }

            },

            event: {

                img: "https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?q=80&w=1887&auto=format&fit=crop",

                fields: ['eventDetails', 'branches'],

                structurePrompt: `Build an event invitation with the following sections: 
1. Hero Section (id="home") with the event name and date
2. Countdown Timer (id="countdown-timer") - Display 3 boxes from RIGHT to LEFT: Days (id="days"), Hours (id="hours"), Minutes (id="minutes"). Use the Event Date from form data to calculate countdown. Style with gradient background and large numbers. Add JavaScript to update every minute.
3. Event details (id="details") with location, time, and additional information
4. RSVP form (id="rsvp") with fields: name, phone, email, number of guests (+1, +2, etc), notes`,

                t: {

                    en: { title: "Event Invitation", label: "Event Name", description: "Invite people to a special event.", guidance: "An <b>Event Invitation</b> is a page designed to create excitement and provide all important information for an upcoming event." },

                    he: { title: "הזמנה לאירוע", label: "שם האירוע", description: "הזמן אנשים לאירוע מיוחד.", guidance: "<b>הזמנה לאירוע</b> היא דף שנועד לייצר התרגשות ולספק את כל המידע החשוב לקראת אירוע קרוב." },

                    es: { title: "Invitación a Evento", label: "Nombre del Evento", description: "Invita a gente a un evento especial.", guidance: "Una <b>Invitación a Evento</b> es una página diseñada para crear expectación y proporcionar toda la información importante para un próximo evento." },

                    fr: { title: "Invitation à un Événement", label: "Nom de l'Événement", description: "Invitez des personnes à un événement spécial.", guidance: "Une <b>Invitation à un Événement</b> est une page conçue pour susciter l'enthousiasme et fournir toutes les informations importantes pour un événement à venir." }

                }

            },

            onlineCourse: {

                img: "https://images.unsplash.com/photo-1501504905252-473c47e087f8?q=80&w=2074&auto=format&fit=crop",

                fields: ['courseManagement', 'websiteLink', 'branches'],

                structurePrompt: `Build a professional online course platform with modern design aesthetic. Create a platform that looks like Udemy or Coursera.

**ABSOLUTELY CRITICAL - YOU MUST INCLUDE THIS EXACT META TAG IN THE <head> SECTION:**
<meta name="page-type" content="course">

**REQUIRED SECTIONS:**
1. **Header** (sticky navigation): 
   - Platform logo/name: \${data.mainName || 'Course Platform'}
   - Clean, modern navigation links
   - ⚠️ DO NOT ADD CART ICON TO HEADER - the cart button is separate
   
2. **Hero Section**: Choose ONE compelling hero layout:
   - Option A: Full-width banner with featured course + "התחל ללמוד" CTA
   - Option B: Split-screen with promotional text and course preview
   - Option C: Slider with 2-3 featured courses
   - Option D: Grid showcase of popular courses

3. **Course Catalog** (id="courses"): 
   
   ⚠️⚠️⚠️ ABSOLUTELY CRITICAL - READ CAREFULLY ⚠️⚠️⚠️
   
   **YOU WILL RECEIVE A LIST OF COURSES IN THE PROMPT BELOW THIS TEMPLATE.**
   **DO NOT CREATE YOUR OWN COURSES - ONLY USE THE COURSES PROVIDED!**
   
   The courses will be listed in a section that starts with "📚 **DIGITAL COURSES**"
   
   For EACH course listed in that section, create ONE beautiful course card with:
   - **🎥 VIDEO PREVIEW WITH LOCK (CRITICAL):**
     * Extract YouTube video ID from the provided video URL
     * Display YouTube thumbnail: https://img.youtube.com/vi/VIDEO_ID/maxresdefault.jpg
     * Add semi-transparent dark overlay (rgba(0,0,0,0.7))
     * Center a large lock icon 🔒 with text "נעול - צפה לאחר רכישה"
     * On click: show alert "יש לרכוש את הקורס תחילה כדי לצפות"
     * After purchase: replace with embedded YouTube player using the exact video URL provided
   - Course title: **USE THE EXACT NAME PROVIDED** (do NOT make up course names!)
   - Course description: **USE THE EXACT DESCRIPTION PROVIDED** (do NOT write your own!)
   - Instructor name (generate professional Hebrew name like: ד"ר יוסי כהן, מרב לוי, etc.)
   - Course stats (generate realistic):
     * Duration: "2.5 שעות" / "45 דקות" / "3 שעות" etc.
     * Lessons: "12 שיעורים" / "8 מפגשים" / "15 פרקים" etc.
     * Level: "מתחילים" / "מתקדמים" / "כולם"
   - Price display: **USE THE EXACT PRICE PROVIDED** (format: ₪XX)
   - "רכוש את הקורס" button with the exact onclick code provided for that course
   - Hover effects (scale, shadow, lift animation, etc.)
   
   ❌ DO NOT create 3, 6, or any fixed number of courses
   ✅ CREATE EXACTLY AS MANY COURSE CARDS AS PROVIDED IN THE DATA
   
   Choose ONE grid layout:
     * Option A: Classic grid (3 columns)
     * Option B: Masonry layout
     * Option C: Featured + grid (1 large + smaller ones)
     * Option D: Carousel/slider format

4. **Cart Placeholders** (⚠️ CRITICAL - ONLY ADD THESE SIMPLE PLACEHOLDERS ⚠️):
   
   ⚠️⚠️⚠️ DO NOT CREATE CART HTML - ONLY PLACEHOLDERS ⚠️⚠️⚠️
   ⚠️⚠️⚠️ THE JAVASCRIPT WILL BUILD THE CART AUTOMATICALLY ⚠️⚠️⚠️
   
   **ADD THESE EXACT 3 LINES ONLY - NOTHING MORE:**
   
<div id="cart-sidebar"></div>
<div id="cart-overlay"></div>
<div id="cart-button-placeholder"></div>
   
   **ABSOLUTELY FORBIDDEN:**
   - ❌ DO NOT add ANY cart icons to the header/navigation
   - ❌ DO NOT add ANY floating buttons
   - ❌ DO NOT add ANY badges or counters
   - ❌ DO NOT add ANY inline styles to these divs
   - ❌ DO NOT add ANY content inside these divs
   - ❌ DO NOT create <button> for cart
   - ❌ DO NOT add cart-related elements anywhere else in the page
   
   **ONLY THESE 3 EMPTY DIVS - THE REST IS HANDLED BY JAVASCRIPT**

5. **Trust Indicators**:
   - "למידה מכל מקום", "תעודת השלמה", "גישה לכל החיים"

6. **Contact/Footer**: Platform info, contact, social media

**VISUAL EXCELLENCE:**
- Course cards must be gorgeous with hover effects
- Use consistent spacing and alignment
- Add "חדש" or "פופולרי" badges where appropriate
- Beautiful checkout button in cart
- Mobile-responsive grid (1 col on mobile, 2-3 on desktop)

**AFTER PURCHASE - VIDEO ACCESS:**
After a user purchases a course, they should be able to access the course videos. The page should check if the user has purchased the course (from localStorage: \`purchasedCourses\`) and if so, display the video player with all course videos.

CRITICAL: NO "ניהול" or "Management" buttons anywhere. Return complete valid HTML starting with <!DOCTYPE html>.`,

                t: {

                    en: { title: "Digital Courses", label: "Platform Name", description: "Sell online courses with video content.", guidance: "A <b>Digital Course Platform</b> is for selling pre-recorded video courses with instant access after purchase." },

                    he: { title: "קורסים דיגיטליים", label: "שם הפלטפורמה", description: "מכור קורסים מקוונים עם תוכן וידאו.", guidance: "<b>פלטפורמת קורסים דיגיטליים</b> מיועדת למכירת קורסי וידאו מוקלטים עם גישה מיידית לאחר רכישה." },

                    es: { title: "Cursos Digitales", label: "Nombre de la Plataforma", description: "Vende cursos en línea con contenido de video.", guidance: "Una <b>Plataforma de Cursos Digitales</b> es para vender cursos de video pregrabados con acceso instantáneo después de la compra." },

                    fr: { title: "Cours Numériques", label: "Nom de la Plateforme", description: "Vendez des cours en ligne avec du contenu vidéo.", guidance: "Une <b>Plateforme de Cours Numériques</b> est destinée à la vente de cours vidéo préenregistrés avec accès instantané après l'achat." }

                }

            },

            liveWorkshop: {

                img: "https://images.unsplash.com/photo-1540317580384-e5d43616b9aa?q=80&w=2074&auto=format&fit=crop",

                fields: ['workshopDetails', 'websiteLink', 'branches'],

                structurePrompt: `Build a beautiful, professional workshop/webinar landing page with modern design aesthetic.

**REQUIRED SECTIONS:**
1. **Header** with navigation containing the provided external links ('Main Link', 'Additional External Link').

2. **Hero Section** (id="home"): Choose ONE compelling hero layout:
   - Option A: Full-width banner with workshop image + "הירשם עכשיו" CTA
   - Option B: Split-screen with promotional text and instructor photo
   - Option C: Centered with animated gradient background
   - Option D: Video background with overlay

Include: Workshop/Webinar name, tagline, date & time prominently displayed, instructor name.

3. **Countdown Timer** (id="countdown-timer"): Beautiful, animated countdown with elements having IDs: days, hours, minutes, seconds. 
   **CRITICAL**: For Hebrew, display order MUST be RIGHT-TO-LEFT: days, hours, minutes, seconds.
   Style variations: 
   - Circular timers with animations
   - Card-based counters with shadows
   - Minimalist numbers with labels

4. **About the Workshop** (id="about"): Detailed description of what participants will learn.

5. **About the Instructor** (id="instructor"): 
   - **Circular** image (class="rounded-full")
   - Instructor's name (from data)
   - Bio and credentials

6. **Who Should Attend** (id="for-whom"): Target audience description.

7. **Workshop Details** (id="details"): 
   - Date and time
   - Location (physical address or "אונליין" for webinar)
   - Duration
   - Language

8. **Registration Form** (id="registration"): Beautiful form that matches the design. 
   Fields: name, email, phone, company (optional), message (optional)
   Submit button: "הירשם לוובינר" or "הירשם לקורס"
   
   **FORM MUST:**
   - Send data to /api/leads endpoint using fetch() POST
   - Include pageId and userId from URL
   - Show success message after submission
   - NOT use WhatsApp for registration

9. **Trust Indicators**: Testimonials from previous participants, number of attendees, certifications offered.

10. **Footer**: Contact info, social media, legal links.

**VISUAL EXCELLENCE:**
- Modern, professional design
- Clear hierarchy emphasizing CTA
- Mobile-responsive
- Smooth animations
- Trust-building elements throughout

Return complete valid HTML starting with <!DOCTYPE html>.`,

                t: {

                    en: { title: "Workshop/Webinar", label: "Workshop Name", description: "Promote and register for live workshops or webinars.", guidance: "A <b>Workshop/Webinar Page</b> is designed to promote a live learning event and collect registrations." },

                    he: { title: "וובינר/קורס פרונטלי", label: "שם הקורס", description: "קדם והרשם לסדנאות או וובינרים חיים.", guidance: "<b>דף וובינר/קורס פרונטלי</b> נועד לקדם אירוע למידה חי ולאסוף הרשמות." },

                    es: { title: "Taller/Webinar", label: "Nombre del Taller", description: "Promociona e inscribe a talleres o webinars en vivo.", guidance: "Una <b>Página de Taller/Webinar</b> está diseñada para promocionar un evento de aprendizaje en vivo y recopilar inscripciones." },

                    fr: { title: "Atelier/Webinaire", label: "Nom de l'Atelier", description: "Faites la promotion et inscrivez-vous à des ateliers ou webinaires en direct.", guidance: "Une <b>Page d'Atelier/Webinaire</b> est conçue pour promouvoir un événement d'apprentissage en direct et collecter des inscriptions." }

                }

            },

            portfolio: {

                img: "https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=2070&auto=format&fit=crop",

                fields: ['websiteLink'],

                structurePrompt: "Build a portfolio page with the following sections: 1. Header with navigation. 2. Hero Section (id='home') with a professional statement. 3. 'Featured Projects' section (id='projects') with a visual gallery of works. 4. 'Services' or 'Skills' section (id='skills'). 5. 'About' section (id='about'). 6. Contact section (id='contact').",

                t: {

                    en: { title: "Portfolio", label: "Your Name / Agency Name", description: "Showcase your projects and skills.", guidance: "A <b>Portfolio</b> is where you display your best work, tell your story, and attract new clients." },

                    he: { title: "תיק עבודות", label: "השם שלך / שם הסוכנות", description: "הצג את הפרויקטים והכישורים שלך.", guidance: "<b>תיק עבודות</b> הוא המקום להציג את העבודות הטובות ביותר שלך, לספר על עצמך ולמשוך לקוחות חדשים." },

                    es: { title: "Portafolio", label: "Tu Nombre / Nombre de la Agencia", description: "Muestra tus proyectos y habilidades.", guidance: "Un <b>Portafolio</b> es donde muestras tu mejor trabajo, cuentas tu historia y atraes a nuevos clientes." },

                    fr: { title: "Portfolio", label: "Votre Nom / Nom de l'Agence", description: "Présentez vos projets et vos compétences.", guidance: "Un <b>Portfolio</b> est l'endroit où vous présentez votre meilleur travail, racontez votre histoire et attirez de nouveaux clients." }

                }

            },

            realEstate: {

                img: "https://images.unsplash.com/photo-1560518883-ce09059eeffa?q=80&w=1973&auto=format&fit=crop",

                fields: ['propertyGallery', 'branches'],

                structurePrompt: `Build a stunning real estate properties showcase page with the following sections:

**REQUIRED SECTIONS:**

1. **Header** (id="header"): Clean header with agency name and navigation

2. **Hero Section** (id="home"): 
   - Agency name with real estate icon 🏠
   - Tagline: "מצא את הבית המושלם שלך"
   - Hero background image

3. **Properties Gallery** (id="properties-gallery"): 
   - **MANDATORY: Display ALL properties in a responsive grid (2-3 columns)**
   - **Each property card MUST include:**
     - Main property image (clickable)
     - Property address/title
     - Price (₪XX format)
     - Key specs: 🛏️ X חדרים | 🚿 X אמבטיות | 📐 X מ"ר
     - **"צור קשר לביקור בנכס" button** (NOT "קנה עכשיו")
     - onclick="openPropertyGallery(propertyIndex)" on the card/image
   
4. **Property Popup Modal** (id="property-modal"):
   - **MANDATORY: Hidden by default (display: none)**
   - **Full-screen overlay with property gallery**
   - **Image slider/carousel showing ALL property images**
   - Property details (address, price, specs, description)
   - **Navigation arrows (prev/next)**
   - **Close button (X)**
   - **"צור קשר לביקור" button with WhatsApp link**

5. **About Agency** (id="about"): Agency description and experience

6. **Contact Section** (id="contact"): 
   - Contact form for property inquiries
   - Phone number (clickable)
   - Email
   - Office address

**🚨 CRITICAL JAVASCRIPT FOR PROPERTY GALLERY:**

\`\`\`javascript
// Property data structure (MUST be populated with actual property data)
const properties = [
  {
    id: 1,
    title: "דירת גן מרווחת בתל אביב",
    address: "רחוב הרצל 123, תל אביב",
    price: "3,500,000",
    beds: 4,
    baths: 2,
    sqft: 120,
    description: "דירת גן מרווחה ומוארת...",
    images: [
      "image1.jpg",
      "image2.jpg",
      "image3.jpg",
      "image4.jpg"
    ]
  },
  // ... more properties
];

let currentProperty = null;
let currentImageIndex = 0;

function openPropertyGallery(propertyIndex) {
  currentProperty = properties[propertyIndex];
  currentImageIndex = 0;
  
  const modal = document.getElementById('property-modal');
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  
  renderPropertyGallery();
}

function closePropertyGallery() {
  const modal = document.getElementById('property-modal');
  modal.style.display = 'none';
  document.body.style.overflow = 'auto';
}

function nextImage() {
  if (currentProperty && currentImageIndex < currentProperty.images.length - 1) {
    currentImageIndex++;
    updateGalleryImage();
  }
}

function prevImage() {
  if (currentProperty && currentImageIndex > 0) {
    currentImageIndex--;
    updateGalleryImage();
  }
}

function updateGalleryImage() {
  const img = document.getElementById('modal-main-image');
  if (img && currentProperty) {
    img.src = currentProperty.images[currentImageIndex];
    
    // Update counter
    const counter = document.getElementById('image-counter');
    if (counter) {
      counter.textContent = \`\${currentImageIndex + 1} / \${currentProperty.images.length}\`;
    }
  }
}

function renderPropertyGallery() {
  if (!currentProperty) return;
  
  // Update modal content
  document.getElementById('modal-property-title').textContent = currentProperty.title;
  document.getElementById('modal-property-address').textContent = currentProperty.address;
  document.getElementById('modal-property-price').textContent = '₪' + currentProperty.price;
  document.getElementById('modal-property-description').textContent = currentProperty.description;
  document.getElementById('modal-main-image').src = currentProperty.images[currentImageIndex];
  document.getElementById('image-counter').textContent = \`1 / \${currentProperty.images.length}\`;
  
  // Update specs
  document.getElementById('modal-beds').textContent = currentProperty.beds;
  document.getElementById('modal-baths').textContent = currentProperty.baths;
  document.getElementById('modal-sqft').textContent = currentProperty.sqft;
}

// Close modal on overlay click
document.getElementById('property-modal')?.addEventListener('click', function(e) {
  if (e.target.id === 'property-modal') {
    closePropertyGallery();
  }
});

// Keyboard navigation
document.addEventListener('keydown', function(e) {
  if (document.getElementById('property-modal').style.display === 'flex') {
    if (e.key === 'ArrowRight') prevImage();
    if (e.key === 'ArrowLeft') nextImage();
    if (e.key === 'Escape') closePropertyGallery();
  }
});
\`\`\`

**🎨 MODAL CSS (MANDATORY):**

\`\`\`css
#property-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-content {
  background: white;
  border-radius: 20px;
  max-width: 1200px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  padding: 40px;
}

.modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 32px;
  cursor: pointer;
  background: white;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 10001;
}

.gallery-image-container {
  position: relative;
  width: 100%;
  height: 500px;
  background: #f5f5f5;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 30px;
}

.gallery-image-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.gallery-nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255,255,255,0.9);
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: all 0.3s;
}

.gallery-nav-btn:hover {
  background: white;
  transform: translateY(-50%) scale(1.1);
}

.gallery-nav-btn.prev {
  right: 20px;
}

.gallery-nav-btn.next {
  left: 20px;
}

.image-counter {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
}
\`\`\`

**VISUAL EXCELLENCE:**
- Beautiful property cards with hover effects (scale, shadow)
- High-quality property images
- Clear pricing and specs
- Professional modal/popup design
- Smooth transitions and animations
- Mobile-responsive grid (1 col on mobile, 2-3 on desktop)
- RTL support for Hebrew

**🚨 ABSOLUTELY CRITICAL:**
- ✅ Each property card MUST be clickable to open gallery
- ✅ Modal MUST show ALL images of selected property
- ✅ "צור קשר לביקור בנכס" button (NOT "קנה עכשיו")
- ✅ Arrow navigation between images
- ✅ Image counter (1/5, 2/5, etc.)
- ✅ Close button that works
- ✅ Keyboard navigation (arrows + ESC)

CRITICAL: NO "ניהול" or "Management" buttons anywhere. Return complete valid HTML starting with <!DOCTYPE html>.`,

                t: {

                    en: { title: "Real Estate Properties", label: "Agency Name", description: "Showcase multiple properties with photo galleries.", guidance: "A <b>Real Estate Page</b> displays multiple properties with detailed photo galleries for each property." },

                    he: { title: "נכסים למכירה", label: "שם הסוכנות", description: "הצג מספר נכסים עם גלריות תמונות.", guidance: "<b>דף נכסים</b> מציג מספר נכסים עם גלריית תמונות מפורטת לכל נכס." },

                    es: { title: "Propiedades Inmobiliarias", label: "Nombre de la Agencia", description: "Muestra múltiples propiedades con galerías de fotos.", guidance: "Una <b>Página de Propiedades</b> muestra múltiples propiedades con galerías de fotos detalladas para cada propiedad." },

                    fr: { title: "Propriétés Immobilières", label: "Nom de l'Agence", description: "Présentez plusieurs propriétés avec des galeries de photos.", guidance: "Une <b>Page de Propriétés</b> affiche plusieurs propriétés avec des galeries de photos détaillées pour chaque propriété." }

                }

            },

            onlineStore: {

                img: "https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?q=80&w=2340&auto=format&fit=crop",

                fields: ['productManagement', 'branches'],

                structurePrompt: `Build a complete online store with modern design. Include:

1. **Fixed Header** with store logo, navigation menu, shopping cart icon (with class="cart-icon")
2. **Hero Section** with store name and tagline  
3. **Product Catalog** with 6-8 products in a responsive grid layout (grid-cols-1 md:grid-cols-2 lg:grid-cols-3)

**🚨 CRITICAL - EVERY PRODUCT CARD MUST INCLUDE THIS EXACT STRUCTURE:**
<div class="product-card">
  <img src="PRODUCT_IMAGE_URL" alt="PRODUCT_NAME">
  <h3 class="product-name">PRODUCT_NAME</h3>
  <p class="product-price">₪PRICE</p>
  <button onclick="addToCart('PRODUCT_NAME', PRICE, 'PRODUCT_IMAGE_URL')" class="btn-add-cart">🛒 הוסף לעגלה</button>
</div>

**IMPORTANT:** Replace PRODUCT_NAME, PRICE, and PRODUCT_IMAGE_URL with real values for each product.

4. **WhatsApp Bot** button (bottom-left, green background)
5. **AI Bot** button (bottom-right, purple background)  
6. **Accessibility Button** (top-right corner, small, wheelchair icon ♿)

**🚨 MANDATORY REQUIREMENTS:**
- EVERY product MUST have a button with onclick="addToCart('NAME', PRICE, 'IMAGE')"
- Cart icon MUST have class="cart-icon"
- DO NOT create shopping cart sidebar in HTML (injected by JavaScript)
- DO NOT create checkout form in HTML (handled by JavaScript)
- DO NOT add ANY WhatsApp checkout - handled by our system`,

                t: {

                    en: { title: "Online Store", label: "Store Name", description: "Create a complete online store.", guidance: "An <b>Online Store</b> is a complete e-commerce website with product catalog, shopping cart, and checkout functionality." },

                    he: { title: "חנות מקוונת", label: "שם החנות", description: "צור חנות מקוונת שלמה.", guidance: "<b>חנות מקוונת</b> היא אתר מסחר אלקטרוני מלא עם קטלוג מוצרים, עגלת קניות ופונקציונליות תשלום." },

                    es: { title: "Tienda Online", label: "Nombre de la Tienda", description: "Crea una tienda online completa.", guidance: "Una <b>Tienda Online</b> es un sitio web de comercio electrónico completo con catálogo de productos, carrito de compras y funcionalidad de pago." },

                    fr: { title: "Boutique en Ligne", label: "Nom de la Boutique", description: "Créez une boutique en ligne complète.", guidance: "Une <b>Boutique en Ligne</b> est un site web de commerce électronique complet avec catalogue de produits, panier d'achat et fonctionnalité de paiement." }

                }

            },

            appLaunch: {

                img: "https://images.unsplash.com/photo-1551650975-87deedd944c3?q=80&w=1974&auto=format&fit=crop",

                fields: ['appLinks'],

                structurePrompt: "Build a landing page for an app launch with the following sections: 1. Hero Section (id='home') with the app name, a catchy slogan, and download buttons for the App Store and Google Play. 2. 'Key Features' section (id='features') showcasing 3-4 features with icons. 3. A section displaying screenshots of the app. 4. 'Testimonials' section (id='testimonials'). 5. Contact section (id='contact').",

                t: {

                    en: { title: "App Launch", label: "App Name", description: "Introduce your new app to the world.", guidance: "A <b>Launch Page</b> is an essential tool for marketing a new app, showcasing key features and driving downloads." },

                    he: { title: "השקת אפליקציה", label: "שם האפליקציה", description: "הצג את האפליקציה החדשה שלך לעולם.", guidance: "<b>דף השקה</b> הוא כלי חיוני לשיווק אפליקציה חדשה, המציג את התכונות המרכזיות ומוביל להורדה." },

                    es: { title: "Lanzamiento de App", label: "Nombre de la App", description: "Presenta tu nueva aplicación al mundo.", guidance: "Una <b>Página de Lanzamiento</b> es una herramienta esencial para comercializar una nueva aplicación, mostrando características clave e impulsando las descargas." },

                    fr: { title: "Lancement d'Application", label: "Nom de l'Application", description: "Présentez votre nouvelle application au monde.", guidance: "Une <b>Page de Lancement</b> est un outil essentiel pour commercialiser une nouvelle application, en présentant les fonctionnalités clés et en encourageant les téléchargements." }

                }

            },

            serviceProvider: {

                img: "https://images.unsplash.com/photo-1556745753-b2904692b3cd?q=80&w=2073&auto=format&fit=crop",

                fields: ['websiteLink', 'appointmentBooking', 'branches'],

                structurePrompt: `Build a professional service provider page with appointment booking functionality.

**REQUIRED SECTIONS:**
1. **Header** with business name and navigation
2. **Hero Section** with service description
3. **Interactive Appointment Calendar** (MANDATORY):
   - Display weekly calendar with time slots
   - Show available hours (green) and booked hours (red/gray)
   - Allow customers to click on available slot to book
   - Display working hours and working days
   - Include navigation (today, tomorrow, next days)
4. **Booking Form** (MANDATORY):
   - Customer name, phone, email
   - Selected date and time (auto-filled from calendar click)
   - Service type selection
   - Notes field
   - Submit button that saves to /api/appointments
5. **Services Section** with pricing
6. **About Section**
7. **Contact Information**
**JAVASCRIPT REQUIREMENTS (MANDATORY):**
- Fetch existing appointments from: /api/appointments/[userId]/[pageId]
- Display them on calendar as unavailable
- When customer selects slot, auto-fill the form
- On form submit, POST to /api/appointments with appointment data
- Show success message after booking`,

                t: {

                    en: { title: "Service Provider", label: "Professional/Company Name", description: "For service professionals like plumbers, electricians, etc. Includes appointment booking option.", guidance: "A <b>Service Provider Page</b> is designed for tradespeople and professionals who provide on-demand services. Includes advanced appointment booking system." },

                    he: { title: "נותן שירותים", label: "שם המקצוע/העסק", description: "למקצועני שירותים כמו שרברבים, חשמלאים וכו'. כולל אופציה לזימון תורים.", guidance: "<b>דף נותן שירותים</b> נועד לאנשי מקצוע ובעלי מלאכה המספקים שירותים לפי דרישה. כולל מערכת זימון תורים מתקדמת." },

                    es: { title: "Proveedor de Servicios", label: "Nombre Profesional/Empresa", description: "Para profesionales como plomeros, electricistas, etc.", guidance: "Una <b>Página de Proveedor de Servicios</b> está diseñada para profesionales y artesanos que brindan servicios bajo demanda." },

                    fr: { title: "Prestataire de Services", label: "Nom Professionnel/Entreprise", description: "Pour les professionnels comme plombiers, électriciens, etc.", guidance: "Une <b>Page de Prestataire de Services</b> est conçue pour les professionnels et artisans qui fournissent des servicios à la demande." }

                }

            },

            messageInBottle: {
                img: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?q=80&w=2070&auto=format&fit=crop",
                
                fields: ['messageName', 'messageRequest', 'messageArea', 'messagePhone', 'messagePrice', 'priceType'],
                
                structurePrompt: `Build a super simple "Message in a Bottle" post page - ONLY A FORM!

**CRITICAL - THIS IS JUST A SIMPLE FORM, NOT A FULL WEBSITE:**

1. **Hidden Information Section** (id='home', style='display:none !important;'):
   - Display: The person's name, their request/service, their area, price and price type
   - This is ONLY for the bot to read, NOT for users to see
   - Users should NEVER see this content

2. **Response Form Section** (id='respond'):
   - Title: "שלח הודעה"
   - Only 4 fields: name (required), phone (required), email (optional), message (optional)
   - Submit button: "שלח"
   - NO other content whatsoever

**ABSOLUTELY NO:**
- AI Bot
- WhatsApp bubble
- Accessibility features
- Header/Footer
- Privacy policy
- Services section
- Any other content

**ONLY: Hidden info for bot + Simple form`,

                t: {
                    en: { title: "Message in a Bottle", label: "Your Name", description: "Social post for instant needs - Quick posts like: 'Looking for a babysitter', 'Looking for friends to play basketball', 'Simple question'", guidance: "A <b>Message in a Bottle</b> is a quick social post. Examples: 'I'm looking for a babysitter for Sunday afternoon' or 'Looking for friends to play basketball'. Stav will find someone in your area and show you the form!" },
                    
                    he: { 
                        title: "מסר בבקבוק", 
                        label: "השם שלך", 
                        description: "פוסט חברתי לצרכים מיידיים - פרסם: 'מחפש בייביסיטר', 'מחפש חברים למשחק כדור סל', 'שאלה פשוטה'", 
                        guidance: `<b>מסר בבקבוק</b> - פונקציה חברתית מהירה!
                        
📋 <b>איך זה עובד:</b>
1. אתה מפרסם פוסט קצר (למשל: "מחפש בייביסיטר ליום א' בצהריים")
2. סתיו מרקט תמצא מישהו באזור שלך
3. סתיו תראה למשתמש את הטופס בפרימה ואפשר למלא פרטים
4. הפרטים נשלחים אליך

🍾 <b>דוגמאות:</b>
• אם אתה <b>מציע שירות:</b> "שלי - בייביסיטר, זמין היום, הרצליה, ₪50 שעתי"
• אם אתה <b>מחפש שירות:</b> "מחפש בייביסיטר ליום א' בצהריים"
• אם אתה <b>מחפש חברים:</b> "מחפש חברים למשחק כדור סל"
• אם יש לך <b>שאלה:</b> "מישהו יודע איפה...?"

✏️ <b>השדות:</b>
• <b>שם:</b> השם שלך (חובה)
• <b>בקשה/שירות:</b> מה אתה מציע או מחפש (חובה)
• <b>אזור:</b> איפה (תל אביב, נתניה...) (חובה)
• <b>טלפון:</b> אם זה שירות בתשלום (לא חובה)
• <b>מחיר:</b> אם זה שירות בתשלום (לא חובה)
• <b>סוג מחיר:</b> כללי או שעתי (לא חובה)

📝 <b>אפשר להציע/לבקש:</b>
• שירותים (בייביסיטר, ניקיון, הובלה...)
• חברים לפעילויות
• מידע/שאלות
• הצעות/בקשות אחרות

זה <b>לא עסק</b> - זה פוסט חברתי מהיר!` 
                    }
                }
            }

        };



        const availableSections = {

            testimonials: {

                icon: "star",

                t: {

                    en: { title: "Testimonials", prompt: "Create a 'Testimonials' section (id='testimonials') with 3 fictitious but believable recommendations, including the recommender's name." },

                    he: { title: "לקוחות ממליצים", prompt: "צור מקטע 'לקוחות ממליצים' (id='testimonials') עם 3 המלצות פיקטיביות אך אמינות, כולל שם הממליץ." },

                    ar: { title: "شهادات العملاء", prompt: "أنشئ قسم 'شهادات العملاء' (id='testimonials') مع 3 توصيات وهمية ولكن معقولة، بما في ذلك اسم الموصي." },

                    es: { title: "Testimonios", prompt: "Crea una sección de 'Testimonios' (id='testimonials') con 3 recomendaciones ficticias pero creíbles, incluyendo el nombre de quien recomienda." },

                    fr: { title: "Témoignages", prompt: "Créez une section 'Témoignages' (id='testimonials') avec 3 recommandations fictives mais crédibles, incluant le nom de la personne qui recommande." }

                }

            },

            faq: {

                icon: "help-circle",

                 t: {

                    en: { title: "FAQ", prompt: "Create an 'FAQ' section (id='faq') with 4 relevant common questions and short answers." },

                    he: { title: "שאלות ותשובות", prompt: "צור מקטע 'שאלות ותשובות' (id='faq') עם 4 שאלות נפוצות רלוונטיות ותשובות קצרות." },

                    ar: { title: "الأسئلة الشائعة", prompt: "أنشئ قسم 'الأسئلة الشائعة' (id='faq') مع 4 أسئلة شائعة ذات صلة وإجابات قصيرة." },

                    es: { title: "Preguntas Frecuentes", prompt: "Crea una sección de 'Preguntas Frecuentes' (id='faq') con 4 preguntas comunes relevantes y respuestas cortas." },

                    fr: { title: "FAQ", prompt: "Créez une section 'FAQ' (id='faq') avec 4 questions fréquentes pertinentes et des réponses courtes." }

                }

            },

            team: {

                icon: "users",

                t: {

                    en: { title: "Our Team", prompt: "Create an 'Our Team' section (id='team') with 3 fictitious team members, including a picture, name, and role." },

                    he: { title: "הצוות שלנו", prompt: "צור מקטע 'הצוות שלנו' (id='team') עם 3 חברי צוות פיקטיביים, כולל תמונה, שם ותפקיד." },

                    ar: { title: "فريقنا", prompt: "أنشئ قسم 'فريقنا' (id='team') مع 3 أعضاء فريق وهميين، بما في ذلك صورة واسم ودور." },

                    es: { title: "Nuestro Equipo", prompt: "Crea una sección de 'Nuestro Equipo' (id='team') con 3 miembros de equipo ficticios, incluyendo una foto, nombre y cargo." },

                    fr: { title: "Notre Équipe", prompt: "Créez une section 'Notre Équipe' (id='team') avec 3 membres d'équipe fictifs, incluant une photo, un nom et un rôle." }

                }

            },

            gallery: {

                icon: "image",

                 t: {

                    en: { title: "Image Gallery", prompt: "Create an image gallery section (id='gallery') with 6 placeholder images from placehold.co." },

                    he: { title: "גלריית תמונות", prompt: "צור מקטע גלריית תמונות (id='gallery') עם 6 תמונות placeholder מ-placehold.co." },

                    ar: { title: "معرض الصور", prompt: "أنشئ قسم معرض الصور (id='gallery') مع 6 صور مؤقتة من placehold.co." },

                    es: { title: "Galería de Imágenes", prompt: "Crea una sección de galería de imágenes (id='gallery') con 6 imágenes de marcador de posición de placehold.co." },

                    fr: { title: "Galerie d'Images", prompt: "Créez une section de galerie d'images (id='gallery') avec 6 images de substitution de placehold.co." }

                }

            },

            pricing: {

                icon: "dollar-sign",

                t: {

                    en: { title: "Pricing", prompt: "Create a 'Pricing' section (id='pricing') with 3 different packages (e.g., Basic, Popular, Premium), including a list of features and a price for each." },

                    he: { title: "מחירון", prompt: "צור מקטע 'מחירון' (id='pricing') עם 3 חבילות שונות (לדוגמה: בסיסית, פופולרית, פרימיום), כולל רשימת תכונות ומחיר לכל אחת." },

                    ar: { title: "جدول الأسعار", prompt: "أنشئ قسم 'جدول الأسعار' (id='pricing') مع 3 حزم مختلفة (مثل: أساسية، شائعة، مميزة)، بما في ذلك قائمة بالميزات وسعر لكل منها." },

                    es: { title: "Tabla de Precios", prompt: "Crea una sección de 'Tabla de Precios' (id='pricing') con 3 paquetes diferentes (por ejemplo, Básico, Popular, Premium), incluyendo una lista de características y un precio para cada uno." },

                    fr: { title: "Tableau des Prix", prompt: "Créez une section 'Tableau des Prix' (id='pricing') avec 3 forfaits différents (par exemple, Basique, Populaire, Premium), incluant une liste de fonctionnalités et un prix pour chacun." }

                }

            },

            services: {

                icon: "briefcase",

                t: {

                    en: { title: "Services", prompt: "Create a 'Services' section (id='services') with a list of services offered." },

                    he: { title: "שירותים", prompt: "צור מקטע 'שירותים' (id='services') עם רשימת שירותים." },

                    ar: { title: "الخدمات", prompt: "أنشئ قسم 'الخدمات' (id='services') مع قائمة بالخدمات المقدمة." },

                    es: { title: "Servicios", prompt: "Crea una sección de 'Servicios' (id='services') con una lista de servicios ofrecidos." },

                    fr: { title: "Services", prompt: "Créez une section 'Services' (id='services') avec une liste de services offerts." }

                }

            },

            about: {

                icon: "info",

                t: {

                    en: { title: "About", prompt: "Create an 'About' section (id='about') with information about the business." },

                    he: { title: "אודות", prompt: "צור מקטע 'אודות' (id='about') עם מידע על העסק." },

                    ar: { title: "حول", prompt: "أنشئ قسم 'حول' (id='about') مع معلومات حول الأعمال." },

                    es: { title: "Acerca de", prompt: "Crea una sección 'Acerca de' (id='about') con información sobre el negocio." },

                    fr: { title: "À propos", prompt: "Créez une section 'À propos' (id='about') avec des informations sur l'entreprise." }

                }

            }

        };

        

        // --- Supabase Client ---

        const SUPABASE_URL = 'https://osoqfadqohqcauawzmmq.supabase.co';

        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zb3FmYWRxb2hxY2F1YXd6bW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2OTIzMjMsImV4cCI6MjA3MzI2ODMyM30.TBLmKIntYGSfBm2StItfWm87-ebojV_NbaKNcYNWMPg';

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        

        // --- Element Selectors ---

        const ui = {

            typeSelectionView: document.getElementById('type-selection-view'),

            formView: document.getElementById('form-view'),

            previewView: document.getElementById('preview-view'),

            detailsForm: document.getElementById('details-form'),

            pageTypeTitle: document.getElementById('page-type-title'),

            mainNameLabel: document.getElementById('mainNameLabel'),

            dynamicFieldsContainer: document.getElementById('dynamic-fields'),

            optionalSectionsFieldset: document.getElementById('optional-sections-fieldset'),

            socialMediaFieldset: document.getElementById('social-media-fieldset'),

            addressFieldContainer: document.getElementById('address-field-container'),

            accessibilityFieldContainer: document.getElementById('accessibility-field-container'),

            assistantContainer: document.getElementById('assistant-container'),

            assistantAvatar: document.getElementById('assistant-avatar'),

            guidanceBubble: document.getElementById('guidance-bubble'),

            generationView: document.getElementById('generation-view'),

            previewContainer: document.getElementById('preview-container'),

            customModal: document.getElementById('custom-modal'),

            modalMessage: document.getElementById('modal-message'),

            modalCloseBtn: document.getElementById('modal-close-btn'),

            generateBtnText: document.getElementById('button-text'),

            generateBtnLoader: document.getElementById('button-loader'),

            designSelectionContainer: document.querySelector('[data-selection="style"]'),

            designStyleFieldset: document.getElementById('design-style-fieldset'),

            previewIframe: document.getElementById('preview-iframe'),

            backToFormBtn: document.getElementById('back-to-form-btn'),

            toolsFab: document.getElementById('tools-fab'),

            toolsMenu: document.getElementById('tools-menu'),

            savePageBtn: document.getElementById('save-page-btn'),

            downloadPageBtn: document.getElementById('download-page-btn'),
            iframeImageUploader: document.getElementById('iframe-image-uploader'),

            editToolsGroup: document.getElementById('edit-tools-group'),

            uploadImageBtn: document.getElementById('upload-image-btn'),
            
            deleteImageBtn: document.getElementById('delete-image-btn'),

            textColorPicker: document.getElementById('text-color-picker'),

            bgColorPicker: document.getElementById('bg-color-picker'),

            opacityControl: document.getElementById('opacity-control'),

            opacitySlider: document.getElementById('opacity-slider'),

            templateGrid: document.getElementById('template-grid'),

            languageSelector: document.getElementById('language-selector'),

            countryCodeSelect: document.getElementById('countryCode')

        };

        

        // --- State Variables ---

        let state = {

            selectedPageType: '',

            selectedPageTitle: '',

            selectedStyle: null,

            selectedLayout: null,

            selectedClipStyle: null,

            isEditing: false,

            currentElementToEdit: null,

            elementToModifyForImage: null,

            imageModificationType: null,

            currentOverlayToEdit: null,

            originalDescription: '',

            currentLanguage: 'en'

        };





        // --- Initialization ---

        async function initializeApp() {

            lucide.createIcons();

            populateCountryCodes();

            await handleAuth();

            const userLang = navigator.language.split('-')[0];

            if (translations[userLang]) {

                state.currentLanguage = userLang;

                ui.languageSelector.value = userLang;

            }
            
            // הגדר ברירת מחדל לשפת הפלט - עברית
            const outputLanguageSelect = document.getElementById('outputLanguage');
            if (outputLanguageSelect && !outputLanguageSelect.value) {
                outputLanguageSelect.value = 'he';
            }

            setLanguage(state.currentLanguage);

            bindEventListeners();

        }



        async function handleAuth() {

            const { data: { session }, error } = await sb.auth.getSession();

            if (error) {

                console.error("Error getting session:", error);

                return;

            }

            if (!session) {

                 const { data: anonData, error: anonError } = await sb.auth.signInAnonymously();

                 if (anonError) {

                    console.error("Error signing in anonymously:", anonError);
                    console.log("💡 Supabase not available - pages will be saved locally only");
                    // Don't show error modal - local saving will work fine
                    // showModal('modal_error_auth');

                 } else {

                    console.log("Signed in anonymously:", anonData.user.id);

                 }

            } else {

                console.log("User session found:", session.user.id);

            }

        }

        // 🎯 Interactive Field Guidance System
        const fieldGuidance = {
            // Basic Details
            'mainName': {
                title: '📝 שם העסק/הפרויקט',
                message: 'כאן תכתוב את השם של העסק או הפרויקט שלך. לדוגמה: "קפה דליה", "סטודיו צילום רון", "מסעדת השף"',
                tips: ['השם יופיע בכותרת הדף', 'בחר שם קצר וזכיר', 'אפשר להוסיף תיאור קצר']
            },
            'contactName': {
                title: '👤 שם איש הקשר',
                message: 'השם של האדם שאנשים יוכלו ליצור איתו קשר. בדרך כלל זה השם שלך או של בעל העסק.',
                tips: ['השם יופיע בפרטי הקשר', 'השתמש בשם מלא או שם פרטי', 'זה יוצר אמון עם הלקוחות']
            },
            'description': {
                title: '📖 תיאור העסק',
                message: 'כתוב תיאור קצר ומעניין על העסק שלך. מה אתה מציע? מה מיוחד בשירות שלך?',
                tips: ['2-3 משפטים מספיקים', 'הדגש את היתרונות שלך', 'כתוב בשפה פשוטה וידידותית']
            },
            'phone': {
                title: '📞 מספר טלפון',
                message: 'המספר שלקוחות יוכלו להתקשר אליך. כשתכתוב טלפון, אוטומטית תתווסף בועת WhatsApp לדף! 💬',
                tips: ['כתוב עם מקף: 050-1234567', 'בועת WhatsApp תופיע אוטומטית', 'הלקוחות יוכלו ללחוץ ולהתקשר']
            },
            'email': {
                title: '📧 כתובת מייל',
                message: 'כתובת המייל לפניות עסקיות. הלקוחות יוכלו ללחוץ ולשלוח מייל ישירות.',
                tips: ['וודא שהכתובת נכונה', 'השתמש במייל עסקי אם יש', 'הלקוחות יוכלו ללחוץ ולשלוח מייל']
            },
            'area': {
                title: '📍 אזור פעילות',
                message: 'באיזה אזור אתה פועל? זה עוזר ללקוחות לדעת אם השירות רלוונטי להם.',
                tips: ['לדוגמה: תל אביב, חיפה, כל הארץ', 'אפשר לכתוב כמה ערים', 'ספציפי עוזר למציאות בחיפוש']
            },
            
            // Message in Bottle specific
            'messageName': {
                title: '🍾 השם שלך',
                message: 'השם שלך לפוסט המהיר. זה יופיע רק "מאחורי הקלעים" לבוט, לא למשתמשים.',
                tips: ['השם שלך או כינוי', 'זה רק למידע הבוט', 'המשתמשים לא יראו את זה']
            },
            'messageRequest': {
                title: '💬 בקשה או שירות',
                message: 'מה אתה מחפש או מציע? לדוגמה: "מחפש בייביסיטר", "מציע שירותי ניקיון", "מחפש חברים לכדורסל"',
                tips: ['כתוב בקצרה ובבירור', 'אפשר בקשה או הצעת שירות', 'זה הפוסט החברתי שלך']
            },
            'messageArea': {
                title: '🗺️ באיזה אזור?',
                message: 'איפה אתה נמצא או איפה אתה מחפש? זה עוזר לבוט למצוא אנשים באזור שלך.',
                tips: ['שם העיר או השכונה', 'ככל שיותר ספציפי - יותר טוב', 'הבוט ישתמש בזה לחיפוש']
            },
            'messagePrice': {
                title: '💰 מחיר (אופציונלי)',
                message: 'אם זה שירות בתשלום, כמה זה עולה? אם זה בחינם או בקשה - השאר ריק.',
                tips: ['רק אם זה שירות בתשלום', 'כתוב מספר בלבד', 'אם זה בחינם - השאר ריק']
            },
            'priceType': {
                title: '⏰ סוג התמחור',
                message: 'האם המחיר הוא כללי (סכום קבוע) או שעתי (לפי שעות עבודה)?',
                tips: ['כללי = מחיר קבוע לכל השירות', 'שעתי = מחיר לשעת עבודה', 'בחר מה שמתאים לשירות שלך']
            },
            
            // Additional common fields
            'websiteUrl': {
                title: '🌐 כתובת אתר',
                message: 'כתובת האתר שלך (אם יש). זה יוסיף קישור לאתר שלך בדף.',
                tips: ['כתוב עם http:// או https://', 'לדוגמה: https://www.mysite.com', 'אם אין אתר - השאר ריק']
            },
            'address': {
                title: '📍 כתובת מלאה',
                message: 'הכתובת הפיזית של העסק. זה יוסיף קישור למפות גוגל!',
                tips: ['כתוב כתובת מלאה עם עיר', 'לדוגמה: רחוב הרצל 15, תל אביב', 'הלקוחות יוכלו ללחוץ ולנווט']
            },
            'price': {
                title: '💰 מחיר',
                message: 'המחיר של השירות או המוצר. זה יוצג בדף בצורה בולטת.',
                tips: ['כתוב רק מספר', 'לדוגמה: 150', 'המטבע (₪) יתווסף אוטומטית']
            },
            'whatsappCountryCode': {
                title: '🌍 קוד מדינה לWhatsApp',
                message: 'קוד המדינה לטלפון WhatsApp. בישראל זה +972.',
                tips: ['בישראל: +972', 'ארה"ב: +1', 'בריטניה: +44']
            },
            
            // Event specific fields
            'eventDate': {
                title: '📅 תאריך האירוע',
                message: 'מתי האירוע מתקיים? זה יופיע בצורה בולטת בהזמנה.',
                tips: ['בחר תאריך מהלוח שנה', 'התאריך יופיע בהזמנה', 'אפשר לשנות גם אחרי']
            },
            'eventTime': {
                title: '🕐 שעת האירוע',
                message: 'באיזו שעה האירוע מתחיל? זה חשוב לאורחים לדעת.',
                tips: ['כתוב בפורמט 20:00', 'אפשר להוסיף "בערב" או "בבוקר"', 'תזכור לציין אם זה שעת התכנסות או התחלה']
            },
            'eventLocation': {
                title: '📍 מקום האירוع',
                message: 'איפה האירוע מתקיים? כתוב כתובת מלאה או שם מקום.',
                tips: ['כתוב כתובת מלאה', 'או שם אולם/מקום מוכר', 'זה יהפוך לקישור לניווט']
            },
            
            // Store specific fields
            'storeName': {
                title: '🏪 שם החנות',
                message: 'השם של החנות או העסק שלך. זה יופיע בכותרת ובכל מקום.',
                tips: ['בחר שם קצר וזכיר', 'השם יופיע בכותרת', 'אפשר להוסיף סלוגן קצר']
            },
            'storeDescription': {
                title: '📝 תיאור החנות',
                message: 'ספר על החנות שלך - מה אתה מוכר? מה מיוחד אצלך?',
                tips: ['2-3 משפטים מספיקים', 'הדגש את היתרונות', 'ספר על איכות המוצרים']
            },
            
            // Course specific fields
            'courseName': {
                title: '📚 שם הקורס',
                message: 'איך קוראים לקורס או לסדנה שלך? בחר שם ברור ומעניין.',
                tips: ['שם ברור ומובן', 'אפשר להוסיף רמה (מתחילים/מתקדמים)', 'הימנע ממילים מסובכות']
            },
            'courseDescription': {
                title: '📖 תיאור הקורס',
                message: 'מה לומדים בקורס? מה התלמידים ירוויחו מזה?',
                tips: ['הסבר מה לומדים', 'ציין את היתרונות', 'כתוב על הניסיון שלך']
            },
            'courseDuration': {
                title: '⏱️ משך הקורס',
                message: 'כמה זמן לוקח הקורס? שעות, ימים, שבועות?',
                tips: ['לדוגמה: 8 שעות', 'או: 4 מפגשים של שעתיים', 'ציין אם זה אינטנסיבי או פרוס']
            },
            'coursePrice': {
                title: '💰 מחיר הקורס',
                message: 'כמה עולה הקורס? זה יוצג בצורה בולטת.',
                tips: ['כתוב מספר בלבד', 'אפשר להוסיף הנחות', 'ציין אם כולל חומרים']
            },
            
            // Service provider fields
            'serviceName': {
                title: '🔧 שם השירות',
                message: 'איך קוראים לשירות שלך? לדוגמה: "שירותי אינסטלציה", "עיצוב גרפי"',
                tips: ['שם ברור ומובן', 'הימנע ממילים מסובכות', 'ציין את התחום']
            },
            'serviceDescription': {
                title: '📋 תיאור השירות',
                message: 'מה השירות כולל? איך אתה עוזר ללקוחות?',
                tips: ['הסבר מה אתה עושה', 'ציין את הניסיון שלך', 'הדגש את היתרונות']
            },
            'serviceArea': {
                title: '🗺️ אזור השירות',
                message: 'באילו אזורים אתה נותן שירות? זה עוזר ללקוחות לדעת אם אתה מגיע אליהם.',
                tips: ['ציין ערים או אזורים', 'לדוגמה: גוש דן, חיפה והקריות', 'אפשר לציין עלות נסיעה']
            },
            
            // Landing page fields
            'landingTitle': {
                title: '🎯 כותרת הדף',
                message: 'הכותרת הראשית של הדף. זה מה שאנשים רואים ראשון!',
                tips: ['כותרת קצרה וחזקה', 'צריכה לעניין מיד', 'הימנע מכותרות ארוכות']
            },
            'landingSubtitle': {
                title: '📝 תת כותרת',
                message: 'הסבר קצר מתחת לכותרת הראשית. מה אתה מציע?',
                tips: ['הרחב על הכותרת', '1-2 משפטים', 'הסבר את הערך שאתה נותן']
            },
            
            // Common fields for all types
            'companyName': {
                title: '🏢 שם החברה',
                message: 'השם הרשמי של החברה או העסק שלך.',
                tips: ['השם הרשמי', 'כפי שרשום במס הכנסה', 'אפשר לציין ע"מ או בע"מ']
            },
            'ownerName': {
                title: '👨‍💼 שם הבעלים',
                message: 'השם שלך או של בעל העסק. זה יוצר אמון אישי.',
                tips: ['שם מלא או שם פרטי', 'זה יוצר קשר אישי', 'אפשר להוסיף תואר מקצועי']
            },
            'businessHours': {
                title: '🕐 שעות פעילות',
                message: 'מתי העסק פתוח? זה חשוב ללקוחות לדעת.',
                tips: ['לדוגמה: א-ה 9:00-17:00', 'ציין ימי שישי ושבת', 'אפשר לציין זמינות טלפונית']
            },
            'socialMedia': {
                title: '📱 רשתות חברתיות',
                message: 'קישורים לפייסבוק, אינסטגרם וכו. זה מחבר אותך ללקוחות.',
                tips: ['העתק את הקישור המלא', 'וודא שהקישור עובד', 'אפשר להוסיף כמה רשתות']
            },
            
            // Optional sections and features
            'optionalSections': {
                title: '📋 סעיפים אופציונליים',
                message: 'כאן תוכל להוסיף סעיפים נוספים לדף שלך כמו: לקוחות ממליצים, שאלות ותשובות, הצוות שלנו, גלריית תמונות ועוד.',
                tips: ['בחר רק מה שרלוונטי לעסק שלך', 'לקוחות ממליצים מחזקים אמון', 'שאלות ותשובות עוזרות ללקוחות', 'גלריה מראה את העבודות שלך']
            },
            'testimonials': {
                title: '⭐ לקוחות ממליצים',
                message: 'המלצות מלקוחות מרוצים. זה אחד הדברים החשובים ביותר לבניית אמון!',
                tips: ['בקש המלצות מלקוחות מרוצים', 'כלול שם מלא ותמונה אם אפשר', 'המלצות אמיתיות עובדות הכי טוב']
            },
            'faq': {
                title: '❓ שאלות ותשובות',
                message: 'שאלות נפוצות שלקוחות שואלים. זה חוסך לך זמן ועוזר ללקוחות למצוא תשובות מהר.',
                tips: ['רשום את השאלות שהכי הרבה שואלים אותך', 'תשובות קצרות וברורות', 'עדכן לפי שאלות חדשות שמגיעות']
            },
            'team': {
                title: '👥 הצוות שלנו',
                message: 'הצגת חברי הצוות. זה יוצר קשר אישי ואמון עם הלקוחות.',
                tips: ['תמונות מקצועיות של הצוות', 'תיאור קצר של כל אחד', 'הדגש את הניסיון והמומחיות']
            },
            'gallery': {
                title: '🖼️ גלריית תמונות',
                message: 'תמונות של העבודות שלך, המוצרים או השירותים. תמונות שווות אלף מילים!',
                tips: ['תמונות באיכות גבוהה', 'הראה את התוצאות הטובות ביותר', 'עדכן תמונות חדשות מפעם לפעם']
            },
            'priceTable': {
                title: '💰 טבלת מחירים',
                message: 'טבלה מסודרת עם המחירים שלך. זה עוזר ללקוחות להבין מה הם מקבלים תמורת הכסף.',
                tips: ['חלק לחבילות ברורות', 'הדגש את החבילה הפופולרית', 'ציין מה כלול בכל חבילה']
            },
            
            // Calendar and appointment system
            'calendar': {
                title: '📅 ממשק יומן',
                message: 'מערכת זימון תורים אוטומטית! הלקוחות יוכלו לקבוע תור ישירות דרך הדף שלך.',
                tips: ['הלקוחות רואים זמינות בזמן אמת', 'אתה מקבל התראות על תורים חדשים', 'אפשר לנהל את היומן בקלות', 'חוסך לך זמן ושיחות טלפון']
            },
            'appointments': {
                title: '🗓️ קביעת תורים',
                message: 'מערכת מתקדמת לקביעת תורים. הלקוחות בוחרים תאריך ושעה, ואתה מקבל הודעה.',
                tips: ['הגדר את השעות הפנויות שלך', 'קבע משך זמן לכל תור', 'הלקוחות יקבלו אישור אוטומטי', 'תוכל לבטל או לשנות תורים']
            },
            'bookingSystem': {
                title: '📋 מערכת הזמנות',
                message: 'מערכת מקצועית לניהול הזמנות ותורים. מושלמת לעסקים עם לוח זמנים צפוף.',
                tips: ['ניהול מתקדם של זמינות', 'אפשרות לתשלום מראש', 'שליחת תזכורות ללקוחות', 'דוחות על התורים']
            },
            
            // Design and styling options
            'designStyle': {
                title: '🎨 סגנון עיצוב',
                message: 'בחר את הסגנון הויזואלי של הדף. כל סגנון יוצר אווירה אחרת ומתאים לעסקים שונים.',
                tips: ['מינימליסטי - נקי ופשוט', 'מודרני - טרנדי ועכשווי', 'קלאסי - אלגנטי ומכובד', 'בחר מה שמתאים לעסק שלך']
            },
            'headerImage': {
                title: '🖼️ תמונת כותרת',
                message: 'התמונה הראשית של הדף. זה מה שאנשים רואים ראשון - חשוב שתהיה איכותית ורלוונטית!',
                tips: ['תמונה באיכות גבוהה', 'רלוונטית לעסק שלך', 'לא יותר מדי טקסט בתמונה', 'גודל מתאים לכל המכשירים']
            },
            
            // Additional settings
            'accessibility': {
                title: '♿ נגישות',
                message: 'הוספת כלי נגישות לדף. זה חשוב כדי שכל האנשים יוכלו להשתמש בדף שלך בנוחות.',
                tips: ['חובה על פי חוק', 'מגדיל את קהל הלקוחות', 'משפר את חוויית המשתמש', 'כולל הגדלת טקסט, ניגודיות ועוד']
            },
            'aiBot': {
                title: '🤖 בוט AI',
                message: 'בוט חכם שעונה על שאלות הלקוחות 24/7. הוא יכול לעזור עם מידע על השירותים ולהפנות לקוחות אליך.',
                tips: ['עובד 24 שעות ביממה', 'עונה על שאלות בסיסיות', 'מפנה לקוחות רציניים אליך', 'משפר את השירות ללקוחות']
            },
            'whatsapp': {
                title: '💬 בועת WhatsApp',
                message: 'כפתור WhatsApp קבוע בדף. הלקוחות יוכלו לפנות אליך ישירות בלחיצה אחת!',
                tips: ['קשר ישיר ומהיר עם לקוחות', 'הלקוחות אוהבים WhatsApp', 'אתה רואה מי פנה אליך', 'אפשר לשלוח תמונות ומיקום']
            }
        };

        // Function to show field guidance
        function showFieldGuidance(fieldId, customGuidance = null) {
            const guidance = customGuidance || fieldGuidance[fieldId];
            if (!guidance) {
                console.log('❌ No guidance found for field:', fieldId);
                return;
            }
            
            console.log('🎯 Showing guidance for field:', fieldId, guidance.title);
            
            // Try multiple ways to show the guidance
            console.log('🔍 Searching for bot elements...');
            
            // Method 1: Try to find existing chat
            let aiChatMessages = document.getElementById('ai-chat-messages');
            if (aiChatMessages) {
                console.log('✅ Found existing chat, adding message...');
                addGuidanceMessage(aiChatMessages, guidance);
                return;
            }
            
            // Method 2: Try to open bot first
            const aiBotBtn = document.getElementById('ai-bot-btn');
            if (aiBotBtn) {
                console.log('✅ Found bot button, opening chat...');
                aiBotBtn.click();
                
                setTimeout(() => {
                    aiChatMessages = document.getElementById('ai-chat-messages');
                    if (aiChatMessages) {
                        console.log('✅ Chat opened, adding message...');
                        addGuidanceMessage(aiChatMessages, guidance);
                    } else {
                        console.log('❌ Chat still not found, trying fallback...');
                        showGuidanceAsFallback(guidance);
                    }
                }, 200);
                return;
            }
            
            // Method 3: Fallback - show as alert or create our own popup
            console.log('❌ No bot found, using fallback method...');
            showGuidanceAsFallback(guidance);
        }
        
        // Helper function to add guidance message
        function addGuidanceMessage(aiChatMessages, guidance) {
            const guidanceDiv = document.createElement('div');
            guidanceDiv.style.cssText = 'background: #FEF3C7; border: 2px solid #F59E0B; padding: 14px; border-radius: 12px; margin-bottom: 12px; animation: slideInFromRight 0.4s ease-out;';
            
            let tipsHtml = '';
            if (guidance.tips && guidance.tips.length > 0) {
                tipsHtml = `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #F59E0B;">
                        <p style="margin: 0 0 6px 0; color: #92400E; font-size: 13px; font-weight: 600;">💡 טיפים:</p>
                        ${guidance.tips.map(tip => `<p style="margin: 2px 0; color: #92400E; font-size: 12px; line-height: 1.4;">• ${tip}</p>`).join('')}
                    </div>
                `;
            }
            
            guidanceDiv.innerHTML = `
                <p style="margin: 0 0 8px 0; color: #92400E; font-size: 15px; font-weight: 600;">${guidance.title}</p>
                <p style="margin: 0; color: #92400E; font-size: 14px; line-height: 1.5;">${guidance.message}</p>
                ${tipsHtml}
            `;
            
            aiChatMessages.appendChild(guidanceDiv);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
            
            // Auto-open bot if closed
            const aiChatWindow = document.getElementById('ai-chat-window');
            if (aiChatWindow && aiChatWindow.style.display === 'none') {
                aiChatWindow.style.display = 'flex';
                console.log('🤖 Bot window opened automatically');
            }
            
            console.log('✅ Field guidance message added successfully!');
        }
        
        // Fallback method to show guidance when bot is not available
        function showGuidanceAsFallback(guidance) {
            console.log('🚨 Using fallback guidance display');
            
            // Create a temporary popup
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #FEF3C7;
                border: 2px solid #F59E0B;
                padding: 16px;
                border-radius: 12px;
                max-width: 350px;
                z-index: 10000;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                animation: slideInFromRight 0.4s ease-out;
            `;
            
            let tipsHtml = '';
            if (guidance.tips && guidance.tips.length > 0) {
                tipsHtml = `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #F59E0B;">
                        <p style="margin: 0 0 6px 0; color: #92400E; font-size: 13px; font-weight: 600;">💡 טיפים:</p>
                        ${guidance.tips.map(tip => `<p style="margin: 2px 0; color: #92400E; font-size: 12px; line-height: 1.4;">• ${tip}</p>`).join('')}
                    </div>
                `;
            }
            
            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <p style="margin: 0; color: #92400E; font-size: 15px; font-weight: 600;">${guidance.title}</p>
                    <button onclick="this.closest('.fixed').remove()" style="background: none; border: none; color: #92400E; font-size: 18px; cursor: pointer; padding: 0; margin-left: 8px;">×</button>
                </div>
                <p style="margin: 0; color: #92400E; font-size: 14px; line-height: 1.5;">${guidance.message}</p>
                ${tipsHtml}
            `;
            
            document.body.appendChild(popup);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.remove();
                }
            }, 8000);
            
            console.log('✅ Fallback guidance popup created');
        }

        // Template selection guidance
        function showTemplateSelectionGuidance(pageType, templateTitle) {
            const templateGuidance = {
                'store': {
                    icon: '🏪',
                    message: 'מעולה! בחרת ליצור חנות אונליין. עכשיו נמלא את הפרטים הבסיסיים ואחר כך נוסיף מוצרים ומחירים.',
                    nextSteps: ['מלא את שם העסק', 'הוסף תיאור קצר', 'הכנס פרטי קשר', 'נוסיף מוצרים בהמשך']
                },
                'event': {
                    icon: '🎉',
                    message: 'נהדר! אתה יוצר הזמנה לאירוע. בואו נמלא את פרטי האירוע ונוסיף כל המידע החשוב לאורחים.',
                    nextSteps: ['שם האירוע', 'תאריך ושעה', 'מקום האירוע', 'פרטים נוספים לאורחים']
                },
                'serviceProvider': {
                    icon: '🔧',
                    message: 'מצוין! אתה יוצר דף לנותן שירותים. נמלא את הפרטים על השירותים שלך ואיך ליצור קשר.',
                    nextSteps: ['שם העסק/השירות', 'תיאור השירותים', 'אזור פעילות', 'דרכי יצירת קשר']
                },
                'messageInBottle': {
                    icon: '🍾',
                    message: 'כיף! אתה יוצר "מסר בבקבוק" - פוסט חברתי מהיר. זה מושלם לבקשות דחופות או הצעות זמניות.',
                    nextSteps: ['השם שלך', 'מה אתה מחפש/מציע', 'באיזה אזור', 'מחיר (אם רלוונטי)']
                },
                'course': {
                    icon: '📚',
                    message: 'נפלא! אתה יוצר דף לקורס או סדנה. נמלא את כל הפרטים שהתלמידים צריכים לדעת.',
                    nextSteps: ['שם הקורס', 'תיאור הקורס', 'מועדים ומחירים', 'פרטי הרשמה']
                }
            };
            
            const guidance = templateGuidance[pageType] || {
                icon: '📄',
                message: `בחרת ליצור ${templateTitle}. בואו נמלא את הפרטים הבסיסיים.`,
                nextSteps: ['מלא את השדות הבסיסיים', 'הוסף תיאור', 'הכנס פרטי קשר']
            };
            
            const aiChatMessages = document.getElementById('ai-chat-messages');
            if (!aiChatMessages) return;
            
            const guidanceDiv = document.createElement('div');
            guidanceDiv.style.cssText = 'background: #DBEAFE; border: 2px solid #3B82F6; padding: 16px; border-radius: 12px; margin-bottom: 12px; animation: slideInFromLeft 0.4s ease-out;';
            
            const stepsHtml = guidance.nextSteps.map((step, index) => 
                `<p style="margin: 2px 0; color: #1E40AF; font-size: 13px; line-height: 1.4;">${index + 1}. ${step}</p>`
            ).join('');
            
            guidanceDiv.innerHTML = `
                <p style="margin: 0 0 8px 0; color: #1E40AF; font-size: 16px; font-weight: 600;">${guidance.icon} ${templateTitle}</p>
                <p style="margin: 0 0 10px 0; color: #1E40AF; font-size: 14px; line-height: 1.5;">${guidance.message}</p>
                <div style="background: rgba(255,255,255,0.7); padding: 10px; border-radius: 8px;">
                    <p style="margin: 0 0 6px 0; color: #1E40AF; font-size: 13px; font-weight: 600;">📋 השלבים הבאים:</p>
                    ${stepsHtml}
                </div>
            `;
            
            aiChatMessages.appendChild(guidanceDiv);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
            
            // Auto-open bot if closed
            const aiChatWindow = document.getElementById('ai-chat-window');
            if (aiChatWindow && aiChatWindow.style.display === 'none') {
                aiChatWindow.style.display = 'flex';
            }
        }

        // Add event listeners to all form fields
        function addFieldGuidanceListeners() {
            console.log('🎯 Initializing field guidance listeners...');
            
            // Function to add listeners to a field
            function addListenersToField(field) {
                if (field && field.id && fieldGuidance[field.id]) {
                    console.log('📝 Adding guidance to field:', field.id);
                    
                    // Remove existing listeners to avoid duplicates
                    field.removeEventListener('focus', field._guidanceHandler);
                    field.removeEventListener('click', field._guidanceHandler);
                    
                    // Create new handler
                    field._guidanceHandler = () => showFieldGuidance(field.id);
                    
                    // Add listeners
                    field.addEventListener('focus', field._guidanceHandler);
                    field.addEventListener('click', field._guidanceHandler);
                }
            }
            
            // Add listeners to existing fields
            function scanAndAddListeners() {
                Object.keys(fieldGuidance).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        addListenersToField(field);
                    }
                });
                
                // Also scan for all input/textarea/select elements
                const allInputs = document.querySelectorAll('input, textarea, select');
                allInputs.forEach(input => {
                    if (input.id && fieldGuidance[input.id]) {
                        addListenersToField(input);
                    } else if (input.name && fieldGuidance[input.name]) {
                        // Try by name attribute too
                        input._guidanceHandler = () => showFieldGuidance(input.name);
                        input.addEventListener('focus', input._guidanceHandler);
                        input.addEventListener('click', input._guidanceHandler);
                        console.log('📝 Adding guidance to field by name:', input.name);
                    } else if (input.placeholder) {
                        // Add generic guidance for fields without specific guidance
                        addGenericGuidance(input);
                    }
                });
                
                // Also scan for buttons and other clickable elements
                const allButtons = document.querySelectorAll('button, .btn, [onclick], label');
                allButtons.forEach(button => {
                    const text = button.textContent?.toLowerCase() || '';
                    const title = button.title?.toLowerCase() || '';
                    
                    if (text.includes('יומן') || text.includes('תור') || text.includes('calendar')) {
                        button._guidanceHandler = () => showFieldGuidance('calendar');
                        button.addEventListener('click', button._guidanceHandler);
                        console.log('📝 Adding calendar guidance to button:', text);
                    } else if (text.includes('סעיף') || text.includes('אופציונ') || text.includes('optional')) {
                        button._guidanceHandler = () => showFieldGuidance('optionalSections');
                        button.addEventListener('click', button._guidanceHandler);
                        console.log('📝 Adding optional sections guidance to button:', text);
                    } else if (text.includes('עיצוב') || text.includes('סגנון') || text.includes('design')) {
                        button._guidanceHandler = () => showFieldGuidance('designStyle');
                        button.addEventListener('click', button._guidanceHandler);
                        console.log('📝 Adding design guidance to button:', text);
                    } else if (text.includes('נגישות') || text.includes('accessibility')) {
                        button._guidanceHandler = () => showFieldGuidance('accessibility');
                        button.addEventListener('click', button._guidanceHandler);
                        console.log('📝 Adding accessibility guidance to button:', text);
                    } else if (text.includes('whatsapp') || text.includes('וואטסאפ')) {
                        button._guidanceHandler = () => showFieldGuidance('whatsapp');
                        button.addEventListener('click', button._guidanceHandler);
                        console.log('📝 Adding WhatsApp guidance to button:', text);
                    } else if (text.includes('בוט') || text.includes('bot') || text.includes('ai')) {
                        button._guidanceHandler = () => showFieldGuidance('aiBot');
                        button.addEventListener('click', button._guidanceHandler);
                        console.log('📝 Adding AI bot guidance to button:', text);
                    }
                });
            }
            
            // Generic guidance for fields without specific guidance
            function addGenericGuidance(field) {
                if (field._hasGenericGuidance) return;
                field._hasGenericGuidance = true;
                
                const placeholder = field.placeholder.toLowerCase();
                let guidance = null;
                
                if (placeholder.includes('שם') || placeholder.includes('name')) {
                    guidance = {
                        title: '📝 שדה שם',
                        message: 'כתוב את השם הרלוונטי כאן. וודא שהשם ברור ומדויק.',
                        tips: ['השתמש בשם מלא', 'בדוק שאין שגיאות כתיב', 'השם יופיע בדף']
                    };
                } else if (placeholder.includes('טלפון') || placeholder.includes('phone')) {
                    guidance = {
                        title: '📞 שדה טלפון',
                        message: 'כתוב מספר טלפון תקין. זה יהפוך לקישור שאפשר ללחוץ עליו!',
                        tips: ['כתוב עם מקף: 050-1234567', 'הלקוחות יוכלו ללחוץ ולהתקשר', 'וודא שהמספר נכון']
                    };
                } else if (placeholder.includes('מייל') || placeholder.includes('email')) {
                    guidance = {
                        title: '📧 שדה מייל',
                        message: 'כתוב כתובת מייל תקינה. הלקוחות יוכלו ללחוץ ולשלוח מייל.',
                        tips: ['וודא שהכתובת נכונה', 'בדוק שיש @ ונקודה', 'השתמש במייל עסקי אם יש']
                    };
                } else if (placeholder.includes('תיאור') || placeholder.includes('description')) {
                    guidance = {
                        title: '📖 שדה תיאור',
                        message: 'כתוב תיאור קצר ומעניין. זה מה שאנשים יקראו כדי להבין מה אתה מציע.',
                        tips: ['2-3 משפטים מספיקים', 'הדגש את היתרונות', 'כתוב בשפה פשוטה']
                    };
                } else if (placeholder.includes('כתובת') || placeholder.includes('address')) {
                    guidance = {
                        title: '📍 שדה כתובת',
                        message: 'כתוב כתובת מלאה. זה יהפוך לקישור לניווט במפות גוגל!',
                        tips: ['כתוב כתובת מלאה עם עיר', 'לדוגמה: רחוב הרצל 15, תל אביב', 'הלקוחות יוכלו ללחוץ ולנווט']
                    };
                } else if (placeholder.includes('מחיר') || placeholder.includes('price')) {
                    guidance = {
                        title: '💰 שדה מחיר',
                        message: 'כתוב את המחיר כמספר. זה יוצג בצורה בולטת בדף.',
                        tips: ['כתוב רק מספר', 'לדוגמה: 150', 'המטבע יתווסף אוטומטית']
                    };
                } else if (placeholder.includes('יומן') || placeholder.includes('calendar') || placeholder.includes('תור')) {
                    guidance = {
                        title: '📅 מערכת תורים',
                        message: 'הוספת מערכת זימון תורים מתקדמת! הלקוחות יוכלו לקבוע תור ישירות דרך הדף.',
                        tips: ['הלקוחות רואים זמינות בזמן אמת', 'אתה מקבל התראות על תורים', 'חוסך זמן ושיחות טלפון', 'מערכת מקצועית ונוחה']
                    };
                } else if (placeholder.includes('סעיף') || placeholder.includes('אופציונ')) {
                    guidance = {
                        title: '📋 סעיפים נוספים',
                        message: 'הוספת סעיפים אופציונליים לדף: לקוחות ממליצים, שאלות ותשובות, הצוות שלנו, גלריה ועוד.',
                        tips: ['בחר רק מה שרלוונטי לעסק', 'לקוחות ממליצים בונים אמון', 'שאלות ותשובות חוסכות זמן', 'גלריה מראה את העבודות']
                    };
                }
                
                if (guidance) {
                    field._guidanceHandler = () => showFieldGuidance(null, guidance);
                    field.addEventListener('focus', field._guidanceHandler);
                    field.addEventListener('click', field._guidanceHandler);
                    console.log('📝 Adding generic guidance to field:', field.placeholder);
                }
            }
            
            // Initial scan
            scanAndAddListeners();
            
            // Scan again after a delay for dynamically created fields
            setTimeout(scanAndAddListeners, 2000);
            setTimeout(scanAndAddListeners, 5000);
            
            // Observer for dynamically created fields
            const observer = new MutationObserver((mutations) => {
                let shouldScan = false;
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            if (node.tagName === 'INPUT' || node.tagName === 'TEXTAREA' || node.tagName === 'SELECT') {
                                shouldScan = true;
                            } else if (node.querySelector) {
                                const hasInputs = node.querySelector('input, textarea, select');
                                if (hasInputs) shouldScan = true;
                            }
                        }
                    });
                });
                
                if (shouldScan) {
                    console.log('🔄 New fields detected, rescanning...');
                    setTimeout(scanAndAddListeners, 100);
                }
            });
            
            observer.observe(document.body, { childList: true, subtree: true });
            
            // Also rescan when template changes
            document.addEventListener('templateChanged', () => {
                console.log('📋 Template changed, rescanning fields...');
                setTimeout(scanAndAddListeners, 500);
            });
        }

        // Initialize field guidance
        addFieldGuidanceListeners();



        // --- I18N Functions ---

        function populateCountryCodes() {

            countries.forEach(country => {

                const option = document.createElement('option');

                option.value = country.code;

                option.textContent = country.name;

                ui.countryCodeSelect.appendChild(option);

            });

            // Set Israel as default

            ui.countryCodeSelect.value = "972";

        }
        function getTranslation(key, lang = state.currentLanguage) {

            const translations = {
                'he': {
                    'modal_close_btn': 'סגור',
                    'main_title': 'AutoPage - צור את הממשק שלך',
                    'main_subtitle': 'צור דף מקצועי תוך דקות עם בוט AI חכם',
                    'create_page_title': 'צור דף',
                    'form_subtitle': 'מלא את הפרטים הבאים',
                    'fieldset_basic_details': 'פרטים בסיסיים',
                    'label_contact_name': 'שם איש קשר',
                    'label_email': 'אימייל',
                    'label_phone': 'טלפון',
                    'label_description': 'תיאור העסק',
                    'label_address': 'כתובת',
                    'fieldset_optional_sections': 'סעיפים אופציונליים',
                    'fieldset_social_media': 'רשתות חברתיות',
                    'label_youtube_display': 'הצגת YouTube',
                    'label_youtube_embed': 'קוד הטמעה',
                    'label_youtube_link': 'קישור',
                    'fieldset_design': 'עיצוב',
                    'label_hero_image': 'תמונת כותרת',
                    'label_use_as_background': 'השתמש כרקע',
                    'note_image_upload': 'העלה תמונה או השאר ריק',
                    'label_additional_settings': 'הגדרות נוספות',
                    'label_output_language': 'שפת הפלט',
                    'label_design_style': 'סגנון עיצוב',
                    'style_minimalist_pro': 'מינימליסטי מקצועי',
                    'style_midnight': 'חצות',
                    'style_claymorphism': 'קליי',
                    'style_retro_title': 'רטרו',
                    'style_retro': 'רטרו',
                    'style_aurora': 'אורורה',
                    'style_bento': 'בנטו',
                    'style_comic': 'קומיקס',
                    'style_surreal': 'סוריאליסטי',
                    'btn_back': 'חזור',
                    'btn_generate': 'צור דף',
                    'fieldset_external_links': 'קישורים חיצוניים',
                    'label_main_button_text': 'טקסט הכפתור הראשי',
                    'label_main_button_url': 'כתובת הכפתור הראשי',
                    'fieldset_property_details': 'פרטי הנכס',
                    'label_beds': 'חדרי שינה',
                    'label_baths': 'חדרי רחצה',
                    'label_sqft': 'מ״ר',
                    'label_price': 'מחיר',
                    'fieldset_app_links': 'קישורי אפליקציות',
                    'label_app_store_link': 'קישור App Store',
                    'label_google_play_link': 'קישור Google Play',
                    'fieldset_event_details': 'פרטי האירוע',
                    'label_event_date': 'תאריך האירוע',
                    'label_event_location': 'שם האולם / מקום האירוע',
                    'label_event_address': 'כתובת המקום',
                    'gen_text_1': '🤖 הבוט החכם שלנו מתחיל ליצור את הדף שלך...',
                    'gen_text_2': '📝 מנתח את הפרטים שמילאת ויוצר תוכן מותאם אישית...',
                    'gen_text_3': '🎨 בוחר את העיצוב המושלם ומתאים את הצבעים והגופנים...',
                    'gen_text_4': '⚡ מיישם טכנולוגיות מתקדמות ומכין את הדף לפרסום...'
                },
                'en': {
                    'modal_close_btn': 'Close',
                    'main_title': 'AutoPage - Create Your Interface',
                    'main_subtitle': 'Create professional pages in minutes with smart AI bot',
                    'create_page_title': 'Create Page',
                    'form_subtitle': 'Fill in the following details',
                    'fieldset_basic_details': 'Basic Details',
                    'label_contact_name': 'Contact Name',
                    'label_email': 'Email',
                    'label_phone': 'Phone',
                    'label_description': 'Business Description',
                    'label_address': 'Address',
                    'fieldset_optional_sections': 'Optional Sections',
                    'fieldset_social_media': 'Social Media',
                    'label_youtube_display': 'YouTube Display',
                    'label_youtube_embed': 'Embed Code',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hero Image',
                    'label_use_as_background': 'Use as Background',
                    'note_image_upload': 'Upload image or leave empty',
                    'label_additional_settings': 'Additional Settings',
                    'label_output_language': 'Output Language',
                    'label_design_style': 'Design Style',
                    'style_minimalist_pro': 'Minimalist Pro',
                    'style_midnight': 'Midnight',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Back',
                    'btn_generate': 'Generate Page',
                    'fieldset_external_links': 'External Links',
                    'label_main_button_text': 'Main Button Text',
                    'label_main_button_url': 'Main Button URL',
                    'fieldset_property_details': 'Property Details',
                    'label_beds': 'Bedrooms',
                    'label_baths': 'Bathrooms',
                    'label_sqft': 'Sq Ft',
                    'label_price': 'Price',
                    'fieldset_app_links': 'App Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link',
                    'fieldset_event_details': 'Event Details',
                    'label_event_date': 'Event Date',
                    'label_event_location': 'Event Location',
                    'label_guest_count': 'Expected Guest Count',
                    'gen_text_1': '🤖 Our smart bot is starting to create your page...',
                    'gen_text_2': '📝 Analyzing your details and creating personalized content...',
                    'gen_text_3': '🎨 Choosing the perfect design and matching colors & fonts...',
                    'gen_text_4': '⚡ Implementing advanced technologies and preparing for launch...'
                },
                'ar': {
                    'modal_close_btn': 'إغلاق',
                    'main_title': 'منشئ صفحات الهبوط المتقدم',
                    'main_subtitle': 'أنشئ صفحات هبوط احترافية في دقائق مع بوت ذكي',
                    'create_page_title': 'إنشاء صفحة',
                    'form_subtitle': 'املأ التفاصيل التالية',
                    'fieldset_basic_details': 'التفاصيل الأساسية',
                    'label_contact_name': 'اسم جهة الاتصال',
                    'label_email': 'البريد الإلكتروني',
                    'label_phone': 'الهاتف',
                    'label_description': 'وصف العمل',
                    'label_address': 'العنوان',
                    'fieldset_optional_sections': 'الأقسام الاختيارية',
                    'fieldset_social_media': 'وسائل التواصل الاجتماعي',
                    'label_youtube_display': 'عرض YouTube',
                    'label_youtube_embed': 'كود التضمين',
                    'label_youtube_link': 'الرابط',
                    'fieldset_design': 'التصميم',
                    'label_hero_image': 'صورة البطل',
                    'label_use_as_background': 'استخدم كخلفية',
                    'note_image_upload': 'ارفع صورة أو اتركها فارغة',
                    'label_additional_settings': 'إعدادات إضافية',
                    'label_output_language': 'لغة الإخراج',
                    'label_design_style': 'نمط التصميم',
                    'style_minimalist_pro': 'بسيط احترافي',
                    'style_midnight': 'منتصف الليل',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'رجعي',
                    'style_retro': 'رجعي',
                    'style_aurora': 'أورورا',
                    'style_bento': 'بنتو',
                    'btn_back': 'رجوع',
                    'btn_generate': 'إنشاء صفحة',
                    'fieldset_external_links': 'الروابط الخارجية',
                    'label_main_button_text': 'نص الزر الرئيسي',
                    'label_main_button_url': 'رابط الزر الرئيسي',
                    'fieldset_property_details': 'تفاصيل العقار',
                    'label_beds': 'غرف النوم',
                    'label_baths': 'الحمامات',
                    'label_sqft': 'قدم مربع',
                    'label_price': 'السعر',
                    'fieldset_app_links': 'روابط التطبيقات',
                    'label_app_store_link': 'رابط App Store',
                    'label_google_play_link': 'رابط Google Play',
                    'gen_text_1': '🤖 البوت الذكي يبدأ في إنشاء صفحتك...',
                    'gen_text_2': '📝 يحلل تفاصيلك وينشئ محتوى مخصص...',
                    'gen_text_3': '🎨 يختار التصميم المثالي ويطابق الألوان والخطوط...',
                    'gen_text_4': '⚡ يطبق التقنيات المتقدمة ويجهز للانطلاق...'
                },
                'ja': {
                    'modal_close_btn': '閉じる',
                    'main_title': '高度なランディングページ作成者',
                    'main_subtitle': 'スマートAIボットで数分でプロフェッショナルなランディングページを作成',
                    'create_page_title': 'ページ作成',
                    'form_subtitle': '以下の詳細を入力してください',
                    'fieldset_basic_details': '基本詳細',
                    'label_contact_name': '連絡先名',
                    'label_email': 'メール',
                    'label_phone': '電話',
                    'label_description': 'ビジネス説明',
                    'label_address': '住所',
                    'fieldset_optional_sections': 'オプションセクション',
                    'fieldset_social_media': 'ソーシャルメディア',
                    'label_youtube_display': 'YouTube表示',
                    'label_youtube_embed': '埋め込みコード',
                    'label_youtube_link': 'リンク',
                    'fieldset_design': 'デザイン',
                    'label_hero_image': 'ヒーロー画像',
                    'label_use_as_background': '背景として使用',
                    'note_image_upload': '画像をアップロードするか空のままにしてください',
                    'label_additional_settings': '追加設定',
                    'label_output_language': '出力言語',
                    'label_design_style': 'デザインスタイル',
                    'style_minimalist_pro': 'ミニマリストプロ',
                    'style_midnight': 'ミッドナイト',
                    'style_claymorphism': 'クレイモーフィズム',
                    'style_retro_title': 'レトロ',
                    'style_retro': 'レトロ',
                    'style_aurora': 'オーロラ',
                    'style_bento': 'ベント',
                    'btn_back': '戻る',
                    'btn_generate': 'ページ生成',
                    'fieldset_external_links': '外部リンク',
                    'label_main_button_text': 'メインボタンテキスト',
                    'label_main_button_url': 'メインボタンURL',
                    'fieldset_property_details': '物件詳細',
                    'label_beds': '寝室',
                    'label_baths': 'バスルーム',
                    'label_sqft': '平方フィート',
                    'label_price': '価格',
                    'fieldset_app_links': 'アプリリンク',
                    'label_app_store_link': 'App Storeリンク',
                    'label_google_play_link': 'Google Playリンク',
                    'gen_text_1': '🤖 スマートボットがページの作成を開始しています...',
                    'gen_text_2': '📝 詳細を分析し、パーソナライズされたコンテンツを作成中...',
                    'gen_text_3': '🎨 完璧なデザインを選択し、色とフォントをマッチング中...',
                    'gen_text_4': '⚡ 高度な技術を実装し、ローンチの準備中...'
                },
                'es': {
                    'modal_close_btn': 'Cerrar',
                    'main_title': 'Creador Avanzado de Páginas de Aterrizaje',
                    'main_subtitle': 'Crea páginas de aterrizaje profesionales en minutos con bot IA inteligente',
                    'create_page_title': 'Crear Página',
                    'form_subtitle': 'Completa los siguientes detalles',
                    'fieldset_basic_details': 'Detalles Básicos',
                    'label_contact_name': 'Nombre de Contacto',
                    'label_email': 'Correo',
                    'label_phone': 'Teléfono',
                    'label_description': 'Descripción del Negocio',
                    'label_address': 'Dirección',
                    'fieldset_optional_sections': 'Secciones Opcionales',
                    'fieldset_social_media': 'Redes Sociales',
                    'label_youtube_display': 'Visualización de YouTube',
                    'label_youtube_embed': 'Código de Integración',
                    'label_youtube_link': 'Enlace',
                    'fieldset_design': 'Diseño',
                    'label_hero_image': 'Imagen Principal',
                    'label_use_as_background': 'Usar como Fondo',
                    'note_image_upload': 'Subir imagen o dejar vacío',
                    'label_additional_settings': 'Configuraciones Adicionales',
                    'label_output_language': 'Idioma de Salida',
                    'label_design_style': 'Estilo de Diseño',
                    'style_minimalist_pro': 'Minimalista Pro',
                    'style_midnight': 'Medianoche',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Atrás',
                    'btn_generate': 'Generar Página',
                    'fieldset_external_links': 'Enlaces Externos',
                    'label_main_button_text': 'Texto del Botón Principal',
                    'label_main_button_url': 'URL del Botón Principal',
                    'fieldset_property_details': 'Detalles de la Propiedad',
                    'label_beds': 'Dormitorios',
                    'label_baths': 'Baños',
                    'label_sqft': 'Pies Cuadrados',
                    'label_price': 'Precio',
                    'fieldset_app_links': 'Enlaces de Aplicaciones',
                    'label_app_store_link': 'Enlace de App Store',
                    'label_google_play_link': 'Enlace de Google Play',
                    'gen_text_1': '🤖 Nuestro bot inteligente está empezando a crear tu página...',
                    'gen_text_2': '📝 Analizando tus detalles y creando contenido personalizado...',
                    'gen_text_3': '🎨 Eligiendo el diseño perfecto y combinando colores y fuentes...',
                    'gen_text_4': '⚡ Implementando tecnologías avanzadas y preparando para el lanzamiento...'
                },
                'fr': {
                    'modal_close_btn': 'Fermer',
                    'main_title': 'Créateur de Pages d\'Atterrissage Avancé',
                    'main_subtitle': 'Créez des pages d\'atterrissage professionnelles en minutes avec un bot IA intelligent',
                    'create_page_title': 'Créer une Page',
                    'form_subtitle': 'Remplissez les détails suivants',
                    'fieldset_basic_details': 'Détails de Base',
                    'label_contact_name': 'Nom du Contact',
                    'label_email': 'Email',
                    'label_phone': 'Téléphone',
                    'label_description': 'Description de l\'Entreprise',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Sections Optionnelles',
                    'fieldset_social_media': 'Réseaux Sociaux',
                    'label_youtube_display': 'Affichage YouTube',
                    'label_youtube_embed': 'Code d\'Intégration',
                    'label_youtube_link': 'Lien',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Image Principale',
                    'label_use_as_background': 'Utiliser comme Arrière-plan',
                    'note_image_upload': 'Télécharger une image ou laisser vide',
                    'label_additional_settings': 'Paramètres Supplémentaires',
                    'label_output_language': 'Langue de Sortie',
                    'label_design_style': 'Style de Design',
                    'style_minimalist_pro': 'Minimaliste Pro',
                    'style_midnight': 'Minuit',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Rétro',
                    'style_retro': 'Rétro',
                    'style_aurora': 'Aurore',
                    'style_bento': 'Bento',
                    'btn_back': 'Retour',
                    'btn_generate': 'Générer Page',
                    'fieldset_external_links': 'Liens Externes',
                    'label_main_button_text': 'Texte du Bouton Principal',
                    'label_main_button_url': 'URL du Bouton Principal',
                    'fieldset_property_details': 'Détails de la Propriété',
                    'label_beds': 'Chambres',
                    'label_baths': 'Salles de Bain',
                    'label_sqft': 'Pieds Carrés',
                    'label_price': 'Prix',
                    'fieldset_app_links': 'Liens d\'Applications',
                    'label_app_store_link': 'Lien App Store',
                    'label_google_play_link': 'Lien Google Play',
                    'gen_text_1': '🤖 Notre bot intelligent commence à créer votre page...',
                    'gen_text_2': '📝 Analyse vos détails et crée du contenu personnalisé...',
                    'gen_text_3': '🎨 Choisit le design parfait et assortit couleurs et polices...',
                    'gen_text_4': '⚡ Implémente des technologies avancées et prépare au lancement...'
                },
                'de': {
                    'modal_close_btn': 'Schließen',
                    'main_title': 'Erweiterter Landing Page Creator',
                    'main_subtitle': 'Erstellen Sie professionelle Landing Pages in Minuten mit intelligentem KI-Bot',
                    'create_page_title': 'Seite Erstellen',
                    'form_subtitle': 'Füllen Sie die folgenden Details aus',
                    'fieldset_basic_details': 'Grundlegende Details',
                    'label_contact_name': 'Kontaktname',
                    'label_email': 'E-Mail',
                    'label_phone': 'Telefon',
                    'label_description': 'Unternehmensbeschreibung',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Optionale Abschnitte',
                    'fieldset_social_media': 'Soziale Medien',
                    'label_youtube_display': 'YouTube-Anzeige',
                    'label_youtube_embed': 'Einbettungscode',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hauptbild',
                    'label_use_as_background': 'Als Hintergrund verwenden',
                    'note_image_upload': 'Bild hochladen oder leer lassen',
                    'label_additional_settings': 'Zusätzliche Einstellungen',
                    'label_output_language': 'Ausgabesprache',
                    'label_design_style': 'Design-Stil',
                    'style_minimalist_pro': 'Minimalistisch Pro',
                    'style_midnight': 'Mitternacht',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Zurück',
                    'btn_generate': 'Seite Generieren',
                    'fieldset_external_links': 'Externe Links',
                    'label_main_button_text': 'Hauptbutton-Text',
                    'label_main_button_url': 'Hauptbutton-URL',
                    'fieldset_property_details': 'Immobiliendetails',
                    'label_beds': 'Schlafzimmer',
                    'label_baths': 'Badezimmer',
                    'label_sqft': 'Quadratfuß',
                    'label_price': 'Preis',
                    'fieldset_app_links': 'App-Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link',
                    'gen_text_1': '🤖 Unser intelligenter Bot beginnt mit der Erstellung Ihrer Seite...',
                    'gen_text_2': '📝 Analysiert Ihre Details und erstellt personalisierten Inhalt...',
                    'gen_text_3': '🎨 Wählt das perfekte Design und passt Farben & Schriftarten an...',
                    'gen_text_4': '⚡ Implementiert fortschrittliche Technologien und bereitet auf den Start vor...'
                },
                'ru': {
                    'modal_close_btn': 'Закрыть',
                    'main_title': 'Продвинутый Создатель Лендингов',
                    'main_subtitle': 'Создавайте профессиональные лендинги за минуты с умным ИИ ботом',
                    'create_page_title': 'Создать Страницу',
                    'form_subtitle': 'Заполните следующие детали',
                    'fieldset_basic_details': 'Основные Детали',
                    'label_contact_name': 'Имя Контакта',
                    'label_email': 'Email',
                    'label_phone': 'Телефон',
                    'label_description': 'Описание Бизнеса',
                    'label_address': 'Адрес',
                    'fieldset_optional_sections': 'Дополнительные Секции',
                    'fieldset_social_media': 'Социальные Сети',
                    'label_youtube_display': 'Отображение YouTube',
                    'label_youtube_embed': 'Код Встраивания',
                    'label_youtube_link': 'Ссылка',
                    'fieldset_design': 'Дизайн',
                    'label_hero_image': 'Главное Изображение',
                    'label_use_as_background': 'Использовать как Фон',
                    'note_image_upload': 'Загрузить изображение или оставить пустым',
                    'label_additional_settings': 'Дополнительные Настройки',
                    'label_output_language': 'Язык Вывода',
                    'label_design_style': 'Стиль Дизайна',
                    'style_minimalist_pro': 'Минималистичный Про',
                    'style_midnight': 'Полночь',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Ретро',
                    'style_retro': 'Ретро',
                    'style_aurora': 'Аврора',
                    'style_bento': 'Бенто',
                    'btn_back': 'Назад',
                    'btn_generate': 'Создать Страницу',
                    'fieldset_external_links': 'Внешние Ссылки',
                    'label_main_button_text': 'Текст Главной Кнопки',
                    'label_main_button_url': 'URL Главной Кнопки',
                    'fieldset_property_details': 'Детали Недвижимости',
                    'label_beds': 'Спальни',
                    'label_baths': 'Ванные',
                    'label_sqft': 'Квадратные Футы',
                    'label_price': 'Цена',
                    'fieldset_app_links': 'Ссылки на Приложения',
                    'label_app_store_link': 'Ссылка App Store',
                    'label_google_play_link': 'Ссылка Google Play',
                    'gen_text_1': '🤖 Наш умный бот начинает создавать вашу страницу...',
                    'gen_text_2': '📝 Анализирует ваши детали и создает персонализированный контент...',
                    'gen_text_3': '🎨 Выбирает идеальный дизайн и подбирает цвета и шрифты...',
                    'gen_text_4': '⚡ Внедряет передовые технологии и готовит к запуску...'
                },
                'zh': {
                    'modal_close_btn': '关闭',
                    'main_title': '高级着陆页创建器',
                    'main_subtitle': '使用智能AI机器人几分钟内创建专业着陆页',
                    'create_page_title': '创建页面',
                    'form_subtitle': '填写以下详细信息',
                    'fieldset_basic_details': '基本详情',
                    'label_contact_name': '联系人姓名',
                    'label_email': '邮箱',
                    'label_phone': '电话',
                    'label_description': '业务描述',
                    'label_address': '地址',
                    'fieldset_optional_sections': '可选部分',
                    'fieldset_social_media': '社交媒体',
                    'label_youtube_display': 'YouTube显示',
                    'label_youtube_embed': '嵌入代码',
                    'label_youtube_link': '链接',
                    'fieldset_design': '设计',
                    'label_hero_image': '主图',
                    'label_use_as_background': '用作背景',
                    'note_image_upload': '上传图片或留空',
                    'label_additional_settings': '其他设置',
                    'label_output_language': '输出语言',
                    'label_design_style': '设计风格',
                    'style_minimalist_pro': '极简专业',
                    'style_midnight': '午夜',
                    'style_claymorphism': '粘土形态',
                    'style_retro_title': '复古',
                    'style_retro': '复古',
                    'style_aurora': '极光',
                    'style_bento': '便当',
                    'btn_back': '返回',
                    'btn_generate': '生成页面',
                    'fieldset_external_links': '外部链接',
                    'label_main_button_text': '主按钮文本',
                    'label_main_button_url': '主按钮URL',
                    'fieldset_property_details': '房产详情',
                    'label_beds': '卧室',
                    'label_baths': '浴室',
                    'label_sqft': '平方英尺',
                    'label_price': '价格',
                    'fieldset_app_links': '应用链接',
                    'label_app_store_link': 'App Store链接',
                    'label_google_play_link': 'Google Play链接',
                    'gen_text_1': '🤖 我们的智能机器人开始创建您的页面...',
                    'gen_text_2': '📝 分析您的详细信息并创建个性化内容...',
                    'gen_text_3': '🎨 选择完美设计并匹配颜色和字体...',
                    'gen_text_4': '⚡ 实施先进技术并准备发布...'
                }
            };
            
            return translations[lang]?.[key] || translations['en']?.[key] || key;
        }



        function setLanguage(lang) {

            state.currentLanguage = lang;

            document.documentElement.lang = lang;

            document.documentElement.dir = (lang === 'he') ? 'rtl' : 'ltr';

            

            // Apply translations to all static elements

            document.querySelectorAll('[data-translate-key]').forEach(el => {

                const key = el.dataset.translateKey;

                el.textContent = getTranslation(key);

            });

             document.querySelectorAll('[data-translate-title]').forEach(el => {

                const key = el.dataset.translateTitle;

                el.title = getTranslation(key);

            });



            // Repopulate dynamic content

            populateTemplateGrid();



            // If in form view, update dynamic form labels

            if(ui.formView.classList.contains('active') && state.selectedPageType) {

                 const template = pageTemplates[state.selectedPageType].t[state.currentLanguage];

                 ui.pageTypeTitle.textContent = template.title;

                 ui.mainNameLabel.textContent = template.label;

                 createDynamicFields(pageTemplates[state.selectedPageType].fields);

            }

        }

        

        // --- Core Functions ---

        function switchView(hideView, showView) {

            if (showView === ui.formView) {

                ui.assistantContainer.classList.remove('hidden');

                // הסתר כפתורי שמירה והורדה במצב טופס
                ui.savePageBtn.classList.add('hidden');
                ui.downloadPageBtn.classList.add('hidden');
            } else {

                ui.assistantContainer.classList.add('hidden');

                // הצג כפתורי שמירה והורדה במצב תצוגה מקדימה
                ui.savePageBtn.classList.remove('hidden');
                ui.downloadPageBtn.classList.remove('hidden');
            }



            if (hideView === ui.previewView) {

                ui.previewView.classList.remove('active');

            } else {

                hideView.classList.add('fade-out');

            }

            

            setTimeout(() => {

                if (hideView !== ui.previewView) {

                    hideView.classList.remove('active', 'fade-out');

                }

                

                if (showView === ui.previewView) {

                    showView.classList.add('active');

                } else {

                    showView.classList.add('active', 'fade-in');

                }



            }, 300);

        }



        function showModal(messageKey) {

            ui.modalMessage.textContent = getTranslation(messageKey);

            ui.customModal.classList.add('visible');

        }



        function hideModal() {

            ui.customModal.classList.remove('visible');

        }



        function getYoutubeVideoId(url) {

            if (!url) return null;

            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;

            const match = url.match(regExp);

            return (match && match[2].length === 11) ? match[2] : null;

        }
        function createMasterPrompt(data) {

            console.log('createMasterPrompt called with data:', data);
            console.log('data.pageType:', data.pageType);
            console.log('data.outputLanguage:', data.outputLanguage);
            const s = (str) => (str || '').replace(/`/g, "'").replace(/\\/g, '\\\\');

            const templateRoot = pageTemplates[data.pageType];

            const templateLang = templateRoot.t[data.outputLanguage]; // Use OUTPUT language

            console.log('templateRoot:', templateRoot);
            console.log('templateLang:', templateLang);
            
            if (!templateRoot) {
                console.error('templateRoot is null/undefined for pageType:', data.pageType);
                return 'Error: Invalid page type';
            }
            
            if (!templateLang) {
                console.error('templateLang is null/undefined for outputLanguage:', data.outputLanguage);
                return 'Error: Invalid output language';
            }
            const youtubeVideoId = getYoutubeVideoId(data.youtubeLink);

            const cleanYoutubeEmbedUrl = youtubeVideoId ? `https://www.youtube.com/embed/${youtubeVideoId}` : null;

            

            let finalStructurePrompt = templateRoot.structurePrompt;

            // Always include Accessibility, WhatsApp bubble, and AI bot on all pages except flyer
            if (data.pageType !== 'flyer') {
                finalStructurePrompt += `

## 🚨 MANDATORY FLOATING ELEMENTS (REQUIRED ON ALL PAGES EXCEPT FLYER) 🚨

**⚠️ CRITICAL: These 3 elements MUST appear in the HTML <body> tag, NOT just in CSS!**

**IMPORTANT DESIGN DISTINCTION:**
- 🔘 **Accessibility** = RECTANGULAR BUTTON (with text "נגישות")
- 🟢 **WhatsApp** = CIRCULAR BUBBLE (only icon, no text)
- 🟣 **AI Bot** = CIRCULAR BUBBLE (only icon, no text)

### 1️⃣ ACCESSIBILITY MENU (CRITICAL - ALWAYS INCLUDE):

**📍 Location:** Inside the header navigation bar, together with other nav links (בית, אודותינו, צור קשר)

**🎨 Design:** BUTTON integrated into navigation, styled like a nav button with "נגישות" text

**⚠️ IMPORTANT:** NOT a floating/fixed button! Part of the navigation!

**⚠️ CRITICAL: Accessibility button MUST be in the navigation bar, NOT a floating button!**

**MUST USE THIS EXACT DESIGN - IN THE HEADER NAVIGATION:**
\`\`\`html
<!-- ⚠️ CRITICAL: Accessibility button is part of the navigation bar! -->
<!-- Example: Add it to the nav links in the header -->
<nav style="display: flex; gap: 24px; align-items: center;">
    <a href="#home" style="font-size: 17px; font-weight: 600; color: #1F2937;">בית</a>
    <a href="#about" style="font-size: 17px; font-weight: 600; color: #1F2937;">אודותינו</a>
    <a href="#contact" style="font-size: 17px; font-weight: 600; color: #1F2937;">צור קשר</a>
    
    <!-- Accessibility button in navigation -->
    <button id="accessibility-btn" class="accessibility-toggle" style="background: #4A5568; color: white; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <circle cx="12" cy="12" r="3"></circle>
        <line x1="12" y1="2" x2="12" y2="4"></line>
        <line x1="12" y1="20" x2="12" y2="22"></line>
        <line x1="4" y1="12" x2="2" y2="12"></line>
        <line x1="22" y1="12" x2="20" y2="12"></line>
    </svg>
        <span>נגישות</span>
</button>
</nav>

<!-- Accessibility menu opens below the header -->
<div id="accessibility-menu" class="accessibility-menu" style="display: none; position: fixed; top: 80px; right: 20px; z-index: 10001; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); padding: 20px; min-width: 280px;">
    <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: bold; color: #2D3748;">נגישות</h3>
    
    <!-- Font Size Controls -->
    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #E2E8F0;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4A5568;">גודל טקסט:</label>
        <div style="display: flex; gap: 8px;">
            <button onclick="changeFontSize('decrease')" style="flex: 1; padding: 8px; background: #EDF2F7; border: 1px solid #CBD5E0; border-radius: 6px; cursor: pointer; font-weight: 600;">A-</button>
            <button onclick="changeFontSize('reset')" style="flex: 1; padding: 8px; background: #EDF2F7; border: 1px solid #CBD5E0; border-radius: 6px; cursor: pointer; font-weight: 600;">A</button>
            <button onclick="changeFontSize('increase')" style="flex: 1; padding: 8px; background: #EDF2F7; border: 1px solid #CBD5E0; border-radius: 6px; cursor: pointer; font-weight: 600;">A+</button>
        </div>
    </div>
    
    <!-- Contrast Toggle -->
    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #E2E8F0;">
        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
            <span style="font-weight: 600; color: #4A5568;">ניגודיות גבוהה</span>
            <input type="checkbox" id="contrast-toggle" onchange="toggleContrast()" style="width: 20px; height: 20px; cursor: pointer;">
        </label>
    </div>
    
    <!-- Readable Font Toggle -->
    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #E2E8F0;">
        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
            <span style="font-weight: 600; color: #4A5568;">גופן קריא</span>
            <input type="checkbox" id="readable-font-toggle" onchange="toggleReadableFont()" style="width: 20px; height: 20px; cursor: pointer;">
        </label>
    </div>
    
    <!-- Highlight Links -->
    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #E2E8F0;">
        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
            <span style="font-weight: 600; color: #4A5568;">הדגש קישורים</span>
            <input type="checkbox" id="highlight-links-toggle" onchange="toggleHighlightLinks()" style="width: 20px; height: 20px; cursor: pointer;">
        </label>
    </div>
    
    <!-- Cursor Size -->
    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #E2E8F0;">
        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
            <span style="font-weight: 600; color: #4A5568;">סמן גדול</span>
            <input type="checkbox" id="large-cursor-toggle" onchange="toggleLargeCursor()" style="width: 20px; height: 20px; cursor: pointer;">
        </label>
    </div>
    
    <!-- Line Height -->
    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #E2E8F0;">
        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
            <span style="font-weight: 600; color: #4A5568;">ריווח שורות מוגבר</span>
            <input type="checkbox" id="line-height-toggle" onchange="toggleLineHeight()" style="width: 20px; height: 20px; cursor: pointer;">
        </label>
    </div>
    
    <!-- Pause Animations -->
    <div style="margin-bottom: 15px;">
        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
            <span style="font-weight: 600; color: #4A5568;">עצור אנימציות</span>
            <input type="checkbox" id="pause-animations-toggle" onchange="toggleAnimations()" style="width: 20px; height: 20px; cursor: pointer;">
        </label>
    </div>
    
    <!-- Reset Button -->
    <button onclick="resetAccessibility()" style="width: 100%; padding: 10px; background: #E53E3E; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 10px;">איפוס הגדרות</button>
</div>
\`\`\`

**🔧 JavaScript Functions (MANDATORY - MUST WORK):**
\`\`\`javascript
// Toggle accessibility menu
document.getElementById('accessibility-btn').addEventListener('click', function() {
    const menu = document.getElementById('accessibility-menu');
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
});

// Close menu when clicking outside
document.addEventListener('click', function(e) {
    const btn = document.getElementById('accessibility-btn');
    const menu = document.getElementById('accessibility-menu');
    if (!btn.contains(e.target) && !menu.contains(e.target)) {
        menu.style.display = 'none';
    }
});

// Font size control
let currentFontSize = 100;
function changeFontSize(action) {
    if (action === 'increase') currentFontSize += 10;
    else if (action === 'decrease') currentFontSize -= 10;
    else currentFontSize = 100;
    
    currentFontSize = Math.max(80, Math.min(140, currentFontSize));
    document.body.style.fontSize = currentFontSize + '%';
    localStorage.setItem('fontSize', currentFontSize);
}

// Contrast toggle
function toggleContrast() {
    const isEnabled = document.getElementById('contrast-toggle').checked;
    if (isEnabled) {
        document.body.style.filter = 'contrast(1.5)';
        document.body.style.background = '#000';
        document.body.style.color = '#fff';
    } else {
        document.body.style.filter = '';
        document.body.style.background = '';
        document.body.style.color = '';
    }
    localStorage.setItem('highContrast', isEnabled);
}

// Readable font toggle
function toggleReadableFont() {
    const isEnabled = document.getElementById('readable-font-toggle').checked;
    document.body.style.fontFamily = isEnabled ? 'Arial, sans-serif' : '';
    localStorage.setItem('readableFont', isEnabled);
}

// Highlight links
function toggleHighlightLinks() {
    const isEnabled = document.getElementById('highlight-links-toggle').checked;
    const links = document.querySelectorAll('a');
    links.forEach(link => {
        if (isEnabled) {
            link.style.textDecoration = 'underline';
            link.style.fontWeight = 'bold';
            link.style.color = '#0066cc';
        } else {
            link.style.textDecoration = '';
            link.style.fontWeight = '';
            link.style.color = '';
        }
    });
    localStorage.setItem('highlightLinks', isEnabled);
}

// Large cursor
function toggleLargeCursor() {
    const isEnabled = document.getElementById('large-cursor-toggle').checked;
    document.body.style.cursor = isEnabled ? 'url("data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'32\\' height=\\'32\\'%3E%3Cpath d=\\'M0,0 L0,24 L8,18 L12,28 L16,26 L12,16 L20,16 Z\\' fill=\\'black\\' stroke=\\'white\\' stroke-width=\\'2\\'/%3E%3C/svg%3E") 0 0, auto' : '';
    localStorage.setItem('largeCursor', isEnabled);
}

// Line height
function toggleLineHeight() {
    const isEnabled = document.getElementById('line-height-toggle').checked;
    document.body.style.lineHeight = isEnabled ? '1.8' : '';
    localStorage.setItem('lineHeight', isEnabled);
}

// Pause animations
function toggleAnimations() {
    const isEnabled = document.getElementById('pause-animations-toggle').checked;
    if (isEnabled) {
        const style = document.createElement('style');
        style.id = 'pause-animations-style';
        style.textContent = '* { animation: none !important; transition: none !important; }';
        document.head.appendChild(style);
    } else {
        const style = document.getElementById('pause-animations-style');
        if (style) style.remove();
    }
    localStorage.setItem('pauseAnimations', isEnabled);
}

// Reset all accessibility settings
function resetAccessibility() {
    currentFontSize = 100;
    document.body.style.fontSize = '';
    document.body.style.filter = '';
    document.body.style.background = '';
    document.body.style.color = '';
    document.body.style.fontFamily = '';
    document.body.style.cursor = '';
    document.body.style.lineHeight = '';
    
    document.getElementById('contrast-toggle').checked = false;
    document.getElementById('readable-font-toggle').checked = false;
    document.getElementById('highlight-links-toggle').checked = false;
    document.getElementById('large-cursor-toggle').checked = false;
    document.getElementById('line-height-toggle').checked = false;
    document.getElementById('pause-animations-toggle').checked = false;
    
    const links = document.querySelectorAll('a');
    links.forEach(link => {
        link.style.textDecoration = '';
        link.style.fontWeight = '';
        link.style.color = '';
    });
    
    const style = document.getElementById('pause-animations-style');
    if (style) style.remove();
    
    localStorage.clear();
}

// Load saved settings on page load
window.addEventListener('DOMContentLoaded', function() {
    const savedFontSize = localStorage.getItem('fontSize');
    if (savedFontSize) {
        currentFontSize = parseInt(savedFontSize);
        document.body.style.fontSize = currentFontSize + '%';
    }
    
    if (localStorage.getItem('highContrast') === 'true') {
        document.getElementById('contrast-toggle').checked = true;
        toggleContrast();
    }
    
    if (localStorage.getItem('readableFont') === 'true') {
        document.getElementById('readable-font-toggle').checked = true;
        toggleReadableFont();
    }
    
    if (localStorage.getItem('highlightLinks') === 'true') {
        document.getElementById('highlight-links-toggle').checked = true;
        toggleHighlightLinks();
    }
    
    if (localStorage.getItem('largeCursor') === 'true') {
        document.getElementById('large-cursor-toggle').checked = true;
        toggleLargeCursor();
    }
    
    if (localStorage.getItem('lineHeight') === 'true') {
        document.getElementById('line-height-toggle').checked = true;
        toggleLineHeight();
    }
    
    if (localStorage.getItem('pauseAnimations') === 'true') {
        document.getElementById('pause-animations-toggle').checked = true;
        toggleAnimations();
    }
});
\`\`\`

---

### 2️⃣ WHATSAPP FLOATING BUBBLE (CRITICAL - ALWAYS INCLUDE):

**📍 Location:** Fixed position, bottom-left corner
**📱 Phone:** ${data.whatsappCountryCode || '+972'}${data.phone || ''}

\`\`\`html
<a href="https://wa.me/${(data.whatsappCountryCode || '+972').replace('+', '')}${data.phone || ''}" target="_blank" id="whatsapp-bubble" style="position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: #25D366; color: white; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4); transition: all 0.3s; text-decoration: none;">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="white">
        <path d="M16 0C7.163 0 0 7.163 0 16c0 2.825.738 5.488 2.038 7.788L0 32l8.4-2.2C10.663 31.087 13.263 32 16 32c8.837 0 16-7.163 16-16S24.837 0 16 0zm0 29.25c-2.438 0-4.75-.663-6.738-1.825l-.488-.288-5.025 1.313 1.338-4.888-.313-.5C3.663 21.075 3 18.6 3 16c0-7.175 5.825-13 13-13s13 5.825 13 13-5.825 13-13 13zm7.125-9.375c-.388-.188-2.3-1.138-2.663-1.263-.363-.125-.625-.188-.888.188-.263.375-1.013 1.263-1.238 1.525-.225.263-.45.3-.838.113-.388-.188-1.638-.6-3.113-1.913-1.15-1.025-1.925-2.288-2.15-2.675-.225-.388-.025-.6.163-.788.175-.175.388-.45.575-.675.188-.225.25-.375.375-.625.125-.25.063-.475-.025-.663-.088-.188-.888-2.138-1.213-2.925-.325-.763-.65-.663-.888-.675h-.763c-.263 0-.675.1-1.025.475-.35.375-1.35 1.313-1.35 3.2s1.388 3.713 1.575 3.975c.188.263 2.638 4.025 6.388 5.638.888.388 1.588.625 2.125.8.9.275 1.713.238 2.363.15.725-.113 2.3-.938 2.625-1.85.325-.913.325-1.688.225-1.85-.1-.163-.363-.263-.75-.45z"/>
    </svg>
</a>
\`\`\`

**🔧 Hover Effect (MANDATORY):**
\`\`\`css
#whatsapp-bubble:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
}
\`\`\`

---

### 3️⃣ AI BOT "סתיו" BUBBLE (CRITICAL - ALWAYS INCLUDE):

**📍 Location:** Fixed position, bottom-right corner
**🤖 Webhook:** https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbmreketpg

\`\`\`html
<div id="ai-bot-bubble" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
    <button id="ai-bot-btn" style="background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); transition: all 0.3s; display: flex; align-items: center; justify-content: center;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="10" rx="2" ry="2"></rect>
            <circle cx="12" cy="5" r="2"></circle>
            <path d="M12 7v4"></path>
            <line x1="8" y1="16" x2="8" y2="16"></line>
            <line x1="16" y1="16" x2="16" y2="16"></line>
        </svg>
    </button>
    
    <div id="ai-chat-window" style="display: none; position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); overflow: hidden; flex-direction: column; z-index: 10000;">
        <div style="background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; position: absolute; top: 0; left: 0; right: 0; z-index: 10001; height: 70px; box-sizing: border-box;">
            <div>
                <h3 style="margin: 0; font-size: 18px; font-weight: bold;">סתיו - עוזרת וירטואלית</h3>
                <p style="margin: 4px 0 0 0; font-size: 12px; opacity: 0.9;">אני כאן לעזור לך! 😊</p>
            </div>
            <button id="ai-close-btn" style="background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 20px; line-height: 1;">×</button>
        </div>
        
        <div id="ai-chat-messages" style="position: absolute; top: 70px; left: 0; right: 0; bottom: 72px; overflow-y: auto; padding: 16px; background: #F7FAFC;">
            <div style="background: #E9D5FF; padding: 16px; border-radius: 12px; margin-bottom: 12px;">
                <p style="margin: 0; color: #1F2937; font-size: 15px; line-height: 1.6; font-weight: 600;">שלום! 😊 איך אני יכולה לעזור לך?</p>
                <p style="margin: 8px 0 0 0; color: #1F2937; font-size: 14px; line-height: 1.5;">אני סתיו, העוזרת הוירטואלית שלך! 💜</p>
                <p style="margin: 8px 0 0 0; color: #1F2937; font-size: 14px; line-height: 1.5;">אני כאן לעזור לך עם כל מה שקשור לעסק - שאלות על המוצרים, הוספת מוצרים לעגלה, מידע נוסף, או כל דבר אחר שאתה צריך! ✨</p>
            </div>
        </div>
        
        <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 16px; border-top: 1px solid #E2E8F0; background: white; min-height: 72px; box-sizing: border-box;">
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="ai-user-input" placeholder="הקלד הודעה..." style="flex: 1; padding: 12px; border: 1px solid #CBD5E0; border-radius: 8px; font-size: 16px; font-weight: 500; box-sizing: border-box;">
                <button id="ai-send-btn" style="background: #8B5CF6; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; flex-shrink: 0; box-sizing: border-box;">שלח</button>
            </div>
        </div>
    </div>
</div>
\`\`\`

**🔧 JavaScript Logic (MANDATORY - MUST WORK PERFECTLY):**
\`\`\`javascript
// AI Bot Toggle - MUST WORK WITHOUT BUGS
const aiBotBtn = document.getElementById('ai-bot-btn');
const aiChatWindow = document.getElementById('ai-chat-window');
const aiCloseBtn = document.getElementById('ai-close-btn');
const aiSendBtn = document.getElementById('ai-send-btn');
const aiUserInput = document.getElementById('ai-user-input');
const aiChatMessages = document.getElementById('ai-chat-messages');

// Toggle chat window - RELIABLE CLICK HANDLER
aiBotBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    const isVisible = aiChatWindow.style.display === 'flex';
    aiChatWindow.style.display = isVisible ? 'none' : 'flex';
    if (!isVisible) {
        aiUserInput.focus();
    }
});

// Close button - MUST WORK EVERY TIME
aiCloseBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    aiChatWindow.style.display = 'none';
    
    // 🔄 Clear chat history and reset to initial message
    aiChatMessages.innerHTML = \`
        <div style="background: #E9D5FF; padding: 12px; border-radius: 12px; margin-bottom: 12px;">
            <p style="margin: 0; color: #1F2937; font-size: 15px; line-height: 1.5;">שלום! 😊 איך אני יכולה לעזור לך?</p>
            <p style="margin: 8px 0 0 0; color: #1F2937; font-size: 14px; line-height: 1.5;">אני סתיו, העוזרת הוירטואלית שלך! 💜</p>
            <p style="margin: 8px 0 0 0; color: #1F2937; font-size: 14px; line-height: 1.5;">אני כאן לעזור לך עם כל מה שקשור לעסק - שאלות על המוצרים, הוספת מוצרים לעגלה, מידע נוסף, או כל דבר אחר שאתה צריך! ✨</p>
        </div>
    \`;
    
    // Clear input field
    aiUserInput.value = '';
    
    console.log('✅ Chat history cleared');
});

// Send message function - MUST SUPPORT ADD TO CART
async function sendAiMessage() {
    const message = aiUserInput.value.trim();
    if (!message) return;
    
    // Add user message to chat
    const userMsgDiv = document.createElement('div');
    userMsgDiv.style.cssText = 'background: #8B5CF6; color: white; padding: 12px; border-radius: 12px; margin-bottom: 12px; text-align: right; font-size: 16px; font-weight: 500; line-height: 1.5;';
    userMsgDiv.textContent = message;
    aiChatMessages.appendChild(userMsgDiv);
    
    aiUserInput.value = '';
    aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
    
    // Show typing indicator
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.style.cssText = 'background: #E9D5FF; padding: 12px; border-radius: 12px; margin-bottom: 12px;';
    typingDiv.innerHTML = '<p style="margin: 0; color: #1F2937; font-size: 15px; line-height: 1.5;">סתיו מקלידה...</p>';
    aiChatMessages.appendChild(typingDiv);
    aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
    
    try {
        // 📊 Extract ALL page content for smart bot responses
        const pageContent = {
            // Basic info
            title: document.querySelector('h1')?.textContent?.trim() || document.title,
            businessName: document.querySelector('meta[name="business-name"]')?.content || '',
            
            // Products (if store) - extract from DOM
            products: Array.from(document.querySelectorAll('.product-card, [class*="product-"], .card')).map(card => {
                const nameEl = card.querySelector('h1, h2, h3, h4, [class*="title"], [class*="name"], .product-name');
                const priceEl = card.querySelector('[class*="price"], .product-price, .price');
                const imgEl = card.querySelector('img');
                
                const name = nameEl?.textContent?.trim() || '';
                let price = 0;
                
                if (priceEl) {
                    const priceText = priceEl.textContent || '';
                    const match = priceText.match(/₪\s*(\d+(?:\.\d+)?)/);
                    if (match) {
                        price = parseFloat(match[1]);
                    }
                }
                
                // Only return products with valid name and price
                if (name && price > 0) {
                    return {
                        name: name,
                        price: price,
                        image: imgEl?.src || '',
                        description: card.querySelector('p')?.textContent?.trim().substring(0, 100) || ''
                    };
                }
                return null;
            }).filter(p => p !== null)
        };
        
        console.log('📊 Sending page content to bot:', pageContent);
        console.log('🛍️ Products found:', pageContent.products.length, pageContent.products);
        
        // Send to webhook
        const response = await fetch('https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbkfhkfggyt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: message, 
                pageContext: window.location.href,
                pageContent: pageContent
            })
        });
        
        let data = await response.json();
        
        // 🔍 Parse data.output if it exists (n8n wraps response in "output")
        if (data.output && typeof data.output === 'string') {
            try { 
                console.log('🔍 Parsing data.output...');
                data = JSON.parse(data.output); 
            } catch (e) { 
                console.warn('output field looks like JSON but failed to parse:', e); 
            }
        }
        
        // 🔍 Parse data.message if it looks like JSON
        if (data.message && typeof data.message === 'string' && data.message.startsWith('{')) {
            try { 
                const parsed = JSON.parse(data.message); 
                data = parsed; 
            } catch (e) { 
                console.warn('message field looks like JSON but failed to parse'); 
            }
        }
        
        console.log('📊 Final parsed data:', data);
        
        // Remove typing indicator
        typingDiv.remove();
        
        // Check for bot actions and execute them
        if (data.action) {
            console.log('🤖 Bot action received:', data.action, data);
            switch(data.action) {
                case 'add_to_cart':
                    // Add products to cart - supports MULTIPLE products and quantities
                    console.log('🛒 Attempting to add to cart:', data.items);
                    if (data.items && Array.isArray(data.items)) {
                        if (typeof window.addToCart === 'function') {
                            console.log('✅ addToCart function exists');
                            data.items.forEach(item => {
                                console.log('➕ Adding item:', item);
                                for (let i = 0; i < (item.quantity || 1); i++) {
                                    window.addToCart(item.product_name, item.price, item.image || '');
                                }
                            });
                            console.log('✅ All items added successfully');
                        } else {
                            console.error('❌ addToCart function not found!');
                        }
                    } else {
                        console.error('❌ Invalid items data:', data.items);
                    }
                    break;
                    
                case 'scroll_to_home':
                    // Scroll to top of page (home)
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    break;
                    
                case 'scroll_to_about':
                    // Scroll to about section
                    const aboutSection = document.querySelector('#about, [id*="about"], .about-section, [class*="about"]');
                    if (aboutSection) {
                        aboutSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    break;
                    
                case 'scroll_to_products':
                    // Scroll to products section
                    const productsSection = document.querySelector('#products, [id*="product"], .products-section, section:has(.product-card)');
                    if (productsSection) {
                        productsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    break;
                    
                case 'scroll_to_faq':
                    // Scroll to FAQ section
                    const faqSection = document.querySelector('#faq, [id*="faq"], .faq-section, section:has(details)');
                    if (faqSection) {
                        faqSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    break;
                    
                case 'scroll_to_testimonials':
                    // Scroll to testimonials/reviews section
                    const testimonialsSection = document.querySelector('#testimonials, [id*="testimonial"], [id*="review"], .testimonials-section, .reviews-section');
                    if (testimonialsSection) {
                        testimonialsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    break;
                    
                case 'scroll_to_contact':
                    // Scroll to contact section
                    const contactSection = document.querySelector('#contact, [id*="contact"], .contact-section, footer');
                    if (contactSection) {
                        contactSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    break;
                    
                case 'fill_rsvp_form':
                    // Fill RSVP form with provided data
                    if (data.formData) {
                        const nameInput = document.querySelector('input[name*="name"], input[placeholder*="שם"]');
                        const phoneInput = document.querySelector('input[name*="phone"], input[placeholder*="טלפון"]');
                        const guestsInput = document.querySelector('input[name*="guest"], input[placeholder*="מלווים"]');
                        
                        if (nameInput && data.formData.name) nameInput.value = data.formData.name;
                        if (phoneInput && data.formData.phone) phoneInput.value = data.formData.phone;
                        if (guestsInput && data.formData.guests) guestsInput.value = data.formData.guests;
                        
                        // Scroll to form
                        const form = document.querySelector('form, [id*="rsvp"]');
                        if (form) form.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    break;
                    
                case 'enroll_course':
                    // Enroll in a specific course
                    if (data.courseData && typeof window.addToCart === 'function') {
                        window.addToCart(data.courseData.name, data.courseData.price, data.courseData.image || '');
                    } else if (data.items && Array.isArray(data.items) && typeof window.addToCart === 'function') {
                        // Support items array format for courses too
                        data.items.forEach(item => {
                            window.addToCart(item.product_name || item.name, item.price, item.image || '');
                        });
                    }
                    break;
                    
                case 'open_whatsapp':
                    // Open WhatsApp chat
                    const whatsappBtn = document.querySelector('[href*="wa.me"], [href*="whatsapp"]');
                    if (whatsappBtn) {
                        whatsappBtn.click();
                    }
                    break;
                    
                case 'show_recommendations':
                    // Scroll to recommendations/products
                    const recsSection = document.querySelector('[id*="recommend"], .recommendations, #products');
                    if (recsSection) {
                        recsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    break;
                    
                case 'scroll_to_appointments':
                    // Scroll to appointments/queue section
                    const appointmentsSection = document.querySelector('#appointments, [id*="appointment"], [id*="queue"], .appointments-section, .queue-section');
                    if (appointmentsSection) {
                        appointmentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    break;
                    
                case 'book_appointment':
                    // Book a specific appointment slot
                    if (data.appointmentData) {
                        const { time, date, name, phone } = data.appointmentData;
                        console.log('📅 Booking appointment:', data.appointmentData);
                        
                        // Find the appointment slot
                        const slots = Array.from(document.querySelectorAll('[data-appointment-slot], [class*="appointment-slot"], [class*="time-slot"]'));
                        const targetSlot = slots.find(slot => 
                            slot.textContent.includes(time) && 
                            (!date || slot.dataset.date === date || slot.closest('[data-date]')?.dataset.date === date)
                        );
                        
                        if (targetSlot && !targetSlot.classList.contains('booked')) {
                            // Click the slot
                            targetSlot.click();
                            
                            // Fill in the booking form if it appears
                            setTimeout(() => {
                                const nameInput = document.querySelector('input[name*="name"], input[placeholder*="שם"]');
                                const phoneInput = document.querySelector('input[name*="phone"], input[placeholder*="טלפון"]');
                                
                                if (nameInput && name) nameInput.value = name;
                                if (phoneInput && phone) phoneInput.value = phone;
                                
                                // Try to submit
                                const submitBtn = document.querySelector('button[type="submit"], button:contains("אישור"), button:contains("קבע תור")');
                                if (submitBtn) {
                                    console.log('✅ Submitting appointment booking');
                                    // We don't auto-submit - let user confirm
                                }
                            }, 500);
                        } else if (targetSlot && targetSlot.classList.contains('booked')) {
                            console.warn('⚠️ Slot already booked:', time);
                        } else {
                            console.error('❌ Slot not found:', time, date);
                        }
                    }
                    break;
            }
        }
        
        // Add bot response - ONLY THE MESSAGE TEXT
        const botMsgDiv = document.createElement('div');
        botMsgDiv.style.cssText = 'background: #E9D5FF; padding: 12px; border-radius: 12px; margin-bottom: 12px;';
        const messageText = data.message || data.response || 'מצטערת, לא הצלחתי להבין. נסה שוב?';
        botMsgDiv.innerHTML = '<p style="margin: 0; color: #1F2937; font-size: 15px; line-height: 1.5; font-weight: 500;">' + messageText + '</p>';
        aiChatMessages.appendChild(botMsgDiv);
        
    } catch (error) {
        typingDiv.remove();
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'background: #FED7D7; padding: 12px; border-radius: 12px; margin-bottom: 12px;';
        errorDiv.innerHTML = '<p style="margin: 0; color: #991B1B; font-size: 15px; line-height: 1.5; font-weight: 500;">אופס! משהו השתבש. נסה שוב מאוחר יותר.</p>';
        aiChatMessages.appendChild(errorDiv);
    }
    
    aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
}

// Send on button click
aiSendBtn.addEventListener('click', sendAiMessage);

// Send on Enter key
aiUserInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendAiMessage();
    }
});

// Hover effect for bot button
aiBotBtn.addEventListener('mouseenter', function() {
    this.style.transform = 'scale(1.1)';
    this.style.boxShadow = '0 6px 20px rgba(139, 92, 246, 0.6)';
});

aiBotBtn.addEventListener('mouseleave', function() {
    this.style.transform = 'scale(1)';
    this.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.4)';
});

\`\`\`

---

**🚨 CRITICAL REQUIREMENTS - MUST INCLUDE IN HTML BODY:**
- ✅ **MANDATORY HTML:** All 3 elements (Accessibility, WhatsApp, AI Bot) MUST be included in the <body> tag
- ✅ **NOT JUST CSS:** The actual HTML elements must exist, not just their styles
- ✅ **COPY THE HTML:** Use the exact HTML code provided above for each element
- ✅ Accessibility menu MUST have ALL 7 options working perfectly
- ✅ AI Bot MUST open/close reliably without bugs
- ✅ WhatsApp bubble MUST link to correct phone number: ${data.whatsappCountryCode || '+972'}${data.phone || ''}
- ✅ All settings MUST persist in localStorage
- ✅ Mobile responsive design
- ✅ RTL support for Hebrew

**🔴 VERIFICATION CHECKLIST (MUST PASS ALL):**
1. ✅ Accessibility = RECTANGULAR BUTTON with text "נגישות" (LEFT side, NOT a circle bubble)
2. ✅ WhatsApp = GREEN CIRCLE bubble (bottom-left)
3. ✅ AI Bot = PURPLE CIRCLE bubble (bottom-right)
4. ✅ Accessibility button does NOT block the logo
5. ✅ All 3 elements have working click handlers
6. ✅ ALL text in AI bot chat is READABLE (dark text, not light purple)
7. ✅ AI Bot user input field is font-size: 16px (NOT tiny!)
8. ✅ AI Bot user messages are font-size: 16px with good contrast
9. ✅ ALL button texts have GOOD CONTRAST and are READABLE
10. ✅ "קנה עכשיו" / "הוסף לעגלה" button text is CLEARLY VISIBLE
11. ✅ Navigation links (בית, מוצרים, צור קשר) are font-size: 16-18px (readable!)
12. ✅ HTML code is in <body>, not just CSS

**IF ANY OF THESE ARE MISSING OR WRONG, THE PAGE IS INCOMPLETE!**
`;
            }

            // Service provider: include appointment booking if enabled
            if (data.pageType === 'serviceProvider' && (data.enableAppointmentBooking === true || data.enableAppointmentBooking === 'on')) {
                const workDaysArray = Array.isArray(data.workDays) ? data.workDays : (data.workDays || 'monday,tuesday,wednesday,thursday,friday').split(',');
                const workDaysText = workDaysArray.join(', ');
                
                // מיפוי ימים לעברית ואנגלית
                const dayMapping = {
                    'sunday': { en: 'Sunday', he: 'ראשון', num: 0 },
                    'monday': { en: 'Monday', he: 'שני', num: 1 },
                    'tuesday': { en: 'Tuesday', he: 'שלישי', num: 2 },
                    'wednesday': { en: 'Wednesday', he: 'רביעי', num: 3 },
                    'thursday': { en: 'Thursday', he: 'חמישי', num: 4 },
                    'friday': { en: 'Friday', he: 'שישי', num: 5 },
                    'saturday': { en: 'Saturday', he: 'שבת', num: 6 }
                };
                
                const workDaysNumbers = workDaysArray.map(day => dayMapping[day.toLowerCase()]?.num).filter(n => n !== undefined);
                const workDaysHebrew = workDaysArray.map(day => dayMapping[day.toLowerCase()]?.he).filter(h => h);
                
                const startTime = data.workStartTime || '09:00';
                const endTime = data.workEndTime || '17:00';
                
                // אסוף הפסקות
                let breaksData = [];
                let breaksText = '';
                if (data.breakStart && Array.isArray(data.breakStart)) {
                    for (let i = 0; i < data.breakStart.length; i++) {
                        if (data.breakStart[i] && data.breakEnd[i]) {
                            const desc = data.breakDescription && data.breakDescription[i] ? data.breakDescription[i] : '';
                            breaksData.push({ start: data.breakStart[i], end: data.breakEnd[i], desc: desc });
                        }
                    }
                    if (breaksData.length > 0) {
                        breaksText = `\n- **BREAKS (mark as unavailable):** ${breaksData.map(b => `${b.start}-${b.end}${b.desc ? ` (${b.desc})` : ''}`).join(', ')}`;
                    }
                }
                
                // אסוף שעות מיוחדות לימים ספציפיים
                let specialHoursData = [];
                let specialHoursText = '';
                if (data.specialDay && Array.isArray(data.specialDay)) {
                    for (let i = 0; i < data.specialDay.length; i++) {
                        if (data.specialDay[i] && data.specialStartTime[i] && data.specialEndTime[i]) {
                            const dayHebrew = dayMapping[data.specialDay[i].toLowerCase()]?.he || data.specialDay[i];
                            specialHoursData.push({ 
                                day: data.specialDay[i], 
                                dayHebrew: dayHebrew,
                                start: data.specialStartTime[i], 
                                end: data.specialEndTime[i] 
                            });
                        }
                    }
                    if (specialHoursData.length > 0) {
                        specialHoursText = `\n- **SPECIAL HOURS (override default hours for specific days):** ${specialHoursData.map(s => `${s.dayHebrew} (${s.day}): ${s.start}-${s.end}`).join(', ')}`;
                    }
                }
                
                finalStructurePrompt += `\n\n## 📅 APPOINTMENT BOOKING SYSTEM (MANDATORY - HIGHEST PRIORITY)

**🎯 GOAL:** Create the BEST appointment calendar interface with perfect UX

---

### 📆 CALENDAR INTERFACE (CRITICAL):

**1. DATE SELECTOR (Top of Calendar):**
\`\`\`html
<div id="date-selector" class="bg-white p-6 rounded-xl shadow-lg mb-6">
    <div class="flex items-center justify-between mb-4">
        <button id="prev-day" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
            ◀ יום קודם
        </button>
        <div id="selected-date-display" class="text-xl font-bold text-gray-800">
            <!-- Will show: "יום חמישי, 24 באוקטובר 2025" -->
        </div>
        <button id="next-day" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
            יום הבא ▶
        </button>
    </div>
    <div id="quick-date-buttons" class="flex gap-2 justify-center flex-wrap">
        <button class="quick-date-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-purple-100">היום</button>
        <button class="quick-date-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-purple-100">מחר</button>
        <button class="quick-date-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-purple-100">מחרתיים</button>
    </div>
</div>
\`\`\`

**2. TIME SLOTS GRID (Main Calendar):**
\`\`\`html
<div id="time-slots-container" class="bg-white p-6 rounded-xl shadow-lg">
    <h3 class="text-2xl font-bold mb-4 text-center">תורים פנויים ליום <span id="day-name"></span></h3>
    
    <div id="time-slots-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
        <!-- Each slot will be generated here -->
    </div>
    
    <div id="no-slots-message" class="hidden text-center py-8">
        <p class="text-red-600 text-lg">אין תורים פנויים ביום זה</p>
        <p class="text-gray-600 mt-2">אנא בחר תאריך אחר</p>
    </div>
</div>
\`\`\`

**3. TIME SLOT DESIGN (Each slot):**
\`\`\`html
<!-- AVAILABLE SLOT (green) -->
<button class="time-slot available" data-time="09:00">
    <div class="time">09:00</div>
    <div class="status">🟢 פנוי</div>
</button>

<!-- BOOKED SLOT (red/gray) -->
<button class="time-slot booked" disabled>
    <div class="time">10:00</div>
    <div class="status">🔴 תפוס</div>
</button>

<!-- BREAK SLOT (orange) -->
<button class="time-slot break" disabled>
    <div class="time">13:00</div>
    <div class="status">☕ הפסקה</div>
</button>
\`\`\`

**4. CSS STYLING (MANDATORY):**
\`\`\`css
.time-slot {
    padding: 16px;
    border-radius: 12px;
    border: 2px solid;
    font-weight: 600;
    transition: all 0.3s;
    cursor: pointer;
    text-align: center;
}

.time-slot.available {
    background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
    border-color: #4ade80;
    color: #166534;
}

.time-slot.available:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(74, 222, 128, 0.4);
}

.time-slot.booked {
    background: #f3f4f6;
    border-color: #d1d5db;
    color: #6b7280;
    cursor: not-allowed;
    opacity: 0.6;
}

.time-slot.break {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-color: #f59e0b;
    color: #92400e;
    cursor: not-allowed;
}

.time {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 4px;
}

.status {
    font-size: 14px;
}
\`\`\`

---

### 🔧 JAVASCRIPT LOGIC (MANDATORY):

\`\`\`javascript
// Configuration
const WORKING_DAYS = [${workDaysNumbers.join(', ')}]; // Day numbers (0=Sunday)
const WORKING_HOURS = { start: '${startTime}', end: '${endTime}' };
const BREAKS = ${JSON.stringify(breaksData)}; // Format: [{start: '13:00', end: '14:00', desc: 'הפסקת צהריים'}]
const SPECIAL_HOURS = ${JSON.stringify(specialHoursData)}; // Format: [{day: 'friday', dayHebrew: 'שישי', start: '09:00', end: '13:00'}]

let selectedDate = new Date(); // Currently selected date
let appointments = []; // Will be fetched from API

// Initialize calendar - IMPROVED VERSION
async function initCalendar() {
    await fetchAppointments();
    
    // Always start with today
    selectedDate = new Date();
    
    // If today is not a working day, jump to next working day
    if (!WORKING_DAYS.includes(selectedDate.getDay())) {
        // Find next working day (max 7 days ahead)
        for (let i = 1; i <= 7; i++) {
            const nextDate = new Date(selectedDate);
            nextDate.setDate(nextDate.getDate() + i);
            if (WORKING_DAYS.includes(nextDate.getDay())) {
                selectedDate = nextDate;
                break;
            }
        }
    }
    
    renderDateSelector();
    renderTimeSlots();
    setupEventListeners();
    
    // Add today's appointments highlight
    highlightTodaysAppointments();
}

// Highlight today's appointments
function highlightTodaysAppointments() {
    const today = new Date().toISOString().split('T')[0];
    const todaysAppointments = appointments.filter(apt => apt.date === today);
    
    if (todaysAppointments.length > 0) {
        // Add notification about today's appointments
        const notification = document.createElement('div');
        notification.style.cssText = 'position: fixed; top: 20px; left: 20px; background: #3b82f6; color: white; padding: 12px 16px; border-radius: 8px; z-index: 10000; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);';
        notification.innerHTML = \`📅 היום יש \${todaysAppointments.length} תורים מתוכננים\`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
}

// Fetch appointments from server - IMPROVED VERSION
async function fetchAppointments() {
    try {
        // Try to get user ID and page ID from URL or page data
        const urlParts = window.location.pathname.split('/');
        const userId = urlParts[urlParts.length - 2] || 'default';
        const pageId = urlParts[urlParts.length - 1]?.replace('_html', '') || 'default';
        
        const response = await fetch(\`/api/appointments/\${userId}/\${pageId}\`);
        if (response.ok) {
        appointments = await response.json();
        } else {
            // Fallback: try to get from localStorage or create empty array
            appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
        }
    } catch (error) {
        console.error('Failed to fetch appointments:', error);
        // Fallback: try to get from localStorage or create empty array
        appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
    }
    
    console.log('📅 Loaded appointments:', appointments.length);
}

// Render date selector - IMPROVED VERSION
function renderDateSelector() {
    const dateDisplay = document.getElementById('selected-date-display');
    const dayName = document.getElementById('day-name');
    
    if (!dateDisplay || !dayName) return;
    
    const hebrewDays = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
    const hebrewMonths = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
    
    const dayOfWeek = hebrewDays[selectedDate.getDay()];
    const day = selectedDate.getDate();
    const month = hebrewMonths[selectedDate.getMonth()];
    const year = selectedDate.getFullYear();
    
    dateDisplay.textContent = \`יום \${dayOfWeek}, \${day} ב\${month} \${year}\`;
    dayName.textContent = dayOfWeek;
    
    // Update page title to show selected date
    const pageTitle = document.querySelector('h1, .page-title');
    if (pageTitle && !pageTitle.textContent.includes('תורים')) {
        pageTitle.textContent = \`תורים ל-\${dayOfWeek}, \${day} ב\${month}\`;
    }
}

// Render time slots for selected date
function renderTimeSlots() {
    const grid = document.getElementById('time-slots-grid');
    const noSlotsMsg = document.getElementById('no-slots-message');
    grid.innerHTML = '';
    
    // Check if selected date is a working day
    const isWorkingDay = WORKING_DAYS.includes(selectedDate.getDay());
    
    if (!isWorkingDay) {
        // Show message but still allow navigation
        grid.innerHTML = \`
            <div class="col-span-full text-center py-12 bg-gradient-to-br from-red-50 to-orange-50 rounded-xl border-2 border-red-200">
                <div class="text-6xl mb-4">📅</div>
                <p class="text-xl font-bold text-red-600 mb-2">יום זה אינו יום עבודה</p>
                <p class="text-gray-700 mb-4">ניתן לקבוע תורים רק בימי: <strong>${workDaysHebrew.join(', ')}</strong></p>
                <p class="text-gray-600">השתמש בכפתורי הניווט למעלה כדי לבחור תאריך אחר</p>
            </div>
        \`;
        return;
    }
    
    noSlotsMsg.classList.add('hidden');
    
    // Check if there are special hours for this day
    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const currentDayName = dayNames[selectedDate.getDay()];
    const specialHoursForDay = SPECIAL_HOURS.find(sh => sh.day.toLowerCase() === currentDayName);
    
    // Use special hours if available, otherwise use default working hours
    let workingHours = WORKING_HOURS;
    if (specialHoursForDay) {
        workingHours = { start: specialHoursForDay.start, end: specialHoursForDay.end };
    }
    
    // Generate time slots
    const [startHour, startMin] = workingHours.start.split(':').map(Number);
    const [endHour, endMin] = workingHours.end.split(':').map(Number);
    
    const dateStr = selectedDate.toISOString().split('T')[0];
    const dayAppointments = appointments.filter(apt => apt.date === dateStr);
    
    // Show special hours message if applicable
    if (specialHoursForDay) {
        const specialHoursNotice = document.createElement('div');
        specialHoursNotice.className = 'col-span-full mb-4 p-3 bg-blue-50 border-2 border-blue-300 rounded-lg text-center';
        specialHoursNotice.innerHTML = \`
            <p class="text-blue-900 font-semibold">🕐 שעות מיוחדות היום: \${specialHoursForDay.start} - \${specialHoursForDay.end}</p>
        \`;
        grid.appendChild(specialHoursNotice);
    }
    
    // Show today's appointments count if viewing today
    const isToday = selectedDate.toISOString().split('T')[0] === new Date().toISOString().split('T')[0];
    if (isToday && dayAppointments.length > 0) {
        const todayNotice = document.createElement('div');
        todayNotice.className = 'col-span-full mb-4 p-3 bg-green-50 border-2 border-green-300 rounded-lg text-center';
        todayNotice.innerHTML = \`
            <p class="text-green-900 font-semibold">📅 היום יש \${dayAppointments.length} תורים מתוכננים</p>
        \`;
        grid.appendChild(todayNotice);
    }
    
    for (let hour = startHour; hour < endHour; hour++) {
        for (let min = 0; min < 60; min += 30) { // 30-minute slots
            const timeStr = \`\${hour.toString().padStart(2, '0')}:\${min.toString().padStart(2, '0')}\`;
            
            // Check if in break time
            const isBreak = BREAKS.some(b => timeStr >= b.start && timeStr < b.end);
            
            // Check if booked
            const isBooked = dayAppointments.some(apt => apt.time === timeStr);
            
            // Create slot button
            const slot = document.createElement('button');
            slot.className = 'time-slot';
            
            if (isBreak) {
                slot.className += ' break';
                slot.disabled = true;
                slot.innerHTML = \`<div class="time">\${timeStr}</div><div class="status">☕ הפסקה</div>\`;
            } else if (isBooked) {
                slot.className += ' booked';
                slot.disabled = true;
                slot.innerHTML = \`<div class="time">\${timeStr}</div><div class="status">🔴 תפוס</div>\`;
            } else {
                slot.className += ' available';
                slot.dataset.time = timeStr;
                
                // Highlight if this is a popular time slot (morning/afternoon)
                const hour = parseInt(timeStr.split(':')[0]);
                const isPopularTime = (hour >= 9 && hour <= 11) || (hour >= 14 && hour <= 16);
                const popularIcon = isPopularTime ? '⭐ ' : '';
                
                slot.innerHTML = \`<div class="time">\${timeStr}</div><div class="status">\${popularIcon}🟢 פנוי</div>\`;
                slot.onclick = () => selectTimeSlot(timeStr);
                
                // Add hover effect for popular times
                if (isPopularTime) {
                    slot.style.borderColor = '#f59e0b';
                    slot.style.boxShadow = '0 0 0 2px rgba(245, 158, 11, 0.2)';
                }
            }
            
            grid.appendChild(slot);
        }
    }
}

// Select time slot and fill form - UNIVERSAL FUNCTION
function selectTimeSlot(time) {
    // Try to find appointment form fields (universal approach)
    const timeInput = document.querySelector('input[name="appointment-time"], input[id*="time"], input[placeholder*="שעה"]');
    const dateInput = document.querySelector('input[name="appointment-date"], input[id*="date"], input[type="date"]');
    const bookingForm = document.querySelector('form, .booking-form, #booking-form');
    
    // Fill the form fields if found
    if (timeInput) {
        timeInput.value = time;
        timeInput.style.backgroundColor = '#d4fc79';
        setTimeout(() => timeInput.style.backgroundColor = '', 2000);
    }
    
    if (dateInput) {
        dateInput.value = selectedDate.toISOString().split('T')[0];
        dateInput.style.backgroundColor = '#d4fc79';
        setTimeout(() => dateInput.style.backgroundColor = '', 2000);
    }
    
    // Scroll to form if found
    if (bookingForm) {
        bookingForm.scrollIntoView({ behavior: 'smooth' });
    } else {
        // Scroll to any form on the page
        const anyForm = document.querySelector('form');
        if (anyForm) {
            anyForm.scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    // Show success message
    const successMsg = document.createElement('div');
    successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 16px; border-radius: 8px; z-index: 10000; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);';
    successMsg.innerHTML = \`✅ נבחר תור ל-\${time} ב-\${selectedDate.toLocaleDateString('he-IL')}\`;
    document.body.appendChild(successMsg);
    
    setTimeout(() => {
        successMsg.remove();
    }, 3000);
}

// Event listeners - IMPROVED VERSION
function setupEventListeners() {
    // Previous day button
    const prevBtn = document.getElementById('prev-day');
    if (prevBtn) {
        prevBtn.onclick = () => {
        selectedDate.setDate(selectedDate.getDate() - 1);
        renderDateSelector();
        renderTimeSlots();
    };
    }
    
    // Next day button
    const nextBtn = document.getElementById('next-day');
    if (nextBtn) {
        nextBtn.onclick = () => {
        selectedDate.setDate(selectedDate.getDate() + 1);
        renderDateSelector();
        renderTimeSlots();
    };
    }
    
    // Quick date buttons
    document.querySelectorAll('.quick-date-btn').forEach((btn, idx) => {
        btn.onclick = () => {
            selectedDate = new Date();
            selectedDate.setDate(selectedDate.getDate() + idx);
            renderDateSelector();
            renderTimeSlots();
        };
    });
    
    // Add keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            selectedDate.setDate(selectedDate.getDate() - 1);
            renderDateSelector();
            renderTimeSlots();
        } else if (e.key === 'ArrowRight') {
            selectedDate.setDate(selectedDate.getDate() + 1);
            renderDateSelector();
            renderTimeSlots();
        }
    });
}

// Initialize on page load - UNIVERSAL APPROACH
// Add exit confirmation for page creator (ONLY in creator, NOT in generated pages)
if (window.location.pathname.includes('page-creator')) {
    window.addEventListener('beforeunload', function(e) {
        // Only show confirmation if there's unsaved work
        const hasUnsavedWork = document.getElementById('mainName')?.value || 
                               document.querySelector('input[type="file"]')?.files.length > 0 ||
                               document.querySelector('textarea')?.value.trim();
        
        if (hasUnsavedWork) {
            e.preventDefault();
            e.returnValue = 'יש לך שינויים שלא נשמרו. האם אתה בטוח שאתה רוצה לעזוב?';
            return e.returnValue;
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Check if this is an appointment page
    const hasAppointmentForm = document.querySelector('form') && (
        document.querySelector('input[name*="appointment"], input[id*="appointment"]') ||
        document.querySelector('input[placeholder*="תור"], input[placeholder*="שעה"]') ||
        document.querySelector('button[onclick*="appointment"], button[onclick*="תור"]')
    );
    
    if (hasAppointmentForm) {
        // Initialize calendar for appointment pages
        initCalendar();
    }
    
    // Initialize AI bot for all pages
    initAIBot();
});

// Universal AI Bot Initialization
function initAIBot() {
    const aiBotBtn = document.getElementById('ai-bot-btn');
    const aiChatWindow = document.getElementById('ai-chat-window');
    const aiCloseBtn = document.getElementById('ai-close-btn');
    const aiSendBtn = document.getElementById('ai-send-btn');
    const aiUserInput = document.getElementById('ai-user-input');
    const aiChatMessages = document.getElementById('ai-chat-messages');
    
    if (!aiBotBtn || !aiChatWindow) return;
    
    // Toggle chat window - RELIABLE CLICK HANDLER
    aiBotBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (aiChatWindow.style.display === 'none' || !aiChatWindow.style.display) {
            aiChatWindow.style.display = 'flex';
            aiUserInput.focus();
        } else {
            aiChatWindow.style.display = 'none';
        }
    });
    
    // Close button
    if (aiCloseBtn) {
        aiCloseBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            aiChatWindow.style.display = 'none';
        });
    }
    
    // Send message
    if (aiSendBtn && aiUserInput) {
        aiSendBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            sendAIMessage();
        });
        
        aiUserInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                sendAIMessage();
            }
        });
    }
    
    function sendAIMessage() {
        const message = aiUserInput.value.trim();
        if (!message) return;
        
        // Add user message
        addBotMessage(message, true);
        aiUserInput.value = '';
        
        // Simulate bot response
        setTimeout(() => {
            addBotMessage('תודה על ההודעה! אני כאן לעזור לך עם קביעת התור. איך אני יכולה לעזור?', false);
        }, 1000);
    }
    
    function addBotMessage(message, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = \`background: \${isUser ? '#8B5CF6' : '#E9D5FF'}; color: \${isUser ? 'white' : '#1F2937'}; padding: 12px; border-radius: 12px; margin-bottom: 12px; font-size: 15px; line-height: 1.5;\`;
        messageDiv.textContent = message;
        aiChatMessages.appendChild(messageDiv);
        aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
    }
}
\`\`\`

---

### 📝 BOOKING FORM (Below Calendar):

\`\`\`html
<form id="booking-form" class="bg-white p-6 rounded-xl shadow-lg mt-6">
    <h3 class="text-2xl font-bold mb-4">פרטי התור</h3>
    <input type="hidden" id="appointment-date" name="date">
    <input type="hidden" id="appointment-time" name="time">
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" name="name" placeholder="שם מלא" required class="px-4 py-3 border rounded-lg">
        <input type="tel" name="phone" placeholder="טלפון" required class="px-4 py-3 border rounded-lg">
        <input type="email" name="email" placeholder="אימייל" class="px-4 py-3 border rounded-lg">
        <select name="service" class="px-4 py-3 border rounded-lg">
            <option>בחר שירות</option>
        </select>
    </div>
    <textarea name="notes" placeholder="הערות" class="w-full px-4 py-3 border rounded-lg mt-4"></textarea>
    <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold mt-4 hover:bg-purple-700">
        אשר תור
    </button>
</form>
\`\`\`

---

**🚨 CRITICAL REQUIREMENTS:**
- Calendar MUST be fully functional and interactive
- Date navigation MUST work (prev/next day buttons)
- Time slots MUST update when date changes
- Available slots MUST be clickable and fill the form
- Booked/break slots MUST be disabled
- Mobile-responsive design
- RTL support for Hebrew
- Beautiful animations and hover effects
- **MANDATORY:** Call \`initCalendar()\` on page load to display time slots
- **MANDATORY:** Time slots grid MUST be visible with green/red/orange slots immediately

**🔴 COMMON MISTAKES TO AVOID:**
- ❌ DO NOT leave the calendar empty - it MUST show time slots on load
- ❌ DO NOT forget to call \`initCalendar()\` in DOMContentLoaded
- ❌ DO NOT hide the time slots - they must be visible by default`;
            }

            if (data.pageType === 'post' && typeof finalStructurePrompt === 'object') {

                const postPromptConfig = finalStructurePrompt;

                const layoutInstructions = postPromptConfig.layouts[data.postLayout] || '';

                finalStructurePrompt = postPromptConfig.base.replace('{{LAYOUT_INSTRUCTIONS}}', layoutInstructions);

            }
            
            // For online store, add product count to prompt
            if (data.pageType === 'onlineStore' && data.productCount) {
                const productCountText = `\n\nIMPORTANT: Create exactly ${data.productCount} products in the product catalog grid.`;
                finalStructurePrompt += productCountText;
            }



            const optionalSections = [];

            document.querySelectorAll('input[name="optionalSections"]:checked').forEach(checkbox => {

                const sectionKey = checkbox.value;

                // בדוק אם השפה קיימת, אחרת השתמש באנגלית
                const sectionData = availableSections[sectionKey];
                const langData = sectionData.t[data.outputLanguage] || sectionData.t['en'];
                
                if (langData && langData.prompt) {
                    optionalSections.push(langData.prompt);
                }

            });

            if (optionalSections.length > 0) {

                const additionText = getTranslation('prompt_add_sections_instruction', data.outputLanguage);

                finalStructurePrompt += `\n\n${additionText}\n- ${optionalSections.join('\n- ')}`;

            }
            
            // For real estate, add properties data
            if (data.pageType === 'realEstate' && data.properties && data.properties.length > 0) {
                finalStructurePrompt += `\n\n## 🏠 PROPERTIES DATA (MANDATORY - USE THIS EXACT DATA)

**🚨 CRITICAL: You MUST use the following properties data to populate the page:**

`;
                
                data.properties.forEach((property, index) => {
                    finalStructurePrompt += `
**Property #${index + 1}:**
- Title: ${s(property.title) || 'נכס למכירה'}
- Address: ${s(property.address) || 'כתובת'}
- Bedrooms: ${property.beds || '0'}
- Bathrooms: ${property.baths || '0'}
- Square Meters: ${property.sqft || '0'}
- Price: ₪${s(property.price) || '0'}
- Description: ${s(property.description) || 'תיאור הנכס'}
- Images (${property.images.length} photos):
${property.images.map((img, imgIndex) => `  ${imgIndex + 1}. ${img}`).join('\n')}

`;
                });
                
                finalStructurePrompt += `
**🚨 MANDATORY IMPLEMENTATION REQUIREMENTS:**

1. **Properties Gallery Section:**
   - Display ALL ${data.properties.length} properties in a responsive grid
   - Each property card MUST include:
     * Main image (first image from the images array - these are SAMPLE images, user will replace them later)
     * Property title and address
     * Price in ₪ format
     * Specs: 🛏️ X חדרים | 🚿 X אמבטיות | 📐 X מ"ר
     * "צור קשר לביקור בנכס" button
     * onclick="openPropertyGallery(${data.properties.length - 1})" (property index)

2. **Property Modal Popup:**
   - MUST be hidden by default (display: none)
   - Full-screen overlay with dark background
   - Image slider showing ALL images for selected property
   - Property details (title, address, price, specs, description)
   - Navigation arrows (prev/next) for images
   - Close button (X)
   - Image counter (e.g., "1 / 5")
   - "צור קשר לביקור" button with WhatsApp link: https://wa.me/${(data.whatsappCountryCode || '+972').replace('+', '')}${data.phone || ''}

3. **JavaScript Implementation:**
   - Create properties array with the exact data provided above
   - Implement openPropertyGallery(index) function
   - Implement closePropertyGallery() function
   - Implement nextImage() and prevImage() functions
   - Implement keyboard navigation (arrows + ESC)
   - Implement click outside to close

**💡 NOTE:** The images provided are SAMPLE images from Unsplash. The user will replace them with actual property photos later through the edit interface.

**⚠️ CRITICAL:** Use the EXACT property data provided above. Do NOT make up fake properties!
`;
            }

            // הוסף טופס צור קשר רק לדפים שאינם הזמנות (כי בהזמנות יש בועת WhatsApp)
            if (data.pageType !== 'event') {
            const contactFormPrompt = `
## Contact Form Section (MANDATORY)
Create a contact form section with ID "contact-form" that includes:
- Name field (required)
- Email field (required) 
- Phone field (optional)
- Message textarea (required)
- Submit button
- Form validation
- Submit to WhatsApp or Email based on user choice

JavaScript functionality:
- Validate required fields
- On submit: Open WhatsApp with pre-filled message OR send email
- Show success/error messages
- Use business contact details from form data`;

            finalStructurePrompt += contactFormPrompt;
            }





            const optionalData = `

* Contact Name: ${s(data.contactName)}

* Email: ${s(data.email)}

* Phone: ${s(data.countryCode)}${s(data.phone)}

* Address: ${s(data.address) || 'Not provided'}

* Main Link (Text & URL): ${s(data.websiteLinkText) || 'Not provided'} - ${s(data.websiteLink) || 'Not provided'}

* Additional External Link (Text & URL): ${s(data.externalLinkText) || 'Not provided'} - ${s(data.externalLink) || 'Not provided'}

* YouTube (Clean Embed URL): ${cleanYoutubeEmbedUrl || 'Not provided'} (Display mode: ${s(data.youtubeDisplayMode) || 'Embed'})

**🔗 SOCIAL MEDIA LINKS (CRITICAL REQUIREMENTS):**
* Facebook: ${s(data.facebookLink) || 'Not provided'}
* Instagram: ${s(data.instagramLink) || 'Not provided'}
* TikTok: ${s(data.tiktokLink) || 'Not provided'}
* LinkedIn: ${s(data.linkedinLink) || 'Not provided'}
* X (Twitter): ${s(data.twitterLink) || 'Not provided'}

**⚠️ SOCIAL MEDIA ICONS - MANDATORY REQUIREMENTS:**
- ✅ Use ONLY official brand SVG icons from Font Awesome or similar
- ✅ Icons MUST be clearly recognizable (Facebook blue, Instagram gradient, etc.)
- ✅ Icons MUST be consistent in size (24x24px or 32x32px)
- ✅ Icons MUST be in a horizontal row with equal spacing
- ✅ Each icon MUST have hover effect (scale or color change)
- ❌ DO NOT use generic icons or text-only links
- ❌ DO NOT use inconsistent icon styles
- **Example HTML for social icons:**
\`\`\`html
<div class="social-icons" style="display: flex; gap: 15px; justify-content: center; margin: 20px 0;">
  ${data.facebookLink ? `<a href="${data.facebookLink}" target="_blank" style="color: #1877F2; font-size: 32px; transition: transform 0.3s;"><svg>...</svg></a>` : ''}
  ${data.instagramLink ? `<a href="${data.instagramLink}" target="_blank" style="background: linear-gradient(45deg, #F58529, #DD2A7B, #8134AF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 32px;"><svg>...</svg></a>` : ''}
</div>
\`\`\`

* Menu Items: ${s(data.menuItems) || 'Not provided'}

* Price: ${s(data.price) || 'Not specified'}

* Payment Link: ${s(data.paymentLink) || 'Not provided'}

* Event Date: ${s(data.eventDate) || 'Not provided'}

* Event Location (Venue Name): ${s(data.eventLocation) || 'Not provided'}

* Event Address: ${s(data.eventAddress) || 'Not provided'}

`;



            let masterPrompt = `

# Master Task: Create a Creative Agency-Level Digital Asset



## 1. Your Identity: AI Creative Director

You are a creative director, copywriter, and designer. Your mission is to take a brief and turn it into a high-converting digital asset.



## 2. Project Brief

* **Asset Type:** ${s(templateLang.title)}

* **Project/Business Name:** ${s(data.mainName)}

* **Core Message:** "${s(data.description)}"

* **Selected Visual Style:** ${s(data.style)}

* **Use as Background Image preference:** ${data.useAsBackground ? 'Yes' : 'No'}

* **Add Accessibility Button:** ${data.addAccessibility ? 'Yes' : 'No'}

* **Add AI Bot:** ${data.addAiBot ? 'Yes' : 'No'}

* **All additional user data:** ${optionalData}



## 🚨 CRITICAL - ACTUAL CONTACT INFORMATION (MUST USE EXACTLY) 🚨

⚠️⚠️⚠️ **THESE ARE THE REAL CONTACT DETAILS - DO NOT INVENT OR CHANGE THEM** ⚠️⚠️⚠️

* **Business/Person Name (USE EXACTLY EVERYWHERE):** ${s(data.mainName)}
  - This must appear in: page title, header logo, hero section, about section, contact section, footer
  
* **Contact Person Name (USE EXACTLY):** ${s(data.contactName)}
  - Display this in: contact section, about section, team section (if applicable)
  
* **Phone Number (USE EXACTLY):** ${s(data.countryCode)}${s(data.phone)}
  - ⚠️ CRITICAL: Make phone CLICKABLE everywhere it appears!
  - 📞 Phone link: <a href="tel:${s(data.countryCode)}${s(data.phone)}">${s(data.countryCode)}${s(data.phone)}</a>
  - 💬 WhatsApp link: <a href="https://wa.me/${s(data.countryCode)}${s(data.phone).replace(/[^0-9]/g, '')}">צור קשר בWhatsApp</a>
  - ✅ Display clickable in: contact section, footer, header
  
* **Email Address (USE EXACTLY):** ${s(data.email)}
  - ⚠️ CRITICAL: Make email CLICKABLE everywhere it appears!
  - 📧 Email link: <a href="mailto:${s(data.email)}">${s(data.email)}</a>
  - ✅ Example: <a href="mailto:${s(data.email)}" style="color: #007bff;">${s(data.email)}</a>
  
* **Physical Address (USE EXACTLY):** ${s(data.address) || 'Not provided'}
  - ⚠️ CRITICAL: Make address CLICKABLE for navigation!
  - 🗺️ Google Maps: <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s(data.address))}" target="_blank">📍 ${s(data.address)}</a>
  - 🚗 Waze: <a href="https://waze.com/ul?q=${encodeURIComponent(s(data.address))}" target="_blank">נווט בWaze</a>
  - ✅ Display clickable in: contact section, footer, about section

✅ **VERIFICATION CHECKLIST - BEFORE SUBMITTING YOUR CODE:**
- [ ] Business name "${s(data.mainName)}" appears in header
- [ ] Business name "${s(data.mainName)}" appears in hero section
- [ ] Contact name "${s(data.contactName)}" appears in contact/about section
- [ ] Phone "${s(data.countryCode)}${s(data.phone)}" is CLICKABLE with <a href="tel:...">
- [ ] WhatsApp link with phone ${s(data.countryCode)}${s(data.phone)} is CLICKABLE with <a href="https://wa.me/...">
- [ ] Email "${s(data.email)}" is CLICKABLE with <a href="mailto:...">
- [ ] Address "${s(data.address)}" is CLICKABLE with Google Maps link <a href="https://www.google.com/maps/search/...">
- [ ] NO plain text contact details - ALL must be clickable links
- [ ] No fake/placeholder contact information exists in the code
- [ ] ALL contact details (phone/email/address) use font-size: 18-20px (NOT tiny text!)
- [ ] FAQ section uses font-size: 20-24px for questions, 16-18px for answers
- [ ] ALL buttons have readable, contrasted text (font-weight: 600-700)
- [ ] Navigation links (בית, מוצרים, אודותינו, צור קשר) use font-size: 16-18px (readable!)
- [ ] AI Bot chat: User input field is font-size: 16px; User messages are font-size: 16px



## 3. Content & Copywriting Task

Based on all data, write full marketing copy for all required sections in the Blueprint. The copy must be written entirely in the requested output language: **${data.language}** (${data.languageName}). 

**CRITICAL**: The ENTIRE page content must be in ${data.languageName} language:
- All headings, titles, and subtitles
- All paragraph text and descriptions  
- All button labels and links
- All form labels and placeholders
- All navigation elements
- All error and success messages
- All tooltips and help text
- All metadata and alt text
- All text overlays on images
- All captions and image descriptions
- All floating elements and widgets text
- All AI bot interface text
- All WhatsApp button text
- All accessibility menu text

**LANGUAGE ENFORCEMENT**: If you generate any text in a different language than ${data.languageName}, the page will be rejected. Every single word, character, and symbol must be in ${data.languageName} language.


## 4. Art Direction & Creative Excellence Task

**YOU ARE A WORLD-CLASS CREATIVE DIRECTOR**. This page must look like it was created by a leading creative agency (Pentagram, Ogilvy, R/GA level). Every pixel must be intentional and beautiful.

### Visual Style Implementation for "${s(data.style)}":

**CRITICAL DESIGN REQUIREMENTS:**
1. **Typography Excellence:**
   - Use modern, professional Google Fonts (Heebo/Rubik for Hebrew, Inter/Poppins for English)
   - Clear hierarchy: Hero (48-72px), H2 (36-48px), H3 (24-32px), body (16-18px)
   - **⚠️ NAVIGATION LINKS (Header menu):** font-size: 16-18px; font-weight: 500-600; MUST be readable!
   - **⚠️ CRITICAL:** ALL navigation links (בית, מוצרים, אודותינו, צור קשר, etc.) MUST be font-size: 16-18px minimum!
   - Line height 1.6-1.8 for readability
   - Letter spacing optimized for the chosen font

2. **⚠️⚠️⚠️ TEXT READABILITY - CRITICAL REQUIREMENTS ⚠️⚠️⚠️:**

   **A. ALL BUTTON TEXT:**
   - **ALL button text MUST be 100% READABLE and CONTRASTED**
   - ❌ NEVER use light text on light background
   - ❌ NEVER use dark text on dark background
   - ✅ ALWAYS ensure minimum 4.5:1 contrast ratio (WCAG AA standard)
   - ✅ Button text MUST be bold (font-weight: 600 or 700)
   - ✅ Button text MUST be at least 16px (preferably 18px)
   - ✅ Add text-shadow if needed for better readability
   - **Examples of GOOD button styles:**
     * Dark button: background: #1F2937; color: white; font-weight: 700;
     * Bright button: background: #10B981; color: white; font-weight: 700;
     * Gradient button: background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
   - **MANDATORY for all buttons:** "קנה עכשיו", "הוסף לעגלה", "צור קשר", "שלח", etc.

   **B. FAQ / שאלות ותשובות SECTION:**
   - ⚠️ CRITICAL: FAQ text MUST be LARGE and READABLE!
   - ✅ Questions (שאלות): font-size: 20-24px; font-weight: 700; color: dark color
   - ✅ Answers (תשובות): font-size: 16-18px; line-height: 1.6; color: #374151 or darker
   - ✅ Good contrast between text and background
   - ❌ NEVER use small font (below 16px) in FAQ section
   - ❌ NEVER use light text on light background in FAQ

   **C. NAVIGATION LINKS (Header menu):**
   - ⚠️ CRITICAL: Nav links MUST be READABLE!
   - ✅ All navigation links: font-size: 16-18px; font-weight: 500-600; color: contrast color
   - ❌ NEVER use font-size below 16px for navigation
   - ❌ NEVER make nav links tiny/hard to read
   - **Example for navigation:**
     <nav style="display: flex; gap: 24px;">
       <a href="#home" style="font-size: 17px; font-weight: 600; color: #1F2937;">בית</a>
       <a href="#products" style="font-size: 17px; font-weight: 600; color: #1F2937;">מוצרים</a>
       <a href="#about" style="font-size: 17px; font-weight: 600; color: #1F2937;">אודותינו</a>
       <a href="#contact" style="font-size: 17px; font-weight: 600; color: #1F2937;">צור קשר</a>
     </nav>

   **D. CONTACT DETAILS AT BOTTOM/FOOTER:**
   - ⚠️ CRITICAL: Contact info MUST be LARGE and VISIBLE!
   - ✅ Phone: font-size: 18-20px; font-weight: 600; color: #1F2937
   - ✅ Email: font-size: 18-20px; font-weight: 600; color: #1F2937
   - ✅ Address: font-size: 18-20px; font-weight: 600; color: #1F2937
   - ✅ Icons (📞 💬 📧 📍): Keep them, but make text BIG
   - ❌ NEVER use font-size below 16px for contact details
   - ❌ NEVER make contact info tiny/small at the bottom
   - **Example for contact section:**
     <div style="font-size: 18px; line-height: 1.8; color: #1F2937;">
       <p style="font-size: 20px; font-weight: 600;">📞 <a href="tel:...">972-505378108</a></p>
       <p style="font-size: 20px; font-weight: 600;">📧 <a href="mailto:...">britolam1@gmail.com</a></p>
       <p style="font-size: 20px; font-weight: 600;">📍 <a href="...">אושיקין 24 נתניה</a></p>
     </div>

3. **Color Palette Strategy:**
   - Create a cohesive 5-color palette based on "${s(data.style)}"
   - Primary color for CTA buttons and key elements (MUST have good contrast with white text)
   - Secondary color for accents
   - Neutral grays for text and backgrounds
   - Use Tailwind's color system intelligently
   - Add gradients where appropriate (bg-gradient-to-r, bg-gradient-to-br)

3. **Spacing & Layout:**
   - Generous white space (py-16, py-24 for sections)
   - Consistent padding (px-4, px-6, px-8)
   - Maximum content width: max-w-7xl mx-auto
   - Grid systems: grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3
   - Gap between elements: gap-6, gap-8, gap-12

4. **Visual Effects & Modern Touches:**
   - Subtle shadows: shadow-md, shadow-lg, shadow-2xl
   - Smooth transitions: transition-all duration-300
   - Hover effects: hover:scale-105, hover:shadow-xl
   - Rounded corners: rounded-lg, rounded-xl, rounded-2xl
   - Backdrop blur for overlays: backdrop-blur-sm
   - Gradient overlays where appropriate

5. **Imagery:**
   - **If 'Use as Background Image' is 'Yes'**: Use as hero background with overlay
   - **If 'Use as Background Image' is 'No'**: Place as prominent \`<img>\` element
   - Find 3-5 additional high-quality Unsplash images for sections
   - Use object-cover and aspect-ratio for perfect sizing
   - Add subtle image filters if they enhance the ${s(data.style)} aesthetic

6. **Micro-interactions:**
   - Buttons must have: shadow, hover:scale, active states
   - Links must have underline effects or color changes
   - Form inputs must have focus:ring effects
   - Cards must lift on hover (hover:-translate-y-2)

7. **Section-Specific Design:**
   - **Header/Navigation:** ⚠️ CRITICAL - ALL nav links MUST be font-size: 16-18px, font-weight: 500-600, easy to read!
   - Hero: Full viewport height (min-h-screen), centered content, compelling CTA
   - Benefits/Features: Cards or icons with descriptions, use grid layout
   - Testimonials: Cards with quotes, author photos, ratings
   - **FAQ (שאלות ותשובות):** ⚠️ CRITICAL - Questions: font-size: 20-24px (bold); Answers: font-size: 16-18px; Good contrast!
   - **Contact Section:** ⚠️ CRITICAL - ALL contact info (phone/email/address) MUST be font-size: 18-20px, font-weight: 600, clickable links
   - **Footer:** Clean, organized, with all links and social media - contact details MUST be font-size: 18-20px (NOT tiny!)

**STYLE-SPECIFIC GUIDELINES:**
- **Minimalist/Minimalist Pro**: Clean whites, subtle grays, thin lines, abundant space, San-serif fonts
- **Modern**: Bold colors, sharp edges, gradients, contemporary feel
- **Luxury**: Gold accents, elegant fonts (serif), rich colors, sophisticated spacing
- **Vintage/Retro**: Warm tones, aged paper textures, classic typography
- **Neon/Aurora**: Vibrant gradients, glowing effects, dark backgrounds, bold colors
- **Claymorphism**: Soft shadows, muted colors, rounded corners, depth
- **Bento Grid**: Card-based layout, organized sections, clean borders
- **Gothic**: Dark palette, dramatic fonts, medieval touches
- **Comic/Pop Art**: Bold outlines, primary colors, playful elements
- **Art Nouveau**: Organic curves, floral elements, elegant lines
- **Bauhaus**: Geometric shapes, primary colors, functional design
- **Casual**: Friendly colors, approachable design, relaxed spacing

* **Default Image:** You must find a suitable, high-quality image from Unsplash.

⚠️⚠️⚠️ **CRITICAL IMAGE RULES - MUST FOLLOW:** ⚠️⚠️⚠️
- ✅ ALWAYS use Unsplash URLs (https://images.unsplash.com/...)
- ❌ NEVER EVER use base64 encoded images (data:image/...)
- ❌ NEVER use placeholder images (via.placeholder.com)
- ❌ NEVER generate images yourself
- ✅ ALL images MUST be from Unsplash with proper URLs



## 5. Blueprint (Work Plan)

Strictly follow this structure plan. IMPORTANT: The output language must be ${data.language} (${data.languageName}).

**MANDATORY LANGUAGE REQUIREMENTS:**
1. Set HTML lang attribute to "${data.language}"
2. Set HTML dir attribute to "${data.language === 'he' || data.language === 'ar' ? 'rtl' : 'ltr'}"
3. ALL text content must be in ${data.languageName} - NO EXCEPTIONS
4. Do NOT add any language switcher - the page should be in a single language only
5. Ensure ALL text overlays, captions, and image text are in ${data.languageName}
6. Verify that floating widgets (WhatsApp, AI Bot, Accessibility) have text in ${data.languageName}
7. **MANDATORY: Add a contact form section** with the following requirements:
   - Form ID: "contact-form"
   - Fields: Name (required), Email (required), Phone (optional), Message (required)
   - Submit button with text in ${data.languageName}
   - Form must submit to WhatsApp with pre-filled message OR send email
   - Use the business phone number and email from form data
   - Form styling should match the page design
   - Include proper validation and success/error messages
   - For WhatsApp: Use href="https://wa.me/${data.whatsappCountryCode}${data.phone.replace(/[^0-9]/g, '')}?text=שלום, אני [name] - [message]"
   - For Email: Use mailto:${data.email}?subject=פנייה מאתר&body=שם: [name]%0Aטלפון: [phone]%0Aהודעה: [message]
${finalStructurePrompt}


## 5.5. 🚨🚨🚨 COUNTDOWN TIMER - COPY THIS CODE EXACTLY 🚨🚨🚨

⚠️⚠️⚠️ THIS IS THE #1 REQUIREMENT - DO NOT DEVIATE FROM THIS CODE ⚠️⚠️⚠️

IF your page includes a countdown timer, you MUST copy-paste this EXACT code with NO modifications:

**VISUAL LAYOUT (what the user will see on screen - HEBREW RTL):**
SECONDS (RIGHT) → MINUTES → HOURS → DAYS/ימים (LEFT)
[שניות 00] [דקות 30] [שעות 10] [ימים 07]
  ←RIGHT                                LEFT→

**EXACT HTML CODE TO USE (COPY-PASTE THIS):**
\`\`\`html
<div class="grid grid-cols-1 md:grid-cols-4 gap-8">
    <div id="seconds" class="countdown-box p-8 flex flex-col items-center justify-center">
        <span class="text-7xl font-bold">00</span>
        <span class="text-2xl mt-2">שניות</span>
    </div>
    <div id="minutes" class="countdown-box p-8 flex flex-col items-center justify-center">
        <span class="text-7xl font-bold">30</span>
        <span class="text-2xl mt-2">דקות</span>
    </div>
    <div id="hours" class="countdown-box p-8 flex flex-col items-center justify-center">
        <span class="text-7xl font-bold">10</span>
        <span class="text-2xl mt-2">שעות</span>
    </div>
    <div id="days" class="countdown-box p-8 flex flex-col items-center justify-center">
        <span class="text-7xl font-bold">07</span>
        <span class="text-2xl mt-2">ימים</span>
    </div>
</div>
\`\`\`

**🚨 ABSOLUTE REQUIREMENTS - NO EXCEPTIONS:**
1. ✅ Grid MUST have: class="grid grid-cols-1 md:grid-cols-4 gap-8" (NO dir attribute!)
2. ✅ Order in HTML: seconds, minutes, hours, days (REVERSED for RTL display!)
3. ✅ Each div MUST have the exact id: "seconds", "minutes", "hours", "days"
4. ✅ Labels MUST be: "שניות", "דקות", "שעות", "ימים"
5. ✅ ALL 4 boxes required - NOT 3, NOT 5, EXACTLY 4
6. ✅ NO dir attribute - RTL will reverse the HTML order to display: ימים→שעות→דקות→שניות

**❌ FORBIDDEN:**
- Changing the order of boxes (must be: seconds, minutes, hours, days)
- Adding dir="ltr" or dir="rtl" to the grid
- Using grid-cols-3 (must be grid-cols-4)
- Skipping any box (must have all 4 boxes)
- Using different IDs or labels

## 6. Technical Checklist

* **Output:** HTML code only.

* **Responsiveness:** Perfect.

* **Links:** All links must work. Phone should link to tel: and WhatsApp. Email to mailto:. External links should open in a new tab (target="_blank").

* **🚨 FORBIDDEN ELEMENTS 🚨:**
  - ❌ DO NOT create "Back to Top" / "חזרה למעלה" button
  - ❌ DO NOT add "© 2025" or "כל הזכויות שמורות" or "All Rights Reserved" text
  - ❌ DO NOT add any copyright statements

* **YouTube Video Integration:**
  - If YouTube URL is provided: ${cleanYoutubeEmbedUrl || 'Not provided'}
  - Display mode: ${s(data.youtubeDisplayMode) || 'Embed'}
  - **If Display Mode is "Embed":**
    * Create a dedicated video section (id="video-section")
    * Use full \`<iframe>\` embed with proper aspect ratio (16:9)
    * \`<iframe width="100%" height="auto" style="aspect-ratio: 16/9;" src="${cleanYoutubeEmbedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>\`
    * Center the video with proper padding
    * Add subtle shadow or border to make it stand out
  - **If Display Mode is "Link":**
    * Add a prominent "Watch on YouTube" button/link
    * Use red YouTube branding color (#FF0000)
    * Link opens in new tab: \`target="_blank"\`
    * Add YouTube icon SVG
  - **If no YouTube URL provided:** Skip video section entirely

* **Contact Form:** Must include JavaScript for form submission to WhatsApp or Email:
document.getElementById('contact-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const message = document.getElementById('message').value;
    
    // Validate required fields
    if (!name || !email || !message) {
        alert('אנא מלא את כל השדות החובה');
        return;
    }
    
    // Create message
    const fullMessage = 'שלום, אני ' + name + '\\nאימייל: ' + email + '\\nטלפון: ' + (phone || 'לא צוין') + '\\nהודעה: ' + message;
    
    // Open WhatsApp
    const whatsappUrl = 'https://wa.me/' + ${data.whatsappCountryCode} + ${data.phone.replace(/[^0-9]/g, '')} + '?text=' + encodeURIComponent(fullMessage);
    window.open(whatsappUrl, '_blank');
    
    // Show success message
    alert('ההודעה נשלחה לווטסאפ!');
});

* **Accessibility:** \`alt\` and \`aria-label\` attributes for all images and interactive elements.
  
  **🤖 BOT CAPABILITIES FOR APPOINTMENT PAGES:**
  ${data.pageType === 'serviceProvider' && data.enableAppointmentBooking ? `
  - ✅ Bot MUST be able to book appointments when asked
  - ✅ When user says "קבע לי תור" or "רוצה לקבוע תור" → show available time slots
  - ✅ Bot should fetch available slots from: /api/appointments/${data.userId || 'USER_ID'}/${data.pageId || 'PAGE_ID'}
  - ✅ Bot should display available times in a clear format
  - ✅ When user selects a time → collect name, phone, and confirm booking
  - ✅ Bot should POST booking to: /api/appointments with data: { userId, pageId, date, time, customerName, phone, service }
  - ✅ After booking → show confirmation message with appointment details
  
  **🎯 BOT INTERACTION WITH CALENDAR (CRITICAL):**
  - ✅ When user asks about available times → Bot can click on date navigation buttons to show different days
  - ✅ Bot should be able to read the calendar and tell user which slots are available
  - ✅ When user chooses a time → Bot should:
    1. Click on the available time slot button (this will auto-fill the form)
    2. Scroll smoothly to the booking form: \`document.getElementById('booking-form').scrollIntoView({ behavior: 'smooth' })\`
    3. Tell user: "בחרתי עבורך את התור ב-[TIME]. אנא מלא את הפרטים בטופס למטה."
  - ✅ Bot can help fill the form fields if user provides info in chat
  - ✅ Example conversation:
    User: "יש לי תור פנוי מחר בבוקר?"
    Bot: *checks calendar for tomorrow* "כן! יש תורים פנויים מחר ב-09:00, 09:30, 10:00. איזה שעה מתאימה לך?"
    User: "09:30"
    Bot: *clicks on 09:30 slot, scrolls to form* "מעולה! בחרתי עבורך תור מחר ב-09:30. אנא מלא את הפרטים בטופס למטה."
  
  **📜 BOT SCROLL FUNCTIONALITY (MANDATORY):**
  \`\`\`javascript
  // When bot helps user select a time slot
  function botSelectTimeSlot(time, date) {
    // Find and click the time slot button
    const timeSlotBtn = document.querySelector(\`[data-time="\${time}"]\`);
    if (timeSlotBtn) {
      timeSlotBtn.click(); // This will auto-fill the form
    }
    
    // Scroll to booking form smoothly
    setTimeout(() => {
      const bookingForm = document.getElementById('booking-form');
      if (bookingForm) {
        bookingForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Highlight the form briefly
        bookingForm.style.boxShadow = '0 0 20px rgba(139, 92, 246, 0.6)';
        setTimeout(() => {
          bookingForm.style.boxShadow = '';
        }, 2000);
      }
    }, 300);
  }
  \`\`\`
  ` : ''}
  - **🚨 CRITICAL - CHAT HISTORY MANAGEMENT 🚨:**
    **YOU MUST USE A UNIQUE KEY FOR EACH PAGE TO PREVENT CHAT MIXING!**
    
    **CORRECT localStorage key (use page URL, NOT title):**
    \`\`\`javascript
    const CHAT_KEY = 'chatHistory_' + window.location.pathname.replace(/[^a-zA-Z0-9]/g, '_');
    \`\`\`
    
    **❌ WRONG (causes chat mixing between pages):**
    - \`chatHistory_\${title}\` - titles can be the same!
    - \`chatHistory\` - will mix all chats!
    
    **✅ CORRECT (each page has its own chat):**
    - \`chatHistory_output_userId_pageId_html\`
    
    **WHEN TO CLEAR CHAT HISTORY:**
    1. ✅ **When chat bubble is closed** - ALWAYS clear on close!
    2. ✅ **When page is in editing mode** - check for editor toolbar
    3. ✅ **When page loads** - start fresh every time
    
    **IMPLEMENTATION:**
    \`\`\`javascript
    // On page load - clear old chat
    document.addEventListener('DOMContentLoaded', function() {
      const CHAT_KEY = 'chatHistory_' + window.location.pathname.replace(/[^a-zA-Z0-9]/g, '_');
      localStorage.removeItem(CHAT_KEY);
      console.log('🧹 Chat history cleared for this page');
    });
    
    // When closing chat bubble - clear chat
    function closeChatBubble() {
      const CHAT_KEY = 'chatHistory_' + window.location.pathname.replace(/[^a-zA-Z0-9]/g, '_');
      localStorage.removeItem(CHAT_KEY);
      console.log('🧹 Chat history cleared on close');
      // ... close the bubble
    }
    
    // Check for editing mode
    if (document.querySelector('.editor-toolbar')) {
      const CHAT_KEY = 'chatHistory_' + window.location.pathname.replace(/[^a-zA-Z0-9]/g, '_');
      localStorage.removeItem(CHAT_KEY);
    }
    \`\`\`
  - **🚨 INITIAL MESSAGE - START FRESH:**
    When the chat opens for the first time, show ONLY the initial greeting message.
    DO NOT load any previous messages from localStorage.
    Each page visit should start with a clean, empty chat.
    
    **ADD THIS CLEANUP CODE AT THE TOP OF YOUR SCRIPT:**
    \`\`\`javascript
    // 🧹 Clean up ALL old chat histories on page load
    (function() {
      // Remove all chatHistory keys from localStorage
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('chatHistory')) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      if (keysToRemove.length > 0) {
        console.log(\`🧹 Cleared \${keysToRemove.length} old chat histories\`);
      }
    })();
    \`\`\`
    
  - Typing indicator: Show "סתיו מקלידה..." in page language inside the message history area when waiting for bot response. Use this HTML structure: <div class="typing-indicator">סתיו מקלידה<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>
  - When sending messages, include both page context data and user message in this format:
    {
      "context": {
        "pageTitle": "Page Title",
        "businessName": "Business Name", 
        "description": "Page Description",
        "phone": "Phone Number",
        "email": "Email Address",
        "address": "Physical Address",
        "allPageData": "Complete page information"
      },
      "user_message": "{{ $json.body.user_message }}",
      "page_type": "${data.pageType || 'landing'}",
      "business_info": {
        "name": "Business Name from form data",
        "phone": "Full phone number from form data (without country code)", 
        "email": "Email Address from form data",
        "address": "Physical Address from form data"
      },
      "event_details": {
        "eventDate": "${data.eventDate || ''}",
        "eventTime": "${data.eventTime || ''}",
        "eventLocation": "${data.eventLocation || ''}",
        "eventAddress": "${data.eventAddress || ''}",
        "eventType": "${data.eventType || data.pageType || ''}"
      },
      "page_details": {
        "profession": "${data.profession || data.mainName || ''}",
        "serviceType": "${data.serviceType || data.description || ''}",
        "businessType": "${data.businessType || data.pageType || ''}",
        "courseName": "${data.courseName || data.title || ''}",
        "courseDescription": "${data.courseDescription || data.description || ''}"
      },
      "products": (typeof extractProductsFromPage === 'function' ? extractProductsFromPage() : [])
    }
  - **🚨🚨🚨 CRITICAL - AUTO-GENERATED extractPageData() FUNCTION 🚨🚨🚨**
    **THE SERVER AUTOMATICALLY INJECTS extractPageData() INTO ALL PAGES!**
    **YOU MUST USE IT IN YOUR FETCH CODE!**
    **DO NOT CREATE IT AGAIN - JUST CALL IT!**
  - **🚨🚨🚨 CRITICAL FOR STORE PAGES - PRODUCT DATA EXTRACTION 🚨🚨🚨**
    
    **THE FUNCTION extractProductsFromPage() IS ALREADY IN THE PAGE!**
    **Just call it in your fetch code:**
    \`\`\`javascript
    "products": (typeof extractProductsFromPage === 'function' ? extractProductsFromPage() : [])
    \`\`\`
    
    **🚨 EXAMPLE OF COMPLETE FETCH:**
    \`\`\`javascript
    const messageData = {
      context: { ... },
      user_message: userMessage,
      page_type: "store",
      business_info: { ... },
      products: extractProductsFromPage()  // ← CALL THE FUNCTION HERE
    };
    
    fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(messageData)
    })
    \`\`\`
    
    This ensures the bot ALWAYS extracts and sends REAL, UP-TO-DATE product information from the actual page EVERY time a message is sent.
    
  - **📋 COMPLETE WORKING EXAMPLE FOR STORE PAGES:**
    See the detailed instructions above for extractProductsFromPage() function and how to call it in the bot's fetch code.
  - The bot will receive responses in this format:
    { "message": "Bot response text here" }
  - **🛒 FOR STORE PAGES - AUTOMATIC BOT ACTIONS:**
    The bot can return JSON with an "action" field to trigger automatic actions:
    
    **Action 1: Add to Cart**
    {
      "message": "✅ Added 3 chocolates to cart!",
      "action": "add_to_cart",
      "product_name": "Chocolate",
      "quantity": 3,
      "price": 40
    }
    When the bot response includes "action": "add_to_cart", automatically call:
    addToCart(product_name, price, '', null, quantity);
    
    **Action 2: Scroll to Products Area**
    {
      "message": "הנה המוצרים שלנו! 🛍️",
      "action": "scroll_to_products"
    }
    When the bot response includes "action": "scroll_to_products", the page will automatically scroll to the products gallery.
    
    **Action 3: Scroll to Specific Product**
    {
      "message": "הנה שוקולד מריר! 🍫",
      "action": "scroll_to_product",
      "product_name": "שוקולד מריר"
    }
    When the bot response includes "action": "scroll_to_product", the page will scroll to and highlight that specific product.
    
    **Action 4: Fill Contact Form**
    {
      "message": "מילאתי את הטופס בשבילך! ✅",
      "action": "fill_contact_form",
      "name": "יניב",
      "phone": "050-1234567",
      "message_text": "אני מעוניין בשירות" (optional)
    }
    Automatically fills the contact form with the user's details from the conversation.
    
    **Action 5: Open WhatsApp**
    {
      "message": "פותח את WhatsApp... 💬",
      "action": "open_whatsapp"
    }
    Automatically clicks the WhatsApp bubble to open a chat.
    
    **Action 6: Scroll to Section**
    {
      "message": "הנה המיקום! 📍",
      "action": "scroll_to_section",
      "section_name": "מיקום" (or "location", "gallery", "about", etc.)
    }
    Scrolls to a specific section of the page by name.
    
    **Action 7: Highlight Element**
    {
      "message": "הנה הכפתור! ✨",
      "action": "highlight_element",
      "element_text": "תשלום" (text to find in the element)
    }
    Finds and highlights (pulsing animation) a specific element on the page.
    
    This allows the bot to perform actions in the page while showing only the message to the user.
    **🚨 CRITICAL - HANDLE BOT RESPONSES CORRECTLY WITH TIMEOUT & RETRY:**
    After receiving the webhook response, parse it and check for actions.
    **IMPORTANT:** Use AbortController with 30-second timeout to prevent bot from hanging:
    \`\`\`javascript
    // When receiving response from webhook (in your fetch().then())
    // Add timeout and retry logic
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 seconds timeout
    
    fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(messageData),
      signal: controller.signal
    })
    .then(response => {
      clearTimeout(timeoutId); // Clear timeout on successful response
      return response.json();
    })
    .then(rawData => {
      // Hide typing indicator
      hideTypingIndicator();
      
      console.log('📥 Raw webhook response:', rawData);
      
      // ROBUST JSON PARSING - handle if response is wrapped in string
      let data = rawData;
      
      // If data is a string, try to parse it as JSON
      if (typeof rawData === 'string') {
        try {
          data = JSON.parse(rawData);
          console.log('✅ Parsed string response as JSON:', data);
        } catch (e) {
          console.warn('⚠️ Response is string but not valid JSON, using as-is');
        }
      }
      
      // If data has a nested 'message' that's also JSON, parse it
      if (data.message && typeof data.message === 'string' && data.message.startsWith('{')) {
        try {
          const parsed = JSON.parse(data.message);
          console.log('✅ Parsed nested JSON in message field');
          data = parsed;
        } catch (e) {
          console.warn('⚠️ message field looks like JSON but failed to parse');
        }
      }
      
      console.log('📊 Final parsed data:', data);
      
      // Check if bot returned an action
      if (data.action === 'add_to_cart' && data.product_name && data.price) {
        console.log('🛒 Bot requested to add to cart:', data);
        
        // Add product to cart
        if (typeof addToCart === 'function') {
          const productName = data.product_name;
          const price = parseFloat(data.price);
          const quantity = parseInt(data.quantity) || 1;
          
          // Call the cart function
          addToCart(productName, price, '', null, quantity);
          
          console.log(\`✅ Added \${quantity}x \${productName} to cart (₪\${price} each)\`);
        } else {
          console.warn('⚠️ addToCart function not found!');
        }
        
        // Display ONLY the message, not the full JSON
        addBotMessage(data.message || 'מוצר נוסף לעגלה!');
      } else if (data.action === 'scroll_to_products') {
        console.log('📜 Bot requested to scroll to products');
        
        // Find the products section and scroll to it
        const productSection = document.querySelector('[class*="product"], .products, #products, section:has(.product-card)');
        if (productSection) {
          productSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          console.log('✅ Scrolled to products section');
        } else {
          console.warn('⚠️ Products section not found');
        }
        
        // Display the message
        addBotMessage(data.message || 'הנה המוצרים שלנו! 🛍️');
      } else if (data.action === 'scroll_to_product' && data.product_name) {
        console.log('📜 Bot requested to scroll to specific product:', data.product_name);
        
        // Find the specific product card
        const allProducts = document.querySelectorAll('.product-card, [class*="product"]');
        let targetProduct = null;
        
        for (const product of allProducts) {
          const nameEl = product.querySelector('h1, h2, h3, h4, [class*="title"], [class*="name"]');
          if (nameEl && nameEl.textContent.trim().toLowerCase().includes(data.product_name.toLowerCase())) {
            targetProduct = product;
            break;
          }
        }
        
        if (targetProduct) {
          targetProduct.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Highlight the product briefly
          targetProduct.style.transition = 'all 0.3s ease';
          targetProduct.style.boxShadow = '0 0 30px rgba(102, 126, 234, 0.8)';
          targetProduct.style.transform = 'scale(1.05)';
          setTimeout(() => {
            targetProduct.style.boxShadow = '';
            targetProduct.style.transform = '';
          }, 2000);
          console.log('✅ Scrolled to product:', data.product_name);
        } else {
          console.warn('⚠️ Product not found:', data.product_name);
        }
        
        addBotMessage(data.message || 'הנה המוצר! 🎯');
      } else if (data.action === 'fill_contact_form' && data.name && data.phone) {
        console.log('📝 Bot requested to fill contact form');
        
        // Find the contact form
        const forms = document.querySelectorAll('form');
        let contactForm = null;
        
        for (const form of forms) {
          const inputs = form.querySelectorAll('input, textarea');
          const hasName = Array.from(inputs).some(inp => inp.name?.includes('name') || inp.placeholder?.includes('שם'));
          const hasPhone = Array.from(inputs).some(inp => inp.name?.includes('phone') || inp.placeholder?.includes('טלפון'));
          
          if (hasName && hasPhone) {
            contactForm = form;
            break;
          }
        }
        
        if (contactForm) {
          // Fill the form
          const nameInput = contactForm.querySelector('input[name*="name"], input[placeholder*="שם"]');
          const phoneInput = contactForm.querySelector('input[name*="phone"], input[type="tel"], input[placeholder*="טלפון"]');
          const messageInput = contactForm.querySelector('textarea, input[name*="message"], input[placeholder*="הודעה"]');
          
          if (nameInput) nameInput.value = data.name;
          if (phoneInput) phoneInput.value = data.phone;
          if (messageInput && data.message_text) messageInput.value = data.message_text;
          
          // Scroll to the form
          contactForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Highlight the form briefly
          contactForm.style.transition = 'all 0.3s ease';
          contactForm.style.boxShadow = '0 0 30px rgba(16, 185, 129, 0.8)';
          setTimeout(() => {
            contactForm.style.boxShadow = '';
          }, 2000);
          
          console.log('✅ Contact form filled');
        } else {
          console.warn('⚠️ Contact form not found');
        }
        
        addBotMessage(data.message || 'מילאתי את הטופס בשבילך! ✅');
      } else if (data.action === 'open_whatsapp') {
        console.log('💬 Bot requested to open WhatsApp');
        
        // Find and click the WhatsApp bubble
        const whatsappBubble = document.querySelector('[id*="whatsapp"], [class*="whatsapp"], a[href*="wa.me"]');
        if (whatsappBubble) {
          whatsappBubble.click();
          console.log('✅ Opened WhatsApp');
        } else {
          console.warn('⚠️ WhatsApp bubble not found');
        }
        
        addBotMessage(data.message || 'פותח את WhatsApp... 💬');
      } else if (data.action === 'scroll_to_section' && data.section_name) {
        console.log('📜 Bot requested to scroll to section:', data.section_name);
        
        // Try to find the section by various methods
        const sectionName = data.section_name.toLowerCase();
        let targetSection = null;
        
        // Method 1: By ID
        targetSection = document.getElementById(sectionName);
        
        // Method 2: By heading text
        if (!targetSection) {
          const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
          for (const heading of headings) {
            if (heading.textContent.toLowerCase().includes(sectionName)) {
              targetSection = heading.closest('section') || heading.parentElement;
              break;
            }
          }
        }
        
        // Method 3: By section with matching text
        if (!targetSection) {
          const sections = document.querySelectorAll('section, .section, [class*="section"]');
          for (const section of sections) {
            if (section.textContent.toLowerCase().includes(sectionName)) {
              targetSection = section;
              break;
            }
          }
        }
        
        if (targetSection) {
          targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          console.log('✅ Scrolled to section:', data.section_name);
        } else {
          console.warn('⚠️ Section not found:', data.section_name);
        }
        
        addBotMessage(data.message || 'הנה החלק שחיפשת! 📍');
      } else if (data.action === 'highlight_element' && data.element_text) {
        console.log('✨ Bot requested to highlight element:', data.element_text);
        
        // Find element by text content
        const allElements = document.querySelectorAll('button, a, h1, h2, h3, h4, .btn, [class*="button"]');
        let targetElement = null;
        
        for (const el of allElements) {
          if (el.textContent.toLowerCase().includes(data.element_text.toLowerCase())) {
            targetElement = el;
            break;
          }
        }
        
        if (targetElement) {
          // Scroll to element
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Create pulsing highlight effect
          const originalBoxShadow = targetElement.style.boxShadow;
          const originalTransform = targetElement.style.transform;
          let pulseCount = 0;
          
          const pulseInterval = setInterval(() => {
            if (pulseCount % 2 === 0) {
              targetElement.style.boxShadow = '0 0 40px rgba(234, 179, 8, 1)';
              targetElement.style.transform = 'scale(1.1)';
            } else {
              targetElement.style.boxShadow = '0 0 20px rgba(234, 179, 8, 0.5)';
              targetElement.style.transform = 'scale(1)';
            }
            pulseCount++;
            
            if (pulseCount >= 6) {
              clearInterval(pulseInterval);
              targetElement.style.boxShadow = originalBoxShadow;
              targetElement.style.transform = originalTransform;
            }
          }, 400);
          
          console.log('✅ Highlighted element');
        } else {
          console.warn('⚠️ Element not found:', data.element_text);
        }
        
        addBotMessage(data.message || 'הנה מה שחיפשת! ✨');
      } else {
        // Regular message - display as is
        addBotMessage(data.message || data.response || 'מצטערת, לא הצלחתי להבין');
      }
    })
    .catch(error => {
      clearTimeout(timeoutId); // Clear timeout on error
      console.error('Bot error:', error);
      hideTypingIndicator();
      
      // Better error messages based on error type
      if (error.name === 'AbortError') {
        addBotMessage('⏱️ הבקשה ארכה יותר מדי. אנא נסה שוב.');
      } else if (!navigator.onLine) {
        addBotMessage('📡 אין חיבור לאינטרנט. בדוק את החיבור ונסה שוב.');
      } else {
        addBotMessage('מצטערת, קרתה שגיאה. נסה שוב בעוד כמה שניות.');
      }
    });
    \`\`\`
    
    **🔑 KEY POINTS:**
    1. ALWAYS use AbortController with 30-second timeout to prevent hanging
    2. ALWAYS parse the response as JSON
    3. Check for bot actions: \`data.action === 'add_to_cart'\` OR \`data.action === 'scroll_to_products'\`
    4. If action exists:
       - For 'add_to_cart': call addToCart() AND display ONLY data.message
       - For 'scroll_to_products': scroll to products section AND display ONLY data.message
    5. NEVER display the raw JSON to the user - ALWAYS display ONLY data.message
    6. Use addBotMessage() or equivalent to display messages in the chat
    7. Provide user-friendly error messages based on error type (timeout, network, general)
    8. Clear timeout on both success and error
    9. **🚨 CRITICAL:** Whether there's an action or not, ALWAYS show ONLY the message text, NEVER the full JSON object!
  - **Bot System Instructions (Instructions for N8N):**
    **שמך:** סתיו - עוזרת חכמה שנותנת שירות בדף
    **אישיות:** שנונה, קצרה, עם נגיעות הומור ומקצועיות
    **הנחיות:**
    - קבלי את המשתמש בסבר פנים יפות
    - הגידי את שמך רק אם תשאלי
    - עני בקצרה על מה שנשאלת - תשובה לעניין וקצרה כמו אדם רגיל, רק על מה שנשאלת
    - תוכלי לשוחח בקצרה על כל נושא אבל תמיד להחזיר את המשתמש לנושא העסק ולהניע לפעולה
    - את בוט אוניברסלי - עונה בשפת הממשק או בשפה שהמשתמש כותב
    
    **מידע עסקי (תפארי את העסק!):**
    - שם העסק: {{ $json.body.business_info.name }}
    - טלפון: {{ $json.body.business_info.phone }} (רק אם מבקשים)
    - אימייל: {{ $json.body.business_info.email }} (רק אם מבקשים)
    - כתובת: {{ $json.body.business_info.address }} (רק אם מבקשים)
    - **אם אין לך תשובה - תמיד תמליצי על צור קשר בדף כאן**
    
    **📋 פרטי האירוע (אם זה דף אירוע):**
    - תאריך: {{ $json.body.event_details.eventDate }}
    - שעה: {{ $json.body.event_details.eventTime }}
    - מקום: {{ $json.body.event_details.eventLocation }}
    - כתובת: {{ $json.body.event_details.eventAddress }}
    - סוג אירוע: {{ $json.body.event_details.eventType }}
    
    **💼 פרטי הדף/העסק:**
    - מקצוע/תחום: {{ $json.body.page_details.profession }}
    - סוג שירות: {{ $json.body.page_details.serviceType }}
    - סוג עסק: {{ $json.body.page_details.businessType }}
    - שם קורס: {{ $json.body.page_details.courseName }}
    - תיאור קורס: {{ $json.body.page_details.courseDescription }}
    
    **🎯 זיהוי סוג הדף והתאמת תשובות:**
    
    **קודם כל - זהי את סוג הדף:**
    - page_type: {{ $json.body.page_type }}
    - businessType: {{ $json.body.page_details.businessType }}
    - profession: {{ $json.body.page_details.profession }}
    
    **לפי סוג הדף, התאימי את התשובות:**
    
    1️⃣ **אם page_type = "event" או "wedding" (הזמנה לאירוע/חתונה):**
       - **השתמשי בפרטי האירוע מ-event_details!**
       - תני פרטים על: תאריך ({{ $json.body.event_details.eventDate }}), שעה ({{ $json.body.event_details.eventTime }}), מקום ({{ $json.body.event_details.eventLocation }})
       - התמקדי ב: אישור הגעה, מיקום, קוד לבוש, שעות הגעה
       - **תמיד הפני לטופס אישור הגעה:** "אפשר לאשר הגעה בטופס באתר!"
    
    2️⃣ **אם page_type = "onlineStore" או "store" (חנות מקוונת):**
       - 🚨 **קיבלת רשימת מוצרים ב-{{ $json.body.products }}** - זוהי רשימה אמיתית מהדף!
       - 🚨 **כל מוצר ברשימה מכיל:** name (שם), price (מחיר), description (תיאור)
       
       **🛒 זיהוי בקשות רכישה:**
       - אם המשתמש מבקש להוסיף מוצר לעגלה (דוגמאות: "אני רוצה 3 שוקולדים", "תוסיף לי 2 עוגות", "הוסף קפה")
       - **חפשי את המוצר ב-{{ $json.body.products }}** לפי שם
       - **החזירי JSON עם פעולה:**
       \`\`\`json
       {
         "message": "✅ מעולה! הוספתי לך [כמות] [שם מוצר] לעגלה 🛒\\nסה\\"כ: ₪[מחיר כפול כמות]",
         "action": "add_to_cart",
         "product_name": "[שם המוצר המדויק מהרשימה]",
         "quantity": [מספר],
         "price": [מחיר יחידה]
       }
       \`\`\`
       
       **✅ דוגמה:**
       - משתמש: "אני רוצה 3 שוקולדים"
       - את בודקת ב-{{ $json.body.products }} ומוצאת: {name: "שוקולד מריר", price: 40}
       - **תחזירי:**
       \`\`\`json
       {
         "message": "✅ מעולה! הוספתי לך 3 שוקולדים מרירים לעגלה 🛒\\nסה\\"כ: ₪120",
         "action": "add_to_cart",
         "product_name": "שוקולד מריר",
         "quantity": 3,
         "price": 40
       }
       \`\`\`
       
       **❌ אם המוצר לא קיים ברשימה:**
       \`\`\`json
       {
         "message": "מצטערת, לא מצאתי את המוצר הזה. מוזמנים לעיין במוצרים הזמינים בדף! 😊"
       }
       \`\`\`
       
       **📋 שאלות על מוצרים (ללא הוספה):**
       - אם המשתמש רק שואל על מחיר - **אל תוסיפי לעגלה**! רק תני מידע.
       - "שוקולד מריר עולה ₪40 ליחידה. רוצה להוסיף לעגלה?"
       
       **📜 גלילה אוטומטית למוצרים:**
       - אם המשתמש מבקש המלצות או לראות מוצרים (דוגמאות: "תראי לי מה יש", "מה יש בחנות", "המלצות", "תראי מוצרים")
       - **החזירי JSON עם פעולת גלילה:**
       \`\`\`json
       {
         "message": "הנה המוצרים שלנו! 🛍️ מוזמנים לעיין ואם משהו מעניין - אשמח לעזור להוסיף לעגלה! 😊",
         "action": "scroll_to_products"
       }
       \`\`\`
       - הדף **יגלול אוטומטית** לגלריית המוצרים והמשתמש יוכל לראות אותם!
       
       **🎯 פעולות גלילה נוספות:**
       - אם המשתמש מבקש לראות **המלצות לקוחות / ביקורות** (דוגמאות: "מה אומרים הלקוחות", "ביקורות", "המלצות"):
       \`\`\`json
       {
         "message": "הנה מה שלקוחותינו אומרים עלינו! ⭐",
         "action": "scroll_to_testimonials"
       }
       \`\`\`
       
       - אם המשתמש מבקש **שאלות ותשובות / FAQ** (דוגמאות: "יש שאלות נפוצות?", "שאלות", "מידע נוסף"):
       \`\`\`json
       {
         "message": "בטח! הנה תשובות לשאלות נפוצות 📋",
         "action": "scroll_to_faq"
       }
       \`\`\`
       
       - אם המשתמש רוצה **פרטי קשר / ליצור קשר**:
       \`\`\`json
       {
         "message": "מוזמנים ליצור קשר! הנה פרטי ההתקשרות שלנו 📞",
         "action": "scroll_to_contact"
       }
       \`\`\`
       
       - אם המשתמש רוצה לפתוח **WhatsApp** (דוגמאות: "שלחי לי בוואטסאפ", "תקשרי בוואטסאפ"):
       \`\`\`json
       {
         "message": "בטח! פותח את WhatsApp עכשיו 💬",
         "action": "open_whatsapp"
       }
       \`\`\`
    
    3️⃣ **אם page_type = "course" (קורס/הדרכה):**
       - **השתמשי בפרטי הקורס:** שם ({{ $json.body.page_details.courseName }}), תיאור ({{ $json.body.page_details.courseDescription }})
       - התמקדי ב: תוכן הקורס, הרשמה, מערכת שעות, תכנית לימודים
       - "ההרשמה לקורס פתוחה - מוזמנים להירשם!"
    
       **📚 הרשמה לקורס:**
       - אם המשתמש רוצה להירשם או לרכוש קורס (דוגמאות: "אני רוצה להירשם", "לקנות את הקורס"):
       \`\`\`json
       {
         "message": "מעולה! אני רושמת אותך לקורס [שם הקורס] 🎓\\nמיד תועבר לתשלום...",
         "action": "enroll_course",
         "courseData": {
           "name": "[שם הקורס]",
           "price": [מחיר],
           "image": "[URL לתמונה]"
         }
       }
       \`\`\`
    
    4️⃣ **אם page_type = "event" (דף אירוע/חתונה) - מילוי טופס אישור הגעה:**
       - אם המשתמש רוצה לאשר הגעה והוא נותן את הפרטים (שם, טלפון, כמות מלווים):
       \`\`\`json
       {
         "message": "מעולה! אני ממלאת את הטופס בשבילך... ✅",
         "action": "fill_rsvp_form",
         "formData": {
           "name": "[שם המשתמש]",
           "phone": "[טלפון]",
           "guests": [מספר מלווים]
         }
       }
       \`\`\`
       - הדף ימלא את הטופס **אוטומטית** ויגלול אליו!
       - אם המשתמש רק מבקש לאשר הגעה אבל לא נתן פרטים:
       \`\`\`json
       {
         "message": "בטח! אני מגלגלת אותך לטופס אישור הגעה 📝 תמלא את הפרטים ותשלח",
         "action": "scroll_to_contact"
       }
       \`\`\`
    
    5️⃣ **אם page_type = "landing" או כרטיס ביקור (אינסטלטור, בעל מקצוע, נותן שירות):**
       - **זהי את המקצוע:** {{ $json.body.page_details.profession }}
       - **זהי את סוג השירות:** {{ $json.body.page_details.serviceType }}
       - התאימי תשובות למקצוע (לדוגמה: אינסטלטור = שיפוצים, אינסטלציה, תיקונים)
       - הפני לפרטי קשר: "מוזמנים ליצור קשר לתיאום פגישה/הצעת מחיר"
       - תני מענה על: שעות פעילות, אזורי שירות, תעריפים (אם יש)
    
    **💡 חשוב:** תמיד התאימי את הטון, השפה והתוכן לסוג הדף הספציפי שאת נמצאת בו!

* **Language & Localization:**
          - Default WhatsApp message: When user clicks WhatsApp bubble, send "היי, אני מעוניין בשירות" (this is the default message for all pages)
  - WhatsApp phone number formatting: Extract phone number from form data, remove all non-digit characters (spaces, dashes, parentheses, etc.), then add the appropriate country code. Use country code: ${data.whatsappCountryCode}. Example: "050-123-4567" becomes "${data.whatsappCountryCode}501234567"
  - Default Language: The page should be created in the language selected: ${data.language} (${data.languageName}). ALL content must be in this language.
  - Country-specific formatting: Format phone numbers, addresses according to: ${data.country}
  - Page Direction: If language is Hebrew (he) or Arabic (ar), set HTML dir="rtl". Otherwise dir="ltr".
  - Complete Translation: Entire page must be in selected language (headings, text, buttons, forms, placeholders, messages, navigation)


## 7. Creative Excellence Standards

**MAKE IT STUNNING - AGENCY-LEVEL QUALITY:**

1. **Modern Web Design Trends 2024:**
   - Use glassmorphism where appropriate (backdrop-filter: blur)
   - Implement smooth scroll animations (scroll-behavior: smooth)
   - Add subtle parallax effects for depth
   - Use CSS Grid and Flexbox masterfully
   - Implement dark mode toggle if it enhances the design
2. **Advanced Tailwind Techniques:**
   - Combine multiple utilities creatively (bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500)
   - Use arbitrary values when needed ([clip-path:polygon(...)])
   - Implement responsive design breakpoints perfectly (sm: md: lg: xl: 2xl:)
   - Use group-hover for interactive cards
   - Apply peer utilities for form validation states

3. **Visual Hierarchy:**
   - Clear F-pattern or Z-pattern for eye flow
   - Important elements should "pop" (larger, colorful, shadowed)
   - Secondary elements should recede (smaller, muted, less contrast)
   - Use size, color, AND spacing to create hierarchy

4. **Emotional Design:**
   - **Landing Page**: Trustworthy, professional, action-oriented
   - **Event/Wedding**: Elegant, romantic, celebratory
   - **Store**: Appetizing, trustworthy, easy to navigate
   - **Brand Page**: Authoritative, memorable, impressive
   - Match colors and imagery to evoke the right emotions

5. **CTAs That Convert:**
   - Primary CTA: Large (px-8 py-4), bold color, strong shadow, clear text
   - Use action verbs: "התחל עכשיו", "הזמן כעת", "קבל הצעה"
   - Add urgency or value: "הצטרף ל-1000+ לקוחות מרוצים"
   - Multiple CTAs throughout the page (above fold, mid-page, footer)

6. **Page-Type Specific Excellence:**
   
   **For Landing Pages:**
   - Attention-grabbing hero with clear value proposition
   - 3-5 benefit boxes with icons
   - Social proof (testimonials, logos, numbers)
   - Urgent CTA with contrast color
   - Trust indicators (security badges, guarantees)
   
   **For Event/Wedding Pages:**
   - Romantic, elegant typography (serif fonts)
   - Countdown timer with beautiful styling
   - Photo gallery or slideshow
   - RSVP form that's inviting and easy
   - Pastel or gold color accents
   - Decorative elements (borders, dividers)
   
   **For Store/Product Pages:**
   - Clean product displays with hover effects
   - Price prominently displayed
   - "Add to Cart" buttons that stand out
   - Product grid with consistent card design
   - Trust badges (secure checkout, free shipping)
   - Shopping cart icon in header
   
   **For Brand/Portfolio Pages:**
   - Bold hero statement about the brand
   - Project/work showcase with hover reveals
   - About section with personality
   - Skills or services grid
   - Contact form that matches brand aesthetics

7. **Random Variation:**
   - For each page type, you have creative freedom to choose from 3-5 different layout variations
   - Vary the hero section design (left-align, center, split-screen, full-background)
   - Alternate between card grids, masonry layouts, and list formats
   - Change section order slightly while maintaining logic
   - Use different animation patterns (fade-in, slide-up, scale)

* **Main Image Directive:**

  * **If 'Use as Background Image' is 'Yes'**: The main image (from Unsplash) **must** be used as a \`background-image\` for the main Hero section. To ensure readability, you **must** add a separate div element as an overlay with a semi-transparent black background (e.g., \`class="absolute inset-0 bg-black/50 bg-overlay"\`) between the background image and the content. **It is important to add the 'bg-overlay' class**.

  * **If 'Use as Background Image' is 'No'**: Place the image as a standard \`<img>\` element.

* **Default Image:** You must find a suitable, high-quality image from Unsplash.

⚠️⚠️⚠️ **CRITICAL IMAGE RULES - MUST FOLLOW:** ⚠️⚠️⚠️
- ✅ ALWAYS use Unsplash URLs (https://images.unsplash.com/...)
- ❌ NEVER EVER use base64 encoded images (data:image/...)
- ❌ NEVER use placeholder images (via.placeholder.com)
- ❌ NEVER generate images yourself
- ✅ ALL images MUST be from Unsplash with proper URLs



## 8. Design Variations & Uniqueness

**CRITICAL**: Each time you generate a page, make it UNIQUE. Don't create cookie-cutter templates.

**For "${s(data.style)}" style, implement ONE of these color scheme variations:**

**Minimalist Pro variations:**
- Variation A: Pure B&W with one accent color (blue, green, or purple)
- Variation B: Soft grays with pastel accent
- Variation C: White with bold typography and minimal color

**Modern variations:**
- Variation A: Blue-purple gradient theme
- Variation B: Teal-cyan contemporary
- Variation C: Dark mode with neon accents

**Luxury variations:**
- Variation A: Gold + deep navy
- Variation B: Rose gold + charcoal
- Variation C: Silver + burgundy

**Event/Wedding variations:**
- Variation A: Blush pink + gold
- Variation B: Sage green + cream
- Variation C: Lavender + silver
- Variation D: Coral + ivory

**Store variations:**
- Variation A: Fresh & clean (white + one brand color)
- Variation B: Warm & inviting (earth tones)
- Variation C: Bold & modern (bright colors, high contrast)

**Layout Variations:** For each section, randomly choose from 2-3 different layout options to create diversity.

## 9. Final Command

Your response must contain only HTML code. Start directly with \`<!DOCTYPE html>\`.

**REMEMBER**: 
- This must be STUNNING - worthy of an award-winning creative agency
- Every element should be polished and professional
- Make it UNIQUE - no two pages should look identical
- Follow the ${s(data.style)} aesthetic but interpret it creatively
- The page should convert visitors into customers/leads/guests

`;

            // Add courses data for digital course platforms
            if (data.courses && data.courses.length > 0) {
                console.log('📝 Adding courses to prompt:', data.courses);
                
                masterPrompt += `\n\n========================================`;
                masterPrompt += `\n📚 **DIGITAL COURSES** (${data.courses.length} courses)`;
                masterPrompt += `\n========================================`;
                masterPrompt += `\n\n⚠️⚠️⚠️ CRITICAL INSTRUCTIONS ⚠️⚠️⚠️`;
                masterPrompt += `\n- YOU MUST CREATE EXACTLY ${data.courses.length} COURSE CARDS`;
                masterPrompt += `\n- DO NOT CREATE YOUR OWN COURSES`;
                masterPrompt += `\n- DO NOT CHANGE THE COURSE NAMES, PRICES, OR DESCRIPTIONS`;
                masterPrompt += `\n- USE THE EXACT DATA PROVIDED BELOW`;
                masterPrompt += `\n\n**CREATE ONE COURSE CARD FOR EACH OF THE FOLLOWING:**`;
                
                data.courses.forEach((course, index) => {
                    masterPrompt += `\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`;
                    masterPrompt += `\n**Course ${index + 1} of ${data.courses.length}:**`;
                    masterPrompt += `\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`;
                    masterPrompt += `\n📝 Course Name (EXACT): "${s(course.name)}"`;
                    masterPrompt += `\n🎥 YouTube Video URL (EXACT): ${s(course.video)}`;
                    masterPrompt += `\n   ⚠️ CRITICAL: Extract video ID and display LOCKED thumbnail with overlay`;
                    masterPrompt += `\n   📺 Thumbnail: https://img.youtube.com/vi/VIDEO_ID/maxresdefault.jpg`;
                    masterPrompt += `\n   🔒 Add lock overlay: "נעול - צפה לאחר רכישה"`;
                    masterPrompt += `\n💰 Price (EXACT): ₪${s(course.price)}`;
                    masterPrompt += `\n📄 Description (EXACT): "${s(course.description)}"`;
                    masterPrompt += `\n🔘 Button Code (EXACT): onclick="addToCart('${s(course.name)}', ${s(course.price)}, 'VIDEO_THUMBNAIL_URL', event)"`;
                    masterPrompt += `\n\n   **AFTER PURCHASE LOGIC:**`;
                    masterPrompt += `\n   - Check if course purchased: localStorage.getItem('purchasedCourses') includes course name`;
                    masterPrompt += `\n   - If purchased: Replace locked thumbnail with embedded YouTube player`;
                    masterPrompt += `\n   - YouTube embed: <iframe src="https://www.youtube.com/embed/VIDEO_ID" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>`;
                });
                
                masterPrompt += `\n\n========================================`;
                masterPrompt += `\n✅ VERIFICATION CHECKLIST:`;
                masterPrompt += `\n- [ ] Created ${data.courses.length} course cards (not more, not less)`;
                masterPrompt += `\n- [ ] Used exact course names from above`;
                masterPrompt += `\n- [ ] Used exact prices from above`;
                masterPrompt += `\n- [ ] Used exact descriptions from above`;
                masterPrompt += `\n- [ ] Used exact onclick code for each button`;
                masterPrompt += `\n========================================`;
                masterPrompt += `\n\n**🎬 VIDEO ACCESS AFTER PURCHASE (CRITICAL):**`;
                masterPrompt += `\n1. Before purchase: Show YouTube thumbnail with lock overlay`;
                masterPrompt += `\n2. User clicks "רכוש את הקורס" → adds to cart → completes purchase`;
                masterPrompt += `\n3. After purchase: Course name saved to localStorage 'purchasedCourses'`;
                masterPrompt += `\n4. Page checks on load: if course purchased → replace thumbnail with YouTube player`;
                masterPrompt += `\n5. User can now watch the full video embedded in the page`;
                masterPrompt += `\n\n**IMPLEMENTATION:**`;
                masterPrompt += `\n- Add JavaScript to check purchased courses on page load`;
                masterPrompt += `\n- For each purchased course: swap locked thumbnail with iframe player`;
                masterPrompt += `\n- Make sure video is responsive and works on mobile`;
                
                console.log('✅ Courses section added to prompt');
            } else {
                console.warn('⚠️ No courses data found! data.courses:', data.courses);
            }

            console.log('Generated masterPrompt length:', masterPrompt.length);
            console.log('MasterPrompt preview:', masterPrompt.substring(0, 500) + '...');
            return masterPrompt;

        }



        function populateTemplateGrid() {

            // סדר מועדף לפי בקשת המשתמש
            const preferredOrder = [
                'landing',      // 1. דף נחיתה - ראשון
                'onlineStore',  // 2. חנות מכוונת - שני
                'serviceProvider', // 3. נותני שירות - שלישי
                'onlineCourse', // 4. קורסים - רביעי
                'realEstate',   // 5. נכסים - חמישי
                'product',      // 6. דף מוצר - שישי
                // השאר בסדר הקיים
            ];
            
            // צור רשימה ממוינת של הסוגים
            const sortedEntries = preferredOrder
                .filter(key => pageTemplates[key]) // רק סוגים שקיימים
                .map(key => [key, pageTemplates[key]])
                .concat(
                    Object.entries(pageTemplates)
                        .filter(([key]) => !preferredOrder.includes(key))
                );

            ui.templateGrid.innerHTML = sortedEntries.map(([key, templateData]) => {

                const t = templateData.t[state.currentLanguage]; // Get translated content

                return `

                <div class="template-card rounded-xl shadow-lg cursor-pointer group" data-type="${key}">

                    <img src="${templateData.img}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/94a3b8?text=Image+Not+Found';" alt="Template for ${t.title}" class="w-full h-80 object-cover">

                    <div class="absolute inset-0 bg-black/20 overlay opacity-0 group-hover:opacity-40"></div>

                    <div class="absolute bottom-0 inset-inline-start-0 inset-inline-end-0 p-6 bg-gradient-to-t from-black/80 to-transparent">

                        <h3 class="font-bold text-2xl text-white">${t.title}</h3>

                        <p class="text-white/80 text-sm mt-1">${t.description}</p>

                    </div>

                </div>

            `}).join('');

        }



        function createDynamicFields(fields) {

            // This function creates form fields. Labels and placeholders should be translated.

            const fieldHTML = {

                websiteLink: `

                <fieldset class="form-fieldset" data-field="websiteLink">

                    <legend class="form-legend" data-translate-key="fieldset_external_links"></legend>

                    <div class="space-y-4">

                        <div>

                            <label for="websiteLinkText" class="block text-sm font-medium text-slate-700" data-translate-key="label_main_button_text"></label>

                            <input type="text" name="websiteLinkText" id="websiteLinkText" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md">

                        </div>

                        <div>

                            <label for="websiteLink" class="block text-sm font-medium text-slate-700" data-translate-key="label_main_button_url"></label>

                            <input type="url" name="websiteLink" id="websiteLink" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md">

                        </div>

                    </div>

                </fieldset>`,


                propertyGallery: `
                <fieldset class="form-fieldset" data-field="propertyGallery">
                    <legend class="form-legend">🏠 גלריית נכסים למכירה</legend>
                    
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200 mb-4">
                            <h4 class="font-semibold text-blue-900 mb-2">🏘️ מערכת נכסים מתקדמת</h4>
                            <p class="text-sm text-blue-700">
                                <strong>מה כולל:</strong> הוסף מספר נכסים, כל נכס עם גלריית תמונות משלו. לחיצה על נכס פותחת חלון עם כל התמונות שלו.
                            </p>
                        </div>
                        
                        <div id="properties-container" class="space-y-6">
                            <!-- נכס ראשון -->
                            <div class="property-item bg-white p-6 rounded-lg border-2 border-gray-300 shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-lg font-bold text-gray-800">🏠 נכס #1</h4>
                                    <button type="button" class="remove-property-btn hidden px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition">
                                        ❌ הסר נכס
                                    </button>
                                </div>
                                
                                <div class="space-y-4">
                                    <!-- פרטי נכס בסיסיים -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">🏘️ כותרת הנכס</label>
                                            <input type="text" name="propertyTitle[]" class="block w-full px-3 py-2 border border-gray-300 rounded" placeholder="דירת גן מרווחת בתל אביב">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">📍 כתובת</label>
                                            <input type="text" name="propertyAddress[]" class="block w-full px-3 py-2 border border-gray-300 rounded" placeholder="רחוב הרצל 123, תל אביב">
                                        </div>
                                    </div>
                                    
                                    <!-- מפרט טכני -->
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">🛏️ חדרים</label>
                                            <input type="number" name="propertyBeds[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="4">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">🚿 אמבטיות</label>
                                            <input type="number" name="propertyBaths[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="2">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">📐 מ"ר</label>
                                            <input type="number" name="propertySqft[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="120">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">💰 מחיר (₪)</label>
                                            <input type="text" name="propertyPrice[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="3,500,000">
                                        </div>
                                    </div>
                                    
                                    <!-- תיאור -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">📝 תיאור הנכס</label>
                                        <textarea name="propertyDescription[]" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded" placeholder="דירת גן מרווחה ומוארת עם גינה פרטית..."></textarea>
                                    </div>
                                    
                                    <!-- הערה על תמונות -->
                                    <div class="bg-purple-50 p-4 rounded border border-purple-200">
                                        <h5 class="font-semibold text-purple-900 mb-2">📸 תמונות הנכס</h5>
                                        <p class="text-sm text-purple-700">
                                            💡 <strong>התמונות יתווספו אחרי יצירת הדף</strong> דרך ממשק העריכה.<br>
                                            כרגע רק הזן את פרטי הנכס, והמערכת תיצור תמונות דוגמה.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" id="add-property-btn" class="w-full px-4 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition shadow-md">
                            ➕ הוסף נכס נוסף
                        </button>
                        
                        <div class="bg-green-50 p-3 rounded-lg mt-4">
                            <p class="text-sm text-green-800 mb-2">
                                <strong>✅ כלול אוטומטית בדף:</strong>
                            </p>
                            <ul class="text-xs text-green-700 space-y-1 mr-4">
                                <li>• 🏘️ גלריית נכסים מעוצבת</li>
                                <li>• 📸 חלון פופאפ עם כל התמונות</li>
                                <li>• ⬅️➡️ ניווט בין תמונות</li>
                                <li>• 📞 כפתור "צור קשר לביקור בנכס"</li>
                                <li>• 📱 עיצוב רספונסיבי</li>
                                <li>• ⌨️ ניווט עם מקלדת (חצים + ESC)</li>
                            </ul>
                        </div>
                    </div>
                </fieldset>`,

                productManagement: `

                <fieldset class="form-fieldset" data-field="productManagement">

                    <legend class="form-legend">הגדרות החנות</legend>

                    <div class="space-y-4">

                        <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                            <h4 class="font-semibold text-blue-900 mb-2">💳 חנות מקוונת מלאה</h4>
                            <p class="text-sm text-blue-700 mb-3">
                                <strong>מה זה חנות מקוונת?</strong><br>
                                גלריית מוצרים עם כפתורי "הוסף לעגלה", עגלת קניות צפה, וטופס תשלום מלא.<br>
                                <strong>כולל:</strong> כרטיס אשראי, PayPal, ביט, משלוח/איסוף עצמי.
                            </p>
                            
                            <div class="bg-white p-3 rounded-lg mb-3">
                                <label class="block text-sm font-semibold text-gray-900 mb-2">📦 כמה מוצרים להציג בחנות?</label>
                                <select name="productCount" id="productCount" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition">
                                    <option value="3">3 מוצרים</option>
                                    <option value="4">4 מוצרים</option>
                                    <option value="6" selected>6 מוצרים (מומלץ)</option>
                                    <option value="8">8 מוצרים</option>
                                    <option value="12">12 מוצרים</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">בחר כמה מוצרים תרצה להציג בקטלוג שלך</p>
                                </div>
                                
                            <div class="bg-green-50 p-3 rounded-lg">
                                <p class="text-sm text-green-800 mb-2">
                                    <strong>✅ כלול אוטומטית בכל חנות:</strong>
                                </p>
                                <ul class="text-xs text-green-700 space-y-1 mr-4">
                                    <li>• 💬 בוט WhatsApp (פינה שמאלית)</li>
                                    <li>• 🤖 בוט AI (פינה ימנית)</li>
                                    <li>• ♿ כפתור נגישות (פינה עליונה)</li>
                                    <li>• 🛒 עגלת קניות צפה</li>
                                    <li>• 💳 טופס תשלום מלא (אשראי, PayPal, ביט)</li>
                                    <li>• 📊 ניהול קניות (נתונים, סטטיסטיקות)</li>
                                </ul>
                                </div>
                        </div>

                    </div>

                </fieldset>`,

                courseManagement: `

                <fieldset class="form-fieldset" data-field="courseManagement">

                    <legend class="form-legend">📚 קורסים דיגיטליים (מוקלטים)</legend>

                    <div class="space-y-4">

                        <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                            <h4 class="font-semibold text-blue-900 mb-2">📚 פלטפורמת קורסים מוקלטים</h4>
                            <p class="text-sm text-blue-700 mb-3">
                                <strong>מה זה?</strong> כל קורס = סרטון מוקלט + מחיר. הלקוחות רוכשים גישה ויכולים לצפות.<br>
                                <strong>כולל:</strong> עגלת קניות, תשלום מאובטח, ממשק ניהול רכישות + נרשמים.
                            </p>
                        </div>

                        <div id="courses-container" class="space-y-4">
                            <!-- Course 1 -->
                            <div class="course-item bg-white p-4 rounded-lg border-2 border-purple-200 shadow-sm">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-semibold text-purple-900">📚 קורס #1</h5>
                                    <button type="button" class="remove-course-btn text-red-600 hover:text-red-800 font-semibold text-sm hidden">
                                        ✖ הסר
                                    </button>
                                </div>
                                
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">שם הקורס</label>
                                        <input type="text" name="courseName[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="למשל: קורס פיתוח אתרים מתקדם">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">🎥 קישור YouTube או העלאת סרטון</label>
                                        <input type="text" name="courseVideo[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="https://youtube.com/watch?v=... או העלה קובץ">
                                        <p class="text-xs text-gray-500 mt-1">💡 ניתן להזין קישור YouTube או להעלות סרטון</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">💰 מחיר (₪)</label>
                                        <input type="number" name="coursePrice[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="199" min="0">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">📝 תיאור קצר</label>
                                        <textarea name="courseDescription[]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="תיאור קצר של הקורס..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" id="add-course-btn" onclick="window.addNewCourse(); return false;" class="w-full px-4 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition shadow-md" style="cursor: pointer; z-index: 100;">
                            ➕ הוסף קורס נוסף
                        </button>
                        
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-sm text-green-800 mb-2">
                                <strong>✅ כלול אוטומטית:</strong>
                            </p>
                            <ul class="text-xs text-green-700 space-y-1 mr-4">
                                <li>• 🛒 עגלת קניות + תשלום מאובטח</li>
                                <li>• 📊 ממשק ניהול: רכישות + נרשמים + ניתוח</li>
                                <li>• 🎥 נגן וידאו לצפייה לאחר רכישה</li>
                                <li>• 💬 בוט WhatsApp + 🤖 בוט AI + ♿ נגישות</li>
                            </ul>
                        </div>

                    </div>

                </fieldset>`,

                workshopDetails: `

                <fieldset class="form-fieldset" data-field="workshopDetails">

                    <legend class="form-legend">פרטי הוובינר/קורס הפרונטלי</legend>

                    <div class="space-y-4">

                        <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200 mb-4">
                            <h4 class="font-semibold text-purple-900 mb-2">🎓 וובינר/קורס פרונטלי חי</h4>
                            <p class="text-sm text-purple-700">
                                <strong>מה כולל:</strong> דף נחיתה לקורס חי (לא מוקלט), ספירה לאחור, פרטי המרצה, וטופס הרשמה.<br>
                                <strong>שים לב:</strong> זה לא קורס מוקלט - זה אירוע חי שצריך להירשם אליו!
                            </p>
                        </div>

                        <div>
                            <label for="workshopDate" class="block text-sm font-medium text-slate-700">📅 תאריך הוובינר/קורס</label>
                            <input type="datetime-local" name="workshopDate" id="workshopDate" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                        </div>

                        <div>
                            <label for="workshopLocation" class="block text-sm font-medium text-slate-700">📍 מיקום (או "אונליין")</label>
                            <input type="text" name="workshopLocation" id="workshopLocation" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder='למשל: "אונליין - Zoom" או "אולם הרצאות, תל אביב"'>
                        </div>

                        <div>
                            <label for="instructorName" class="block text-sm font-medium text-slate-700">👨‍🏫 שם המרצה</label>
                            <input type="text" name="instructorName" id="instructorName" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="למשל: ד״ר יוסי כהן">
                        </div>

                        <div>
                            <label for="instructorBio" class="block text-sm font-medium text-slate-700">📝 אודות המרצה</label>
                            <textarea name="instructorBio" id="instructorBio" rows="3" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="תיאור קצר על המרצה, ניסיון, הישגים..."></textarea>
                        </div>

                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-sm text-green-800 mb-2">
                                <strong>✅ כלול אוטומטית בכל וובינר/קורס פרונטלי:</strong>
                            </p>
                            <ul class="text-xs text-green-700 space-y-1 mr-4">
                                <li>• ⏱️ ספירה לאחור לתאריך הקורס</li>
                                <li>• 📋 טופס הרשמה</li>
                                <li>• 👥 ממשק ניהול נרשמים</li>
                                <li>• 💬 בוט WhatsApp</li>
                                <li>• 🤖 בוט AI</li>
                                <li>• ♿ כפתור נגישות</li>
                            </ul>
                        </div>

                    </div>

                </fieldset>`,

                appLinks: `

                <fieldset class="form-fieldset" data-field="appLinks">

                    <legend class="form-legend" data-translate-key="fieldset_app_links"></legend>

                    <div class="space-y-4">

                        <div><label for="appStoreLink" class="block text-sm font-medium text-slate-700" data-translate-key="label_app_store_link"></label><input type="url" name="appStoreLink" id="appStoreLink" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                        <div><label for="googlePlayLink" class="block text-sm font-medium text-slate-700" data-translate-key="label_google_play_link"></label><input type="url" name="googlePlayLink" id="googlePlayLink" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                    </div>

                </fieldset>`,

                eventDetails: `

                <fieldset class="form-fieldset" data-field="eventDetails">

                    <legend class="form-legend" data-translate-key="fieldset_event_details">פרטי האירוע</legend>

                    <div class="space-y-4">

                        <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200 mb-4">
                            <h4 class="font-semibold text-purple-900 mb-2">🎉 הזמנה לאירוע מותאמת אישית</h4>
                            <p class="text-sm text-purple-700">
                                <strong>מה כולל:</strong> הזמנה מעוצבת עם ספירה לאחור, פרטי האירוע, טופס אישור הגעה (RSVP), ואפשרויות ניהול מוזמנים מתקדמות.
                            </p>
                        </div>

                        <div>
                            <label for="eventDate" class="block text-sm font-medium text-slate-700" data-translate-key="label_event_date">תאריך האירוע</label>
                            <input type="datetime-local" name="eventDate" id="eventDate" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                        </div>

                        <div>
                            <label for="eventLocation" class="block text-sm font-medium text-slate-700" data-translate-key="label_event_location">שם האולם / מקום האירוע</label>
                            <input type="text" name="eventLocation" id="eventLocation" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="למשל: אולם אירועים גן העיר">
                        </div>

                        <div>
                            <label for="eventAddress" class="block text-sm font-medium text-slate-700">כתובת המקום</label>
                            <input type="text" name="eventAddress" id="eventAddress" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="למשל: רחוב הרצל 25, תל אביב">
                            <p class="mt-1 text-sm text-slate-500">הכתובת תשמש למיקום ב-Google Maps בדף האירוע</p>
                        </div>

                        <div class="bg-blue-50 p-3 rounded-lg mt-4">
                            <p class="text-sm text-blue-800 mb-2">
                                <strong>✅ כלול אוטומטית בכל הזמנה:</strong>
                            </p>
                            <ul class="text-xs text-blue-700 space-y-1 mr-4">
                                <li>• ⏱️ ספירה לאחור לאירוע</li>
                                <li>• 📋 טופס אישור הגעה (RSVP)</li>
                                <li>• 👥 ממשק ניהול מוזמנים</li>
                                <li>• 🎁 מערכת רישום מתנות</li>
                                <li>• 🪑 סידור שולחנות אינטראקטיבי</li>
                                <li>• 💬 בוט WhatsApp לעדכונים</li>
                                <li>• ♿ כפתור נגישות</li>
                            </ul>
                        </div>

                    </div>

                </fieldset>`,

                appointmentBooking: `

                <fieldset class="form-fieldset" data-field="appointmentBooking">

                    <legend class="form-legend">מערכת קביעת תורים</legend>

                    <div class="space-y-4">

                        <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200 mb-4">
                            <h4 class="font-semibold text-purple-900 mb-2">📅 מערכת קביעת תורים חכמה</h4>
                            <p class="text-sm text-purple-700">
                                <strong>מה כולל:</strong> יומן תורים אוטומטי, טופס קביעת תור עם שעות פנויות בלבד, ניהול תורים מתקדם, והתראות ללקוחות.
                            </p>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" name="enableAppointmentBooking" id="enableAppointmentBooking" 
                                   class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-600">
                            <label for="enableAppointmentBooking" class="ms-2 block text-sm text-gray-900">הפעל מערכת קביעת תורים</label>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="workStartTime" class="block text-sm font-medium text-gray-700">⏰ שעת התחלת עבודה</label>
                                <input type="time" name="workStartTime" id="workStartTime" value="09:00" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="workEndTime" class="block text-sm font-medium text-gray-700">⏰ שעת סיום עבודה</label>
                                <input type="time" name="workEndTime" id="workEndTime" value="17:00" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">📅 ימי עבודה</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="workDays" value="sunday" checked class="mr-2">
                                    <span class="text-sm">ראשון</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="workDays" value="monday" checked class="mr-2">
                                    <span class="text-sm">שני</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="workDays" value="tuesday" checked class="mr-2">
                                    <span class="text-sm">שלישי</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="workDays" value="wednesday" checked class="mr-2">
                                    <span class="text-sm">רביעי</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="workDays" value="thursday" checked class="mr-2">
                                    <span class="text-sm">חמישי</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="workDays" value="friday" checked class="mr-2">
                                    <span class="text-sm">שישי</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="workDays" value="saturday" class="mr-2">
                                    <span class="text-sm">שבת</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- שעות מיוחדות לימים ספציפיים -->
                        <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200 mt-4">
                            <h4 class="font-semibold text-blue-900 mb-3">🕐 שעות מיוחדות לימים ספציפיים</h4>
                            <p class="text-xs text-blue-700 mb-3">הגדר שעות עבודה שונות לימים מסוימים (למשל: שישי חצי יום 09:00-13:00)</p>
                            
                            <div id="special-hours-container" class="space-y-3">
                                <!-- שעות מיוחדות ראשונות -->
                                <div class="special-hours-item bg-white p-3 rounded border border-blue-200 relative">
                                    <button type="button" class="remove-special-hours-btn absolute top-2 left-2 text-red-500 hover:text-red-700 text-xl font-bold" title="הסר שעות מיוחדות">×</button>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">📅 יום</label>
                                            <select name="specialDay[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                                <option value="">בחר יום...</option>
                                                <option value="sunday">ראשון</option>
                                                <option value="monday">שני</option>
                                                <option value="tuesday">שלישי</option>
                                                <option value="wednesday">רביעי</option>
                                                <option value="thursday">חמישי</option>
                                                <option value="friday">שישי</option>
                                                <option value="saturday">שבת</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">⏰ שעת התחלה</label>
                                            <input type="time" name="specialStartTime[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="09:00">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">⏰ שעת סיום</label>
                                            <input type="time" name="specialEndTime[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="13:00">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- תצוגת סיכום השעות המיוחדות -->
                            <div id="special-hours-summary" class="mt-4 p-3 bg-green-50 rounded border border-green-200 hidden">
                                <h5 class="font-semibold text-green-900 mb-2">✅ שעות מיוחדות שהוגדרו:</h5>
                                <div id="special-hours-list" class="text-sm text-green-800 space-y-1"></div>
                            </div>
                            
                            <button type="button" id="add-special-hours-btn" class="mt-3 px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition">
                                ➕ הוסף יום נוסף עם שעות מיוחדות
                            </button>
                            
                            <div class="mt-3 p-2 bg-blue-100 rounded text-xs text-blue-800">
                                <strong>💡 דוגמה:</strong> אם אתה עובד בשישי רק עד 13:00, בחר "שישי" ושעות 09:00-13:00
                            </div>
                        </div>

                        <!-- הפסקות קבועות -->
                        <div class="bg-orange-50 p-4 rounded-lg border-2 border-orange-200">
                            <h4 class="font-semibold text-orange-900 mb-3">☕ הפסקות קבועות</h4>
                            <p class="text-xs text-orange-700 mb-3">הגדר הפסקות שחוזרות על עצמן בכל יום עבודה (למשל: הפסקת צהריים 13:00-14:00)</p>
                            
                            <div id="breaks-container" class="space-y-3">
                                <!-- הפסקה ראשונה -->
                                <div class="break-item bg-white p-3 rounded border border-orange-200">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">⏰ התחלת הפסקה</label>
                                            <input type="time" name="breakStart[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="13:00">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">⏰ סיום הפסקה</label>
                                            <input type="time" name="breakEnd[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="14:00">
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">📝 תיאור (אופציונלי)</label>
                                        <input type="text" name="breakDescription[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="הפסקת צהריים">
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" id="add-break-btn" class="mt-3 px-3 py-1 bg-orange-500 text-white text-sm rounded hover:bg-orange-600 transition">
                                ➕ הוסף הפסקה נוספת
                            </button>
                        </div>

                        <!-- ניהול שירותים -->
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200 mt-4">
                            <h4 class="font-semibold text-green-900 mb-3">🔧 ניהול שירותים</h4>
                            <p class="text-xs text-green-700 mb-3">הוסף את השירותים שלך עם משך זמן ומחיר (למשל: לק 30 דק, גל ידיים רגליים 45 דק)</p>
                            
                            <div id="services-container" class="space-y-3">
                                <!-- שירות ראשון -->
                                <div class="service-item bg-white p-3 rounded border border-green-200 relative">
                                    <button type="button" class="remove-service-btn absolute top-2 left-2 text-red-500 hover:text-red-700 text-xl font-bold" title="הסר שירות">×</button>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">🔧 שם השירות</label>
                                            <input type="text" name="serviceName[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="למשל: לק, גל ידיים רגליים">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">⏱️ משך (דקות)</label>
                                            <input type="number" name="serviceDuration[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="30" min="1" value="30">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">💰 מחיר (₪)</label>
                                            <input type="number" name="servicePrice[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="0" min="0" step="0.01" value="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" id="add-service-btn" class="mt-3 px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition">
                                ➕ הוסף שירות נוסף
                            </button>
                            
                            <div class="mt-3 p-2 bg-green-100 rounded text-xs text-green-800">
                                <strong>💡 דוגמה:</strong> לק 30 דק ₪50, גל ידיים רגליים 45 דק ₪80
                            </div>
                        </div>

                        <div class="bg-blue-50 p-3 rounded-lg mt-4">
                            <p class="text-sm text-blue-800 mb-2">
                                <strong>✅ כלול אוטומטית במערכת:</strong>
                            </p>
                            <ul class="text-xs text-blue-700 space-y-1 mr-4">
                                <li>• 📅 יומן תורים אינטראקטיבי</li>
                                <li>• ⏰ הצגת שעות פנויות בלבד</li>
                                <li>• 📱 SMS/WhatsApp לאישור תור</li>
                                <li>• ✅ אישור/ביטול תורים</li>
                                <li>• 📊 דוחות ותובנות</li>
                                <li>• 🤖 בוט סתיו לקביעת תור אוטומטי</li>
                            </ul>
                        </div>

                    </div>

                </fieldset>`,

                courseDetails: `

                <fieldset class="form-fieldset" data-field="courseDetails">

                    <legend class="form-legend">פרטי הקורס</legend>

                    <div class="space-y-4">

                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200 mb-4">
                            <h4 class="font-semibold text-green-900 mb-2">🎓 גלריית קורסים/שיעורים</h4>
                            <p class="text-sm text-green-700">
                                <strong>מה כולל:</strong> הוסף סרטוני היכרות, תוכן לדוגמה, או תצוגה מקדימה של הקורס. אפשר להעלות סרטונים או להוסיף קישורי YouTube.
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">📹 הוסף סרטונים/שיעורים</label>
                            <div id="course-videos-container" class="space-y-4">
                                <div class="course-video-item bg-white p-4 border-2 border-dashed border-gray-300 rounded-lg">
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">שם השיעור/סרטון</label>
                                            <input type="text" name="courseVideoTitle[]" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="למשל: שיעור 1 - היכרות">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">בחר סוג:</label>
                                            <div class="flex gap-4 mt-2">
                                                <label class="flex items-center">
                                                    <input type="radio" name="courseVideoType_0" value="youtube" class="mr-2" checked>
                                                    <span class="text-sm">קישור YouTube</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" name="courseVideoType_0" value="upload" class="mr-2">
                                                    <span class="text-sm">העלאת סרטון</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="youtube-input">
                                            <label class="block text-sm font-medium text-gray-700">קישור YouTube</label>
                                            <input type="url" name="courseVideoUrl[]" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="https://youtube.com/watch?v=...">
                                        </div>
                                        <div class="upload-input hidden">
                                            <label class="block text-sm font-medium text-gray-700">העלה סרטון</label>
                                            <input type="file" name="courseVideoFile[]" accept="video/*" class="mt-1 block w-full">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" id="add-course-video-btn" class="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                ➕ הוסף סרטון נוסף
                            </button>
                        </div>

                        <div>
                            <label for="courseInstructor" class="block text-sm font-medium text-gray-700">שם המרצה</label>
                            <input type="text" name="courseInstructor" id="courseInstructor" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="שם המרצה">
                        </div>

                        <div>
                            <label for="courseDate" class="block text-sm font-medium text-gray-700">תאריך תחילת הקורס</label>
                            <input type="date" name="courseDate" id="courseDate" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>

                        <div>
                            <label for="courseLocation" class="block text-sm font-medium text-gray-700">מיקום הקורס</label>
                            <input type="text" name="courseLocation" id="courseLocation" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="אונליין / כתובת פיזית">
                        </div>

                        <div class="bg-blue-50 p-3 rounded-lg mt-4">
                            <p class="text-sm text-blue-800 mb-2">
                                <strong>✅ כלול אוטומטית בדף הקורס:</strong>
                            </p>
                            <ul class="text-xs text-blue-700 space-y-1 mr-4">
                                <li>• ⏱️ ספירה לאחור להתחלת הקורס</li>
                                <li>• 📹 גלריית סרטוני הקורס</li>
                                <li>• 👨‍🏫 פרופיל המרצה</li>
                                <li>• 📝 כפתור הרשמה בולט</li>
                                <li>• 🎯 תוכן הקורס ומי זה בשבילו</li>
                                <li>• 💬 בוט סתיו לשאלות</li>
                            </ul>
                        </div>

                    </div>

                </fieldset>`,

                propertyDetails: `

                <fieldset class="form-fieldset" data-field="propertyDetails">

                    <legend class="form-legend">🏠 פרטי הנכס</legend>

                    <div class="space-y-4">

                        <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200 mb-4">
                            <h4 class="font-semibold text-blue-900 mb-2">🏘️ דף נכס למכירה</h4>
                            <p class="text-sm text-blue-700">
                                <strong>מה כולל:</strong> גלריית תמונות, פרטים טכניים, תיאור הנכס, ופרטי יצירת קשר עם הסוכן ב-WhatsApp.
                            </p>
                        </div>

                        <!-- Image Gallery -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h5 class="font-semibold text-gray-900 mb-3">📸 גלריית תמונות הנכס</h5>
                            
                            <div class="space-y-4">
                                <!-- Main Image -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">🖼️ תמונה ראשית</label>
                                    <input type="file" name="propertyMainImage" id="propertyMainImage" accept="image/*" 
                                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p class="text-xs text-gray-500 mt-1">תמונה זו תופיע בראש הדף</p>
                                </div>
                                
                                <!-- Gallery Images (4 images) -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">🏡 גלריית תמונות (4 תמונות נוספות)</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">תמונה #1</label>
                                            <input type="file" name="propertyImage1" accept="image/*" 
                                                   class="block w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">תמונה #2</label>
                                            <input type="file" name="propertyImage2" accept="image/*" 
                                                   class="block w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">תמונה #3</label>
                                            <input type="file" name="propertyImage3" accept="image/*" 
                                                   class="block w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">תמונה #4</label>
                                            <input type="file" name="propertyImage4" accept="image/*" 
                                                   class="block w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100">
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">💡 העלה 4 תמונות איכותיות נוספות שיוצגו בגלריה</p>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Specs -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="propertyBeds" class="block text-sm font-medium text-gray-700">🛏️ מספר חדרים</label>
                                <input type="number" name="propertyBeds" id="propertyBeds" min="0" 
                                       class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="3">
                            </div>
                            <div>
                                <label for="propertyBaths" class="block text-sm font-medium text-gray-700">🚿 מספר אמבטיות</label>
                                <input type="number" name="propertyBaths" id="propertyBaths" min="0" step="0.5" 
                                       class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="2">
                            </div>
                            <div>
                                <label for="propertySqm" class="block text-sm font-medium text-gray-700">📐 שטח (מ״ר)</label>
                                <input type="number" name="propertySqm" id="propertySqm" min="0" 
                                       class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="120">
                            </div>
                            <div>
                                <label for="propertyPrice" class="block text-sm font-medium text-gray-700">💰 מחיר (₪)</label>
                                <input type="text" name="propertyPrice" id="propertyPrice" 
                                       class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="2,500,000">
                            </div>
                        </div>

                        <!-- Agent Info -->
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <h5 class="font-semibold text-purple-900 mb-3">👤 פרטי הסוכן</h5>
                            <div class="space-y-3">
                                <div>
                                    <label for="agentName" class="block text-sm font-medium text-gray-700">שם הסוכן</label>
                                    <input type="text" name="agentName" id="agentName" 
                                           class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="משה כהן">
                                </div>
                                <div>
                                    <label for="agentPhoto" class="block text-sm font-medium text-gray-700">תמונת הסוכן</label>
                                    <input type="file" name="agentPhoto" id="agentPhoto" accept="image/*" 
                                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-sm text-green-800 mb-2">
                                <strong>✅ כלול אוטומטית בדף הנכס:</strong>
                            </p>
                            <ul class="text-xs text-green-700 space-y-1 mr-4">
                                <li>• 📸 גלריית תמונות אינטראקטיבית</li>
                                <li>• 📋 מפרט טכני מלא</li>
                                <li>• 💬 כפתור WhatsApp "צור קשר לביקור"</li>
                                <li>• 🤖 בוט AI לשאלות</li>
                                <li>• ♿ כפתור נגישות</li>
                            </ul>
                        </div>

                    </div>

                </fieldset>`,

                menuCategories: `
                <fieldset class="form-fieldset" data-field="menuCategories">
                    <legend class="form-legend">🍽️ תפריט המסעדה</legend>
                    <div class="space-y-6">
                        
                        <div class="bg-orange-50 p-4 rounded-lg border-2 border-orange-200 mb-4">
                            <h4 class="font-semibold text-orange-900 mb-2">🍴 תפריט עם קטגוריות</h4>
                            <p class="text-sm text-orange-700">
                                <strong>מה כולל:</strong> ארגן את התפריט לפי קטגוריות (ראשונות, עיקריות, קינוחים, משקאות). כל מנה תכלול תמונה, תיאור, מחיר וכפתור "הוסף לעגלה".
                            </p>
                        </div>

                        <!-- Menu Categories Container -->
                        <div id="menu-categories-container" class="space-y-6">
                            
                            <!-- Category 1: Appetizers -->
                            <div class="menu-category-item bg-white p-5 rounded-lg border-2 border-orange-200 shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h5 class="font-semibold text-orange-900 text-lg">🍔 קטגוריה: מנות ראשונות</h5>
                                    <button type="button" onclick="this.closest('.menu-category-item').remove(); window.updateCategoryNumbers();" class="remove-category-btn text-red-600 hover:text-red-800 font-semibold text-sm">
                                        ✖ הסר קטגוריה
                                    </button>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">שם הקטגוריה</label>
                                    <input type="text" name="categoryName[]" value="מנות ראשונות" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="למשל: ראשונות, עיקריות, קינוחים...">
                                </div>
                                
                                <div class="category-items-container space-y-3" data-category-index="0">
                                    <div class="menu-item bg-gray-50 p-3 rounded-lg border border-gray-200">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-gray-700">🍽️ מנה #1</span>
                                            <button type="button" onclick="this.closest('.menu-item').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">שם המנה</label>
                                                <input type="text" name="itemName_0[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="סלט ירקות">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">מחיר (₪)</label>
                                                <input type="number" name="itemPrice_0[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="25" min="0">
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <label class="block text-xs text-gray-600 mb-1">תיאור קצר</label>
                                            <input type="text" name="itemDescription_0[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="סלט ירקות טריים עם רוטב בית">
                                        </div>
                                        
                                        <!-- Item Options -->
                                        <div class="mt-3 p-2 bg-blue-50 rounded border border-blue-200">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-xs font-medium text-blue-800">🍕 אופציות ותוספות למנה</span>
                                                <button type="button" onclick="addNewItemOption(this, 0, 0)" class="text-blue-600 hover:text-blue-800 text-xs font-medium">➕ הוסף אופציה</button>
                                            </div>
                                            <div class="item-options-container space-y-2">
                                                <!-- Default option -->
                                                <div class="item-option bg-white p-2 rounded border border-blue-100">
                                                    <div class="flex justify-between items-center mb-1">
                                                        <span class="text-xs text-blue-700">אופציה #1</span>
                                                        <button type="button" onclick="this.closest('.item-option').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                                                    </div>
                                                    <div class="grid grid-cols-3 gap-2">
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">שם האופציה</label>
                                                            <input type="text" name="itemOptionName_0_0[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded" placeholder="מנה שניה פיצה" value="מנה שניה פיצה">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">מחיר נוסף</label>
                                                            <input type="number" name="itemOptionPrice_0_0[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded" placeholder="0" min="0" value="0">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">סוג</label>
                                                            <select name="itemOptionType_0_0[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded">
                                                                <option value="single">יחידה</option>
                                                                <option value="multiple" selected>מרובה</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Second option example -->
                                                <div class="item-option bg-white p-2 rounded border border-blue-100">
                                                    <div class="flex justify-between items-center mb-1">
                                                        <span class="text-xs text-blue-700">אופציה #2</span>
                                                        <button type="button" onclick="this.closest('.item-option').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                                                    </div>
                                                    <div class="grid grid-cols-3 gap-2">
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">שם האופציה</label>
                                                            <input type="text" name="itemOptionName_0_0[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded" placeholder="זיתים" value="זיתים">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">מחיר נוסף</label>
                                                            <input type="number" name="itemOptionPrice_0_0[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded" placeholder="5" min="0" value="5">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">סוג</label>
                                                            <select name="itemOptionType_0_0[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded">
                                                                <option value="single">יחידה</option>
                                                                <option value="multiple" selected>מרובה</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" onclick="window.addNewMenuItem(this, 0)" class="mt-3 w-full px-3 py-2 bg-orange-100 text-orange-700 font-semibold rounded-lg hover:bg-orange-200 transition text-sm">
                                    ➕ הוסף מנה לקטגוריה זו
                                </button>
                            </div>

                        </div>

                        <button type="button" id="add-category-btn" onclick="window.addNewCategory(); return false;" class="w-full px-4 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition shadow-md">
                            ➕ הוסף קטגוריה נוספת
                        </button>

                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-sm text-blue-800 mb-2">
                                <strong>✅ כלול אוטומטית בתפריט:</strong>
                            </p>
                            <ul class="text-xs text-blue-700 space-y-1 mr-4">
                                <li>• 🛒 עגלת קניות מלאה</li>
                                <li>• 💳 קופה עם משלוח/איסוף</li>
                                <li>• 📱 שליחה ל-WhatsApp</li>
                                <li>• 🤖 בוט AI לעזרה</li>
                                <li>• ♿ כפתור נגישות</li>
                            </ul>
                        </div>

                    </div>
                </fieldset>`,

                productDetails: `
                <fieldset class="form-fieldset" data-field="productDetails">
                    <legend class="form-legend">📦 פרטי מוצר</legend>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">שם המוצר</label>
                            <input type="text" name="productName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="שם המוצר">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">מחיר (₪)</label>
                            <input type="number" name="productPrice" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">תיאור המוצר</label>
                            <textarea name="productDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="תיאור מפורט של המוצר"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">מפרט טכני</label>
                            <textarea name="productSpecs" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="מפרט טכני של המוצר"></textarea>
                        </div>
                    </div>
                </fieldset>`,

                productGallery: `
                <fieldset class="form-fieldset" data-field="productGallery">
                    <legend class="form-legend">🖼️ גלריית מוצר</legend>
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                            <h4 class="font-semibold text-blue-900 mb-2">📸 תמונות מוצר</h4>
                            <p class="text-sm text-blue-700">הוסף תמונות של המוצר מכמה זוויות שונות</p>
                        </div>
                        <div id="product-images-container" class="space-y-3">
                            <div class="product-image-item bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-medium text-gray-700">📸 תמונה #1</span>
                                    <button type="button" onclick="this.closest('.product-image-item').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                                </div>
                                <input type="url" name="productImage[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="קישור לתמונה">
                            </div>
                        </div>
                        <button type="button" onclick="addNewProductImage()" class="w-full px-4 py-2 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium">
                            ➕ הוסף תמונה נוספת
                        </button>
                    </div>
                </fieldset>`,

                branches: `
                <fieldset class="form-fieldset" data-field="branches">
                    <legend class="form-legend">🏢 סניפים</legend>
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="enableBranches" name="enableBranches" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="enableBranches" class="text-sm font-medium text-blue-900">הוסף כפתור "סניפים" מתחת לכתובת</label>
                            </div>
                            <p class="text-xs text-blue-700 mt-1">כפתור קטן שיפתח רשימת סניפים</p>
                        </div>
                        <div id="branches-container" class="space-y-3" style="display: none;">
                            <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                                <h4 class="font-semibold text-green-900 mb-2">📍 ניהול סניפים</h4>
                                <p class="text-sm text-green-700">הוסף כתובות סניפים נוספים לעסק שלך</p>
                            </div>
                            <div class="space-y-3">
                                <div class="branch-item bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700">🏢 סניף #1</span>
                                        <button type="button" onclick="this.closest('.branch-item').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                                    </div>
                                    <div class="space-y-2">
                                        <input type="text" name="branchName[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="שם הסניף">
                                        <input type="text" name="branchAddress[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="כתובת הסניף">
                                        <input type="tel" name="branchPhone[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="טלפון הסניף">
                                    </div>
                                </div>
                            </div>
                            <button type="button" onclick="addNewBranch()" class="w-full px-4 py-2 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 transition-colors text-sm font-medium">
                                ➕ הוסף סניף נוסף
                            </button>
                        </div>
                    </div>
                </fieldset>`,

                messageName: `
                <div class="space-y-2 p-4 bg-blue-50 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700">שם *</label>
                    <input type="text" name="messageName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="השם שלך">
                </div>`,

                messageRequest: `
                <div class="space-y-2 p-4 bg-blue-50 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700">בקשה/שירות *</label>
                    <textarea name="messageRequest" required rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="מה אתה מציע או מחפש?"></textarea>
                </div>`,

                messageArea: `
                <div class="space-y-2 p-4 bg-blue-50 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700">אזור *</label>
                    <input type="text" name="messageArea" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="תל אביב, נתניה...">
                </div>`,

                messagePhone: `
                <div class="space-y-2 p-4 bg-blue-50 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700">טלפון</label>
                    <input type="tel" name="messagePhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="טלפון (לא חובה)">
                </div>`,

                messagePrice: `
                <div class="space-y-2 p-4 bg-blue-50 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700">מחיר (₪)</label>
                    <input type="number" name="messagePrice" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="100">
                </div>`,

                priceType: `
                <div class="space-y-2 p-4 bg-blue-50 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700">סוג מחיר</label>
                    <select name="priceType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        <option value="">בחירת סוג מחיר</option>
                        <option value="כללי">כללי</option>
                        <option value="שעתי">שעתי</option>
                    </select>
                </div>`

            };

             ui.dynamicFieldsContainer.innerHTML = fields.map(field => fieldHTML[field] || '').join('');

             // Re-apply translations for any new elements

             ui.dynamicFieldsContainer.querySelectorAll('[data-translate-key]').forEach(el => {

                el.textContent = getTranslation(el.dataset.translateKey);

             });

        }
        // --- Event Binding ---

        function bindEventListeners() {

            ui.languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));

            ui.templateGrid.addEventListener('click', (e) => {
                handleTemplateSelection(e);
                
                // Hide gallery and pricing table for onlineStore and realEstate
                setTimeout(() => {
                    const pageType = state.selectedPageType;
                    const galleryCheckbox = document.querySelector('input[value="gallery"]');
                    const pricingCheckbox = document.querySelector('input[value="pricingTable"]');
                    
                    if (pageType === 'onlineStore' || pageType === 'realEstate') {
                        if (galleryCheckbox) galleryCheckbox.closest('.flex').style.display = 'none';
                        if (pricingCheckbox) pricingCheckbox.closest('.flex').style.display = 'none';
                    } else {
                        if (galleryCheckbox) galleryCheckbox.closest('.flex').style.display = '';
                        if (pricingCheckbox) pricingCheckbox.closest('.flex').style.display = '';
                    }
                }, 100);
            });

            ui.detailsForm.addEventListener('submit', handleFormSubmit);
            
            // Make injectStoreScripts globally available BEFORE handleFormSubmit is called
            if (typeof window.injectStoreScripts !== 'function') {
                console.log('⚠️ injectStoreScripts not yet defined - will be available soon');
            }

            if (ui.designSelectionContainer) {

                ui.designSelectionContainer.addEventListener('mouseover', handleStyleHover);

                ui.designSelectionContainer.addEventListener('click', handleStyleSelection);

            }

            ui.backToFormBtn.addEventListener('click', () => {

                switchView(ui.previewView, ui.formView);

                if (state.isEditing) toggleEditMode(false); // Force exit edit mode

            });

            ui.toolsFab.addEventListener('click', handleFabClick);

            ui.savePageBtn.addEventListener('click', handleSavePage);

            ui.downloadPageBtn.addEventListener('click', handleBackToHome);
            ui.iframeImageUploader.addEventListener('change', handleImageUpload);

            ui.uploadImageBtn.addEventListener('click', handleUploadBtnClick);
            
            ui.deleteImageBtn.addEventListener('click', handleDeleteImage);

            ui.textColorPicker.addEventListener('input', (e) => { if (state.currentElementToEdit) state.currentElementToEdit.style.color = e.target.value; });

            ui.bgColorPicker.addEventListener('input', (e) => { if (state.currentElementToEdit) state.currentElementToEdit.style.backgroundColor = e.target.value; });

            ui.opacitySlider.addEventListener('input', (e) => { if(state.currentOverlayToEdit) state.currentOverlayToEdit.style.backgroundColor = `rgba(0, 0, 0, ${e.target.value})`; });

            ui.modalCloseBtn.addEventListener('click', hideModal);

            ui.customModal.addEventListener('click', (e) => { if (e.target === ui.customModal) hideModal(); });

            document.getElementById('back-to-type-btn').addEventListener('click', () => switchView(ui.formView, ui.typeSelectionView));


            // Course Management - Add/Remove Courses
            // Global counter for courses
            window.courseCount = 1;
            
            // Global function to add new course (called from inline onclick)
            window.addNewCourse = function() {
                console.log('🎯 addNewCourse called!');
                
                const coursesContainer = document.getElementById('courses-container');
                if (!coursesContainer) {
                    console.error('❌ courses-container not found!');
                    return;
                }
                
                window.courseCount++;
                const courseItem = document.createElement('div');
                courseItem.className = 'course-item bg-white p-4 rounded-lg border-2 border-purple-200 shadow-sm';
                courseItem.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h5 class="font-semibold text-purple-900">📚 קורס #${window.courseCount}</h5>
                        <button type="button" onclick="this.closest('.course-item').remove(); window.updateCourseNumbers();" class="remove-course-btn text-red-600 hover:text-red-800 font-semibold text-sm">
                            ✖ הסר
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">שם הקורס</label>
                            <input type="text" name="courseName[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="למשל: קורס פיתוח אתרים מתקדם">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">🎥 קישור YouTube או העלאת סרטון</label>
                            <input type="text" name="courseVideo[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="https://youtube.com/watch?v=... או העלה קובץ">
                            <p class="text-xs text-gray-500 mt-1">💡 ניתן להזין קישור YouTube או להעלות סרטון</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">💰 מחיר (₪)</label>
                            <input type="number" name="coursePrice[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="199" min="0">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">📝 תיאור קצר</label>
                            <textarea name="courseDescription[]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="תיאור קצר של הקורס..."></textarea>
                        </div>
                    </div>
                `;
                
                coursesContainer.appendChild(courseItem);
                console.log(`✅ Added course #${window.courseCount}`);
            };
            
            // Global function to update course numbers
            window.updateCourseNumbers = function() {
                const courseItems = document.querySelectorAll('.course-item');
                courseItems.forEach((item, index) => {
                    const title = item.querySelector('h5');
                    if (title) {
                        title.textContent = `📚 קורס #${index + 1}`;
                    }
                });
                window.courseCount = courseItems.length;
            };

            // Menu Categories Management - Add/Remove Categories and Items
            window.categoryCount = 1;

            // Global function to add new category
            window.addNewCategory = function() {
                console.log('🍽️ addNewCategory called!');
                
                const categoriesContainer = document.getElementById('menu-categories-container');
                if (!categoriesContainer) {
                    console.error('❌ menu-categories-container not found!');
                    return;
                }
                
                window.categoryCount++;
                const categoryIndex = window.categoryCount - 1;
                const categoryItem = document.createElement('div');
                categoryItem.className = 'menu-category-item bg-white p-5 rounded-lg border-2 border-orange-200 shadow-sm';
                categoryItem.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h5 class="font-semibold text-orange-900 text-lg">🍴 קטגוריה #${window.categoryCount}</h5>
                        <button type="button" onclick="this.closest('.menu-category-item').remove(); window.updateCategoryNumbers();" class="remove-category-btn text-red-600 hover:text-red-800 font-semibold text-sm">
                            ✖ הסר קטגוריה
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">שם הקטגוריה</label>
                        <input type="text" name="categoryName[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200" placeholder="למשל: ראשונות, עיקריות, קינוחים...">
                    </div>
                    
                    <div class="category-items-container space-y-3" data-category-index="${categoryIndex}">
                        <div class="menu-item bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">🍽️ מנה #1</span>
                                <button type="button" onclick="this.closest('.menu-item').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">שם המנה</label>
                                    <input type="text" name="itemName_${categoryIndex}[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="שם המנה">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">מחיר (₪)</label>
                                    <input type="number" name="itemPrice_${categoryIndex}[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="25" min="0">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-xs text-gray-600 mb-1">תיאור קצר</label>
                                <input type="text" name="itemDescription_${categoryIndex}[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="תיאור המנה">
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" onclick="window.addNewMenuItem(this, ${categoryIndex})" class="mt-3 w-full px-3 py-2 bg-orange-100 text-orange-700 font-semibold rounded-lg hover:bg-orange-200 transition text-sm">
                        ➕ הוסף מנה לקטגוריה זו
                    </button>
                `;
                
                categoriesContainer.appendChild(categoryItem);
                console.log(`✅ Added category #${window.categoryCount}`);
            };

            // Global function to add new menu item to a specific category
            window.addNewMenuItem = function(button, categoryIndex) {
                console.log(`🍽️ addNewMenuItem called for category ${categoryIndex}`);
                
                const categoryItem = button.closest('.menu-category-item');
                const itemsContainer = categoryItem.querySelector('.category-items-container');
                
                if (!itemsContainer) {
                    console.error('❌ items container not found!');
                    return;
                }
                
                const currentItemCount = itemsContainer.querySelectorAll('.menu-item').length;
                
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item bg-gray-50 p-3 rounded-lg border border-gray-200';
                menuItem.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">🍽️ מנה #${currentItemCount + 1}</span>
                        <button type="button" onclick="this.closest('.menu-item').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">שם המנה</label>
                            <input type="text" name="itemName_${categoryIndex}[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="שם המנה">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">מחיר (₪)</label>
                            <input type="number" name="itemPrice_${categoryIndex}[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="25" min="0">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs text-gray-600 mb-1">תיאור קצר</label>
                        <input type="text" name="itemDescription_${categoryIndex}[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="תיאור המנה">
                    </div>
                    
                    <!-- Item Options -->
                    <div class="mt-3 p-2 bg-blue-50 rounded border border-blue-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-medium text-blue-800">🍕 אופציות ותוספות למנה</span>
                            <button type="button" onclick="addNewItemOption(this, ${categoryIndex}, ${currentItemCount})" class="text-blue-600 hover:text-blue-800 text-xs font-medium">➕ הוסף אופציה</button>
                        </div>
                        <div class="item-options-container space-y-2">
                            <!-- Default option -->
                            <div class="item-option bg-white p-2 rounded border border-blue-100">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs text-blue-700">אופציה #1</span>
                                    <button type="button" onclick="this.closest('.item-option').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">שם האופציה</label>
                                        <input type="text" name="itemOptionName_${categoryIndex}_${currentItemCount}[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded" placeholder="גדל">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">מחיר נוסף</label>
                                        <input type="number" name="itemOptionPrice_${categoryIndex}_${currentItemCount}[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded" placeholder="0" min="0" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">סוג</label>
                                        <select name="itemOptionType_${categoryIndex}_${currentItemCount}[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded">
                                            <option value="single">יחידה</option>
                                            <option value="multiple">מרובה</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                itemsContainer.appendChild(menuItem);
                console.log(`✅ Added menu item #${currentItemCount + 1} to category ${categoryIndex}`);
            };

            // Global function to update category numbers
            window.updateCategoryNumbers = function() {
                const categoryItems = document.querySelectorAll('.menu-category-item');
                categoryItems.forEach((item, index) => {
                    const title = item.querySelector('h5');
                    if (title) {
                        title.textContent = `🍴 קטגוריה #${index + 1}`;
                    }
                    // Update category index
                    const itemsContainer = item.querySelector('.category-items-container');
                    if (itemsContainer) {
                        itemsContainer.dataset.categoryIndex = index;
                    }
                });
                window.categoryCount = categoryItems.length;
            };

            // Global function to add new option to a specific menu item
            window.addNewItemOption = function(button, categoryIndex, itemIndex) {
                console.log(`🍕 addNewItemOption called for category ${categoryIndex}, item ${itemIndex}!`);
                
                const menuItem = button.closest('.menu-item');
                const optionsContainer = menuItem.querySelector('.item-options-container');
                
                if (!optionsContainer) {
                    console.error('❌ item-options-container not found!');
                    return;
                }
                
                const currentOptionCount = optionsContainer.querySelectorAll('.item-option').length + 1;
                
                const optionItem = document.createElement('div');
                optionItem.className = 'item-option bg-white p-2 rounded border border-blue-100';
                optionItem.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-blue-700">אופציה #${currentOptionCount}</span>
                        <button type="button" onclick="this.closest('.item-option').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">שם האופציה</label>
                            <input type="text" name="itemOptionName_${categoryIndex}_${itemIndex}[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded" placeholder="שם האופציה">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">מחיר נוסף</label>
                            <input type="number" name="itemOptionPrice_${categoryIndex}_${itemIndex}[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded" placeholder="0" min="0" value="0">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">סוג</label>
                            <select name="itemOptionType_${categoryIndex}_${itemIndex}[]" class="w-full px-1.5 py-1 text-xs border border-gray-300 rounded">
                                <option value="single">יחידה</option>
                                <option value="multiple">מרובה</option>
                            </select>
                        </div>
                    </div>
                `;
                
                optionsContainer.appendChild(optionItem);
                console.log(`✅ Added option #${currentOptionCount} to item ${itemIndex} in category ${categoryIndex}`);
            };

            // Global function to add new product image
            window.addNewProductImage = function() {
                console.log('📸 addNewProductImage called!');
                
                const container = document.getElementById('product-images-container');
                if (!container) {
                    console.error('❌ product-images-container not found!');
                    return;
                }
                
                const currentImageCount = container.querySelectorAll('.product-image-item').length + 1;
                
                const imageItem = document.createElement('div');
                imageItem.className = 'product-image-item bg-gray-50 p-3 rounded-lg border border-gray-200';
                imageItem.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">📸 תמונה #${currentImageCount}</span>
                        <button type="button" onclick="this.closest('.product-image-item').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                    </div>
                    <input type="url" name="productImage[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="קישור לתמונה">
                `;
                
                container.appendChild(imageItem);
                console.log(`✅ Added product image #${currentImageCount}`);
            };

            // Global function to add new branch
            window.addNewBranch = function() {
                console.log('🏢 addNewBranch called!');
                
                const container = document.getElementById('branches-container');
                if (!container) {
                    console.error('❌ branches-container not found!');
                    return;
                }
                
                const currentBranchCount = container.querySelectorAll('.branch-item').length + 1;
                
                const branchItem = document.createElement('div');
                branchItem.className = 'branch-item bg-gray-50 p-3 rounded-lg border border-gray-200';
                branchItem.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">🏢 סניף #${currentBranchCount}</span>
                        <button type="button" onclick="this.closest('.branch-item').remove();" class="text-red-500 hover:text-red-700 text-xs">✖</button>
                    </div>
                    <div class="space-y-2">
                        <input type="text" name="branchName[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="שם הסניף">
                        <input type="text" name="branchAddress[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="כתובת הסניף">
                        <input type="tel" name="branchPhone[]" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded" placeholder="טלפון הסניף">
                    </div>
                `;
                
                container.appendChild(branchItem);
                console.log(`✅ Added branch #${currentBranchCount}`);
            };

            // Toggle branches container when checkbox is clicked
            document.addEventListener('change', function(e) {
                if (e.target.id === 'enableBranches') {
                    const branchesContainer = document.getElementById('branches-container');
                    if (branchesContainer) {
                        branchesContainer.style.display = e.target.checked ? 'block' : 'none';
                    }
                }
            });
            
            
            // OLD FUNCTION - kept for backwards compatibility but not used
            function initCourseManagement() {
                console.log('🎓 Initializing course management...');
                
            let courseCount = 1;
            const addCourseBtn = document.getElementById('add-course-btn');
            const coursesContainer = document.getElementById('courses-container');

                if (!addCourseBtn || !coursesContainer) {
                    console.warn('⚠️ Course elements not found yet, retrying...');
                    setTimeout(initCourseManagement, 100);
                    return;
                }

                console.log('✅ Course elements found, setting up listeners');
                console.log('🔍 Button element:', addCourseBtn);
                console.log('🔍 Container element:', coursesContainer);

                // Simple direct listener - no cloning
                addCourseBtn.addEventListener('click', (e) => {
                    console.log('🎯 Button clicked!');
                    e.preventDefault();
                    e.stopPropagation();
                    courseCount++;
                    const courseItem = document.createElement('div');
                    courseItem.className = 'course-item bg-white p-4 rounded-lg border-2 border-purple-200 shadow-sm';
                    courseItem.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-semibold text-purple-900">📚 קורס #${courseCount}</h5>
                            <button type="button" class="remove-course-btn text-red-600 hover:text-red-800 font-semibold text-sm">
                                ✖ הסר
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">שם הקורס</label>
                                <input type="text" name="courseName[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="למשל: קורס פיתוח אתרים מתקדם">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">🎥 קישור YouTube או העלאת סרטון</label>
                                <input type="text" name="courseVideo[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="https://youtube.com/watch?v=... או העלה קובץ">
                                <p class="text-xs text-gray-500 mt-1">💡 ניתן להזין קישור YouTube או להעלות סרטון</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">💰 מחיר (₪)</label>
                                <input type="number" name="coursePrice[]" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="199" min="0">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">📝 תיאור קצר</label>
                                <textarea name="courseDescription[]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" placeholder="תיאור קצר של הקורס..."></textarea>
                            </div>
                        </div>
                    `;
                    
                    coursesContainer.appendChild(courseItem);
                    updateRemoveCourseButtons();
                    console.log(`✅ Added course #${courseCount}`);
                });

                // Event delegation for remove buttons
                coursesContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-course-btn')) {
                        e.target.closest('.course-item').remove();
                        courseCount--;
                        updateCourseNumbers();
                        updateRemoveCourseButtons();
                        console.log(`🗑️ Removed course, now ${courseCount} total`);
                    }
                });

                function updateRemoveCourseButtons() {
                    const courseItems = coursesContainer.querySelectorAll('.course-item');
                    courseItems.forEach((item, index) => {
                        const removeBtn = item.querySelector('.remove-course-btn');
                        if (courseItems.length > 1) {
                            removeBtn.classList.remove('hidden');
                        } else {
                            removeBtn.classList.add('hidden');
                        }
                    });
                }

                function updateCourseNumbers() {
                    const courseItems = coursesContainer.querySelectorAll('.course-item');
                    courseItems.forEach((item, index) => {
                        const title = item.querySelector('h5');
                        title.textContent = `📚 קורס #${index + 1}`;
                    });
                }
                
                console.log('🎓 Course management initialized successfully!');
            }

            // Store Management Dashboard
            document.getElementById('close-dashboard-btn').addEventListener('click', () => {
                document.getElementById('store-management-dashboard').classList.add('hidden');
            });

            // Dashboard Navigation
            document.querySelectorAll('.dashboard-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    document.querySelectorAll('.dashboard-nav-btn').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    btn.classList.add('active');
                    
                    // Hide all sections
                    document.querySelectorAll('.dashboard-section').forEach(section => {
                        section.classList.add('hidden');
                    });
                    
                    // Show selected section
                    const sectionId = btn.getAttribute('data-section') + '-section';
                    document.getElementById(sectionId).classList.remove('hidden');
                });
            });

            // Close dashboard when clicking outside
            document.getElementById('store-management-dashboard').addEventListener('click', (e) => {
                if (e.target.id === 'store-management-dashboard') {
                    document.getElementById('store-management-dashboard').classList.add('hidden');
                }
            });

            // Function to open page-specific management interface
            window.openStoreManagement = function() {
                // Update dashboard title based on page type
                const pageType = state.selectedPageType;
                const dashboardTitle = document.getElementById('dashboard-title');
                
                if (pageType === 'event') {
                    dashboardTitle.textContent = 'ניהול מוזמנים';
                } else if (pageType === 'onlineStore') {
                    dashboardTitle.textContent = 'ניהול חנות';
                } else {
                    dashboardTitle.textContent = 'ניהול הדף';
                }
                // Create management interface for this specific page
                createPageManagementInterface();
            };

            // Function to create page-specific management interface
            function createPageManagementInterface() {
                // Remove existing management interface if any
                const existing = document.getElementById('page-management-interface');
                if (existing) {
                    existing.remove();
                }

                // Create new management interface
                const managementInterface = document.createElement('div');
                managementInterface.id = 'page-management-interface';
                managementInterface.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                managementInterface.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl w-11/12 h-5/6 max-w-4xl overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-600 to-pink-500 text-white p-6">
                            <div class="flex justify-between items-center">
                                <h1 class="text-2xl font-bold">ניהול הדף</h1>
                                <button onclick="closePageManagement()" class="text-white hover:text-gray-200 text-2xl">×</button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <h3 class="text-lg font-semibold text-blue-900 mb-4">נתוני הדף</h3>
                                    <p class="text-blue-700">שם הדף: ${document.title || 'ללא שם'}</p>
                                    <p class="text-blue-700">תאריך יצירה: ${new Date().toLocaleDateString('he-IL')}</p>
                                    <p class="text-blue-700">מספר ביקורים: ${Math.floor(Math.random() * 1000)}</p>
                                </div>
                                
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <h3 class="text-lg font-semibold text-green-900 mb-4">פעולות מהירות</h3>
                                    <div class="space-y-2">
                                        <button onclick="editPageContent()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">ערוך תוכן</button>
                                        <button onclick="viewAnalytics()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">צפה בסטטיסטיקות</button>
                                        <button onclick="exportPage()" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700">ייצא דף</button>
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 p-6 rounded-lg">
                                    <h3 class="text-lg font-semibold text-yellow-900 mb-4">הגדרות הדף</h3>
                                    <div class="space-y-2">
                                        <button onclick="changePageTitle()" class="w-full bg-yellow-600 text-white py-2 px-4 rounded hover:bg-yellow-700">שנה כותרת</button>
                                        <button onclick="changePageColors()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700">שנה צבעים</button>
                                        <button onclick="addNewSection()" class="w-full bg-pink-600 text-white py-2 px-4 rounded hover:bg-pink-700">הוסף קטע</button>
                                    </div>
                                </div>
                                
                                <div class="bg-red-50 p-6 rounded-lg">
                                    <h3 class="text-lg font-semibold text-red-900 mb-4">ניהול מתקדם</h3>
                                    <div class="space-y-2">
                                        <button onclick="viewPageSource()" class="w-full bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700">צפה בקוד המקור</button>
                                        <button onclick="duplicatePage()" class="w-full bg-teal-600 text-white py-2 px-4 rounded hover:bg-teal-700">שכפל דף</button>
                                        <button onclick="deletePage()" class="w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">מחק דף</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(managementInterface);
            }

            // Function to close page management
            window.closePageManagement = function() {
                const managementInterface = document.getElementById('page-management-interface');
                if (managementInterface) {
                    managementInterface.remove();
                }
            };

            // Management functions
            window.editPageContent = function() {
                alert('פתיחת עורך התוכן...');
            };

            window.viewAnalytics = function() {
                alert('צפייה בסטטיסטיקות הדף...');
            };

            window.exportPage = function() {
                alert('ייצוא הדף...');
            };

            window.changePageTitle = function() {
                const newTitle = prompt('הזן כותרת חדשה:', document.title);
                if (newTitle) {
                    document.title = newTitle;
                }
            };

            window.changePageColors = function() {
                alert('פתיחת עורך הצבעים...');
            };

            window.addNewSection = function() {
                alert('הוספת קטע חדש...');
            };

            window.viewPageSource = function() {
                alert('צפייה בקוד המקור של הדף...');
            };

            window.duplicatePage = function() {
                alert('שכפול הדף...');
            };

            window.deletePage = function() {
                if (confirm('האם אתה בטוח שברצונך למחוק את הדף?')) {
                    alert('מחיקת הדף...');
                }
            };

            ui.formView.addEventListener('focusin', (e) => {

                if (e.target.dataset.guidanceKey) {

                    ui.guidanceBubble.innerHTML = getTranslation(e.target.dataset.guidanceKey);

                    ui.guidanceBubble.classList.remove('hidden');

                }

            });

            ui.assistantAvatar.addEventListener('click', () => {

                ui.guidanceBubble.classList.toggle('hidden');

            });

        }



        // --- Event Handlers ---

        function handleTemplateSelection(event) {

            const card = event.target.closest('.template-card');

            if (!card) return;



            state.selectedPageType = card.dataset.type;

            const template = pageTemplates[state.selectedPageType].t[state.currentLanguage];

            

            state.selectedPageTitle = template.title;

            ui.pageTypeTitle.textContent = template.title;

            ui.mainNameLabel.textContent = template.label;
            
            ui.guidanceBubble.innerHTML = template.guidance;

            ui.guidanceBubble.classList.remove('hidden');
            
            // Add bot guidance for template selection
            showTemplateSelectionGuidance(state.selectedPageType, template.title);
            
            // Trigger event for field guidance system
            setTimeout(() => {
                document.dispatchEvent(new CustomEvent('templateChanged'));
            }, 100);

            // Update description label based on page type
            try {
                const descriptionLabel = document.querySelector('label[for="description"]');
                if (descriptionLabel && state.selectedPageType && state.currentLanguage) {
                    if (state.selectedPageType === 'event') {
                        descriptionLabel.textContent = state.currentLanguage === 'he' ? 'פרטי האירוע' : 'Event Details';
                    } else {
                        descriptionLabel.textContent = state.currentLanguage === 'he' ? 'תיאור העסק' : 'Business Description';
                    }
                }

                // Update contact name label for events
                const contactNameLabel = document.querySelector('label[for="contactName"]');
                if (contactNameLabel && state.selectedPageType && state.currentLanguage) {
                    if (state.selectedPageType === 'event') {
                        contactNameLabel.textContent = state.currentLanguage === 'he' ? 'שם המארגן' : 'Organizer Name';
                    } else {
                        contactNameLabel.textContent = state.currentLanguage === 'he' ? 'שם איש קשר' : 'Contact Name';
                    }
                }
            } catch (error) {
                console.warn('Error updating labels:', error);
            }

            createDynamicFields(pageTemplates[state.selectedPageType].fields);

            // Initialize course management after dynamic fields are created
            if (state.selectedPageType === 'onlineCourse') {
                console.log('🎯 Selected page type is onlineCourse, initializing course management...');
                setTimeout(() => {
                    initCourseManagement();
                }, 200); // Increased delay to ensure DOM is ready
            } else {
                console.log('ℹ️ Selected page type:', state.selectedPageType);
            }

            const showExtraSections = !['flyer', 'post', 'businessCard', 'event', 'messageInBottle'].includes(state.selectedPageType);

            const showDesignStyle = state.selectedPageType !== 'messageInBottle'; 

            const showAccessibilityOption = !['flyer', 'post', 'messageInBottle'].includes(state.selectedPageType);

            // Hide basic details fieldset for messageInBottle and remove required attribute
            if (state.selectedPageType === 'messageInBottle') {
                const basicDetailsFieldset = document.getElementById('basic-details-fieldset');
                if (basicDetailsFieldset) {
                    basicDetailsFieldset.style.display = 'none';
                }
                
                // Remove required attribute from hidden fields
                const mainNameInput = document.getElementById('mainName');
                const contactNameInput = document.getElementById('contactName');
                const emailInput = document.getElementById('email');
                const phoneInput = document.getElementById('phone');
                const descriptionInput = document.getElementById('description');
                
                if (mainNameInput) mainNameInput.removeAttribute('required');
                if (contactNameInput) contactNameInput.removeAttribute('required');
                if (emailInput) emailInput.removeAttribute('required');
                if (phoneInput) phoneInput.removeAttribute('required');
                if (descriptionInput) descriptionInput.removeAttribute('required');
            } else {
                const basicDetailsFieldset = document.getElementById('basic-details-fieldset');
                if (basicDetailsFieldset) {
                    basicDetailsFieldset.style.display = 'block';
                }
                
                // Restore required attribute
                const mainNameInput = document.getElementById('mainName');
                const contactNameInput = document.getElementById('contactName');
                const emailInput = document.getElementById('email');
                const phoneInput = document.getElementById('phone');
                const descriptionInput = document.getElementById('description');
                
                if (mainNameInput) mainNameInput.setAttribute('required', '');
                if (contactNameInput) contactNameInput.setAttribute('required', '');
                if (emailInput) emailInput.setAttribute('required', '');
                if (phoneInput) phoneInput.setAttribute('required', '');
                if (descriptionInput) descriptionInput.setAttribute('required', '');
            }

            ui.socialMediaFieldset.style.display = showExtraSections ? 'block' : 'none';

            ui.optionalSectionsFieldset.style.display = showExtraSections ? 'block' : 'none';

            ui.designStyleFieldset.style.display = showDesignStyle ? 'block' : 'none';

            ui.addressFieldContainer.style.display = showExtraSections ? 'block' : 'none';

            

            const accessibilityContainer = document.getElementById('accessibility-field-container');

            if(accessibilityContainer) {

                 accessibilityContainer.style.display = showAccessibilityOption ? 'block' : 'none';

            }





            if (showExtraSections) {

                const optionsGrid = ui.optionalSectionsFieldset.querySelector('.grid');

                // Filter out 'services' section for serviceProvider - services should only be in appointment booking form
                const sectionsToShow = Object.entries(availableSections).filter(([key, sectionData]) => {
                    if (state.selectedPageType === 'serviceProvider' && key === 'services') {
                        return false; // Hide services for serviceProvider
                    }
                    return true;
                });

                optionsGrid.innerHTML = sectionsToShow.map(([key, sectionData]) => {

                     const section = sectionData.t[state.currentLanguage];

                     return `

                    <div class="flex items-center">

                        <input id="section-${key}" name="optionalSections" type="checkbox" value="${key}" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-600">

                        <label for="section-${key}" class="ms-2 block text-sm text-gray-900">${section.title}</label>

                    </div>

                `}).join('');

            }



            switchView(ui.typeSelectionView, ui.formView);

        }



        function handleStyleHover(event) {

            const card = event.target.closest('.option-card');

            if (card && card.dataset.guidanceKey) {

                ui.guidanceBubble.innerHTML = getTranslation(card.dataset.guidanceKey);

                ui.guidanceBubble.classList.remove('hidden');

            }

        }



        function handleStyleSelection(event) {

            const selectedCard = event.target.closest('.option-card');

            if (!selectedCard) return;

            ui.designSelectionContainer.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));

            selectedCard.classList.add('selected');

            state.selectedStyle = selectedCard.dataset.value;

        }



        async function handleFormSubmit(event) {

            event.preventDefault();

            // Skip style validation for messageInBottle
            if (!state.selectedStyle && state.selectedPageType !== 'messageInBottle') {

                showModal('modal_error_style');

                return;

            }

            

            setLoading(true);



            const formData = new FormData(ui.detailsForm);

            let data = Object.fromEntries(formData.entries());
            
            // Collect services for serviceProvider pages (arrays need special handling)
            if (state.selectedPageType === 'serviceProvider' || state.selectedPageType === 'appointment') {
                console.log('🔍 Collecting services for serviceProvider page...');
                const serviceNames = formData.getAll('serviceName[]');
                const serviceDurations = formData.getAll('serviceDuration[]');
                const servicePrices = formData.getAll('servicePrice[]');
                
                console.log('📋 Services found:', {
                    names: serviceNames,
                    durations: serviceDurations,
                    prices: servicePrices
                });
                
                // Store as arrays in data
                data.serviceName = serviceNames;
                data.serviceDuration = serviceDurations;
                data.servicePrice = servicePrices;
                
                console.log('✅ Services collected:', data.serviceName.length, 'services');
                
                // IMPORTANT: Collect enableAppointmentBooking checkbox value
                const enableAppointmentBookingCheckbox = document.getElementById('enableAppointmentBooking');
                if (enableAppointmentBookingCheckbox) {
                    data.enableAppointmentBooking = enableAppointmentBookingCheckbox.checked;
                    console.log('📅 enableAppointmentBooking checkbox value:', data.enableAppointmentBooking);
                } else {
                    console.warn('⚠️ enableAppointmentBooking checkbox not found!');
                    data.enableAppointmentBooking = false; // Default to false if not found
                }
                
                // IMPORTANT: Collect working days as array (checkboxes with same name)
                const workDaysArray = formData.getAll('workDays');
                data.workDays = workDaysArray;
                console.log('📅 Working days collected from FormData:', workDaysArray, 'length:', workDaysArray.length);
                
                // Debug: Check all checkboxes directly
                const allWorkDayCheckboxes = document.querySelectorAll('input[name="workDays"]');
                const checkedDays = [];
                allWorkDayCheckboxes.forEach(cb => {
                    console.log(`📅 Checkbox ${cb.value}: checked=${cb.checked}`);
                    if (cb.checked) checkedDays.push(cb.value);
                });
                console.log('📅 Checked days from DOM:', checkedDays);
                
                // If FormData didn't get all values, use DOM values
                if (workDaysArray.length === 0 || workDaysArray.length < checkedDays.length) {
                    console.log('⚠️ Using DOM values instead of FormData');
                    data.workDays = checkedDays;
                }
                
                // Collect special hours
                const specialDays = formData.getAll('specialDay[]');
                const specialStartTimes = formData.getAll('specialStartTime[]');
                const specialEndTimes = formData.getAll('specialEndTime[]');
                data.specialDay = specialDays;
                data.specialStartTime = specialStartTimes;
                data.specialEndTime = specialEndTimes;
                console.log('🕐 Special hours collected:', { days: specialDays, starts: specialStartTimes, ends: specialEndTimes });
                
                // Collect breaks
                const breakStarts = formData.getAll('breakStart[]');
                const breakEnds = formData.getAll('breakEnd[]');
                const breakDescs = formData.getAll('breakDesc[]');
                data.breakStart = breakStarts;
                data.breakEnd = breakEnds;
                data.breakDesc = breakDescs;
                console.log('☕ Breaks collected:', { starts: breakStarts, ends: breakEnds, descs: breakDescs });
            }

            // נגישות, AI Bot ו-WhatsApp תמיד מופיעים
            data.addAccessibility = true;
            data.addAiBot = true;
            data.useAsBackground = document.getElementById('use-as-background').checked;

            // Set default style for messageInBottle if no style is selected
            data.style = state.selectedStyle || (state.selectedPageType === 'messageInBottle' ? 'minimal' : state.selectedStyle);

            data.pageType = state.selectedPageType;

            // Collect messageInBottle specific data
            if (state.selectedPageType === 'messageInBottle') {
                // Debug: Check if elements exist
                console.log('🔍 Looking for messageInBottle form elements...');
                const nameEl = document.querySelector('input[name="messageName"]');
                const requestEl = document.querySelector('textarea[name="messageRequest"]');
                const areaEl = document.querySelector('input[name="messageArea"]');
                const phoneEl = document.querySelector('input[name="messagePhone"]');
                const priceEl = document.querySelector('input[name="messagePrice"]');
                const priceTypeEl = document.querySelector('select[name="priceType"]');
                
                console.log('🔍 Elements found:', {
                    nameEl: nameEl ? 'FOUND' : 'NOT FOUND',
                    requestEl: requestEl ? 'FOUND' : 'NOT FOUND', 
                    areaEl: areaEl ? 'FOUND' : 'NOT FOUND',
                    phoneEl: phoneEl ? 'FOUND' : 'NOT FOUND',
                    priceEl: priceEl ? 'FOUND' : 'NOT FOUND',
                    priceTypeEl: priceTypeEl ? 'FOUND' : 'NOT FOUND'
                });
                
                // If elements not found, try alternative selectors
                if (!nameEl) {
                    console.log('❌ messageName not found, trying alternatives...');
                    const alternatives = document.querySelectorAll('input[type="text"]');
                    console.log('Available text inputs:', Array.from(alternatives).map(el => el.name || el.id || el.placeholder));
                }
                
                console.log('🔍 Form elements check:', {
                    nameEl: !!nameEl,
                    requestEl: !!requestEl,
                    areaEl: !!areaEl,
                    phoneEl: !!phoneEl,
                    priceEl: !!priceEl,
                    priceTypeEl: !!priceTypeEl
                });
                
                data.messageName = nameEl?.value || '';
                data.messageRequest = requestEl?.value || '';
                data.messageArea = areaEl?.value || '';
                data.messagePhone = phoneEl?.value || '';
                data.messagePrice = priceEl?.value || '0';
                data.messagePriceType = priceTypeEl?.value || 'כללי';
                
                console.log('🍾 Raw form values:', {
                    messageName: nameEl?.value,
                    messageRequest: requestEl?.value,
                    messageArea: areaEl?.value,
                    messagePhone: phoneEl?.value,
                    messagePrice: priceEl?.value,
                    messagePriceType: priceTypeEl?.value
                });
                
                console.log('🍾 Collected messageInBottle data:', {
                    messageName: data.messageName,
                    messageRequest: data.messageRequest,
                    messageArea: data.messageArea,
                    messagePhone: data.messagePhone,
                    messagePrice: data.messagePrice,
                    messagePriceType: data.messagePriceType
                });
                
                // 🚨 DEBUG: Print actual values
                console.log('🚨 DEBUG VALUES:');
                console.log('messageName actual value:', data.messageName);
                console.log('messageRequest actual value:', data.messageRequest);
                console.log('messageArea actual value:', data.messageArea);
                console.log('messagePhone actual value:', data.messagePhone);
                console.log('messagePrice actual value:', data.messagePrice);
                console.log('messagePriceType actual value:', data.messagePriceType);
                
                // Disable features for messageInBottle
                data.addAccessibility = false;
                data.addAiBot = false;
                data.addWhatsApp = false;
            }

            state.originalDescription = data.description;

            // Collect courses data if this is a digital course page
            if (data.pageType === 'onlineCourse') {
                console.log('🎓 Collecting courses data for onlineCourse page...');
                const courseNames = document.getElementsByName('courseName[]');
                const courseVideos = document.getElementsByName('courseVideo[]');
                const coursePrices = document.getElementsByName('coursePrice[]');
                const courseDescriptions = document.getElementsByName('courseDescription[]');
                
                console.log('📊 Found fields:', {
                    courseNames: courseNames.length,
                    courseVideos: courseVideos.length,
                    coursePrices: coursePrices.length,
                    courseDescriptions: courseDescriptions.length
                });
                
                data.courses = [];
                for (let i = 0; i < courseNames.length; i++) {
                    if (courseNames[i].value.trim()) {
                        const course = {
                            name: courseNames[i].value.trim(),
                            video: courseVideos[i].value.trim(),
                            price: coursePrices[i].value || '0',
                            description: courseDescriptions[i].value.trim() || 'קורס מקצועי ומקיף'
                        };
                        console.log(`📚 Course ${i + 1}:`, course);
                        data.courses.push(course);
                    }
                }
                
                console.log('✅ Total courses collected:', data.courses.length);
                console.log('📦 Courses array:', data.courses);
            }
            
            // הוסף נתוני שפה ומדינה
            data = addLanguageToPageData(data);
            
            // Collect property gallery data for real estate
            if (data.pageType === 'realEstate') {
                const properties = [];
                const propertyItems = document.querySelectorAll('.property-item');
                
                // תמונות דוגמה מקצועיות לנכסים
                const sampleImages = [
                    'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=800',
                    'https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=800',
                    'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800',
                    'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=800',
                    'https://images.unsplash.com/photo-1600566753086-00f18fb6b3ea?w=800'
                ];
                
                propertyItems.forEach((item, index) => {
                    const title = item.querySelector('input[name="propertyTitle[]"]')?.value || '';
                    const address = item.querySelector('input[name="propertyAddress[]"]')?.value || '';
                    const beds = item.querySelector('input[name="propertyBeds[]"]')?.value || '0';
                    const baths = item.querySelector('input[name="propertyBaths[]"]')?.value || '0';
                    const sqft = item.querySelector('input[name="propertySqft[]"]')?.value || '0';
                    const price = item.querySelector('input[name="propertyPrice[]"]')?.value || '0';
                    const description = item.querySelector('textarea[name="propertyDescription[]"]')?.value || '';
                    
                    // השתמש בתמונות דוגמה (5 תמונות לכל נכס)
                    const images = sampleImages.slice(0, 5);
                    
                    if (title || address) {
                        properties.push({
                            title,
                            address,
                            beds,
                            baths,
                            sqft,
                            price,
                            description,
                            images
                        });
                    }
                });
                
                data.properties = properties;
                console.log('Collected properties data with sample images:', properties);
            }

            const masterPrompt = createMasterPrompt(data);

            

            // setLoading already does switchView, so don't do it twice
            // switchView(ui.formView, ui.previewView);



            try {
                let htmlContent;
                let usedTemplateSystem = false; // Flag to prevent duplicate script injection for template-based pages
                
                // Force local generation for messageInBottle to ensure data is included
                if (state.selectedPageType === 'messageInBottle') {
                    console.log('🍾 Forcing local generation for messageInBottle');
                    console.log('🍾 Data being sent:', data);
                    
                // 🚨 DEBUG FIRST
                console.log('🚨 CRITICAL DEBUG - Data values:');
                console.log('  messageName:', data.messageName, '| typeof:', typeof data.messageName);
                console.log('  messageRequest:', data.messageRequest, '| typeof:', typeof data.messageRequest);
                console.log('  messageArea:', data.messageArea, '| typeof:', typeof data.messageArea);
                console.log('  messagePhone:', data.messagePhone, '| typeof:', typeof data.messagePhone);
                console.log('  messagePrice:', data.messagePrice, '| typeof:', typeof data.messagePrice);
                console.log('  messagePriceType:', data.messagePriceType, '| typeof:', typeof data.messagePriceType);
                
                // Force use actual values - NO defaults!
                const enhancedPrompt = `${masterPrompt}

**ACTUAL USER DATA FOR MESSAGE IN BOTTLE:**
messageName: ${data.messageName || ''}
messageRequest: ${data.messageRequest || ''}  
messageArea: ${data.messageArea || ''}
messagePhone: ${data.messagePhone || ''}
messagePrice: ${data.messagePrice || ''}
messagePriceType: ${data.messagePriceType || ''}

**JSON DATA:**
${JSON.stringify({
    messageName: data.messageName || '',
    messageRequest: data.messageRequest || '',
    messageArea: data.messageArea || '',
    messagePhone: data.messagePhone || '',
    messagePrice: data.messagePrice || '',
    messagePriceType: data.messagePriceType || ''
})}`;

                console.log('🚨 CRITICAL DEBUG - Enhanced prompt:');
                console.log(enhancedPrompt);
                    
                    const localResponse = await fetch('/api/generate-html', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            prompt: enhancedPrompt,
                            pageType: 'messageInBottle'
                        })
                    });
                    
                    if (localResponse.ok) {
                        const localData = await localResponse.json();
                        htmlContent = localData.html;
                        console.log('✅ Local generation successful for messageInBottle');
                    } else {
                        throw new Error('Local generation failed');
                    }
                } else {
                    // For serviceProvider and onlineStore, use template-based generation
                    if (state.selectedPageType === 'serviceProvider' || state.selectedPageType === 'appointment' || state.selectedPageType === 'onlineStore' || state.selectedPageType === 'store') {
                        console.log('🎯 Using template-based generation for', state.selectedPageType);
                        usedTemplateSystem = true; // Mark that we used template system - prevents old store scripts injection
                        
                        // Collect optional sections - ONLY checked ones
                        const optionalSections = [];
                        document.querySelectorAll('input[name="optionalSections"]:checked').forEach(checkbox => {
                            optionalSections.push(checkbox.value);
                        });
                        console.log('📋 Optional sections collected from form:', optionalSections);
                        
                        try {
                            const response = await fetch('/api/create-page-with-template', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    userId: data.userId || 'temp_user',
                                    pageType: state.selectedPageType,
                                    formData: data,
                                    optionalSections: optionalSections
                                })
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                console.log('✅ Template-based generation result:', result);
                                
                                // Fetch the actual HTML from the pageUrl
                                const pageResponse = await fetch(result.pageUrl);
                                if (pageResponse.ok) {
                                    htmlContent = await pageResponse.text();
                                    console.log('✅ Loaded HTML from template system');
                                    // Note: Store template already has its own cart/checkout JS built-in
                                    // No need to inject additional scripts
                                } else {
                                    throw new Error('Failed to load generated page');
                                }
                            } else {
                                throw new Error('Template generation failed');
                            }
                        } catch (error) {
                            console.error('❌ Template generation error:', error);
                            throw new Error(`יצירת דף נכשלה: ${error.message}. אנא בדוק את הפרטים בטופס ונסה שוב.`);
                        }
                    } else {
                        // For other page types (onlineStore, etc.), use local generation
                        console.log('🎯 Using local generation for page type:', state.selectedPageType);
                        const localResponse = await fetch('/api/generate-html', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                prompt: masterPrompt,
                                pageType: state.selectedPageType
                            })
                        });
                        
                        if (localResponse.ok) {
                            const localData = await localResponse.json();
                            htmlContent = localData.html;
                            console.log('✅ Local generation successful');
                        } else {
                            throw new Error('יצירת דף נכשלה. אנא נסה שוב.');
                        }
                    }
                }

                    // הוסף קישורים לתחתית הדף (לא למסר בבקבוק, נותן שירותים או חנות - כי כבר יש להם פוטר)
                    const skipFooterTypes = ['messageInBottle', 'serviceProvider', 'onlineStore', 'store'];
                    let finalHtml = skipFooterTypes.includes(state.selectedPageType) ? htmlContent : addFooterLinks(htmlContent, data);
                    
                    // וודא הזרקת meta של סוג הדף לפני כל זיהוי
                    if (!finalHtml.includes('<meta name="page-type"')) {
                        try {
                            finalHtml = finalHtml.replace('<head>', `<head>\n<meta name="page-type" content="${state.selectedPageType}">`);
                        } catch (e) { console.warn('Could not inject page-type meta:', e); }
                    }
                    
                    // 🔥 CRITICAL: Inject CSS to force vertical layout BEFORE iframe loads
                    if (state.selectedPageType === 'serviceProvider' || state.selectedPageType === 'appointment') {
                        const verticalLayoutCSS = `
<style>
/* 🔥 ULTIMATE FIX: Force vertical layout - highest priority */
html, body {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow-x: hidden !important;
}

body > * {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    float: none !important;
    clear: both !important;
}

section, section.hero, section.section, section.about-section, section.services-section,
section#hero, section#about, section#services, section#gallery, section#testimonials,
section#faq, section#team, section#calendar, section#contact, section#pricing, section#youtube {
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    float: none !important;
    clear: both !important;
    margin: 0 !important;
    padding: 80px 24px !important;
    box-sizing: border-box !important;
    position: relative !important;
}
</style>`;
                        // Inject at the end of <head>
                        if (finalHtml.includes('</head>')) {
                            finalHtml = finalHtml.replace('</head>', verticalLayoutCSS + '\n</head>');
                        } else if (finalHtml.includes('<body')) {
                            finalHtml = finalHtml.replace('<body', verticalLayoutCSS + '\n<body');
                        }
                        console.log('✅ Injected vertical layout CSS');
                    }
                    
                    // הוסף פונקציונליות חנות רק אם התבנית היא חנות ולא השתמשנו בתבנית החדשה
                    console.log('Checking if need to inject store scripts. selectedPageType:', state.selectedPageType, 'usedTemplateSystem:', usedTemplateSystem);
                    const isStoreTemplate = state.selectedPageType === 'onlineStore' || state.selectedPageType === 'onlineCourse' || state.selectedPageType === 'restaurantMenu';
                    
                    // 🔥 CRITICAL: Skip old store script injection if we used template-based generation
                    // Template already has cart/checkout built-in
                    if (isStoreTemplate && !usedTemplateSystem) {
                        console.log('✅ Injecting store/course scripts for preview (AI-generated page)...');
                        if (typeof window.injectStoreScripts === 'function') {
                            finalHtml = window.injectStoreScripts(finalHtml, data);
                            console.log('✅ Store/Course scripts injected to preview!');
                        } else {
                            console.error('❌ window.injectStoreScripts is not defined!');
                        }
                    } else if (usedTemplateSystem) {
                        console.log('⏭️ Skipping old store scripts - template already has cart/checkout built-in');
                    } else {
                        console.log('❌ NOT a store/course, skipping store scripts');
                    }
                
                
                    ui.previewIframe.srcdoc = finalHtml;
                
                // Store in window for saving (CRITICAL for page saving!)
                // 🔥 Store in BOTH parent window AND iframe for reliable access
                window.generatedPageHTML_backup = finalHtml; // Parent window backup
                try {
                    ui.previewIframe.contentWindow.generatedPageHTML = finalHtml;
                } catch(e) {
                    console.log('⚠️ Could not store in iframe window, using parent backup');
                }

                // Hide preview initially, show animation
                ui.previewContainer.classList.add('hidden');

                ui.previewIframe.onload = () => {
                    
                    // Ensure generatedPageHTML is set AGAIN after iframe loads
                    // 🔥 Store in BOTH parent window AND iframe for reliable access
                    window.generatedPageHTML_backup = finalHtml; // Keep parent backup updated
                    try {
                        ui.previewIframe.contentWindow.generatedPageHTML = finalHtml;
                    } catch(e) {
                        console.log('⚠️ Could not store in iframe window');
                    }
                    console.log('✅ generatedPageHTML stored (backup + iframe attempt)');

                    // FORCE VERTICAL LAYOUT - Fix sections directly in DOM (AGGRESSIVE)
                    function forceVerticalLayout() {
                        try {
                            const iframeDoc = ui.previewIframe.contentDocument || ui.previewIframe.contentWindow.document;
                            if (!iframeDoc) return;
                            
                            // Force html
                            const html = iframeDoc.documentElement;
                            html.style.setProperty('display', 'block', 'important');
                            html.style.setProperty('width', '100%', 'important');
                            html.style.setProperty('max-width', '100%', 'important');
                            
                            // Force body to be block container
                            const body = iframeDoc.body;
                            body.style.setProperty('display', 'block', 'important');
                            body.style.setProperty('width', '100%', 'important');
                            body.style.setProperty('max-width', '100%', 'important');
                            body.style.setProperty('margin', '0', 'important');
                            body.style.setProperty('padding', '0', 'important');
                            body.style.setProperty('flex-direction', 'column', 'important');
                            body.style.setProperty('flex-wrap', 'nowrap', 'important');
                            
                            // Force structural elements to be block - but SKIP hidden elements and floating buttons
                            const skipIds = ['accessibility-menu', 'admin-mode-btn', 'ai-chat-window', 'ai-bot-bubble', 'whatsapp-bubble'];
                            const skipTags = ['SCRIPT', 'STYLE', 'LINK', 'META', 'NOSCRIPT', 'A'];
                            const structuralTags = ['SECTION', 'HEADER', 'FOOTER', 'MAIN', 'NAV', 'ARTICLE'];
                            
                            Array.from(body.children).forEach(child => {
                                // Skip elements that should stay hidden
                                if (skipIds.includes(child.id) || skipTags.includes(child.tagName)) {
                                    return;
                                }
                                // Only apply to structural elements
                                if (structuralTags.includes(child.tagName)) {
                                    child.style.setProperty('display', 'block', 'important');
                                    child.style.setProperty('width', '100%', 'important');
                                    child.style.setProperty('max-width', '100%', 'important');
                                    child.style.setProperty('float', 'none', 'important');
                                    child.style.setProperty('clear', 'both', 'important');
                                }
                            });
                            
                            // CRITICAL: Explicitly hide script tags and accessibility menu
                            const scripts = iframeDoc.querySelectorAll('script');
                            scripts.forEach(script => {
                                script.style.setProperty('display', 'none', 'important');
                                script.style.setProperty('visibility', 'hidden', 'important');
                            });
                            
                            const accessMenu = iframeDoc.getElementById('accessibility-menu');
                            if (accessMenu) {
                                accessMenu.style.setProperty('display', 'none', 'important');
                                accessMenu.style.setProperty('visibility', 'hidden', 'important');
                            }
                            
                            const adminBtn = iframeDoc.getElementById('admin-mode-btn');
                            if (adminBtn) {
                                adminBtn.style.setProperty('display', 'none', 'important');
                            }
                            
                            // Force ALL sections to be block-level
                            const sections = iframeDoc.querySelectorAll('section');
                            sections.forEach(section => {
                                // Check and fix parent container
                                let current = section.parentElement;
                                while (current && current !== body && current !== html) {
                                    const computed = getComputedStyle(current);
                                    if (computed.display === 'flex' || computed.display === 'grid') {
                                        current.style.setProperty('display', 'block', 'important');
                                        current.style.setProperty('flex-direction', 'column', 'important');
                                        current.style.setProperty('grid-template-columns', 'none', 'important');
                                    }
                                    current.style.setProperty('width', '100%', 'important');
                                    current.style.setProperty('max-width', '100%', 'important');
                                    current.style.setProperty('float', 'none', 'important');
                                    current.style.setProperty('clear', 'both', 'important');
                                    current = current.parentElement;
                                }
                                
                                section.style.setProperty('display', 'block', 'important');
                                section.style.setProperty('width', '100%', 'important');
                                section.style.setProperty('max-width', '100%', 'important');
                                section.style.setProperty('float', 'none', 'important');
                                section.style.setProperty('clear', 'both', 'important');
                                section.style.setProperty('margin', '0', 'important');
                                section.style.setProperty('padding', section.style.padding || '80px 24px', 'important');
                                section.style.setProperty('box-sizing', 'border-box', 'important');
                                section.style.setProperty('position', 'relative', 'important');
                                section.style.setProperty('left', '0', 'important');
                                section.style.setProperty('right', '0', 'important');
                                section.style.setProperty('flex-direction', 'column', 'important');
                                section.style.setProperty('flex-wrap', 'nowrap', 'important');
                                
                                // Force ALL children of section to be block too
                                Array.from(section.children).forEach(child => {
                                    if (!['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'div'].includes(child.tagName.toLowerCase())) {
                                        child.style.setProperty('display', 'block', 'important');
                                        child.style.setProperty('width', '100%', 'important');
                                        child.style.setProperty('max-width', '100%', 'important');
                                    }
                                });
                            });
                            
                            // Also check for any divs that might be acting as wrappers
                            const allDivs = iframeDoc.querySelectorAll('body > div, body > div > div');
                            allDivs.forEach(div => {
                                const computed = getComputedStyle(div);
                                if (computed.display === 'flex' || computed.display === 'grid') {
                                    const hasSections = div.querySelector('section');
                                    if (hasSections) {
                                        div.style.setProperty('display', 'block', 'important');
                                        div.style.setProperty('width', '100%', 'important');
                                        div.style.setProperty('max-width', '100%', 'important');
                                    }
                                }
                            });
                            
                            console.log(`✅ Fixed ${sections.length} sections to be vertical`);
                        } catch (e) {
                            console.error('❌ Error fixing vertical layout:', e);
                        }
                    }
                    
                    // Run immediately
                    forceVerticalLayout();
                    
                    // Run again after delays to catch late-loading styles
                    setTimeout(forceVerticalLayout, 100);
                    setTimeout(forceVerticalLayout, 500);
                    setTimeout(forceVerticalLayout, 1000);

                    // Wait a bit for iframe to fully render
                    setTimeout(() => {
                        // Hide animation and show preview
                        setLoading(false);
                        ui.previewContainer.classList.remove('hidden');
                        ui.toolsFab.classList.remove('hidden');
                        ui.toolsFab.classList.remove('active');
                    ui.toolsMenu.classList.remove('open');
                    }, 500); // Small delay to ensure smooth transition

                };

            } catch (error) {

                console.error('Error generating page:', error);
                setLoading(false);
                ui.generationView.innerHTML = `<div class="text-center p-8"><h2 class="text-2xl font-semibold text-red-500">${getTranslation('gen_error_title')}</h2><p class="text-slate-600 mt-2">${getTranslation('gen_error_details')}</p><pre class="mt-2 text-left text-xs bg-slate-100 p-2 rounded text-slate-500 whitespace-pre-wrap">${error.message}</pre></div>`;

            }

        }
            function addFooterLinks(htmlContent, formData = null) {
                // קבל פרטי יצירת קשר מהטופס או מהפרמטרים
                let contactEmail, contactPhone, businessName, websiteUrl;
                let facebookLink, instagramLink, linkedinLink, twitterLink, tiktokLink, youtubeLink;
                
                if (formData) {
                    contactEmail = formData.email || 'info@example.com';
                    contactPhone = formData.phone || '03-1234567';
                    businessName = formData.mainName || 'החברה שלנו';
                    websiteUrl = formData.websiteUrl || window.location.origin;
                    facebookLink = formData.facebookLink || '';
                    instagramLink = formData.instagramLink || '';
                    linkedinLink = formData.linkedinLink || '';
                    twitterLink = formData.twitterLink || '';
                    tiktokLink = formData.tiktokLink || '';
                    youtubeLink = formData.youtubeLink || '';
                } else {
                    contactEmail = document.getElementById('email')?.value || 'info@example.com';
                    contactPhone = document.getElementById('phone')?.value || '03-1234567';
                    businessName = document.getElementById('mainName')?.value || 'החברה שלנו';
                    websiteUrl = document.getElementById('websiteUrl')?.value || window.location.origin;
                    facebookLink = document.getElementById('facebookLink')?.value || '';
                    instagramLink = document.getElementById('instagramLink')?.value || '';
                    linkedinLink = document.getElementById('linkedinLink')?.value || '';
                    twitterLink = document.getElementById('twitterLink')?.value || '';
                    tiktokLink = document.getElementById('tiktokLink')?.value || '';
                    youtubeLink = document.getElementById('youtubeLink')?.value || '';
                }
                
                // בניית קישורי רשתות חברתיות - רק אם יש קישורים
                let socialIconsHtml = '';
                const socialLinks = [];
                if (facebookLink) socialLinks.push(`<a href="${facebookLink}" target="_blank" rel="noopener noreferrer" style="color: #1877F2; font-size: 28px; margin: 0 12px; transition: transform 0.3s; display: inline-block; text-decoration: none;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" title="Facebook"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"/></svg></a>`);
                if (instagramLink) socialLinks.push(`<a href="${instagramLink}" target="_blank" rel="noopener noreferrer" style="background: linear-gradient(45deg, #F58529, #DD2A7B, #8134AF, #515BD4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 28px; margin: 0 12px; transition: transform 0.3s; display: inline-block; text-decoration: none;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" title="Instagram"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></a>`);
                if (linkedinLink) socialLinks.push(`<a href="${linkedinLink}" target="_blank" rel="noopener noreferrer" style="color: #0077B5; font-size: 28px; margin: 0 12px; transition: transform 0.3s; display: inline-block; text-decoration: none;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" title="LinkedIn"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>`);
                if (twitterLink) socialLinks.push(`<a href="${twitterLink}" target="_blank" rel="noopener noreferrer" style="color: #1DA1F2; font-size: 28px; margin: 0 12px; transition: transform 0.3s; display: inline-block; text-decoration: none;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" title="X (Twitter)"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>`);
                if (tiktokLink) socialLinks.push(`<a href="${tiktokLink}" target="_blank" rel="noopener noreferrer" style="color: #000000; font-size: 28px; margin: 0 12px; transition: transform 0.3s; display: inline-block; text-decoration: none;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" title="TikTok"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-2.43.05-4.84-.94-6.37-2.96-2.2-2.95-2.2-6.82 0-9.78 1.59-2.1 4.3-3.04 6.66-2.49.12.03.24.05.35.08v4.03c-1.11-.35-2.29-.5-3.43-.5-1.72 0-3.34.7-4.52 1.95-1.24 1.3-1.86 3.02-1.86 4.73 0 3.49 2.72 6.36 6.08 6.36 3.35 0 6.08-2.87 6.08-6.36 0-1.52-.57-2.93-1.56-4.02-.98-1.09-2.38-1.68-3.8-1.68-.24 0-.48.01-.7.03v-4.03z"/></svg></a>`);
                if (youtubeLink) socialLinks.push(`<a href="${youtubeLink}" target="_blank" rel="noopener noreferrer" style="color: #FF0000; font-size: 28px; margin: 0 12px; transition: transform 0.3s; display: inline-block; text-decoration: none;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" title="YouTube"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>`);
                
                if (socialLinks.length > 0) {
                    socialIconsHtml = `<div style="text-align: center; margin: 30px 0 20px 0; padding: 20px 0; border-bottom: 1px solid #e2e8f0;">${socialLinks.join('')}</div>`;
                }
                
                // הוסף קישורים לתחתית הדף עם פרטי יצירת קשר מותאמים
                const footerHtml = `
                    <footer style="background-color: #f8fafc; border-top: 1px solid #e2e8f0; padding: 20px 0; margin-top: 40px; text-align: center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                        <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
                            ${socialIconsHtml}
                            <div style="margin-bottom: 15px; margin-top: ${socialIconsHtml ? '10px' : '20px'};">
                                <a href="/privacy-policy.html?business=${encodeURIComponent(businessName)}&email=${encodeURIComponent(contactEmail)}&phone=${encodeURIComponent(contactPhone)}" style="color: #64748b; text-decoration: none; margin: 0 15px; font-size: 14px; transition: color 0.3s ease;" onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='#64748b'">מדיניות פרטיות</a>
                                <span style="color: #cbd5e1;">|</span>
                                <a href="/accessibility-statement.html?business=${encodeURIComponent(businessName)}&email=${encodeURIComponent(contactEmail)}&phone=${encodeURIComponent(contactPhone)}" style="color: #64748b; text-decoration: none; margin: 0 15px; font-size: 14px; transition: color 0.3s ease;" onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='#64748b'">הצהרת נגישות</a>
                                <span style="color: #cbd5e1;">|</span>
                                <a href="/terms-of-service.html?business=${encodeURIComponent(businessName)}&email=${encodeURIComponent(contactEmail)}&phone=${encodeURIComponent(contactPhone)}&website=${encodeURIComponent(websiteUrl)}" style="color: #64748b; text-decoration: none; margin: 0 15px; font-size: 14px; transition: color 0.3s ease;" onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='#64748b'">תנאי שירות</a>
                            </div>
                            <div style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                                יצירת קשר: <a href="mailto:${contactEmail}" style="color: #64748b; text-decoration: none;">${contactEmail}</a> | ${contactPhone}
                            </div>
                        </div>
                    </footer>
                `;

                // בדוק אם יש תגית </body> או </html>
                if (htmlContent.includes('</body>')) {
                    return htmlContent.replace('</body>', footerHtml + '</body>');
                } else if (htmlContent.includes('</html>')) {
                    return htmlContent.replace('</html>', footerHtml + '</html>');
                } else {
                    // אם אין תגיות סגירה, פשוט הוסף את התחתית בסוף
                    return htmlContent + footerHtml;
                }
            }

        async function generateHtmlFromApi(prompt) {
             // ❌ NO N8N - Use local generation only
             console.log('⚡ Using LOCAL generation (NO N8N)');
             
             try {
                    // Use local generation only
                    const localHtmlResponse = await fetch('/api/generate-html', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ masterPrompt: prompt })
                    });
                    
                    if (localHtmlResponse.ok) {
                        const localData = await localHtmlResponse.json();
                        if (localData.html) {
                            console.log('✅ Created HTML locally successfully');
                            return localData.html;
                        }
                    }
                    
                    throw new Error('Local generation failed');
                } catch (error) {
                    console.error('❌ Local generation error:', error);
                    
                    // Show error message
                     ui.generationView.innerHTML = `
                         <div class="max-w-2xl mx-auto text-center">
                             <div class="mb-8">
                                 <h2 class="text-3xl font-bold text-red-400 mb-4">⚠️ בעיה טכנית</h2>
                                <p class="text-gray-300 text-lg">יצירת הדף נכשלה, אנא נסה שוב</p>
                             </div>
                             <div class="bg-red-500/20 backdrop-blur-sm rounded-xl p-6">
                                <p class="text-red-300 font-medium">שגיאה: ${error.message}</p>
                             </div>
                             <div class="mt-6">
                                 <button onclick="window.location.reload()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                     נסה שוב
                                 </button>
                             </div>
                         </div>
                     `;
                     
                    throw error;
                }

        }



        function handleFabClick() {

            const isOpening = !ui.toolsMenu.classList.contains('open');

            ui.toolsFab.classList.toggle('active', isOpening);

            ui.toolsMenu.classList.toggle('open', isOpening);

            

            toggleEditMode(isOpening);

        }



        function toggleEditMode(forceState) {

            const newState = (typeof forceState === 'boolean') ? forceState : !state.isEditing;

            if (newState === state.isEditing) return;



            state.isEditing = newState;

            const iframeDoc = ui.previewIframe.contentWindow.document;

            if (!iframeDoc) {

                showModal("modal_error_edit_mode");

                return;

            }



            if (state.isEditing) {

                iframeDoc.body.contentEditable = true;

                iframeDoc.designMode = 'off';

                ui.previewIframe.classList.add('editable');

                ui.toolsFab.innerHTML = '<i data-lucide="check-circle" class="w-6 h-6"></i>';

                iframeDoc.body.addEventListener('click', handleIframeElementClick, true);

            } else {

                iframeDoc.body.contentEditable = false;

                ui.previewIframe.classList.remove('editable');

                ui.toolsFab.innerHTML = '<i data-lucide="pencil" class="w-6 h-6"></i>';

                iframeDoc.body.removeEventListener('click', handleIframeElementClick, true);

                if (state.currentElementToEdit) {

                    state.currentElementToEdit.style.outline = '';

                    state.currentElementToEdit = null;

                }
                
                // איפוס מצב תמונה והסתר כפתור מחיקה
                state.elementToModifyForImage = null;
                state.imageModificationType = null;
                ui.deleteImageBtn.style.display = 'none';

                 ui.opacityControl.classList.add('hidden');

            }

            lucide.createIcons(); 

        }



        function handleIframeElementClick(event) {

            if (!state.isEditing) return;

            event.preventDefault();

            event.stopPropagation();

            const target = event.target;



            ui.opacityControl.classList.add('hidden');

            state.currentOverlayToEdit = null;

            

            state.elementToModifyForImage = null;

            state.imageModificationType = null;



            const backgroundHolder = findBackgroundHolder(target);

            

            if (target.tagName === 'IMG') {

                state.elementToModifyForImage = target;

                state.imageModificationType = 'src';
                
                // הצג כפתור מחיקה
                ui.deleteImageBtn.style.display = 'block';

            } else if (backgroundHolder) {

                state.elementToModifyForImage = backgroundHolder;

                state.imageModificationType = 'background';

                state.currentOverlayToEdit = backgroundHolder.querySelector('.bg-overlay');

                if (state.currentOverlayToEdit) {

                    ui.opacityControl.classList.remove('hidden');

                    const rgbaColor = window.getComputedStyle(state.currentOverlayToEdit).backgroundColor;

                    const match = /rgba?\((\d+), (\d+), (\d+)(, ([\d.]+))?\)/.exec(rgbaColor);

                    ui.opacitySlider.value = match && match[5] ? match[5] : 0.5;

                }
                
                // הצג כפתור מחיקה
                ui.deleteImageBtn.style.display = 'block';

            }



            if (state.currentElementToEdit) state.currentElementToEdit.style.outline = '';

            state.currentElementToEdit = target;

            state.currentElementToEdit.style.outline = '2px dashed #8b5cf6';

        }



        function handleUploadBtnClick() {

            if (state.elementToModifyForImage) {

                ui.iframeImageUploader.click();

            } else {

                showModal("modal_error_upload_image");

            }

        }

        

        async function handleImageUpload(event) {

             const file = event.target.files[0];

             if (!file || !state.elementToModifyForImage) return;



             showModal(getTranslation('modal_processing_image'));



             try {

                 const resizedFile = await resizeAndCompressImage(file);

                 

                 // Get user ID (from Supabase or localStorage)
                 let userId = localStorage.getItem('userId') || 'user_' + Date.now();
                 
                 try {
                     const { data: { user } } = await sb.auth.getUser();
                     if (user) {
                         userId = user.id;
                     }
                 } catch (supabaseError) {
                     console.log('Supabase not available, using local userId');
                 }



                 let imageUrl = null;

                 // העלה תמונה לתיקיית output המקומית
                 try {
                     const formData = new FormData();
                     formData.append('image', resizedFile);
                     formData.append('userId', userId);
                     formData.append('pageName', state.currentPageData?.title || 'general');

                     const response = await fetch('/api/upload-image', {
                         method: 'POST',
                         body: formData
                     });

                     if (response.ok) {
                         const result = await response.json();
                         if (result.success) {
                             imageUrl = result.imageUrl;
                             console.log('תמונה נשמרה מקומית:', imageUrl);
                         }
                     }
                 } catch (localError) {
                     console.error('Local upload failed:', localError);
                 }

                 // אם גם זה נכשל, השתמש ב-data URL
                 if (!imageUrl) {
                     const reader = new FileReader();
                     imageUrl = await new Promise((resolve) => {
                         reader.onload = () => resolve(reader.result);
                         reader.readAsDataURL(resizedFile);
                     });
                     console.log('תמונה נשמרה כ-data URL');
                 }

                 if (!imageUrl) {
                     throw new Error('לא ניתן להעלות את התמונה');
                 }

                 // עדכן את התמונה
                 if (state.imageModificationType === 'src') {

                      state.elementToModifyForImage.src = imageUrl;
                 } else if (state.imageModificationType === 'background') {

                      state.elementToModifyForImage.style.backgroundImage = `url('${imageUrl}')`;
                 }

                // עדכן את ה-generatedPageHTML עם התמונה החדשה
                const iframeDoc = ui.previewIframe.contentDocument;
                if (iframeDoc) {
                    window.generatedPageHTML = iframeDoc.documentElement.outerHTML;
                    console.log('✅ Updated generatedPageHTML with new image');
                }

                 hideModal();

                 showModal(getTranslation('modal_image_success'));



             } catch (error) {

                 console.error('Error uploading image:', error);

                 hideModal();

                 showModal(`${getTranslation('modal_image_error')}: ${error.message}`);

             } finally {

                 state.elementToModifyForImage = null;

                 event.target.value = '';

             }

        }


        // מחיקת תמונה
        function handleDeleteImage() {
            if (!state.elementToModifyForImage) {
                showModal("נא לבחור תמונה למחיקה");
                return;
            }

            if (!confirm('האם אתה בטוח שברצונך למחוק את התמונה?')) {
                return;
            }

            try {
                // מחק תמונה לפי סוג
                if (state.imageModificationType === 'src' && state.elementToModifyForImage.tagName === 'IMG') {
                    // מחק src ושם placeholder
                    state.elementToModifyForImage.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23ddd" width="400" height="300"/%3E%3Ctext fill="%23999" font-size="24" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle"%3ENo Image%3C/text%3E%3C/svg%3E';
                    state.elementToModifyForImage.alt = '';
                } else if (state.imageModificationType === 'background') {
                    // מחק background image
                    state.elementToModifyForImage.style.backgroundImage = 'none';
                    state.elementToModifyForImage.style.backgroundColor = '#f3f4f6'; // צבע רקע ניטרלי
                }

                showModal("✅ התמונה נמחקה בהצלחה");
                setTimeout(hideModal, 1500);

            } catch (error) {
                console.error('Error deleting image:', error);
                showModal("❌ שגיאה במחיקת התמונה: " + error.message);
            }
        }
        function resizeAndCompressImage(file, maxWidth = 1920, quality = 0.85) {

            return new Promise((resolve, reject) => {

                const reader = new FileReader();

                reader.readAsDataURL(file);

                reader.onload = event => {

                    const img = new Image();

                    img.src = event.target.result;

                    img.onload = () => {

                        const canvas = document.createElement('canvas');

                        const ctx = canvas.getContext('2d');

                        

                        let width = img.width;

                        let height = img.height;



                        if (width > maxWidth) {

                            height *= maxWidth / width;

                            width = maxWidth;

                        }



                        canvas.width = width;

                        canvas.height = height;

                        ctx.drawImage(img, 0, 0, width, height);

                        

                        canvas.toBlob(blob => {

                            if (!blob) {

                                reject(new Error('Canvas to Blob conversion failed.'));

                                return;

                            }

                            const newFile = new File([blob], file.name, {

                                type: blob.type,

                                lastModified: Date.now()

                            });

                            resolve(newFile);

                        }, file.type, quality);

                    };

                    img.onerror = error => reject(error);

                };

                reader.onerror = error => reject(error);

            });

        }
        async function handleSavePage() {

            showModal(getTranslation('modal_saving'));

            // Try to get Supabase user, fallback to temp_user if not available
            let user = null;
            try {
                const { data } = await sb.auth.getUser();
                user = data?.user;
            } catch (e) {
                console.log('⚠️ Supabase not available, using temp_user');
            }
            
            // If no user, create a temp user object for local saving
            if (!user) {
                console.log('📁 No Supabase user, saving locally with temp_user');
                user = { id: 'temp_user' };
            }



            if(state.isEditing) toggleEditMode(false);

            // Wait for iframe to fully reload - CRITICAL FOR SAVING ALL CONTENT
            console.log('⏳ Waiting for iframe to fully reload...');
            await new Promise(r => setTimeout(r, 3500)); // Increased to 3500ms for stability
            
            // Wait for iframe document to be in ready state
            const iframeDoc = ui.previewIframe.contentWindow.document;
            if (iframeDoc.readyState !== 'complete') {
                console.log('⏳ Waiting for iframe to complete loading...');
                await new Promise(resolve => {
                    const handler = () => {
                        console.log('✅ DOM loaded');
                        resolve();
                    };
                    if (iframeDoc.readyState === 'loading') {
                        iframeDoc.addEventListener('DOMContentLoaded', handler, { once: true });
                    }
                    setTimeout(resolve, 1500); // Longer fallback timeout
                });
            }
            
            // Extra wait to ensure all scripts and async content have loaded
            console.log('⏳ Additional wait for async content...');
            await new Promise(r => setTimeout(r, 1000));
            console.log('✅ Iframe fully loaded, cloning document...');

            let finalHtml;
            
            // 🔥 CRITICAL FIX: For template-based pages, use the ORIGINAL HTML, not the modified DOM
            // This prevents dynamically added elements (like old cart) from being saved
            const isTemplateBasedPage = state.selectedPageType === 'serviceProvider' || 
                                        state.selectedPageType === 'appointment' || 
                                        state.selectedPageType === 'onlineStore' || 
                                        state.selectedPageType === 'store';
            
            // Also check if the page has template markers (in case state is wrong)
            const hasTemplateMarkers = iframeDoc.querySelector('meta[name="skip-store-injection"]') ||
                                       iframeDoc.querySelector('.cart-float-btn') ||
                                       iframeDoc.querySelector('#cart-float-btn');
            
            const shouldUseOriginal = isTemplateBasedPage || hasTemplateMarkers;
            
            console.log('🔍 Save detection:', {
                selectedPageType: state.selectedPageType,
                isTemplateBasedPage,
                hasTemplateMarkers: !!hasTemplateMarkers,
                shouldUseOriginal
            });
            
            // Try to get original HTML from multiple sources
            const iframeGeneratedHTML = ui.previewIframe.contentWindow?.generatedPageHTML;
            const backupGeneratedHTML = window.generatedPageHTML_backup;
            const originalHTML = iframeGeneratedHTML || backupGeneratedHTML;
            
            console.log('📄 HTML sources:', {
                hasIframeHTML: !!iframeGeneratedHTML,
                hasBackupHTML: !!backupGeneratedHTML,
                iframeLength: iframeGeneratedHTML?.length || 0,
                backupLength: backupGeneratedHTML?.length || 0
            });
            
            if (shouldUseOriginal && originalHTML) {
                console.log('📄 ✅ Using ORIGINAL generatedPageHTML for template-based page (prevents duplicate carts/bots)');
                console.log('📄 Source:', iframeGeneratedHTML ? 'iframe' : 'parent backup');
                finalHtml = originalHTML;
            } else if (shouldUseOriginal && !originalHTML) {
                console.warn('⚠️ Template page but NO BACKUP HTML! Falling back to DOM clone...');
                const clonedDoc = iframeDoc.cloneNode(true);
                clonedDoc.querySelectorAll('[style*="outline"]').forEach(el => el.style.outline = '');
                finalHtml = clonedDoc.documentElement.outerHTML;
            } else {
                // For other page types, clone the DOM as before
                const clonedDoc = iframeDoc.cloneNode(true);
                clonedDoc.querySelectorAll('[style*="outline"]').forEach(el => el.style.outline = '');
                finalHtml = clonedDoc.documentElement.outerHTML;
                console.log('📄 Using cloned DOM for non-template page');
            }
            
            // Verify we have RSVP form if this is an event page
            const hasRsvpForm = finalHtml.includes('id="rsvp-form"') || finalHtml.includes('rsvp-name');
            console.log('📋 RSVP form present in saved HTML:', hasRsvpForm);
            if (!hasRsvpForm && state.selectedPageType === 'event') {
                console.warn('⚠️ WARNING: Event page missing RSVP form in final HTML!');
            }
            
            // בדוק אם אנחנו במצב עריכה
            const urlParams = new URLSearchParams(window.location.search);
            const editProjectId = urlParams.get('edit');

            if (editProjectId) {
                // מצב עריכה - עדכן את הקובץ הקיים
                console.log('Updating existing project:', editProjectId);
                
                if (editProjectId.startsWith('local_')) {
                    // עדכן קובץ מקומי
                    const fileName = editProjectId.replace('local_', '');
                    try {
                        const response = await fetch('/api/update-page', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                userId: user.id,
                                fileName: fileName,
                                htmlContent: finalHtml
                            })
                        });

                        if (response.ok) {
                            console.log('Local page updated successfully');
                            showModal('הדף עודכן בהצלחה!');
                        } else {
                            throw new Error('Failed to update local page');
                        }
                    } catch (error) {
                        console.error('Error updating local page:', error);
                        showModal('שגיאה בעדכון הדף');
                        return;
                    }
                } else {
                    // עדכן דף מ-Supabase
                    try {
                        const { error } = await sb.from('projects')
                            .update({ 
                                html_content: finalHtml,
                                name: document.getElementById('mainName').value || 'דף נחיתה'
                            })
                            .eq('id', editProjectId);
                        
                        if (error) {
                            console.error('Error updating Supabase project:', error);
                            showModal('שגיאה בעדכון הדף');
                            return;
                        }
                        
                        console.log('Supabase project updated successfully');
                        showModal('הדף עודכן בהצלחה!');
                    } catch (error) {
                        console.error('Supabase update error:', error);
                        showModal('שגיאה בעדכון הדף');
                        return;
                    }
                }
            } else {
                // מצב יצירה חדשה
            const pageData = {

                user_id: user.id,

                    name: document.getElementById('mainName').value || 'דף נחיתה',
                description: state.originalDescription,

                html_content: finalHtml,

                template_type: state.selectedPageType,
                
                pageType: state.selectedPageType === 'onlineStore' ? 'store' : state.selectedPageType,

                status: 'completed'

            };



                // נסה לשמור ב-Supabase
                let supabaseSuccess = false;
                try {
                    const { error } = await sb.from('projects').insert(pageData);
                    if (error) {
                        console.error('Error saving to Supabase:', error);
                    } else {
                        supabaseSuccess = true;
                        console.log('Page saved to Supabase successfully');
                    }
                } catch (supabaseError) {
                    console.error('Supabase save failed:', supabaseError);
                }

                // אם Supabase נכשל, נסה לשמור מקומית
                if (!supabaseSuccess) {
                    try {
                        const messageInBottleData = state.selectedPageType === 'messageInBottle' ? {
                                    name: document.querySelector('input[name="messageName"]')?.value || '',
                                    request: document.querySelector('textarea[name="messageRequest"]')?.value || '',
                                    area: document.querySelector('input[name="messageArea"]')?.value || '',
                                    phone: document.querySelector('input[name="messagePhone"]')?.value || '',
                                    price: document.querySelector('input[name="messagePrice"]')?.value || '',
                                    priceType: document.querySelector('select[name="priceType"]')?.value || ''
                                } : undefined;
                        
                        console.log('🚨 DEBUG messageInBottleData:', messageInBottleData);
                        
                        const response = await fetch('/api/create-page', {
                    method: 'POST',

                    headers: {

                                'Content-Type': 'application/json',
                    },

                    body: JSON.stringify({

                        userId: user.id,
                        title: state.selectedPageType === 'messageInBottle' ? 
                            (document.querySelector('input[name="messageName"]')?.value || 'מסר בבקבוק') :
                            (document.getElementById('mainName')?.value || 'דף נחיתה'),
                                htmlContent: finalHtml,
                                selectedPageType: state.selectedPageType,
                                messageInBottleData: messageInBottleData
                    })

                });



                        if (response.ok) {
                            const result = await response.json();
                            console.log('Page saved locally:', result);
                            showModal(getTranslation('modal_save_success'));
                        } else {
                            throw new Error('Local save failed');
                        }
                    } catch (localError) {
                        console.error('Local save error:', localError);
                        showModal(`${getTranslation('modal_error_save')}: שמירה מקומית נכשלה`);
                        return;
                    }
                } else {
                showModal(getTranslation('modal_save_success'));

                }
            }


                const redirectUrl = urlParams.get('redirectUrl');

                setTimeout(() => {

                    if (redirectUrl) {
                        // הוסף פרמטר שמציין שחזרנו מיצירת דף
                        const separator = redirectUrl.includes('?') ? '&' : '?';
                        window.top.location.href = redirectUrl + separator + 'fromCreator=true';

                    } else {

                        hideModal();

                    }

                }, 2000);

        }

        // --- Download Page Function ---
        // --- Back to Home Function ---
        function handleBackToHome() {
            // חזור לדף הבית ללא שמירה
            window.location.href = '/';
        }



        // --- Utility Functions ---

        function setLoading(isLoading) {

             if (isLoading) {

                ui.generateBtnText.classList.add('hidden');

                ui.generateBtnLoader.classList.remove('hidden');

                

                // טקסטים מתחלפים עם הסברים יפים
                const messages = [getTranslation('gen_text_1'), getTranslation('gen_text_2'), getTranslation('gen_text_3'), getTranslation('gen_text_4')];

                let messageIndex = 0;

                ui.generationView.innerHTML = `
                    <div class="gen-loader">
                        <div class="inner one"></div>
                        <div class="inner two"></div>
                        <div class="inner three"></div>
                    </div>
                    <p id="gen-text-animation" class="gen-text text-xl">${messages[messageIndex]}</p>
                `;

                const textElement = document.getElementById('gen-text-animation');

                const intervalId = setInterval(() => {
                    messageIndex = (messageIndex + 1) % messages.length;

                    if(textElement) {
                       textElement.classList.remove('fade-in');
                       void textElement.offsetWidth; // Trigger reflow
                       textElement.textContent = messages[messageIndex];
                       textElement.classList.add('fade-in');
                    }
                }, 4000); // זמן איטי יותר כדי שהמשתמש יוכל לקרוא בנוחות

                ui.generationView.dataset.intervalId = intervalId;






                if (!ui.previewView.classList.contains('active')) {

                     switchView(ui.formView, ui.previewView);

                }

                ui.generationView.classList.remove('hidden');

                ui.previewContainer.classList.add('hidden');

            } else {

                ui.generateBtnText.classList.remove('hidden');

                ui.generateBtnLoader.classList.add('hidden');

                ui.generationView.classList.add('hidden');

                // עצור את האנימציה
                const intervalId = ui.generationView.dataset.intervalId;
                if (intervalId) {
                    clearInterval(intervalId);
                }
            }

        }

        



        function findBackgroundHolder(el) {

            let current = el;

            for (let i = 0; i < 5 && current && current !== document.body; i++) {

                if (window.getComputedStyle(current).backgroundImage !== 'none') return current;

                current = current.parentElement;

            }

            return null;

        }



        // --- App Start ---

        window.addEventListener('DOMContentLoaded', (event) => {

            initializeApp();
            
            // הוסף event listeners לשעות מיוחדות קיימות
            setTimeout(() => {
                const existingSpecialInputs = document.querySelectorAll('select[name="specialDay[]"], input[name="specialStartTime[]"], input[name="specialEndTime[]"]');
                existingSpecialInputs.forEach(input => {
                    if (!input.classList.contains('special-day-select') && !input.classList.contains('special-time-input')) {
                        if (input.tagName === 'SELECT') {
                            input.classList.add('special-day-select');
                        } else {
                            input.classList.add('special-time-input');
                        }
                    }
                    input.addEventListener('change', function() {
                        if (typeof updateSpecialHoursSummary === 'function') {
                            updateSpecialHoursSummary();
                        }
                    });
                });
                
                // עדכן את הסיכום אם יש שעות מיוחדות כבר מלאות
                if (typeof updateSpecialHoursSummary === 'function') {
                    updateSpecialHoursSummary();
                }
            }, 500);

            // הוסף מאזין לכפתור הוספת הפסקה
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'add-break-btn') {
                    const breaksContainer = document.getElementById('breaks-container');
                    const breakItem = document.createElement('div');
                    breakItem.className = 'break-item bg-white p-3 rounded border border-orange-200 relative';
                    breakItem.innerHTML = `
                        <button type="button" class="remove-break-btn absolute top-2 left-2 text-red-500 hover:text-red-700 text-xl font-bold" title="הסר הפסקה">×</button>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">⏰ התחלת הפסקה</label>
                                <input type="time" name="breakStart[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="13:00">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">⏰ סיום הפסקה</label>
                                <input type="time" name="breakEnd[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="14:00">
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="block text-xs font-medium text-gray-700 mb-1">📝 תיאור (אופציונלי)</label>
                            <input type="text" name="breakDescription[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="הפסקת צהריים">
                        </div>
                    `;
                    breaksContainer.appendChild(breakItem);
                }
                
                // הסר הפסקה
                if (e.target && e.target.classList.contains('remove-break-btn')) {
                    e.target.closest('.break-item').remove();
                }
                
                // פונקציה לעדכן תצוגת סיכום שעות מיוחדות
                function updateSpecialHoursSummary() {
                    const container = document.getElementById('special-hours-container');
                    const summaryDiv = document.getElementById('special-hours-summary');
                    const summaryList = document.getElementById('special-hours-list');
                    
                    if (!container || !summaryDiv || !summaryList) return;
                    
                    const dayNames = {
                        'sunday': 'ראשון',
                        'monday': 'שני',
                        'tuesday': 'שלישי',
                        'wednesday': 'רביעי',
                        'thursday': 'חמישי',
                        'friday': 'שישי',
                        'saturday': 'שבת'
                    };
                    
                    const items = container.querySelectorAll('.special-hours-item');
                    const filledItems = [];
                    
                    items.forEach(item => {
                        const daySelect = item.querySelector('select[name="specialDay[]"]');
                        const startInput = item.querySelector('input[name="specialStartTime[]"]');
                        const endInput = item.querySelector('input[name="specialEndTime[]"]');
                        
                        if (daySelect && daySelect.value && startInput && startInput.value && endInput && endInput.value) {
                            const dayName = dayNames[daySelect.value] || daySelect.value;
                            filledItems.push({
                                day: dayName,
                                start: startInput.value,
                                end: endInput.value
                            });
                        }
                    });
                    
                    if (filledItems.length > 0) {
                        summaryList.innerHTML = filledItems.map(item => 
                            `• <strong>${item.day}</strong>: ${item.start} - ${item.end}`
                        ).join('<br>');
                        summaryDiv.classList.remove('hidden');
                    } else {
                        summaryDiv.classList.add('hidden');
                    }
                }
                
                // הוסף שעות מיוחדות
                if (e.target && e.target.id === 'add-special-hours-btn') {
                    const specialHoursContainer = document.getElementById('special-hours-container');
                    const specialHoursItem = document.createElement('div');
                    specialHoursItem.className = 'special-hours-item bg-white p-3 rounded border border-blue-200 relative';
                    specialHoursItem.innerHTML = `
                        <button type="button" class="remove-special-hours-btn absolute top-2 left-2 text-red-500 hover:text-red-700 text-xl font-bold" title="הסר שעות מיוחדות">×</button>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">📅 יום</label>
                                <select name="specialDay[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded special-day-select">
                                    <option value="">בחר יום...</option>
                                    <option value="sunday">ראשון</option>
                                    <option value="monday">שני</option>
                                    <option value="tuesday">שלישי</option>
                                    <option value="wednesday">רביעי</option>
                                    <option value="thursday">חמישי</option>
                                    <option value="friday">שישי</option>
                                    <option value="saturday">שבת</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">⏰ שעת התחלה</label>
                                <input type="time" name="specialStartTime[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded special-time-input" placeholder="09:00">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">⏰ שעת סיום</label>
                                <input type="time" name="specialEndTime[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded special-time-input" placeholder="13:00">
                            </div>
                        </div>
                    `;
                    specialHoursContainer.appendChild(specialHoursItem);
                    
                    // הוסף event listeners לעדכון הסיכום
                    const selects = specialHoursItem.querySelectorAll('select.special-day-select');
                    const inputs = specialHoursItem.querySelectorAll('input.special-time-input');
                    [...selects, ...inputs].forEach(el => {
                        el.addEventListener('change', updateSpecialHoursSummary);
                        el.addEventListener('input', updateSpecialHoursSummary);
                    });
                    
                    updateSpecialHoursSummary();
                }
                
                // הסר שעות מיוחדות
                if (e.target && e.target.classList.contains('remove-special-hours-btn')) {
                    e.target.closest('.special-hours-item').remove();
                    updateSpecialHoursSummary();
                }
                
                // הוסף שירות
                if (e.target && e.target.id === 'add-service-btn') {
                    const servicesContainer = document.getElementById('services-container');
                    if (!servicesContainer) return;
                    
                    const serviceItem = document.createElement('div');
                    serviceItem.className = 'service-item bg-white p-3 rounded border border-green-200 relative';
                    serviceItem.innerHTML = `
                        <button type="button" class="remove-service-btn absolute top-2 left-2 text-red-500 hover:text-red-700 text-xl font-bold" title="הסר שירות">×</button>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">🔧 שם השירות</label>
                                <input type="text" name="serviceName[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="למשל: לק, גל ידיים רגליים">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">⏱️ משך (דקות)</label>
                                <input type="number" name="serviceDuration[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="30" min="1" value="30">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">💰 מחיר (₪)</label>
                                <input type="number" name="servicePrice[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="0" min="0" step="0.01" value="0">
                            </div>
                        </div>
                    `;
                    servicesContainer.appendChild(serviceItem);
                }
                
                // הסר שירות
                if (e.target && e.target.classList.contains('remove-service-btn')) {
                    e.target.closest('.service-item').remove();
                }
                
                // עדכן סיכום כשמשנים שדות קיימים
                if (e.target && (e.target.classList.contains('special-day-select') || e.target.classList.contains('special-time-input'))) {
                    updateSpecialHoursSummary();
                }
                
                // גם עבור שדות קיימים שהיו בדף מראש
                if (e.target && e.target.matches('select[name="specialDay[]"], input[name="specialStartTime[]"], input[name="specialEndTime[]"]')) {
                    updateSpecialHoursSummary();
                }
                
                // הוסף נכס חדש
                if (e.target && e.target.id === 'add-property-btn') {
                    const propertiesContainer = document.getElementById('properties-container');
                    const propertyCount = propertiesContainer.querySelectorAll('.property-item').length;
                    const propertyItem = document.createElement('div');
                    propertyItem.className = 'property-item bg-white p-6 rounded-lg border-2 border-gray-300 shadow-sm';
                    propertyItem.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-gray-800">🏠 נכס #${propertyCount + 1}</h4>
                            <button type="button" class="remove-property-btn px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition">
                                ❌ הסר נכס
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">🏘️ כותרת הנכס</label>
                                    <input type="text" name="propertyTitle[]" class="block w-full px-3 py-2 border border-gray-300 rounded" placeholder="דירת גן מרווחת בתל אביב">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">📍 כתובת</label>
                                    <input type="text" name="propertyAddress[]" class="block w-full px-3 py-2 border border-gray-300 rounded" placeholder="רחוב הרצל 123, תל אביב">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">🛏️ חדרים</label>
                                    <input type="number" name="propertyBeds[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="4">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">🚿 אמבטיות</label>
                                    <input type="number" name="propertyBaths[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="2">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">📐 מ"ר</label>
                                    <input type="number" name="propertySqft[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="120">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">💰 מחיר (₪)</label>
                                    <input type="text" name="propertyPrice[]" class="block w-full px-2 py-1 text-sm border border-gray-300 rounded" placeholder="3,500,000">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">📝 תיאור הנכס</label>
                                <textarea name="propertyDescription[]" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded" placeholder="דירת גן מרווחה ומוארת עם גינה פרטית..."></textarea>
                            </div>
                            
                                            <div class="bg-purple-50 p-4 rounded border border-purple-200">
                                <h5 class="font-semibold text-purple-900 mb-2">📸 תמונות הנכס</h5>
                                <p class="text-sm text-purple-700">
                                    💡 <strong>התמונות יתווספו אחרי יצירת הדף</strong> דרך ממשק העריכה.<br>
                                    כרגע רק הזן את פרטי הנכס, והמערכת תיצור תמונות דוגמה.
                                </p>
                            </div>
                        </div>
                    `;
                    propertiesContainer.appendChild(propertyItem);
                    
                    // הצג כפתורי הסרה
                    updateRemovePropertyButtons();
                }
                
                // הסר נכס
                if (e.target && e.target.classList.contains('remove-property-btn')) {
                    e.target.closest('.property-item').remove();
                    updateRemovePropertyButtons();
                }
                
                // הוסף סרטון קורס
                if (e.target && e.target.id === 'add-course-video-btn') {
                    const container = document.getElementById('course-videos-container');
                    const videoCount = container.querySelectorAll('.course-video-item').length;
                    const videoItem = document.createElement('div');
                    videoItem.className = 'course-video-item bg-white p-4 border-2 border-dashed border-gray-300 rounded-lg relative';
                    videoItem.innerHTML = `
                        <button type="button" class="remove-video-btn absolute top-2 left-2 text-red-500 hover:text-red-700 text-xl font-bold" title="הסר סרטון">×</button>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">שם השיעור/סרטון</label>
                                <input type="text" name="courseVideoTitle[]" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="למשל: שיעור ${videoCount + 1}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">בחר סוג:</label>
                                <div class="flex gap-4 mt-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="courseVideoType_${videoCount}" value="youtube" class="mr-2 video-type-radio" checked>
                                        <span class="text-sm">קישור YouTube</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="courseVideoType_${videoCount}" value="upload" class="mr-2 video-type-radio">
                                        <span class="text-sm">העלאת סרטון</span>
                                    </label>
                                </div>
                            </div>
                            <div class="youtube-input">
                                <label class="block text-sm font-medium text-gray-700">קישור YouTube</label>
                                <input type="url" name="courseVideoUrl[]" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="https://youtube.com/watch?v=...">
                            </div>
                            <div class="upload-input hidden">
                                <label class="block text-sm font-medium text-gray-700">העלה סרטון</label>
                                <input type="file" name="courseVideoFile[]" accept="video/*" class="mt-1 block w-full">
                            </div>
                        </div>
                    `;
                    container.appendChild(videoItem);
                }
                
                // הסר סרטון
                if (e.target && e.target.classList.contains('remove-video-btn')) {
                    e.target.closest('.course-video-item').remove();
                }
                
                // החלף בין YouTube להעלאה
                if (e.target && e.target.classList.contains('video-type-radio')) {
                    const videoItem = e.target.closest('.course-video-item');
                    const youtubeInput = videoItem.querySelector('.youtube-input');
                    const uploadInput = videoItem.querySelector('.upload-input');
                    
                    if (e.target.value === 'youtube') {
                        youtubeInput.classList.remove('hidden');
                        uploadInput.classList.add('hidden');
                    } else {
                        youtubeInput.classList.add('hidden');
                        uploadInput.classList.remove('hidden');
                    }
                }
            });
            
            // בדוק אם צריך לטעון פרויקט לעריכה
            const urlParams = new URLSearchParams(window.location.search);
            const editProjectId = urlParams.get('edit');
            
            if (editProjectId) {
                // טען פרויקט לעריכה
                loadProjectForEdit(editProjectId);
            } else {
                // טען פרויקטים קיימים אחרי האתחול
                setTimeout(() => {
                    loadUserProjects();
                }, 1000);
                
                // הצג הודעה על מצב Supabase
                setTimeout(() => {
                    console.log('💡 טיפ: אם Supabase לא זמין, הדפים יישמרו מקומית בלבד');
                }, 2000);
            }
        });
        
        // פונקציות עזר לניהול נכסים
        function updateRemovePropertyButtons() {
            const properties = document.querySelectorAll('.property-item');
            properties.forEach((property, index) => {
                const removeBtn = property.querySelector('.remove-property-btn');
                if (properties.length > 1) {
                    removeBtn.classList.remove('hidden');
                } else {
                    removeBtn.classList.add('hidden');
                }
                
                // עדכן מספור
                const title = property.querySelector('h4');
                if (title) {
                    title.textContent = `🏠 נכס #${index + 1}`;
                }
            });
        }

        // --- Load Project for Edit ---
        async function loadProjectForEdit(projectId) {
            try {
                console.log('Loading project for edit:', projectId);
                
                // בדוק אם זה דף מקומי
                if (projectId.startsWith('local_')) {
                    const fileName = projectId.replace('local_', '');
                    console.log('Loading local file:', fileName);
                    
                    // טען את הקובץ המקומי
                    const { data: { user: currentUser } } = await sb.auth.getUser();
                    if (!currentUser) {
                        throw new Error('User not authenticated');
                    }
                    const response = await fetch(`/pages/${currentUser.id}/${fileName}`);
                    if (response.ok) {
                        const htmlContent = await response.text();
                        ui.previewIframe.srcdoc = htmlContent;
                        
                        // Store in iframe window for saving (CRITICAL!)
                        ui.previewIframe.onload = () => {
                            ui.previewIframe.contentWindow.generatedPageHTML = htmlContent;
                            console.log('✅ generatedPageHTML stored (loaded from file)');
                        };
                        
                        ui.previewContainer.classList.remove('hidden');
                        ui.generationView.classList.add('hidden');
                        ui.toolsFab.classList.remove('hidden');
                        ui.toolsFab.classList.remove('active');
                        ui.toolsMenu.classList.remove('open');
                        ui.savePageBtn.classList.remove('hidden');
                        ui.downloadPageBtn.classList.remove('hidden');
                        switchView(ui.typeSelectionView, ui.previewView);
                        return;
                    } else {
                        throw new Error('Failed to load local file');
                    }
                }
                
                // דף מ-Supabase
                const { data: project, error } = await sb
                    .from('projects')
                    .select('*')
                    .eq('id', projectId)
                    .single();

                if (error || !project) {
                    console.error('Supabase error:', error);
                    showModal('שגיאה בטעינת הפרויקט מ-Supabase');
                    return;
                }

                // טען את הפרויקט לעריכה
                ui.previewIframe.srcdoc = project.html_content;
                
                // Store in iframe window for saving (CRITICAL!)
                ui.previewIframe.onload = () => {
                    ui.previewIframe.contentWindow.generatedPageHTML = project.html_content;
                    console.log('✅ generatedPageHTML stored (loaded from Supabase)');
                };
                
                ui.previewContainer.classList.remove('hidden');
                ui.generationView.classList.add('hidden');
                ui.toolsFab.classList.remove('hidden');
                ui.toolsFab.classList.remove('active');
                ui.toolsMenu.classList.remove('open');
                ui.savePageBtn.classList.remove('hidden');
                ui.downloadPageBtn.classList.remove('hidden');
                switchView(ui.typeSelectionView, ui.previewView);

            } catch (error) {
                console.error('Error loading project for edit:', error);
                showModal('שגיאה בטעינת הפרויקט: ' + error.message);
            }
        }

        // --- Load User Projects ---
        async function loadUserProjects() {
            try {
                const { data: { user } } = await sb.auth.getUser();
                if (!user) {
                    console.log('No user found - Supabase unavailable');
                    return;
                }

                const { data: projects, error } = await sb
                    .from('projects')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.log('Supabase לא זמין - לא נטענו פרויקטים קיימים');
                } else {
                    console.log('נטענו פרויקטים קיימים:', projects?.length || 0);
                }
            } catch (error) {
                console.log('Supabase לא זמין - לא נטענו פרויקטים קיימים');
            }
        }

        // --- Language and Country Support ---
        function getCurrentLanguage() {
            // בדוק אם יש פרמטרים מ-URL
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            if (urlLang) {
                // עדכן את ה-selector
                const selector = document.getElementById('language-selector');
                if (selector) {
                    selector.value = urlLang;
                }
                return urlLang;
            }
            return document.getElementById('language-selector')?.value || 'he';
        }

        function getCountryFromLanguage(lang) {
            const countryMap = {
                'he': 'IL', // ישראל
                'ar': 'SA', // סעודיה
                'ja': 'JP', // יפן
                'en': 'US', // ארה"ב
                'es': 'ES', // ספרד
                'fr': 'FR', // צרפת
                'de': 'DE', // גרמניה
                'ru': 'RU', // רוסיה
                'zh': 'CN'  // סין
            };
            return countryMap[lang] || 'IL';
        }

        function getWhatsAppCountryCode(lang) {
            const countryCodes = {
                'he': '972', // ישראל
                'ar': '966', // סעודיה
                'ja': '81',  // יפן
                'en': '1',   // ארה"ב
                'es': '34',  // ספרד
                'fr': '33',  // צרפת
                'de': '49',  // גרמניה
                'ru': '7',   // רוסיה
                'zh': '86'   // סין
            };
            return countryCodes[lang] || '972';
        }

        function getLanguageName(lang) {
            const names = {
                'he': 'עברית',
                'ar': 'العربية',
                'ja': '日本語',
                'en': 'English',
                'es': 'Español',
                'fr': 'Français',
                'de': 'Deutsch',
                'ru': 'Русский',
                'zh': '中文'
            };
            return names[lang] || 'עברית';
        }

        function addLanguageToPageData(data) {
            // השתמש בשפה שנבחרה בטופס, לא בשפת הממשק
            const selectedOutputLang = data.outputLanguage || getCurrentLanguage();
            const country = getCountryFromLanguage(selectedOutputLang);
            const whatsappCountryCode = getWhatsAppCountryCode(selectedOutputLang);
            
            data.language = selectedOutputLang;
            data.outputLanguage = selectedOutputLang;
            data.country = country;
            data.languageName = getLanguageName(selectedOutputLang);
            data.whatsappCountryCode = whatsappCountryCode;
            
            // עדכן גם את ה-select של שפת הפלט
            const outputLanguageSelect = document.getElementById('outputLanguage');
            if (outputLanguageSelect) {
                outputLanguageSelect.value = selectedOutputLang;
            }
            
            console.log('Added language data:', { 
                language: selectedOutputLang, 
                outputLanguage: data.outputLanguage,
                country, 
                languageName: data.languageName,
                whatsappCountryCode 
            });
            return data;
        }
        // פונקציה לעדכון שפת הדף
        function updatePageLanguage(lang) {
            document.documentElement.lang = lang;
            if (lang === 'he' || lang === 'ar') {
                document.documentElement.dir = 'rtl';
            } else {
                document.documentElement.dir = 'ltr';
            }
            
            // אל תעדכן את שפת הפלט - תן למשתמש לבחור אותה בנפרד
            // const outputLanguageSelect = document.getElementById('outputLanguage');
            // if (outputLanguageSelect) {
            //     outputLanguageSelect.value = lang;
            // }
            
            translatePageCreatorInterface(lang);
        }
        function translatePageCreatorInterface(lang) {
            const translations = {
                'he': {
                    'main_title': 'AutoPage - צור את הממשק שלך',
                    'main_subtitle': 'צור דף מקצועי תוך דקות עם בוט AI חכם',
                    'create_page_title': 'צור דף',
                    'form_subtitle': 'מלא את הפרטים הבאים',
                    'fieldset_basic_details': 'פרטים בסיסיים',
                    'label_contact_name': 'שם איש קשר',
                    'label_email': 'אימייל',
                    'label_phone': 'טלפון',
                    'label_description': 'תיאור העסק',
                    'label_address': 'כתובת',
                    'fieldset_optional_sections': 'סעיפים אופציונליים',
                    'fieldset_social_media': 'רשתות חברתיות',
                    'label_youtube_display': 'הצגת YouTube',
                    'label_youtube_embed': 'קוד הטמעה',
                    'label_youtube_link': 'קישור',
                    'fieldset_design': 'עיצוב',
                    'label_hero_image': 'תמונת כותרת',
                    'label_use_as_background': 'השתמש כרקע',
                    'note_image_upload': 'העלה תמונה או השאר ריק',
                    'label_additional_settings': 'הגדרות נוספות',
                    'label_output_language': 'שפת הפלט',
                    'label_design_style': 'סגנון עיצוב',
                    'style_minimalist_pro': 'מינימליסטי מקצועי',
                    'style_midnight': 'חצות',
                    'style_claymorphism': 'קליי',
                    'style_retro_title': 'רטרו',
                    'style_retro': 'רטרו',
                    'style_aurora': 'אורורה',
                    'style_bento': 'בנטו',
                    'style_comic': 'קומיקס',
                    'style_surreal': 'סוריאליסטי',
                    'btn_back': 'חזור',
                    'btn_generate': 'צור דף',
                    'fieldset_external_links': 'קישורים חיצוניים',
                    'label_main_button_text': 'טקסט הכפתור הראשי',
                    'label_main_button_url': 'כתובת הכפתור הראשי',
                    'fieldset_property_details': 'פרטי הנכס',
                    'label_beds': 'חדרי שינה',
                    'label_baths': 'חדרי רחצה',
                    'label_sqft': 'מ״ר',
                    'label_price': 'מחיר',
                    'fieldset_app_links': 'קישורי אפליקציות',
                    'label_app_store_link': 'קישור App Store',
                    'label_google_play_link': 'קישור Google Play',
                    'modal_close_btn': 'סגור'
                },
                'en': {
                    'main_title': 'AutoPage - Create Your Interface',
                    'main_subtitle': 'Create professional pages in minutes with smart AI bot',
                    'create_page_title': 'Create Page',
                    'form_subtitle': 'Fill in the following details',
                    'fieldset_basic_details': 'Basic Details',
                    'label_contact_name': 'Contact Name',
                    'label_email': 'Email',
                    'label_phone': 'Phone',
                    'label_description': 'Business Description',
                    'label_address': 'Address',
                    'fieldset_optional_sections': 'Optional Sections',
                    'fieldset_social_media': 'Social Media',
                    'label_youtube_display': 'YouTube Display',
                    'label_youtube_embed': 'Embed Code',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hero Image',
                    'label_use_as_background': 'Use as Background',
                    'note_image_upload': 'Upload image or leave blank',
                    'label_additional_settings': 'Additional Settings',
                    'label_output_language': 'Output Language',
                    'label_design_style': 'Design Style',
                    'style_minimalist_pro': 'Minimalist Pro',
                    'style_midnight': 'Midnight',
                    'style_claymorphism': 'Clay',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Back',
                    'btn_generate': 'Create Page',
                    'fieldset_external_links': 'External Links',
                    'label_main_button_text': 'Main Button Text',
                    'label_main_button_url': 'Main Button URL',
                    'fieldset_property_details': 'Property Details',
                    'label_beds': 'Bedrooms',
                    'label_baths': 'Bathrooms',
                    'label_sqft': 'Sq Ft',
                    'label_price': 'Price',
                    'fieldset_app_links': 'App Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link',
                    'modal_close_btn': 'Close'
                },
                'ar': {
                    'main_title': 'منشئ صفحات الهبوط المتقدم',
                    'main_subtitle': 'أنشئ صفحات هبوط احترافية في دقائق مع بوت ذكي',
                    'create_page_title': 'إنشاء صفحة',
                    'form_subtitle': 'املأ التفاصيل التالية',
                    'fieldset_basic_details': 'التفاصيل الأساسية',
                    'label_contact_name': 'اسم جهة الاتصال',
                    'label_email': 'البريد الإلكتروني',
                    'label_phone': 'الهاتف',
                        'label_description': 'وصف ال;عمل',
                    'label_address': 'العنوان',
                    'fieldset_optional_sections': 'أقسام اختيارية',
                    'fieldset_social_media': 'وسائل التواصل الاجتماعي',
                    'label_youtube_display': 'عرض YouTube',
                    'label_youtube_embed': 'كود التضمين',
                    'label_youtube_link': 'الرابط',
                    'fieldset_design': 'التصميم',
                    'label_hero_image': 'صورة البطل',
                    'label_use_as_background': 'استخدام كخلفية',
                    'note_image_upload': 'رفع صورة أو اتركها فارغة',
                    'label_additional_settings': 'إعدادات إضافية',
                    'label_output_language': 'لغة الإخراج',
                    'label_design_style': 'نمط التصميم',
                    'style_minimalist_pro': 'بسيط احترافي',
                    'style_midnight': 'منتصف الليل',
                    'style_claymorphism': 'طيني',
                    'style_retro_title': 'رجعي',
                    'style_retro': 'رجعي',
                    'style_aurora': 'الشفق',
                    'style_bento': 'بنتو',
                    'btn_back': 'رجوع',
                    'btn_generate': 'إنشاء صفحة',
                    'fieldset_external_links': 'روابط خارجية',
                    'label_main_button_text': 'نص الزر الرئيسي',
                    'label_main_button_url': 'رابط الزر الرئيسي',
                    'fieldset_property_details': 'تفاصيل العقار',
                    'label_beds': 'غرف النوم',
                    'label_baths': 'الحمامات',
                    'label_sqft': 'قدم مربع',
                    'label_price': 'السعر',
                    'fieldset_app_links': 'روابط التطبيقات',
                    'label_app_store_link': 'رابط App Store',
                    'label_google_play_link': 'رابط Google Play',
                    'modal_close_btn': 'إغلاق'
                },
                'ja': {
                    'main_title': '高度なランディングページ作成者',
                    'main_subtitle': 'スマートAIボットで数分でプロフェッショナルなランディングページを作成',
                    'create_page_title': 'ページ作成',
                    'form_subtitle': '以下の詳細を入力してください',
                    'fieldset_basic_details': '基本詳細',
                    'label_contact_name': '連絡先名',
                    'label_email': 'メール',
                    'label_phone': '電話番号',
                    'label_description': 'ビジネス説明',
                    'label_address': '住所',
                    'fieldset_optional_sections': 'オプションセクション',
                    'fieldset_social_media': 'ソーシャルメディア',
                    'label_youtube_display': 'YouTube表示',
                    'label_youtube_embed': '埋め込みコード',
                    'label_youtube_link': 'リンク',
                    'fieldset_design': 'デザイン',
                    'label_hero_image': 'ヒーロー画像',
                    'label_use_as_background': '背景として使用',
                    'note_image_upload': '画像をアップロードまたは空白のまま',
                    'label_additional_settings': '追加設定',
                    'label_output_language': '出力言語',
                    'label_design_style': 'デザインスタイル',
                    'style_minimalist_pro': 'ミニマリストプロ',
                    'style_midnight': 'ミッドナイト',
                    'style_claymorphism': 'クレイ',
                    'style_retro_title': 'レトロ',
                    'style_retro': 'レトロ',
                    'style_aurora': 'オーロラ',
                    'style_bento': 'ベント',
                    'btn_back': '戻る',
                    'btn_generate': 'ページ作成',
                    'fieldset_external_links': '外部リンク',
                    'label_main_button_text': 'メインボタンテキスト',
                    'label_main_button_url': 'メインボタンURL',
                    'fieldset_property_details': '物件詳細',
                    'label_beds': '寝室',
                    'label_baths': 'バスルーム',
                    'label_sqft': '平方フィート',
                    'label_price': '価格',
                    'fieldset_app_links': 'アプリリンク',
                    'label_app_store_link': 'App Storeリンク',
                    'label_google_play_link': 'Google Playリンク',
                    'modal_close_btn': '閉じる'
                },
                'es': {
                    'main_title': 'Creador Avanzado de Páginas de Aterrizaje',
                    'main_subtitle': 'Crea páginas de aterrizaje profesionales en minutos con bot IA inteligente',
                    'create_page_title': 'Crear Página',
                    'form_subtitle': 'Complete los siguientes detalles',
                    'fieldset_basic_details': 'Detalles Básicos',
                    'label_contact_name': 'Nombre de Contacto',
                    'label_email': 'Correo Electrónico',
                    'label_phone': 'Teléfono',
                    'label_description': 'Descripción del Negocio',
                    'label_address': 'Dirección',
                    'fieldset_optional_sections': 'Secciones Opcionales',
                    'fieldset_social_media': 'Redes Sociales',
                    'label_youtube_display': 'Mostrar YouTube',
                    'label_youtube_embed': 'Código de Incrustación',
                    'label_youtube_link': 'Enlace',
                    'fieldset_design': 'Diseño',
                    'label_hero_image': 'Imagen Principal',
                    'label_use_as_background': 'Usar como Fondo',
                    'note_image_upload': 'Subir imagen o dejar en blanco',
                    'label_additional_settings': 'Configuraciones Adicionales',
                    'label_output_language': 'Idioma de Salida',
                    'label_design_style': 'Estilo de Diseño',
                    'style_minimalist_pro': 'Minimalista Pro',
                    'style_midnight': 'Medianoche',
                    'style_claymorphism': 'Arcilla',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Atrás',
                    'btn_generate': 'Crear Página',
                    'fieldset_external_links': 'Enlaces Externos',
                    'label_main_button_text': 'Texto del Botón Principal',
                    'label_main_button_url': 'URL del Botón Principal',
                    'fieldset_property_details': 'Detalles de la Propiedad',
                    'label_beds': 'Dormitorios',
                    'label_baths': 'Baños',
                    'label_sqft': 'Pies Cuadrados',
                    'label_price': 'Precio',
                    'fieldset_app_links': 'Enlaces de Aplicaciones',
                    'label_app_store_link': 'Enlace de App Store',
                    'label_google_play_link': 'Enlace de Google Play',
                    'modal_close_btn': 'Cerrar'
                },
                'fr': {
                    'main_title': 'Créateur de Pages d\'Atterrissage Avancé',
                    'main_subtitle': 'Créez des pages d\'atterrissage professionnelles en minutes avec un bot IA intelligent',
                    'create_page_title': 'Créer une Page',
                    'form_subtitle': 'Remplissez les détails suivants',
                    'fieldset_basic_details': 'Détails de Base',
                    'label_contact_name': 'Nom de Contact',
                    'label_email': 'E-mail',
                    'label_phone': 'Téléphone',
                    'label_description': 'Description de l\'Entreprise',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Sections Optionnelles',
                    'fieldset_social_media': 'Réseaux Sociaux',
                    'label_youtube_display': 'Affichage YouTube',
                    'label_youtube_embed': 'Code d\'Intégration',
                    'label_youtube_link': 'Lien',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Image Principale',
                    'label_use_as_background': 'Utiliser comme Arrière-plan',
                    'note_image_upload': 'Télécharger une image ou laisser vide',
                    'label_additional_settings': 'Paramètres Supplémentaires',
                    'label_output_language': 'Langue de Sortie',
                    'label_design_style': 'Style de Design',
                    'style_minimalist_pro': 'Minimaliste Pro',
                    'style_midnight': 'Minuit',
                    'style_claymorphism': 'Argile',
                    'style_retro_title': 'Rétro',
                    'style_retro': 'Rétro',
                    'style_aurora': 'Aurore',
                    'style_bento': 'Bento',
                    'btn_back': 'Retour',
                    'btn_generate': 'Créer une Page',
                    'fieldset_external_links': 'Liens Externes',
                    'label_main_button_text': 'Texte du Bouton Principal',
                    'label_main_button_url': 'URL du Bouton Principal',
                    'fieldset_property_details': 'Détails de la Propriété',
                    'label_beds': 'Chambres',
                    'label_baths': 'Salles de Bain',
                    'label_sqft': 'Pieds Carrés',
                    'label_price': 'Prix',
                    'fieldset_app_links': 'Liens d\'Applications',
                    'label_app_store_link': 'Lien App Store',
                    'label_google_play_link': 'Lien Google Play',
                    'modal_close_btn': 'Fermer'
                },
                'de': {
                    'main_title': 'Erweiterter Landing Page Creator',
                    'main_subtitle': 'Erstellen Sie professionelle Landing Pages in Minuten mit intelligentem KI-Bot',
                    'create_page_title': 'Seite Erstellen',
                    'form_subtitle': 'Füllen Sie die folgenden Details aus',
                    'fieldset_basic_details': 'Grundlegende Details',
                    'label_contact_name': 'Kontaktname',
                    'label_email': 'E-Mail',
                    'label_phone': 'Telefon',
                    'label_description': 'Geschäftsbeschreibung',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Optionale Abschnitte',
                    'fieldset_social_media': 'Soziale Medien',
                    'label_youtube_display': 'YouTube-Anzeige',
                    'label_youtube_embed': 'Einbettungscode',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hauptbild',
                    'label_use_as_background': 'Als Hintergrund verwenden',
                    'note_image_upload': 'Bild hochladen oder leer lassen',
                    'label_additional_settings': 'Zusätzliche Einstellungen',
                    'label_output_language': 'Ausgabesprache',
                    'label_design_style': 'Design-Stil',
                    'style_minimalist_pro': 'Minimalistisch Pro',
                    'style_midnight': 'Mitternacht',
                    'style_claymorphism': 'Ton',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Zurück',
                    'btn_generate': 'Seite Erstellen',
                    'fieldset_external_links': 'Externe Links',
                    'label_main_button_text': 'Hauptbutton-Text',
                    'label_main_button_url': 'Hauptbutton-URL',
                    'fieldset_property_details': 'Immobiliendetails',
                    'label_beds': 'Schlafzimmer',
                    'label_baths': 'Badezimmer',
                    'label_sqft': 'Quadratfuß',
                    'label_price': 'Preis',
                    'fieldset_app_links': 'App-Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link',
                    'modal_close_btn': 'Schließen'
                },
                'ru': {
                    'main_title': 'Продвинутый Создатель Лендингов',
                    'main_subtitle': 'Создавайте профессиональные лендинги за минуты с умным ИИ ботом',
                    'create_page_title': 'Создать Страницу',
                    'form_subtitle': 'Заполните следующие детали',
                    'fieldset_basic_details': 'Основные Детали',
                    'label_contact_name': 'Имя Контакта',
                    'label_email': 'Электронная Почта',
                    'label_phone': 'Телефон',
                    'label_description': 'Описание Бизнеса',
                    'label_address': 'Адрес',
                    'fieldset_optional_sections': 'Дополнительные Разделы',
                    'fieldset_social_media': 'Социальные Сети',
                    'label_youtube_display': 'Отображение YouTube',
                    'label_youtube_embed': 'Код Встраивания',
                    'label_youtube_link': 'Ссылка',
                    'fieldset_design': 'Дизайн',
                    'label_hero_image': 'Главное Изображение',
                    'label_use_as_background': 'Использовать как Фон',
                    'note_image_upload': 'Загрузить изображение или оставить пустым',
                    'label_additional_settings': 'Дополнительные Настройки',
                    'label_output_language': 'Язык Вывода',
                    'label_design_style': 'Стиль Дизайна',
                    'style_minimalist_pro': 'Минималистичный Про',
                    'style_midnight': 'Полночь',
                    'style_claymorphism': 'Глина',
                    'style_retro_title': 'Ретро',
                    'style_retro': 'Ретро',
                    'style_aurora': 'Аврора',
                    'style_bento': 'Бенто',
                    'btn_back': 'Назад',
                    'btn_generate': 'Создать Страницу',
                    'fieldset_external_links': 'Внешние Ссылки',
                    'label_main_button_text': 'Текст Главной Кнопки',
                    'label_main_button_url': 'URL Главной Кнопки',
                    'fieldset_property_details': 'Детали Недвижимости',
                    'label_beds': 'Спальни',
                    'label_baths': 'Ванные Комнаты',
                    'label_sqft': 'Квадратные Футы',
                    'label_price': 'Цена',
                    'fieldset_app_links': 'Ссылки на Приложения',
                    'label_app_store_link': 'Ссылка App Store',
                    'label_google_play_link': 'Ссылка Google Play',
                    'modal_close_btn': 'Закрыть'
                },
                'zh': {
                    'main_title': '高级着陆页创建器',
                    'main_subtitle': '使用智能AI机器人几分钟内创建专业着陆页',
                    'create_page_title': '创建页面',
                    'form_subtitle': '填写以下详细信息',
                    'fieldset_basic_details': '基本详情',
                    'label_contact_name': '联系人姓名',
                    'label_email': '电子邮件',
                    'label_phone': '电话',
                    'label_description': '业务描述',
                    'label_address': '地址',
                    'fieldset_optional_sections': '可选部分',
                    'fieldset_social_media': '社交媒体',
                    'label_youtube_display': 'YouTube显示',
                    'label_youtube_embed': '嵌入代码',
                    'label_youtube_link': '链接',
                    'fieldset_design': '设计',
                    'label_hero_image': '主图',
                    'label_use_as_background': '用作背景',
                    'note_image_upload': '上传图片或留空',
                    'label_additional_settings': '附加设置',
                    'label_output_language': '输出语言',
                    'label_design_style': '设计风格',
                    'style_minimalist_pro': '极简专业',
                    'style_midnight': '午夜',
                    'style_claymorphism': '粘土',
                    'style_retro_title': '复古',
                    'style_retro': '复古',
                    'style_aurora': '极光',
                    'style_bento': '便当',
                    'btn_back': '返回',
                    'btn_generate': '创建页面',
                    'fieldset_external_links': '外部链接',
                    'label_main_button_text': '主按钮文本',
                    'label_main_button_url': '主按钮URL',
                    'fieldset_property_details': '房产详情',
                    'label_beds': '卧室',
                    'label_baths': '浴室',
                    'label_sqft': '平方英尺',
                    'label_price': '价格',
                    'fieldset_app_links': '应用链接',
                    'label_app_store_link': 'App Store链接',
                    'label_google_play_link': 'Google Play链接',
                    'modal_close_btn': '关闭'
                }
            };

            const t = translations[lang] || translations['he'];
            
            // עדכן טקסטים עם data-translate-key
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (t[key]) {
                    element.textContent = t[key];
                }
            });
            
            // עדכן כותרת הדף
            document.title = t.main_title;
        }

        // טען פרמטרים מ-URL בעת טעינת הדף
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            if (urlLang) {
                const selector = document.getElementById('language-selector');
                if (selector) {
                    selector.value = urlLang;
                    updatePageLanguage(urlLang);
                }
            } else {
                // ברירת מחדל - עברית
                updatePageLanguage('he');
            }
        });



    </script>
</body>

        <!-- Store Management Dashboard -->
        <div id="store-management-dashboard" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-11/12 h-5/6 max-w-7xl overflow-hidden">
                <!-- Dashboard Header -->
                <div class="bg-gradient-to-r from-purple-600 to-pink-500 text-white p-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold" id="dashboard-title">ניהול</h1>
                        <button id="close-dashboard-btn" class="text-white hover:text-gray-200 text-2xl">×</button>
                    </div>
                </div>

                <!-- Dashboard Navigation -->
                <div class="bg-gray-100 border-b">
                    <nav class="flex space-x-8 px-6">
                        <button class="dashboard-nav-btn active" data-section="dashboard">דשבורד</button>
                        <button class="dashboard-nav-btn" data-section="orders">הזמנות</button>
                        <button class="dashboard-nav-btn" data-section="customers">לקוחות</button>
                        <button class="dashboard-nav-btn" data-section="products">מוצרים</button>
                        <button class="dashboard-nav-btn" data-section="media">תמונות</button>
                        <button class="dashboard-nav-btn" data-section="analytics">סטטיסטיקות</button>
                        <button class="dashboard-nav-btn" data-section="users">משתמשים</button>
                    </nav>
                </div>

                <!-- Dashboard Content -->
                <div class="p-6 h-full overflow-y-auto">
                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="dashboard-section">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg">
                                <h3 class="text-lg font-semibold">מכירות היום</h3>
                                <p class="text-3xl font-bold">₪2,450</p>
                            </div>
                            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg">
                                <h3 class="text-lg font-semibold">הזמנות חדשות</h3>
                                <p class="text-3xl font-bold">12</p>
                            </div>
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg">
                                <h3 class="text-lg font-semibold">לקוחות חדשים</h3>
                                <p class="text-3xl font-bold">8</p>
                            </div>
                            <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-lg">
                                <h3 class="text-lg font-semibold">מוצרים במלאי</h3>
                                <p class="text-3xl font-bold">156</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white border rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">מכירות שבועיות</h3>
                                <div class="h-64 bg-gray-100 rounded flex items-center justify-center">
                                    <p class="text-gray-500">גרף מכירות שבועיות</p>
                                </div>
                            </div>
                            <div class="bg-white border rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">מוצרים פופולריים</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span>מוצר A</span>
                                        <span class="text-green-600">45 מכירות</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>מוצר B</span>
                                        <span class="text-green-600">32 מכירות</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>מוצר C</span>
                                        <span class="text-green-600">28 מכירות</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Section -->
                    <div id="orders-section" class="dashboard-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">הזמנות</h2>
                            <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">ייצא דוח</button>
                        </div>
                        
                        <div class="bg-white border rounded-lg overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right">מספר הזמנה</th>
                                        <th class="px-6 py-3 text-right">לקוח</th>
                                        <th class="px-6 py-3 text-right">סכום</th>
                                        <th class="px-6 py-3 text-right">תאריך</th>
                                        <th class="px-6 py-3 text-right">סטטוס</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t">
                                        <td class="px-6 py-4">#12345</td>
                                        <td class="px-6 py-4">יוסי כהן</td>
                                        <td class="px-6 py-4">₪450</td>
                                        <td class="px-6 py-4">2024-01-15</td>
                                        <td class="px-6 py-4"><span class="bg-green-100 text-green-800 px-2 py-1 rounded">הושלם</span></td>
                                    </tr>
                                    <tr class="border-t">
                                        <td class="px-6 py-4">#12346</td>
                                        <td class="px-6 py-4">שרה לוי</td>
                                        <td class="px-6 py-4">₪320</td>
                                        <td class="px-6 py-4">2024-01-15</td>
                                        <td class="px-6 py-4"><span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">בטיפול</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Customers Section -->
                    <div id="customers-section" class="dashboard-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">לקוחות</h2>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">הוסף לקוח</button>
                        </div>
                        
                        <div class="bg-white border rounded-lg overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right">שם</th>
                                        <th class="px-6 py-3 text-right">אימייל</th>
                                        <th class="px-6 py-3 text-right">טלפון</th>
                                        <th class="px-6 py-3 text-right">סכום קניות</th>
                                        <th class="px-6 py-3 text-right">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t">
                                        <td class="px-6 py-4">יוסי כהן</td>
                                        <td class="px-6 py-4">yossi@example.com</td>
                                        <td class="px-6 py-4">050-1234567</td>
                                        <td class="px-6 py-4">₪1,250</td>
                                        <td class="px-6 py-4">
                                            <button class="text-blue-600 hover:text-blue-800">שלח הודעה</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Products Section -->
                    <div id="products-section" class="dashboard-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">מוצרים</h2>
                            <button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">הוסף מוצר</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white border rounded-lg p-6">
                                <img src="https://via.placeholder.com/200x150" alt="מוצר" class="w-full h-32 object-cover rounded mb-4">
                                <h3 class="font-semibold">מוצר A</h3>
                                <p class="text-gray-600">₪120</p>
                                <p class="text-sm text-gray-500">מלאי: 25</p>
                                <div class="mt-4 flex gap-2">
                                    <button class="bg-blue-600 text-white px-3 py-1 rounded text-sm">ערוך</button>
                                    <button class="bg-red-600 text-white px-3 py-1 rounded text-sm">מחק</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Media Section -->
                    <div id="media-section" class="dashboard-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">תמונות וקבצים</h2>
                            <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">העלה קובץ</button>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            <div class="bg-white border rounded-lg p-4">
                                <img src="https://via.placeholder.com/150x150" alt="תמונה" class="w-full h-24 object-cover rounded mb-2">
                                <p class="text-sm text-gray-600">image1.jpg</p>
                                <button class="text-red-600 text-sm mt-2">מחק</button>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Section -->
                    <div id="analytics-section" class="dashboard-section hidden">
                        <h2 class="text-2xl font-bold mb-6">סטטיסטיקות</h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white border rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">מכירות לפי שעות</h3>
                                <div class="h-64 bg-gray-100 rounded flex items-center justify-center">
                                    <p class="text-gray-500">גרף מכירות לפי שעות</p>
                                </div>
                            </div>
                            <div class="bg-white border rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">ניתוח התנהגות לקוחות</h3>
                                <div class="h-64 bg-gray-100 rounded flex items-center justify-center">
                                    <p class="text-gray-500">גרף התנהגות לקוחות</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Section -->
                    <div id="users-section" class="dashboard-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">משתמשים ומנהלים</h2>
                            <button class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">הוסף מנהל</button>
                        </div>
                        
                        <div class="bg-white border rounded-lg overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right">שם משתמש</th>
                                        <th class="px-6 py-3 text-right">אימייל</th>
                                        <th class="px-6 py-3 text-right">תפקיד</th>
                                        <th class="px-6 py-3 text-right">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t">
                                        <td class="px-6 py-4">admin</td>
                                        <td class="px-6 py-4">admin@store.com</td>
                                        <td class="px-6 py-4">מנהל ראשי</td>
                                        <td class="px-6 py-4">
                                            <button class="text-blue-600 hover:text-blue-800">ערוך</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // Store functionality injection
        function injectStoreScripts(htmlContent, data) {
            console.log('Injecting store scripts for page:', data.title);
            
            // 🔥 CRITICAL: Check if this is a template-based page - SKIP EVERYTHING!
            const isTemplateSystem = htmlContent.includes('meta name="template-system"') || 
                                     htmlContent.includes('meta name="skip-store-injection"') ||
                                     htmlContent.includes('skip-store-injection');
            
            if (isTemplateSystem) {
                console.log('⏭️ SKIPPING ALL INJECTIONS - Template-based page detected');
                return htmlContent; // Return unchanged - template has everything built-in
            }
            
            // 🔍 Check if scripts already exist (AI might have added them)
            // Check for multiple indicators that store scripts exist
            const hasCartVariable = htmlContent.includes('let cart') || htmlContent.includes('var cart') || htmlContent.includes('const cart');
            const hasStoreScripts = htmlContent.includes('Store scripts loaded') || htmlContent.includes('addToCart');
            const hasStoreCheckout = htmlContent.includes('store-checkout.js');
            const hasBotHandler = htmlContent.includes('AI BOT ACTIONS HANDLER') || htmlContent.includes('handleBotAction');
            
            if (hasCartVariable || hasStoreScripts || hasStoreCheckout) {
                console.log('⚠️ Store scripts already exist in HTML - skipping cart injection');
                console.log('  - Has cart variable:', hasCartVariable);
                console.log('  - Has store scripts:', hasStoreScripts);
                console.log('  - Has checkout script:', hasStoreCheckout);
                
                // BUT - always inject bot handler if missing!
                if (!hasBotHandler) {
                    console.log('🤖 Bot handler missing - injecting it!');
                    const botHandler = `
<script>
// ===============================================
// 🤖 AI BOT ACTIONS HANDLER
// ===============================================
if (typeof window.sendAiMessage !== 'undefined') {
    const originalSendAiMessage = window.sendAiMessage;
    window.sendAiMessage = async function(...args) {
        try {
            const result = await originalSendAiMessage.apply(this, args);
            if (result && result.action) {
                console.log('🤖 Bot action detected:', result.action, result);
                handleBotAction(result);
            }
            return result;
        } catch (error) {
            console.error('Error in sendAiMessage:', error);
            throw error;
        }
    };
}

function handleBotAction(data) {
    console.log('🛒 Handling bot action:', data.action);
    
    switch(data.action) {
        case 'add_to_cart':
            if (data.items && Array.isArray(data.items)) {
                console.log('🛒 Adding items from bot:', data.items);
                data.items.forEach(item => {
                    if (item.product_name && item.price) {
                        console.log('➕ Adding:', item.product_name, '₪' + item.price, 'x' + (item.quantity || 1));
                        for (let i = 0; i < (item.quantity || 1); i++) {
                            if (typeof window.addToCart === 'function') {
                                window.addToCart(item.product_name, item.price, item.image || '');
                            }
                        }
                    }
                });
            }
            break;
            
        case 'scroll_to_home':
            window.scrollTo({ top: 0, behavior: 'smooth' });
            break;
            
        case 'scroll_to_about':
            const aboutSection = document.querySelector('#about, [id*="about"], .about-section');
            if (aboutSection) aboutSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_products':
            const productsSection = document.querySelector('#products, [id*="products"], .products-section');
            if (productsSection) productsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_contact':
            const contactSection = document.querySelector('#contact, [id*="contact"], .contact-section');
            if (contactSection) contactSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_testimonials':
            const testimonialsSection = document.querySelector('#testimonials, [id*="testimonial"]');
            if (testimonialsSection) testimonialsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_faq':
            const faqSection = document.querySelector('#faq, [id*="faq"]');
            if (faqSection) faqSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_product':
            if (data.product_name) {
                const allProducts = document.querySelectorAll('.product-card, [class*="product"]');
                for (const product of allProducts) {
                    const nameEl = product.querySelector('h1, h2, h3, h4, .product-name, [class*="name"]');
                    if (nameEl && nameEl.textContent.toLowerCase().includes(data.product_name.toLowerCase())) {
                        product.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        product.style.transition = 'all 0.3s ease';
                        product.style.boxShadow = '0 0 30px rgba(139, 92, 246, 0.8)';
                        setTimeout(() => { product.style.boxShadow = ''; }, 2000);
                        break;
                    }
                }
            }
            break;
            
        case 'open_whatsapp':
            const whatsappLink = document.querySelector('[href*="wa.me"], [href*="whatsapp"]');
            if (whatsappLink) {
                window.open(whatsappLink.href, '_blank');
            } else {
                const whatsappBtn = document.getElementById('whatsapp-bubble');
                if (whatsappBtn) whatsappBtn.click();
            }
            break;
            
        case 'open_gallery':
            // For real estate - open property gallery
            if (typeof openPropertyGallery === 'function') {
                openPropertyGallery();
            } else {
                const galleryBtn = document.querySelector('[onclick*="openPropertyGallery"], [onclick*="openGallery"]');
                if (galleryBtn) galleryBtn.click();
            }
            break;
            
        case 'scroll_to_specs':
            // For real estate - scroll to property specs
            const specsSection = document.querySelector('#specs, [id*="spec"], .specs-section, [class*="spec"]');
            if (specsSection) specsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_event_details':
            // For events - scroll to event details
            const eventSection = document.querySelector('#event-details, [id*="event"], .event-section');
            if (eventSection) eventSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'purchase_course':
            // For courses - trigger purchase
            if (data.courseName && data.price && typeof window.purchaseCourse === 'function') {
                window.purchaseCourse(data.courseName, data.price);
            }
            break;
            
        case 'book_appointment':
            // For appointments - trigger booking
            const appointmentForm = document.querySelector('#appointment-form, [id*="appointment"]');
            if (appointmentForm && data.appointmentData) {
                // Fill form fields if available
                const timeInput = appointmentForm.querySelector('[name*="time"], #time');
                const dateInput = appointmentForm.querySelector('[name*="date"], #date');
                if (timeInput) timeInput.value = data.appointmentData.time || '';
                if (dateInput) dateInput.value = data.appointmentData.date || '';
                appointmentForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            break;
            
        case 'scroll_to_appointments':
            const appointmentsSection = document.querySelector('#appointments, [id*="appointment"], .appointments-section');
            if (appointmentsSection) appointmentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'fill_rsvp_form':
            // For events - fill RSVP form
            const rsvpForm = document.querySelector('#rsvp-form, [id*="rsvp"], form');
            if (rsvpForm && data.formData) {
                const nameInput = rsvpForm.querySelector('[name*="name"], #name');
                const phoneInput = rsvpForm.querySelector('[name*="phone"], #phone');
                const guestsInput = rsvpForm.querySelector('[name*="guest"], #guests');
                if (nameInput) nameInput.value = data.formData.name || '';
                if (phoneInput) phoneInput.value = data.formData.phone || '';
                if (guestsInput) guestsInput.value = data.formData.guests || 1;
                rsvpForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            break;
            
        case 'fill_property_lead':
            // For real estate - fill property lead form
            const propertyForm = document.querySelector('#property-lead-form');
            if (propertyForm && data.formData) {
                const nameInput = propertyForm.querySelector('[name="name"]');
                const phoneInput = propertyForm.querySelector('[name="phone"]');
                const emailInput = propertyForm.querySelector('[name="email"]');
                const messageInput = propertyForm.querySelector('[name="message"]');
                if (nameInput) nameInput.value = data.formData.name || '';
                if (phoneInput) phoneInput.value = data.formData.phone || '';
                if (emailInput) emailInput.value = data.formData.email || '';
                if (messageInput) messageInput.value = data.formData.message || '';
                propertyForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            break;
            
        case 'fill_landing_lead':
            // For landing/brand pages - fill lead form
            const leadForm = document.querySelector('#landing-lead-form, #brand-lead-form');
            if (leadForm && data.formData) {
                const nameInput = leadForm.querySelector('[name="name"]');
                const phoneInput = leadForm.querySelector('[name="phone"]');
                const emailInput = leadForm.querySelector('[name="email"]');
                const messageInput = leadForm.querySelector('[name="message"]');
                if (nameInput) nameInput.value = data.formData.name || '';
                if (phoneInput) phoneInput.value = data.formData.phone || '';
                if (emailInput) emailInput.value = data.formData.email || '';
                if (messageInput) messageInput.value = data.formData.message || '';
                leadForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            break;
    }
}

// Make handleBotAction globally available
window.handleBotAction = handleBotAction;

console.log('✅ AI Bot actions handler installed (with ALL page types support)');
</` + `script>
`;
                    if (htmlContent.includes('</body>')) {
                        htmlContent = htmlContent.replace('</body>', botHandler + '</body>');
                    } else {
                        htmlContent += botHandler;
                    }
                    console.log('✅ Bot handler injected!');
                }
                
                return htmlContent;
            }
            
            const pageName = data.title || 'store_' + Date.now();
            
            const storeScript = `
<script>
console.log('Store scripts loaded for: ${pageName}');

let userId = localStorage.getItem('userId') || 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
let storeId = '${pageName}';

// Get page info from URL
let pageFileName = decodeURIComponent(window.location.pathname.split('/').pop());
let pageUserId = window.location.pathname.split('/')[2]; // Extract userId from path /pages/userId/fileName

// Start with empty cart for new page load
let cart = [];
localStorage.setItem('cart_' + storeId, JSON.stringify(cart));

console.log('Store initialized with empty cart:', { pageName: '${pageName}', fileName: pageFileName, userId: pageUserId });

localStorage.setItem('userId', userId);

function updateCartDisplay() {
    cart = JSON.parse(localStorage.getItem('cart_' + storeId) || '[]');
    const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
    
    console.log('Updating cart display. Total items:', cartCount);
    
    // Update ALL cart badges (both ours and N8N's)
    const allBadges = document.querySelectorAll('.cart-count-badge, [class*="badge"], [class*="count"], span[class*="cart"]');
    allBadges.forEach(badge => {
        // Skip if it's inside our sidebar
        if (badge.closest('.cart-sidebar, #cart-sidebar')) {
            return;
        }
        
        badge.textContent = cartCount;
        badge.style.display = cartCount > 0 ? 'flex' : 'none';
        console.log('Updated badge:', badge.className);
    });
    
    // Update our badge
    const cartBadge = document.querySelector('.cart-count-badge');
    if (cartBadge) {
        cartBadge.textContent = cartCount;
        cartBadge.style.display = cartCount > 0 ? 'flex' : 'none';
    }
    
    const cartItems = document.querySelector('.cart-items');
    const cartTotal = document.querySelector('.cart-total');
    
    if (cartItems) {
        if (cart.length === 0) {
            cartItems.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;"><div style="font-size: 48px; margin-bottom: 15px;">🛒</div><div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">העגלה ריקה</div></div>';
        } else {
            const itemsHtml = cart.map(item => {
                const itemTotal = (item.price * item.quantity).toFixed(2);
                return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: white; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">' +
                    '<div style="flex: 1;">' +
                        '<div style="font-weight: bold; color: #333; margin-bottom: 5px; font-size: 16px;">' + item.name + '</div>' +
                        '<div style="color: #666; font-size: 14px;">₪' + item.price + ' x ' + item.quantity + '</div>' +
                    '</div>' +
                    '<div style="font-weight: bold; color: #007bff; font-size: 18px;">₪' + itemTotal + '</div>' +
                '</div>';
            }).join('');
            cartItems.innerHTML = itemsHtml;
            console.log('Cart items updated:', cart.length, 'items');
        }
    }
    
    if (cartTotal) {
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        cartTotal.textContent = '₪' + total;
    }
}

function addToCart(productName, price, image) {
    console.log('addToCart called:', { productName, price, image, storeId });
    
    cart = JSON.parse(localStorage.getItem('cart_' + storeId) || '[]');
    console.log('Current cart:', cart);
    
    const existingItem = cart.find(item => item.name === productName);
    
    if (existingItem) {
        existingItem.quantity += 1;
        console.log('Updated existing item quantity:', existingItem);
    } else {
        const newItem = {
            id: 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            name: productName,
            price: parseFloat(price),
            quantity: 1,
            image: image || ''
        };
        cart.push(newItem);
        console.log('Added new item:', newItem);
    }
    
    localStorage.setItem('cart_' + storeId, JSON.stringify(cart));
    console.log('Cart saved to localStorage');
    
    updateCartDisplay();
    console.log('Cart display updated');
    
    // Open cart sidebar
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    if (cartSidebar) {
        cartSidebar.classList.add('open');
    }
    
    alert(productName + ' נוסף לעגלה!');
}

function quickBuy(productName, price, image) {
    addToCart(productName, price, image);
    const cartSidebar = document.querySelector('.cart-sidebar');
    if (cartSidebar) {
        cartSidebar.classList.add('open');
    }
    setTimeout(() => checkout(), 1000);
}

function checkout() {
    cart = JSON.parse(localStorage.getItem('cart_' + storeId) || '[]');
    if (cart.length === 0) {
        alert('העגלה ריקה');
        return;
    }
    
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    // Show checkout form in the cart sidebar
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    if (!cartSidebar) return;
    
    cartSidebar.innerHTML = \`
        <div style="height: 100%; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                <h3 style="margin: 0; color: #007bff; font-size: 24px;">💳 תשלום</h3>
                <button onclick="cancelCheckout()" style="background: #6c757d; color: white; border: none; font-size: 16px; padding: 8px 16px; border-radius: 6px; cursor: pointer;">חזור</button>
            </div>
            
            <div style="flex: 1; overflow-y: auto;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">סיכום הזמנה</h4>
                    \${cart.map(item => \`
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                            <span>\${item.name} x \${item.quantity}</span>
                            <span style="font-weight: bold;">₪\${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    \`).join('')}
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                        <span>סכום ביניים:</span>
                        <span style="font-weight: bold;">₪\${total.toFixed(2)}</span>
                    </div>
                    <div id="shipping-cost-display" style="display: none; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                        <span>משלוח:</span>
                        <span style="font-weight: bold; color: #007bff;">₪35.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 15px 0 0 0; font-size: 20px; font-weight: bold; color: #28a745;">
                        <span>סה"כ לתשלום:</span>
                        <span id="final-total">₪\${total.toFixed(2)}</span>
                    </div>
                </div>
                
                <form id="checkout-form" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">שם מלא *</label>
                        <input type="text" id="checkout-name" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">טלפון *</label>
                        <input type="tel" id="checkout-phone" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="050-1234567">
                    </div>
                    
                    <div>
                        <label style="display: flex; align-items: center; margin-bottom: 10px; gap: 8px;">
                            <input type="checkbox" id="checkout-shipping" onchange="toggleShipping()" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-weight: bold; color: #333;">משלוח (+ ₪35)</span>
                        </label>
                        <div id="shipping-address" style="display: none;">
                            <input type="text" id="checkout-address" placeholder="רחוב, מספר בית, עיר" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">אמצעי תשלום *</label>
                        <select id="checkout-payment-method" onchange="togglePaymentFields()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="credit">כרטיס אשראי</option>
                            <option value="paypal">PayPal</option>
                            <option value="bit">ביט</option>
                        </select>
                    </div>
                    
                    <div id="credit-card-fields">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">מספר כרטיס אשראי *</label>
                            <input type="text" id="checkout-card" placeholder="1234 5678 9012 3456" maxlength="19" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">תוקף *</label>
                                <input type="text" id="checkout-expiry" placeholder="MM/YY" maxlength="5" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">CVV *</label>
                                <input type="text" id="checkout-cvv" placeholder="123" maxlength="3" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                    </div>
                    
                    <div id="paypal-info" style="display: none; background: #fff3cd; padding: 12px; border-radius: 6px; border: 1px solid #ffc107;">
                        <p style="margin: 0; color: #856404; font-size: 14px;">תועבר לדף PayPal לסיום התשלום</p>
                    </div>
                    
                    <div id="bit-info" style="display: none; background: #d1ecf1; padding: 12px; border-radius: 6px; border: 1px solid #0dcaf0;">
                        <p style="margin: 0; color: #055160; font-size: 14px;">תועבר לאפליקציית ביט לסיום התשלום</p>
                    </div>
                </form>
            </div>
            
            <div style="padding-top: 15px; border-top: 2px solid #dee2e6;">
                <button onclick="processPayment()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                    ✅ אישור תשלום - ₪\${total.toFixed(2)}
                </button>
            </div>
        </div>
    \`;
    
    // Format card number
    const cardInput = document.getElementById('checkout-card');
    if (cardInput) {
        cardInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });
    }
    
    // Format expiry
    const expiryInput = document.getElementById('checkout-expiry');
    if (expiryInput) {
        expiryInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
    }
}

function cancelCheckout() {
    // Return to cart view
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    if (cartSidebar) {
        cartSidebar.innerHTML = \`
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                <h3 style="margin: 0; color: #007bff; font-size: 24px;">🛒 עגלת קניות</h3>
                <button onclick="toggleCart()" style="background: #dc3545; color: white; border: none; font-size: 20px; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">×</button>
            </div>
            <div class="cart-items"></div>
            <div class="cart-total" style="font-weight: bold; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 20px 0; font-size: 18px; color: #007bff;"></div>
            <button onclick="checkout()" style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 16px; font-weight: bold;">💳 המשך לתשלום</button>
            <button onclick="clearCart()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 14px;">🗑️ נקה עגלה</button>
        \`;
        updateCartDisplay();
    }
}

function toggleShipping() {
    const shippingCheckbox = document.getElementById('checkout-shipping');
    const shippingAddress = document.getElementById('shipping-address');
    const shippingCostDisplay = document.getElementById('shipping-cost-display');
    const finalTotal = document.getElementById('final-total');
    
    const cart = JSON.parse(localStorage.getItem('cart_' + storeId) || '[]');
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    if (shippingCheckbox.checked) {
        shippingAddress.style.display = 'block';
        shippingCostDisplay.style.display = 'flex';
        finalTotal.textContent = '₪' + (subtotal + 35).toFixed(2);
    } else {
        shippingAddress.style.display = 'none';
        shippingCostDisplay.style.display = 'none';
        finalTotal.textContent = '₪' + subtotal.toFixed(2);
    }
}

function togglePaymentFields() {
    const paymentMethod = document.getElementById('checkout-payment-method')?.value;
    const creditFields = document.getElementById('credit-card-fields');
    const paypalInfo = document.getElementById('paypal-info');
    const bitInfo = document.getElementById('bit-info');
    
    if (paymentMethod === 'credit') {
        creditFields.style.display = 'block';
        paypalInfo.style.display = 'none';
        bitInfo.style.display = 'none';
    } else if (paymentMethod === 'paypal') {
        creditFields.style.display = 'none';
        paypalInfo.style.display = 'block';
        bitInfo.style.display = 'none';
    } else if (paymentMethod === 'bit') {
        creditFields.style.display = 'none';
        paypalInfo.style.display = 'none';
        bitInfo.style.display = 'block';
    }
}
function processPayment() {
    const name = document.getElementById('checkout-name')?.value;
    const phone = document.getElementById('checkout-phone')?.value;
    const shippingCheckbox = document.getElementById('checkout-shipping')?.checked;
    const address = shippingCheckbox ? document.getElementById('checkout-address')?.value : '';
    const paymentMethod = document.getElementById('checkout-payment-method')?.value;
    
    // Validate required fields
    if (!name || !phone) {
        alert('אנא מלא שם וטלפון');
        return;
    }
    
    if (shippingCheckbox && !address) {
        alert('אנא מלא כתובת למשלוח');
        return;
    }
    
    // Validate payment method fields
    if (paymentMethod === 'credit') {
        const card = document.getElementById('checkout-card')?.value;
        const expiry = document.getElementById('checkout-expiry')?.value;
        const cvv = document.getElementById('checkout-cvv')?.value;
        
        if (!card || !expiry || !cvv) {
            alert('אנא מלא את פרטי כרטיס האשראי');
            return;
        }
    }
    
    cart = JSON.parse(localStorage.getItem('cart_' + storeId) || '[]');
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const shippingCost = shippingCheckbox ? 35 : 0;
    const total = subtotal + shippingCost;
    
    // Show loading
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    cartSidebar.innerHTML = \`
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 20px; animation: spin 1s linear infinite;">⏳</div>
            <h3 style="color: #007bff; margin: 0 0 10px 0;">מעבד תשלום...</h3>
            <p style="color: #666;">אנא המתן</p>
        </div>
        <style>
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        </style>
    \`;
    
    // Record purchase
    const purchaseData = {
        userId: userId,
        storeId: pageFileName,
        pageName: storeId,
        pageOwnerId: pageUserId,
        customerName: name,
        customerPhone: phone,
        customerAddress: address || 'איסוף עצמי',
        shipping: shippingCheckbox,
        shippingCost: shippingCost,
        products: cart,
        subtotal: subtotal,
        total: total,
        paymentMethod: paymentMethod,
        createdAt: new Date().toISOString()
    };
    
    console.log('Recording purchase:', purchaseData);
    
    // Try to send to server
    fetch(window.location.origin + '/api/purchase', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(purchaseData)
    }).then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Server not available');
    })
    .then(data => {
        console.log('Purchase recorded on server:', data);
    })
    .catch(error => {
        console.log('Server not available, saving locally:', error);
        const purchases = JSON.parse(localStorage.getItem('pending_purchases') || '[]');
        purchases.push(purchaseData);
        localStorage.setItem('pending_purchases', JSON.stringify(purchases));
    });
    
    // Show success after 2 seconds
    setTimeout(() => {
        cartSidebar.innerHTML = \`
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
                <div style="font-size: 80px; margin-bottom: 20px; color: #28a745;">✅</div>
                <h3 style="color: #28a745; margin: 0 0 10px 0;">תשלום בוצע בהצלחה!</h3>
                <p style="color: #666; margin-bottom: 30px;">תודה על הקנייה</p>
                <button onclick="closeCartAndReset()" style="padding: 12px 30px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                    סגור
                </button>
            </div>
        \`;
        
        // Clear cart
        localStorage.removeItem('cart_' + storeId);
        
        // Close cart after 3 seconds
        setTimeout(() => {
            closeCartAndReset();
        }, 3000);
    }, 2000);
}

function toggleCart() {
    console.log('toggleCart called');
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    let overlay = document.querySelector('.cart-overlay');
    
    // Create overlay if doesn't exist
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'cart-overlay';
        overlay.onclick = function() {
            toggleCart(); // Close cart when clicking overlay
        };
        document.body.appendChild(overlay);
    }
    
    if (cartSidebar) {
        console.log('Cart sidebar found, toggling...');
        const isOpen = cartSidebar.classList.contains('open');
        
        if (isOpen) {
            // Close cart
            cartSidebar.classList.remove('open');
            overlay.classList.remove('show');
        } else {
            // Open cart
            cartSidebar.classList.add('open');
            overlay.classList.add('show');
        }
        
        console.log('Cart sidebar classes:', cartSidebar.className);
    } else {
        console.error('Cart sidebar not found!');
    }
}

function closeCartAndReset() {
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    const overlay = document.querySelector('.cart-overlay');
    
    if (cartSidebar) {
        cartSidebar.classList.remove('open');
        if (overlay) {
            overlay.classList.remove('show');
        }
        
        // Reset cart content after closing
        setTimeout(() => {
            cartSidebar.innerHTML = \`
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                    <h3 style="margin: 0; color: #007bff; font-size: 24px;">🛒 עגלת קניות</h3>
                    <button onclick="toggleCart()" style="background: #dc3545; color: white; border: none; font-size: 20px; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">×</button>
                </div>
                <div class="cart-items"></div>
                <div class="cart-total" style="font-weight: bold; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 20px 0; font-size: 18px; color: #007bff;"></div>
                <button onclick="checkout()" style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 16px; font-weight: bold;">💳 המשך לתשלום</button>
                <button onclick="clearCart()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 14px;">🗑️ נקה עגלה</button>
            \`;
            updateCartDisplay();
        }, 400);
    }
}

function clearCart() {
    if (confirm('האם אתה בטוח שברצונך לנקות את העגלה?')) {
        localStorage.removeItem('cart_' + storeId);
        updateCartDisplay();
        alert('העגלה נוקתה בהצלחה!');
    }
}

// Make functions globally available IMMEDIATELY
window.addToCart = addToCart;
window.quickBuy = quickBuy;
window.toggleCart = toggleCart;
window.checkout = checkout;
window.clearCart = clearCart;
window.processPayment = processPayment;
window.cancelCheckout = cancelCheckout;
window.closeCartAndReset = closeCartAndReset;
window.toggleShipping = toggleShipping;
window.togglePaymentFields = togglePaymentFields;

console.log('Functions registered globally:', {
    addToCart: typeof window.addToCart,
    quickBuy: typeof window.quickBuy,
    toggleCart: typeof window.toggleCart,
    checkout: typeof window.checkout,
    clearCart: typeof window.clearCart,
    processPayment: typeof window.processPayment,
    cancelCheckout: typeof window.cancelCheckout,
    closeCartAndReset: typeof window.closeCartAndReset
});

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing store...');
    
    // Re-register functions after DOM load (just in case)
    window.addToCart = addToCart;
    window.quickBuy = quickBuy;
    window.toggleCart = toggleCart;
    window.checkout = checkout;
    window.clearCart = clearCart;
    window.processPayment = processPayment;
    window.cancelCheckout = cancelCheckout;
    window.closeCartAndReset = closeCartAndReset;
    window.toggleShipping = toggleShipping;
    window.togglePaymentFields = togglePaymentFields;
    
    // Auto-attach event listeners to ALL buttons and cart icons
    setTimeout(() => {
        console.log('Starting auto-attachment...');
        
        // Find cart icon with class="cart-icon" and attach toggleCart
        const cartIcon = document.querySelector('.cart-icon');
        if (cartIcon) {
            cartIcon.onclick = (e) => {
                e.preventDefault();
                toggleCart();
            };
            cartIcon.style.cursor = 'pointer';
            cartIcon.style.position = 'relative';
            
            // Add badge to cart icon
            if (!cartIcon.querySelector('.cart-count-badge')) {
                const badge = document.createElement('span');
                badge.className = 'cart-count-badge';
                badge.textContent = '0';
                badge.style.display = 'none';
                cartIcon.appendChild(badge);
                console.log('Added badge to cart icon');
            }
            console.log('Cart icon found and connected!');
        } else {
            console.log('No cart icon found with class="cart-icon"');
        }
        
        // Find all product cards and add "Add to Cart" buttons if missing
        const productCards = document.querySelectorAll('[class*="product"], [class*="item"], [class*="card"]');
        console.log('Found potential product cards:', productCards.length);
        
        productCards.forEach((card, idx) => {
            // Check if it looks like a product (has image and price)
            const hasImage = card.querySelector('img');
            const hasPrice = card.textContent.includes('₪');
            
            if (!hasImage || !hasPrice) return;
            
            // Check if it already has an "Add to Cart" button
            const hasButton = Array.from(card.querySelectorAll('button')).some(btn => 
                btn.textContent.includes('הוסף') || btn.textContent.includes('עגלה') || btn.textContent.includes('Add') || btn.onclick
            );
            
            if (hasButton) {
                console.log(\`Product card \${idx} already has button\`);
                return;
            }
            
            // Extract product details
            const nameElement = card.querySelector('h1, h2, h3, h4, h5, h6');
            const productName = nameElement ? nameElement.textContent.trim() : 'מוצר ' + (idx + 1);
            
            const priceMatch = card.textContent.match(/₪\s*(\d+[\d,\.]*)/);
            const price = priceMatch ? parseFloat(priceMatch[1].replace(/,/g, '')) : 99;
            
            const image = card.querySelector('img')?.src || '';
            
            // Add button to card
            const button = document.createElement('button');
            button.textContent = '🛒 הוסף לעגלה';
            button.onclick = () => addToCart(productName, price, image);
            button.style.cssText = 'width: 100%; padding: 12px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);';
            button.onmouseover = () => button.style.transform = 'translateY(-2px)';
            button.onmouseout = () => button.style.transform = 'translateY(0)';
            
            card.appendChild(button);
            console.log(\`Added button to product: \${productName}, ₪\${price}\`);
        });
        
        console.log('Auto-attachment completed!');
    }, 1500);
    
    if (!document.getElementById('cart-sidebar')) {
        const sidebar = document.createElement('div');
        sidebar.id = 'cart-sidebar';
        sidebar.className = 'cart-sidebar';
        sidebar.innerHTML = \`
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                <h3 style="margin: 0; color: #007bff; font-size: 24px;">🛒 עגלת קניות</h3>
                <button onclick="toggleCart()" style="background: #dc3545; color: white; border: none; font-size: 20px; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">×</button>
            </div>
            <div class="cart-items"></div>
            <div class="cart-total" style="font-weight: bold; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 20px 0; font-size: 18px; color: #007bff;"></div>
            <button onclick="checkout()" style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 16px; font-weight: bold;">💳 המשך לתשלום</button>
            <button onclick="clearCart()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 14px;">🗑️ נקה עגלה</button>
        \`;
        document.body.appendChild(sidebar);
    }
    
    // Always create our cart icon if N8N didn't create a working one
    if (!document.querySelector('.cart-icon')) {
        // Create floating cart button
        const cartButton = document.createElement('div');
        cartButton.className = 'cart-icon';
        cartButton.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4); z-index: 1001; transition: all 0.3s;';
        cartButton.innerHTML = \`
            <svg style="width: 30px; height: 30px; fill: white;" viewBox="0 0 24 24">
                <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
            <span class="cart-count-badge" style="position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; border-radius: 50%; min-width: 24px; height: 24px; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">0</span>
        \`;
        cartButton.onclick = toggleCart;
        document.body.appendChild(cartButton);
        console.log('Created floating cart button');
    }
    
    updateCartDisplay();
    console.log('Store initialized successfully!');
});
</` + `script>

<style>
/* === CRITICAL CART STYLES - OVERRIDE ALL THEMES === */
.cart-sidebar, #cart-sidebar {
    position: fixed !important;
    top: 0 !important;
    right: -500px !important;
    width: 450px !important;
    max-width: 90vw !important;
    height: 100vh !important;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
    box-shadow: -5px 0 30px rgba(0,0,0,0.2) !important;
    transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    z-index: 2147483647 !important; /* Maximum z-index */
    padding: 25px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    border-left: 4px solid #007bff !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    direction: rtl !important;
    text-align: right !important;
}

.cart-sidebar.open, #cart-sidebar.open {
    right: 0 !important;
}

/* Cart overlay */
.cart-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.5) !important;
    z-index: 2147483646 !important;
    display: none !important;
    opacity: 0 !important;
    transition: opacity 0.3s ease !important;
}

.cart-overlay.show {
    display: block !important;
    opacity: 1 !important;
}

.cart-icon, [class*="cart-icon"], [id*="cart-icon"] {
    position: relative !important;
    cursor: pointer !important;
    z-index: 999998 !important;
}

.cart-count-badge, [class*="cart-count"], [class*="badge"] {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-width: 22px !important;
    height: 22px !important;
    padding: 0 6px !important;
    background: #dc3545 !important;
    color: white !important;
    border-radius: 11px !important;
    font-size: 12px !important;
    font-weight: bold !important;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4) !important;
    position: absolute !important;
    top: -8px !important;
    left: -8px !important;
}

/* Ensure cart always appears above everything */
.cart-sidebar * {
    box-sizing: border-box !important;
}

/* Remove any modal overlays that might interfere */
body.cart-open::before {
    content: none !important;
}

/* Override any theme-specific modal styles */
.modal, .overlay, .backdrop {
    z-index: 999997 !important;
}
</style>

<script>
// ===============================================
// 🤖 AI BOT ACTIONS HANDLER
// ===============================================
// This script handles actions from the AI bot (n8n webhook responses)
// It listens for bot actions like add_to_cart and executes them

// Monitor all sendAiMessage responses and handle bot actions
if (typeof window.sendAiMessage !== 'undefined') {
    const originalSendAiMessage = window.sendAiMessage;
    window.sendAiMessage = async function(...args) {
        try {
            const result = await originalSendAiMessage.apply(this, args);
            
            // Check if result has an action
            if (result && result.action) {
                console.log('🤖 Bot action detected:', result.action, result);
                handleBotAction(result);
            }
            
            return result;
        } catch (error) {
            console.error('Error in sendAiMessage:', error);
            throw error;
        }
    };
}

// Handle bot actions - FULL VERSION supporting ALL page types
function handleBotAction(data) {
    console.log('🤖 Handling bot action:', data.action);
    
    switch(data.action) {
        case 'add_to_cart':
            if (data.items && Array.isArray(data.items)) {
                console.log('🛒 Adding items from bot:', data.items);
                data.items.forEach(item => {
                    if (item.product_name && item.price) {
                        console.log('➕ Adding:', item.product_name, '₪' + item.price, 'x' + (item.quantity || 1));
                        for (let i = 0; i < (item.quantity || 1); i++) {
                            if (typeof window.addToCart === 'function') {
                                window.addToCart(item.product_name, item.price, item.image || '');
                            }
                        }
                    }
                });
            }
            break;
            
        case 'scroll_to_home':
            window.scrollTo({ top: 0, behavior: 'smooth' });
            break;
            
        case 'scroll_to_about':
            const aboutSection = document.querySelector('#about, [id*="about"], .about-section');
            if (aboutSection) aboutSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_products':
            const productsSection = document.querySelector('#products, [id*="products"], .products-section');
            if (productsSection) productsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_contact':
            const contactSection = document.querySelector('#contact, [id*="contact"], .contact-section');
            if (contactSection) contactSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_testimonials':
            const testimonialsSection = document.querySelector('#testimonials, [id*="testimonial"]');
            if (testimonialsSection) testimonialsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_faq':
            const faqSection = document.querySelector('#faq, [id*="faq"]');
            if (faqSection) faqSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_product':
            if (data.product_name) {
                const allProducts = document.querySelectorAll('.product-card, [class*="product"]');
                for (const product of allProducts) {
                    const nameEl = product.querySelector('h1, h2, h3, h4, .product-name, [class*="name"]');
                    if (nameEl && nameEl.textContent.toLowerCase().includes(data.product_name.toLowerCase())) {
                        product.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        product.style.transition = 'all 0.3s ease';
                        product.style.boxShadow = '0 0 30px rgba(139, 92, 246, 0.8)';
                        setTimeout(() => { product.style.boxShadow = ''; }, 2000);
                        break;
                    }
                }
            }
            break;
            
        case 'open_whatsapp':
            const whatsappLink = document.querySelector('[href*="wa.me"], [href*="whatsapp"]');
            if (whatsappLink) {
                window.open(whatsappLink.href, '_blank');
            } else {
                const whatsappBtn = document.getElementById('whatsapp-bubble');
                if (whatsappBtn) whatsappBtn.click();
            }
            break;
            
        case 'open_gallery':
            if (typeof openPropertyGallery === 'function') {
                openPropertyGallery();
            } else {
                const galleryBtn = document.querySelector('[onclick*="openPropertyGallery"], [onclick*="openGallery"]');
                if (galleryBtn) galleryBtn.click();
            }
            break;
            
        case 'scroll_to_specs':
            const specsSection = document.querySelector('#specs, [id*="spec"], .specs-section, [class*="spec"]');
            if (specsSection) specsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'scroll_to_event_details':
            const eventSection = document.querySelector('#event-details, [id*="event"], .event-section');
            if (eventSection) eventSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'purchase_course':
            if (data.courseName && data.price && typeof window.purchaseCourse === 'function') {
                window.purchaseCourse(data.courseName, data.price);
            }
            break;
            
        case 'book_appointment':
            const appointmentForm = document.querySelector('#appointment-form, [id*="appointment"]');
            if (appointmentForm && data.appointmentData) {
                const timeInput = appointmentForm.querySelector('[name*="time"], #time');
                const dateInput = appointmentForm.querySelector('[name*="date"], #date');
                if (timeInput) timeInput.value = data.appointmentData.time || '';
                if (dateInput) dateInput.value = data.appointmentData.date || '';
                appointmentForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            break;
            
        case 'scroll_to_appointments':
            const appointmentsSection = document.querySelector('#appointments, [id*="appointment"], .appointments-section');
            if (appointmentsSection) appointmentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            break;
            
        case 'fill_rsvp_form':
            const rsvpForm = document.querySelector('#rsvp-form, [id*="rsvp"], form');
            if (rsvpForm && data.formData) {
                const nameInput = rsvpForm.querySelector('[name*="name"], #name');
                const phoneInput = rsvpForm.querySelector('[name*="phone"], #phone');
                const guestsInput = rsvpForm.querySelector('[name*="guest"], #guests');
                if (nameInput) nameInput.value = data.formData.name || '';
                if (phoneInput) phoneInput.value = data.formData.phone || '';
                if (guestsInput) guestsInput.value = data.formData.guests || 1;
                rsvpForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            break;
            
        case 'fill_property_lead':
            // For real estate - fill property lead form
            const propertyForm = document.querySelector('#property-lead-form');
            if (propertyForm && data.formData) {
                const nameInput = propertyForm.querySelector('[name="name"]');
                const phoneInput = propertyForm.querySelector('[name="phone"]');
                const emailInput = propertyForm.querySelector('[name="email"]');
                const messageInput = propertyForm.querySelector('[name="message"]');
                if (nameInput) nameInput.value = data.formData.name || '';
                if (phoneInput) phoneInput.value = data.formData.phone || '';
                if (emailInput) emailInput.value = data.formData.email || '';
                if (messageInput) messageInput.value = data.formData.message || '';
                propertyForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            break;
            
        case 'fill_landing_lead':
            // For landing/brand pages - fill lead form
            const leadForm = document.querySelector('#landing-lead-form, #brand-lead-form');
            if (leadForm && data.formData) {
                const nameInput = leadForm.querySelector('[name="name"]');
                const phoneInput = leadForm.querySelector('[name="phone"]');
                const emailInput = leadForm.querySelector('[name="email"]');
                const messageInput = leadForm.querySelector('[name="message"]');
                if (nameInput) nameInput.value = data.formData.name || '';
                if (phoneInput) phoneInput.value = data.formData.phone || '';
                if (emailInput) emailInput.value = data.formData.email || '';
                if (messageInput) messageInput.value = data.formData.message || '';
                leadForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            break;
    }
}

console.log('✅ AI Bot actions handler installed (UNIVERSAL - supports ALL page types)');
</` + `script>

${data.pageType === 'restaurantMenu' ? '<script src="/restaurant-menu.js"><' + '/script>' : ''}
`;
            
            if (htmlContent.includes('</body>')) {
                htmlContent = htmlContent.replace('</body>', storeScript + '</body>');
            } else {
                htmlContent += storeScript;
            }
            
            return htmlContent;
        }
        
        // Make injectStoreScripts available globally
        window.injectStoreScripts = injectStoreScripts;
        console.log('✅ injectStoreScripts registered globally');
        </script>

</html>