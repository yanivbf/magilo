<!DOCTYPE html>
<!-- The lang and dir attributes will be set dynamically by JavaScript -->

<html lang="he" dir="rtl">
<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Dashboard - Advanced Page Builder Pro</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Frank+Ruhl+Libre:wght@400;700&family=Heebo:wght@400;700&family=Rubik:wght@400;700;900&family=Arimo:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    

    <style>

        /* General Body and Animation Styles */

        html, body { 

            font-family: 'Inter', 'Assistant', sans-serif;
            min-height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;

        }

        .square-container {
            width: 100vh;
            height: 100vh;
            max-width: 100vw;
            max-height: 100vw;
            display: flex;
            flex-direction: column;
            position: relative;
            margin: 0 auto;
        }

        .website-preview {
            height: calc(100vh - 140px);
            background: white;
            margin: 10px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .control-panel {
            height: 120px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            width: calc(100vh - 40px);
            max-width: calc(100vw - 40px);
            position: relative;
            z-index: 10;
        }

        .website-info {
            flex: 1;
            padding-right: 20px;
        }

        .website-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .website-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .website-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #059669;
            background: #d1fae5;
            padding: 4px 8px;
            border-radius: 6px;
            width: fit-content;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: #059669;
            border-radius: 50%;
        }

        .control-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .view { display: none; }

        .view.active { display: block; }

        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }

        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }



        /* Loader Styles */

        .loader { border-top-color: #a78bfa; animation: spin 1s linear infinite; }

        @keyframes spin { to { transform: rotate(360deg); } }

        

        /* Card Styles (Templates & Options) */

        .template-card { 

            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            background-color: white;

            position: relative;

            overflow: hidden;

        }

        .template-card:hover .overlay { opacity: 1; }

        .template-card:hover img { transform: scale(1.05); }

        .template-card img { transition: transform 0.3s ease-in-out; }

        .overlay { transition: opacity 0.3s ease-in-out; }



        .option-card { transition: all 0.3s ease-in-out; }

        .option-card.selected { 

            transform: scale(1.03); 

            box-shadow: 0 0 0 3px #8b5cf6; 

            border-color: #8b5cf6;

        }



        /* AI Assistant Chat Bubble */

        .chat-bubble { 

            max-width: 100%; 

            padding: 12px 18px; 

            border-radius: 20px; 

            line-height: 1.5;

            animation: bubbleIn 0.4s ease-in-out;

            word-wrap: break-word;

            background-color: #eef2ff; 

            color: #4338ca; 

            box-shadow: 0 4px 10px rgba(0,0,0,0.05);

            transition: all 0.3s ease;

        }

        html[dir="rtl"] .chat-bubble { border-bottom-right-radius: 4px; }

        html[dir="ltr"] .chat-bubble { border-bottom-left-radius: 4px; }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-style: italic;
            color: #6b7280;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #8b5cf6;
            animation: bounce 1.4s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { 
                transform: translateY(0); 
            }
            40% { 
                transform: translateY(-10px); 
            }
            60% { 
                transform: translateY(-5px); 
            }
        }

        @keyframes bubbleIn {

            from { opacity: 0; transform: scale(0.8) translateY(10px); }

            to { opacity: 1; transform: scale(1) translateY(0); }

        }



        /* Modal Styles */

        .modal-overlay {

            position: fixed;

            top: 0; left: 0; right: 0; bottom: 0;

            background: rgba(0, 0, 0, 0.5);

            display: flex;

            align-items: center;

            justify-content: center;

            z-index: 1000;

            opacity: 0;

            visibility: hidden;

            transition: opacity 0.3s, visibility 0.3s;

        }

        .modal-overlay.visible { opacity: 1; visibility: visible; }

        .modal-content {

            background: white;

            padding: 2rem;

            border-radius: 1rem;

            box-shadow: 0 10px 25px rgba(0,0,0,0.1);

            text-align: center;

            transform: scale(0.9);

            transition: transform 0.3s;

        }

        .modal-overlay.visible .modal-content { transform: scale(1); }



        /* Form & Editor Styles */

        .form-fieldset {

            border: 1px solid #e5e7eb;

            border-radius: 0.75rem;

            padding: 1.5rem;

            background-color: rgba(255,255,255,0.5);

        }

        .form-legend {

            padding: 0 0.5rem;

            font-weight: 600;

            color: #4c1d95;

        }

        #preview-iframe.editable {

            box-shadow: 0 0 0 4px #8b5cf6;

            border-radius: 8px;

        }

        .color-picker-wrapper { position: relative; }

        .color-picker-input {

            opacity: 0;

            position: absolute;

            top: 0; left: 0;

            width: 100%; height: 100%;

            cursor: pointer;

        }



        /* Generation Loading Animation Styles */

        .gen-view-container { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }

        .gen-loader {

            width: 80px; height: 80px;

            border-radius: 50%;

            perspective: 800px;

        }

        .gen-loader .inner {

            position: absolute;

            box-sizing: border-box;

            width: 100%; height: 100%;

            border-radius: 50%;

        }

        .gen-loader .inner.one {

            left: 0%; top: 0%;

            animation: rotate-one 1.5s linear infinite;

            border-bottom: 3px solid #8b5cf6;

        }

        .gen-loader .inner.two {

            right: 0%; top: 0%;

            animation: rotate-two 1.5s linear infinite;

            border-right: 3px solid #ec4899;

        }

        .gen-loader .inner.three {

            right: 0%; bottom: 0%;

            animation: rotate-three 1.5s linear infinite;

            border-top: 3px solid #3b82f6;

        }

        @keyframes rotate-one { 0% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(0deg); } 100% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(360deg); } }

        @keyframes rotate-two { 0% { transform: rotateX(50deg) rotateY(10deg) rotateZ(0deg); } 100% { transform: rotateX(50deg) rotateY(10deg) rotateZ(360deg); } }

        @keyframes rotate-three { 0% { transform: rotateX(35deg) rotateY(55deg) rotateZ(0deg); } 100% { transform: rotateX(35deg) rotateY(55deg) rotateZ(360deg); } }

        

        .gen-text {

            font-family: 'Heebo', sans-serif;

            font-weight: 600;

            color: #475569;

            margin-top: 2rem;

            min-height: 2em; /* Reserve space for text */
            
            animation: none; /* הסר כל אנימציה מהבהבה */

        }

        

        /* Floating Edit Toolbar */

        #preview-controls-container {

            position: absolute;

            bottom: 1rem;

            left: 50%;

            transform: translateX(-50%);

            z-index: 50;

            display: flex;

            flex-direction: column;

            align-items: center;

            gap: 0.75rem;

        }

        #tools-fab {

            transition: all 0.3s ease-in-out;

            flex-shrink: 0;

        }

        #tools-fab.active {

            transform: rotate(135deg);

            background-color: #be185d; /* Pink */

        }

        #tools-menu {

            display: flex;

            align-items: center;

            gap: 0.75rem;

            transition: all 0.3s ease-in-out;

        }

        #tools-menu:not(.open) {

            opacity: 0;

            transform: translateY(10px) scale(0.95);

            pointer-events: none;

            height: 0;

        }

        #tools-menu.open {

            opacity: 1;

            transform: translateY(0) scale(1);

            pointer-events: auto;

        }

        .tool-btn {

            background-color: rgba(31, 41, 55, 0.8);

            backdrop-filter: blur(8px);

            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);

        }



        /* Language Selector */

        #language-selector-container {

            position: absolute;

            top: 1.5rem;

            inset-inline-end: 1.5rem; /* Replaces right/left for RTL/LTR support */

            z-index: 20;

        }

    </style>

</head>

<body class="bg-gray-100">



    <!-- Modal for general messages -->

    <div id="custom-modal" class="modal-overlay">

        <div class="modal-content">

            <p id="modal-message" class="text-lg text-slate-700 mb-6"></p>

            <button id="modal-close-btn" data-translate-key="modal_close_btn" class="bg-purple-600 text-white font-bold py-2 px-6 hover:bg-purple-700 transition" style="aspect-ratio: 1/1; border-radius: 8px;"></button>

        </div>

    </div>

    

    <!-- Floating AI Assistant Bubble -->

    <div id="assistant-container" class="fixed bottom-6 inset-inline-end-6 z-20 w-80 hidden">

        <div class="flex items-start gap-3">

            <img src="https://placehold.co/48x48/8b5cf6/ffffff?text=AI" alt="Bot Avatar" class="w-12 h-12 rounded-full flex-shrink-0 shadow-lg cursor-pointer" id="assistant-avatar">

            <div id="guidance-bubble" class="chat-bubble hidden"></div>

        </div>

    </div>





    <div class="square-container">



        <!-- Language Selector Dropdown -->
        <div id="language-selector-container" style="position: absolute; top: 10px; right: 10px; z-index: 100;">
            <select id="language-selector" onchange="updatePageLanguage(this.value)" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 p-2 shadow">
                <option value="he">עברית</option>
                <option value="en">English</option>
                <option value="ar">العربية</option>
                <option value="ja">日本語</option>
                <option value="es">Español</option>
                 <option value="fr">Français</option>
                <option value="de">Deutsch</option>
                <option value="ru">Русский</option>
                <option value="zh">中文</option>
            </select>
        </div>



        <!-- Website Preview Area -->
        <div class="website-preview">
            <div id="type-selection-view" class="view active h-full flex flex-col items-center justify-center">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4" data-translate-key="main_title">בניית דף נחיתה מקצועי</h1>
                    <p class="text-gray-600 mb-8" data-translate-key="main_subtitle">צור דף נחיתה מרשים תוך דקות</p>
                    <div id="template-grid" class="grid grid-cols-2 gap-4 max-w-md">
                        <div class="template-card bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow" onclick="selectTemplate('business')">
                            <div class="h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-md mb-3"></div>
                            <h3 class="font-semibold text-gray-800">עסק</h3>
                            <p class="text-sm text-gray-600">דף נחיתה לעסק</p>
                </div>

                        <div class="template-card bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow" onclick="selectTemplate('restaurant')">
                            <div class="h-16 bg-gradient-to-r from-orange-500 to-red-600 rounded-md mb-3"></div>
                            <h3 class="font-semibold text-gray-800">מסעדה</h3>
                            <p class="text-sm text-gray-600">דף נחיתה למסעדה</p>
                </div>

                        <div class="template-card bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow" onclick="selectTemplate('course')">
                            <div class="h-16 bg-gradient-to-r from-green-500 to-teal-600 rounded-md mb-3"></div>
                            <h3 class="font-semibold text-gray-800">קורס</h3>
                            <p class="text-sm text-gray-600">דף נחיתה לקורס</p>
            </div>

                        <div class="template-card bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow" onclick="selectTemplate('real-estate')">
                            <div class="h-16 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-md mb-3"></div>
                            <h3 class="font-semibold text-gray-800">נדלן</h3>
                            <p class="text-sm text-gray-600">דף נחיתה לנדלן</p>
        </div>
                </div>
                                    </div>
                                </div>

            <div id="form-view" class="view h-full flex flex-col items-center justify-center" style="display: none;">
                <div class="text-center w-full max-w-md">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">צור את הדף שלך</h1>
                    <form id="details-form" class="space-y-4">
                                <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">שם העסק</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="הכנס שם העסק">
                                    </div>
                                <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">תיאור קצר</label>
                            <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="תאר את העסק שלך"></textarea>
                                    </div>
                                <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">טלפון</label>
                            <input type="tel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="050-123-4567">
                                    </div>
                        <button type="button" onclick="generatePage()" class="w-full bg-gradient-to-r from-purple-600 to-pink-500 text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-all">
                            צור דף נחיתה
                        </button>
                    </form>
                                </div>
                                    </div>

            <div id="preview-view" class="view h-full">
                <iframe id="preview-iframe" class="w-full h-full border-0" title="Preview"></iframe>
                                </div>
                            </div>
        </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="website-info">
            <div class="website-title">פיצה שף - הפיצה המושלמת שלך</div>
            <div class="website-subtitle">דף נחיתה מקצועי</div>
            <div class="website-status">
                <div class="status-dot"></div>
                <span>מנוי פעיל - האתר זמין לצפייה</span>
                                </div>
                            </div>

        <div class="control-buttons">
            <button class="btn btn-secondary" onclick="viewPage()" id="viewBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
                צפיה
            </button>
            
            <button class="btn btn-primary" onclick="editPage()" id="editBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
                עריכה
            </button>
            
            <button class="btn btn-warning" onclick="activateSubscription()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                הפעלת מנוי
                        </button>

            <button class="btn btn-success" onclick="purchaseLink()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                קנה קישור
            </button>
                    </div>
            </div>















                            </div>

    

    <input type="file" id="iframe-image-uploader" class="hidden" accept="image/*">





    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <script>

        // --- START OF SCRIPT ---
        
        // Simple template selection function
        function selectTemplate(templateType) {
            // Hide type selection view
            document.getElementById('type-selection-view').classList.remove('active');
            document.getElementById('type-selection-view').style.display = 'none';
            
            // Show form view
            document.getElementById('form-view').classList.add('active');
            document.getElementById('form-view').style.display = 'flex';
            
            // Update page type title
            const titles = {
                'business': 'עסק',
                'restaurant': 'מסעדה', 
                'course': 'קורס',
                'real-estate': 'נדלן'
            };
            document.querySelector('#form-view h1').textContent = `צור דף נחיתה - ${titles[templateType]}`;
        }
        
        // Simple form submission
        function generatePage() {
            // Hide form view
            document.getElementById('form-view').classList.remove('active');
            document.getElementById('form-view').style.display = 'none';
            
            // Show preview view with sample content
            document.getElementById('preview-view').classList.add('active');
            document.getElementById('preview-view').style.display = 'block';
            
            // Add sample HTML to iframe
            const iframe = document.getElementById('preview-iframe');
            const sampleHTML = `
                <!DOCTYPE html>
                <html dir="rtl" lang="he">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>דף נחיתה מקצועי</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
                        .container { max-width: 800px; margin: 0 auto; text-align: center; }
                        h1 { font-size: 3rem; margin-bottom: 1rem; }
                        p { font-size: 1.2rem; margin-bottom: 2rem; }
                        .btn { background: white; color: #667eea; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>ברוכים הבאים!</h1>
                        <p>זהו דף נחיתה מקצועי שנוצר עבורכם</p>
                        <button class="btn">התחל עכשיו</button>
            </div>
                </body>
                </html>
            `;
            iframe.srcdoc = sampleHTML;
        }
        
        // Control panel functions
        let isEditMode = false;
        
        function viewPage() {
            // Show preview view
            document.getElementById('preview-view').classList.add('active');
            document.getElementById('preview-view').style.display = 'block';
            
            // Hide form view
            document.getElementById('form-view').classList.remove('active');
            document.getElementById('form-view').style.display = 'none';
            
            // Hide type selection view
            document.getElementById('type-selection-view').classList.remove('active');
            document.getElementById('type-selection-view').style.display = 'none';
            
            // Update button states
            document.getElementById('viewBtn').textContent = 'צפיה';
            document.getElementById('editBtn').textContent = 'עריכה';
            isEditMode = false;
        }
        
        function editPage() {
            if (!isEditMode) {
                // Enter edit mode
                isEditMode = true;
                document.getElementById('editBtn').textContent = 'סיום עריכה';
                document.getElementById('editBtn').style.background = '#dc3545';
                document.getElementById('viewBtn').style.display = 'none';
                
                // Add edit functionality to iframe
                const iframe = document.getElementById('preview-iframe');
                if (iframe) {
                    iframe.classList.add('editable');
                    iframe.style.border = '2px solid #8b5cf6';
                }
                
                alert('מצב עריכה פעיל - לחץ על אלמנטים בדף כדי לערוך אותם');
            } else {
                // Exit edit mode
                isEditMode = false;
                document.getElementById('editBtn').textContent = 'עריכה';
                document.getElementById('editBtn').style.background = '';
                document.getElementById('viewBtn').style.display = 'flex';
                
                // Remove edit functionality from iframe
                const iframe = document.getElementById('preview-iframe');
                if (iframe) {
                    iframe.classList.remove('editable');
                    iframe.style.border = 'none';
                }
                
                alert('מצב עריכה נסגר');
            }
        }
        
        function activateSubscription() {
            alert('הפעלת מנוי...');
        }
        
        function purchaseLink() {
            alert('קניית קישור...');
        }

        

        // --- I18N DATA & CONFIGURATION ---

        const translations = {

            en: {

                main_title: "Hello! What are we building today?",

                main_subtitle: "Choose the base template that best suits your goal.",

                create_page_title: "Create",

                form_subtitle: "Fill in the details and the smart bot will guide you and build a custom page for you.",

                fieldset_basic_details: "Basic Details",

                label_contact_name: "Contact Person / Role",

                label_email: "Contact Email",

                label_phone: "Phone",

                label_description: "General Description",

                label_address: "Physical Address (Optional)",

                fieldset_optional_sections: "Optional Sections",

                fieldset_social_media: "Social Media (Optional)",

                label_youtube_display: "How to display the video?",

                label_youtube_embed: "Embed in page",

                label_youtube_link: "Link only",

                fieldset_design: "Design & Settings",

                label_hero_image: "Main Image Settings",

                label_use_as_background: "Use image as background for the main section",

                note_image_upload: "Note: Personal image upload is done in the editing stage, after page creation.",

                label_additional_settings: "Additional Settings",

                label_add_accessibility: "Add accessibility button to the site",

                label_add_ai_bot: "AI Bot (right) and WhatsApp (left) will appear automatically on all pages",
                label_output_language: "Page Language",

                label_design_style: "Choose a Design Style",

                style_minimalist_pro: "Professional & Clean",

                style_midnight: "Dark & Elegant",

                style_claymorphism: "Claymorphism 3D",

                style_retro_title: "Magazine Headline",

                style_retro: "Retro Magazine",

                style_aurora: "Aurora UI",

                style_bento: "Bento Grid",

                btn_back: "Back",

                btn_generate: "Send to Bot & Build",

                modal_close_btn: "Got it",

                modal_error_style: "Please choose a design style.",

                modal_error_layout: "Please choose a layout for the post.",

                modal_error_clip: "Please choose a clip style.",

                modal_error_edit_mode: "Error: Cannot activate edit mode.",

                modal_error_upload_image: "To replace an image, first click on the image or an area with a background image on the page.",

                modal_error_auth: "You must be logged in to save or upload images.",

                modal_error_save: "Error saving page",

                modal_save_success: "Page saved successfully! Redirecting back to your user area...",

                modal_saving: "Saving...",

                modal_processing_image: "Processing and uploading image...",

                modal_image_success: "Image replaced successfully!",

                modal_image_error: "Error uploading image",

                modal_upload_auth_error: "You must be logged in to upload images.",

                modal_url_error: "Could not get the URL of the uploaded image.",

                gen_text_1: "Our advanced AI system is analyzing your requirements...",

                gen_text_2: "Creating professional code architecture...",

                gen_text_3: "Applying premium design patterns...",

                gen_text_4: "Finalizing your masterpiece...",

                gen_error_title: "Oops, an error occurred",

                gen_error_details: "Error details:",

                tooltip_save_page: "Save Page & Exit",

                tooltip_back_home: "Back to home page",
                tooltip_back_to_form: "Back to form",

                tooltip_upload_image: "Upload/Replace image",

                tooltip_text_color: "Change text color",

                tooltip_bg_color: "Change background color",

                tooltip_opacity: "Background overlay opacity",

            },

            he: {

                main_title: "שלום! מה נבנה היום?",

                main_subtitle: "בחר את תבנית הבסיס המתאימה ביותר למטרה שלך.",

                create_page_title: "יצירת",

                form_subtitle: "מלא את הפרטים והבוט החכם ילווה אותך ויבנה עבורך דף מותאם אישית.",

                fieldset_basic_details: "פרטים בסיסיים",

                label_contact_name: "שם איש קשר / תפקיד",

                label_email: "אימייל ליצירת קשר",

                label_phone: "טלפון",

                label_description: "תיאור כללי",

                label_address: "כתובת פיזית (אופציונלי)",

                fieldset_optional_sections: "מקטעים אופציונליים",

                fieldset_social_media: "מדיה ורשתות חברתיות (אופציונלי)",

                label_youtube_display: "איך להציג את הסרטון?",

                label_youtube_embed: "להטמיע בדף",

                label_youtube_link: "רק קישור",

                fieldset_design: "עיצוב והגדרות",

                label_hero_image: "הגדרות תמונה ראשית",

                label_use_as_background: "השתמש בתמונה כרקע למקטע הראשי",

                note_image_upload: "הערה: העלאת תמונה אישית מתבצעת בשלב העריכה, לאחר יצירת הדף.",

                label_additional_settings: "הגדרות נוספות",

                label_add_accessibility: "הוסף כפתור נגישות לאתר",

                label_add_ai_bot: "AI Bot (ימין) ו-WhatsApp (שמאל) יופיעו אוטומטית בכל הדפים",
                label_output_language: "שפת הדף",

                label_design_style: "בחירת סגנון עיצוב",

                style_minimalist_pro: "מקצועי ונקי",

                style_midnight: "כהה ואלגנטי",

                style_claymorphism: "קליימורפיזם 3D",

                style_retro_title: "כותרת מגזין",

                style_retro: "רטרו מגזין",

                style_aurora: "Aurora UI",

                style_bento: "Bento Grid",

                btn_back: "חזור",

                btn_generate: "שלח לבוט ובנה",

                modal_close_btn: "הבנתי",

                modal_error_style: "אנא בחר סגנון עיצוב.",

                modal_error_layout: "אנא בחר מבנה לפוסט.",

                modal_error_clip: "אנא בחר סגנון חיתוך.",

                modal_error_edit_mode: "שגיאה: לא ניתן להפעיל את מצב העריכה.",

                modal_error_upload_image: "כדי להחליף תמונה, יש ללחוץ תחילה על התמונה או על אזור עם תמונת רקע בעמוד.",

                modal_error_auth: "עליך להיות מחובר כדי לשמור או להעלות תמונות.",

                modal_error_save: "שגיאה בשמירת הדף",

                modal_save_success: "הדף נשמר בהצלחה! מועבר חזרה לאזור המשתמש...",

                modal_saving: "שומר...",

                modal_processing_image: "מעבד ומעלה תמונה...",

                modal_image_success: "התמונה הוחלפה בהצלחה!",

                modal_image_error: "שגיאה בהעלאת התמונה",

                modal_upload_auth_error: "עליך להיות מחובר כדי להעלות תמונות.",

                modal_url_error: "לא ניתן היה לקבל את כתובת התמונה שהועלתה.",

                gen_text_1: "מערכת ה-AI המתקדמת שלנו מנתחת את הדרישות שלך...",

                gen_text_2: "יוצרת ארכיטקטורת קוד מקצועית...",

                gen_text_3: "מיישמת דפוסי עיצוב פרימיום...",

                gen_text_4: "מסיימת את יצירת המופת שלך...",

                gen_error_title: "אופס, התרחשה שגיאה",

                gen_error_details: "פרטי השגיאה:",

                tooltip_save_page: "שמור וצא",

                tooltip_back_home: "חזור לדף הבית",
                tooltip_back_to_form: "חזור לטופס",

                tooltip_upload_image: "העלה/החלף תמונה",

                tooltip_text_color: "שנה צבע טקסט",

                tooltip_bg_color: "שנה צבע רקע",

                tooltip_opacity: "שקיפות שכבת הרקע",

            },

            es: {

                main_title: "¡Hola! ¿Qué construimos hoy?",

                main_subtitle: "Elige la plantilla base que mejor se adapte a tu objetivo.",

                create_page_title: "Crear",

                form_subtitle: "Completa los detalles y el bot inteligente te guiará y construirá una página personalizada para ti.",

                fieldset_basic_details: "Detalles Básicos",

                label_contact_name: "Persona de Contacto / Cargo",

                label_email: "Email de Contacto",

                label_phone: "Teléfono",

                label_description: "Descripción General",

                label_address: "Dirección Física (Opcional)",

                fieldset_optional_sections: "Secciones Opcionales",

                fieldset_social_media: "Redes Sociales (Opcional)",

                label_youtube_display: "¿Cómo mostrar el video?",

                label_youtube_embed: "Incrustar en la página",

                label_youtube_link: "Solo enlace",

                fieldset_design: "Diseño y Ajustes",

                label_hero_image: "Ajustes de Imagen Principal",

                label_use_as_background: "Usar imagen como fondo para la sección principal",

                note_image_upload: "Nota: La carga de imágenes personales se realiza en la etapa de edición, después de la creación de la página.",

                label_additional_settings: "Ajustes Adicionales",

                label_add_accessibility: "Añadir botón de accesibilidad al sitio",

                label_add_ai_bot: "AI Bot (derecha) y WhatsApp (izquierda) aparecerán automáticamente en todas las páginas",
                label_output_language: "Idioma de la Página",

                label_design_style: "Elige un Estilo de Diseño",

                style_minimalist_pro: "Profesional y Limpio",

                style_midnight: "Oscuro y Elegante",

                style_claymorphism: "Claymorphism 3D",

                style_retro_title: "Titular de Revista",

                style_retro: "Revista Retro",

                style_aurora: "UI Aurora",

                style_bento: "Bento Grid",

                btn_back: "Atrás",

                btn_generate: "Enviar al Bot y Construir",

                modal_close_btn: "Entendido",

                modal_error_style: "Por favor, elige un estilo de diseño.",

                modal_error_layout: "Por favor, elige un diseño para la publicación.",

                modal_error_clip: "Por favor, elige un estilo de corte.",

                modal_error_edit_mode: "Error: No se puede activar el modo de edición.",

                modal_error_upload_image: "Para reemplazar una imagen, primero haz clic en la imagen o en un área con una imagen de fondo en la página.",

                 modal_error_auth: "Debes iniciar sesión para guardar o subir imágenes.",

                modal_error_save: "Error al guardar la página",

                modal_save_success: "¡Página guardada con éxito! Redirigiendo a tu área de usuario...",

                modal_saving: "Guardando...",

                modal_processing_image: "Procesando y subiendo imagen...",

                modal_image_success: "¡Imagen reemplazada con éxito!",

                modal_image_error: "Error al subir la imagen",

                modal_upload_auth_error: "Debes iniciar sesión para subir imágenes.",

                modal_url_error: "No se pudo obtener la URL de la imagen subida.",

                gen_text_1: "Analizando solicitud...",

                gen_text_2: "Escribiendo código...",

                gen_text_3: "Diseñando los píxeles...",

                gen_text_4: "Casi terminado...",

                gen_error_title: "Vaya, ocurrió un error",

                gen_error_details: "Detalles del error:",

                tooltip_save_page: "Guardar y Salir",

                tooltip_back_home: "Volver a la página principal",
                tooltip_back_to_form: "Volver al formulario",

                tooltip_upload_image: "Subir/Reemplazar imagen",

                tooltip_text_color: "Cambiar color del texto",

                tooltip_bg_color: "Cambiar color de fondo",

                tooltip_opacity: "Opacidad de la capa de fondo",

            },

            fr: {

                main_title: "Bonjour ! Que construisons-nous aujourd'hui ?",

                main_subtitle: "Choisissez le modèle de base qui correspond le mieux à votre objectif.",

                create_page_title: "Créer",

                form_subtitle: "Remplissez les détails et le bot intelligent vous guidera et construira une page personnalisée pour vous.",

                fieldset_basic_details: "Détails de Base",

                label_contact_name: "Personne à Contacter / Rôle",

                label_email: "E-mail de Contact",

                label_phone: "Téléphone",

                label_description: "Description Générale",

                label_address: "Adresse Physique (Optionnel)",

                fieldset_optional_sections: "Sections Optionnelles",

                fieldset_social_media: "Réseaux Sociaux (Optionnel)",

                label_youtube_display: "Comment afficher la vidéo ?",

                label_youtube_embed: "Intégrer dans la page",

                label_youtube_link: "Lien uniquement",

                fieldset_design: "Design & Paramètres",

                label_hero_image: "Paramètres de l'Image Principale",

                label_use_as_background: "Utiliser l'image comme arrière-plan pour la section principale",

                note_image_upload: "Note : Le téléchargement d'image personnelle se fait à l'étape d'édition, après la création de la page.",

                label_additional_settings: "Paramètres Supplémentaires",

                label_add_accessibility: "Ajouter un bouton d'accessibilité au site",

                label_add_ai_bot: "AI Bot (droite) et WhatsApp (gauche) apparaîtront automatiquement sur toutes les pages",
                label_output_language: "Langue de la Page",

                label_design_style: "Choisissez un Style de Design",

                style_minimalist_pro: "Professionnel & Épuré",

                style_midnight: "Sombre & Élégant",

                style_claymorphism: "Claymorphism 3D",

                style_retro_title: "Titre de Magazine",

                style_retro: "Magazine Rétro",

                style_aurora: "UI Aurora",

                style_bento: "Grille Bento",

                btn_back: "Retour",

                btn_generate: "Envoyer au Bot & Construire",

                modal_close_btn: "J'ai compris",

                modal_error_style: "Veuillez choisir un style de design.",

                modal_error_layout: "Veuillez choisir une mise en page pour la publication.",

                modal_error_clip: "Veuillez choisir un style de découpe.",

                modal_error_edit_mode: "Erreur : Impossible d'activer le mode édition.",

                modal_error_upload_image: "Pour remplacer une image, cliquez d'abord sur l'image ou sur une zone avec une image de fond sur la page.",

                modal_error_auth: "Vous devez être connecté pour enregistrer ou télécharger des images.",

                modal_error_save: "Erreur lors de l'enregistrement de la page",

                modal_save_success: "Page enregistrée avec succès ! Redirection vers votre espace utilisateur...",

                modal_saving: "Enregistrement...",

                modal_processing_image: "Traitement et téléversement de l'image...",

                modal_image_success: "Image remplacée avec succès !",

                modal_image_error: "Erreur lors du téléversement de l'image",

                modal_upload_auth_error: "Vous devez être connecté pour télécharger des images.",

                modal_url_error: "Impossible d'obtenir l'URL de l'image téléchargée.",

                gen_text_1: "Analyse de la demande...",

                gen_text_2: "Écriture du code...",

                gen_text_3: "Conception des pixels...",

                gen_text_4: "Presque terminé...",

                gen_error_title: "Oups, une erreur est survenue",

                gen_error_details: "Détails de l'erreur :",

                tooltip_save_page: "Enregistrer & Quitter",

                tooltip_back_home: "Retour à la page d'accueil",
                tooltip_back_to_form: "Retour au formulaire",

                tooltip_upload_image: "Télécharger/Remplacer l'image",

                tooltip_text_color: "Changer la couleur du texte",

                tooltip_bg_color: "Changer la couleur de fond",

                tooltip_opacity: "Opacité du calque de fond",

            }

        };



        const countries = [

            { name: "Israel (+972)", code: "972" },

            { name: "USA (+1)", code: "1" },

            { name: "UK (+44)", code: "44" },

            { name: "France (+33)", code: "33" },

            { name: "Spain (+34)", code: "34" },

            { name: "Germany (+49)", code: "49" },

        ];



        // --- CORE DATA & CONFIGURATION ---

        const pageTemplates = {

            landing: {

                img: "https://images.unsplash.com/photo-1552664730-d307ca884978?q=80&w=2070&auto=format&fit=crop",

                fields: ['websiteLink'],

                structurePrompt: `Build a landing page with only the following sections, in this order: 1. A simple Header containing the provided external links ('Main Link', 'Additional External Link') as text links or small buttons on the side. 2. Hero Section (id="home") with a headline, description, and a central CTA button. 3. Benefits section (id="benefits") with 3 key benefits. 4. Contact form section (id="contact").`,

                t: {

                    en: { title: "Landing Page", label: "Campaign Name", description: "A focused page for conversions and lead collection.", guidance: "<b>Landing Page</b> is a focused page designed to make a visitor perform a single action, like leaving details or making a purchase." },

                    he: { title: "דף נחיתה", label: "שם הקמפיין", description: "דף ממוקד להמרות ואיסוף לידים.", guidance: "<b>דף נחיתה</b> הוא דף ממוקד שנועד לגרום למבקר לבצע פעולה אחת, כמו השארת פרטים או רכישה." },

                    ar: { title: "صفحة هبوط", label: "اسم الحملة", description: "صفحة مركزة للتحويل وجمع العملاء المحتملين.", guidance: "<b>صفحة الهبوط</b> هي صفحة مركزة مصممة لجعل الزائر يقوم بعمل واحد، مثل ترك التفاصيل أو إجراء عملية شراء." },
                    ja: { title: "ランディングページ", label: "キャンペーン名", description: "コンバージョンとリード収集に焦点を当てたページ。", guidance: "<b>ランディングページ</b>は、訪問者が詳細を残したり購入したりするなどの単一のアクションを実行するよう設計された集中ページです。" },
                    es: { title: "Página de Aterrizaje", label: "Nombre de la Campaña", description: "Una página enfocada en conversiones y captación de leads.", guidance: "Una <b>Página de Aterrizaje</b> es una página enfocada diseñada para que un visitante realice una sola acción, como dejar sus datos o realizar una compra." },

                    fr: { title: "Page d'Atterrissage", label: "Nom de la Campagne", description: "Une page ciblée pour les conversions et la collecte de prospects.", guidance: "Une <b>Page d'Atterrissage</b> est une page ciblée conçue pour inciter un visiteur à effectuer une seule action, comme laisser ses coordonnées ou faire un achat." },
                    de: { title: "Landing Page", label: "Kampagnenname", description: "Eine fokussierte Seite für Konversionen und Lead-Sammlung.", guidance: "Eine <b>Landing Page</b> ist eine fokussierte Seite, die darauf ausgelegt ist, einen Besucher zu einer einzigen Aktion zu veranlassen, wie das Hinterlassen von Details oder einen Kauf." },
                    ru: { title: "Целевая Страница", label: "Название Кампании", description: "Сфокусированная страница для конверсий и сбора лидов.", guidance: "<b>Целевая Страница</b> - это сфокусированная страница, предназначенная для того, чтобы посетитель выполнил одно действие, например, оставил данные или совершил покупку." },
                    zh: { title: "着陆页", label: "活动名称", description: "专注于转化和潜在客户收集的页面。", guidance: "<b>着陆页</b>是一个专注的页面，旨在让访问者执行单一操作，如留下详细信息或进行购买。" }
                }

            },

            general: {

                img: "https://images.unsplash.com/photo-1556761175-5973dc0f32e7?q=80&w=1932&auto=format&fit=crop",

                fields: ['websiteLink'],

                 structurePrompt: `Build a brand page with only the following sections, in this order: 1. Header with a logo and navigation. In the navigation, include internal links to relevant sections (About, Services, Contact) and also the provided external links ('Main Link', 'Additional External Link'). If button text is provided, use it. The external links should be prominent, perhaps as buttons. 2. Hero Section (id="home"). 3. About section (id="about"). 4. Services section (id="services"). 5. Contact section (id="contact"). 6. Footer.`,

                t: {

                    en: { title: "Brand Page", label: "Business Name", description: "Showcase your business to the world.", guidance: "A <b>Brand Page</b> is like your expanded digital business card. Its purpose is to present your business, services, and story professionally." },

                    he: { title: "דף תדמית", label: "שם העסק", description: "הצג את העסק שלך לעולם.", guidance: "<b>דף תדמית</b> הוא כמו כרטיס הביקור הדיגיטלי המורחב שלך. מטרתו להציג את העסק, השירותים והסיפור שלך בצורה מקצועית." },

                    ar: { title: "صفحة العلامة التجارية", label: "اسم العمل", description: "اعرض عملك للعالم.", guidance: "<b>صفحة العلامة التجارية</b> مثل بطاقة العمل الرقمية الموسعة. هدفها هو تقديم عملك وخدماتك وقصتك بشكل مهني." },
                    ja: { title: "ブランドページ", label: "ビジネス名", description: "あなたのビジネスを世界に紹介しましょう。", guidance: "<b>ブランドページ</b>は、拡張されたデジタル名刺のようなものです。その目的は、あなたのビジネス、サービス、ストーリーを専門的に提示することです。" },
                     es: { title: "Página de Marca", label: "Nombre del Negocio", description: "Muestra tu negocio al mundo.", guidance: "Una <b>Página de Marca</b> es como tu tarjeta de visita digital ampliada. Su propósito es presentar tu negocio, servicios e historia de manera profesional." },

                    fr: { title: "Page de Marque", label: "Nom de l'Entreprise", description: "Présentez votre entreprise au monde.", guidance: "Une <b>Page de Marque</b> est comme votre carte de visite numérique étendue. Son but est de présenter votre entreprise, vos services et votre histoire de manière professionnelle." },
                    de: { title: "Markenseite", label: "Geschäftsname", description: "Präsentieren Sie Ihr Geschäft der Welt.", guidance: "Eine <b>Markenseite</b> ist wie Ihre erweiterte digitale Visitenkarte. Ihr Zweck ist es, Ihr Geschäft, Ihre Dienstleistungen und Ihre Geschichte professionell zu präsentieren." },
                    ru: { title: "Страница Бренда", label: "Название Бизнеса", description: "Покажите свой бизнес миру.", guidance: "<b>Страница Бренда</b> - это как ваша расширенная цифровая визитная карточка. Её цель - профессионально представить ваш бизнес, услуги и историю." },
                    zh: { title: "品牌页面", label: "企业名称", description: "向世界展示您的企业。", guidance: "<b>品牌页面</b>就像您扩展的数字名片。它的目的是专业地展示您的企业、服务和故事。" }
                }

            },

            post: {

                img: "https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=2071&auto=format&fit=crop",

                fields: ['postLayout'],

                structurePrompt: {

                    base: `...`, 

                    layouts: {

                       "Partial Cover": `...`,

                       "Full Image Background": `...`,

                       "Bold Poster": `...`,

                    }

                },

                t: {

                    en: { title: "Marketing Post", label: "Post Title", description: "A visual post for social media." },

                    he: { title: "פוסט שיווקי", label: "כותרת הפוסט", description: "פוסט ויזואלי לרשתות חברתיות." },

                    ar: { title: "منشور تسويقي", label: "عنوان المنشور", description: "منشور بصري لوسائل التواصل الاجتماعي." },
                    ja: { title: "マーケティング投稿", label: "投稿タイトル", description: "ソーシャルメディア用のビジュアル投稿。" },
                    es: { title: "Publicación de Marketing", label: "Título de la Publicación", description: "Una publicación visual para redes sociales." },

                    fr: { title: "Publication Marketing", label: "Titre de la Publication", description: "Une publication visuelle pour les réseaux sociaux." },
                    de: { title: "Marketing-Beitrag", label: "Beitragstitel", description: "Ein visueller Beitrag für soziale Medien." },
                    ru: { title: "Маркетинговый Пост", label: "Заголовок Поста", description: "Визуальный пост для социальных сетей." },
                    zh: { title: "营销帖子", label: "帖子标题", description: "用于社交媒体的视觉帖子。" }
                }

            },

            flyer: {

                img: "https://images.unsplash.com/photo-1555939594-58d7cb561ad1?q=80&w=1887&auto=format&fit=crop",

                fields: ['menuItems'],

                structurePrompt: `Build a menu page with the following sections only: 1. Header (id="header") with the business name. 2. Category sections (e.g., 'Appetizers', 'Main Courses') and under each category, a grid of items based on the provided data. 3. Contact details and address as plain text (not links).`,

                t: {

                    en: { title: "Menu / Flyer", label: "Business / Restaurant Name", description: "Display products or dishes visually.", guidance: "A <b>Menu or Flyer</b> is designed to present information clearly and legibly, divided into categories and items." },

                    he: { title: "תפריט / פלאייר", label: "שם העסק / מסעדה", description: "הצג מוצרים או מנות בצורה ויזואלית.", guidance: "<b>תפריט או פלאייר</b> נועד להציג מידע בצורה ברורה וקלה לקריאה, מחולק לקטגוריות ופריטים." },

                    ar: { title: "قائمة / نشرة", label: "اسم العمل / المطعم", description: "اعرض المنتجات أو الأطباق بصرياً.", guidance: "<b>القائمة أو النشرة</b> مصممة لعرض المعلومات بوضوح ومقروئية، مقسمة إلى فئات وعناصر." },
                    ja: { title: "メニュー / チラシ", label: "ビジネス名 / レストラン名", description: "製品や料理を視覚的に表示します。", guidance: "<b>メニューやチラシ</b>は、情報を明確で読みやすく提示するよう設計されており、カテゴリーとアイテムに分かれています。" },
                    es: { title: "Menú / Folleto", label: "Nombre del Negocio / Restaurante", description: "Muestra productos o platos visualmente.", guidance: "Un <b>Menú o Folleto</b> está diseñado para presentar información de forma clara y legible, dividida en categorías y artículos." },

                    fr: { title: "Menu / Flyer", label: "Nom de l'Entreprise / Restaurant", description: "Affichez des produits ou des plats de manière visuelle.", guidance: "Un <b>Menu ou Flyer</b> est conçu pour présenter des informations de manière claire et lisible, divisé en catégories et articles." },
                    de: { title: "Menü / Flyer", label: "Geschäftsname / Restaurantname", description: "Zeigen Sie Produkte oder Gerichte visuell an.", guidance: "Ein <b>Menü oder Flyer</b> ist darauf ausgelegt, Informationen klar und lesbar zu präsentieren, unterteilt in Kategorien und Artikel." },
                    ru: { title: "Меню / Листовка", label: "Название Бизнеса / Ресторана", description: "Визуально отображайте продукты или блюда.", guidance: "<b>Меню или Листовка</b> предназначены для четкого и разборчивого представления информации, разделенной на категории и элементы." },
                    zh: { title: "菜单 / 传单", label: "企业名称 / 餐厅名称", description: "视觉展示产品或菜肴。", guidance: "<b>菜单或传单</b>旨在清晰易读地呈现信息，分为类别和项目。" }
                }

            },

            product: {

                img: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=1999&auto=format&fit=crop",

                fields: ['pricing'],

                structurePrompt: `Build a product page with the following sections only: 1. Main section (id="home") with a product image, name, price, and a purchase button. 2. Detailed description section (id="description").`,

                t: {

                    en: { title: "Product Page", label: "Product Name", description: "Sell a specific product.", guidance: "A <b>Product Page</b> focuses on a single product, showcasing its features and benefits to lead to a purchase." },

                    he: { title: "דף מוצר", label: "שם המוצר", description: "מכור מוצר ספציפי.", guidance: "<b>דף מוצר</b> מתמקד במוצר אחד, מציג את התכונות והתועלות שלו במטרה להוביל לרכישה." },

                    es: { title: "Página de Producto", label: "Nombre del Producto", description: "Vende un producto específico.", guidance: "Una <b>Página de Producto</b> se centra en un solo producto, mostrando sus características y beneficios para conducir a una compra." },

                    fr: { title: "Page Produit", label: "Nom du Produit", description: "Vendez un produit spécifique.", guidance: "Une <b>Page Produit</b> se concentre sur un seul produit, mettant en valeur ses caractéristiques et avantages pour inciter à l'achat." }

                }

            },

            artist: {

                img: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=2070&auto=format&fit=crop",

                fields: ['websiteLink'],

                structurePrompt: `Build an artist page with the following sections only: 1. Header with internal navigation (Biography, Gallery, Contact) and also the provided external links ('Main Link', 'Additional External Link'). 2. Hero Section (id="home") with a picture and the artist's name. 3. Biography section (id="bio"). 4. Works gallery (id="gallery"). 5. Contact details (id="contact").`,

                t: {

                    en: { title: "Artist Page", label: "Artist Name", description: "Promote yourself and your work.", guidance: "An <b>Artist Page</b> is a digital portfolio, showcasing your creations and personal story." },

                    he: { title: "דף אומן", label: "שם האומן", description: "קדם את עצמך ואת היצירה שלך.", guidance: "<b>דף אומן</b> הוא תיק עבודות דיגיטלי, המציג את היצירות שלך ואת הסיפור האישי שלך." },

                    es: { title: "Página de Artista", label: "Nombre del Artista", description: "Promociónate a ti mismo y a tu trabajo.", guidance: "Una <b>Página de Artista</b> es un portafolio digital, que muestra tus creaciones y tu historia personal." },

                    fr: { title: "Page d'Artiste", label: "Nom de l'Artiste", description: "Faites votre promotion et celle de votre travail.", guidance: "Une <b>Page d'Artiste</b> est un portfolio numérique, présentant vos créations et votre histoire personnelle." }

                }

            },

            businessCard: {

                img: "https://images.unsplash.com/photo-1560250097-0b93528c311a?q=80&w=1887&auto=format&fit=crop",

                fields: [],

                structurePrompt: `Build a digital business card designed as a single central card (id="vcard"). It must contain a picture, name, title, short description, and clear action buttons for contact.`,

                t: {

                    en: { title: "Digital Business Card", label: "Your Name", description: "A personal, focused, and impressive page.", guidance: "A <b>Digital Business Card</b> is a simple and focused page, centralizing all your contact methods in one place." },

                    he: { title: "כרטיס ביקור דיגיטלי", label: "השם שלך", description: "דף אישי, ממוקד ומרשים.", guidance: "<b>כרטיס ביקור דיגיטלי</b> הוא דף פשוט וממוקד, המרכז את כל דרכי יצירת הקשר איתך במקום אחד." },

                    es: { title: "Tarjeta de Visita Digital", label: "Tu Nombre", description: "Una página personal, enfocada e impresionante.", guidance: "Una <b>Tarjeta de Visita Digital</b> es una página simple y enfocada, que centraliza todos tus métodos de contacto en un solo lugar." },

                    fr: { title: "Carte de Visite Numérique", label: "Votre Nom", description: "Une page personnelle, ciblée et impressionnante.", guidance: "Une <b>Carte de Visite Numérique</b> est une page simple et ciblée, centralisant toutes vos méthodes de contact en un seul endroit." }

                }

            },

            event: {

                img: "https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?q=80&w=1887&auto=format&fit=crop",

                fields: ['eventDetails'],

                structurePrompt: `Build an event invitation with the following sections: 1. Hero Section (id="home") with the event name and date. 2. Countdown timer (id="countdown-timer") with elements having IDs: days, hours, minutes, seconds. **Very important**: The display order for Hebrew should be right-to-left: days, hours, minutes, seconds. 3. Event details (id="details") with location, time, and additional information. 4. RSVP form (id="rsvp").`,

                t: {

                    en: { title: "Event Invitation", label: "Event Name", description: "Invite people to a special event.", guidance: "An <b>Event Invitation</b> is a page designed to create excitement and provide all important information for an upcoming event." },

                    he: { title: "הזמנה לאירוע", label: "שם האירוע", description: "הזמן אנשים לאירוע מיוחד.", guidance: "<b>הזמנה לאירוע</b> היא דף שנועד לייצר התרגשות ולספק את כל המידע החשוב לקראת אירוע קרוב." },

                    es: { title: "Invitación a Evento", label: "Nombre del Evento", description: "Invita a gente a un evento especial.", guidance: "Una <b>Invitación a Evento</b> es una página diseñada para crear expectación y proporcionar toda la información importante para un próximo evento." },

                    fr: { title: "Invitation à un Événement", label: "Nom de l'Événement", description: "Invitez des personnes à un événement spécial.", guidance: "Une <b>Invitation à un Événement</b> est une page conçue pour susciter l'enthousiasme et fournir toutes les informations importantes pour un événement à venir." }

                }

            },

            course: {

                img: "https://images.unsplash.com/photo-1588072432836-e10032774350?q=80&w=2072&auto=format&fit=crop",

                fields: ['courseDetails', 'websiteLink'],

                structurePrompt: `Build a course page with the following sections: 1. Header with navigation containing the provided external links ('Main Link', 'Additional External Link'). 2. Hero Section (id="home") with the course name and a central promise. 3. Countdown timer (id="countdown-timer") with elements having IDs: days, hours, minutes, seconds. **Very important**: The display order for Hebrew should be right-to-left: days, hours, minutes, seconds. 4. "About the Course" section (id="about") with a detailed description. 5. "About the Instructor" section (id="instructor") with a **circular** image (class="rounded-full"), the instructor's name (from data), and a short description. 6. "Who is this course for" section (id="for-whom"). 7. Course details (id="details") - location. 8. A prominent registration button that leads to the provided registration link.`,

                t: {

                    en: { title: "Course Page", label: "Course Name", description: "Market and register for a course or workshop.", guidance: "A <b>Course Page</b> is designed to market a course or workshop, introduce the instructor, and provide all necessary information for registration." },

                    he: { title: "דף קורס", label: "שם הקורס", description: "שיווק והרשמה לקורס או סדנה.", guidance: "<b>דף קורס</b> נועד לשווק קורס או סדנה, להציג את המרצה, ולספק את כל המידע הדרוש להרשמה." },

                    es: { title: "Página de Curso", label: "Nombre del Curso", description: "Promociona e inscribe a un curso o taller.", guidance: "Una <b>Página de Curso</b> está diseñada para promocionar un curso o taller, presentar al instructor y proporcionar toda la información necesaria para la inscripción." },

                    fr: { title: "Page de Cours", label: "Nom du Cours", description: "Faites la promotion et l'inscription à un cours ou un atelier.", guidance: "Une <b>Page de Cours</b> est conçue pour promouvoir un cours ou un atelier, présenter l'instructeur et fournir toutes les informations nécessaires à l'inscription." }

                }

            },

            portfolio: {

                img: "https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=2070&auto=format&fit=crop",

                fields: ['websiteLink'],

                structurePrompt: "Build a portfolio page with the following sections: 1. Header with navigation. 2. Hero Section (id='home') with a professional statement. 3. 'Featured Projects' section (id='projects') with a visual gallery of works. 4. 'Services' or 'Skills' section (id='skills'). 5. 'About' section (id='about'). 6. Contact section (id='contact').",

                t: {

                    en: { title: "Portfolio", label: "Your Name / Agency Name", description: "Showcase your projects and skills.", guidance: "A <b>Portfolio</b> is where you display your best work, tell your story, and attract new clients." },

                    he: { title: "תיק עבודות", label: "השם שלך / שם הסוכנות", description: "הצג את הפרויקטים והכישורים שלך.", guidance: "<b>תיק עבודות</b> הוא המקום להציג את העבודות הטובות ביותר שלך, לספר על עצמך ולמשוך לקוחות חדשים." },

                    es: { title: "Portafolio", label: "Tu Nombre / Nombre de la Agencia", description: "Muestra tus proyectos y habilidades.", guidance: "Un <b>Portafolio</b> es donde muestras tu mejor trabajo, cuentas tu historia y atraes a nuevos clientes." },

                    fr: { title: "Portfolio", label: "Votre Nom / Nom de l'Agence", description: "Présentez vos projets et vos compétences.", guidance: "Un <b>Portfolio</b> est l'endroit où vous présentez votre meilleur travail, racontez votre histoire et attirez de nouveaux clients." }

                }

            },

            realEstate: {

                img: "https://images.unsplash.com/photo-1560518883-ce09059eeffa?q=80&w=1973&auto=format&fit=crop",

                fields: ['propertyDetails'],

                structurePrompt: "Build a real estate property landing page with the following sections: 1. Hero Section with a primary image of the property, address, and price. 2. Image gallery (id='gallery'). 3. 'Property Description' section (id='description') with marketing text. 4. 'Technical Specs' section (id='specs') showing the number of bedrooms, bathrooms, and square meters/feet. 5. Agent contact section (id='contact').",

                t: {

                    en: { title: "Property for Sale", label: "Property Address", description: "A stunning landing page to sell a real estate property.", guidance: "A <b>Property Page</b> showcases a specific property with all important details: photos, description, technical specs, and agent contact information." },

                    he: { title: "נכס למכירה", label: "כתובת הנכס", description: "דף נחיתה מרהיב למכירת נכס נדל\"ן.", guidance: "<b>דף נכס</b> מציג נכס ספציפי עם כל הפרטים החשובים: תמונות, תיאור, מפרט טכני ופרטי יצירת קשר עם הסוכן." },

                    es: { title: "Propiedad en Venta", label: "Dirección de la Propiedad", description: "Una impresionante página de aterrizaje para vender una propiedad inmobiliaria.", guidance: "Una <b>Página de Propiedad</b> muestra una propiedad específica con todos los detalles importantes: fotos, descripción, especificaciones técnicas e información de contacto del agente." },

                    fr: { title: "Propriété à Vendre", label: "Adresse de la Propriété", description: "Une superbe page de destination pour vendre un bien immobilier.", guidance: "Une <b>Page Propriété</b> présente un bien spécifique avec tous les détails importants : photos, description, spécifications techniques et coordonnées de l'agent." }

                }

            },

            appLaunch: {

                img: "https://images.unsplash.com/photo-1551650975-87deedd944c3?q=80&w=1974&auto=format&fit=crop",

                fields: ['appLinks'],

                structurePrompt: "Build a landing page for an app launch with the following sections: 1. Hero Section (id='home') with the app name, a catchy slogan, and download buttons for the App Store and Google Play. 2. 'Key Features' section (id='features') showcasing 3-4 features with icons. 3. A section displaying screenshots of the app. 4. 'Testimonials' section (id='testimonials'). 5. Contact section (id='contact').",

                t: {

                    en: { title: "App Launch", label: "App Name", description: "Introduce your new app to the world.", guidance: "A <b>Launch Page</b> is an essential tool for marketing a new app, showcasing key features and driving downloads." },

                    he: { title: "השקת אפליקציה", label: "שם האפליקציה", description: "הצג את האפליקציה החדשה שלך לעולם.", guidance: "<b>דף השקה</b> הוא כלי חיוני לשיווק אפליקציה חדשה, המציג את התכונות המרכזיות ומוביל להורדה." },

                    es: { title: "Lanzamiento de App", label: "Nombre de la App", description: "Presenta tu nueva aplicación al mundo.", guidance: "Una <b>Página de Lanzamiento</b> es una herramienta esencial para comercializar una nueva aplicación, mostrando características clave e impulsando las descargas." },

                    fr: { title: "Lancement d'Application", label: "Nom de l'Application", description: "Présentez votre nouvelle application au monde.", guidance: "Une <b>Page de Lancement</b> est un outil essentiel pour commercialiser une nouvelle application, en présentant les fonctionnalités clés et en encourageant les téléchargements." }

                }

            }

        };



        const availableSections = {

            testimonials: {

                icon: "star",

                t: {

                    en: { title: "Testimonials", prompt: "Create a 'Testimonials' section (id='testimonials') with 3 fictitious but believable recommendations, including the recommender's name." },

                    he: { title: "לקוחות ממליצים", prompt: "צור מקטע 'לקוחות ממליצים' (id='testimonials') עם 3 המלצות פיקטיביות אך אמינות, כולל שם הממליץ." },

                    ar: { title: "شهادات العملاء", prompt: "أنشئ قسم 'شهادات العملاء' (id='testimonials') مع 3 توصيات وهمية ولكن معقولة، بما في ذلك اسم الموصي." },

                    es: { title: "Testimonios", prompt: "Crea una sección de 'Testimonios' (id='testimonials') con 3 recomendaciones ficticias pero creíbles, incluyendo el nombre de quien recomienda." },

                    fr: { title: "Témoignages", prompt: "Créez une section 'Témoignages' (id='testimonials') avec 3 recommandations fictives mais crédibles, incluant le nom de la personne qui recommande." }

                }

            },

            gallery: {

                icon: "image",

                 t: {

                    en: { title: "Image Gallery", prompt: "Create an image gallery section (id='gallery') with 6 placeholder images from placehold.co." },

                    he: { title: "גלריית תמונות", prompt: "צור מקטע גלריית תמונות (id='gallery') עם 6 תמונות placeholder מ-placehold.co." },

                    ar: { title: "معرض الصور", prompt: "أنشئ قسم معرض الصور (id='gallery') مع 6 صور مؤقتة من placehold.co." },

                    es: { title: "Galería de Imágenes", prompt: "Crea una sección de galería de imágenes (id='gallery') con 6 imágenes de marcador de posición de placehold.co." },

                    fr: { title: "Galerie d'Images", prompt: "Créez une section de galerie d'images (id='gallery') avec 6 images de substitution de placehold.co." }

                }

            },

            faq: {

                icon: "help-circle",

                 t: {

                    en: { title: "FAQ", prompt: "Create an 'FAQ' section (id='faq') with 4 relevant common questions and short answers." },

                    he: { title: "שאלות ותשובות", prompt: "צור מקטע 'שאלות ותשובות' (id='faq') עם 4 שאלות נפוצות רלוונטיות ותשובות קצרות." },

                    ar: { title: "الأسئلة الشائعة", prompt: "أنشئ قسم 'الأسئلة الشائعة' (id='faq') مع 4 أسئلة شائعة ذات صلة وإجابات قصيرة." },

                    es: { title: "Preguntas Frecuentes", prompt: "Crea una sección de 'Preguntas Frecuentes' (id='faq') con 4 preguntas comunes relevantes y respuestas cortas." },

                    fr: { title: "FAQ", prompt: "Créez une section 'FAQ' (id='faq') avec 4 questions fréquentes pertinentes et des réponses courtes." }

                }

            },

            team: {

                icon: "users",

                t: {

                    en: { title: "Our Team", prompt: "Create an 'Our Team' section (id='team') with 3 fictitious team members, including a picture, name, and role." },

                    he: { title: "הצוות שלנו", prompt: "צור מקטע 'הצוות שלנו' (id='team') עם 3 חברי צוות פיקטיביים, כולל תמונה, שם ותפקיד." },

                    ar: { title: "فريقنا", prompt: "أنشئ قسم 'فريقنا' (id='team') مع 3 أعضاء فريق وهميين، بما في ذلك صورة واسم ودور." },

                    es: { title: "Nuestro Equipo", prompt: "Crea una sección de 'Nuestro Equipo' (id='team') con 3 miembros de equipo ficticios, incluyendo una foto, nombre y cargo." },

                    fr: { title: "Notre Équipe", prompt: "Créez une section 'Notre Équipe' (id='team') avec 3 membres d'équipe fictifs, incluant une photo, un nom et un rôle." }

                }

            },

            pricingTable: {

                icon: "dollar-sign",

                t: {

                    en: { title: "Pricing Table", prompt: "Create a 'Pricing Table' section (id='pricing') with 3 different packages (e.g., Basic, Popular, Premium), including a list of features and a price for each." },

                    he: { title: "טבלת מחירים", prompt: "צור מקטע 'טבלת מחירים' (id='pricing') עם 3 חבילות שונות (לדוגמה: בסיסית, פופולרית, פרימיום), כולל רשימת תכונות ומחיר לכל אחת." },

                    ar: { title: "جدول الأسعار", prompt: "أنشئ قسم 'جدول الأسعار' (id='pricing') مع 3 حزم مختلفة (مثل: أساسية، شائعة، مميزة)، بما في ذلك قائمة بالميزات وسعر لكل منها." },

                    es: { title: "Tabla de Precios", prompt: "Crea una sección de 'Tabla de Precios' (id='pricing') con 3 paquetes diferentes (por ejemplo, Básico, Popular, Premium), incluyendo una lista de características y un precio para cada uno." },

                    fr: { title: "Tableau de Prix", prompt: "Créez une section 'Tableau de Prix' (id='pricing') avec 3 forfaits différents (par exemple, Basique, Populaire, Premium), incluant une liste de fonctionnalités et un prix pour chacun." }

                }

            },

            callToAction: {

                icon: "megaphone",

                t: {

                    en: { title: "Call to Action", prompt: "Create a visually prominent 'Call to Action' section (id='cta') with a different background color, a compelling headline, and a large, clear button." },

                    he: { title: "קריאה לפעולה", prompt: "צור מקטע קריאה לפעולה (id='cta') ויזואלי ובולט, עם רקע בצבע שונה, כותרת משכנעת וכפתור גדול וברור." },

                    ar: { title: "دعوة للعمل", prompt: "أنشئ قسم 'دعوة للعمل' (id='cta') بارز بصريًا بخلفية بلون مختلف وعنوان مقنع وزر كبير وواضح." },

                    es: { title: "Llamada a la Acción", prompt: "Crea una sección de 'Llamada a la Acción' (id='cta') visualmente destacada con un color de fondo diferente, un titular convincente y un botón grande y claro." },

                    fr: { title: "Appel à l'Action", prompt: "Créez une section 'Appel à l'Action' (id='cta') visuellement proéminente avec une couleur de fond différente, un titre convaincant et un bouton grand et clair." }

                }

            }

        };

        

        // --- Supabase Client ---

        const SUPABASE_URL = 'https://osoqfadqohqcauawzmmq.supabase.co';

        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zb3FmYWRxb2hxY2F1YXd6bW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2OTIzMjMsImV4cCI6MjA3MzI2ODMyM30.TBLmKIntYGSfBm2StItfWm87-ebojV_NbaKNcYNWMPg';

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        

        // --- Element Selectors ---

        const ui = {

            typeSelectionView: document.getElementById('type-selection-view'),

            formView: document.getElementById('form-view'),

            previewView: document.getElementById('preview-view'),

            detailsForm: document.getElementById('details-form'),

            pageTypeTitle: document.getElementById('page-type-title'),

            mainNameLabel: document.getElementById('mainNameLabel'),

            dynamicFieldsContainer: document.getElementById('dynamic-fields'),

            optionalSectionsFieldset: document.getElementById('optional-sections-fieldset'),

            socialMediaFieldset: document.getElementById('social-media-fieldset'),

            addressFieldContainer: document.getElementById('address-field-container'),

            accessibilityFieldContainer: document.getElementById('accessibility-field-container'),

            assistantContainer: document.getElementById('assistant-container'),

            assistantAvatar: document.getElementById('assistant-avatar'),

            guidanceBubble: document.getElementById('guidance-bubble'),

            generationView: document.getElementById('generation-view'),

            previewContainer: document.getElementById('preview-container'),

            customModal: document.getElementById('custom-modal'),

            modalMessage: document.getElementById('modal-message'),

            modalCloseBtn: document.getElementById('modal-close-btn'),

            generateBtnText: document.getElementById('button-text'),

            generateBtnLoader: document.getElementById('button-loader'),

            designSelectionContainer: document.querySelector('[data-selection="style"]'),

            designStyleFieldset: document.getElementById('design-style-fieldset'),

            previewIframe: document.getElementById('preview-iframe'),

            backToFormBtn: document.getElementById('back-to-form-btn'),

            toolsFab: document.getElementById('tools-fab'),

            toolsMenu: document.getElementById('tools-menu'),

            savePageBtn: document.getElementById('save-page-btn'),

            downloadPageBtn: document.getElementById('download-page-btn'),
            iframeImageUploader: document.getElementById('iframe-image-uploader'),

            editToolsGroup: document.getElementById('edit-tools-group'),

            uploadImageBtn: document.getElementById('upload-image-btn'),

            textColorPicker: document.getElementById('text-color-picker'),

            bgColorPicker: document.getElementById('bg-color-picker'),

            opacityControl: document.getElementById('opacity-control'),

            opacitySlider: document.getElementById('opacity-slider'),

            templateGrid: document.getElementById('template-grid'),

            languageSelector: document.getElementById('language-selector'),

            countryCodeSelect: document.getElementById('countryCode')

        };

        

        // --- State Variables ---

        let state = {

            selectedPageType: '',

            selectedPageTitle: '',

            selectedStyle: null,

            selectedLayout: null,

            selectedClipStyle: null,

            isEditing: false,

            currentElementToEdit: null,

            elementToModifyForImage: null,

            imageModificationType: null,

            currentOverlayToEdit: null,

            originalDescription: '',

            currentLanguage: 'en'

        };





        // --- Initialization ---

        async function initializeApp() {

            lucide.createIcons();

            populateCountryCodes();

            await handleAuth();

            const userLang = navigator.language.split('-')[0];

            if (translations[userLang]) {

                state.currentLanguage = userLang;

                ui.languageSelector.value = userLang;

            }
            
            // הגדר ברירת מחדל לשפת הפלט - עברית
            const outputLanguageSelect = document.getElementById('outputLanguage');
            if (outputLanguageSelect && !outputLanguageSelect.value) {
                outputLanguageSelect.value = 'he';
            }

            setLanguage(state.currentLanguage);

            bindEventListeners();

        }



        async function handleAuth() {

            const { data: { session }, error } = await sb.auth.getSession();

            if (error) {

                console.error("Error getting session:", error);

                return;

            }

            if (!session) {

                 const { data: anonData, error: anonError } = await sb.auth.signInAnonymously();

                 if (anonError) {

                    console.error("Error signing in anonymously:", anonError);

                    showModal('modal_error_auth');

                 } else {

                    console.log("Signed in anonymously:", anonData.user.id);

                 }

            } else {

                console.log("User session found:", session.user.id);

            }

        }



        // --- I18N Functions ---

        function populateCountryCodes() {

            countries.forEach(country => {

                const option = document.createElement('option');

                option.value = country.code;

                option.textContent = country.name;

                ui.countryCodeSelect.appendChild(option);

            });

            // Set Israel as default

            ui.countryCodeSelect.value = "972";

        }



        function getTranslation(key, lang = state.currentLanguage) {

            const translations = {
                'he': {
                    'modal_close_btn': 'סגור',
                    'main_title': 'יוצר דפי נחיתה מתקדם',
                    'main_subtitle': 'צור דף נחיתה מקצועי תוך דקות עם בוט AI חכם',
                    'create_page_title': 'צור דף',
                    'form_subtitle': 'מלא את הפרטים הבאים',
                    'fieldset_basic_details': 'פרטים בסיסיים',
                    'label_contact_name': 'שם איש קשר',
                    'label_email': 'אימייל',
                    'label_phone': 'טלפון',
                    'label_description': 'תיאור העסק',
                    'label_address': 'כתובת',
                    'fieldset_optional_sections': 'סעיפים אופציונליים',
                    'fieldset_social_media': 'רשתות חברתיות',
                    'label_youtube_display': 'הצגת YouTube',
                    'label_youtube_embed': 'קוד הטמעה',
                    'label_youtube_link': 'קישור',
                    'fieldset_design': 'עיצוב',
                    'label_hero_image': 'תמונת כותרת',
                    'label_use_as_background': 'השתמש כרקע',
                    'note_image_upload': 'העלה תמונה או השאר ריק',
                    'label_additional_settings': 'הגדרות נוספות',
                    'label_output_language': 'שפת הפלט',
                    'label_design_style': 'סגנון עיצוב',
                    'style_minimalist_pro': 'מינימליסטי מקצועי',
                    'style_midnight': 'חצות',
                    'style_claymorphism': 'קליי',
                    'style_retro_title': 'רטרו',
                    'style_retro': 'רטרו',
                    'style_aurora': 'אורורה',
                    'style_bento': 'בנטו',
                    'btn_back': 'חזור',
                    'btn_generate': 'צור דף',
                    'fieldset_external_links': 'קישורים חיצוניים',
                    'label_main_button_text': 'טקסט הכפתור הראשי',
                    'label_main_button_url': 'כתובת הכפתור הראשי',
                    'fieldset_property_details': 'פרטי הנכס',
                    'label_beds': 'חדרי שינה',
                    'label_baths': 'חדרי רחצה',
                    'label_sqft': 'מ״ר',
                    'label_price': 'מחיר',
                    'fieldset_app_links': 'קישורי אפליקציות',
                    'label_app_store_link': 'קישור App Store',
                    'label_google_play_link': 'קישור Google Play'
                },
                'en': {
                    'modal_close_btn': 'Close',
                    'main_title': 'Advanced Landing Page Creator',
                    'main_subtitle': 'Create professional landing pages in minutes with smart AI bot',
                    'create_page_title': 'Create Page',
                    'form_subtitle': 'Fill in the following details',
                    'fieldset_basic_details': 'Basic Details',
                    'label_contact_name': 'Contact Name',
                    'label_email': 'Email',
                    'label_phone': 'Phone',
                    'label_description': 'Business Description',
                    'label_address': 'Address',
                    'fieldset_optional_sections': 'Optional Sections',
                    'fieldset_social_media': 'Social Media',
                    'label_youtube_display': 'YouTube Display',
                    'label_youtube_embed': 'Embed Code',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hero Image',
                    'label_use_as_background': 'Use as Background',
                    'note_image_upload': 'Upload image or leave empty',
                    'label_additional_settings': 'Additional Settings',
                    'label_output_language': 'Output Language',
                    'label_design_style': 'Design Style',
                    'style_minimalist_pro': 'Minimalist Pro',
                    'style_midnight': 'Midnight',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Back',
                    'btn_generate': 'Generate Page',
                    'fieldset_external_links': 'External Links',
                    'label_main_button_text': 'Main Button Text',
                    'label_main_button_url': 'Main Button URL',
                    'fieldset_property_details': 'Property Details',
                    'label_beds': 'Bedrooms',
                    'label_baths': 'Bathrooms',
                    'label_sqft': 'Sq Ft',
                    'label_price': 'Price',
                    'fieldset_app_links': 'App Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link'
                },
                'ar': {
                    'modal_close_btn': 'إغلاق',
                    'main_title': 'منشئ صفحات الهبوط المتقدم',
                    'main_subtitle': 'أنشئ صفحات هبوط احترافية في دقائق مع بوت ذكي',
                    'create_page_title': 'إنشاء صفحة',
                    'form_subtitle': 'املأ التفاصيل التالية',
                    'fieldset_basic_details': 'التفاصيل الأساسية',
                    'label_contact_name': 'اسم جهة الاتصال',
                    'label_email': 'البريد الإلكتروني',
                    'label_phone': 'الهاتف',
                    'label_description': 'وصف العمل',
                    'label_address': 'العنوان',
                    'fieldset_optional_sections': 'الأقسام الاختيارية',
                    'fieldset_social_media': 'وسائل التواصل الاجتماعي',
                    'label_youtube_display': 'عرض YouTube',
                    'label_youtube_embed': 'كود التضمين',
                    'label_youtube_link': 'الرابط',
                    'fieldset_design': 'التصميم',
                    'label_hero_image': 'صورة البطل',
                    'label_use_as_background': 'استخدم كخلفية',
                    'note_image_upload': 'ارفع صورة أو اتركها فارغة',
                    'label_additional_settings': 'إعدادات إضافية',
                    'label_output_language': 'لغة الإخراج',
                    'label_design_style': 'نمط التصميم',
                    'style_minimalist_pro': 'بسيط احترافي',
                    'style_midnight': 'منتصف الليل',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'رجعي',
                    'style_retro': 'رجعي',
                    'style_aurora': 'أورورا',
                    'style_bento': 'بنتو',
                    'btn_back': 'رجوع',
                    'btn_generate': 'إنشاء صفحة',
                    'fieldset_external_links': 'الروابط الخارجية',
                    'label_main_button_text': 'نص الزر الرئيسي',
                    'label_main_button_url': 'رابط الزر الرئيسي',
                    'fieldset_property_details': 'تفاصيل العقار',
                    'label_beds': 'غرف النوم',
                    'label_baths': 'الحمامات',
                    'label_sqft': 'قدم مربع',
                    'label_price': 'السعر',
                    'fieldset_app_links': 'روابط التطبيقات',
                    'label_app_store_link': 'رابط App Store',
                    'label_google_play_link': 'رابط Google Play'
                },
                'ja': {
                    'modal_close_btn': '閉じる',
                    'main_title': '高度なランディングページ作成者',
                    'main_subtitle': 'スマートAIボットで数分でプロフェッショナルなランディングページを作成',
                    'create_page_title': 'ページ作成',
                    'form_subtitle': '以下の詳細を入力してください',
                    'fieldset_basic_details': '基本詳細',
                    'label_contact_name': '連絡先名',
                    'label_email': 'メール',
                    'label_phone': '電話',
                    'label_description': 'ビジネス説明',
                    'label_address': '住所',
                    'fieldset_optional_sections': 'オプションセクション',
                    'fieldset_social_media': 'ソーシャルメディア',
                    'label_youtube_display': 'YouTube表示',
                    'label_youtube_embed': '埋め込みコード',
                    'label_youtube_link': 'リンク',
                    'fieldset_design': 'デザイン',
                    'label_hero_image': 'ヒーロー画像',
                    'label_use_as_background': '背景として使用',
                    'note_image_upload': '画像をアップロードするか空のままにしてください',
                    'label_additional_settings': '追加設定',
                    'label_output_language': '出力言語',
                    'label_design_style': 'デザインスタイル',
                    'style_minimalist_pro': 'ミニマリストプロ',
                    'style_midnight': 'ミッドナイト',
                    'style_claymorphism': 'クレイモーフィズム',
                    'style_retro_title': 'レトロ',
                    'style_retro': 'レトロ',
                    'style_aurora': 'オーロラ',
                    'style_bento': 'ベント',
                    'btn_back': '戻る',
                    'btn_generate': 'ページ生成',
                    'fieldset_external_links': '外部リンク',
                    'label_main_button_text': 'メインボタンテキスト',
                    'label_main_button_url': 'メインボタンURL',
                    'fieldset_property_details': '物件詳細',
                    'label_beds': '寝室',
                    'label_baths': 'バスルーム',
                    'label_sqft': '平方フィート',
                    'label_price': '価格',
                    'fieldset_app_links': 'アプリリンク',
                    'label_app_store_link': 'App Storeリンク',
                    'label_google_play_link': 'Google Playリンク'
                },
                'es': {
                    'modal_close_btn': 'Cerrar',
                    'main_title': 'Creador Avanzado de Páginas de Aterrizaje',
                    'main_subtitle': 'Crea páginas de aterrizaje profesionales en minutos con bot IA inteligente',
                    'create_page_title': 'Crear Página',
                    'form_subtitle': 'Completa los siguientes detalles',
                    'fieldset_basic_details': 'Detalles Básicos',
                    'label_contact_name': 'Nombre de Contacto',
                    'label_email': 'Correo',
                    'label_phone': 'Teléfono',
                    'label_description': 'Descripción del Negocio',
                    'label_address': 'Dirección',
                    'fieldset_optional_sections': 'Secciones Opcionales',
                    'fieldset_social_media': 'Redes Sociales',
                    'label_youtube_display': 'Visualización de YouTube',
                    'label_youtube_embed': 'Código de Integración',
                    'label_youtube_link': 'Enlace',
                    'fieldset_design': 'Diseño',
                    'label_hero_image': 'Imagen Principal',
                    'label_use_as_background': 'Usar como Fondo',
                    'note_image_upload': 'Subir imagen o dejar vacío',
                    'label_additional_settings': 'Configuraciones Adicionales',
                    'label_output_language': 'Idioma de Salida',
                    'label_design_style': 'Estilo de Diseño',
                    'style_minimalist_pro': 'Minimalista Pro',
                    'style_midnight': 'Medianoche',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Atrás',
                    'btn_generate': 'Generar Página',
                    'fieldset_external_links': 'Enlaces Externos',
                    'label_main_button_text': 'Texto del Botón Principal',
                    'label_main_button_url': 'URL del Botón Principal',
                    'fieldset_property_details': 'Detalles de la Propiedad',
                    'label_beds': 'Dormitorios',
                    'label_baths': 'Baños',
                    'label_sqft': 'Pies Cuadrados',
                    'label_price': 'Precio',
                    'fieldset_app_links': 'Enlaces de Aplicaciones',
                    'label_app_store_link': 'Enlace de App Store',
                    'label_google_play_link': 'Enlace de Google Play'
                },
                'fr': {
                    'modal_close_btn': 'Fermer',
                    'main_title': 'Créateur de Pages d\'Atterrissage Avancé',
                    'main_subtitle': 'Créez des pages d\'atterrissage professionnelles en minutes avec un bot IA intelligent',
                    'create_page_title': 'Créer une Page',
                    'form_subtitle': 'Remplissez les détails suivants',
                    'fieldset_basic_details': 'Détails de Base',
                    'label_contact_name': 'Nom du Contact',
                    'label_email': 'Email',
                    'label_phone': 'Téléphone',
                    'label_description': 'Description de l\'Entreprise',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Sections Optionnelles',
                    'fieldset_social_media': 'Réseaux Sociaux',
                    'label_youtube_display': 'Affichage YouTube',
                    'label_youtube_embed': 'Code d\'Intégration',
                    'label_youtube_link': 'Lien',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Image Principale',
                    'label_use_as_background': 'Utiliser comme Arrière-plan',
                    'note_image_upload': 'Télécharger une image ou laisser vide',
                    'label_additional_settings': 'Paramètres Supplémentaires',
                    'label_output_language': 'Langue de Sortie',
                    'label_design_style': 'Style de Design',
                    'style_minimalist_pro': 'Minimaliste Pro',
                    'style_midnight': 'Minuit',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Rétro',
                    'style_retro': 'Rétro',
                    'style_aurora': 'Aurore',
                    'style_bento': 'Bento',
                    'btn_back': 'Retour',
                    'btn_generate': 'Générer Page',
                    'fieldset_external_links': 'Liens Externes',
                    'label_main_button_text': 'Texte du Bouton Principal',
                    'label_main_button_url': 'URL du Bouton Principal',
                    'fieldset_property_details': 'Détails de la Propriété',
                    'label_beds': 'Chambres',
                    'label_baths': 'Salles de Bain',
                    'label_sqft': 'Pieds Carrés',
                    'label_price': 'Prix',
                    'fieldset_app_links': 'Liens d\'Applications',
                    'label_app_store_link': 'Lien App Store',
                    'label_google_play_link': 'Lien Google Play'
                },
                'de': {
                    'modal_close_btn': 'Schließen',
                    'main_title': 'Erweiterter Landing Page Creator',
                    'main_subtitle': 'Erstellen Sie professionelle Landing Pages in Minuten mit intelligentem KI-Bot',
                    'create_page_title': 'Seite Erstellen',
                    'form_subtitle': 'Füllen Sie die folgenden Details aus',
                    'fieldset_basic_details': 'Grundlegende Details',
                    'label_contact_name': 'Kontaktname',
                    'label_email': 'E-Mail',
                    'label_phone': 'Telefon',
                    'label_description': 'Unternehmensbeschreibung',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Optionale Abschnitte',
                    'fieldset_social_media': 'Soziale Medien',
                    'label_youtube_display': 'YouTube-Anzeige',
                    'label_youtube_embed': 'Einbettungscode',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hauptbild',
                    'label_use_as_background': 'Als Hintergrund verwenden',
                    'note_image_upload': 'Bild hochladen oder leer lassen',
                    'label_additional_settings': 'Zusätzliche Einstellungen',
                    'label_output_language': 'Ausgabesprache',
                    'label_design_style': 'Design-Stil',
                    'style_minimalist_pro': 'Minimalistisch Pro',
                    'style_midnight': 'Mitternacht',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Zurück',
                    'btn_generate': 'Seite Generieren',
                    'fieldset_external_links': 'Externe Links',
                    'label_main_button_text': 'Hauptbutton-Text',
                    'label_main_button_url': 'Hauptbutton-URL',
                    'fieldset_property_details': 'Immobiliendetails',
                    'label_beds': 'Schlafzimmer',
                    'label_baths': 'Badezimmer',
                    'label_sqft': 'Quadratfuß',
                    'label_price': 'Preis',
                    'fieldset_app_links': 'App-Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link'
                },
                'ru': {
                    'modal_close_btn': 'Закрыть',
                    'main_title': 'Продвинутый Создатель Лендингов',
                    'main_subtitle': 'Создавайте профессиональные лендинги за минуты с умным ИИ ботом',
                    'create_page_title': 'Создать Страницу',
                    'form_subtitle': 'Заполните следующие детали',
                    'fieldset_basic_details': 'Основные Детали',
                    'label_contact_name': 'Имя Контакта',
                    'label_email': 'Email',
                    'label_phone': 'Телефон',
                    'label_description': 'Описание Бизнеса',
                    'label_address': 'Адрес',
                    'fieldset_optional_sections': 'Дополнительные Секции',
                    'fieldset_social_media': 'Социальные Сети',
                    'label_youtube_display': 'Отображение YouTube',
                    'label_youtube_embed': 'Код Встраивания',
                    'label_youtube_link': 'Ссылка',
                    'fieldset_design': 'Дизайн',
                    'label_hero_image': 'Главное Изображение',
                    'label_use_as_background': 'Использовать как Фон',
                    'note_image_upload': 'Загрузить изображение или оставить пустым',
                    'label_additional_settings': 'Дополнительные Настройки',
                    'label_output_language': 'Язык Вывода',
                    'label_design_style': 'Стиль Дизайна',
                    'style_minimalist_pro': 'Минималистичный Про',
                    'style_midnight': 'Полночь',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Ретро',
                    'style_retro': 'Ретро',
                    'style_aurora': 'Аврора',
                    'style_bento': 'Бенто',
                    'btn_back': 'Назад',
                    'btn_generate': 'Создать Страницу',
                    'fieldset_external_links': 'Внешние Ссылки',
                    'label_main_button_text': 'Текст Главной Кнопки',
                    'label_main_button_url': 'URL Главной Кнопки',
                    'fieldset_property_details': 'Детали Недвижимости',
                    'label_beds': 'Спальни',
                    'label_baths': 'Ванные',
                    'label_sqft': 'Квадратные Футы',
                    'label_price': 'Цена',
                    'fieldset_app_links': 'Ссылки на Приложения',
                    'label_app_store_link': 'Ссылка App Store',
                    'label_google_play_link': 'Ссылка Google Play'
                },
                'zh': {
                    'modal_close_btn': '关闭',
                    'main_title': '高级着陆页创建器',
                    'main_subtitle': '使用智能AI机器人几分钟内创建专业着陆页',
                    'create_page_title': '创建页面',
                    'form_subtitle': '填写以下详细信息',
                    'fieldset_basic_details': '基本详情',
                    'label_contact_name': '联系人姓名',
                    'label_email': '邮箱',
                    'label_phone': '电话',
                    'label_description': '业务描述',
                    'label_address': '地址',
                    'fieldset_optional_sections': '可选部分',
                    'fieldset_social_media': '社交媒体',
                    'label_youtube_display': 'YouTube显示',
                    'label_youtube_embed': '嵌入代码',
                    'label_youtube_link': '链接',
                    'fieldset_design': '设计',
                    'label_hero_image': '主图',
                    'label_use_as_background': '用作背景',
                    'note_image_upload': '上传图片或留空',
                    'label_additional_settings': '其他设置',
                    'label_output_language': '输出语言',
                    'label_design_style': '设计风格',
                    'style_minimalist_pro': '极简专业',
                    'style_midnight': '午夜',
                    'style_claymorphism': '粘土形态',
                    'style_retro_title': '复古',
                    'style_retro': '复古',
                    'style_aurora': '极光',
                    'style_bento': '便当',
                    'btn_back': '返回',
                    'btn_generate': '生成页面',
                    'fieldset_external_links': '外部链接',
                    'label_main_button_text': '主按钮文本',
                    'label_main_button_url': '主按钮URL',
                    'fieldset_property_details': '房产详情',
                    'label_beds': '卧室',
                    'label_baths': '浴室',
                    'label_sqft': '平方英尺',
                    'label_price': '价格',
                    'fieldset_app_links': '应用链接',
                    'label_app_store_link': 'App Store链接',
                    'label_google_play_link': 'Google Play链接'
                }
            };
            
            return translations[lang]?.[key] || translations['en']?.[key] || key;
        }



        function setLanguage(lang) {

            state.currentLanguage = lang;

            document.documentElement.lang = lang;

            document.documentElement.dir = (lang === 'he') ? 'rtl' : 'ltr';

            

            // Apply translations to all static elements

            document.querySelectorAll('[data-translate-key]').forEach(el => {

                const key = el.dataset.translateKey;

                el.textContent = getTranslation(key);

            });

             document.querySelectorAll('[data-translate-title]').forEach(el => {

                const key = el.dataset.translateTitle;

                el.title = getTranslation(key);

            });



            // Repopulate dynamic content

            populateTemplateGrid();



            // If in form view, update dynamic form labels

            if(ui.formView.classList.contains('active') && state.selectedPageType) {

                 const template = pageTemplates[state.selectedPageType].t[state.currentLanguage];

                 ui.pageTypeTitle.textContent = template.title;

                 ui.mainNameLabel.textContent = template.label;

                 createDynamicFields(pageTemplates[state.selectedPageType].fields);

            }

        }

        

        // --- Core Functions ---

        function switchView(hideView, showView) {

            if (showView === ui.formView) {

                ui.assistantContainer.classList.remove('hidden');

                // הסתר כפתורי שמירה והורדה במצב טופס
                ui.savePageBtn.classList.add('hidden');
                ui.downloadPageBtn.classList.add('hidden');
            } else {

                ui.assistantContainer.classList.add('hidden');

                // הצג כפתורי שמירה והורדה במצב תצוגה מקדימה
                ui.savePageBtn.classList.remove('hidden');
                ui.downloadPageBtn.classList.remove('hidden');
            }



            if (hideView === ui.previewView) {

                ui.previewView.classList.remove('active');

            } else {

                hideView.classList.add('fade-out');

            }

            

            setTimeout(() => {

                if (hideView !== ui.previewView) {

                    hideView.classList.remove('active', 'fade-out');

                }

                

                if (showView === ui.previewView) {

                    showView.classList.add('active');

                } else {

                    showView.classList.add('active', 'fade-in');

                }



            }, 300);

        }



        function showModal(messageKey) {

            ui.modalMessage.textContent = getTranslation(messageKey);

            ui.customModal.classList.add('visible');

        }



        function hideModal() {

            ui.customModal.classList.remove('visible');

        }



        function getYoutubeVideoId(url) {

            if (!url) return null;

            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;

            const match = url.match(regExp);

            return (match && match[2].length === 11) ? match[2] : null;

        }



        function createMasterPrompt(data) {

            console.log('createMasterPrompt called with data:', data);
            console.log('data.pageType:', data.pageType);
            console.log('data.outputLanguage:', data.outputLanguage);
            const s = (str) => (str || '').replace(/`/g, "'").replace(/\\/g, '\\\\');

            const templateRoot = pageTemplates[data.pageType];

            const templateLang = templateRoot.t[data.outputLanguage]; // Use OUTPUT language

            console.log('templateRoot:', templateRoot);
            console.log('templateLang:', templateLang);
            
            if (!templateRoot) {
                console.error('templateRoot is null/undefined for pageType:', data.pageType);
                return 'Error: Invalid page type';
            }
            
            if (!templateLang) {
                console.error('templateLang is null/undefined for outputLanguage:', data.outputLanguage);
                return 'Error: Invalid output language';
            }
            const youtubeVideoId = getYoutubeVideoId(data.youtubeLink);

            const cleanYoutubeEmbedUrl = youtubeVideoId ? `https://www.youtube.com/embed/${youtubeVideoId}` : null;

            

            let finalStructurePrompt = templateRoot.structurePrompt;

            

            if (data.pageType === 'post' && typeof finalStructurePrompt === 'object') {

                const postPromptConfig = finalStructurePrompt;

                const layoutInstructions = postPromptConfig.layouts[data.postLayout] || '';

                finalStructurePrompt = postPromptConfig.base.replace('{{LAYOUT_INSTRUCTIONS}}', layoutInstructions);

            }



            const optionalSections = [];

            document.querySelectorAll('input[name="optionalSections"]:checked').forEach(checkbox => {

                const sectionKey = checkbox.value;

                // בדוק אם השפה קיימת, אחרת השתמש באנגלית
                const sectionData = availableSections[sectionKey];
                const langData = sectionData.t[data.outputLanguage] || sectionData.t['en'];
                
                if (langData && langData.prompt) {
                    optionalSections.push(langData.prompt);
                }

            });

            if (optionalSections.length > 0) {

                const additionText = getTranslation('prompt_add_sections_instruction', data.outputLanguage);

                finalStructurePrompt += `\n\n${additionText}\n- ${optionalSections.join('\n- ')}`;

            }

            // הוסף טופס הרשמה חובה
            const contactFormPrompt = `
## Contact Form Section (MANDATORY)
Create a contact form section with ID "contact-form" that includes:
- Name field (required)
- Email field (required) 
- Phone field (optional)
- Message textarea (required)
- Submit button
- Form validation
- Submit to WhatsApp or Email based on user choice

JavaScript functionality:
- Validate required fields
- On submit: Open WhatsApp with pre-filled message OR send email
- Show success/error messages
- Use business contact details from form data`;

            finalStructurePrompt += contactFormPrompt;





            const optionalData = `

* Contact Name: ${s(data.contactName)}

* Email: ${s(data.email)}

* Phone: ${s(data.countryCode)}${s(data.phone)}

* Address: ${s(data.address) || 'Not provided'}

* Main Link (Text & URL): ${s(data.websiteLinkText) || 'Not provided'} - ${s(data.websiteLink) || 'Not provided'}

* Additional External Link (Text & URL): ${s(data.externalLinkText) || 'Not provided'} - ${s(data.externalLink) || 'Not provided'}

* YouTube (Clean Embed URL): ${cleanYoutubeEmbedUrl || 'Not provided'} (Display mode: ${s(data.youtubeDisplayMode) || 'Embed'})

* Facebook: ${s(data.facebookLink) || 'Not provided'}

* Instagram: ${s(data.instagramLink) || 'Not provided'}

* TikTok: ${s(data.tiktokLink) || 'Not provided'}

* Menu Items: ${s(data.menuItems) || 'Not provided'}

* Price: ${s(data.price) || 'Not specified'}

* Payment Link: ${s(data.paymentLink) || 'Not provided'}

`;



            const masterPrompt = `

# Master Task: Create a Creative Agency-Level Digital Asset



## 1. Your Identity: AI Creative Director

You are a creative director, copywriter, and designer. Your mission is to take a brief and turn it into a high-converting digital asset.



## 2. Project Brief

* **Asset Type:** ${s(templateLang.title)}

* **Project/Business Name:** ${s(data.mainName)}

* **Core Message:** "${s(data.description)}"

* **Selected Visual Style:** ${s(data.style)}

* **Use as Background Image preference:** ${data.useAsBackground ? 'Yes' : 'No'}

* **Add Accessibility Button:** ${data.addAccessibility ? 'Yes' : 'No'}

* **Add AI Bot:** ${data.addAiBot ? 'Yes' : 'No'}

* **All additional user data:** ${optionalData}



## 3. Content & Copywriting Task

Based on all data, write full marketing copy for all required sections in the Blueprint. The copy must be written entirely in the requested output language: **${data.language}** (${data.languageName}). 

**CRITICAL**: The ENTIRE page content must be in ${data.languageName} language:
- All headings, titles, and subtitles
- All paragraph text and descriptions  
- All button labels and links
- All form labels and placeholders
- All navigation elements
- All error and success messages
- All tooltips and help text
- All metadata and alt text
- All text overlays on images
- All captions and image descriptions
- All floating elements and widgets text
- All AI bot interface text
- All WhatsApp button text
- All accessibility menu text

**LANGUAGE ENFORCEMENT**: If you generate any text in a different language than ${data.languageName}, the page will be rejected. Every single word, character, and symbol must be in ${data.languageName} language.


## 4. Art Direction Task

* **Main Image Directive:**

  * **If 'Use as Background Image' is 'Yes'**: The main image (from Unsplash) **must** be used as a \`background-image\` for the main Hero section. To ensure readability, you **must** add a separate div element as an overlay with a semi-transparent black background (e.g., \`class="absolute inset-0 bg-black/50 bg-overlay"\`) between the background image and the content. **It is important to add the 'bg-overlay' class**.

  * **If 'Use as Background Image' is 'No'**: Place the image as a standard \`<img>\` element.

* **Default Image:** You must find a suitable, high-quality image from Unsplash.



## 5. Blueprint (Work Plan)

Strictly follow this structure plan. IMPORTANT: The output language must be ${data.language} (${data.languageName}).

**MANDATORY LANGUAGE REQUIREMENTS:**
1. Set HTML lang attribute to "${data.language}"
2. Set HTML dir attribute to "${data.language === 'he' || data.language === 'ar' ? 'rtl' : 'ltr'}"
3. ALL text content must be in ${data.languageName} - NO EXCEPTIONS
4. Do NOT add any language switcher - the page should be in a single language only
5. Ensure ALL text overlays, captions, and image text are in ${data.languageName}
6. Verify that floating widgets (WhatsApp, AI Bot, Accessibility) have text in ${data.languageName}
7. **MANDATORY: Add a contact form section** with the following requirements:
   - Form ID: "contact-form"
   - Fields: Name (required), Email (required), Phone (optional), Message (required)
   - Submit button with text in ${data.languageName}
   - Form must submit to WhatsApp with pre-filled message OR send email
   - Use the business phone number and email from form data
   - Form styling should match the page design
   - Include proper validation and success/error messages
   - For WhatsApp: Use href="https://wa.me/${data.whatsappCountryCode}${data.phone.replace(/[^0-9]/g, '')}?text=שלום, אני [name] - [message]"
   - For Email: Use mailto:${data.email}?subject=פנייה מאתר&body=שם: [name]%0Aטלפון: [phone]%0Aהודעה: [message]
${finalStructurePrompt}



## 6. Technical Checklist

* **Output:** HTML code only.

* **Responsiveness:** Perfect.

* **Links:** All links must work. Phone should link to tel: and WhatsApp. Email to mailto:. External links should open in a new tab (target="_blank").

* **Contact Form:** Must include JavaScript for form submission to WhatsApp or Email:
document.getElementById('contact-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const message = document.getElementById('message').value;
    
    // Validate required fields
    if (!name || !email || !message) {
        alert('אנא מלא את כל השדות החובה');
        return;
    }
    
    // Create message
    const fullMessage = 'שלום, אני ' + name + '\\nאימייל: ' + email + '\\nטלפון: ' + (phone || 'לא צוין') + '\\nהודעה: ' + message;
    
    // Open WhatsApp
    const whatsappUrl = 'https://wa.me/' + ${data.whatsappCountryCode} + ${data.phone.replace(/[^0-9]/g, '')} + '?text=' + encodeURIComponent(fullMessage);
    window.open(whatsappUrl, '_blank');
    
    // Show success message
    alert('ההודעה נשלחה לווטסאפ!');
});

* **Accessibility:** \`alt\` and \`aria-label\` attributes. If the user requested an accessibility button, add it.

* **Accessibility Button:** Always add an accessibility floating button in the center-bottom of the page (position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%)) with blue background (#3B82F6) and clear accessibility icon. Use this wheelchair accessibility SVG icon:
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
    <circle cx="12" cy="12" r="2" fill="white"/>
    <path d="M12 6v6m0 0v6m0-6h6m-6 0H6" stroke="white" stroke-width="2" fill="none"/>
  </svg>
  When clicked, open a menu with all accessibility options (font size, contrast, screen reader, etc.).

* **WhatsApp Bubble:** Always add a WhatsApp floating bubble on the left side of the page (position: fixed; bottom: 20px; left: 20px) with the phone number from the form data. Use green background (#25D366) and clear WhatsApp logo. Make it clickable with href="https://wa.me/[country_code][phone_number]?text=היי, אני מעוניין בשירות" target="_blank" to open WhatsApp directly with the message "היי, אני מעוניין בשירות". Use the full phone number from form data including country code (don't remove country code). Ensure the phone number is properly formatted (remove spaces, dashes, parentheses, and keep only digits, then add country code 972 for Israel). Use this clear WhatsApp SVG icon:
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.893 3.488"/>
  </svg>

* **AI Bot (סתיו):** Always add the AI bot widget on the right side of the page (position: fixed; bottom: 20px; right: 20px) with purple background (#8B5CF6) and clear robot head icon. The bot should introduce itself in the page language:
  - Hebrew (he): "סתיו"
  - Arabic (ar): "ستاف"
  - English (en): "Stav"
  - Spanish (es): "Stav"
  - French (fr): "Stav"
  The bot should help users with questions about the business. Use this clear robot head SVG icon:
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
    <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 6.5V7.5C15 8.33 14.33 9 13.5 9H10.5C9.67 9 9 8.33 9 7.5V6.5L3 7V9L9 8.5V19C9 20.1 9.9 21 11 21H13C14.1 21 15 20.1 15 19V8.5L21 9ZM7.5 11C6.67 11 6 11.67 6 12.5S6.67 14 7.5 14 9 13.33 9 12.5 8.33 11 7.5 11ZM16.5 11C15.67 11 15 11.67 15 12.5S15.67 14 16.5 14 18 13.33 18 12.5 17.33 11 16.5 11Z"/>
    <circle cx="12" cy="12" r="2" fill="white"/>
    <circle cx="12" cy="12" r="1" fill="#8B5CF6"/>
  </svg>
  The bot should be initialized with a \`context\` object containing all page data and must use this info to answer questions. Use this webhook URL for bot communication: https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbkfhkfggyt. Include a complete chat interface that opens when clicked with:
  - Chat window (width: 300px, height: 400px)
  - Message input field at bottom
  - Send button
  - Message history area
  - Close button
  - Smooth animations for open/close
  - **IMPORTANT: Clear chat history when:**
    1. Page is in editing mode (when editor toolbar is visible)
    2. Chat window is closed and reopened
    3. Page is refreshed
  - Use localStorage to store chat state: \`localStorage.setItem('chatHistory_${data.title || 'page'}', JSON.stringify([]))\` to clear history
  - Check for editing mode: \`if (document.querySelector('.editor-toolbar')) { clearChatHistory(); }\`
  - When the chat opens, show initial message based on page language:
    * Hebrew (he): "שלום! אני סתיו, איך אני יכולה לעזור לך?"
    * Arabic (ar): "مرحباً! أنا ستاف، كيف يمكنني مساعدتك؟"
    * English (en): "Hello! I'm Stav, how can I help you?"
    * Spanish (es): "¡Hola! Soy Stav, ¿cómo puedo ayudarte?"
    * French (fr): "Bonjour! Je suis Stav, comment puis-je vous aider?"
  - Typing indicator: Show "סתיו מקלידה..." in page language inside the message history area when waiting for bot response. Use this HTML structure: <div class="typing-indicator">סתיו מקלידה<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>
  - When sending messages, include both page context data and user message in this format:
    {
      "context": {
        "pageTitle": "Page Title",
        "businessName": "Business Name", 
        "description": "Page Description",
        "phone": "Phone Number",
        "email": "Email Address",
        "address": "Physical Address",
        "allPageData": "Complete page information"
      },
      "user_message": "User's message here",
      "business_info": {
        "name": "Business Name from form data",
        "phone": "Full phone number from form data (without country code)", 
        "email": "Email Address from form data",
        "address": "Physical Address from form data"
      }
    }
  - The bot will receive responses in this format:
    { "message": "Bot response text here" }
          - Bot instructions: Always include business information in responses when relevant:
            - Business name: {{ $json.body.business_info.name }}
            - Phone number: {{ $json.body.business_info.phone }} (full number without country code, when asked for contact info)
            - Email address: {{ $json.body.business_info.email }} (when asked for contact info)
            - Physical address: {{ $json.body.business_info.address }} (when asked for location)
            - If you don't have an answer, always recommend contacting the business through the page
          - Default WhatsApp message: When user clicks WhatsApp bubble, send "היי, אני מעוניין בשירות" (this is the default message for all pages)
          - WhatsApp phone number formatting: Extract phone number from form data, remove all non-digit characters (spaces, dashes, parentheses, etc.), then add the appropriate country code based on the selected language. Use country code: ${data.whatsappCountryCode}. Example: "050-123-4567" becomes "${data.whatsappCountryCode}501234567"
          - Default Language: The page should be created in the language selected in the creation interface: ${data.language} (${data.languageName}). ALL content on the page (headings, text, buttons, forms, etc.) should be in this language.
          - Country-specific formatting: Format phone numbers, addresses, and other locale-specific content according to the country: ${data.country}
          - Page Direction: If the default language is Hebrew (he) or Arabic (ar), set the HTML dir attribute to "rtl". For all other languages, set it to "ltr".
          - Complete Translation: The entire page content must be in the selected language, including:
            * All headings and titles
            * All text content
            * All button labels
            * All form labels
            * All placeholder text
            * All error messages
            * All success messages
            * All navigation elements


## 7. Final Command

Your response must contain only HTML code. Start directly with \`<!DOCTYPE html>\`.

`;

            console.log('Generated masterPrompt length:', masterPrompt.length);
            console.log('MasterPrompt preview:', masterPrompt.substring(0, 500) + '...');
            return masterPrompt;

        }



        function populateTemplateGrid() {

            ui.templateGrid.innerHTML = Object.entries(pageTemplates).map(([key, templateData]) => {

                const t = templateData.t[state.currentLanguage]; // Get translated content

                return `

                <div class="template-card rounded-xl shadow-lg cursor-pointer group" data-type="${key}">

                    <img src="${templateData.img}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/94a3b8?text=Image+Not+Found';" alt="Template for ${t.title}" class="w-full h-80 object-cover">

                    <div class="absolute inset-0 bg-black/20 overlay opacity-0 group-hover:opacity-40"></div>

                    <div class="absolute bottom-0 inset-inline-start-0 inset-inline-end-0 p-6 bg-gradient-to-t from-black/80 to-transparent">

                        <h3 class="font-bold text-2xl text-white">${t.title}</h3>

                        <p class="text-white/80 text-sm mt-1">${t.description}</p>

                    </div>

                </div>

            `}).join('');

        }



        function createDynamicFields(fields) {

            // This function creates form fields. Labels and placeholders should be translated.

            const fieldHTML = {

                websiteLink: `

                <fieldset class="form-fieldset" data-field="websiteLink">

                    <legend class="form-legend" data-translate-key="fieldset_external_links"></legend>

                    <div class="space-y-4">

                        <div>

                            <label for="websiteLinkText" class="block text-sm font-medium text-slate-700" data-translate-key="label_main_button_text"></label>

                            <input type="text" name="websiteLinkText" id="websiteLinkText" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md">

                        </div>

                        <div>

                            <label for="websiteLink" class="block text-sm font-medium text-slate-700" data-translate-key="label_main_button_url"></label>

                            <input type="url" name="websiteLink" id="websiteLink" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md">

                        </div>

                    </div>

                </fieldset>`,

                propertyDetails: `

                <fieldset class="form-fieldset" data-field="propertyDetails">

                    <legend class="form-legend" data-translate-key="fieldset_property_details"></legend>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">

                        <div><label for="beds" class="block text-sm font-medium text-slate-700" data-translate-key="label_beds"></label><input type="number" name="beds" id="beds" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                        <div><label for="baths" class="block text-sm font-medium text-slate-700" data-translate-key="label_baths"></label><input type="number" name="baths" id="baths" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                        <div><label for="sqft" class="block text-sm font-medium text-slate-700" data-translate-key="label_sqft"></label><input type="number" name="sqft" id="sqft" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                        <div><label for="price" class="block text-sm font-medium text-slate-700" data-translate-key="label_price"></label><input type="text" name="price" id="price" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                    </div>

                </fieldset>`,

                appLinks: `

                <fieldset class="form-fieldset" data-field="appLinks">

                    <legend class="form-legend" data-translate-key="fieldset_app_links"></legend>

                    <div class="space-y-4">

                        <div><label for="appStoreLink" class="block text-sm font-medium text-slate-700" data-translate-key="label_app_store_link"></label><input type="url" name="appStoreLink" id="appStoreLink" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                        <div><label for="googlePlayLink" class="block text-sm font-medium text-slate-700" data-translate-key="label_google_play_link"></label><input type="url" name="googlePlayLink" id="googlePlayLink" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                    </div>

                </fieldset>`

            };

             ui.dynamicFieldsContainer.innerHTML = fields.map(field => fieldHTML[field] || '').join('');

             // Re-apply translations for any new elements

             ui.dynamicFieldsContainer.querySelectorAll('[data-translate-key]').forEach(el => {

                el.textContent = getTranslation(el.dataset.translateKey);

             });

        }

        

        // --- Event Binding ---

        function bindEventListeners() {

            ui.languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));

            ui.templateGrid.addEventListener('click', handleTemplateSelection);

            ui.detailsForm.addEventListener('submit', handleFormSubmit);

            if (ui.designSelectionContainer) {

                ui.designSelectionContainer.addEventListener('mouseover', handleStyleHover);

                ui.designSelectionContainer.addEventListener('click', handleStyleSelection);

            }

            ui.backToFormBtn.addEventListener('click', () => {

                switchView(ui.previewView, ui.formView);

                if (state.isEditing) toggleEditMode(false); // Force exit edit mode

            });

            ui.toolsFab.addEventListener('click', handleFabClick);

            ui.savePageBtn.addEventListener('click', handleSavePage);

            ui.downloadPageBtn.addEventListener('click', handleBackToHome);
            ui.iframeImageUploader.addEventListener('change', handleImageUpload);

            ui.uploadImageBtn.addEventListener('click', handleUploadBtnClick);

            ui.textColorPicker.addEventListener('input', (e) => { if (state.currentElementToEdit) state.currentElementToEdit.style.color = e.target.value; });

            ui.bgColorPicker.addEventListener('input', (e) => { if (state.currentElementToEdit) state.currentElementToEdit.style.backgroundColor = e.target.value; });

            ui.opacitySlider.addEventListener('input', (e) => { if(state.currentOverlayToEdit) state.currentOverlayToEdit.style.backgroundColor = `rgba(0, 0, 0, ${e.target.value})`; });

            ui.modalCloseBtn.addEventListener('click', hideModal);

            ui.customModal.addEventListener('click', (e) => { if (e.target === ui.customModal) hideModal(); });

            document.getElementById('back-to-type-btn').addEventListener('click', () => switchView(ui.formView, ui.typeSelectionView));

            ui.formView.addEventListener('focusin', (e) => {

                if (e.target.dataset.guidanceKey) {

                    ui.guidanceBubble.innerHTML = getTranslation(e.target.dataset.guidanceKey);

                    ui.guidanceBubble.classList.remove('hidden');

                }

            });

            ui.assistantAvatar.addEventListener('click', () => {

                ui.guidanceBubble.classList.toggle('hidden');

            });

        }



        // --- Event Handlers ---

        function handleTemplateSelection(event) {

            const card = event.target.closest('.template-card');

            if (!card) return;



            state.selectedPageType = card.dataset.type;

            const template = pageTemplates[state.selectedPageType].t[state.currentLanguage];

            

            state.selectedPageTitle = template.title;

            ui.pageTypeTitle.textContent = template.title;

            ui.mainNameLabel.textContent = template.label;

            ui.guidanceBubble.innerHTML = template.guidance;

            ui.guidanceBubble.classList.remove('hidden');



            createDynamicFields(pageTemplates[state.selectedPageType].fields);

            

            const showExtraSections = !['flyer', 'post', 'businessCard', 'event'].includes(state.selectedPageType);

            const showDesignStyle = true; 

            const showAccessibilityOption = !['flyer', 'post'].includes(state.selectedPageType);



            ui.socialMediaFieldset.style.display = showExtraSections ? 'block' : 'none';

            ui.optionalSectionsFieldset.style.display = showExtraSections ? 'block' : 'none';

            ui.designStyleFieldset.style.display = showDesignStyle ? 'block' : 'none';

            ui.addressFieldContainer.style.display = showExtraSections ? 'block' : 'none';

            

            const accessibilityContainer = document.getElementById('accessibility-field-container');

            if(accessibilityContainer) {

                 accessibilityContainer.style.display = showAccessibilityOption ? 'block' : 'none';

            }





            if (showExtraSections) {

                const optionsGrid = ui.optionalSectionsFieldset.querySelector('.grid');

                optionsGrid.innerHTML = Object.entries(availableSections).map(([key, sectionData]) => {

                     const section = sectionData.t[state.currentLanguage];

                     return `

                    <div class="flex items-center">

                        <input id="section-${key}" name="optionalSections" type="checkbox" value="${key}" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-600">

                        <label for="section-${key}" class="ms-2 block text-sm text-gray-900">${section.title}</label>

                    </div>

                `}).join('');

            }



            switchView(ui.typeSelectionView, ui.formView);

        }



        function handleStyleHover(event) {

            const card = event.target.closest('.option-card');

            if (card && card.dataset.guidanceKey) {

                ui.guidanceBubble.innerHTML = getTranslation(card.dataset.guidanceKey);

                ui.guidanceBubble.classList.remove('hidden');

            }

        }



        function handleStyleSelection(event) {

            const selectedCard = event.target.closest('.option-card');

            if (!selectedCard) return;

            ui.designSelectionContainer.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));

            selectedCard.classList.add('selected');

            state.selectedStyle = selectedCard.dataset.value;

        }



        async function handleFormSubmit(event) {

            event.preventDefault();

            if (!state.selectedStyle) {

                showModal('modal_error_style');

                return;

            }

            

            setLoading(true);



            const formData = new FormData(ui.detailsForm);

            let data = Object.fromEntries(formData.entries());

            // נגישות, AI Bot ו-WhatsApp תמיד מופיעים
            data.addAccessibility = true;
            data.addAiBot = true;
            data.useAsBackground = document.getElementById('use-as-background').checked;

            data.style = state.selectedStyle;

            data.pageType = state.selectedPageType;

            state.originalDescription = data.description;

            
            // הוסף נתוני שפה ומדינה
            data = addLanguageToPageData(data);
            

            const masterPrompt = createMasterPrompt(data);

            

            switchView(ui.formView, ui.previewView);



            try {

                const htmlContent = await generateHtmlFromApi(masterPrompt);

                const finalHtml = htmlContent;
                

                ui.previewIframe.srcdoc = finalHtml;

                ui.previewIframe.onload = () => {

                    ui.previewContainer.classList.remove('hidden');

                    ui.generationView.classList.add('hidden');

                    ui.toolsFab.classList.remove('hidden');

                    ui.toolsFab.classList.remove('active');

                    ui.toolsMenu.classList.remove('open');

                };

            } catch (error) {

                console.error('Error generating page:', error);

                ui.generationView.innerHTML = `<div class="text-center p-8"><h2 class="text-2xl font-semibold text-red-500">${getTranslation('gen_error_title')}</h2><p class="text-slate-600 mt-2">${getTranslation('gen_error_details')}</p><pre class="mt-2 text-left text-xs bg-slate-100 p-2 rounded text-slate-500 whitespace-pre-wrap">${error.message}</pre></div>`;

            } finally {

                setLoading(false);

            }

        }

        

        async function generateHtmlFromApi(prompt) {

             const N8N_GENERATE_URL = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhfaadsgdrghre546yrthfg';

             const payload = { masterPrompt: prompt };

             
             console.log('Sending request to webhook:', N8N_GENERATE_URL);
             console.log('Payload:', payload);
             

             try {

                 // יצירת AbortController עם timeout של 5 דקות
                 const controller = new AbortController();
                 const timeoutId = setTimeout(() => controller.abort(), 5 * 60 * 1000); // 5 דקות

                 const response = await fetch(N8N_GENERATE_URL, {

                     method: 'POST',

                     headers: { 'Content-Type': 'application/json' },

                     body: JSON.stringify(payload),
                     
                     signal: controller.signal

                 });
                 
                 clearTimeout(timeoutId);

                 
                 console.log('Webhook response status:', response.status);
                 console.log('Webhook response ok:', response.ok);


                 const responseText = await response.text();

                 console.log('Webhook response text length:', responseText.length);
                 console.log('Webhook response preview:', responseText.substring(0, 200) + '...');
                 

                 if (!response.ok) {

                     console.error('Webhook error:', response.status, responseText);
                     
                     // הצג הודעת שגיאה ידידותית למשתמש
                     ui.generationView.innerHTML = `
                         <div class="max-w-2xl mx-auto text-center">
                             <div class="mb-8">
                                 <h2 class="text-3xl font-bold text-red-400 mb-4">⚠️ בעיה טכנית</h2>
                                 <p class="text-gray-300 text-lg">השרת שלנו כרגע עמוס, אנא נסה שוב בעוד כמה דקות</p>
                             </div>
                             <div class="bg-red-500/20 backdrop-blur-sm rounded-xl p-6">
                                 <p class="text-red-300 font-medium">שגיאה ${response.status}: השרת לא זמין כרגע</p>
                             </div>
                             <div class="mt-6">
                                 <button onclick="window.location.reload()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                     נסה שוב
                                 </button>
                             </div>
                         </div>
                     `;
                     
                     throw new Error(`Server Error (${response.status}): ${responseText}`);

                 }



                 function findHtml(obj) {

                    for (const key in obj) {

                        if (typeof obj[key] === 'string' && (obj[key].trim().startsWith('<!DOCTYPE html') || obj[key].trim().startsWith('<html') || obj[key].trim().startsWith('```html'))) {

                            return obj[key].replace(/^```html\s*/, '').replace(/```$/, '').trim();

                        }

                        if (typeof obj[key] === 'object' && obj[key] !== null) {

                            const result = findHtml(obj[key]);

                            if (result) return result;

                        }

                    }

                    return null;

                 }

                

                 try {

                    const responseData = JSON.parse(responseText);

                    const html = findHtml(responseData);

                    if (html) return html;

                 } catch (e) {

                    if (responseText.trim().startsWith('<!DOCTYPE html') || responseText.trim().startsWith('<html')) {

                        return responseText;

                    }

                 }

                 

                 throw new Error("Could not find valid HTML in the server response.");



             } catch (error) {

                 console.error("Error in generateHtmlFromApi:", error);
                 console.error('Error details:', error.message);
                 console.error('Error stack:', error.stack);
                 
                 // בדוק אם זה timeout
                 if (error.name === 'AbortError') {
                     ui.generationView.innerHTML = `
                         <div class="max-w-2xl mx-auto text-center">
                             <div class="mb-8">
                                 <h2 class="text-3xl font-bold text-yellow-400 mb-4">⏰ זה לוקח זמן רב</h2>
                                 <p class="text-gray-300 text-lg">השרת שלנו עובד על הדף שלך, אבל זה לוקח יותר זמן מהרגיל</p>
                             </div>
                             <div class="bg-yellow-500/20 backdrop-blur-sm rounded-xl p-6">
                                 <p class="text-yellow-300 font-medium">המתן עוד כמה דקות או נסה שוב</p>
                             </div>
                             <div class="mt-6">
                                 <button onclick="window.location.reload()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                     נסה שוב
                                 </button>
                             </div>
                         </div>
                     `;
                 } else {
                     // הצג הודעת שגיאה ידידותית למשתמש
                     ui.generationView.innerHTML = `
                         <div class="max-w-2xl mx-auto text-center">
                             <div class="mb-8">
                                 <h2 class="text-3xl font-bold text-red-400 mb-4">⚠️ בעיה בחיבור</h2>
                                 <p class="text-gray-300 text-lg">לא הצלחנו להתחבר לשרת ה-AI שלנו</p>
                             </div>
                             <div class="bg-red-500/20 backdrop-blur-sm rounded-xl p-6">
                                 <p class="text-red-300 font-medium">${error.message}</p>
                             </div>
                             <div class="mt-6">
                                 <button onclick="window.location.reload()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                     נסה שוב
                                 </button>
                             </div>
                         </div>
                     `;
                 }
                 
                 throw error;

             }

        }



        function handleFabClick() {

            const isOpening = !ui.toolsMenu.classList.contains('open');

            ui.toolsFab.classList.toggle('active', isOpening);

            ui.toolsMenu.classList.toggle('open', isOpening);

            

            toggleEditMode(isOpening);

        }



        function toggleEditMode(forceState) {

            const newState = (typeof forceState === 'boolean') ? forceState : !state.isEditing;

            if (newState === state.isEditing) return;



            state.isEditing = newState;

            const iframeDoc = ui.previewIframe.contentWindow.document;

            if (!iframeDoc) {

                showModal("modal_error_edit_mode");

                return;

            }



            if (state.isEditing) {

                iframeDoc.body.contentEditable = true;

                iframeDoc.designMode = 'off';

                ui.previewIframe.classList.add('editable');

                ui.toolsFab.innerHTML = '<i data-lucide="check-circle" class="w-6 h-6"></i>';

                iframeDoc.body.addEventListener('click', handleIframeElementClick, true);

            } else {

                iframeDoc.body.contentEditable = false;

                ui.previewIframe.classList.remove('editable');

                ui.toolsFab.innerHTML = '<i data-lucide="pencil" class="w-6 h-6"></i>';

                iframeDoc.body.removeEventListener('click', handleIframeElementClick, true);

                if (state.currentElementToEdit) {

                    state.currentElementToEdit.style.outline = '';

                    state.currentElementToEdit = null;

                }

                 ui.opacityControl.classList.add('hidden');

            }

            lucide.createIcons(); 

        }



        function handleIframeElementClick(event) {

            if (!state.isEditing) return;

            event.preventDefault();

            event.stopPropagation();

            const target = event.target;



            ui.opacityControl.classList.add('hidden');

            state.currentOverlayToEdit = null;

            

            state.elementToModifyForImage = null;

            state.imageModificationType = null;



            const backgroundHolder = findBackgroundHolder(target);

            

            if (target.tagName === 'IMG') {

                state.elementToModifyForImage = target;

                state.imageModificationType = 'src';

            } else if (backgroundHolder) {

                state.elementToModifyForImage = backgroundHolder;

                state.imageModificationType = 'background';

                state.currentOverlayToEdit = backgroundHolder.querySelector('.bg-overlay');

                if (state.currentOverlayToEdit) {

                    ui.opacityControl.classList.remove('hidden');

                    const rgbaColor = window.getComputedStyle(state.currentOverlayToEdit).backgroundColor;

                    const match = /rgba?\((\d+), (\d+), (\d+)(, ([\d.]+))?\)/.exec(rgbaColor);

                    ui.opacitySlider.value = match && match[5] ? match[5] : 0.5;

                }

            }



            if (state.currentElementToEdit) state.currentElementToEdit.style.outline = '';

            state.currentElementToEdit = target;

            state.currentElementToEdit.style.outline = '2px dashed #8b5cf6';

        }



        function handleUploadBtnClick() {

            if (state.elementToModifyForImage) {

                ui.iframeImageUploader.click();

            } else {

                showModal("modal_error_upload_image");

            }

        }

        

        async function handleImageUpload(event) {

             const file = event.target.files[0];

             if (!file || !state.elementToModifyForImage) return;



             showModal(getTranslation('modal_processing_image'));



             try {

                 const resizedFile = await resizeAndCompressImage(file);

                 

                 const { data: { user } } = await sb.auth.getUser();

                 if (!user) {

                     throw new Error(getTranslation('modal_upload_auth_error'));

                 }



                 let imageUrl = null;

                 // העלה תמונה לתיקיית output המקומית
                 try {
                     const formData = new FormData();
                     formData.append('image', resizedFile);
                     formData.append('userId', user.id);
                     formData.append('pageName', state.currentPageData?.title || 'general');

                     const response = await fetch('/api/upload-image', {
                         method: 'POST',
                         body: formData
                     });

                     if (response.ok) {
                         const result = await response.json();
                         if (result.success) {
                             imageUrl = result.imageUrl;
                             console.log('תמונה נשמרה מקומית:', imageUrl);
                         }
                     }
                 } catch (localError) {
                     console.error('Local upload failed:', localError);
                 }

                 // אם גם זה נכשל, השתמש ב-data URL
                 if (!imageUrl) {
                     const reader = new FileReader();
                     imageUrl = await new Promise((resolve) => {
                         reader.onload = () => resolve(reader.result);
                         reader.readAsDataURL(resizedFile);
                     });
                     console.log('תמונה נשמרה כ-data URL');
                 }

                 if (!imageUrl) {
                     throw new Error('לא ניתן להעלות את התמונה');
                 }

                 // עדכן את התמונה
                 if (state.imageModificationType === 'src') {

                      state.elementToModifyForImage.src = imageUrl;
                 } else if (state.imageModificationType === 'background') {

                      state.elementToModifyForImage.style.backgroundImage = `url('${imageUrl}')`;
                 }

                 

                 hideModal();

                 showModal(getTranslation('modal_image_success'));



             } catch (error) {

                 console.error('Error uploading image:', error);

                 hideModal();

                 showModal(`${getTranslation('modal_image_error')}: ${error.message}`);

             } finally {

                 state.elementToModifyForImage = null;

                 event.target.value = '';

             }

        }

        

        function resizeAndCompressImage(file, maxWidth = 1920, quality = 0.85) {

            return new Promise((resolve, reject) => {

                const reader = new FileReader();

                reader.readAsDataURL(file);

                reader.onload = event => {

                    const img = new Image();

                    img.src = event.target.result;

                    img.onload = () => {

                        const canvas = document.createElement('canvas');

                        const ctx = canvas.getContext('2d');

                        

                        let width = img.width;

                        let height = img.height;



                        if (width > maxWidth) {

                            height *= maxWidth / width;

                            width = maxWidth;

                        }



                        canvas.width = width;

                        canvas.height = height;

                        ctx.drawImage(img, 0, 0, width, height);

                        

                        canvas.toBlob(blob => {

                            if (!blob) {

                                reject(new Error('Canvas to Blob conversion failed.'));

                                return;

                            }

                            const newFile = new File([blob], file.name, {

                                type: blob.type,

                                lastModified: Date.now()

                            });

                            resolve(newFile);

                        }, file.type, quality);

                    };

                    img.onerror = error => reject(error);

                };

                reader.onerror = error => reject(error);

            });

        }





        async function handleSavePage() {

            showModal(getTranslation('modal_saving'));



            const { data: { user } } = await sb.auth.getUser();

            if (!user) {

                showModal(getTranslation('modal_error_auth'));

                return;

            }



            if(state.isEditing) toggleEditMode(false);

            await new Promise(r => setTimeout(r, 100));



            const clonedDoc = ui.previewIframe.contentWindow.document.cloneNode(true);

            clonedDoc.querySelectorAll('[style*="outline"]').forEach(el => el.style.outline = '');

            const finalHtml = clonedDoc.documentElement.outerHTML;



            // בדוק אם אנחנו במצב עריכה
            const urlParams = new URLSearchParams(window.location.search);
            const editProjectId = urlParams.get('edit');

            if (editProjectId) {
                // מצב עריכה - עדכן את הקובץ הקיים
                console.log('Updating existing project:', editProjectId);
                
                if (editProjectId.startsWith('local_')) {
                    // עדכן קובץ מקומי
                    const fileName = editProjectId.replace('local_', '');
                    try {
                        const response = await fetch('/api/update-page', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                userId: user.id,
                                fileName: fileName,
                                htmlContent: finalHtml
                            })
                        });

                        if (response.ok) {
                            console.log('Local page updated successfully');
                            showModal('הדף עודכן בהצלחה!');
                        } else {
                            throw new Error('Failed to update local page');
                        }
                    } catch (error) {
                        console.error('Error updating local page:', error);
                        showModal('שגיאה בעדכון הדף');
                        return;
                    }
                } else {
                    // עדכן דף מ-Supabase
                    try {
                        const { error } = await sb.from('projects')
                            .update({ 
                                html_content: finalHtml,
                                name: document.getElementById('mainName').value || 'דף נחיתה'
                            })
                            .eq('id', editProjectId);
                        
                        if (error) {
                            console.error('Error updating Supabase project:', error);
                            showModal('שגיאה בעדכון הדף');
                            return;
                        }
                        
                        console.log('Supabase project updated successfully');
                        showModal('הדף עודכן בהצלחה!');
                    } catch (error) {
                        console.error('Supabase update error:', error);
                        showModal('שגיאה בעדכון הדף');
                        return;
                    }
                }
            } else {
                // מצב יצירה חדשה
            const pageData = {

                user_id: user.id,

                    name: document.getElementById('mainName').value || 'דף נחיתה',
                description: state.originalDescription,

                html_content: finalHtml,

                template_type: state.selectedPageType,

                status: 'completed'

            };



                // נסה לשמור ב-Supabase
                let supabaseSuccess = false;
                try {
                    const { error } = await sb.from('projects').insert(pageData);
                    if (error) {
                        console.error('Error saving to Supabase:', error);
                    } else {
                        supabaseSuccess = true;
                        console.log('Page saved to Supabase successfully');
                    }
                } catch (supabaseError) {
                    console.error('Supabase save failed:', supabaseError);
                }

                // אם Supabase נכשל, נסה לשמור מקומית
                if (!supabaseSuccess) {
                    try {
                        const response = await fetch('/api/create-page', {
                    method: 'POST',

                    headers: {

                                'Content-Type': 'application/json',
                    },

                    body: JSON.stringify({

                        userId: user.id,

                                title: document.getElementById('mainName').value || 'דף נחיתה',
                                htmlContent: finalHtml
                    })

                });



                        if (response.ok) {
                            const result = await response.json();
                            console.log('Page saved locally:', result);
                            showModal(getTranslation('modal_save_success'));
                        } else {
                            throw new Error('Local save failed');
                        }
                    } catch (localError) {
                        console.error('Local save error:', localError);
                        showModal(`${getTranslation('modal_error_save')}: שמירה מקומית נכשלה`);
                        return;
                    }
                } else {
                showModal(getTranslation('modal_save_success'));

                }
            }


                const redirectUrl = urlParams.get('redirectUrl');

                setTimeout(() => {

                    if (redirectUrl) {
                        // הוסף פרמטר שמציין שחזרנו מיצירת דף
                        const separator = redirectUrl.includes('?') ? '&' : '?';
                        window.top.location.href = redirectUrl + separator + 'fromCreator=true';

                    } else {

                        hideModal();

                    }

                }, 2000);

        }

        // --- Download Page Function ---
        // --- Back to Home Function ---
        function handleBackToHome() {
            // חזור לדף הבית ללא שמירה
            window.location.href = '/';
        }



        // --- Utility Functions ---

        function setLoading(isLoading) {

             if (isLoading) {

                ui.generateBtnText.classList.add('hidden');

                ui.generateBtnLoader.classList.remove('hidden');

                

                const messages = [getTranslation('gen_text_1'), getTranslation('gen_text_2'), getTranslation('gen_text_3'), getTranslation('gen_text_4')];

                let messageIndex = 0;

                

                ui.generationView.innerHTML = `
                    <div class="gen-loader">
                        <div class="inner one"></div>
                        <div class="inner two"></div>
                        <div class="inner three"></div>
                    </div>
                    <p id="gen-text-animation" class="gen-text text-xl">${messages[messageIndex]}</p>
                `;



                const textElement = document.getElementById('gen-text-animation');

                const intervalId = setInterval(() => {

                    messageIndex = (messageIndex + 1) % messages.length;

                    if(textElement) {

                       textElement.classList.remove('fade-in');

                       void textElement.offsetWidth; // Trigger reflow

                       textElement.textContent = messages[messageIndex];

                       textElement.classList.add('fade-in');

                    }

                }, 2000);



                ui.generationView.dataset.intervalId = intervalId;



                if (!ui.previewView.classList.contains('active')) {

                     switchView(ui.formView, ui.previewView);

                }

                ui.generationView.classList.remove('hidden');

                ui.previewContainer.classList.add('hidden');

            } else {

                ui.generateBtnText.classList.remove('hidden');

                ui.generateBtnLoader.classList.add('hidden');

                ui.generationView.classList.add('hidden');

                const intervalId = ui.generationView.dataset.intervalId;

                if (intervalId) {

                    clearInterval(intervalId);

                }

            }

        }

        



        function findBackgroundHolder(el) {

            let current = el;

            for (let i = 0; i < 5 && current && current !== document.body; i++) {

                if (window.getComputedStyle(current).backgroundImage !== 'none') return current;

                current = current.parentElement;

            }

            return null;

        }



        // --- App Start ---

        window.addEventListener('DOMContentLoaded', (event) => {

            initializeApp();

            
            // בדוק אם צריך לטעון פרויקט לעריכה
            const urlParams = new URLSearchParams(window.location.search);
            const editProjectId = urlParams.get('edit');
            
            if (editProjectId) {
                // טען פרויקט לעריכה
                loadProjectForEdit(editProjectId);
            } else {
                // טען פרויקטים קיימים אחרי האתחול
                setTimeout(() => {
                    loadUserProjects();
                }, 1000);
                
                // הצג הודעה על מצב Supabase
                setTimeout(() => {
                    console.log('💡 טיפ: אם Supabase לא זמין, הדפים יישמרו מקומית בלבד');
                }, 2000);
            }
        });

        // --- Load Project for Edit ---
        async function loadProjectForEdit(projectId) {
            try {
                console.log('Loading project for edit:', projectId);
                
                // בדוק אם זה דף מקומי
                if (projectId.startsWith('local_')) {
                    const fileName = projectId.replace('local_', '');
                    console.log('Loading local file:', fileName);
                    
                    // טען את הקובץ המקומי
                    const { data: { user: currentUser } } = await sb.auth.getUser();
                    if (!currentUser) {
                        throw new Error('User not authenticated');
                    }
                    const response = await fetch(`/pages/${currentUser.id}/${fileName}`);
                    if (response.ok) {
                        const htmlContent = await response.text();
                        ui.previewIframe.srcdoc = htmlContent;
                        ui.previewContainer.classList.remove('hidden');
                        ui.generationView.classList.add('hidden');
                        ui.toolsFab.classList.remove('hidden');
                        ui.toolsFab.classList.remove('active');
                        ui.toolsMenu.classList.remove('open');
                        ui.savePageBtn.classList.remove('hidden');
                        ui.downloadPageBtn.classList.remove('hidden');
                        switchView(ui.typeSelectionView, ui.previewView);
                        return;
                    } else {
                        throw new Error('Failed to load local file');
                    }
                }
                
                // דף מ-Supabase
                const { data: project, error } = await sb
                    .from('projects')
                    .select('*')
                    .eq('id', projectId)
                    .single();

                if (error || !project) {
                    console.error('Supabase error:', error);
                    showModal('שגיאה בטעינת הפרויקט מ-Supabase');
                    return;
                }

                // טען את הפרויקט לעריכה
                ui.previewIframe.srcdoc = project.html_content;
                ui.previewContainer.classList.remove('hidden');
                ui.generationView.classList.add('hidden');
                ui.toolsFab.classList.remove('hidden');
                ui.toolsFab.classList.remove('active');
                ui.toolsMenu.classList.remove('open');
                ui.savePageBtn.classList.remove('hidden');
                ui.downloadPageBtn.classList.remove('hidden');
                switchView(ui.typeSelectionView, ui.previewView);

            } catch (error) {
                console.error('Error loading project for edit:', error);
                showModal('שגיאה בטעינת הפרויקט: ' + error.message);
            }
        }

        // --- Load User Projects ---
        async function loadUserProjects() {
            try {
                const { data: { user } } = await sb.auth.getUser();
                if (!user) {
                    console.log('No user found - Supabase unavailable');
                    return;
                }

                const { data: projects, error } = await sb
                    .from('projects')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.log('Supabase לא זמין - לא נטענו פרויקטים קיימים');
                } else {
                    console.log('נטענו פרויקטים קיימים:', projects?.length || 0);
                }
            } catch (error) {
                console.log('Supabase לא זמין - לא נטענו פרויקטים קיימים');
            }
        }

        // --- Language and Country Support ---
        function getCurrentLanguage() {
            // בדוק אם יש פרמטרים מ-URL
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            if (urlLang) {
                // עדכן את ה-selector
                const selector = document.getElementById('language-selector');
                if (selector) {
                    selector.value = urlLang;
                }
                return urlLang;
            }
            return document.getElementById('language-selector')?.value || 'he';
        }

        function getCountryFromLanguage(lang) {
            const countryMap = {
                'he': 'IL', // ישראל
                'ar': 'SA', // סעודיה
                'ja': 'JP', // יפן
                'en': 'US', // ארה"ב
                'es': 'ES', // ספרד
                'fr': 'FR', // צרפת
                'de': 'DE', // גרמניה
                'ru': 'RU', // רוסיה
                'zh': 'CN'  // סין
            };
            return countryMap[lang] || 'IL';
        }

        function getWhatsAppCountryCode(lang) {
            const countryCodes = {
                'he': '972', // ישראל
                'ar': '966', // סעודיה
                'ja': '81',  // יפן
                'en': '1',   // ארה"ב
                'es': '34',  // ספרד
                'fr': '33',  // צרפת
                'de': '49',  // גרמניה
                'ru': '7',   // רוסיה
                'zh': '86'   // סין
            };
            return countryCodes[lang] || '972';
        }

        function getLanguageName(lang) {
            const names = {
                'he': 'עברית',
                'ar': 'العربية',
                'ja': '日本語',
                'en': 'English',
                'es': 'Español',
                'fr': 'Français',
                'de': 'Deutsch',
                'ru': 'Русский',
                'zh': '中文'
            };
            return names[lang] || 'עברית';
        }

        function addLanguageToPageData(data) {
            // השתמש בשפה שנבחרה בטופס, לא בשפת הממשק
            const selectedOutputLang = data.outputLanguage || getCurrentLanguage();
            const country = getCountryFromLanguage(selectedOutputLang);
            const whatsappCountryCode = getWhatsAppCountryCode(selectedOutputLang);
            
            data.language = selectedOutputLang;
            data.outputLanguage = selectedOutputLang;
            data.country = country;
            data.languageName = getLanguageName(selectedOutputLang);
            data.whatsappCountryCode = whatsappCountryCode;
            
            // עדכן גם את ה-select של שפת הפלט
            const outputLanguageSelect = document.getElementById('outputLanguage');
            if (outputLanguageSelect) {
                outputLanguageSelect.value = selectedOutputLang;
            }
            
            console.log('Added language data:', { 
                language: selectedOutputLang, 
                outputLanguage: data.outputLanguage,
                country, 
                languageName: data.languageName,
                whatsappCountryCode 
            });
            return data;
        }

        // פונקציה לעדכון שפת הדף
        function updatePageLanguage(lang) {
            document.documentElement.lang = lang;
            if (lang === 'he' || lang === 'ar') {
                document.documentElement.dir = 'rtl';
            } else {
                document.documentElement.dir = 'ltr';
            }
            
            // אל תעדכן את שפת הפלט - תן למשתמש לבחור אותה בנפרד
            // const outputLanguageSelect = document.getElementById('outputLanguage');
            // if (outputLanguageSelect) {
            //     outputLanguageSelect.value = lang;
            // }
            
            translatePageCreatorInterface(lang);
        }

        function translatePageCreatorInterface(lang) {
            const translations = {
                'he': {
                    'main_title': 'יוצר דפי נחיתה מתקדם',
                    'main_subtitle': 'צור דף נחיתה מקצועי תוך דקות עם בוט AI חכם',
                    'create_page_title': 'צור דף',
                    'form_subtitle': 'מלא את הפרטים הבאים',
                    'fieldset_basic_details': 'פרטים בסיסיים',
                    'label_contact_name': 'שם איש קשר',
                    'label_email': 'אימייל',
                    'label_phone': 'טלפון',
                    'label_description': 'תיאור העסק',
                    'label_address': 'כתובת',
                    'fieldset_optional_sections': 'סעיפים אופציונליים',
                    'fieldset_social_media': 'רשתות חברתיות',
                    'label_youtube_display': 'הצגת YouTube',
                    'label_youtube_embed': 'קוד הטמעה',
                    'label_youtube_link': 'קישור',
                    'fieldset_design': 'עיצוב',
                    'label_hero_image': 'תמונת כותרת',
                    'label_use_as_background': 'השתמש כרקע',
                    'note_image_upload': 'העלה תמונה או השאר ריק',
                    'label_additional_settings': 'הגדרות נוספות',
                    'label_output_language': 'שפת הפלט',
                    'label_design_style': 'סגנון עיצוב',
                    'style_minimalist_pro': 'מינימליסטי מקצועי',
                    'style_midnight': 'חצות',
                    'style_claymorphism': 'קליי',
                    'style_retro_title': 'רטרו',
                    'style_retro': 'רטרו',
                    'style_aurora': 'אורורה',
                    'style_bento': 'בנטו',
                    'btn_back': 'חזור',
                    'btn_generate': 'צור דף',
                    'fieldset_external_links': 'קישורים חיצוניים',
                    'label_main_button_text': 'טקסט הכפתור הראשי',
                    'label_main_button_url': 'כתובת הכפתור הראשי',
                    'fieldset_property_details': 'פרטי הנכס',
                    'label_beds': 'חדרי שינה',
                    'label_baths': 'חדרי רחצה',
                    'label_sqft': 'מ״ר',
                    'label_price': 'מחיר',
                    'fieldset_app_links': 'קישורי אפליקציות',
                    'label_app_store_link': 'קישור App Store',
                    'label_google_play_link': 'קישור Google Play',
                    'modal_close_btn': 'סגור'
                },
                'en': {
                    'main_title': 'Advanced Landing Page Creator',
                    'main_subtitle': 'Create professional landing pages in minutes with smart AI bot',
                    'create_page_title': 'Create Page',
                    'form_subtitle': 'Fill in the following details',
                    'fieldset_basic_details': 'Basic Details',
                    'label_contact_name': 'Contact Name',
                    'label_email': 'Email',
                    'label_phone': 'Phone',
                    'label_description': 'Business Description',
                    'label_address': 'Address',
                    'fieldset_optional_sections': 'Optional Sections',
                    'fieldset_social_media': 'Social Media',
                    'label_youtube_display': 'YouTube Display',
                    'label_youtube_embed': 'Embed Code',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hero Image',
                    'label_use_as_background': 'Use as Background',
                    'note_image_upload': 'Upload image or leave blank',
                    'label_additional_settings': 'Additional Settings',
                    'label_output_language': 'Output Language',
                    'label_design_style': 'Design Style',
                    'style_minimalist_pro': 'Minimalist Pro',
                    'style_midnight': 'Midnight',
                    'style_claymorphism': 'Clay',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Back',
                    'btn_generate': 'Create Page',
                    'fieldset_external_links': 'External Links',
                    'label_main_button_text': 'Main Button Text',
                    'label_main_button_url': 'Main Button URL',
                    'fieldset_property_details': 'Property Details',
                    'label_beds': 'Bedrooms',
                    'label_baths': 'Bathrooms',
                    'label_sqft': 'Sq Ft',
                    'label_price': 'Price',
                    'fieldset_app_links': 'App Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link',
                    'modal_close_btn': 'Close'
                },
                'ar': {
                    'main_title': 'منشئ صفحات الهبوط المتقدم',
                    'main_subtitle': 'أنشئ صفحات هبوط احترافية في دقائق مع بوت ذكي',
                    'create_page_title': 'إنشاء صفحة',
                    'form_subtitle': 'املأ التفاصيل التالية',
                    'fieldset_basic_details': 'التفاصيل الأساسية',
                    'label_contact_name': 'اسم جهة الاتصال',
                    'label_email': 'البريد الإلكتروني',
                    'label_phone': 'الهاتف',
                    'label_description': 'وصف العمل',
                    'label_address': 'العنوان',
                    'fieldset_optional_sections': 'أقسام اختيارية',
                    'fieldset_social_media': 'وسائل التواصل الاجتماعي',
                    'label_youtube_display': 'عرض YouTube',
                    'label_youtube_embed': 'كود التضمين',
                    'label_youtube_link': 'الرابط',
                    'fieldset_design': 'التصميم',
                    'label_hero_image': 'صورة البطل',
                    'label_use_as_background': 'استخدام كخلفية',
                    'note_image_upload': 'رفع صورة أو اتركها فارغة',
                    'label_additional_settings': 'إعدادات إضافية',
                    'label_output_language': 'لغة الإخراج',
                    'label_design_style': 'نمط التصميم',
                    'style_minimalist_pro': 'بسيط احترافي',
                    'style_midnight': 'منتصف الليل',
                    'style_claymorphism': 'طيني',
                    'style_retro_title': 'رجعي',
                    'style_retro': 'رجعي',
                    'style_aurora': 'الشفق',
                    'style_bento': 'بنتو',
                    'btn_back': 'رجوع',
                    'btn_generate': 'إنشاء صفحة',
                    'fieldset_external_links': 'روابط خارجية',
                    'label_main_button_text': 'نص الزر الرئيسي',
                    'label_main_button_url': 'رابط الزر الرئيسي',
                    'fieldset_property_details': 'تفاصيل العقار',
                    'label_beds': 'غرف النوم',
                    'label_baths': 'الحمامات',
                    'label_sqft': 'قدم مربع',
                    'label_price': 'السعر',
                    'fieldset_app_links': 'روابط التطبيقات',
                    'label_app_store_link': 'رابط App Store',
                    'label_google_play_link': 'رابط Google Play',
                    'modal_close_btn': 'إغلاق'
                },
                'ja': {
                    'main_title': '高度なランディングページ作成者',
                    'main_subtitle': 'スマートAIボットで数分でプロフェッショナルなランディングページを作成',
                    'create_page_title': 'ページ作成',
                    'form_subtitle': '以下の詳細を入力してください',
                    'fieldset_basic_details': '基本詳細',
                    'label_contact_name': '連絡先名',
                    'label_email': 'メール',
                    'label_phone': '電話番号',
                    'label_description': 'ビジネス説明',
                    'label_address': '住所',
                    'fieldset_optional_sections': 'オプションセクション',
                    'fieldset_social_media': 'ソーシャルメディア',
                    'label_youtube_display': 'YouTube表示',
                    'label_youtube_embed': '埋め込みコード',
                    'label_youtube_link': 'リンク',
                    'fieldset_design': 'デザイン',
                    'label_hero_image': 'ヒーロー画像',
                    'label_use_as_background': '背景として使用',
                    'note_image_upload': '画像をアップロードまたは空白のまま',
                    'label_additional_settings': '追加設定',
                    'label_output_language': '出力言語',
                    'label_design_style': 'デザインスタイル',
                    'style_minimalist_pro': 'ミニマリストプロ',
                    'style_midnight': 'ミッドナイト',
                    'style_claymorphism': 'クレイ',
                    'style_retro_title': 'レトロ',
                    'style_retro': 'レトロ',
                    'style_aurora': 'オーロラ',
                    'style_bento': 'ベント',
                    'btn_back': '戻る',
                    'btn_generate': 'ページ作成',
                    'fieldset_external_links': '外部リンク',
                    'label_main_button_text': 'メインボタンテキスト',
                    'label_main_button_url': 'メインボタンURL',
                    'fieldset_property_details': '物件詳細',
                    'label_beds': '寝室',
                    'label_baths': 'バスルーム',
                    'label_sqft': '平方フィート',
                    'label_price': '価格',
                    'fieldset_app_links': 'アプリリンク',
                    'label_app_store_link': 'App Storeリンク',
                    'label_google_play_link': 'Google Playリンク',
                    'modal_close_btn': '閉じる'
                },
                'es': {
                    'main_title': 'Creador Avanzado de Páginas de Aterrizaje',
                    'main_subtitle': 'Crea páginas de aterrizaje profesionales en minutos con bot IA inteligente',
                    'create_page_title': 'Crear Página',
                    'form_subtitle': 'Complete los siguientes detalles',
                    'fieldset_basic_details': 'Detalles Básicos',
                    'label_contact_name': 'Nombre de Contacto',
                    'label_email': 'Correo Electrónico',
                    'label_phone': 'Teléfono',
                    'label_description': 'Descripción del Negocio',
                    'label_address': 'Dirección',
                    'fieldset_optional_sections': 'Secciones Opcionales',
                    'fieldset_social_media': 'Redes Sociales',
                    'label_youtube_display': 'Mostrar YouTube',
                    'label_youtube_embed': 'Código de Incrustación',
                    'label_youtube_link': 'Enlace',
                    'fieldset_design': 'Diseño',
                    'label_hero_image': 'Imagen Principal',
                    'label_use_as_background': 'Usar como Fondo',
                    'note_image_upload': 'Subir imagen o dejar en blanco',
                    'label_additional_settings': 'Configuraciones Adicionales',
                    'label_output_language': 'Idioma de Salida',
                    'label_design_style': 'Estilo de Diseño',
                    'style_minimalist_pro': 'Minimalista Pro',
                    'style_midnight': 'Medianoche',
                    'style_claymorphism': 'Arcilla',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Atrás',
                    'btn_generate': 'Crear Página',
                    'fieldset_external_links': 'Enlaces Externos',
                    'label_main_button_text': 'Texto del Botón Principal',
                    'label_main_button_url': 'URL del Botón Principal',
                    'fieldset_property_details': 'Detalles de la Propiedad',
                    'label_beds': 'Dormitorios',
                    'label_baths': 'Baños',
                    'label_sqft': 'Pies Cuadrados',
                    'label_price': 'Precio',
                    'fieldset_app_links': 'Enlaces de Aplicaciones',
                    'label_app_store_link': 'Enlace de App Store',
                    'label_google_play_link': 'Enlace de Google Play',
                    'modal_close_btn': 'Cerrar'
                },
                'fr': {
                    'main_title': 'Créateur de Pages d\'Atterrissage Avancé',
                    'main_subtitle': 'Créez des pages d\'atterrissage professionnelles en minutes avec un bot IA intelligent',
                    'create_page_title': 'Créer une Page',
                    'form_subtitle': 'Remplissez les détails suivants',
                    'fieldset_basic_details': 'Détails de Base',
                    'label_contact_name': 'Nom de Contact',
                    'label_email': 'E-mail',
                    'label_phone': 'Téléphone',
                    'label_description': 'Description de l\'Entreprise',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Sections Optionnelles',
                    'fieldset_social_media': 'Réseaux Sociaux',
                    'label_youtube_display': 'Affichage YouTube',
                    'label_youtube_embed': 'Code d\'Intégration',
                    'label_youtube_link': 'Lien',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Image Principale',
                    'label_use_as_background': 'Utiliser comme Arrière-plan',
                    'note_image_upload': 'Télécharger une image ou laisser vide',
                    'label_additional_settings': 'Paramètres Supplémentaires',
                    'label_output_language': 'Langue de Sortie',
                    'label_design_style': 'Style de Design',
                    'style_minimalist_pro': 'Minimaliste Pro',
                    'style_midnight': 'Minuit',
                    'style_claymorphism': 'Argile',
                    'style_retro_title': 'Rétro',
                    'style_retro': 'Rétro',
                    'style_aurora': 'Aurore',
                    'style_bento': 'Bento',
                    'btn_back': 'Retour',
                    'btn_generate': 'Créer une Page',
                    'fieldset_external_links': 'Liens Externes',
                    'label_main_button_text': 'Texte du Bouton Principal',
                    'label_main_button_url': 'URL du Bouton Principal',
                    'fieldset_property_details': 'Détails de la Propriété',
                    'label_beds': 'Chambres',
                    'label_baths': 'Salles de Bain',
                    'label_sqft': 'Pieds Carrés',
                    'label_price': 'Prix',
                    'fieldset_app_links': 'Liens d\'Applications',
                    'label_app_store_link': 'Lien App Store',
                    'label_google_play_link': 'Lien Google Play',
                    'modal_close_btn': 'Fermer'
                },
                'de': {
                    'main_title': 'Erweiterter Landing Page Creator',
                    'main_subtitle': 'Erstellen Sie professionelle Landing Pages in Minuten mit intelligentem KI-Bot',
                    'create_page_title': 'Seite Erstellen',
                    'form_subtitle': 'Füllen Sie die folgenden Details aus',
                    'fieldset_basic_details': 'Grundlegende Details',
                    'label_contact_name': 'Kontaktname',
                    'label_email': 'E-Mail',
                    'label_phone': 'Telefon',
                    'label_description': 'Geschäftsbeschreibung',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Optionale Abschnitte',
                    'fieldset_social_media': 'Soziale Medien',
                    'label_youtube_display': 'YouTube-Anzeige',
                    'label_youtube_embed': 'Einbettungscode',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hauptbild',
                    'label_use_as_background': 'Als Hintergrund verwenden',
                    'note_image_upload': 'Bild hochladen oder leer lassen',
                    'label_additional_settings': 'Zusätzliche Einstellungen',
                    'label_output_language': 'Ausgabesprache',
                    'label_design_style': 'Design-Stil',
                    'style_minimalist_pro': 'Minimalistisch Pro',
                    'style_midnight': 'Mitternacht',
                    'style_claymorphism': 'Ton',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Zurück',
                    'btn_generate': 'Seite Erstellen',
                    'fieldset_external_links': 'Externe Links',
                    'label_main_button_text': 'Hauptbutton-Text',
                    'label_main_button_url': 'Hauptbutton-URL',
                    'fieldset_property_details': 'Immobiliendetails',
                    'label_beds': 'Schlafzimmer',
                    'label_baths': 'Badezimmer',
                    'label_sqft': 'Quadratfuß',
                    'label_price': 'Preis',
                    'fieldset_app_links': 'App-Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link',
                    'modal_close_btn': 'Schließen'
                },
                'ru': {
                    'main_title': 'Продвинутый Создатель Лендингов',
                    'main_subtitle': 'Создавайте профессиональные лендинги за минуты с умным ИИ ботом',
                    'create_page_title': 'Создать Страницу',
                    'form_subtitle': 'Заполните следующие детали',
                    'fieldset_basic_details': 'Основные Детали',
                    'label_contact_name': 'Имя Контакта',
                    'label_email': 'Электронная Почта',
                    'label_phone': 'Телефон',
                    'label_description': 'Описание Бизнеса',
                    'label_address': 'Адрес',
                    'fieldset_optional_sections': 'Дополнительные Разделы',
                    'fieldset_social_media': 'Социальные Сети',
                    'label_youtube_display': 'Отображение YouTube',
                    'label_youtube_embed': 'Код Встраивания',
                    'label_youtube_link': 'Ссылка',
                    'fieldset_design': 'Дизайн',
                    'label_hero_image': 'Главное Изображение',
                    'label_use_as_background': 'Использовать как Фон',
                    'note_image_upload': 'Загрузить изображение или оставить пустым',
                    'label_additional_settings': 'Дополнительные Настройки',
                    'label_output_language': 'Язык Вывода',
                    'label_design_style': 'Стиль Дизайна',
                    'style_minimalist_pro': 'Минималистичный Про',
                    'style_midnight': 'Полночь',
                    'style_claymorphism': 'Глина',
                    'style_retro_title': 'Ретро',
                    'style_retro': 'Ретро',
                    'style_aurora': 'Аврора',
                    'style_bento': 'Бенто',
                    'btn_back': 'Назад',
                    'btn_generate': 'Создать Страницу',
                    'fieldset_external_links': 'Внешние Ссылки',
                    'label_main_button_text': 'Текст Главной Кнопки',
                    'label_main_button_url': 'URL Главной Кнопки',
                    'fieldset_property_details': 'Детали Недвижимости',
                    'label_beds': 'Спальни',
                    'label_baths': 'Ванные Комнаты',
                    'label_sqft': 'Квадратные Футы',
                    'label_price': 'Цена',
                    'fieldset_app_links': 'Ссылки на Приложения',
                    'label_app_store_link': 'Ссылка App Store',
                    'label_google_play_link': 'Ссылка Google Play',
                    'modal_close_btn': 'Закрыть'
                },
                'zh': {
                    'main_title': '高级着陆页创建器',
                    'main_subtitle': '使用智能AI机器人几分钟内创建专业着陆页',
                    'create_page_title': '创建页面',
                    'form_subtitle': '填写以下详细信息',
                    'fieldset_basic_details': '基本详情',
                    'label_contact_name': '联系人姓名',
                    'label_email': '电子邮件',
                    'label_phone': '电话',
                    'label_description': '业务描述',
                    'label_address': '地址',
                    'fieldset_optional_sections': '可选部分',
                    'fieldset_social_media': '社交媒体',
                    'label_youtube_display': 'YouTube显示',
                    'label_youtube_embed': '嵌入代码',
                    'label_youtube_link': '链接',
                    'fieldset_design': '设计',
                    'label_hero_image': '主图',
                    'label_use_as_background': '用作背景',
                    'note_image_upload': '上传图片或留空',
                    'label_additional_settings': '附加设置',
                    'label_output_language': '输出语言',
                    'label_design_style': '设计风格',
                    'style_minimalist_pro': '极简专业',
                    'style_midnight': '午夜',
                    'style_claymorphism': '粘土',
                    'style_retro_title': '复古',
                    'style_retro': '复古',
                    'style_aurora': '极光',
                    'style_bento': '便当',
                    'btn_back': '返回',
                    'btn_generate': '创建页面',
                    'fieldset_external_links': '外部链接',
                    'label_main_button_text': '主按钮文本',
                    'label_main_button_url': '主按钮URL',
                    'fieldset_property_details': '房产详情',
                    'label_beds': '卧室',
                    'label_baths': '浴室',
                    'label_sqft': '平方英尺',
                    'label_price': '价格',
                    'fieldset_app_links': '应用链接',
                    'label_app_store_link': 'App Store链接',
                    'label_google_play_link': 'Google Play链接',
                    'modal_close_btn': '关闭'
                }
            };

            const t = translations[lang] || translations['he'];
            
            // עדכן טקסטים עם data-translate-key
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (t[key]) {
                    element.textContent = t[key];
                }
            });
            
            // עדכן כותרת הדף
            document.title = t.main_title;
        }

        // טען פרמטרים מ-URL בעת טעינת הדף
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            if (urlLang) {
                const selector = document.getElementById('language-selector');
                if (selector) {
                    selector.value = urlLang;
                    updatePageLanguage(urlLang);
                }
            } else {
                // ברירת מחדל - עברית
                updatePageLanguage('he');
            }
        });



    </script>

</body>

</html>

