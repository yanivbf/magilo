<!--
<!DOCTYPE html>
<!-- The lang and dir attributes will be set dynamically by JavaScript -->

<html lang="he" dir="rtl">
<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Dashboard - Advanced Page Builder Pro</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Frank+Ruhl+Libre:wght@400;700&family=Heebo:wght@400;700&family=Rubik:wght@400;700;900&family=Arimo:wght@400;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    

    <style>

        /* General Body and Animation Styles */

            body { 

            font-family: 'Inter', 'Assistant', sans-serif;
    
                background-color: #f0f2f5;
    
        }

        .view { display: none; }

        .view.active { display: block; }

        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }

        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }



        /* Loader Styles */

        .loader { border-top-color: #a78bfa; animation: spin 1s linear infinite; }

        @keyframes spin { to { transform: rotate(360deg); } }

        

        /* Card Styles (Templates & Options) */

        .template-card { 

            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            background-color: white;

            position: relative;

            overflow: hidden;

        }

        .template-card:hover .overlay { opacity: 1; }

        .template-card:hover img { transform: scale(1.05); }

        .template-card img { transition: transform 0.3s ease-in-out; }

        .overlay { transition: opacity 0.3s ease-in-out; }



        .option-card { transition: all 0.3s ease-in-out; }

        .option-card.selected { 

            transform: scale(1.03); 

            box-shadow: 0 0 0 3px #8b5cf6; 

            border-color: #8b5cf6;

        }



        /* AI Assistant Chat Bubble */

        .chat-bubble { 

            max-width: 100%; 

            padding: 12px 18px; 

            border-radius: 20px; 

            line-height: 1.5;

            animation: bubbleIn 0.4s ease-in-out;

            word-wrap: break-word;

            background-color: #eef2ff; 

            color: #4338ca; 

            box-shadow: 0 4px 10px rgba(0,0,0,0.05);

            transition: all 0.3s ease;

        }

        html[dir="rtl"] .chat-bubble { border-bottom-right-radius: 4px; }

        html[dir="ltr"] .chat-bubble { border-bottom-left-radius: 4px; }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-style: italic;
            color: #6b7280;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #8b5cf6;
            animation: bounce 1.4s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { 
                transform: translateY(0); 
            }
            40% { 
                transform: translateY(-10px); 
            }
            60% { 
                transform: translateY(-5px); 
            }
        }

        @keyframes bubbleIn {

            from { opacity: 0; transform: scale(0.8) translateY(10px); }

            to { opacity: 1; transform: scale(1) translateY(0); }

        }



        /* Modal Styles */

        .modal-overlay {

            position: fixed;

            top: 0; left: 0; right: 0; bottom: 0;

            background: rgba(0, 0, 0, 0.5);

            display: flex;

            align-items: center;

            justify-content: center;

            z-index: 1000;

            opacity: 0;

            visibility: hidden;

            transition: opacity 0.3s, visibility 0.3s;

        }

        .modal-overlay.visible { opacity: 1; visibility: visible; }

        .modal-content {

            background: white;

            padding: 2rem;

            border-radius: 1rem;

            box-shadow: 0 10px 25px rgba(0,0,0,0.1);

            text-align: center;

            transform: scale(0.9);

            transition: transform 0.3s;

        }

        .modal-overlay.visible .modal-content { transform: scale(1); }



        /* Form & Editor Styles */

        .form-fieldset {

            border: 1px solid #e5e7eb;

            border-radius: 0.75rem;

            padding: 1.5rem;

            background-color: rgba(255,255,255,0.5);

        }

        .form-legend {

            padding: 0 0.5rem;

            font-weight: 600;

            color: #4c1d95;

        }

        #preview-iframe.editable {

            box-shadow: 0 0 0 4px #8b5cf6;

            border-radius: 8px;

        }

        .color-picker-wrapper { position: relative; }

        .color-picker-input {

            opacity: 0;

            position: absolute;

            top: 0; left: 0;

            width: 100%; height: 100%;

            cursor: pointer;

        }



        /* Generation Loading Animation Styles */

        .gen-view-container { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }

        .gen-loader {

            width: 80px; height: 80px;

            border-radius: 50%;

            perspective: 800px;

        }

        .gen-loader .inner {

            position: absolute;

            box-sizing: border-box;

            width: 100%; height: 100%;

            border-radius: 50%;

        }

        .gen-loader .inner.one {

            left: 0%; top: 0%;

            animation: rotate-one 1.5s linear infinite;

            border-bottom: 3px solid #8b5cf6;

        }

        .gen-loader .inner.two {

            right: 0%; top: 0%;

            animation: rotate-two 1.5s linear infinite;

            border-right: 3px solid #ec4899;

        }

        .gen-loader .inner.three {

            right: 0%; bottom: 0%;

            animation: rotate-three 1.5s linear infinite;

            border-top: 3px solid #3b82f6;

        }

        @keyframes rotate-one { 0% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(0deg); } 100% { transform: rotateX(35deg) rotateY(-45deg) rotateZ(360deg); } }

        @keyframes rotate-two { 0% { transform: rotateX(50deg) rotateY(10deg) rotateZ(0deg); } 100% { transform: rotateX(50deg) rotateY(10deg) rotateZ(360deg); } }

        @keyframes rotate-three { 0% { transform: rotateX(35deg) rotateY(55deg) rotateZ(0deg); } 100% { transform: rotateX(35deg) rotateY(55deg) rotateZ(360deg); } }

        

        .gen-text {

            font-family: 'Heebo', sans-serif;

            font-weight: 600;

            color: #475569;

            margin-top: 2rem;

            min-height: 2em; /* Reserve space for text */
            
            animation: none; /* הסר כל אנימציה מהבהבה */

        }

        

        /* Floating Edit Toolbar */

        #preview-controls-container {

            position: absolute;

            bottom: 1rem;

            left: 50%;

            transform: translateX(-50%);

            z-index: 50;

            display: flex;

            flex-direction: column;

            align-items: center;

            gap: 0.75rem;

        }

        #tools-fab {

            transition: all 0.3s ease-in-out;

            flex-shrink: 0;

        }

        #tools-fab.active {

            transform: rotate(135deg);

            background-color: #be185d; /* Pink */

        }

        #tools-menu {

            display: flex;

            align-items: center;

            gap: 0.75rem;

            transition: all 0.3s ease-in-out;

        }

        #tools-menu:not(.open) {

            opacity: 0;

            transform: translateY(10px) scale(0.95);

            pointer-events: none;

            height: 0;

        }

        #tools-menu.open {

            opacity: 1;

            transform: translateY(0) scale(1);

            pointer-events: auto;

        }

        .tool-btn {

            background-color: rgba(31, 41, 55, 0.8);

            backdrop-filter: blur(8px);

            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);

        }



        /* Language Selector */

        #language-selector-container {

            position: absolute;

            top: 1.5rem;

            inset-inline-end: 1.5rem; /* Replaces right/left for RTL/LTR support */

            z-index: 20;

        }

        /* Store Management Dashboard Styles */
        .dashboard-nav-btn {
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .dashboard-nav-btn:hover {
            color: #374151;
            background: #f9fafb;
        }

        .dashboard-nav-btn.active {
            color: #8b5cf6;
            border-bottom-color: #8b5cf6;
            background: #f9fafb;
        }

        .dashboard-section {
            min-height: 400px;
        }

        #store-management-dashboard {
            backdrop-filter: blur(4px);
        }

    </style>

</head>

<body class="bg-gray-100">



    <!-- Modal for general messages -->

    <div id="custom-modal" class="modal-overlay">

        <div class="modal-content">

            <p id="modal-message" class="text-lg text-slate-700 mb-6"></p>

                <button id="modal-close-btn" data-translate-key="modal_close_btn" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition"></button>

        </div>

    </div>

    

    <!-- Floating AI Assistant Bubble -->

    <div id="assistant-container" class="fixed bottom-6 inset-inline-end-6 z-20 w-80 hidden">

        <div class="flex items-start gap-3">

            <img src="https://placehold.co/48x48/8b5cf6/ffffff?text=AI" alt="Bot Avatar" class="w-12 h-12 rounded-full flex-shrink-0 shadow-lg cursor-pointer" id="assistant-avatar">

            <div id="guidance-bubble" class="chat-bubble hidden"></div>

        </div>

    </div>





        <div class="min-h-screen flex flex-col items-center justify-center p-4 relative">



        <!-- Language Selector Dropdown -->
    
            <div id="language-selector-container">
    
                <select id="language-selector" onchange="updatePageLanguage(this.value)" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 shadow">
                <option value="he">עברית</option>
    
                <option value="en">English</option>
                <option value="ar">العربية</option>
                <option value="ja">日本語</option>
                <option value="es">Español</option>
    
                 <option value="fr">Français</option>
    
                <option value="de">Deutsch</option>
                <option value="ru">Русский</option>
                <option value="zh">中文</option>
            </select>
    
        </div>



            <div id="type-selection-view" class="view active w-full max-w-7xl">
    
                <div class="bg-white/60 backdrop-blur-xl rounded-2xl shadow-xl p-8 fade-in">
    
                    <div class="text-center mb-10">
    
                        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-700 to-pink-600" data-translate-key="main_title"></h1>
    
                        <p class="text-slate-600 mt-3 text-lg" data-translate-key="main_subtitle"></p>
    
                </div>

                    <div id="template-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
    
                        <!-- Template cards will be injected by JS -->
    
                </div>

            </div>

        </div>
    
    
    
            <div id="form-view" class="view w-full max-w-5xl relative">
    
                 <div class="bg-white/60 backdrop-blur-xl rounded-2xl shadow-xl p-8">
    
                    <div class="text-center mb-8">
    
                        <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-700 to-pink-600"><span data-translate-key="create_page_title"></span> <span id="page-type-title"></span></h1>
    
                        <p class="text-slate-600 mt-2" data-translate-key="form_subtitle"></p>
    
                </div>
    
                    <div>
    
                        <form id="details-form" class="space-y-6">
    
                            
    
                            <fieldset class="form-fieldset">
    
                                <legend class="form-legend" data-translate-key="fieldset_basic_details"></legend>
    
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
    
                                    <div><label for="mainName" id="mainNameLabel" class="block text-sm font-medium text-slate-700"></label><input type="text" id="mainName" name="mainName" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required></div>
    
                                    <div><label for="contactName" data-translate-key="label_contact_name" class="block text-sm font-medium text-slate-700"></label><input type="text" id="contactName" name="contactName" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required></div>
    
                                    <div><label for="email" data-translate-key="label_email" class="block text-sm font-medium text-slate-700"></label><input type="email" id="email" name="email" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required></div>
    
                                    
    
                                    <!-- Phone Number with Country Code -->
    
                                    <div class="sm:col-span-2">
    
                                        <label for="phone" data-translate-key="label_phone" class="block text-sm font-medium text-slate-700"></label>
    
                                        <div class="mt-1 flex rounded-md shadow-sm">
    
                                            <select id="countryCode" name="countryCode" class="block rounded-s-md border-e-0 border-gray-300 bg-gray-50 text-gray-500 focus:ring-purple-500 focus:border-purple-500"></select>
    
                                            <input type="tel" id="phone" name="phone" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-gray-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" required>
    
                                    </div>
    
                                </div>

    
    
                                    <div class="sm:col-span-2"><label for="description" data-translate-key="label_description" class="block text-sm font-medium text-slate-700"></label><textarea id="description" name="description" rows="4" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required spellcheck="false"></textarea></div>
    
                                    <div id="address-field-container" class="sm:col-span-2"><label for="address" data-translate-key="label_address" class="block text-sm font-medium text-slate-700"></label><input type="text" id="address" name="address" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>
    
                                </div>
    
                            </fieldset>
    
    
    
                            <div id="dynamic-fields" class="space-y-6">
    
                                <!-- Dynamic fields will be injected here by JS -->
    
                            </div>
    
                            
    
                            <fieldset id="optional-sections-fieldset" class="form-fieldset" style="display: none;">
    
                                <legend class="form-legend" data-translate-key="fieldset_optional_sections"></legend>
    
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
    
                                    <!-- Checkboxes will be injected here -->
    
                                </div>
    
                            </fieldset>
    
    
    
                            <fieldset id="social-media-fieldset" class="form-fieldset">
    
                                <legend class="form-legend" data-translate-key="fieldset_social_media"></legend>
    
                                 <div class="space-y-4">
    
                                <div>
    
                                        <label for="youtubeLink" class="sr-only">YouTube</label>
    
                                        <div class="flex rounded-md shadow-sm">
    
                                             <span class="inline-flex items-center px-3 rounded-s-md border border-e-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm">
    
                                                <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266-4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816V8l6 4-6 4z" clip-rule="evenodd" /></svg>
    
                                            </span>
    
                                            <input type="url" name="youtubeLink" id="youtubeLink" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-slate-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="https://youtube.com/watch?v=...">
    
                                    </div>
    
                                        <div class="mt-2">
    
                                            <label class="text-sm font-medium text-slate-700" data-translate-key="label_youtube_display"></label>
    
                                            <div class="mt-1 flex gap-x-6">
    
                                                <div class="flex items-center">
    
                                                    <input id="youtube-embed" name="youtubeDisplayMode" type="radio" value="Embed" class="h-4 w-4 border-gray-300 text-purple-600 focus:ring-purple-600" checked>
    
                                                    <label for="youtube-embed" data-translate-key="label_youtube_embed" class="ms-2 block text-sm text-gray-900"></label>
    
                                                </div>
    
                                                <div class="flex items-center">
    
                                                    <input id="youtube-link" name="youtubeDisplayMode" type="radio" value="Link" class="h-4 w-4 border-gray-300 text-purple-600 focus:ring-purple-600">
    
                                                    <label for="youtube-link" data-translate-key="label_youtube_link" class="ms-2 block text-sm text-gray-900"></label>
    
                                                </div>
    
                                            </div>
    
                                        </div>
    
                                    </div>
    
                                <div>
    
                                        <label for="facebookLink" class="sr-only">Facebook</label>
    
                                        <div class="flex rounded-md shadow-sm">
    
                                            <span class="inline-flex items-center px-3 rounded-s-md border border-e-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm">
    
                                                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" /></svg>
    
                                            </span>
    
                                            <input type="url" name="facebookLink" id="facebookLink" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-slate-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="https://facebook.com/your-page">
    
                                    </div>
    
                                    </div>
    
                                <div>
    
                                        <label for="instagramLink" class="sr-only">Instagram</label>
    
                                        <div class="flex rounded-md shadow-sm">
    
                                             <span class="inline-flex items-center px-3 rounded-s-md border border-e-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm">
    
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 16c-3.314 0-6-2.686-6-6s2.686-6 6-6 6 2.686 6 6-2.686 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm6-2a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
    
                                            </span>
    
                                            <input type="url" name="instagramLink" id="instagramLink" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-slate-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="https://instagram.com/your-profile">
    
                                    </div>
    
                                </div>
    
                                    <div>
    
                                        <label for="tiktokLink" class="sr-only">TikTok</label>
    
                                        <div class="flex rounded-md shadow-sm">
    
                                             <span class="inline-flex items-center px-3 rounded-s-md border border-e-0 border-slate-300 bg-slate-50 text-slate-500 sm:text-sm">
    
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-2.43.05-4.84-.94-6.37-2.96-2.2-2.95-2.2-6.82 0-9.78 1.59-2.1 4.3-3.04 6.66-2.49.12.03.24.05.35.08v4.03c-1.11-.35-2.29-.5-3.43-.5-1.72 0-3.34.7-4.52 1.95-1.24 1.3-1.86 3.02-1.86 4.73 0 3.49 2.72 6.36 6.08 6.36 3.35 0 6.08-2.87 6.08-6.36 0-1.52-.57-2.93-1.56-4.02-.98-1.09-2.38-1.68-3.8-1.68-.24 0-.48.01-.7.03v-4.03z" /></svg>
    
                                            </span>
    
                                            <input type="url" name="tiktokLink" id="tiktokLink" class="block w-full min-w-0 flex-1 rounded-none rounded-e-md border-slate-300 px-3 py-2 focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="https://tiktok.com/@your-profile">
    
                                    </div>

                                </div>
    
                            </div>
    
                            </fieldset>
    
    
    
                            <fieldset id="design-style-fieldset" class="form-fieldset">
    
                                <legend class="form-legend" data-translate-key="fieldset_design"></legend>
    
                                <div class="space-y-6">
    
                                    <div>
    
                                        <label class="block text-sm font-medium text-slate-700 mb-2" data-translate-key="label_hero_image"></label>
    
                                        <div class="flex items-center">
    
                                            <input type="checkbox" id="use-as-background" name="useAsBackground" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-600">
    
                                            <label for="use-as-background" data-translate-key="label_use_as_background" class="ms-2 block text-sm text-gray-900"></label>
    
        </div>

                                        <p class="text-xs text-slate-500 mt-1" data-translate-key="note_image_upload"></p>
    
                                </div>
    
                                    <div id="accessibility-field-container">
    
                                        <label class="block text-sm font-medium text-slate-700 mb-2" data-translate-key="label_additional_settings"></label>
    
                                         <div class="flex items-center">
    
                                            <span class="text-sm text-gray-600">✅ נגישות (מרכז), AI Bot (ימין) ו-WhatsApp (שמאל) יופיעו אוטומטית בכל הדפים</span>
                            </div>

                                    </div>
    
    
    
                                    <div>
    
                                        <label for="outputLanguage" class="block text-sm font-medium text-slate-700 mb-2" data-translate-key="label_output_language"></label>
    
                                        <select id="outputLanguage" name="outputLanguage" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5 shadow">
    
                                            <option value="he">עברית</option>
    
                                            <option value="en">English</option>
                                            <option value="ar">العربية</option>
                                            <option value="ja">日本語</option>
                                            <option value="es">Español</option>
    
                                            <option value="fr">Français</option>
    
                                            <option value="de">Deutsch</option>
                                            <option value="ru">Русский</option>
                                            <option value="zh">中文</option>
                                        </select>
    
                                    </div>
    
    
    
                                    <div>
    
                                        <label class="block text-sm font-medium text-slate-700 mb-2" data-translate-key="label_design_style"></label>
    
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" data-selection="style">
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Minimalist Pro">
    
                                                <div class="h-24 bg-white rounded-lg p-2 flex items-center justify-center border border-slate-200"><div class="w-6 h-6 bg-slate-400 rounded-full"></div></div>
    
                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_minimalist_pro"></p>
    
                                            </div>
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Midnight">
    
                                                <div class="h-24 bg-slate-900 rounded-lg p-2 flex items-center justify-center"><div class="w-6 h-6 bg-indigo-500 rounded-full shadow-lg shadow-indigo-500/50"></div></div>
    
                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_midnight"></p>
    
                                            </div>
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Claymorphism 3D">
    
                                                <div class="h-24 bg-slate-100 rounded-lg p-2 flex items-center justify-center shadow-[inset_3px_3px_8px_#d1d5db,inset_-3px_-3px_8px_#ffffff]"><div class="w-6 h-6 bg-slate-300 rounded-full shadow-[inset_1px_1px_3px_#d1d5db]"></div></div>
    
                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_claymorphism"></p>
    
                                            </div>
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Retro Magazine">
    
                                                <div class="h-24 bg-amber-50 rounded-lg p-2 flex items-center justify-center border border-amber-300"><div class="w-6 h-6 bg-amber-600 rounded-full"></div></div>
    
                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_retro"></p>
    
                                            </div>
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Aurora UI">
    
                                                <div class="h-24 rounded-lg p-2 flex items-center justify-center bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500"><div class="w-6 h-6 bg-white/60 rounded-full backdrop-blur-sm"></div></div>
    
                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_aurora"></p>
    
                                            </div>
    
                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Bento Grid">

                                                <div class="h-24 rounded-lg p-2 bg-slate-50 flex items-center justify-center border border-slate-200 shadow-sm"><div class="w-6 h-6 bg-slate-400 rounded-full"></div></div>

                                                <p class="font-semibold mt-2 text-sm text-slate-700" data-translate-key="style_bento"></p>

                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Modern">
                                                <div class="h-24 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-white rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">מודרני</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Minimalist">
                                                <div class="h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-gray-400 rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">מינימליסטי</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Vintage">
                                                <div class="h-24 bg-gradient-to-br from-amber-600 to-orange-700 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-yellow-400 rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">וינטג'</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Luxury">
                                                <div class="h-24 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-white rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">לוקסוס</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Gothic">
                                                <div class="h-24 bg-gradient-to-br from-gray-800 to-black rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white/10 backdrop-blur-md rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-red-600 rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">גותי</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Neon">
                                                <div class="h-24 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center"><div class="h-6 w-6 bg-cyan-400 rounded-full"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">נאון</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Comic">
                                                <div class="h-24 bg-gradient-to-br from-yellow-300 via-red-400 to-blue-500 rounded-lg p-2 flex items-center justify-center border-4 border-black"><div class="h-12 w-3/4 bg-white rounded-lg border-2 border-black flex items-center justify-center"><div class="h-6 w-6 bg-red-500 rounded-full border-2 border-black"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">קומיקס</p>
                                            </div>

                                            <div class="option-card border-2 border-slate-200 rounded-lg p-3 cursor-pointer text-center" data-value="Surreal">
                                                <div class="h-24 bg-gradient-to-br from-amber-200 via-teal-300 to-purple-400 rounded-lg p-2 flex items-center justify-center"><div class="h-12 w-3/4 bg-gradient-to-r from-yellow-200 to-pink-300 rounded-full flex items-center justify-center transform rotate-12"><div class="h-6 w-6 bg-blue-500 rounded-none transform -rotate-45"></div></div></div>
                                                <p class="font-semibold mt-2 text-sm text-slate-700">סוריאליסטי</p>
                                            </div>
    
                                        </div>
    
                                    </div>
    
                                </div>
    
                            </fieldset>
    
    
    
                            <div class="flex gap-4 pt-4">
    
                                <button type="button" id="back-to-type-btn" data-translate-key="btn_back" class="w-1/3 bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg hover:bg-slate-300 transition"></button>
    
                                <button type="submit" class="w-2/3 bg-gradient-to-r from-purple-600 to-pink-500 text-white font-bold py-3 px-8 rounded-lg hover:opacity-90 transition-transform duration-300 hover:scale-105 shadow-lg flex items-center justify-center gap-2">
    
                                    <span id="button-text" data-translate-key="btn_generate"></span>
    
                                    <div id="button-loader" class="loader w-6 h-6 rounded-full border-4 border-white hidden"></div>
    
            </button>
    
                    </div>
    
                        </form>
    
            </div>

                </div>
    
            </div>
    
    
    
            <div id="preview-view" class="view fixed inset-0 z-50 bg-gray-800 p-4 md:p-6 lg:p-8">
    
                 <div id="generation-view" class="absolute inset-0 gen-view-container flex flex-col items-center justify-center text-center p-4 hidden"></div>
    
                 <div id="preview-container" class="w-full h-full hidden flex-col relative">
    
                    <iframe id="preview-iframe" class="w-full h-full border-0 bg-white rounded-lg shadow-2xl transition-all duration-300" title="Preview"></iframe>
    
                    
    
                    <!-- כפתורי שמירה והורדה קבועים -->
                    <div class="fixed top-4 right-4 flex gap-3 z-50">
                        <button id="save-page-btn" class="bg-green-600 text-white font-bold p-3 rounded-full hover:bg-green-700 transition shadow-lg" data-translate-title="tooltip_save_page">
                                <i data-lucide="save" class="w-5 h-5"></i>
    
                            </button>
    
                        <button id="download-page-btn" class="bg-blue-600 text-white font-bold p-3 rounded-full hover:bg-blue-700 transition shadow-lg" data-translate-title="tooltip_back_home">
                            <i data-lucide="home" class="w-5 h-5"></i>
                        </button>
                    </div>
    
                    <div id="preview-controls-container">
                        <div id="tools-menu" class="order-1">
                             <button id="back-to-form-btn" class="tool-btn text-white font-bold p-3 rounded-full hover:bg-gray-700 transition" data-translate-title="tooltip_back_to_form">
    
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
    
                            </button>
    
                            <div id="edit-tools-group" class="flex items-center gap-3">
    
                                 <button id="upload-image-btn" class="tool-btn text-white font-bold p-3 rounded-full hover:bg-gray-700 transition" data-translate-title="tooltip_upload_image">
    
                                    <i data-lucide="image-up" class="w-5 h-5"></i>
    
                                </button>
    
                                <button id="delete-image-btn" class="tool-btn text-red-500 font-bold p-3 rounded-full hover:bg-red-700 hover:text-white transition" data-translate-title="tooltip_delete_image" style="display: none;">
    
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
    
                                </button>
    
                                <div class="color-picker-wrapper tool-btn text-white font-bold p-3 rounded-full hover:bg-gray-700 transition" data-translate-title="tooltip_text_color">
    
                                    <i data-lucide="type" class="w-5 h-5"></i>
    
                                    <input type="color" id="text-color-picker" class="color-picker-input">

                            </div>

                                <div class="color-picker-wrapper tool-btn text-white font-bold p-3 rounded-full hover:bg-gray-700 transition" data-translate-title="tooltip_bg_color">
    
                                    <i data-lucide="palette" class="w-5 h-5"></i>
    
                                    <input type="color" id="bg-color-picker" class="color-picker-input">
    
                                </div>
    
                                 <div id="opacity-control" class="hidden items-center gap-2 tool-btn p-2 rounded-full" data-translate-title="tooltip_opacity">
    
                                    <i data-lucide="layers" class="w-5 h-5 text-white"></i>
                                    <input type="range" id="opacity-slider" min="0" max="1" step="0.05" class="w-24 h-2 bg-gray-500 rounded-lg appearance-none cursor-pointer">
    
                                </div>
    
                            </div>
    
                        </div>
    
                        <button id="tools-fab" class="bg-blue-600 text-white font-bold p-4 rounded-full hover:bg-blue-700 transition shadow-lg order-2">
    
                            <i data-lucide="pencil" class="w-6 h-6"></i>
    
                        </button>
    
                    </div>
    
    
    
            </div>
    
            </div>
    
        </div>
    
        
    
        <input type="file" id="iframe-image-uploader" class="hidden" accept="image/*">
    
    
    
    
    
        <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
        <script>
    
            // --- START OF SCRIPT ---

        

        // --- I18N DATA & CONFIGURATION ---

        const translations = {

            en: {

                main_title: "Hello! What are we building today?",

                main_subtitle: "Choose the base template that best suits your goal.",

                create_page_title: "Create",

                form_subtitle: "Fill in the details and the smart bot will guide you and build a custom page for you.",

                fieldset_basic_details: "Basic Details",

                label_contact_name: "Contact Person / Role",

                label_email: "Contact Email",

                label_phone: "Phone",

                label_description: "General Description",

                label_address: "Physical Address (Optional)",

                fieldset_optional_sections: "Optional Sections",

                fieldset_social_media: "Social Media (Optional)",

                label_youtube_display: "How to display the video?",

                label_youtube_embed: "Embed in page",

                label_youtube_link: "Link only",

                fieldset_design: "Design & Settings",

                label_hero_image: "Main Image Settings",

                label_use_as_background: "Use image as background for the main section",

                note_image_upload: "Note: Personal image upload is done in the editing stage, after page creation.",

                label_additional_settings: "Additional Settings",

                label_add_accessibility: "Add accessibility button to the site",

                label_add_ai_bot: "AI Bot (right) and WhatsApp (left) will appear automatically on all pages",
                label_output_language: "Page Language",

                label_design_style: "Choose a Design Style",

                style_minimalist_pro: "Professional & Clean",

                style_midnight: "Dark & Elegant",

                style_claymorphism: "Claymorphism 3D",

                style_retro_title: "Magazine Headline",

                style_retro: "Retro Magazine",

                style_aurora: "Aurora UI",

                style_bento: "Bento Grid",

                btn_back: "Back",

                btn_generate: "Send to Bot & Build",

                modal_close_btn: "Got it",

                modal_error_style: "Please choose a design style.",

                modal_error_layout: "Please choose a layout for the post.",

                modal_error_clip: "Please choose a clip style.",

                modal_error_edit_mode: "Error: Cannot activate edit mode.",

                modal_error_upload_image: "To replace an image, first click on the image or an area with a background image on the page.",

                modal_error_auth: "You must be logged in to save or upload images.",

                modal_error_save: "Error saving page",

                modal_save_success: "Page saved successfully! Redirecting back to your user area...",

                modal_saving: "Saving...",

                modal_processing_image: "Processing and uploading image...",

                modal_image_success: "Image replaced successfully!",

                modal_image_error: "Error uploading image",

                modal_upload_auth_error: "You must be logged in to upload images.",

                modal_url_error: "Could not get the URL of the uploaded image.",

                gen_text_1: "AutoPage bot is creating your page...",

                gen_text_2: "This may take a few minutes...",

                gen_text_3: "Our advanced AI system is analyzing your requirements...",

                gen_text_4: "Applying premium design patterns...",

                gen_error_title: "Oops, an error occurred",

                gen_error_details: "Error details:",

                tooltip_save_page: "Save Page & Exit",

                tooltip_back_home: "Back to home page",
                tooltip_back_to_form: "Back to form",

                tooltip_upload_image: "Upload/Replace image",

                tooltip_text_color: "Change text color",

                tooltip_bg_color: "Change background color",

                tooltip_opacity: "Background overlay opacity",

            },

            he: {

                main_title: "שלום! מה נבנה היום?",

                main_subtitle: "בחר את תבנית הבסיס המתאימה ביותר למטרה שלך.",

                create_page_title: "יצירת",

                form_subtitle: "מלא את הפרטים והבוט החכם ילווה אותך ויבנה עבורך דף מותאם אישית.",

                fieldset_basic_details: "פרטים בסיסיים",

                label_contact_name: "שם איש קשר / תפקיד",

                label_email: "אימייל ליצירת קשר",

                label_phone: "טלפון",

                label_description: "תיאור כללי",

                label_address: "כתובת פיזית (אופציונלי)",

                fieldset_optional_sections: "מקטעים אופציונליים",

                fieldset_social_media: "מדיה ורשתות חברתיות (אופציונלי)",

                label_youtube_display: "איך להציג את הסרטון?",

                label_youtube_embed: "להטמיע בדף",

                label_youtube_link: "רק קישור",

                fieldset_design: "עיצוב והגדרות",

                label_hero_image: "הגדרות תמונה ראשית",

                label_use_as_background: "השתמש בתמונה כרקע למקטע הראשי",

                note_image_upload: "הערה: העלאת תמונה אישית מתבצעת בשלב העריכה, לאחר יצירת הדף.",

                label_additional_settings: "הגדרות נוספות",

                label_add_accessibility: "הוסף כפתור נגישות לאתר",

                label_add_ai_bot: "AI Bot (ימין) ו-WhatsApp (שמאל) יופיעו אוטומטית בכל הדפים",
                label_output_language: "שפת הדף",

                label_design_style: "בחירת סגנון עיצוב",

                style_minimalist_pro: "מקצועי ונקי",

                style_midnight: "כהה ואלגנטי",

                style_claymorphism: "קליימורפיזם 3D",

                style_retro_title: "כותרת מגזין",

                style_retro: "רטרו מגזין",

                style_aurora: "Aurora UI",

                style_bento: "Bento Grid",

                btn_back: "חזור",

                btn_generate: "שלח לבוט ובנה",

                modal_close_btn: "הבנתי",

                modal_error_style: "אנא בחר סגנון עיצוב.",

                modal_error_layout: "אנא בחר מבנה לפוסט.",

                modal_error_clip: "אנא בחר סגנון חיתוך.",

                modal_error_edit_mode: "שגיאה: לא ניתן להפעיל את מצב העריכה.",

                modal_error_upload_image: "כדי להחליף תמונה, יש ללחוץ תחילה על התמונה או על אזור עם תמונת רקע בעמוד.",

                modal_error_auth: "עליך להיות מחובר כדי לשמור או להעלות תמונות.",

                modal_error_save: "שגיאה בשמירת הדף",

                modal_save_success: "הדף נשמר בהצלחה! מועבר חזרה לאזור המשתמש...",

                modal_saving: "שומר...",

                modal_processing_image: "מעבד ומעלה תמונה...",

                modal_image_success: "התמונה הוחלפה בהצלחה!",

                modal_image_error: "שגיאה בהעלאת התמונה",

                modal_upload_auth_error: "עליך להיות מחובר כדי להעלות תמונות.",

                modal_url_error: "לא ניתן היה לקבל את כתובת התמונה שהועלתה.",

                gen_text_1: "מערכת ה-AI המתקדמת שלנו מנתחת את הדרישות שלך...",

                gen_text_2: "יוצרת ארכיטקטורת קוד מקצועית...",

                gen_text_3: "מיישמת דפוסי עיצוב פרימיום...",

                gen_text_4: "מסיימת את יצירת המופת שלך...",

                gen_error_title: "אופס, התרחשה שגיאה",

                gen_error_details: "פרטי השגיאה:",

                tooltip_save_page: "שמור וצא",

                tooltip_back_home: "חזור לדף הבית",
                tooltip_back_to_form: "חזור לטופס",

                tooltip_upload_image: "העלה/החלף תמונה",
                
                tooltip_delete_image: "מחק תמונה",

                tooltip_text_color: "שנה צבע טקסט",

                tooltip_bg_color: "שנה צבע רקע",

                tooltip_opacity: "שקיפות שכבת הרקע",

            },

            es: {

                main_title: "¡Hola! ¿Qué construimos hoy?",

                main_subtitle: "Elige la plantilla base que mejor se adapte a tu objetivo.",

                create_page_title: "Crear",

                form_subtitle: "Completa los detalles y el bot inteligente te guiará y construirá una página personalizada para ti.",

                fieldset_basic_details: "Detalles Básicos",

                label_contact_name: "Persona de Contacto / Cargo",

                label_email: "Email de Contacto",

                label_phone: "Teléfono",

                label_description: "Descripción General",

                label_address: "Dirección Física (Opcional)",

                fieldset_optional_sections: "Secciones Opcionales",

                fieldset_social_media: "Redes Sociales (Opcional)",

                label_youtube_display: "¿Cómo mostrar el video?",

                label_youtube_embed: "Incrustar en la página",

                label_youtube_link: "Solo enlace",

                fieldset_design: "Diseño y Ajustes",

                label_hero_image: "Ajustes de Imagen Principal",

                label_use_as_background: "Usar imagen como fondo para la sección principal",

                note_image_upload: "Nota: La carga de imágenes personales se realiza en la etapa de edición, después de la creación de la página.",

                label_additional_settings: "Ajustes Adicionales",

                label_add_accessibility: "Añadir botón de accesibilidad al sitio",

                label_add_ai_bot: "AI Bot (derecha) y WhatsApp (izquierda) aparecerán automáticamente en todas las páginas",
                label_output_language: "Idioma de la Página",

                label_design_style: "Elige un Estilo de Diseño",

                style_minimalist_pro: "Profesional y Limpio",

                style_midnight: "Oscuro y Elegante",

                style_claymorphism: "Claymorphism 3D",

                style_retro_title: "Titular de Revista",

                style_retro: "Revista Retro",

                style_aurora: "UI Aurora",

                style_bento: "Bento Grid",

                btn_back: "Atrás",

                btn_generate: "Enviar al Bot y Construir",

                modal_close_btn: "Entendido",

                modal_error_style: "Por favor, elige un estilo de diseño.",

                modal_error_layout: "Por favor, elige un diseño para la publicación.",

                modal_error_clip: "Por favor, elige un estilo de corte.",

                modal_error_edit_mode: "Error: No se puede activar el modo de edición.",

                modal_error_upload_image: "Para reemplazar una imagen, primero haz clic en la imagen o en un área con una imagen de fondo en la página.",

                 modal_error_auth: "Debes iniciar sesión para guardar o subir imágenes.",

                modal_error_save: "Error al guardar la página",

                modal_save_success: "¡Página guardada con éxito! Redirigiendo a tu área de usuario...",

                modal_saving: "Guardando...",

                modal_processing_image: "Procesando y subiendo imagen...",

                modal_image_success: "¡Imagen reemplazada con éxito!",

                modal_image_error: "Error al subir la imagen",

                modal_upload_auth_error: "Debes iniciar sesión para subir imágenes.",

                modal_url_error: "No se pudo obtener la URL de la imagen subida.",

                gen_text_1: "El bot de AutoPage está creando tu página...",

                gen_text_2: "Esto puede tomar unos minutos...",

                gen_text_3: "Nuestro sistema de IA avanzado está analizando tus requisitos...",

                gen_text_4: "Aplicando patrones de diseño premium...",

                gen_error_title: "Vaya, ocurrió un error",

                gen_error_details: "Detalles del error:",

                tooltip_save_page: "Guardar y Salir",

                tooltip_back_home: "Volver a la página principal",
                tooltip_back_to_form: "Volver al formulario",

                tooltip_upload_image: "Subir/Reemplazar imagen",

                tooltip_text_color: "Cambiar color del texto",

                tooltip_bg_color: "Cambiar color de fondo",

                tooltip_opacity: "Opacidad de la capa de fondo",

            },

            fr: {

                main_title: "Bonjour ! Que construisons-nous aujourd'hui ?",

                main_subtitle: "Choisissez le modèle de base qui correspond le mieux à votre objectif.",

                create_page_title: "Créer",

                form_subtitle: "Remplissez les détails et le bot intelligent vous guidera et construira une page personnalisée pour vous.",

                fieldset_basic_details: "Détails de Base",

                label_contact_name: "Personne à Contacter / Rôle",

                label_email: "E-mail de Contact",

                label_phone: "Téléphone",

                label_description: "Description Générale",

                label_address: "Adresse Physique (Optionnel)",

                fieldset_optional_sections: "Sections Optionnelles",

                fieldset_social_media: "Réseaux Sociaux (Optionnel)",

                label_youtube_display: "Comment afficher la vidéo ?",

                label_youtube_embed: "Intégrer dans la page",

                label_youtube_link: "Lien uniquement",

                fieldset_design: "Design & Paramètres",

                label_hero_image: "Paramètres de l'Image Principale",

                label_use_as_background: "Utiliser l'image comme arrière-plan pour la section principale",

                note_image_upload: "Note : Le téléchargement d'image personnelle se fait à l'étape d'édition, après la création de la page.",

                label_additional_settings: "Paramètres Supplémentaires",

                label_add_accessibility: "Ajouter un bouton d'accessibilité au site",

                label_add_ai_bot: "AI Bot (droite) et WhatsApp (gauche) apparaîtront automatiquement sur toutes les pages",
                label_output_language: "Langue de la Page",

                label_design_style: "Choisissez un Style de Design",

                style_minimalist_pro: "Professionnel & Épuré",

                style_midnight: "Sombre & Élégant",

                style_claymorphism: "Claymorphism 3D",

                style_retro_title: "Titre de Magazine",

                style_retro: "Magazine Rétro",

                style_aurora: "UI Aurora",

                style_bento: "Grille Bento",

                btn_back: "Retour",

                btn_generate: "Envoyer au Bot & Construire",

                modal_close_btn: "J'ai compris",

                modal_error_style: "Veuillez choisir un style de design.",

                modal_error_layout: "Veuillez choisir une mise en page pour la publication.",

                modal_error_clip: "Veuillez choisir un style de découpe.",

                modal_error_edit_mode: "Erreur : Impossible d'activer le mode édition.",

                modal_error_upload_image: "Pour remplacer une image, cliquez d'abord sur l'image ou sur une zone avec une image de fond sur la page.",

                modal_error_auth: "Vous devez être connecté pour enregistrer ou télécharger des images.",

                modal_error_save: "Erreur lors de l'enregistrement de la page",

                modal_save_success: "Page enregistrée avec succès ! Redirection vers votre espace utilisateur...",

                modal_saving: "Enregistrement...",

                modal_processing_image: "Traitement et téléversement de l'image...",

                modal_image_success: "Image remplacée avec succès !",

                modal_image_error: "Erreur lors du téléversement de l'image",

                modal_upload_auth_error: "Vous devez être connecté pour télécharger des images.",

                modal_url_error: "Impossible d'obtenir l'URL de l'image téléchargée.",

                gen_text_1: "Le bot AutoPage crée votre page...",

                gen_text_2: "Cela peut prendre quelques minutes...",

                gen_text_3: "Notre système d'IA avancé analyse vos exigences...",

                gen_text_4: "Application de modèles de design premium...",

                gen_error_title: "Oups, une erreur est survenue",

                gen_error_details: "Détails de l'erreur :",

                tooltip_save_page: "Enregistrer & Quitter",

                tooltip_back_home: "Retour à la page d'accueil",
                tooltip_back_to_form: "Retour au formulaire",

                tooltip_upload_image: "Télécharger/Remplacer l'image",

                tooltip_text_color: "Changer la couleur du texte",

                tooltip_bg_color: "Changer la couleur de fond",

                tooltip_opacity: "Opacité du calque de fond",

            }

        };



        const countries = [

            { name: "Israel (+972)", code: "972" },

            { name: "USA (+1)", code: "1" },

            { name: "UK (+44)", code: "44" },

            { name: "France (+33)", code: "33" },

            { name: "Spain (+34)", code: "34" },

            { name: "Germany (+49)", code: "49" },

        ];



        // --- CORE DATA & CONFIGURATION ---

        const pageTemplates = {

            landing: {

                img: "https://images.unsplash.com/photo-1552664730-d307ca884978?q=80&w=2070&auto=format&fit=crop",

                fields: ['websiteLink'],

                structurePrompt: `Build a landing page with only the following sections, in this order: 1. A simple Header containing the provided external links ('Main Link', 'Additional External Link') as text links or small buttons on the side. 2. Hero Section (id="home") with a headline, description, and a central CTA button. 3. Benefits section (id="benefits") with 3 key benefits. 4. Contact form section (id="contact").`,

                t: {

                    en: { title: "Landing Page", label: "Campaign Name", description: "A focused page for conversions and lead collection.", guidance: "<b>Landing Page</b> is a focused page designed to make a visitor perform a single action, like leaving details or making a purchase." },

                    he: { title: "דף נחיתה", label: "שם הקמפיין", description: "דף ממוקד להמרות ואיסוף לידים.", guidance: "<b>דף נחיתה</b> הוא דף ממוקד שנועד לגרום למבקר לבצע פעולה אחת, כמו השארת פרטים או רכישה." },

                    ar: { title: "صفحة هبوط", label: "اسم الحملة", description: "صفحة مركزة للتحويل وجمع العملاء المحتملين.", guidance: "<b>صفحة الهبوط</b> هي صفحة مركزة مصممة لجعل الزائر يقوم بعمل واحد، مثل ترك التفاصيل أو إجراء عملية شراء." },
                    ja: { title: "ランディングページ", label: "キャンペーン名", description: "コンバージョンとリード収集に焦点を当てたページ。", guidance: "<b>ランディングページ</b>は、訪問者が詳細を残したり購入したりするなどの単一のアクションを実行するよう設計された集中ページです。" },
                    es: { title: "Página de Aterrizaje", label: "Nombre de la Campaña", description: "Una página enfocada en conversiones y captación de leads.", guidance: "Una <b>Página de Aterrizaje</b> es una página enfocada diseñada para que un visitante realice una sola acción, como dejar sus datos o realizar una compra." },

                    fr: { title: "Page d'Atterrissage", label: "Nom de la Campagne", description: "Une page ciblée pour les conversions et la collecte de prospects.", guidance: "Une <b>Page d'Atterrissage</b> est une page ciblée conçue pour inciter un visiteur à effectuer une seule action, comme laisser ses coordonnées ou faire un achat." },
                    de: { title: "Landing Page", label: "Kampagnenname", description: "Eine fokussierte Seite für Konversionen und Lead-Sammlung.", guidance: "Eine <b>Landing Page</b> ist eine fokussierte Seite, die darauf ausgelegt ist, einen Besucher zu einer einzigen Aktion zu veranlassen, wie das Hinterlassen von Details oder einen Kauf." },
                    ru: { title: "Целевая Страница", label: "Название Кампании", description: "Сфокусированная страница для конверсий и сбора лидов.", guidance: "<b>Целевая Страница</b> - это сфокусированная страница, предназначенная для того, чтобы посетитель выполнил одно действие, например, оставил данные или совершил покупку." },
                    zh: { title: "着陆页", label: "活动名称", description: "专注于转化和潜在客户收集的页面。", guidance: "<b>着陆页</b>是一个专注的页面，旨在让访问者执行单一操作，如留下详细信息或进行购买。" }
                }

            },

            general: {

                img: "https://images.unsplash.com/photo-1556761175-5973dc0f32e7?q=80&w=1932&auto=format&fit=crop",

                fields: ['websiteLink'],

                 structurePrompt: `Build a brand page with only the following sections, in this order: 1. Header with a logo and navigation. In the navigation, include internal links to relevant sections (About, Services, Contact) and also the provided external links ('Main Link', 'Additional External Link'). If button text is provided, use it. The external links should be prominent, perhaps as buttons. 2. Hero Section (id="home"). 3. About section (id="about"). 4. Services section (id="services"). 5. Contact section (id="contact"). 6. Footer.`,

                t: {

                    en: { title: "Brand Page", label: "Business Name", description: "Showcase your business to the world.", guidance: "A <b>Brand Page</b> is like your expanded digital business card. Its purpose is to present your business, services, and story professionally." },

                    he: { title: "דף תדמית", label: "שם העסק", description: "הצג את העסק שלך לעולם.", guidance: "<b>דף תדמית</b> הוא כמו כרטיס הביקור הדיגיטלי המורחב שלך. מטרתו להציג את העסק, השירותים והסיפור שלך בצורה מקצועית." },

                    ar: { title: "صفحة العلامة التجارية", label: "اسم العمل", description: "اعرض عملك للعالم.", guidance: "<b>صفحة العلامة التجارية</b> مثل بطاقة العمل الرقمية الموسعة. هدفها هو تقديم عملك وخدماتك وقصتك بشكل مهني." },
                    ja: { title: "ブランドページ", label: "ビジネス名", description: "あなたのビジネスを世界に紹介しましょう。", guidance: "<b>ブランドページ</b>は、拡張されたデジタル名刺のようなものです。その目的は、あなたのビジネス、サービス、ストーリーを専門的に提示することです。" },
                     es: { title: "Página de Marca", label: "Nombre del Negocio", description: "Muestra tu negocio al mundo.", guidance: "Una <b>Página de Marca</b> es como tu tarjeta de visita digital ampliada. Su propósito es presentar tu negocio, servicios e historia de manera profesional." },

                    fr: { title: "Page de Marque", label: "Nom de l'Entreprise", description: "Présentez votre entreprise au monde.", guidance: "Une <b>Page de Marque</b> est comme votre carte de visite numérique étendue. Son but est de présenter votre entreprise, vos services et votre histoire de manière professionnelle." },
                    de: { title: "Markenseite", label: "Geschäftsname", description: "Präsentieren Sie Ihr Geschäft der Welt.", guidance: "Eine <b>Markenseite</b> ist wie Ihre erweiterte digitale Visitenkarte. Ihr Zweck ist es, Ihr Geschäft, Ihre Dienstleistungen und Ihre Geschichte professionell zu präsentieren." },
                    ru: { title: "Страница Бренда", label: "Название Бизнеса", description: "Покажите свой бизнес миру.", guidance: "<b>Страница Бренда</b> - это как ваша расширенная цифровая визитная карточка. Её цель - профессионально представить ваш бизнес, услуги и историю." },
                    zh: { title: "品牌页面", label: "企业名称", description: "向世界展示您的企业。", guidance: "<b>品牌页面</b>就像您扩展的数字名片。它的目的是专业地展示您的企业、服务和故事。" }
                }

            },

            post: {

                img: "https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=2071&auto=format&fit=crop",

                fields: ['postLayout'],

                structurePrompt: {

                    base: `...`, 

                    layouts: {

                       "Partial Cover": `...`,

                       "Full Image Background": `...`,

                       "Bold Poster": `...`,

                    }

                },

                t: {

                    en: { title: "Marketing Post", label: "Post Title", description: "A visual post for social media." },

                    he: { title: "פוסט שיווקי", label: "כותרת הפוסט", description: "פוסט ויזואלי לרשתות חברתיות." },

                    ar: { title: "منشور تسويقي", label: "عنوان المنشور", description: "منشور بصري لوسائل التواصل الاجتماعي." },
                    ja: { title: "マーケティング投稿", label: "投稿タイトル", description: "ソーシャルメディア用のビジュアル投稿。" },
                    es: { title: "Publicación de Marketing", label: "Título de la Publicación", description: "Una publicación visual para redes sociales." },

                    fr: { title: "Publication Marketing", label: "Titre de la Publication", description: "Une publication visuelle pour les réseaux sociaux." },
                    de: { title: "Marketing-Beitrag", label: "Beitragstitel", description: "Ein visueller Beitrag für soziale Medien." },
                    ru: { title: "Маркетинговый Пост", label: "Заголовок Поста", description: "Визуальный пост для социальных сетей." },
                    zh: { title: "营销帖子", label: "帖子标题", description: "用于社交媒体的视觉帖子。" }
                }

            },

            flyer: {

                img: "https://images.unsplash.com/photo-1555939594-58d7cb561ad1?q=80&w=1887&auto=format&fit=crop",

                fields: ['menuItems'],

                structurePrompt: `Build a menu page with the following sections only: 1. Header (id="header") with the business name. 2. Category sections (e.g., 'Appetizers', 'Main Courses') and under each category, a grid of items based on the provided data. 3. Contact details and address as plain text (not links).`,

                t: {

                    en: { title: "Menu / Flyer", label: "Business / Restaurant Name", description: "Display products or dishes visually.", guidance: "A <b>Menu or Flyer</b> is designed to present information clearly and legibly, divided into categories and items." },

                    he: { title: "תפריט / פלאייר", label: "שם העסק / מסעדה", description: "הצג מוצרים או מנות בצורה ויזואלית.", guidance: "<b>תפריט או פלאייר</b> נועד להציג מידע בצורה ברורה וקלה לקריאה, מחולק לקטגוריות ופריטים." },

                    ar: { title: "قائمة / نشرة", label: "اسم العمل / المطعم", description: "اعرض المنتجات أو الأطباق بصرياً.", guidance: "<b>القائمة أو النشرة</b> مصممة لعرض المعلومات بوضوح ومقروئية، مقسمة إلى فئات وعناصر." },
                    ja: { title: "メニュー / チラシ", label: "ビジネス名 / レストラン名", description: "製品や料理を視覚的に表示します。", guidance: "<b>メニューやチラシ</b>は、情報を明確で読みやすく提示するよう設計されており、カテゴリーとアイテムに分かれています。" },
                    es: { title: "Menú / Folleto", label: "Nombre del Negocio / Restaurante", description: "Muestra productos o platos visualmente.", guidance: "Un <b>Menú o Folleto</b> está diseñado para presentar información de forma clara y legible, dividida en categorías y artículos." },

                    fr: { title: "Menu / Flyer", label: "Nom de l'Entreprise / Restaurant", description: "Affichez des produits ou des plats de manière visuelle.", guidance: "Un <b>Menu ou Flyer</b> est conçu pour présenter des informations de manière claire et lisible, divisé en catégories et articles." },
                    de: { title: "Menü / Flyer", label: "Geschäftsname / Restaurantname", description: "Zeigen Sie Produkte oder Gerichte visuell an.", guidance: "Ein <b>Menü oder Flyer</b> ist darauf ausgelegt, Informationen klar und lesbar zu präsentieren, unterteilt in Kategorien und Artikel." },
                    ru: { title: "Меню / Листовка", label: "Название Бизнеса / Ресторана", description: "Визуально отображайте продукты или блюда.", guidance: "<b>Меню или Листовка</b> предназначены для четкого и разборчивого представления информации, разделенной на категории и элементы." },
                    zh: { title: "菜单 / 传单", label: "企业名称 / 餐厅名称", description: "视觉展示产品或菜肴。", guidance: "<b>菜单或传单</b>旨在清晰易读地呈现信息，分为类别和项目。" }
                }

            },

            product: {

                img: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=1999&auto=format&fit=crop",

                fields: ['pricing'],

                structurePrompt: `Build a product page with the following sections only: 1. Main section (id="home") with a product image, name, price, and a purchase button. 2. Detailed description section (id="description").`,

                t: {

                    en: { title: "Product Page", label: "Product Name", description: "Sell a specific product.", guidance: "A <b>Product Page</b> focuses on a single product, showcasing its features and benefits to lead to a purchase." },

                    he: { title: "דף מוצר", label: "שם המוצר", description: "מכור מוצר ספציפי.", guidance: "<b>דף מוצר</b> מתמקד במוצר אחד, מציג את התכונות והתועלות שלו במטרה להוביל לרכישה." },

                    es: { title: "Página de Producto", label: "Nombre del Producto", description: "Vende un producto específico.", guidance: "Una <b>Página de Producto</b> se centra en un solo producto, mostrando sus características y beneficios para conducir a una compra." },

                    fr: { title: "Page Produit", label: "Nom du Produit", description: "Vendez un produit spécifique.", guidance: "Une <b>Page Produit</b> se concentre sur un seul produit, mettant en valeur ses caractéristiques et avantages pour inciter à l'achat." }

                }

            },

            artist: {

                img: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=2070&auto=format&fit=crop",

                fields: ['websiteLink'],

                structurePrompt: `Build an artist page with the following sections only: 1. Header with internal navigation (Biography, Gallery, Contact) and also the provided external links ('Main Link', 'Additional External Link'). 2. Hero Section (id="home") with a picture and the artist's name. 3. Biography section (id="bio"). 4. Works gallery (id="gallery"). 5. Contact details (id="contact").`,

                t: {

                    en: { title: "Artist Page", label: "Artist Name", description: "Promote yourself and your work.", guidance: "An <b>Artist Page</b> is a digital portfolio, showcasing your creations and personal story." },

                    he: { title: "דף אומן", label: "שם האומן", description: "קדם את עצמך ואת היצירה שלך.", guidance: "<b>דף אומן</b> הוא תיק עבודות דיגיטלי, המציג את היצירות שלך ואת הסיפור האישי שלך." },

                    es: { title: "Página de Artista", label: "Nombre del Artista", description: "Promociónate a ti mismo y a tu trabajo.", guidance: "Una <b>Página de Artista</b> es un portafolio digital, que muestra tus creaciones y tu historia personal." },

                    fr: { title: "Page d'Artiste", label: "Nom de l'Artiste", description: "Faites votre promotion et celle de votre travail.", guidance: "Une <b>Page d'Artiste</b> est un portfolio numérique, présentant vos créations et votre histoire personnelle." }

                }

            },

            businessCard: {

                img: "https://images.unsplash.com/photo-1560250097-0b93528c311a?q=80&w=1887&auto=format&fit=crop",

                fields: [],

                structurePrompt: `Build a digital business card designed as a single central card (id="vcard"). It must contain a picture, name, title, short description, and clear action buttons for contact.`,

                t: {

                    en: { title: "Digital Business Card", label: "Your Name", description: "A personal, focused, and impressive page.", guidance: "A <b>Digital Business Card</b> is a simple and focused page, centralizing all your contact methods in one place." },

                    he: { title: "כרטיס ביקור דיגיטלי", label: "השם שלך", description: "דף אישי, ממוקד ומרשים.", guidance: "<b>כרטיס ביקור דיגיטלי</b> הוא דף פשוט וממוקד, המרכז את כל דרכי יצירת הקשר איתך במקום אחד." },

                    es: { title: "Tarjeta de Visita Digital", label: "Tu Nombre", description: "Una página personal, enfocada e impresionante.", guidance: "Una <b>Tarjeta de Visita Digital</b> es una página simple y enfocada, que centraliza todos tus métodos de contacto en un solo lugar." },

                    fr: { title: "Carte de Visite Numérique", label: "Votre Nom", description: "Une page personnelle, ciblée et impressionnante.", guidance: "Une <b>Carte de Visite Numérique</b> est une page simple et ciblée, centralisant toutes vos méthodes de contact en un seul endroit." }

                }

            },

            event: {

                img: "https://images.unsplash.com/photo-1519751138087-5bf79df62d5b?q=80&w=1887&auto=format&fit=crop",

                fields: ['eventDetails'],

                structurePrompt: `Build an event invitation with the following sections: 
1. Hero Section (id="home") with the event name and date
2. Countdown Timer (id="countdown-timer") - Display 3 boxes from RIGHT to LEFT: Days (id="days"), Hours (id="hours"), Minutes (id="minutes"). Use the Event Date from form data to calculate countdown. Style with gradient background and large numbers. Add JavaScript to update every minute.
3. Event details (id="details") with location, time, and additional information
4. RSVP form (id="rsvp") with fields: name, phone, email, number of guests (+1, +2, etc), notes`,

                t: {

                    en: { title: "Event Invitation", label: "Event Name", description: "Invite people to a special event.", guidance: "An <b>Event Invitation</b> is a page designed to create excitement and provide all important information for an upcoming event." },

                    he: { title: "הזמנה לאירוע", label: "שם האירוע", description: "הזמן אנשים לאירוע מיוחד.", guidance: "<b>הזמנה לאירוע</b> היא דף שנועד לייצר התרגשות ולספק את כל המידע החשוב לקראת אירוע קרוב." },

                    es: { title: "Invitación a Evento", label: "Nombre del Evento", description: "Invita a gente a un evento especial.", guidance: "Una <b>Invitación a Evento</b> es una página diseñada para crear expectación y proporcionar toda la información importante para un próximo evento." },

                    fr: { title: "Invitation à un Événement", label: "Nom de l'Événement", description: "Invitez des personnes à un événement spécial.", guidance: "Une <b>Invitation à un Événement</b> est une page conçue pour susciter l'enthousiasme et fournir toutes les informations importantes pour un événement à venir." }

                }

            },

            course: {

                img: "https://images.unsplash.com/photo-1588072432836-e10032774350?q=80&w=2072&auto=format&fit=crop",

                fields: ['courseDetails', 'websiteLink'],

                structurePrompt: `Build a course page with the following sections: 1. Header with navigation containing the provided external links ('Main Link', 'Additional External Link'). 2. Hero Section (id="home") with the course name and a central promise. 3. Countdown timer (id="countdown-timer") with elements having IDs: days, hours, minutes, seconds. **Very important**: The display order for Hebrew should be right-to-left: days, hours, minutes, seconds. 4. "About the Course" section (id="about") with a detailed description. 5. "About the Instructor" section (id="instructor") with a **circular** image (class="rounded-full"), the instructor's name (from data), and a short description. 6. "Who is this course for" section (id="for-whom"). 7. Course details (id="details") - location. 8. A prominent registration button that leads to the provided registration link.`,

                t: {

                    en: { title: "Course Page", label: "Course Name", description: "Market and register for a course or workshop.", guidance: "A <b>Course Page</b> is designed to market a course or workshop, introduce the instructor, and provide all necessary information for registration." },

                    he: { title: "דף קורס", label: "שם הקורס", description: "שיווק והרשמה לקורס או סדנה.", guidance: "<b>דף קורס</b> נועד לשווק קורס או סדנה, להציג את המרצה, ולספק את כל המידע הדרוש להרשמה." },

                    es: { title: "Página de Curso", label: "Nombre del Curso", description: "Promociona e inscribe a un curso o taller.", guidance: "Una <b>Página de Curso</b> está diseñada para promocionar un curso o taller, presentar al instructor y proporcionar toda la información necesaria para la inscripción." },

                    fr: { title: "Page de Cours", label: "Nom du Cours", description: "Faites la promotion et l'inscription à un cours ou un atelier.", guidance: "Une <b>Page de Cours</b> est conçue pour promouvoir un cours ou un atelier, présenter l'instructeur et fournir toutes les informations nécessaires à l'inscription." }

                }

            },

            portfolio: {

                img: "https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=2070&auto=format&fit=crop",

                fields: ['websiteLink'],

                structurePrompt: "Build a portfolio page with the following sections: 1. Header with navigation. 2. Hero Section (id='home') with a professional statement. 3. 'Featured Projects' section (id='projects') with a visual gallery of works. 4. 'Services' or 'Skills' section (id='skills'). 5. 'About' section (id='about'). 6. Contact section (id='contact').",

                t: {

                    en: { title: "Portfolio", label: "Your Name / Agency Name", description: "Showcase your projects and skills.", guidance: "A <b>Portfolio</b> is where you display your best work, tell your story, and attract new clients." },

                    he: { title: "תיק עבודות", label: "השם שלך / שם הסוכנות", description: "הצג את הפרויקטים והכישורים שלך.", guidance: "<b>תיק עבודות</b> הוא המקום להציג את העבודות הטובות ביותר שלך, לספר על עצמך ולמשוך לקוחות חדשים." },

                    es: { title: "Portafolio", label: "Tu Nombre / Nombre de la Agencia", description: "Muestra tus proyectos y habilidades.", guidance: "Un <b>Portafolio</b> es donde muestras tu mejor trabajo, cuentas tu historia y atraes a nuevos clientes." },

                    fr: { title: "Portfolio", label: "Votre Nom / Nom de l'Agence", description: "Présentez vos projets et vos compétences.", guidance: "Un <b>Portfolio</b> est l'endroit où vous présentez votre meilleur travail, racontez votre histoire et attirez de nouveaux clients." }

                }

            },

            realEstate: {

                img: "https://images.unsplash.com/photo-1560518883-ce09059eeffa?q=80&w=1973&auto=format&fit=crop",

                fields: ['propertyDetails'],

                structurePrompt: "Build a real estate property landing page with the following sections: 1. Hero Section with a primary image of the property, address, and price. 2. Image gallery (id='gallery'). 3. 'Property Description' section (id='description') with marketing text. 4. 'Technical Specs' section (id='specs') showing the number of bedrooms, bathrooms, and square meters/feet. 5. Agent contact section (id='contact').",

                t: {

                    en: { title: "Property for Sale", label: "Property Address", description: "A stunning landing page to sell a real estate property.", guidance: "A <b>Property Page</b> showcases a specific property with all important details: photos, description, technical specs, and agent contact information." },

                    he: { title: "נכס למכירה", label: "כתובת הנכס", description: "דף נחיתה מרהיב למכירת נכס נדל\"ן.", guidance: "<b>דף נכס</b> מציג נכס ספציפי עם כל הפרטים החשובים: תמונות, תיאור, מפרט טכני ופרטי יצירת קשר עם הסוכן." },

                    es: { title: "Propiedad en Venta", label: "Dirección de la Propiedad", description: "Una impresionante página de aterrizaje para vender una propiedad inmobiliaria.", guidance: "Una <b>Página de Propiedad</b> muestra una propiedad específica con todos los detalles importantes: fotos, descripción, especificaciones técnicas e información de contacto del agente." },

                    fr: { title: "Propriété à Vendre", label: "Adresse de la Propriété", description: "Une superbe page de destination pour vendre un bien immobilier.", guidance: "Une <b>Page Propriété</b> présente un bien spécifique avec tous les détails importants : photos, description, spécifications techniques et coordonnées de l'agent." }

                }

            },

            onlineStore: {

                img: "https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?q=80&w=2340&auto=format&fit=crop",

                fields: ['productManagement'],

                structurePrompt: `Build a complete online store with modern design. Include:

1. **Fixed Header** with store logo, navigation menu, shopping cart icon (with class="cart-icon")
2. **Hero Section** with store name and tagline  
3. **Product Catalog** with 6-8 products in a responsive grid layout (grid-cols-1 md:grid-cols-2 lg:grid-cols-3)

**🚨 CRITICAL - EVERY PRODUCT CARD MUST INCLUDE THIS EXACT STRUCTURE:**
<div class="product-card">
  <img src="PRODUCT_IMAGE_URL" alt="PRODUCT_NAME">
  <h3 class="product-name">PRODUCT_NAME</h3>
  <p class="product-price">₪PRICE</p>
  <button onclick="addToCart('PRODUCT_NAME', PRICE, 'PRODUCT_IMAGE_URL')" class="btn-add-cart">🛒 הוסף לעגלה</button>
</div>

**IMPORTANT:** Replace PRODUCT_NAME, PRICE, and PRODUCT_IMAGE_URL with real values for each product.

4. **WhatsApp Bot** button (bottom-left, green background)
5. **AI Bot** button (bottom-right, purple background)  
6. **Accessibility Button** (top-right corner, small, wheelchair icon ♿)

**🚨 MANDATORY REQUIREMENTS:**
- EVERY product MUST have a button with onclick="addToCart('NAME', PRICE, 'IMAGE')"
- Cart icon MUST have class="cart-icon"
- DO NOT create shopping cart sidebar in HTML (injected by JavaScript)
- DO NOT create checkout form in HTML (handled by JavaScript)
- DO NOT add ANY WhatsApp checkout - handled by our system`,

                t: {

                    en: { title: "Online Store", label: "Store Name", description: "Create a complete online store.", guidance: "An <b>Online Store</b> is a complete e-commerce website with product catalog, shopping cart, and checkout functionality." },

                    he: { title: "חנות מקוונת", label: "שם החנות", description: "צור חנות מקוונת שלמה.", guidance: "<b>חנות מקוונת</b> היא אתר מסחר אלקטרוני מלא עם קטלוג מוצרים, עגלת קניות ופונקציונליות תשלום." },

                    es: { title: "Tienda Online", label: "Nombre de la Tienda", description: "Crea una tienda online completa.", guidance: "Una <b>Tienda Online</b> es un sitio web de comercio electrónico completo con catálogo de productos, carrito de compras y funcionalidad de pago." },

                    fr: { title: "Boutique en Ligne", label: "Nom de la Boutique", description: "Créez une boutique en ligne complète.", guidance: "Une <b>Boutique en Ligne</b> est un site web de commerce électronique complet avec catalogue de produits, panier d'achat et fonctionnalité de paiement." }

                }

            },

            appLaunch: {

                img: "https://images.unsplash.com/photo-1551650975-87deedd944c3?q=80&w=1974&auto=format&fit=crop",

                fields: ['appLinks'],

                structurePrompt: "Build a landing page for an app launch with the following sections: 1. Hero Section (id='home') with the app name, a catchy slogan, and download buttons for the App Store and Google Play. 2. 'Key Features' section (id='features') showcasing 3-4 features with icons. 3. A section displaying screenshots of the app. 4. 'Testimonials' section (id='testimonials'). 5. Contact section (id='contact').",

                t: {

                    en: { title: "App Launch", label: "App Name", description: "Introduce your new app to the world.", guidance: "A <b>Launch Page</b> is an essential tool for marketing a new app, showcasing key features and driving downloads." },

                    he: { title: "השקת אפליקציה", label: "שם האפליקציה", description: "הצג את האפליקציה החדשה שלך לעולם.", guidance: "<b>דף השקה</b> הוא כלי חיוני לשיווק אפליקציה חדשה, המציג את התכונות המרכזיות ומוביל להורדה." },

                    es: { title: "Lanzamiento de App", label: "Nombre de la App", description: "Presenta tu nueva aplicación al mundo.", guidance: "Una <b>Página de Lanzamiento</b> es una herramienta esencial para comercializar una nueva aplicación, mostrando características clave e impulsando las descargas." },

                    fr: { title: "Lancement d'Application", label: "Nom de l'Application", description: "Présentez votre nouvelle application au monde.", guidance: "Une <b>Page de Lancement</b> est un outil essentiel pour commercialiser une nouvelle application, en présentant les fonctionnalités clés et en encourageant les téléchargements." }

                }

            }

        };



        const availableSections = {

            testimonials: {

                icon: "star",

                t: {

                    en: { title: "Testimonials", prompt: "Create a 'Testimonials' section (id='testimonials') with 3 fictitious but believable recommendations, including the recommender's name." },

                    he: { title: "לקוחות ממליצים", prompt: "צור מקטע 'לקוחות ממליצים' (id='testimonials') עם 3 המלצות פיקטיביות אך אמינות, כולל שם הממליץ." },

                    ar: { title: "شهادات العملاء", prompt: "أنشئ قسم 'شهادات العملاء' (id='testimonials') مع 3 توصيات وهمية ولكن معقولة، بما في ذلك اسم الموصي." },

                    es: { title: "Testimonios", prompt: "Crea una sección de 'Testimonios' (id='testimonials') con 3 recomendaciones ficticias pero creíbles, incluyendo el nombre de quien recomienda." },

                    fr: { title: "Témoignages", prompt: "Créez une section 'Témoignages' (id='testimonials') avec 3 recommandations fictives mais crédibles, incluant le nom de la personne qui recommande." }

                }

            },

            gallery: {

                icon: "image",

                 t: {

                    en: { title: "Image Gallery", prompt: "Create an image gallery section (id='gallery') with 6 placeholder images from placehold.co." },

                    he: { title: "גלריית תמונות", prompt: "צור מקטע גלריית תמונות (id='gallery') עם 6 תמונות placeholder מ-placehold.co." },

                    ar: { title: "معرض الصور", prompt: "أنشئ قسم معرض الصور (id='gallery') مع 6 صور مؤقتة من placehold.co." },

                    es: { title: "Galería de Imágenes", prompt: "Crea una sección de galería de imágenes (id='gallery') con 6 imágenes de marcador de posición de placehold.co." },

                    fr: { title: "Galerie d'Images", prompt: "Créez une section de galerie d'images (id='gallery') avec 6 images de substitution de placehold.co." }

                }

            },

            faq: {

                icon: "help-circle",

                 t: {

                    en: { title: "FAQ", prompt: "Create an 'FAQ' section (id='faq') with 4 relevant common questions and short answers." },

                    he: { title: "שאלות ותשובות", prompt: "צור מקטע 'שאלות ותשובות' (id='faq') עם 4 שאלות נפוצות רלוונטיות ותשובות קצרות." },

                    ar: { title: "الأسئلة الشائعة", prompt: "أنشئ قسم 'الأسئلة الشائعة' (id='faq') مع 4 أسئلة شائعة ذات صلة وإجابات قصيرة." },

                    es: { title: "Preguntas Frecuentes", prompt: "Crea una sección de 'Preguntas Frecuentes' (id='faq') con 4 preguntas comunes relevantes y respuestas cortas." },

                    fr: { title: "FAQ", prompt: "Créez une section 'FAQ' (id='faq') avec 4 questions fréquentes pertinentes et des réponses courtes." }

                }

            },

            team: {

                icon: "users",

                t: {

                    en: { title: "Our Team", prompt: "Create an 'Our Team' section (id='team') with 3 fictitious team members, including a picture, name, and role." },

                    he: { title: "הצוות שלנו", prompt: "צור מקטע 'הצוות שלנו' (id='team') עם 3 חברי צוות פיקטיביים, כולל תמונה, שם ותפקיד." },

                    ar: { title: "فريقنا", prompt: "أنشئ قسم 'فريقنا' (id='team') مع 3 أعضاء فريق وهميين، بما في ذلك صورة واسم ودور." },

                    es: { title: "Nuestro Equipo", prompt: "Crea una sección de 'Nuestro Equipo' (id='team') con 3 miembros de equipo ficticios, incluyendo una foto, nombre y cargo." },

                    fr: { title: "Notre Équipe", prompt: "Créez une section 'Notre Équipe' (id='team') avec 3 membres d'équipe fictifs, incluant une photo, un nom et un rôle." }

                }

            },

            pricingTable: {

                icon: "dollar-sign",

                t: {

                    en: { title: "Pricing Table", prompt: "Create a 'Pricing Table' section (id='pricing') with 3 different packages (e.g., Basic, Popular, Premium), including a list of features and a price for each." },

                    he: { title: "טבלת מחירים", prompt: "צור מקטע 'טבלת מחירים' (id='pricing') עם 3 חבילות שונות (לדוגמה: בסיסית, פופולרית, פרימיום), כולל רשימת תכונות ומחיר לכל אחת." },

                    ar: { title: "جدول الأسعار", prompt: "أنشئ قسم 'جدول الأسعار' (id='pricing') مع 3 حزم مختلفة (مثل: أساسية، شائعة، مميزة)، بما في ذلك قائمة بالميزات وسعر لكل منها." },

                    es: { title: "Tabla de Precios", prompt: "Crea una sección de 'Tabla de Precios' (id='pricing') con 3 paquetes diferentes (por ejemplo, Básico, Popular, Premium), incluyendo una lista de características y un precio para cada uno." },

                    fr: { title: "Tableau de Prix", prompt: "Créez une section 'Tableau de Prix' (id='pricing') avec 3 forfaits différents (par exemple, Basique, Populaire, Premium), incluant une liste de fonctionnalités et un prix pour chacun." }

                }

            },

            callToAction: {

                icon: "megaphone",

                t: {

                    en: { title: "Call to Action", prompt: "Create a visually prominent 'Call to Action' section (id='cta') with a different background color, a compelling headline, and a large, clear button." },

                    he: { title: "קריאה לפעולה", prompt: "צור מקטע קריאה לפעולה (id='cta') ויזואלי ובולט, עם רקע בצבע שונה, כותרת משכנעת וכפתור גדול וברור." },

                    ar: { title: "دعوة للعمل", prompt: "أنشئ قسم 'دعوة للعمل' (id='cta') بارز بصريًا بخلفية بلون مختلف وعنوان مقنع وزر كبير وواضح." },

                    es: { title: "Llamada a la Acción", prompt: "Crea una sección de 'Llamada a la Acción' (id='cta') visualmente destacada con un color de fondo diferente, un titular convincente y un botón grande y claro." },

                    fr: { title: "Appel à l'Action", prompt: "Créez une section 'Appel à l'Action' (id='cta') visuellement proéminente avec une couleur de fond différente, un titre convaincant et un bouton grand et clair." }

                }

            }

        };

        

        // --- Supabase Client ---

        const SUPABASE_URL = 'https://osoqfadqohqcauawzmmq.supabase.co';

        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zb3FmYWRxb2hxY2F1YXd6bW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2OTIzMjMsImV4cCI6MjA3MzI2ODMyM30.TBLmKIntYGSfBm2StItfWm87-ebojV_NbaKNcYNWMPg';

        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        

        // --- Element Selectors ---

        const ui = {

            typeSelectionView: document.getElementById('type-selection-view'),

            formView: document.getElementById('form-view'),

            previewView: document.getElementById('preview-view'),

            detailsForm: document.getElementById('details-form'),

            pageTypeTitle: document.getElementById('page-type-title'),

            mainNameLabel: document.getElementById('mainNameLabel'),

            dynamicFieldsContainer: document.getElementById('dynamic-fields'),

            optionalSectionsFieldset: document.getElementById('optional-sections-fieldset'),

            socialMediaFieldset: document.getElementById('social-media-fieldset'),

            addressFieldContainer: document.getElementById('address-field-container'),

            accessibilityFieldContainer: document.getElementById('accessibility-field-container'),

            assistantContainer: document.getElementById('assistant-container'),

            assistantAvatar: document.getElementById('assistant-avatar'),

            guidanceBubble: document.getElementById('guidance-bubble'),

            generationView: document.getElementById('generation-view'),

            previewContainer: document.getElementById('preview-container'),

            customModal: document.getElementById('custom-modal'),

            modalMessage: document.getElementById('modal-message'),

            modalCloseBtn: document.getElementById('modal-close-btn'),

            generateBtnText: document.getElementById('button-text'),

            generateBtnLoader: document.getElementById('button-loader'),

            designSelectionContainer: document.querySelector('[data-selection="style"]'),

            designStyleFieldset: document.getElementById('design-style-fieldset'),

            previewIframe: document.getElementById('preview-iframe'),

            backToFormBtn: document.getElementById('back-to-form-btn'),

            toolsFab: document.getElementById('tools-fab'),

            toolsMenu: document.getElementById('tools-menu'),

            savePageBtn: document.getElementById('save-page-btn'),

            downloadPageBtn: document.getElementById('download-page-btn'),
            iframeImageUploader: document.getElementById('iframe-image-uploader'),

            editToolsGroup: document.getElementById('edit-tools-group'),

            uploadImageBtn: document.getElementById('upload-image-btn'),
            
            deleteImageBtn: document.getElementById('delete-image-btn'),

            textColorPicker: document.getElementById('text-color-picker'),

            bgColorPicker: document.getElementById('bg-color-picker'),

            opacityControl: document.getElementById('opacity-control'),

            opacitySlider: document.getElementById('opacity-slider'),

            templateGrid: document.getElementById('template-grid'),

            languageSelector: document.getElementById('language-selector'),

            countryCodeSelect: document.getElementById('countryCode')

        };

        

        // --- State Variables ---

        let state = {

            selectedPageType: '',

            selectedPageTitle: '',

            selectedStyle: null,

            selectedLayout: null,

            selectedClipStyle: null,

            isEditing: false,

            currentElementToEdit: null,

            elementToModifyForImage: null,

            imageModificationType: null,

            currentOverlayToEdit: null,

            originalDescription: '',

            currentLanguage: 'en'

        };





        // --- Initialization ---

        async function initializeApp() {

            lucide.createIcons();

            populateCountryCodes();

            await handleAuth();

            const userLang = navigator.language.split('-')[0];

            if (translations[userLang]) {

                state.currentLanguage = userLang;

                ui.languageSelector.value = userLang;

            }
            
            // הגדר ברירת מחדל לשפת הפלט - עברית
            const outputLanguageSelect = document.getElementById('outputLanguage');
            if (outputLanguageSelect && !outputLanguageSelect.value) {
                outputLanguageSelect.value = 'he';
            }

            setLanguage(state.currentLanguage);

            bindEventListeners();

        }



        async function handleAuth() {

            const { data: { session }, error } = await sb.auth.getSession();

            if (error) {

                console.error("Error getting session:", error);

                return;

            }

            if (!session) {

                 const { data: anonData, error: anonError } = await sb.auth.signInAnonymously();

                 if (anonError) {

                    console.error("Error signing in anonymously:", anonError);

                    showModal('modal_error_auth');

                 } else {

                    console.log("Signed in anonymously:", anonData.user.id);

                 }

            } else {

                console.log("User session found:", session.user.id);

            }

        }



        // --- I18N Functions ---

        function populateCountryCodes() {

            countries.forEach(country => {

                const option = document.createElement('option');

                option.value = country.code;

                option.textContent = country.name;

                ui.countryCodeSelect.appendChild(option);

            });

            // Set Israel as default

            ui.countryCodeSelect.value = "972";

        }



        function getTranslation(key, lang = state.currentLanguage) {

            const translations = {
                'he': {
                    'modal_close_btn': 'סגור',
                    'main_title': 'יוצר דפי נחיתה מתקדם',
                    'main_subtitle': 'צור דף נחיתה מקצועי תוך דקות עם בוט AI חכם',
                    'create_page_title': 'צור דף',
                    'form_subtitle': 'מלא את הפרטים הבאים',
                    'fieldset_basic_details': 'פרטים בסיסיים',
                    'label_contact_name': 'שם איש קשר',
                    'label_email': 'אימייל',
                    'label_phone': 'טלפון',
                    'label_description': 'תיאור העסק',
                    'label_address': 'כתובת',
                    'fieldset_optional_sections': 'סעיפים אופציונליים',
                    'fieldset_social_media': 'רשתות חברתיות',
                    'label_youtube_display': 'הצגת YouTube',
                    'label_youtube_embed': 'קוד הטמעה',
                    'label_youtube_link': 'קישור',
                    'fieldset_design': 'עיצוב',
                    'label_hero_image': 'תמונת כותרת',
                    'label_use_as_background': 'השתמש כרקע',
                    'note_image_upload': 'העלה תמונה או השאר ריק',
                    'label_additional_settings': 'הגדרות נוספות',
                    'label_output_language': 'שפת הפלט',
                    'label_design_style': 'סגנון עיצוב',
                    'style_minimalist_pro': 'מינימליסטי מקצועי',
                    'style_midnight': 'חצות',
                    'style_claymorphism': 'קליי',
                    'style_retro_title': 'רטרו',
                    'style_retro': 'רטרו',
                    'style_aurora': 'אורורה',
                    'style_bento': 'בנטו',
                    'style_comic': 'קומיקס',
                    'style_surreal': 'סוריאליסטי',
                    'btn_back': 'חזור',
                    'btn_generate': 'צור דף',
                    'fieldset_external_links': 'קישורים חיצוניים',
                    'label_main_button_text': 'טקסט הכפתור הראשי',
                    'label_main_button_url': 'כתובת הכפתור הראשי',
                    'fieldset_property_details': 'פרטי הנכס',
                    'label_beds': 'חדרי שינה',
                    'label_baths': 'חדרי רחצה',
                    'label_sqft': 'מ״ר',
                    'label_price': 'מחיר',
                    'fieldset_app_links': 'קישורי אפליקציות',
                    'label_app_store_link': 'קישור App Store',
                    'label_google_play_link': 'קישור Google Play',
                    'fieldset_event_details': 'פרטי האירוע',
                    'label_event_date': 'תאריך האירוע',
                    'label_event_location': 'שם האולם / מקום האירוע',
                    'label_event_address': 'כתובת המקום',
                    'gen_text_1': '🤖 הבוט החכם שלנו מתחיל ליצור את הדף שלך...',
                    'gen_text_2': '📝 מנתח את הפרטים שמילאת ויוצר תוכן מותאם אישית...',
                    'gen_text_3': '🎨 בוחר את העיצוב המושלם ומתאים את הצבעים והגופנים...',
                    'gen_text_4': '⚡ מיישם טכנולוגיות מתקדמות ומכין את הדף לפרסום...'
                },
                'en': {
                    'modal_close_btn': 'Close',
                    'main_title': 'Advanced Landing Page Creator',
                    'main_subtitle': 'Create professional landing pages in minutes with smart AI bot',
                    'create_page_title': 'Create Page',
                    'form_subtitle': 'Fill in the following details',
                    'fieldset_basic_details': 'Basic Details',
                    'label_contact_name': 'Contact Name',
                    'label_email': 'Email',
                    'label_phone': 'Phone',
                    'label_description': 'Business Description',
                    'label_address': 'Address',
                    'fieldset_optional_sections': 'Optional Sections',
                    'fieldset_social_media': 'Social Media',
                    'label_youtube_display': 'YouTube Display',
                    'label_youtube_embed': 'Embed Code',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hero Image',
                    'label_use_as_background': 'Use as Background',
                    'note_image_upload': 'Upload image or leave empty',
                    'label_additional_settings': 'Additional Settings',
                    'label_output_language': 'Output Language',
                    'label_design_style': 'Design Style',
                    'style_minimalist_pro': 'Minimalist Pro',
                    'style_midnight': 'Midnight',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Back',
                    'btn_generate': 'Generate Page',
                    'fieldset_external_links': 'External Links',
                    'label_main_button_text': 'Main Button Text',
                    'label_main_button_url': 'Main Button URL',
                    'fieldset_property_details': 'Property Details',
                    'label_beds': 'Bedrooms',
                    'label_baths': 'Bathrooms',
                    'label_sqft': 'Sq Ft',
                    'label_price': 'Price',
                    'fieldset_app_links': 'App Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link',
                    'fieldset_event_details': 'Event Details',
                    'label_event_date': 'Event Date',
                    'label_event_location': 'Event Location',
                    'label_guest_count': 'Expected Guest Count',
                    'gen_text_1': '🤖 Our smart bot is starting to create your page...',
                    'gen_text_2': '📝 Analyzing your details and creating personalized content...',
                    'gen_text_3': '🎨 Choosing the perfect design and matching colors & fonts...',
                    'gen_text_4': '⚡ Implementing advanced technologies and preparing for launch...'
                },
                'ar': {
                    'modal_close_btn': 'إغلاق',
                    'main_title': 'منشئ صفحات الهبوط المتقدم',
                    'main_subtitle': 'أنشئ صفحات هبوط احترافية في دقائق مع بوت ذكي',
                    'create_page_title': 'إنشاء صفحة',
                    'form_subtitle': 'املأ التفاصيل التالية',
                    'fieldset_basic_details': 'التفاصيل الأساسية',
                    'label_contact_name': 'اسم جهة الاتصال',
                    'label_email': 'البريد الإلكتروني',
                    'label_phone': 'الهاتف',
                    'label_description': 'وصف العمل',
                    'label_address': 'العنوان',
                    'fieldset_optional_sections': 'الأقسام الاختيارية',
                    'fieldset_social_media': 'وسائل التواصل الاجتماعي',
                    'label_youtube_display': 'عرض YouTube',
                    'label_youtube_embed': 'كود التضمين',
                    'label_youtube_link': 'الرابط',
                    'fieldset_design': 'التصميم',
                    'label_hero_image': 'صورة البطل',
                    'label_use_as_background': 'استخدم كخلفية',
                    'note_image_upload': 'ارفع صورة أو اتركها فارغة',
                    'label_additional_settings': 'إعدادات إضافية',
                    'label_output_language': 'لغة الإخراج',
                    'label_design_style': 'نمط التصميم',
                    'style_minimalist_pro': 'بسيط احترافي',
                    'style_midnight': 'منتصف الليل',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'رجعي',
                    'style_retro': 'رجعي',
                    'style_aurora': 'أورورا',
                    'style_bento': 'بنتو',
                    'btn_back': 'رجوع',
                    'btn_generate': 'إنشاء صفحة',
                    'fieldset_external_links': 'الروابط الخارجية',
                    'label_main_button_text': 'نص الزر الرئيسي',
                    'label_main_button_url': 'رابط الزر الرئيسي',
                    'fieldset_property_details': 'تفاصيل العقار',
                    'label_beds': 'غرف النوم',
                    'label_baths': 'الحمامات',
                    'label_sqft': 'قدم مربع',
                    'label_price': 'السعر',
                    'fieldset_app_links': 'روابط التطبيقات',
                    'label_app_store_link': 'رابط App Store',
                    'label_google_play_link': 'رابط Google Play',
                    'gen_text_1': '🤖 البوت الذكي يبدأ في إنشاء صفحتك...',
                    'gen_text_2': '📝 يحلل تفاصيلك وينشئ محتوى مخصص...',
                    'gen_text_3': '🎨 يختار التصميم المثالي ويطابق الألوان والخطوط...',
                    'gen_text_4': '⚡ يطبق التقنيات المتقدمة ويجهز للانطلاق...'
                },
                'ja': {
                    'modal_close_btn': '閉じる',
                    'main_title': '高度なランディングページ作成者',
                    'main_subtitle': 'スマートAIボットで数分でプロフェッショナルなランディングページを作成',
                    'create_page_title': 'ページ作成',
                    'form_subtitle': '以下の詳細を入力してください',
                    'fieldset_basic_details': '基本詳細',
                    'label_contact_name': '連絡先名',
                    'label_email': 'メール',
                    'label_phone': '電話',
                    'label_description': 'ビジネス説明',
                    'label_address': '住所',
                    'fieldset_optional_sections': 'オプションセクション',
                    'fieldset_social_media': 'ソーシャルメディア',
                    'label_youtube_display': 'YouTube表示',
                    'label_youtube_embed': '埋め込みコード',
                    'label_youtube_link': 'リンク',
                    'fieldset_design': 'デザイン',
                    'label_hero_image': 'ヒーロー画像',
                    'label_use_as_background': '背景として使用',
                    'note_image_upload': '画像をアップロードするか空のままにしてください',
                    'label_additional_settings': '追加設定',
                    'label_output_language': '出力言語',
                    'label_design_style': 'デザインスタイル',
                    'style_minimalist_pro': 'ミニマリストプロ',
                    'style_midnight': 'ミッドナイト',
                    'style_claymorphism': 'クレイモーフィズム',
                    'style_retro_title': 'レトロ',
                    'style_retro': 'レトロ',
                    'style_aurora': 'オーロラ',
                    'style_bento': 'ベント',
                    'btn_back': '戻る',
                    'btn_generate': 'ページ生成',
                    'fieldset_external_links': '外部リンク',
                    'label_main_button_text': 'メインボタンテキスト',
                    'label_main_button_url': 'メインボタンURL',
                    'fieldset_property_details': '物件詳細',
                    'label_beds': '寝室',
                    'label_baths': 'バスルーム',
                    'label_sqft': '平方フィート',
                    'label_price': '価格',
                    'fieldset_app_links': 'アプリリンク',
                    'label_app_store_link': 'App Storeリンク',
                    'label_google_play_link': 'Google Playリンク',
                    'gen_text_1': '🤖 スマートボットがページの作成を開始しています...',
                    'gen_text_2': '📝 詳細を分析し、パーソナライズされたコンテンツを作成中...',
                    'gen_text_3': '🎨 完璧なデザインを選択し、色とフォントをマッチング中...',
                    'gen_text_4': '⚡ 高度な技術を実装し、ローンチの準備中...'
                },
                'es': {
                    'modal_close_btn': 'Cerrar',
                    'main_title': 'Creador Avanzado de Páginas de Aterrizaje',
                    'main_subtitle': 'Crea páginas de aterrizaje profesionales en minutos con bot IA inteligente',
                    'create_page_title': 'Crear Página',
                    'form_subtitle': 'Completa los siguientes detalles',
                    'fieldset_basic_details': 'Detalles Básicos',
                    'label_contact_name': 'Nombre de Contacto',
                    'label_email': 'Correo',
                    'label_phone': 'Teléfono',
                    'label_description': 'Descripción del Negocio',
                    'label_address': 'Dirección',
                    'fieldset_optional_sections': 'Secciones Opcionales',
                    'fieldset_social_media': 'Redes Sociales',
                    'label_youtube_display': 'Visualización de YouTube',
                    'label_youtube_embed': 'Código de Integración',
                    'label_youtube_link': 'Enlace',
                    'fieldset_design': 'Diseño',
                    'label_hero_image': 'Imagen Principal',
                    'label_use_as_background': 'Usar como Fondo',
                    'note_image_upload': 'Subir imagen o dejar vacío',
                    'label_additional_settings': 'Configuraciones Adicionales',
                    'label_output_language': 'Idioma de Salida',
                    'label_design_style': 'Estilo de Diseño',
                    'style_minimalist_pro': 'Minimalista Pro',
                    'style_midnight': 'Medianoche',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Atrás',
                    'btn_generate': 'Generar Página',
                    'fieldset_external_links': 'Enlaces Externos',
                    'label_main_button_text': 'Texto del Botón Principal',
                    'label_main_button_url': 'URL del Botón Principal',
                    'fieldset_property_details': 'Detalles de la Propiedad',
                    'label_beds': 'Dormitorios',
                    'label_baths': 'Baños',
                    'label_sqft': 'Pies Cuadrados',
                    'label_price': 'Precio',
                    'fieldset_app_links': 'Enlaces de Aplicaciones',
                    'label_app_store_link': 'Enlace de App Store',
                    'label_google_play_link': 'Enlace de Google Play',
                    'gen_text_1': '🤖 Nuestro bot inteligente está empezando a crear tu página...',
                    'gen_text_2': '📝 Analizando tus detalles y creando contenido personalizado...',
                    'gen_text_3': '🎨 Eligiendo el diseño perfecto y combinando colores y fuentes...',
                    'gen_text_4': '⚡ Implementando tecnologías avanzadas y preparando para el lanzamiento...'
                },
                'fr': {
                    'modal_close_btn': 'Fermer',
                    'main_title': 'Créateur de Pages d\'Atterrissage Avancé',
                    'main_subtitle': 'Créez des pages d\'atterrissage professionnelles en minutes avec un bot IA intelligent',
                    'create_page_title': 'Créer une Page',
                    'form_subtitle': 'Remplissez les détails suivants',
                    'fieldset_basic_details': 'Détails de Base',
                    'label_contact_name': 'Nom du Contact',
                    'label_email': 'Email',
                    'label_phone': 'Téléphone',
                    'label_description': 'Description de l\'Entreprise',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Sections Optionnelles',
                    'fieldset_social_media': 'Réseaux Sociaux',
                    'label_youtube_display': 'Affichage YouTube',
                    'label_youtube_embed': 'Code d\'Intégration',
                    'label_youtube_link': 'Lien',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Image Principale',
                    'label_use_as_background': 'Utiliser comme Arrière-plan',
                    'note_image_upload': 'Télécharger une image ou laisser vide',
                    'label_additional_settings': 'Paramètres Supplémentaires',
                    'label_output_language': 'Langue de Sortie',
                    'label_design_style': 'Style de Design',
                    'style_minimalist_pro': 'Minimaliste Pro',
                    'style_midnight': 'Minuit',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Rétro',
                    'style_retro': 'Rétro',
                    'style_aurora': 'Aurore',
                    'style_bento': 'Bento',
                    'btn_back': 'Retour',
                    'btn_generate': 'Générer Page',
                    'fieldset_external_links': 'Liens Externes',
                    'label_main_button_text': 'Texte du Bouton Principal',
                    'label_main_button_url': 'URL du Bouton Principal',
                    'fieldset_property_details': 'Détails de la Propriété',
                    'label_beds': 'Chambres',
                    'label_baths': 'Salles de Bain',
                    'label_sqft': 'Pieds Carrés',
                    'label_price': 'Prix',
                    'fieldset_app_links': 'Liens d\'Applications',
                    'label_app_store_link': 'Lien App Store',
                    'label_google_play_link': 'Lien Google Play',
                    'gen_text_1': '🤖 Notre bot intelligent commence à créer votre page...',
                    'gen_text_2': '📝 Analyse vos détails et crée du contenu personnalisé...',
                    'gen_text_3': '🎨 Choisit le design parfait et assortit couleurs et polices...',
                    'gen_text_4': '⚡ Implémente des technologies avancées et prépare au lancement...'
                },
                'de': {
                    'modal_close_btn': 'Schließen',
                    'main_title': 'Erweiterter Landing Page Creator',
                    'main_subtitle': 'Erstellen Sie professionelle Landing Pages in Minuten mit intelligentem KI-Bot',
                    'create_page_title': 'Seite Erstellen',
                    'form_subtitle': 'Füllen Sie die folgenden Details aus',
                    'fieldset_basic_details': 'Grundlegende Details',
                    'label_contact_name': 'Kontaktname',
                    'label_email': 'E-Mail',
                    'label_phone': 'Telefon',
                    'label_description': 'Unternehmensbeschreibung',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Optionale Abschnitte',
                    'fieldset_social_media': 'Soziale Medien',
                    'label_youtube_display': 'YouTube-Anzeige',
                    'label_youtube_embed': 'Einbettungscode',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hauptbild',
                    'label_use_as_background': 'Als Hintergrund verwenden',
                    'note_image_upload': 'Bild hochladen oder leer lassen',
                    'label_additional_settings': 'Zusätzliche Einstellungen',
                    'label_output_language': 'Ausgabesprache',
                    'label_design_style': 'Design-Stil',
                    'style_minimalist_pro': 'Minimalistisch Pro',
                    'style_midnight': 'Mitternacht',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Zurück',
                    'btn_generate': 'Seite Generieren',
                    'fieldset_external_links': 'Externe Links',
                    'label_main_button_text': 'Hauptbutton-Text',
                    'label_main_button_url': 'Hauptbutton-URL',
                    'fieldset_property_details': 'Immobiliendetails',
                    'label_beds': 'Schlafzimmer',
                    'label_baths': 'Badezimmer',
                    'label_sqft': 'Quadratfuß',
                    'label_price': 'Preis',
                    'fieldset_app_links': 'App-Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link',
                    'gen_text_1': '🤖 Unser intelligenter Bot beginnt mit der Erstellung Ihrer Seite...',
                    'gen_text_2': '📝 Analysiert Ihre Details und erstellt personalisierten Inhalt...',
                    'gen_text_3': '🎨 Wählt das perfekte Design und passt Farben & Schriftarten an...',
                    'gen_text_4': '⚡ Implementiert fortschrittliche Technologien und bereitet auf den Start vor...'
                },
                'ru': {
                    'modal_close_btn': 'Закрыть',
                    'main_title': 'Продвинутый Создатель Лендингов',
                    'main_subtitle': 'Создавайте профессиональные лендинги за минуты с умным ИИ ботом',
                    'create_page_title': 'Создать Страницу',
                    'form_subtitle': 'Заполните следующие детали',
                    'fieldset_basic_details': 'Основные Детали',
                    'label_contact_name': 'Имя Контакта',
                    'label_email': 'Email',
                    'label_phone': 'Телефон',
                    'label_description': 'Описание Бизнеса',
                    'label_address': 'Адрес',
                    'fieldset_optional_sections': 'Дополнительные Секции',
                    'fieldset_social_media': 'Социальные Сети',
                    'label_youtube_display': 'Отображение YouTube',
                    'label_youtube_embed': 'Код Встраивания',
                    'label_youtube_link': 'Ссылка',
                    'fieldset_design': 'Дизайн',
                    'label_hero_image': 'Главное Изображение',
                    'label_use_as_background': 'Использовать как Фон',
                    'note_image_upload': 'Загрузить изображение или оставить пустым',
                    'label_additional_settings': 'Дополнительные Настройки',
                    'label_output_language': 'Язык Вывода',
                    'label_design_style': 'Стиль Дизайна',
                    'style_minimalist_pro': 'Минималистичный Про',
                    'style_midnight': 'Полночь',
                    'style_claymorphism': 'Claymorphism',
                    'style_retro_title': 'Ретро',
                    'style_retro': 'Ретро',
                    'style_aurora': 'Аврора',
                    'style_bento': 'Бенто',
                    'btn_back': 'Назад',
                    'btn_generate': 'Создать Страницу',
                    'fieldset_external_links': 'Внешние Ссылки',
                    'label_main_button_text': 'Текст Главной Кнопки',
                    'label_main_button_url': 'URL Главной Кнопки',
                    'fieldset_property_details': 'Детали Недвижимости',
                    'label_beds': 'Спальни',
                    'label_baths': 'Ванные',
                    'label_sqft': 'Квадратные Футы',
                    'label_price': 'Цена',
                    'fieldset_app_links': 'Ссылки на Приложения',
                    'label_app_store_link': 'Ссылка App Store',
                    'label_google_play_link': 'Ссылка Google Play',
                    'gen_text_1': '🤖 Наш умный бот начинает создавать вашу страницу...',
                    'gen_text_2': '📝 Анализирует ваши детали и создает персонализированный контент...',
                    'gen_text_3': '🎨 Выбирает идеальный дизайн и подбирает цвета и шрифты...',
                    'gen_text_4': '⚡ Внедряет передовые технологии и готовит к запуску...'
                },
                'zh': {
                    'modal_close_btn': '关闭',
                    'main_title': '高级着陆页创建器',
                    'main_subtitle': '使用智能AI机器人几分钟内创建专业着陆页',
                    'create_page_title': '创建页面',
                    'form_subtitle': '填写以下详细信息',
                    'fieldset_basic_details': '基本详情',
                    'label_contact_name': '联系人姓名',
                    'label_email': '邮箱',
                    'label_phone': '电话',
                    'label_description': '业务描述',
                    'label_address': '地址',
                    'fieldset_optional_sections': '可选部分',
                    'fieldset_social_media': '社交媒体',
                    'label_youtube_display': 'YouTube显示',
                    'label_youtube_embed': '嵌入代码',
                    'label_youtube_link': '链接',
                    'fieldset_design': '设计',
                    'label_hero_image': '主图',
                    'label_use_as_background': '用作背景',
                    'note_image_upload': '上传图片或留空',
                    'label_additional_settings': '其他设置',
                    'label_output_language': '输出语言',
                    'label_design_style': '设计风格',
                    'style_minimalist_pro': '极简专业',
                    'style_midnight': '午夜',
                    'style_claymorphism': '粘土形态',
                    'style_retro_title': '复古',
                    'style_retro': '复古',
                    'style_aurora': '极光',
                    'style_bento': '便当',
                    'btn_back': '返回',
                    'btn_generate': '生成页面',
                    'fieldset_external_links': '外部链接',
                    'label_main_button_text': '主按钮文本',
                    'label_main_button_url': '主按钮URL',
                    'fieldset_property_details': '房产详情',
                    'label_beds': '卧室',
                    'label_baths': '浴室',
                    'label_sqft': '平方英尺',
                    'label_price': '价格',
                    'fieldset_app_links': '应用链接',
                    'label_app_store_link': 'App Store链接',
                    'label_google_play_link': 'Google Play链接',
                    'gen_text_1': '🤖 我们的智能机器人开始创建您的页面...',
                    'gen_text_2': '📝 分析您的详细信息并创建个性化内容...',
                    'gen_text_3': '🎨 选择完美设计并匹配颜色和字体...',
                    'gen_text_4': '⚡ 实施先进技术并准备发布...'
                }
            };
            
            return translations[lang]?.[key] || translations['en']?.[key] || key;
        }



        function setLanguage(lang) {

            state.currentLanguage = lang;

            document.documentElement.lang = lang;

            document.documentElement.dir = (lang === 'he') ? 'rtl' : 'ltr';

            

            // Apply translations to all static elements

            document.querySelectorAll('[data-translate-key]').forEach(el => {

                const key = el.dataset.translateKey;

                el.textContent = getTranslation(key);

            });

             document.querySelectorAll('[data-translate-title]').forEach(el => {

                const key = el.dataset.translateTitle;

                el.title = getTranslation(key);

            });



            // Repopulate dynamic content

            populateTemplateGrid();



            // If in form view, update dynamic form labels

            if(ui.formView.classList.contains('active') && state.selectedPageType) {

                 const template = pageTemplates[state.selectedPageType].t[state.currentLanguage];

                 ui.pageTypeTitle.textContent = template.title;

                 ui.mainNameLabel.textContent = template.label;

                 createDynamicFields(pageTemplates[state.selectedPageType].fields);

            }

        }

        

        // --- Core Functions ---

        function switchView(hideView, showView) {

            if (showView === ui.formView) {

                ui.assistantContainer.classList.remove('hidden');

                // הסתר כפתורי שמירה והורדה במצב טופס
                ui.savePageBtn.classList.add('hidden');
                ui.downloadPageBtn.classList.add('hidden');
            } else {

                ui.assistantContainer.classList.add('hidden');

                // הצג כפתורי שמירה והורדה במצב תצוגה מקדימה
                ui.savePageBtn.classList.remove('hidden');
                ui.downloadPageBtn.classList.remove('hidden');
            }



            if (hideView === ui.previewView) {

                ui.previewView.classList.remove('active');

            } else {

                hideView.classList.add('fade-out');

            }

            

            setTimeout(() => {

                if (hideView !== ui.previewView) {

                    hideView.classList.remove('active', 'fade-out');

                }

                

                if (showView === ui.previewView) {

                    showView.classList.add('active');

                } else {

                    showView.classList.add('active', 'fade-in');

                }



            }, 300);

        }



        function showModal(messageKey) {

            ui.modalMessage.textContent = getTranslation(messageKey);

            ui.customModal.classList.add('visible');

        }



        function hideModal() {

            ui.customModal.classList.remove('visible');

        }



        function getYoutubeVideoId(url) {

            if (!url) return null;

            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;

            const match = url.match(regExp);

            return (match && match[2].length === 11) ? match[2] : null;

        }



        function createMasterPrompt(data) {

            console.log('createMasterPrompt called with data:', data);
            console.log('data.pageType:', data.pageType);
            console.log('data.outputLanguage:', data.outputLanguage);
            const s = (str) => (str || '').replace(/`/g, "'").replace(/\\/g, '\\\\');

            const templateRoot = pageTemplates[data.pageType];

            const templateLang = templateRoot.t[data.outputLanguage]; // Use OUTPUT language

            console.log('templateRoot:', templateRoot);
            console.log('templateLang:', templateLang);
            
            if (!templateRoot) {
                console.error('templateRoot is null/undefined for pageType:', data.pageType);
                return 'Error: Invalid page type';
            }
            
            if (!templateLang) {
                console.error('templateLang is null/undefined for outputLanguage:', data.outputLanguage);
                return 'Error: Invalid output language';
            }
            const youtubeVideoId = getYoutubeVideoId(data.youtubeLink);

            const cleanYoutubeEmbedUrl = youtubeVideoId ? `https://www.youtube.com/embed/${youtubeVideoId}` : null;

            

            let finalStructurePrompt = templateRoot.structurePrompt;

            

            if (data.pageType === 'post' && typeof finalStructurePrompt === 'object') {

                const postPromptConfig = finalStructurePrompt;

                const layoutInstructions = postPromptConfig.layouts[data.postLayout] || '';

                finalStructurePrompt = postPromptConfig.base.replace('{{LAYOUT_INSTRUCTIONS}}', layoutInstructions);

            }
            
            // For online store, add product count to prompt
            if (data.pageType === 'onlineStore' && data.productCount) {
                const productCountText = `\n\nIMPORTANT: Create exactly ${data.productCount} products in the product catalog grid.`;
                finalStructurePrompt += productCountText;
            }



            const optionalSections = [];

            document.querySelectorAll('input[name="optionalSections"]:checked').forEach(checkbox => {

                const sectionKey = checkbox.value;

                // בדוק אם השפה קיימת, אחרת השתמש באנגלית
                const sectionData = availableSections[sectionKey];
                const langData = sectionData.t[data.outputLanguage] || sectionData.t['en'];
                
                if (langData && langData.prompt) {
                    optionalSections.push(langData.prompt);
                }

            });

            if (optionalSections.length > 0) {

                const additionText = getTranslation('prompt_add_sections_instruction', data.outputLanguage);

                finalStructurePrompt += `\n\n${additionText}\n- ${optionalSections.join('\n- ')}`;

            }

            // הוסף טופס צור קשר רק לדפים שאינם הזמנות (כי בהזמנות יש בועת WhatsApp)
            if (data.pageType !== 'event') {
            const contactFormPrompt = `
## Contact Form Section (MANDATORY)
Create a contact form section with ID "contact-form" that includes:
- Name field (required)
- Email field (required) 
- Phone field (optional)
- Message textarea (required)
- Submit button
- Form validation
- Submit to WhatsApp or Email based on user choice

JavaScript functionality:
- Validate required fields
- On submit: Open WhatsApp with pre-filled message OR send email
- Show success/error messages
- Use business contact details from form data`;

            finalStructurePrompt += contactFormPrompt;
            }





            const optionalData = `

* Contact Name: ${s(data.contactName)}

* Email: ${s(data.email)}

* Phone: ${s(data.countryCode)}${s(data.phone)}

* Address: ${s(data.address) || 'Not provided'}

* Main Link (Text & URL): ${s(data.websiteLinkText) || 'Not provided'} - ${s(data.websiteLink) || 'Not provided'}

* Additional External Link (Text & URL): ${s(data.externalLinkText) || 'Not provided'} - ${s(data.externalLink) || 'Not provided'}

* YouTube (Clean Embed URL): ${cleanYoutubeEmbedUrl || 'Not provided'} (Display mode: ${s(data.youtubeDisplayMode) || 'Embed'})

* Facebook: ${s(data.facebookLink) || 'Not provided'}

* Instagram: ${s(data.instagramLink) || 'Not provided'}

* TikTok: ${s(data.tiktokLink) || 'Not provided'}

* Menu Items: ${s(data.menuItems) || 'Not provided'}

* Price: ${s(data.price) || 'Not specified'}

* Payment Link: ${s(data.paymentLink) || 'Not provided'}

* Event Date: ${s(data.eventDate) || 'Not provided'}

* Event Location (Venue Name): ${s(data.eventLocation) || 'Not provided'}

* Event Address: ${s(data.eventAddress) || 'Not provided'}

`;



            const masterPrompt = `

# Master Task: Create a Creative Agency-Level Digital Asset



## 1. Your Identity: AI Creative Director

You are a creative director, copywriter, and designer. Your mission is to take a brief and turn it into a high-converting digital asset.



## 2. Project Brief

* **Asset Type:** ${s(templateLang.title)}

* **Project/Business Name:** ${s(data.mainName)}

* **Core Message:** "${s(data.description)}"

* **Selected Visual Style:** ${s(data.style)}

* **Use as Background Image preference:** ${data.useAsBackground ? 'Yes' : 'No'}

* **Add Accessibility Button:** ${data.addAccessibility ? 'Yes' : 'No'}

* **Add AI Bot:** ${data.addAiBot ? 'Yes' : 'No'}

* **All additional user data:** ${optionalData}



## 3. Content & Copywriting Task

Based on all data, write full marketing copy for all required sections in the Blueprint. The copy must be written entirely in the requested output language: **${data.language}** (${data.languageName}). 

**CRITICAL**: The ENTIRE page content must be in ${data.languageName} language:
- All headings, titles, and subtitles
- All paragraph text and descriptions  
- All button labels and links
- All form labels and placeholders
- All navigation elements
- All error and success messages
- All tooltips and help text
- All metadata and alt text
- All text overlays on images
- All captions and image descriptions
- All floating elements and widgets text
- All AI bot interface text
- All WhatsApp button text
- All accessibility menu text

**LANGUAGE ENFORCEMENT**: If you generate any text in a different language than ${data.languageName}, the page will be rejected. Every single word, character, and symbol must be in ${data.languageName} language.


## 4. Art Direction & Creative Excellence Task

**YOU ARE A WORLD-CLASS CREATIVE DIRECTOR**. This page must look like it was created by a leading creative agency (Pentagram, Ogilvy, R/GA level). Every pixel must be intentional and beautiful.

### Visual Style Implementation for "${s(data.style)}":

**CRITICAL DESIGN REQUIREMENTS:**
1. **Typography Excellence:**
   - Use modern, professional Google Fonts (Heebo/Rubik for Hebrew, Inter/Poppins for English)
   - Clear hierarchy: Hero (48-72px), H2 (36-48px), H3 (24-32px), body (16-18px)
   - Line height 1.6-1.8 for readability
   - Letter spacing optimized for the chosen font

2. **Color Palette Strategy:**
   - Create a cohesive 5-color palette based on "${s(data.style)}"
   - Primary color for CTA buttons and key elements
   - Secondary color for accents
   - Neutral grays for text and backgrounds
   - Use Tailwind's color system intelligently
   - Add gradients where appropriate (bg-gradient-to-r, bg-gradient-to-br)

3. **Spacing & Layout:**
   - Generous white space (py-16, py-24 for sections)
   - Consistent padding (px-4, px-6, px-8)
   - Maximum content width: max-w-7xl mx-auto
   - Grid systems: grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3
   - Gap between elements: gap-6, gap-8, gap-12

4. **Visual Effects & Modern Touches:**
   - Subtle shadows: shadow-md, shadow-lg, shadow-2xl
   - Smooth transitions: transition-all duration-300
   - Hover effects: hover:scale-105, hover:shadow-xl
   - Rounded corners: rounded-lg, rounded-xl, rounded-2xl
   - Backdrop blur for overlays: backdrop-blur-sm
   - Gradient overlays where appropriate

5. **Imagery:**
   - **If 'Use as Background Image' is 'Yes'**: Use as hero background with overlay
   - **If 'Use as Background Image' is 'No'**: Place as prominent \`<img>\` element
   - Find 3-5 additional high-quality Unsplash images for sections
   - Use object-cover and aspect-ratio for perfect sizing
   - Add subtle image filters if they enhance the ${s(data.style)} aesthetic

6. **Micro-interactions:**
   - Buttons must have: shadow, hover:scale, active states
   - Links must have underline effects or color changes
   - Form inputs must have focus:ring effects
   - Cards must lift on hover (hover:-translate-y-2)

7. **Section-Specific Design:**
   - Hero: Full viewport height (min-h-screen), centered content, compelling CTA
   - Benefits/Features: Cards or icons with descriptions, use grid layout
   - Testimonials: Cards with quotes, author photos, ratings
   - Contact: Form with beautiful styling, clear labels, helpful placeholders
   - Footer: Clean, organized, with all links and social media

**STYLE-SPECIFIC GUIDELINES:**
- **Minimalist/Minimalist Pro**: Clean whites, subtle grays, thin lines, abundant space, San-serif fonts
- **Modern**: Bold colors, sharp edges, gradients, contemporary feel
- **Luxury**: Gold accents, elegant fonts (serif), rich colors, sophisticated spacing
- **Vintage/Retro**: Warm tones, aged paper textures, classic typography
- **Neon/Aurora**: Vibrant gradients, glowing effects, dark backgrounds, bold colors
- **Claymorphism**: Soft shadows, muted colors, rounded corners, depth
- **Bento Grid**: Card-based layout, organized sections, clean borders
- **Gothic**: Dark palette, dramatic fonts, medieval touches
- **Comic/Pop Art**: Bold outlines, primary colors, playful elements
- **Art Nouveau**: Organic curves, floral elements, elegant lines
- **Bauhaus**: Geometric shapes, primary colors, functional design
- **Casual**: Friendly colors, approachable design, relaxed spacing

* **Default Image:** You must find a suitable, high-quality image from Unsplash.

⚠️⚠️⚠️ **CRITICAL IMAGE RULES - MUST FOLLOW:** ⚠️⚠️⚠️
- ✅ ALWAYS use Unsplash URLs (https://images.unsplash.com/...)
- ❌ NEVER EVER use base64 encoded images (data:image/...)
- ❌ NEVER use placeholder images (via.placeholder.com)
- ❌ NEVER generate images yourself
- ✅ ALL images MUST be from Unsplash with proper URLs



## 5. Blueprint (Work Plan)

Strictly follow this structure plan. IMPORTANT: The output language must be ${data.language} (${data.languageName}).

**MANDATORY LANGUAGE REQUIREMENTS:**
1. Set HTML lang attribute to "${data.language}"
2. Set HTML dir attribute to "${data.language === 'he' || data.language === 'ar' ? 'rtl' : 'ltr'}"
3. ALL text content must be in ${data.languageName} - NO EXCEPTIONS
4. Do NOT add any language switcher - the page should be in a single language only
5. Ensure ALL text overlays, captions, and image text are in ${data.languageName}
6. Verify that floating widgets (WhatsApp, AI Bot, Accessibility) have text in ${data.languageName}
7. **MANDATORY: Add a contact form section** with the following requirements:
   - Form ID: "contact-form"
   - Fields: Name (required), Email (required), Phone (optional), Message (required)
   - Submit button with text in ${data.languageName}
   - Form must submit to WhatsApp with pre-filled message OR send email
   - Use the business phone number and email from form data
   - Form styling should match the page design
   - Include proper validation and success/error messages
   - For WhatsApp: Use href="https://wa.me/${data.whatsappCountryCode}${data.phone.replace(/[^0-9]/g, '')}?text=שלום, אני [name] - [message]"
   - For Email: Use mailto:${data.email}?subject=פנייה מאתר&body=שם: [name]%0Aטלפון: [phone]%0Aהודעה: [message]
${finalStructurePrompt}


## 5.5. 🚨🚨🚨 COUNTDOWN TIMER - COPY THIS CODE EXACTLY 🚨🚨🚨

⚠️⚠️⚠️ THIS IS THE #1 REQUIREMENT - DO NOT DEVIATE FROM THIS CODE ⚠️⚠️⚠️

IF your page includes a countdown timer, you MUST copy-paste this EXACT code with NO modifications:

**VISUAL LAYOUT (what the user will see on screen - HEBREW RTL):**
SECONDS (RIGHT) → MINUTES → HOURS → DAYS/ימים (LEFT)
[שניות 00] [דקות 30] [שעות 10] [ימים 07]
  ←RIGHT                                LEFT→

**EXACT HTML CODE TO USE (COPY-PASTE THIS):**
\`\`\`html
<div class="grid grid-cols-1 md:grid-cols-4 gap-8">
    <div id="seconds" class="countdown-box p-8 flex flex-col items-center justify-center">
        <span class="text-7xl font-bold">00</span>
        <span class="text-2xl mt-2">שניות</span>
    </div>
    <div id="minutes" class="countdown-box p-8 flex flex-col items-center justify-center">
        <span class="text-7xl font-bold">30</span>
        <span class="text-2xl mt-2">דקות</span>
    </div>
    <div id="hours" class="countdown-box p-8 flex flex-col items-center justify-center">
        <span class="text-7xl font-bold">10</span>
        <span class="text-2xl mt-2">שעות</span>
    </div>
    <div id="days" class="countdown-box p-8 flex flex-col items-center justify-center">
        <span class="text-7xl font-bold">07</span>
        <span class="text-2xl mt-2">ימים</span>
    </div>
</div>
\`\`\`

**🚨 ABSOLUTE REQUIREMENTS - NO EXCEPTIONS:**
1. ✅ Grid MUST have: class="grid grid-cols-1 md:grid-cols-4 gap-8" (NO dir attribute!)
2. ✅ Order in HTML: seconds, minutes, hours, days (REVERSED for RTL display!)
3. ✅ Each div MUST have the exact id: "seconds", "minutes", "hours", "days"
4. ✅ Labels MUST be: "שניות", "דקות", "שעות", "ימים"
5. ✅ ALL 4 boxes required - NOT 3, NOT 5, EXACTLY 4
6. ✅ NO dir attribute - RTL will reverse the HTML order to display: ימים→שעות→דקות→שניות

**❌ FORBIDDEN:**
- Changing the order of boxes (must be: seconds, minutes, hours, days)
- Adding dir="ltr" or dir="rtl" to the grid
- Using grid-cols-3 (must be grid-cols-4)
- Skipping any box (must have all 4 boxes)
- Using different IDs or labels

## 6. Technical Checklist

* **Output:** HTML code only.

* **Responsiveness:** Perfect.

* **Links:** All links must work. Phone should link to tel: and WhatsApp. Email to mailto:. External links should open in a new tab (target="_blank").

* **🚨 MANDATORY FLOATING BUBBLES & ACCESSIBILITY 🚨:**
  - ✅ ALWAYS create ONE WhatsApp floating bubble (bottom-right, green, fixed position, with phone number)
  - ✅ NEVER create accessibility bubble/widget - instead add "נגישות" button in the top navigation bar
  - ✅ Accessibility button should open a simple menu with: font size controls, contrast toggle, readable font toggle
  - ❌ DO NOT create floating accessibility bubble or widget
  - ❌ DO NOT create multiple floating bubbles (only WhatsApp!)

* **🚨 FORBIDDEN ELEMENTS 🚨:**
  - ❌ DO NOT create "Back to Top" / "חזרה למעלה" button
  - ❌ DO NOT add "© 2025" or "כל הזכויות שמורות" or "All Rights Reserved" text
  - ❌ DO NOT add any copyright statements
  - ❌ DO NOT create floating accessibility bubble (use top bar button instead!)
  - These will be added automatically by the system - DO NOT include them in your HTML!

* **YouTube Video Integration:**
  - If YouTube URL is provided: ${cleanYoutubeEmbedUrl || 'Not provided'}
  - Display mode: ${s(data.youtubeDisplayMode) || 'Embed'}
  - **If Display Mode is "Embed":**
    * Create a dedicated video section (id="video-section")
    * Use full \`<iframe>\` embed with proper aspect ratio (16:9)
    * \`<iframe width="100%" height="auto" style="aspect-ratio: 16/9;" src="${cleanYoutubeEmbedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>\`
    * Center the video with proper padding
    * Add subtle shadow or border to make it stand out
  - **If Display Mode is "Link":**
    * Add a prominent "Watch on YouTube" button/link
    * Use red YouTube branding color (#FF0000)
    * Link opens in new tab: \`target="_blank"\`
    * Add YouTube icon SVG
  - **If no YouTube URL provided:** Skip video section entirely

* **Contact Form:** Must include JavaScript for form submission to WhatsApp or Email:
document.getElementById('contact-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const message = document.getElementById('message').value;
    
    // Validate required fields
    if (!name || !email || !message) {
        alert('אנא מלא את כל השדות החובה');
        return;
    }
    
    // Create message
    const fullMessage = 'שלום, אני ' + name + '\\nאימייל: ' + email + '\\nטלפון: ' + (phone || 'לא צוין') + '\\nהודעה: ' + message;
    
    // Open WhatsApp
    const whatsappUrl = 'https://wa.me/' + ${data.whatsappCountryCode} + ${data.phone.replace(/[^0-9]/g, '')} + '?text=' + encodeURIComponent(fullMessage);
    window.open(whatsappUrl, '_blank');
    
    // Show success message
    alert('ההודעה נשלחה לווטסאפ!');
});

* **Accessibility:** \`alt\` and \`aria-label\` attributes. If the user requested an accessibility button, add it.

* **Accessibility Button:** Always add an accessibility floating button in the center-bottom of the page (position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%)) with blue background (#3B82F6) and clear accessibility icon. Use this wheelchair accessibility SVG icon:
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
    <circle cx="12" cy="12" r="2" fill="white"/>
    <path d="M12 6v6m0 0v6m0-6h6m-6 0H6" stroke="white" stroke-width="2" fill="none"/>
  </svg>
  When clicked, open a menu with all accessibility options (font size, contrast, screen reader, etc.).

* **🚨 WhatsApp Bubble - THE ONLY FLOATING ELEMENT 🚨:** 
  - ✅ ALWAYS add ONE WhatsApp floating bubble on the left side of the page (position: fixed; bottom: 20px; left: 20px)
  - ✅ Use green background (#25D366) and clear WhatsApp logo
  - ✅ Make it clickable with href="https://wa.me/[country_code][phone_number]?text=היי, אני מעוניין בשירות" target="_blank"
  - ✅ Use full phone number from form data including country code (972 for Israel)
  - ✅ Properly format phone number (remove spaces, dashes, parentheses, keep only digits)
  - ❌ DO NOT create ANY OTHER floating bubbles (no accessibility, no chatbots, ONLY WhatsApp!)
  - Use this clear WhatsApp SVG icon:
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.893 3.488"/>
  </svg>

* **AI Bot (סתיו):** Always add the AI bot widget on the right side of the page (position: fixed; bottom: 20px; right: 20px) with purple background (#8B5CF6) and clear robot head icon. The bot should introduce itself in the page language:
  - Hebrew (he): "שלום! אני סתיו, איך אני יכולה לעזור לך?"
  - Arabic (ar): "مرحباً! أنا ستاف، كيف يمكنني مساعدتك؟"
  - English (en): "Hello! I'm Stav, how can I help you?"
  - Spanish (es): "¡Hola! Soy Stav, ¿cómo puedo ayudarte?"
  - French (fr): "Bonjour! Je suis Stav, comment puis-je vous aider?"
  Use this clear robot head SVG icon:
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
    <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 6.5V7.5C15 8.33 14.33 9 13.5 9H10.5C9.67 9 9 8.33 9 7.5V6.5L3 7V9L9 8.5V19C9 20.1 9.9 21 11 21H13C14.1 21 15 20.1 15 19V8.5L21 9ZM7.5 11C6.67 11 6 11.67 6 12.5S6.67 14 7.5 14 9 13.33 9 12.5 8.33 11 7.5 11ZM16.5 11C15.67 11 15 11.67 15 12.5S15.67 14 16.5 14 18 13.33 18 12.5 17.33 11 16.5 11Z"/>
    <circle cx="12" cy="12" r="2" fill="white"/>
    <circle cx="12" cy="12" r="1" fill="#8B5CF6"/>
  </svg>
  The bot should be initialized with a \`context\` object containing all page data and must use this info to answer questions. Use this webhook URL for bot communication: https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhf757754jhldkbsjkbkfhkfggyt. Include a complete chat interface that opens when clicked with:
  - Chat window (width: 300px, height: 400px)
  - Message input field at bottom
  - Send button
  - Message history area
  - Close button
  - Smooth animations for open/close
  - **🚨 CRITICAL - CHAT HISTORY MANAGEMENT 🚨:**
    **YOU MUST USE A UNIQUE KEY FOR EACH PAGE TO PREVENT CHAT MIXING!**
    
    **CORRECT localStorage key (use page URL, NOT title):**
    \`\`\`javascript
    const CHAT_KEY = 'chatHistory_' + window.location.pathname.replace(/[^a-zA-Z0-9]/g, '_');
    \`\`\`
    
    **❌ WRONG (causes chat mixing between pages):**
    - \`chatHistory_\${title}\` - titles can be the same!
    - \`chatHistory\` - will mix all chats!
    
    **✅ CORRECT (each page has its own chat):**
    - \`chatHistory_output_userId_pageId_html\`
    
    **WHEN TO CLEAR CHAT HISTORY:**
    1. ✅ **When chat bubble is closed** - ALWAYS clear on close!
    2. ✅ **When page is in editing mode** - check for editor toolbar
    3. ✅ **When page loads** - start fresh every time
    
    **IMPLEMENTATION:**
    \`\`\`javascript
    // On page load - clear old chat
    document.addEventListener('DOMContentLoaded', function() {
      const CHAT_KEY = 'chatHistory_' + window.location.pathname.replace(/[^a-zA-Z0-9]/g, '_');
      localStorage.removeItem(CHAT_KEY);
      console.log('🧹 Chat history cleared for this page');
    });
    
    // When closing chat bubble - clear chat
    function closeChatBubble() {
      const CHAT_KEY = 'chatHistory_' + window.location.pathname.replace(/[^a-zA-Z0-9]/g, '_');
      localStorage.removeItem(CHAT_KEY);
      console.log('🧹 Chat history cleared on close');
      // ... close the bubble
    }
    
    // Check for editing mode
    if (document.querySelector('.editor-toolbar')) {
      const CHAT_KEY = 'chatHistory_' + window.location.pathname.replace(/[^a-zA-Z0-9]/g, '_');
      localStorage.removeItem(CHAT_KEY);
    }
    \`\`\`
  - **🚨 INITIAL MESSAGE - START FRESH:**
    When the chat opens for the first time, show ONLY the initial greeting message.
    DO NOT load any previous messages from localStorage.
    Each page visit should start with a clean, empty chat.
    
    **ADD THIS CLEANUP CODE AT THE TOP OF YOUR SCRIPT:**
    \`\`\`javascript
    // 🧹 Clean up ALL old chat histories on page load
    (function() {
      // Remove all chatHistory keys from localStorage
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('chatHistory')) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      if (keysToRemove.length > 0) {
        console.log(\`🧹 Cleared \${keysToRemove.length} old chat histories\`);
      }
    })();
    \`\`\`
    
  - Typing indicator: Show "סתיו מקלידה..." in page language inside the message history area when waiting for bot response. Use this HTML structure: <div class="typing-indicator">סתיו מקלידה<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>
  - When sending messages, include both page context data and user message in this format:
    {
      "context": {
        "pageTitle": "Page Title",
        "businessName": "Business Name", 
        "description": "Page Description",
        "phone": "Phone Number",
        "email": "Email Address",
        "address": "Physical Address",
        "allPageData": "Complete page information"
      },
      "user_message": "{{ $json.body.user_message }}",
      "page_type": "${data.pageType || 'landing'}",
      "business_info": {
        "name": "Business Name from form data",
        "phone": "Full phone number from form data (without country code)", 
        "email": "Email Address from form data",
        "address": "Physical Address from form data"
      },
      "event_details": {
        "eventDate": "${data.eventDate || ''}",
        "eventTime": "${data.eventTime || ''}",
        "eventLocation": "${data.eventLocation || ''}",
        "eventAddress": "${data.eventAddress || ''}",
        "eventType": "${data.eventType || data.pageType || ''}"
      },
      "page_details": {
        "profession": "${data.profession || data.mainName || ''}",
        "serviceType": "${data.serviceType || data.description || ''}",
        "businessType": "${data.businessType || data.pageType || ''}",
        "courseName": "${data.courseName || data.title || ''}",
        "courseDescription": "${data.courseDescription || data.description || ''}"
      },
      "products": (typeof extractProductsFromPage === 'function' ? extractProductsFromPage() : [])
    }
  - **🚨🚨🚨 CRITICAL - AUTO-GENERATED extractPageData() FUNCTION 🚨🚨🚨**
    **THE SERVER AUTOMATICALLY INJECTS extractPageData() INTO ALL PAGES!**
    **YOU MUST USE IT IN YOUR FETCH CODE!**
    **DO NOT CREATE IT AGAIN - JUST CALL IT!**
  - **🚨🚨🚨 CRITICAL FOR STORE PAGES - PRODUCT DATA EXTRACTION 🚨🚨🚨**
    
    **THE FUNCTION extractProductsFromPage() IS ALREADY IN THE PAGE!**
    **Just call it in your fetch code:**
    \`\`\`javascript
    "products": (typeof extractProductsFromPage === 'function' ? extractProductsFromPage() : [])
    \`\`\`
    
    **🚨 EXAMPLE OF COMPLETE FETCH:**
    \`\`\`javascript
    const messageData = {
      context: { ... },
      user_message: userMessage,
      page_type: "store",
      business_info: { ... },
      products: extractProductsFromPage()  // ← CALL THE FUNCTION HERE
    };
    
    fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(messageData)
    })
    \`\`\`
    
    This ensures the bot ALWAYS extracts and sends REAL, UP-TO-DATE product information from the actual page EVERY time a message is sent.
    
  - **📋 COMPLETE WORKING EXAMPLE FOR STORE PAGES:**
    See the detailed instructions above for extractProductsFromPage() function and how to call it in the bot's fetch code.
  - The bot will receive responses in this format:
    { "message": "Bot response text here" }
  - **🛒 FOR STORE PAGES - AUTOMATIC BOT ACTIONS:**
    The bot can return JSON with an "action" field to trigger automatic actions:
    
    **Action 1: Add to Cart**
    {
      "message": "✅ Added 3 chocolates to cart!",
      "action": "add_to_cart",
      "product_name": "Chocolate",
      "quantity": 3,
      "price": 40
    }
    When the bot response includes "action": "add_to_cart", automatically call:
    addToCart(product_name, price, '', null, quantity);
    
    **Action 2: Scroll to Products Area**
    {
      "message": "הנה המוצרים שלנו! 🛍️",
      "action": "scroll_to_products"
    }
    When the bot response includes "action": "scroll_to_products", the page will automatically scroll to the products gallery.
    
    **Action 3: Scroll to Specific Product**
    {
      "message": "הנה שוקולד מריר! 🍫",
      "action": "scroll_to_product",
      "product_name": "שוקולד מריר"
    }
    When the bot response includes "action": "scroll_to_product", the page will scroll to and highlight that specific product.
    
    **Action 4: Fill Contact Form**
    {
      "message": "מילאתי את הטופס בשבילך! ✅",
      "action": "fill_contact_form",
      "name": "יניב",
      "phone": "050-1234567",
      "message_text": "אני מעוניין בשירות" (optional)
    }
    Automatically fills the contact form with the user's details from the conversation.
    
    **Action 5: Open WhatsApp**
    {
      "message": "פותח את WhatsApp... 💬",
      "action": "open_whatsapp"
    }
    Automatically clicks the WhatsApp bubble to open a chat.
    
    **Action 6: Scroll to Section**
    {
      "message": "הנה המיקום! 📍",
      "action": "scroll_to_section",
      "section_name": "מיקום" (or "location", "gallery", "about", etc.)
    }
    Scrolls to a specific section of the page by name.
    
    **Action 7: Highlight Element**
    {
      "message": "הנה הכפתור! ✨",
      "action": "highlight_element",
      "element_text": "תשלום" (text to find in the element)
    }
    Finds and highlights (pulsing animation) a specific element on the page.
    
    This allows the bot to perform actions in the page while showing only the message to the user.
    **🚨 CRITICAL - HANDLE BOT RESPONSES CORRECTLY WITH TIMEOUT & RETRY:**
    After receiving the webhook response, parse it and check for actions.
    **IMPORTANT:** Use AbortController with 30-second timeout to prevent bot from hanging:
    \`\`\`javascript
    // When receiving response from webhook (in your fetch().then())
    // Add timeout and retry logic
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 seconds timeout
    
    fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(messageData),
      signal: controller.signal
    })
    .then(response => {
      clearTimeout(timeoutId); // Clear timeout on successful response
      return response.json();
    })
    .then(rawData => {
      // Hide typing indicator
      hideTypingIndicator();
      
      console.log('📥 Raw webhook response:', rawData);
      
      // ROBUST JSON PARSING - handle if response is wrapped in string
      let data = rawData;
      
      // If data is a string, try to parse it as JSON
      if (typeof rawData === 'string') {
        try {
          data = JSON.parse(rawData);
          console.log('✅ Parsed string response as JSON:', data);
        } catch (e) {
          console.warn('⚠️ Response is string but not valid JSON, using as-is');
        }
      }
      
      // If data has a nested 'message' that's also JSON, parse it
      if (data.message && typeof data.message === 'string' && data.message.startsWith('{')) {
        try {
          const parsed = JSON.parse(data.message);
          console.log('✅ Parsed nested JSON in message field');
          data = parsed;
        } catch (e) {
          console.warn('⚠️ message field looks like JSON but failed to parse');
        }
      }
      
      console.log('📊 Final parsed data:', data);
      
      // Check if bot returned an action
      if (data.action === 'add_to_cart' && data.product_name && data.price) {
        console.log('🛒 Bot requested to add to cart:', data);
        
        // Add product to cart
        if (typeof addToCart === 'function') {
          const productName = data.product_name;
          const price = parseFloat(data.price);
          const quantity = parseInt(data.quantity) || 1;
          
          // Call the cart function
          addToCart(productName, price, '', null, quantity);
          
          console.log(\`✅ Added \${quantity}x \${productName} to cart (₪\${price} each)\`);
        } else {
          console.warn('⚠️ addToCart function not found!');
        }
        
        // Display ONLY the message, not the full JSON
        addBotMessage(data.message || 'מוצר נוסף לעגלה!');
      } else if (data.action === 'scroll_to_products') {
        console.log('📜 Bot requested to scroll to products');
        
        // Find the products section and scroll to it
        const productSection = document.querySelector('[class*="product"], .products, #products, section:has(.product-card)');
        if (productSection) {
          productSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          console.log('✅ Scrolled to products section');
        } else {
          console.warn('⚠️ Products section not found');
        }
        
        // Display the message
        addBotMessage(data.message || 'הנה המוצרים שלנו! 🛍️');
      } else if (data.action === 'scroll_to_product' && data.product_name) {
        console.log('📜 Bot requested to scroll to specific product:', data.product_name);
        
        // Find the specific product card
        const allProducts = document.querySelectorAll('.product-card, [class*="product"]');
        let targetProduct = null;
        
        for (const product of allProducts) {
          const nameEl = product.querySelector('h1, h2, h3, h4, [class*="title"], [class*="name"]');
          if (nameEl && nameEl.textContent.trim().toLowerCase().includes(data.product_name.toLowerCase())) {
            targetProduct = product;
            break;
          }
        }
        
        if (targetProduct) {
          targetProduct.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Highlight the product briefly
          targetProduct.style.transition = 'all 0.3s ease';
          targetProduct.style.boxShadow = '0 0 30px rgba(102, 126, 234, 0.8)';
          targetProduct.style.transform = 'scale(1.05)';
          setTimeout(() => {
            targetProduct.style.boxShadow = '';
            targetProduct.style.transform = '';
          }, 2000);
          console.log('✅ Scrolled to product:', data.product_name);
        } else {
          console.warn('⚠️ Product not found:', data.product_name);
        }
        
        addBotMessage(data.message || 'הנה המוצר! 🎯');
      } else if (data.action === 'fill_contact_form' && data.name && data.phone) {
        console.log('📝 Bot requested to fill contact form');
        
        // Find the contact form
        const forms = document.querySelectorAll('form');
        let contactForm = null;
        
        for (const form of forms) {
          const inputs = form.querySelectorAll('input, textarea');
          const hasName = Array.from(inputs).some(inp => inp.name?.includes('name') || inp.placeholder?.includes('שם'));
          const hasPhone = Array.from(inputs).some(inp => inp.name?.includes('phone') || inp.placeholder?.includes('טלפון'));
          
          if (hasName && hasPhone) {
            contactForm = form;
            break;
          }
        }
        
        if (contactForm) {
          // Fill the form
          const nameInput = contactForm.querySelector('input[name*="name"], input[placeholder*="שם"]');
          const phoneInput = contactForm.querySelector('input[name*="phone"], input[type="tel"], input[placeholder*="טלפון"]');
          const messageInput = contactForm.querySelector('textarea, input[name*="message"], input[placeholder*="הודעה"]');
          
          if (nameInput) nameInput.value = data.name;
          if (phoneInput) phoneInput.value = data.phone;
          if (messageInput && data.message_text) messageInput.value = data.message_text;
          
          // Scroll to the form
          contactForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Highlight the form briefly
          contactForm.style.transition = 'all 0.3s ease';
          contactForm.style.boxShadow = '0 0 30px rgba(16, 185, 129, 0.8)';
          setTimeout(() => {
            contactForm.style.boxShadow = '';
          }, 2000);
          
          console.log('✅ Contact form filled');
        } else {
          console.warn('⚠️ Contact form not found');
        }
        
        addBotMessage(data.message || 'מילאתי את הטופס בשבילך! ✅');
      } else if (data.action === 'open_whatsapp') {
        console.log('💬 Bot requested to open WhatsApp');
        
        // Find and click the WhatsApp bubble
        const whatsappBubble = document.querySelector('[id*="whatsapp"], [class*="whatsapp"], a[href*="wa.me"]');
        if (whatsappBubble) {
          whatsappBubble.click();
          console.log('✅ Opened WhatsApp');
        } else {
          console.warn('⚠️ WhatsApp bubble not found');
        }
        
        addBotMessage(data.message || 'פותח את WhatsApp... 💬');
      } else if (data.action === 'scroll_to_section' && data.section_name) {
        console.log('📜 Bot requested to scroll to section:', data.section_name);
        
        // Try to find the section by various methods
        const sectionName = data.section_name.toLowerCase();
        let targetSection = null;
        
        // Method 1: By ID
        targetSection = document.getElementById(sectionName);
        
        // Method 2: By heading text
        if (!targetSection) {
          const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
          for (const heading of headings) {
            if (heading.textContent.toLowerCase().includes(sectionName)) {
              targetSection = heading.closest('section') || heading.parentElement;
              break;
            }
          }
        }
        
        // Method 3: By section with matching text
        if (!targetSection) {
          const sections = document.querySelectorAll('section, .section, [class*="section"]');
          for (const section of sections) {
            if (section.textContent.toLowerCase().includes(sectionName)) {
              targetSection = section;
              break;
            }
          }
        }
        
        if (targetSection) {
          targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          console.log('✅ Scrolled to section:', data.section_name);
        } else {
          console.warn('⚠️ Section not found:', data.section_name);
        }
        
        addBotMessage(data.message || 'הנה החלק שחיפשת! 📍');
      } else if (data.action === 'highlight_element' && data.element_text) {
        console.log('✨ Bot requested to highlight element:', data.element_text);
        
        // Find element by text content
        const allElements = document.querySelectorAll('button, a, h1, h2, h3, h4, .btn, [class*="button"]');
        let targetElement = null;
        
        for (const el of allElements) {
          if (el.textContent.toLowerCase().includes(data.element_text.toLowerCase())) {
            targetElement = el;
            break;
          }
        }
        
        if (targetElement) {
          // Scroll to element
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Create pulsing highlight effect
          const originalBoxShadow = targetElement.style.boxShadow;
          const originalTransform = targetElement.style.transform;
          let pulseCount = 0;
          
          const pulseInterval = setInterval(() => {
            if (pulseCount % 2 === 0) {
              targetElement.style.boxShadow = '0 0 40px rgba(234, 179, 8, 1)';
              targetElement.style.transform = 'scale(1.1)';
            } else {
              targetElement.style.boxShadow = '0 0 20px rgba(234, 179, 8, 0.5)';
              targetElement.style.transform = 'scale(1)';
            }
            pulseCount++;
            
            if (pulseCount >= 6) {
              clearInterval(pulseInterval);
              targetElement.style.boxShadow = originalBoxShadow;
              targetElement.style.transform = originalTransform;
            }
          }, 400);
          
          console.log('✅ Highlighted element');
        } else {
          console.warn('⚠️ Element not found:', data.element_text);
        }
        
        addBotMessage(data.message || 'הנה מה שחיפשת! ✨');
      } else {
        // Regular message - display as is
        addBotMessage(data.message || data.response || 'מצטערת, לא הצלחתי להבין');
      }
    })
    .catch(error => {
      clearTimeout(timeoutId); // Clear timeout on error
      console.error('Bot error:', error);
      hideTypingIndicator();
      
      // Better error messages based on error type
      if (error.name === 'AbortError') {
        addBotMessage('⏱️ הבקשה ארכה יותר מדי. אנא נסה שוב.');
      } else if (!navigator.onLine) {
        addBotMessage('📡 אין חיבור לאינטרנט. בדוק את החיבור ונסה שוב.');
      } else {
        addBotMessage('מצטערת, קרתה שגיאה. נסה שוב בעוד כמה שניות.');
      }
    });
    \`\`\`
    
    **🔑 KEY POINTS:**
    1. ALWAYS use AbortController with 30-second timeout to prevent hanging
    2. ALWAYS parse the response as JSON
    3. Check for bot actions: \`data.action === 'add_to_cart'\` OR \`data.action === 'scroll_to_products'\`
    4. If action exists:
       - For 'add_to_cart': call addToCart() AND display ONLY data.message
       - For 'scroll_to_products': scroll to products section AND display ONLY data.message
    5. NEVER display the raw JSON to the user - ALWAYS display ONLY data.message
    6. Use addBotMessage() or equivalent to display messages in the chat
    7. Provide user-friendly error messages based on error type (timeout, network, general)
    8. Clear timeout on both success and error
    9. **🚨 CRITICAL:** Whether there's an action or not, ALWAYS show ONLY the message text, NEVER the full JSON object!
  - **Bot System Instructions (Instructions for N8N):**
    **שמך:** סתיו - עוזרת חכמה שנותנת שירות בדף
    **אישיות:** שנונה, קצרה, עם נגיעות הומור ומקצועיות
    **הנחיות:**
    - קבלי את המשתמש בסבר פנים יפות
    - הגידי את שמך רק אם תשאלי
    - עני בקצרה על מה שנשאלת - תשובה לעניין וקצרה כמו אדם רגיל, רק על מה שנשאלת
    - תוכלי לשוחח בקצרה על כל נושא אבל תמיד להחזיר את המשתמש לנושא העסק ולהניע לפעולה
    - את בוט אוניברסלי - אם הממשק בשפה אחרת את עונה בשפת הממשק או בשפה שהמשתמש כותב
    
    **מידע עסקי (תפארי את העסק!):**
    - שם העסק: {{ $json.body.business_info.name }}
    - טלפון: {{ $json.body.business_info.phone }} (רק אם מבקשים)
    - אימייל: {{ $json.body.business_info.email }} (רק אם מבקשים)
    - כתובת: {{ $json.body.business_info.address }} (רק אם מבקשים)
    - **אם אין לך תשובה - תמיד תמליצי על צור קשר בדף כאן**
    
    **📋 פרטי האירוע (אם זה דף אירוע):**
    - תאריך: {{ $json.body.event_details.eventDate }}
    - שעה: {{ $json.body.event_details.eventTime }}
    - מקום: {{ $json.body.event_details.eventLocation }}
    - כתובת: {{ $json.body.event_details.eventAddress }}
    - סוג אירוע: {{ $json.body.event_details.eventType }}
    
    **💼 פרטי הדף/העסק:**
    - מקצוע/תחום: {{ $json.body.page_details.profession }}
    - סוג שירות: {{ $json.body.page_details.serviceType }}
    - סוג עסק: {{ $json.body.page_details.businessType }}
    - שם קורס: {{ $json.body.page_details.courseName }}
    - תיאור קורס: {{ $json.body.page_details.courseDescription }}
    
    **🎯 זיהוי סוג הדף והתאמת תשובות:**
    
    **קודם כל - זהי את סוג הדף:**
    - page_type: {{ $json.body.page_type }}
    - businessType: {{ $json.body.page_details.businessType }}
    - profession: {{ $json.body.page_details.profession }}
    
    **לפי סוג הדף, התאימי את התשובות:**
    
    1️⃣ **אם page_type = "event" או "wedding" (הזמנה לאירוע/חתונה):**
       - **השתמשי בפרטי האירוע מ-event_details!**
       - תני פרטים על: תאריך ({{ $json.body.event_details.eventDate }}), שעה ({{ $json.body.event_details.eventTime }}), מקום ({{ $json.body.event_details.eventLocation }})
       - התמקדי ב: אישור הגעה, מיקום, קוד לבוש, שעות הגעה
       - **תמיד הפני לטופס אישור הגעה:** "אפשר לאשר הגעה בטופס באתר!"
    
    2️⃣ **אם page_type = "onlineStore" או "store" (חנות מקוונת):**
       - 🚨 **קיבלת רשימת מוצרים ב-{{ $json.body.products }}** - זוהי רשימה אמיתית מהדף!
       - 🚨 **כל מוצר ברשימה מכיל:** name (שם), price (מחיר), description (תיאור)
       
       **🛒 זיהוי בקשות רכישה:**
       - אם המשתמש מבקש להוסיף מוצר לעגלה (דוגמאות: "אני רוצה 3 שוקולדים", "תוסיף לי 2 עוגות", "הוסף קפה")
       - **חפשי את המוצר ב-{{ $json.body.products }}** לפי שם
       - **החזירי JSON עם פעולה:**
       \`\`\`json
       {
         "message": "✅ מעולה! הוספתי לך [כמות] [שם מוצר] לעגלה 🛒\\nסה\\"כ: ₪[מחיר כפול כמות]",
         "action": "add_to_cart",
         "product_name": "[שם המוצר המדויק מהרשימה]",
         "quantity": [מספר],
         "price": [מחיר יחידה]
       }
       \`\`\`
       
       **✅ דוגמה:**
       - משתמש: "אני רוצה 3 שוקולדים"
       - את בודקת ב-{{ $json.body.products }} ומוצאת: {name: "שוקולד מריר", price: 40}
       - **תחזירי:**
       \`\`\`json
       {
         "message": "✅ מעולה! הוספתי לך 3 שוקולדים מרירים לעגלה 🛒\\nסה\\"כ: ₪120",
         "action": "add_to_cart",
         "product_name": "שוקולד מריר",
         "quantity": 3,
         "price": 40
       }
       \`\`\`
       
       **❌ אם המוצר לא קיים ברשימה:**
       \`\`\`json
       {
         "message": "מצטערת, לא מצאתי את המוצר הזה. מוזמנים לעיין במוצרים הזמינים בדף! 😊"
       }
       \`\`\`
       
       **📋 שאלות על מוצרים (ללא הוספה):**
       - אם המשתמש רק שואל על מחיר - **אל תוסיפי לעגלה**! רק תני מידע.
       - "שוקולד מריר עולה ₪40 ליחידה. רוצה להוסיף לעגלה?"
       
       **📜 גלילה אוטומטית למוצרים:**
       - אם המשתמש מבקש המלצות או לראות מוצרים (דוגמאות: "תראי לי מה יש", "מה יש בחנות", "המלצות", "תראי מוצרים")
       - **החזירי JSON עם פעולת גלילה:**
       \`\`\`json
       {
         "message": "הנה המוצרים שלנו! 🛍️ מוזמנים לעיין ואם משהו מעניין - אשמח לעזור להוסיף לעגלה! 😊",
         "action": "scroll_to_products"
       }
       \`\`\`
       - הדף **יגלול אוטומטית** לגלריית המוצרים והמשתמש יוכל לראות אותם!
    
    3️⃣ **אם page_type = "course" (קורס/הדרכה):**
       - **השתמשי בפרטי הקורס:** שם ({{ $json.body.page_details.courseName }}), תיאור ({{ $json.body.page_details.courseDescription }})
       - התמקדי ב: תוכן הקורס, הרשמה, מערכת שעות, תכנית לימודים
       - "ההרשמה לקורס פתוחה - מוזמנים להירשם!"
    
    4️⃣ **אם page_type = "landing" או כרטיס ביקור (אינסטלטור, בעל מקצוע, נותן שירות):**
       - **זהי את המקצוע:** {{ $json.body.page_details.profession }}
       - **זהי את סוג השירות:** {{ $json.body.page_details.serviceType }}
       - התאימי תשובות למקצוע (לדוגמה: אינסטלטור = שיפוצים, אינסטלציה, תיקונים)
       - הפני לפרטי קשר: "מוזמנים ליצור קשר לתיאום פגישה/הצעת מחיר"
       - תני מענה על: שעות פעילות, אזורי שירות, תעריפים (אם יש)
    
    **💡 חשוב:** תמיד התאימי את הטון, השפה והתוכן לסוג הדף הספציפי שאת נמצאת בו!

* **Language & Localization:**
          - Default WhatsApp message: When user clicks WhatsApp bubble, send "היי, אני מעוניין בשירות" (this is the default message for all pages)
  - WhatsApp phone number formatting: Extract phone number from form data, remove all non-digit characters (spaces, dashes, parentheses, etc.), then add the appropriate country code. Use country code: ${data.whatsappCountryCode}. Example: "050-123-4567" becomes "${data.whatsappCountryCode}501234567"
  - Default Language: The page should be created in the language selected: ${data.language} (${data.languageName}). ALL content must be in this language.
  - Country-specific formatting: Format phone numbers, addresses according to: ${data.country}
  - Page Direction: If language is Hebrew (he) or Arabic (ar), set HTML dir="rtl". Otherwise dir="ltr".
  - Complete Translation: Entire page must be in selected language (headings, text, buttons, forms, placeholders, messages, navigation)


## 7. Creative Excellence Standards

**MAKE IT STUNNING - AGENCY-LEVEL QUALITY:**

1. **Modern Web Design Trends 2024:**
   - Use glassmorphism where appropriate (backdrop-filter: blur)
   - Implement smooth scroll animations (scroll-behavior: smooth)
   - Add subtle parallax effects for depth
   - Use CSS Grid and Flexbox masterfully
   - Implement dark mode toggle if it enhances the design
   
2. **Advanced Tailwind Techniques:**
   - Combine multiple utilities creatively (bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500)
   - Use arbitrary values when needed ([clip-path:polygon(...)])
   - Implement responsive design breakpoints perfectly (sm: md: lg: xl: 2xl:)
   - Use group-hover for interactive cards
   - Apply peer utilities for form validation states

3. **Visual Hierarchy:**
   - Clear F-pattern or Z-pattern for eye flow
   - Important elements should "pop" (larger, colorful, shadowed)
   - Secondary elements should recede (smaller, muted, less contrast)
   - Use size, color, AND spacing to create hierarchy

4. **Emotional Design:**
   - **Landing Page**: Trustworthy, professional, action-oriented
   - **Event/Wedding**: Elegant, romantic, celebratory
   - **Store**: Appetizing, trustworthy, easy to navigate
   - **Brand Page**: Authoritative, memorable, impressive
   - Match colors and imagery to evoke the right emotions

5. **CTAs That Convert:**
   - Primary CTA: Large (px-8 py-4), bold color, strong shadow, clear text
   - Use action verbs: "התחל עכשיו", "הזמן כעת", "קבל הצעה"
   - Add urgency or value: "הצטרף ל-1000+ לקוחות מרוצים"
   - Multiple CTAs throughout the page (above fold, mid-page, footer)

6. **Page-Type Specific Excellence:**
   
   **For Landing Pages:**
   - Attention-grabbing hero with clear value proposition
   - 3-5 benefit boxes with icons
   - Social proof (testimonials, logos, numbers)
   - Urgent CTA with contrast color
   - Trust indicators (security badges, guarantees)
   
   **For Event/Wedding Pages:**
   - Romantic, elegant typography (serif fonts)
   - Countdown timer with beautiful styling
   - Photo gallery or slideshow
   - RSVP form that's inviting and easy
   - Pastel or gold color accents
   - Decorative elements (borders, dividers)
   
   **For Store/Product Pages:**
   - Clean product displays with hover effects
   - Price prominently displayed
   - "Add to Cart" buttons that stand out
   - Product grid with consistent card design
   - Trust badges (secure checkout, free shipping)
   - Shopping cart icon in header
   
   **For Brand/Portfolio Pages:**
   - Bold hero statement about the brand
   - Project/work showcase with hover reveals
   - About section with personality
   - Skills or services grid
   - Contact form that matches brand aesthetics

7. **Random Variation:**
   - For each page type, you have creative freedom to choose from 3-5 different layout variations
   - Vary the hero section design (left-align, center, split-screen, full-background)
   - Alternate between card grids, masonry layouts, and list formats
   - Change section order slightly while maintaining logic
   - Use different animation patterns (fade-in, slide-up, scale)

* **Main Image Directive:**

  * **If 'Use as Background Image' is 'Yes'**: The main image (from Unsplash) **must** be used as a \`background-image\` for the main Hero section. To ensure readability, you **must** add a separate div element as an overlay with a semi-transparent black background (e.g., \`class="absolute inset-0 bg-black/50 bg-overlay"\`) between the background image and the content. **It is important to add the 'bg-overlay' class**.

  * **If 'Use as Background Image' is 'No'**: Place the image as a standard \`<img>\` element.

* **Default Image:** You must find a suitable, high-quality image from Unsplash.

⚠️⚠️⚠️ **CRITICAL IMAGE RULES - MUST FOLLOW:** ⚠️⚠️⚠️
- ✅ ALWAYS use Unsplash URLs (https://images.unsplash.com/...)
- ❌ NEVER EVER use base64 encoded images (data:image/...)
- ❌ NEVER use placeholder images (via.placeholder.com)
- ❌ NEVER generate images yourself
- ✅ ALL images MUST be from Unsplash with proper URLs



## 8. Design Variations & Uniqueness

**CRITICAL**: Each time you generate a page, make it UNIQUE. Don't create cookie-cutter templates.

**For "${s(data.style)}" style, implement ONE of these color scheme variations:**

**Minimalist Pro variations:**
- Variation A: Pure B&W with one accent color (blue, green, or purple)
- Variation B: Soft grays with pastel accent
- Variation C: White with bold typography and minimal color

**Modern variations:**
- Variation A: Blue-purple gradient theme
- Variation B: Teal-cyan contemporary
- Variation C: Dark mode with neon accents

**Luxury variations:**
- Variation A: Gold + deep navy
- Variation B: Rose gold + charcoal
- Variation C: Silver + burgundy

**Event/Wedding variations:**
- Variation A: Blush pink + gold
- Variation B: Sage green + cream
- Variation C: Lavender + silver
- Variation D: Coral + ivory

**Store variations:**
- Variation A: Fresh & clean (white + one brand color)
- Variation B: Warm & inviting (earth tones)
- Variation C: Bold & modern (bright colors, high contrast)

**Layout Variations:** For each section, randomly choose from 2-3 different layout options to create diversity.

## 9. Final Command

Your response must contain only HTML code. Start directly with \`<!DOCTYPE html>\`.

**REMEMBER**: 
- This must be STUNNING - worthy of an award-winning creative agency
- Every element should be polished and professional
- Make it UNIQUE - no two pages should look identical
- Follow the ${s(data.style)} aesthetic but interpret it creatively
- The page should convert visitors into customers/leads/guests

`;

            console.log('Generated masterPrompt length:', masterPrompt.length);
            console.log('MasterPrompt preview:', masterPrompt.substring(0, 500) + '...');
            return masterPrompt;

        }



        function populateTemplateGrid() {

            ui.templateGrid.innerHTML = Object.entries(pageTemplates).map(([key, templateData]) => {

                const t = templateData.t[state.currentLanguage]; // Get translated content

                return `

                <div class="template-card rounded-xl shadow-lg cursor-pointer group" data-type="${key}">

                    <img src="${templateData.img}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/94a3b8?text=Image+Not+Found';" alt="Template for ${t.title}" class="w-full h-80 object-cover">

                    <div class="absolute inset-0 bg-black/20 overlay opacity-0 group-hover:opacity-40"></div>

                    <div class="absolute bottom-0 inset-inline-start-0 inset-inline-end-0 p-6 bg-gradient-to-t from-black/80 to-transparent">

                        <h3 class="font-bold text-2xl text-white">${t.title}</h3>

                        <p class="text-white/80 text-sm mt-1">${t.description}</p>

                    </div>

                </div>

            `}).join('');

        }



        function createDynamicFields(fields) {

            // This function creates form fields. Labels and placeholders should be translated.

            const fieldHTML = {

                websiteLink: `

                <fieldset class="form-fieldset" data-field="websiteLink">

                    <legend class="form-legend" data-translate-key="fieldset_external_links"></legend>

                    <div class="space-y-4">

                        <div>

                            <label for="websiteLinkText" class="block text-sm font-medium text-slate-700" data-translate-key="label_main_button_text"></label>

                            <input type="text" name="websiteLinkText" id="websiteLinkText" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md">

                        </div>

                        <div>

                            <label for="websiteLink" class="block text-sm font-medium text-slate-700" data-translate-key="label_main_button_url"></label>

                            <input type="url" name="websiteLink" id="websiteLink" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md">

                        </div>

                    </div>

                </fieldset>`,

                propertyDetails: `

                <fieldset class="form-fieldset" data-field="propertyDetails">

                    <legend class="form-legend" data-translate-key="fieldset_property_details"></legend>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">

                        <div><label for="beds" class="block text-sm font-medium text-slate-700" data-translate-key="label_beds"></label><input type="number" name="beds" id="beds" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                        <div><label for="baths" class="block text-sm font-medium text-slate-700" data-translate-key="label_baths"></label><input type="number" name="baths" id="baths" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                        <div><label for="sqft" class="block text-sm font-medium text-slate-700" data-translate-key="label_sqft"></label><input type="number" name="sqft" id="sqft" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                        <div><label for="price" class="block text-sm font-medium text-slate-700" data-translate-key="label_price"></label><input type="text" name="price" id="price" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                    </div>

                </fieldset>`,

                productManagement: `

                <fieldset class="form-fieldset" data-field="productManagement">

                    <legend class="form-legend">הגדרות החנות</legend>

                    <div class="space-y-4">

                        <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                            <h4 class="font-semibold text-blue-900 mb-2">💳 חנות מקוונת מלאה</h4>
                            <p class="text-sm text-blue-700 mb-3">
                                <strong>מה זה חנות מקוונת?</strong><br>
                                גלריית מוצרים עם כפתורי "הוסף לעגלה", עגלת קניות צפה, וטופס תשלום מלא.<br>
                                <strong>כולל:</strong> כרטיס אשראי, PayPal, ביט, משלוח/איסוף עצמי.
                            </p>
                            
                            <div class="bg-white p-3 rounded-lg mb-3">
                                <label class="block text-sm font-semibold text-gray-900 mb-2">📦 כמה מוצרים להציג בחנות?</label>
                                <select name="productCount" id="productCount" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition">
                                    <option value="3">3 מוצרים</option>
                                    <option value="4">4 מוצרים</option>
                                    <option value="6" selected>6 מוצרים (מומלץ)</option>
                                    <option value="8">8 מוצרים</option>
                                    <option value="12">12 מוצרים</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">בחר כמה מוצרים תרצה להציג בקטלוג שלך</p>
                                </div>
                                
                            <div class="bg-green-50 p-3 rounded-lg">
                                <p class="text-sm text-green-800 mb-2">
                                    <strong>✅ כלול אוטומטית בכל חנות:</strong>
                                </p>
                                <ul class="text-xs text-green-700 space-y-1 mr-4">
                                    <li>• 💬 בוט WhatsApp (פינה שמאלית)</li>
                                    <li>• 🤖 בוט AI (פינה ימנית)</li>
                                    <li>• ♿ כפתור נגישות (פינה עליונה)</li>
                                    <li>• 🛒 עגלת קניות צפה</li>
                                    <li>• 💳 טופס תשלום מלא (אשראי, PayPal, ביט)</li>
                                    <li>• 📊 ניהול קניות (נתונים, סטטיסטיקות)</li>
                                </ul>
                                </div>
                        </div>

                    </div>

                </fieldset>`,

                appLinks: `

                <fieldset class="form-fieldset" data-field="appLinks">

                    <legend class="form-legend" data-translate-key="fieldset_app_links"></legend>

                    <div class="space-y-4">

                        <div><label for="appStoreLink" class="block text-sm font-medium text-slate-700" data-translate-key="label_app_store_link"></label><input type="url" name="appStoreLink" id="appStoreLink" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                        <div><label for="googlePlayLink" class="block text-sm font-medium text-slate-700" data-translate-key="label_google_play_link"></label><input type="url" name="googlePlayLink" id="googlePlayLink" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></div>

                    </div>

                </fieldset>`,

                eventDetails: `

                <fieldset class="form-fieldset" data-field="eventDetails">

                    <legend class="form-legend" data-translate-key="fieldset_event_details">פרטי האירוע</legend>

                    <div class="space-y-4">

                        <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200 mb-4">
                            <h4 class="font-semibold text-purple-900 mb-2">🎉 הזמנה לאירוע מותאמת אישית</h4>
                            <p class="text-sm text-purple-700">
                                <strong>מה כולל:</strong> הזמנה מעוצבת עם ספירה לאחור, פרטי האירוע, טופס אישור הגעה (RSVP), ואפשרויות ניהול מוזמנים מתקדמות.
                            </p>
                        </div>

                        <div>
                            <label for="eventDate" class="block text-sm font-medium text-slate-700" data-translate-key="label_event_date">תאריך האירוע</label>
                            <input type="datetime-local" name="eventDate" id="eventDate" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                        </div>

                        <div>
                            <label for="eventLocation" class="block text-sm font-medium text-slate-700" data-translate-key="label_event_location">שם האולם / מקום האירוע</label>
                            <input type="text" name="eventLocation" id="eventLocation" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="למשל: אולם אירועים גן העיר">
                        </div>

                        <div>
                            <label for="eventAddress" class="block text-sm font-medium text-slate-700">כתובת המקום</label>
                            <input type="text" name="eventAddress" id="eventAddress" class="mt-1 block w-full px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm" placeholder="למשל: רחוב הרצל 25, תל אביב">
                            <p class="mt-1 text-sm text-slate-500">הכתובת תשמש למיקום ב-Google Maps בדף האירוע</p>
                        </div>

                        <div class="bg-blue-50 p-3 rounded-lg mt-4">
                            <p class="text-sm text-blue-800 mb-2">
                                <strong>✅ כלול אוטומטית בכל הזמנה:</strong>
                            </p>
                            <ul class="text-xs text-blue-700 space-y-1 mr-4">
                                <li>• ⏱️ ספירה לאחור לאירוע</li>
                                <li>• 📋 טופס אישור הגעה (RSVP)</li>
                                <li>• 👥 ממשק ניהול מוזמנים</li>
                                <li>• 🎁 מערכת רישום מתנות</li>
                                <li>• 🪑 סידור שולחנות אינטראקטיבי</li>
                                <li>• 💬 בוט WhatsApp לעדכונים</li>
                                <li>• ♿ כפתור נגישות</li>
                            </ul>
                        </div>

                    </div>

                </fieldset>`

            };

             ui.dynamicFieldsContainer.innerHTML = fields.map(field => fieldHTML[field] || '').join('');

             // Re-apply translations for any new elements

             ui.dynamicFieldsContainer.querySelectorAll('[data-translate-key]').forEach(el => {

                el.textContent = getTranslation(el.dataset.translateKey);

             });

        }

        

        // --- Event Binding ---

        function bindEventListeners() {

            ui.languageSelector.addEventListener('change', (e) => setLanguage(e.target.value));

            ui.templateGrid.addEventListener('click', handleTemplateSelection);

            ui.detailsForm.addEventListener('submit', handleFormSubmit);

            if (ui.designSelectionContainer) {

                ui.designSelectionContainer.addEventListener('mouseover', handleStyleHover);

                ui.designSelectionContainer.addEventListener('click', handleStyleSelection);

            }

            ui.backToFormBtn.addEventListener('click', () => {

                switchView(ui.previewView, ui.formView);

                if (state.isEditing) toggleEditMode(false); // Force exit edit mode

            });

            ui.toolsFab.addEventListener('click', handleFabClick);

            ui.savePageBtn.addEventListener('click', handleSavePage);

            ui.downloadPageBtn.addEventListener('click', handleBackToHome);
            ui.iframeImageUploader.addEventListener('change', handleImageUpload);

            ui.uploadImageBtn.addEventListener('click', handleUploadBtnClick);
            
            ui.deleteImageBtn.addEventListener('click', handleDeleteImage);

            ui.textColorPicker.addEventListener('input', (e) => { if (state.currentElementToEdit) state.currentElementToEdit.style.color = e.target.value; });

            ui.bgColorPicker.addEventListener('input', (e) => { if (state.currentElementToEdit) state.currentElementToEdit.style.backgroundColor = e.target.value; });

            ui.opacitySlider.addEventListener('input', (e) => { if(state.currentOverlayToEdit) state.currentOverlayToEdit.style.backgroundColor = `rgba(0, 0, 0, ${e.target.value})`; });

            ui.modalCloseBtn.addEventListener('click', hideModal);

            ui.customModal.addEventListener('click', (e) => { if (e.target === ui.customModal) hideModal(); });

            document.getElementById('back-to-type-btn').addEventListener('click', () => switchView(ui.formView, ui.typeSelectionView));

            // Store Management Dashboard
            document.getElementById('close-dashboard-btn').addEventListener('click', () => {
                document.getElementById('store-management-dashboard').classList.add('hidden');
            });

            // Dashboard Navigation
            document.querySelectorAll('.dashboard-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    document.querySelectorAll('.dashboard-nav-btn').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    btn.classList.add('active');
                    
                    // Hide all sections
                    document.querySelectorAll('.dashboard-section').forEach(section => {
                        section.classList.add('hidden');
                    });
                    
                    // Show selected section
                    const sectionId = btn.getAttribute('data-section') + '-section';
                    document.getElementById(sectionId).classList.remove('hidden');
                });
            });

            // Close dashboard when clicking outside
            document.getElementById('store-management-dashboard').addEventListener('click', (e) => {
                if (e.target.id === 'store-management-dashboard') {
                    document.getElementById('store-management-dashboard').classList.add('hidden');
                }
            });

            // Function to open page-specific management interface
            window.openStoreManagement = function() {
                // Update dashboard title based on page type
                const pageType = state.selectedPageType;
                const dashboardTitle = document.getElementById('dashboard-title');
                
                if (pageType === 'event') {
                    dashboardTitle.textContent = 'ניהול מוזמנים';
                } else if (pageType === 'onlineStore') {
                    dashboardTitle.textContent = 'ניהול חנות';
                } else {
                    dashboardTitle.textContent = 'ניהול הדף';
                }
                // Create management interface for this specific page
                createPageManagementInterface();
            };

            // Function to create page-specific management interface
            function createPageManagementInterface() {
                // Remove existing management interface if any
                const existing = document.getElementById('page-management-interface');
                if (existing) {
                    existing.remove();
                }

                // Create new management interface
                const managementInterface = document.createElement('div');
                managementInterface.id = 'page-management-interface';
                managementInterface.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                managementInterface.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl w-11/12 h-5/6 max-w-4xl overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-600 to-pink-500 text-white p-6">
                            <div class="flex justify-between items-center">
                                <h1 class="text-2xl font-bold">ניהול הדף</h1>
                                <button onclick="closePageManagement()" class="text-white hover:text-gray-200 text-2xl">×</button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <h3 class="text-lg font-semibold text-blue-900 mb-4">נתוני הדף</h3>
                                    <p class="text-blue-700">שם הדף: ${document.title || 'ללא שם'}</p>
                                    <p class="text-blue-700">תאריך יצירה: ${new Date().toLocaleDateString('he-IL')}</p>
                                    <p class="text-blue-700">מספר ביקורים: ${Math.floor(Math.random() * 1000)}</p>
                                </div>
                                
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <h3 class="text-lg font-semibold text-green-900 mb-4">פעולות מהירות</h3>
                                    <div class="space-y-2">
                                        <button onclick="editPageContent()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">ערוך תוכן</button>
                                        <button onclick="viewAnalytics()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">צפה בסטטיסטיקות</button>
                                        <button onclick="exportPage()" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700">ייצא דף</button>
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 p-6 rounded-lg">
                                    <h3 class="text-lg font-semibold text-yellow-900 mb-4">הגדרות הדף</h3>
                                    <div class="space-y-2">
                                        <button onclick="changePageTitle()" class="w-full bg-yellow-600 text-white py-2 px-4 rounded hover:bg-yellow-700">שנה כותרת</button>
                                        <button onclick="changePageColors()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700">שנה צבעים</button>
                                        <button onclick="addNewSection()" class="w-full bg-pink-600 text-white py-2 px-4 rounded hover:bg-pink-700">הוסף קטע</button>
                                    </div>
                                </div>
                                
                                <div class="bg-red-50 p-6 rounded-lg">
                                    <h3 class="text-lg font-semibold text-red-900 mb-4">ניהול מתקדם</h3>
                                    <div class="space-y-2">
                                        <button onclick="viewPageSource()" class="w-full bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700">צפה בקוד המקור</button>
                                        <button onclick="duplicatePage()" class="w-full bg-teal-600 text-white py-2 px-4 rounded hover:bg-teal-700">שכפל דף</button>
                                        <button onclick="deletePage()" class="w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">מחק דף</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(managementInterface);
            }

            // Function to close page management
            window.closePageManagement = function() {
                const managementInterface = document.getElementById('page-management-interface');
                if (managementInterface) {
                    managementInterface.remove();
                }
            };

            // Management functions
            window.editPageContent = function() {
                alert('פתיחת עורך התוכן...');
            };

            window.viewAnalytics = function() {
                alert('צפייה בסטטיסטיקות הדף...');
            };

            window.exportPage = function() {
                alert('ייצוא הדף...');
            };

            window.changePageTitle = function() {
                const newTitle = prompt('הזן כותרת חדשה:', document.title);
                if (newTitle) {
                    document.title = newTitle;
                }
            };

            window.changePageColors = function() {
                alert('פתיחת עורך הצבעים...');
            };

            window.addNewSection = function() {
                alert('הוספת קטע חדש...');
            };

            window.viewPageSource = function() {
                alert('צפייה בקוד המקור של הדף...');
            };

            window.duplicatePage = function() {
                alert('שכפול הדף...');
            };

            window.deletePage = function() {
                if (confirm('האם אתה בטוח שברצונך למחוק את הדף?')) {
                    alert('מחיקת הדף...');
                }
            };

            ui.formView.addEventListener('focusin', (e) => {

                if (e.target.dataset.guidanceKey) {

                    ui.guidanceBubble.innerHTML = getTranslation(e.target.dataset.guidanceKey);

                    ui.guidanceBubble.classList.remove('hidden');

                }

            });

            ui.assistantAvatar.addEventListener('click', () => {

                ui.guidanceBubble.classList.toggle('hidden');

            });

        }



        // --- Event Handlers ---

        function handleTemplateSelection(event) {

            const card = event.target.closest('.template-card');

            if (!card) return;



            state.selectedPageType = card.dataset.type;

            const template = pageTemplates[state.selectedPageType].t[state.currentLanguage];

            

            state.selectedPageTitle = template.title;

            ui.pageTypeTitle.textContent = template.title;

            ui.mainNameLabel.textContent = template.label;

            ui.guidanceBubble.innerHTML = template.guidance;

            ui.guidanceBubble.classList.remove('hidden');

            // Update description label based on page type
            try {
                const descriptionLabel = document.querySelector('label[for="description"]');
                if (descriptionLabel && state.selectedPageType && state.currentLanguage) {
                    if (state.selectedPageType === 'event') {
                        descriptionLabel.textContent = state.currentLanguage === 'he' ? 'פרטי האירוע' : 'Event Details';
                    } else {
                        descriptionLabel.textContent = state.currentLanguage === 'he' ? 'תיאור העסק' : 'Business Description';
                    }
                }

                // Update contact name label for events
                const contactNameLabel = document.querySelector('label[for="contactName"]');
                if (contactNameLabel && state.selectedPageType && state.currentLanguage) {
                    if (state.selectedPageType === 'event') {
                        contactNameLabel.textContent = state.currentLanguage === 'he' ? 'שם המארגן' : 'Organizer Name';
                    } else {
                        contactNameLabel.textContent = state.currentLanguage === 'he' ? 'שם איש קשר' : 'Contact Name';
                    }
                }
            } catch (error) {
                console.warn('Error updating labels:', error);
            }

            createDynamicFields(pageTemplates[state.selectedPageType].fields);

            

            const showExtraSections = !['flyer', 'post', 'businessCard', 'event'].includes(state.selectedPageType);

            const showDesignStyle = true; 

            const showAccessibilityOption = !['flyer', 'post'].includes(state.selectedPageType);



            ui.socialMediaFieldset.style.display = showExtraSections ? 'block' : 'none';

            ui.optionalSectionsFieldset.style.display = showExtraSections ? 'block' : 'none';

            ui.designStyleFieldset.style.display = showDesignStyle ? 'block' : 'none';

            ui.addressFieldContainer.style.display = showExtraSections ? 'block' : 'none';

            

            const accessibilityContainer = document.getElementById('accessibility-field-container');

            if(accessibilityContainer) {

                 accessibilityContainer.style.display = showAccessibilityOption ? 'block' : 'none';

            }





            if (showExtraSections) {

                const optionsGrid = ui.optionalSectionsFieldset.querySelector('.grid');

                optionsGrid.innerHTML = Object.entries(availableSections).map(([key, sectionData]) => {

                     const section = sectionData.t[state.currentLanguage];

                     return `

                    <div class="flex items-center">

                        <input id="section-${key}" name="optionalSections" type="checkbox" value="${key}" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-600">

                        <label for="section-${key}" class="ms-2 block text-sm text-gray-900">${section.title}</label>

                    </div>

                `}).join('');

            }



            switchView(ui.typeSelectionView, ui.formView);

        }



        function handleStyleHover(event) {

            const card = event.target.closest('.option-card');

            if (card && card.dataset.guidanceKey) {

                ui.guidanceBubble.innerHTML = getTranslation(card.dataset.guidanceKey);

                ui.guidanceBubble.classList.remove('hidden');

            }

        }



        function handleStyleSelection(event) {

            const selectedCard = event.target.closest('.option-card');

            if (!selectedCard) return;

            ui.designSelectionContainer.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));

            selectedCard.classList.add('selected');

            state.selectedStyle = selectedCard.dataset.value;

        }



        async function handleFormSubmit(event) {

            event.preventDefault();

            if (!state.selectedStyle) {

                showModal('modal_error_style');

                return;

            }

            

            setLoading(true);



            const formData = new FormData(ui.detailsForm);

            let data = Object.fromEntries(formData.entries());

            // נגישות, AI Bot ו-WhatsApp תמיד מופיעים
            data.addAccessibility = true;
            data.addAiBot = true;
            data.useAsBackground = document.getElementById('use-as-background').checked;

            data.style = state.selectedStyle;

            data.pageType = state.selectedPageType;

            state.originalDescription = data.description;

            
            // הוסף נתוני שפה ומדינה
            data = addLanguageToPageData(data);
            

            const masterPrompt = createMasterPrompt(data);

            

            switchView(ui.formView, ui.previewView);



            try {

                const htmlContent = await generateHtmlFromApi(masterPrompt);

                    // הוסף קישורים לתחתית הדף
                    let finalHtml = addFooterLinks(htmlContent, data);
                    
                    // הוסף פונקציונליות חנות אם יש מוצרים או addToCart
                    console.log('Checking if need to inject store scripts. selectedPageType:', state.selectedPageType);
                    const hasAddToCart = finalHtml.includes('addToCart');
                    const hasProductCard = finalHtml.includes('product-card') || finalHtml.includes('product-name');
                    const hasCartIcon = finalHtml.includes('cart-icon');
                    const isStoreTemplate = state.selectedPageType === 'onlineStore';
                    
                    if (isStoreTemplate || hasAddToCart || hasProductCard || hasCartIcon) {
                        console.log('✅ Injecting store scripts for preview... (isStore:', isStoreTemplate, 'hasAddToCart:', hasAddToCart, 'hasProductCard:', hasProductCard, ')');
                        finalHtml = injectStoreScripts(finalHtml, data);
                        console.log('✅ Store scripts injected to preview!');
                    } else {
                        console.log('❌ NOT a store, skipping store scripts');
                    }
                

                ui.previewIframe.srcdoc = finalHtml;
                
                // Store in window for saving (CRITICAL for page saving!)
                ui.previewIframe.contentWindow.generatedPageHTML = finalHtml;

                ui.previewIframe.onload = () => {
                    
                    // Ensure generatedPageHTML is set AGAIN after iframe loads
                    ui.previewIframe.contentWindow.generatedPageHTML = finalHtml;
                    console.log('✅ generatedPageHTML stored in iframe window');

                    ui.previewContainer.classList.remove('hidden');

                    ui.generationView.classList.add('hidden');

                    ui.toolsFab.classList.remove('hidden');

                    ui.toolsFab.classList.remove('active');

                    ui.toolsMenu.classList.remove('open');

                };

            } catch (error) {

                console.error('Error generating page:', error);

                ui.generationView.innerHTML = `<div class="text-center p-8"><h2 class="text-2xl font-semibold text-red-500">${getTranslation('gen_error_title')}</h2><p class="text-slate-600 mt-2">${getTranslation('gen_error_details')}</p><pre class="mt-2 text-left text-xs bg-slate-100 p-2 rounded text-slate-500 whitespace-pre-wrap">${error.message}</pre></div>`;

            } finally {

                setLoading(false);

            }

        }

        
    
            function addFooterLinks(htmlContent, formData = null) {
                // קבל פרטי יצירת קשר מהטופס או מהפרמטרים
                let contactEmail, contactPhone, businessName, websiteUrl;
                
                if (formData) {
                    contactEmail = formData.email || 'info@example.com';
                    contactPhone = formData.phone || '03-1234567';
                    businessName = formData.mainName || 'החברה שלנו';
                    websiteUrl = formData.websiteUrl || window.location.origin;
                } else {
                    contactEmail = document.getElementById('email')?.value || 'info@example.com';
                    contactPhone = document.getElementById('phone')?.value || '03-1234567';
                    businessName = document.getElementById('mainName')?.value || 'החברה שלנו';
                    websiteUrl = document.getElementById('websiteUrl')?.value || window.location.origin;
                }
                
                // הוסף קישורים לתחתית הדף עם פרטי יצירת קשר מותאמים
                const footerHtml = `
                    <footer style="background-color: #f8fafc; border-top: 1px solid #e2e8f0; padding: 20px 0; margin-top: 40px; text-align: center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                        <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
                            <div style="margin-bottom: 15px;">
                                <a href="/privacy-policy.html?business=${encodeURIComponent(businessName)}&email=${encodeURIComponent(contactEmail)}&phone=${encodeURIComponent(contactPhone)}" style="color: #64748b; text-decoration: none; margin: 0 15px; font-size: 14px; transition: color 0.3s ease;" onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='#64748b'">מדיניות פרטיות</a>
                                <span style="color: #cbd5e1;">|</span>
                                <a href="/accessibility-statement.html?business=${encodeURIComponent(businessName)}&email=${encodeURIComponent(contactEmail)}&phone=${encodeURIComponent(contactPhone)}" style="color: #64748b; text-decoration: none; margin: 0 15px; font-size: 14px; transition: color 0.3s ease;" onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='#64748b'">הצהרת נגישות</a>
                                <span style="color: #cbd5e1;">|</span>
                                <a href="/terms-of-service.html?business=${encodeURIComponent(businessName)}&email=${encodeURIComponent(contactEmail)}&phone=${encodeURIComponent(contactPhone)}&website=${encodeURIComponent(websiteUrl)}" style="color: #64748b; text-decoration: none; margin: 0 15px; font-size: 14px; transition: color 0.3s ease;" onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='#64748b'">תנאי שירות</a>
                            </div>
                            <div style="color: #94a3b8; font-size: 11px; margin-top: 5px;">
                                יצירת קשר: <a href="mailto:${contactEmail}" style="color: #64748b; text-decoration: none;">${contactEmail}</a> | ${contactPhone}
                            </div>
                        </div>
                    </footer>
                `;

                // בדוק אם יש תגית </body> או </html>
                if (htmlContent.includes('</body>')) {
                    return htmlContent.replace('</body>', footerHtml + '</body>');
                } else if (htmlContent.includes('</html>')) {
                    return htmlContent.replace('</html>', footerHtml + '</html>');
                } else {
                    // אם אין תגיות סגירה, פשוט הוסף את התחתית בסוף
                    return htmlContent + footerHtml;
                }
            }

        async function generateHtmlFromApi(prompt) {

             const N8N_GENERATE_URL = 'https://n8n-service-how4.onrender.com/webhook/jhfuhgufkhlkuho8erhfaadsgdrghre546yrthfg';

             const payload = { masterPrompt: prompt };

             
             console.log('Sending request to webhook:', N8N_GENERATE_URL);
             console.log('Payload:', payload);
             

             try {

                // יצירת AbortController עם timeout של 10 דקות
                 const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10 * 60 * 1000); // 10 דקות

                 const response = await fetch(N8N_GENERATE_URL, {

                     method: 'POST',

                     headers: { 'Content-Type': 'application/json' },

                     body: JSON.stringify(payload),
                     
                     signal: controller.signal

                 });
                 
                 clearTimeout(timeoutId);

                 
                 console.log('Webhook response status:', response.status);
                 console.log('Webhook response ok:', response.ok);


                const responseText = await response.text();

                console.log('Webhook response text length:', responseText.length);
                console.log('Webhook response preview:', responseText.substring(0, 200) + '...');
                
                // בדוק אם התשובה ריקה
                if (!responseText || responseText.trim().length === 0) {
                    console.warn('⚠️ N8N returned empty response - falling back to local generation');
                    clearTimeout(timeoutId);
                    
                    // נסה יצירה מקומית
                    const localHtmlResponse = await fetch('/api/generate-html', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ masterPrompt: prompt })
                    });
                    
                    if (localHtmlResponse.ok) {
                        const localData = await localHtmlResponse.json();
                        if (localData.html) {
                            console.log('✅ Created HTML locally successfully');
                            return localData.html;
                        }
                    }
                    
                    throw new Error('N8N returned empty response and local generation failed');
                }

                if (!response.ok) {

                    console.error('Webhook error:', response.status, responseText);
                     
                     // הצג הודעת שגיאה ידידותית למשתמש
                     ui.generationView.innerHTML = `
                         <div class="max-w-2xl mx-auto text-center">
                             <div class="mb-8">
                                 <h2 class="text-3xl font-bold text-red-400 mb-4">⚠️ בעיה טכנית</h2>
                                 <p class="text-gray-300 text-lg">השרת שלנו כרגע עמוס, אנא נסה שוב בעוד כמה דקות</p>
                             </div>
                             <div class="bg-red-500/20 backdrop-blur-sm rounded-xl p-6">
                                 <p class="text-red-300 font-medium">שגיאה ${response.status}: השרת לא זמין כרגע</p>
                             </div>
                             <div class="mt-6">
                                 <button onclick="window.location.reload()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                     נסה שוב
                                 </button>
                             </div>
                         </div>
                     `;
                     
                     throw new Error(`Server Error (${response.status}): ${responseText}`);

                 }



                 function findHtml(obj) {

                    for (const key in obj) {

                        if (typeof obj[key] === 'string' && (obj[key].trim().startsWith('<!DOCTYPE html') || obj[key].trim().startsWith('<html') || obj[key].trim().startsWith('```html'))) {

                            return obj[key].replace(/^```html\s*/, '').replace(/```$/, '').trim();

                        }

                        if (typeof obj[key] === 'object' && obj[key] !== null) {

                            const result = findHtml(obj[key]);

                            if (result) return result;

                        }

                    }

                    return null;

                 }

                

                 try {

                    const responseData = JSON.parse(responseText);

                    const html = findHtml(responseData);

                    if (html) return html;

                 } catch (e) {

                    if (responseText.trim().startsWith('<!DOCTYPE html') || responseText.trim().startsWith('<html')) {

                        return responseText;

                    }

                 }

                 

                 throw new Error("Could not find valid HTML in the server response.");



             } catch (error) {

                 console.error("Error in generateHtmlFromApi:", error);
                 console.error('Error details:', error.message);
                 console.error('Error stack:', error.stack);
                 
                // בדוק אם זה timeout - במקום להראות שגיאה, ניצור HTML בסיסי מקומית
                 if (error.name === 'AbortError') {
                    console.log('⚠️ N8N timeout - creating basic HTML locally');
                    
                    // יצירת HTML בסיסי מקומית
                    try {
                        const localHtmlResponse = await fetch('/api/generate-html', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ masterPrompt: prompt })
                        });
                        
                        if (localHtmlResponse.ok) {
                            const localData = await localHtmlResponse.json();
                            if (localData.html) {
                                console.log('✅ Created HTML locally successfully');
                                return localData.html;
                            }
                        }
                    } catch (localError) {
                        console.error('Local generation also failed:', localError);
                    }
                    
                    // אם גם זה נכשל, הצג הודעת שגיאה
                     ui.generationView.innerHTML = `
                         <div class="max-w-2xl mx-auto text-center">
                             <div class="mb-8">
                                <h2 class="text-3xl font-bold text-yellow-400 mb-4">⏰ השרת עמוס</h2>
                                <p class="text-gray-300 text-lg">השרת החיצוני שלנו עמוס כרגע</p>
                             </div>
                             <div class="bg-yellow-500/20 backdrop-blur-sm rounded-xl p-6">
                                <p class="text-yellow-300 font-medium">אנא נסה שוב בעוד כמה דקות</p>
                             </div>
                             <div class="mt-6">
                                 <button onclick="window.location.reload()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                     נסה שוב
                                 </button>
                             </div>
                         </div>
                     `;
                    throw error;
                 } else {
                     // הצג הודעת שגיאה ידידותית למשתמש
                     ui.generationView.innerHTML = `
                         <div class="max-w-2xl mx-auto text-center">
                             <div class="mb-8">
                                 <h2 class="text-3xl font-bold text-red-400 mb-4">⚠️ בעיה בחיבור</h2>
                                 <p class="text-gray-300 text-lg">לא הצלחנו להתחבר לשרת ה-AI שלנו</p>
                             </div>
                             <div class="bg-red-500/20 backdrop-blur-sm rounded-xl p-6">
                                 <p class="text-red-300 font-medium">${error.message}</p>
                             </div>
                             <div class="mt-6">
                                 <button onclick="window.location.reload()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                     נסה שוב
                                 </button>
                             </div>
                         </div>
                     `;
                 }
                 
                 throw error;

             }

        }



        function handleFabClick() {

            const isOpening = !ui.toolsMenu.classList.contains('open');

            ui.toolsFab.classList.toggle('active', isOpening);

            ui.toolsMenu.classList.toggle('open', isOpening);

            

            toggleEditMode(isOpening);

        }



        function toggleEditMode(forceState) {

            const newState = (typeof forceState === 'boolean') ? forceState : !state.isEditing;

            if (newState === state.isEditing) return;



            state.isEditing = newState;

            const iframeDoc = ui.previewIframe.contentWindow.document;

            if (!iframeDoc) {

                showModal("modal_error_edit_mode");

                return;

            }



            if (state.isEditing) {

                iframeDoc.body.contentEditable = true;

                iframeDoc.designMode = 'off';

                ui.previewIframe.classList.add('editable');

                ui.toolsFab.innerHTML = '<i data-lucide="check-circle" class="w-6 h-6"></i>';

                iframeDoc.body.addEventListener('click', handleIframeElementClick, true);

            } else {

                iframeDoc.body.contentEditable = false;

                ui.previewIframe.classList.remove('editable');

                ui.toolsFab.innerHTML = '<i data-lucide="pencil" class="w-6 h-6"></i>';

                iframeDoc.body.removeEventListener('click', handleIframeElementClick, true);

                if (state.currentElementToEdit) {

                    state.currentElementToEdit.style.outline = '';

                    state.currentElementToEdit = null;

                }
                
                // איפוס מצב תמונה והסתר כפתור מחיקה
                state.elementToModifyForImage = null;
                state.imageModificationType = null;
                ui.deleteImageBtn.style.display = 'none';

                 ui.opacityControl.classList.add('hidden');

            }

            lucide.createIcons(); 

        }



        function handleIframeElementClick(event) {

            if (!state.isEditing) return;

            event.preventDefault();

            event.stopPropagation();

            const target = event.target;



            ui.opacityControl.classList.add('hidden');

            state.currentOverlayToEdit = null;

            

            state.elementToModifyForImage = null;

            state.imageModificationType = null;



            const backgroundHolder = findBackgroundHolder(target);

            

            if (target.tagName === 'IMG') {

                state.elementToModifyForImage = target;

                state.imageModificationType = 'src';
                
                // הצג כפתור מחיקה
                ui.deleteImageBtn.style.display = 'block';

            } else if (backgroundHolder) {

                state.elementToModifyForImage = backgroundHolder;

                state.imageModificationType = 'background';

                state.currentOverlayToEdit = backgroundHolder.querySelector('.bg-overlay');

                if (state.currentOverlayToEdit) {

                    ui.opacityControl.classList.remove('hidden');

                    const rgbaColor = window.getComputedStyle(state.currentOverlayToEdit).backgroundColor;

                    const match = /rgba?\((\d+), (\d+), (\d+)(, ([\d.]+))?\)/.exec(rgbaColor);

                    ui.opacitySlider.value = match && match[5] ? match[5] : 0.5;

                }
                
                // הצג כפתור מחיקה
                ui.deleteImageBtn.style.display = 'block';

            }



            if (state.currentElementToEdit) state.currentElementToEdit.style.outline = '';

            state.currentElementToEdit = target;

            state.currentElementToEdit.style.outline = '2px dashed #8b5cf6';

        }



        function handleUploadBtnClick() {

            if (state.elementToModifyForImage) {

                ui.iframeImageUploader.click();

            } else {

                showModal("modal_error_upload_image");

            }

        }

        

        async function handleImageUpload(event) {

             const file = event.target.files[0];

             if (!file || !state.elementToModifyForImage) return;



             showModal(getTranslation('modal_processing_image'));



             try {

                 const resizedFile = await resizeAndCompressImage(file);

                 

                 const { data: { user } } = await sb.auth.getUser();

                 if (!user) {

                     throw new Error(getTranslation('modal_upload_auth_error'));

                 }



                 let imageUrl = null;

                 // העלה תמונה לתיקיית output המקומית
                 try {
                     const formData = new FormData();
                     formData.append('image', resizedFile);
                     formData.append('userId', user.id);
                     formData.append('pageName', state.currentPageData?.title || 'general');

                     const response = await fetch('/api/upload-image', {
                         method: 'POST',
                         body: formData
                     });

                     if (response.ok) {
                         const result = await response.json();
                         if (result.success) {
                             imageUrl = result.imageUrl;
                             console.log('תמונה נשמרה מקומית:', imageUrl);
                         }
                     }
                 } catch (localError) {
                     console.error('Local upload failed:', localError);
                 }

                 // אם גם זה נכשל, השתמש ב-data URL
                 if (!imageUrl) {
                     const reader = new FileReader();
                     imageUrl = await new Promise((resolve) => {
                         reader.onload = () => resolve(reader.result);
                         reader.readAsDataURL(resizedFile);
                     });
                     console.log('תמונה נשמרה כ-data URL');
                 }

                 if (!imageUrl) {
                     throw new Error('לא ניתן להעלות את התמונה');
                 }

                 // עדכן את התמונה
                 if (state.imageModificationType === 'src') {

                      state.elementToModifyForImage.src = imageUrl;
                 } else if (state.imageModificationType === 'background') {

                      state.elementToModifyForImage.style.backgroundImage = `url('${imageUrl}')`;
                 }

                 

                 hideModal();

                 showModal(getTranslation('modal_image_success'));



             } catch (error) {

                 console.error('Error uploading image:', error);

                 hideModal();

                 showModal(`${getTranslation('modal_image_error')}: ${error.message}`);

             } finally {

                 state.elementToModifyForImage = null;

                 event.target.value = '';

             }

        }


        // מחיקת תמונה
        function handleDeleteImage() {
            if (!state.elementToModifyForImage) {
                showModal("נא לבחור תמונה למחיקה");
                return;
            }

            if (!confirm('האם אתה בטוח שברצונך למחוק את התמונה?')) {
                return;
            }

            try {
                // מחק תמונה לפי סוג
                if (state.imageModificationType === 'src' && state.elementToModifyForImage.tagName === 'IMG') {
                    // מחק src ושם placeholder
                    state.elementToModifyForImage.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23ddd" width="400" height="300"/%3E%3Ctext fill="%23999" font-size="24" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle"%3ENo Image%3C/text%3E%3C/svg%3E';
                    state.elementToModifyForImage.alt = '';
                } else if (state.imageModificationType === 'background') {
                    // מחק background image
                    state.elementToModifyForImage.style.backgroundImage = 'none';
                    state.elementToModifyForImage.style.backgroundColor = '#f3f4f6'; // צבע רקע ניטרלי
                }

                showModal("✅ התמונה נמחקה בהצלחה");
                setTimeout(hideModal, 1500);

            } catch (error) {
                console.error('Error deleting image:', error);
                showModal("❌ שגיאה במחיקת התמונה: " + error.message);
            }
        }

        

        function resizeAndCompressImage(file, maxWidth = 1920, quality = 0.85) {

            return new Promise((resolve, reject) => {

                const reader = new FileReader();

                reader.readAsDataURL(file);

                reader.onload = event => {

                    const img = new Image();

                    img.src = event.target.result;

                    img.onload = () => {

                        const canvas = document.createElement('canvas');

                        const ctx = canvas.getContext('2d');

                        

                        let width = img.width;

                        let height = img.height;



                        if (width > maxWidth) {

                            height *= maxWidth / width;

                            width = maxWidth;

                        }



                        canvas.width = width;

                        canvas.height = height;

                        ctx.drawImage(img, 0, 0, width, height);

                        

                        canvas.toBlob(blob => {

                            if (!blob) {

                                reject(new Error('Canvas to Blob conversion failed.'));

                                return;

                            }

                            const newFile = new File([blob], file.name, {

                                type: blob.type,

                                lastModified: Date.now()

                            });

                            resolve(newFile);

                        }, file.type, quality);

                    };

                    img.onerror = error => reject(error);

                };

                reader.onerror = error => reject(error);

            });

        }





        async function handleSavePage() {

            showModal(getTranslation('modal_saving'));



            const { data: { user } } = await sb.auth.getUser();

            if (!user) {

                showModal(getTranslation('modal_error_auth'));

                return;

            }



            if(state.isEditing) toggleEditMode(false);

            // Wait for iframe to fully reload - CRITICAL FOR SAVING ALL CONTENT
            console.log('⏳ Waiting for iframe to fully reload...');
            await new Promise(r => setTimeout(r, 3500)); // Increased to 3500ms for stability
            
            // Wait for iframe document to be in ready state
            const iframeDoc = ui.previewIframe.contentWindow.document;
            if (iframeDoc.readyState !== 'complete') {
                console.log('⏳ Waiting for iframe to complete loading...');
                await new Promise(resolve => {
                    const handler = () => {
                        console.log('✅ DOM loaded');
                        resolve();
                    };
                    if (iframeDoc.readyState === 'loading') {
                        iframeDoc.addEventListener('DOMContentLoaded', handler, { once: true });
                    }
                    setTimeout(resolve, 1500); // Longer fallback timeout
                });
            }
            
            // Extra wait to ensure all scripts and async content have loaded
            console.log('⏳ Additional wait for async content...');
            await new Promise(r => setTimeout(r, 1000));
            console.log('✅ Iframe fully loaded, cloning document...');



            const clonedDoc = iframeDoc.cloneNode(true);

            clonedDoc.querySelectorAll('[style*="outline"]').forEach(el => el.style.outline = '');

            let finalHtml = clonedDoc.documentElement.outerHTML;
            
            // Verify we have RSVP form if this is an event page
            const hasRsvpForm = finalHtml.includes('id="rsvp-form"') || finalHtml.includes('rsvp-name');
            console.log('📋 RSVP form present in saved HTML:', hasRsvpForm);
            if (!hasRsvpForm && state.selectedPageType === 'event') {
                console.warn('⚠️ WARNING: Event page missing RSVP form in final HTML!');
            }
            
            // הוסף פונקציונליות חנות אם יש מוצרים או addToCart
            console.log('Saving page. selectedPageType:', state.selectedPageType);
            const hasAddToCart = finalHtml.includes('addToCart');
            const hasProductCard = finalHtml.includes('product-card') || finalHtml.includes('product-name');
            const hasCartIcon = finalHtml.includes('cart-icon');
            const isStoreTemplate = state.selectedPageType === 'onlineStore';
            
            if (isStoreTemplate || hasAddToCart || hasProductCard || hasCartIcon) {
                console.log('✅ Injecting store scripts for saving... (isStore:', isStoreTemplate, 'hasAddToCart:', hasAddToCart, 'hasProductCard:', hasProductCard, ')');
                const formData = new FormData(ui.detailsForm);
                const data = Object.fromEntries(formData.entries());
                data.pageType = state.selectedPageType || 'onlineStore';
                data.title = data.title || document.getElementById('mainName')?.value || 'חנות';
                finalHtml = injectStoreScripts(finalHtml, data);
                console.log('✅ Store scripts injected to final HTML!');
            } else {
                console.log('❌ NOT a store, skipping injection');
            }



            // בדוק אם אנחנו במצב עריכה
            const urlParams = new URLSearchParams(window.location.search);
            const editProjectId = urlParams.get('edit');

            if (editProjectId) {
                // מצב עריכה - עדכן את הקובץ הקיים
                console.log('Updating existing project:', editProjectId);
                
                if (editProjectId.startsWith('local_')) {
                    // עדכן קובץ מקומי
                    const fileName = editProjectId.replace('local_', '');
                    try {
                        const response = await fetch('/api/update-page', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                userId: user.id,
                                fileName: fileName,
                                htmlContent: finalHtml
                            })
                        });

                        if (response.ok) {
                            console.log('Local page updated successfully');
                            showModal('הדף עודכן בהצלחה!');
                        } else {
                            throw new Error('Failed to update local page');
                        }
                    } catch (error) {
                        console.error('Error updating local page:', error);
                        showModal('שגיאה בעדכון הדף');
                        return;
                    }
                } else {
                    // עדכן דף מ-Supabase
                    try {
                        const { error } = await sb.from('projects')
                            .update({ 
                                html_content: finalHtml,
                                name: document.getElementById('mainName').value || 'דף נחיתה'
                            })
                            .eq('id', editProjectId);
                        
                        if (error) {
                            console.error('Error updating Supabase project:', error);
                            showModal('שגיאה בעדכון הדף');
                            return;
                        }
                        
                        console.log('Supabase project updated successfully');
                        showModal('הדף עודכן בהצלחה!');
                    } catch (error) {
                        console.error('Supabase update error:', error);
                        showModal('שגיאה בעדכון הדף');
                        return;
                    }
                }
            } else {
                // מצב יצירה חדשה
            const pageData = {

                user_id: user.id,

                    name: document.getElementById('mainName').value || 'דף נחיתה',
                description: state.originalDescription,

                html_content: finalHtml,

                template_type: state.selectedPageType,
                
                pageType: state.selectedPageType === 'onlineStore' ? 'store' : state.selectedPageType,

                status: 'completed'

            };



                // נסה לשמור ב-Supabase
                let supabaseSuccess = false;
                try {
                    const { error } = await sb.from('projects').insert(pageData);
                    if (error) {
                        console.error('Error saving to Supabase:', error);
                    } else {
                        supabaseSuccess = true;
                        console.log('Page saved to Supabase successfully');
                    }
                } catch (supabaseError) {
                    console.error('Supabase save failed:', supabaseError);
                }

                // אם Supabase נכשל, נסה לשמור מקומית
                if (!supabaseSuccess) {
                    try {
                        const response = await fetch('/api/create-page', {
                    method: 'POST',

                    headers: {

                                'Content-Type': 'application/json',
                    },

                    body: JSON.stringify({

                        userId: user.id,

                                title: document.getElementById('mainName').value || 'דף נחיתה',
                                htmlContent: finalHtml,
                                selectedPageType: state.selectedPageType
                    })

                });



                        if (response.ok) {
                            const result = await response.json();
                            console.log('Page saved locally:', result);
                            showModal(getTranslation('modal_save_success'));
                        } else {
                            throw new Error('Local save failed');
                        }
                    } catch (localError) {
                        console.error('Local save error:', localError);
                        showModal(`${getTranslation('modal_error_save')}: שמירה מקומית נכשלה`);
                        return;
                    }
                } else {
                showModal(getTranslation('modal_save_success'));

                }
            }


                const redirectUrl = urlParams.get('redirectUrl');

                setTimeout(() => {

                    if (redirectUrl) {
                        // הוסף פרמטר שמציין שחזרנו מיצירת דף
                        const separator = redirectUrl.includes('?') ? '&' : '?';
                        window.top.location.href = redirectUrl + separator + 'fromCreator=true';

                    } else {

                        hideModal();

                    }

                }, 2000);

        }

        // --- Download Page Function ---
        // --- Back to Home Function ---
        function handleBackToHome() {
            // חזור לדף הבית ללא שמירה
            window.location.href = '/';
        }



        // --- Utility Functions ---

        function setLoading(isLoading) {

             if (isLoading) {

                ui.generateBtnText.classList.add('hidden');

                ui.generateBtnLoader.classList.remove('hidden');

                

                // טקסטים מתחלפים עם הסברים יפים
                const messages = [getTranslation('gen_text_1'), getTranslation('gen_text_2'), getTranslation('gen_text_3'), getTranslation('gen_text_4')];

                let messageIndex = 0;

                ui.generationView.innerHTML = `
                    <div class="gen-loader">
                        <div class="inner one"></div>
                        <div class="inner two"></div>
                        <div class="inner three"></div>
                    </div>
                    <p id="gen-text-animation" class="gen-text text-xl">${messages[messageIndex]}</p>
                `;

                const textElement = document.getElementById('gen-text-animation');

                const intervalId = setInterval(() => {
                    messageIndex = (messageIndex + 1) % messages.length;

                    if(textElement) {
                       textElement.classList.remove('fade-in');
                       void textElement.offsetWidth; // Trigger reflow
                       textElement.textContent = messages[messageIndex];
                       textElement.classList.add('fade-in');
                    }
                }, 4000); // זמן איטי יותר כדי שהמשתמש יוכל לקרוא בנוחות

                ui.generationView.dataset.intervalId = intervalId;






                if (!ui.previewView.classList.contains('active')) {

                     switchView(ui.formView, ui.previewView);

                }

                ui.generationView.classList.remove('hidden');

                ui.previewContainer.classList.add('hidden');

            } else {

                ui.generateBtnText.classList.remove('hidden');

                ui.generateBtnLoader.classList.add('hidden');

                ui.generationView.classList.add('hidden');

                // עצור את האנימציה
                const intervalId = ui.generationView.dataset.intervalId;
                if (intervalId) {
                    clearInterval(intervalId);
                }
            }

        }

        



        function findBackgroundHolder(el) {

            let current = el;

            for (let i = 0; i < 5 && current && current !== document.body; i++) {

                if (window.getComputedStyle(current).backgroundImage !== 'none') return current;

                current = current.parentElement;

            }

            return null;

        }



        // --- App Start ---

        window.addEventListener('DOMContentLoaded', (event) => {

            initializeApp();

            
            // בדוק אם צריך לטעון פרויקט לעריכה
            const urlParams = new URLSearchParams(window.location.search);
            const editProjectId = urlParams.get('edit');
            
            if (editProjectId) {
                // טען פרויקט לעריכה
                loadProjectForEdit(editProjectId);
            } else {
                // טען פרויקטים קיימים אחרי האתחול
                setTimeout(() => {
                    loadUserProjects();
                }, 1000);
                
                // הצג הודעה על מצב Supabase
                setTimeout(() => {
                    console.log('💡 טיפ: אם Supabase לא זמין, הדפים יישמרו מקומית בלבד');
                }, 2000);
            }
        });

        // --- Load Project for Edit ---
        async function loadProjectForEdit(projectId) {
            try {
                console.log('Loading project for edit:', projectId);
                
                // בדוק אם זה דף מקומי
                if (projectId.startsWith('local_')) {
                    const fileName = projectId.replace('local_', '');
                    console.log('Loading local file:', fileName);
                    
                    // טען את הקובץ המקומי
                    const { data: { user: currentUser } } = await sb.auth.getUser();
                    if (!currentUser) {
                        throw new Error('User not authenticated');
                    }
                    const response = await fetch(`/pages/${currentUser.id}/${fileName}`);
                    if (response.ok) {
                        const htmlContent = await response.text();
                        ui.previewIframe.srcdoc = htmlContent;
                        
                        // Store in iframe window for saving (CRITICAL!)
                        ui.previewIframe.onload = () => {
                            ui.previewIframe.contentWindow.generatedPageHTML = htmlContent;
                            console.log('✅ generatedPageHTML stored (loaded from file)');
                        };
                        
                        ui.previewContainer.classList.remove('hidden');
                        ui.generationView.classList.add('hidden');
                        ui.toolsFab.classList.remove('hidden');
                        ui.toolsFab.classList.remove('active');
                        ui.toolsMenu.classList.remove('open');
                        ui.savePageBtn.classList.remove('hidden');
                        ui.downloadPageBtn.classList.remove('hidden');
                        switchView(ui.typeSelectionView, ui.previewView);
                        return;
                    } else {
                        throw new Error('Failed to load local file');
                    }
                }
                
                // דף מ-Supabase
                const { data: project, error } = await sb
                    .from('projects')
                    .select('*')
                    .eq('id', projectId)
                    .single();

                if (error || !project) {
                    console.error('Supabase error:', error);
                    showModal('שגיאה בטעינת הפרויקט מ-Supabase');
                    return;
                }

                // טען את הפרויקט לעריכה
                ui.previewIframe.srcdoc = project.html_content;
                
                // Store in iframe window for saving (CRITICAL!)
                ui.previewIframe.onload = () => {
                    ui.previewIframe.contentWindow.generatedPageHTML = project.html_content;
                    console.log('✅ generatedPageHTML stored (loaded from Supabase)');
                };
                
                ui.previewContainer.classList.remove('hidden');
                ui.generationView.classList.add('hidden');
                ui.toolsFab.classList.remove('hidden');
                ui.toolsFab.classList.remove('active');
                ui.toolsMenu.classList.remove('open');
                ui.savePageBtn.classList.remove('hidden');
                ui.downloadPageBtn.classList.remove('hidden');
                switchView(ui.typeSelectionView, ui.previewView);

            } catch (error) {
                console.error('Error loading project for edit:', error);
                showModal('שגיאה בטעינת הפרויקט: ' + error.message);
            }
        }

        // --- Load User Projects ---
        async function loadUserProjects() {
            try {
                const { data: { user } } = await sb.auth.getUser();
                if (!user) {
                    console.log('No user found - Supabase unavailable');
                    return;
                }

                const { data: projects, error } = await sb
                    .from('projects')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.log('Supabase לא זמין - לא נטענו פרויקטים קיימים');
                } else {
                    console.log('נטענו פרויקטים קיימים:', projects?.length || 0);
                }
            } catch (error) {
                console.log('Supabase לא זמין - לא נטענו פרויקטים קיימים');
            }
        }

        // --- Language and Country Support ---
        function getCurrentLanguage() {
            // בדוק אם יש פרמטרים מ-URL
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            if (urlLang) {
                // עדכן את ה-selector
                const selector = document.getElementById('language-selector');
                if (selector) {
                    selector.value = urlLang;
                }
                return urlLang;
            }
            return document.getElementById('language-selector')?.value || 'he';
        }

        function getCountryFromLanguage(lang) {
            const countryMap = {
                'he': 'IL', // ישראל
                'ar': 'SA', // סעודיה
                'ja': 'JP', // יפן
                'en': 'US', // ארה"ב
                'es': 'ES', // ספרד
                'fr': 'FR', // צרפת
                'de': 'DE', // גרמניה
                'ru': 'RU', // רוסיה
                'zh': 'CN'  // סין
            };
            return countryMap[lang] || 'IL';
        }

        function getWhatsAppCountryCode(lang) {
            const countryCodes = {
                'he': '972', // ישראל
                'ar': '966', // סעודיה
                'ja': '81',  // יפן
                'en': '1',   // ארה"ב
                'es': '34',  // ספרד
                'fr': '33',  // צרפת
                'de': '49',  // גרמניה
                'ru': '7',   // רוסיה
                'zh': '86'   // סין
            };
            return countryCodes[lang] || '972';
        }

        function getLanguageName(lang) {
            const names = {
                'he': 'עברית',
                'ar': 'العربية',
                'ja': '日本語',
                'en': 'English',
                'es': 'Español',
                'fr': 'Français',
                'de': 'Deutsch',
                'ru': 'Русский',
                'zh': '中文'
            };
            return names[lang] || 'עברית';
        }

        function addLanguageToPageData(data) {
            // השתמש בשפה שנבחרה בטופס, לא בשפת הממשק
            const selectedOutputLang = data.outputLanguage || getCurrentLanguage();
            const country = getCountryFromLanguage(selectedOutputLang);
            const whatsappCountryCode = getWhatsAppCountryCode(selectedOutputLang);
            
            data.language = selectedOutputLang;
            data.outputLanguage = selectedOutputLang;
            data.country = country;
            data.languageName = getLanguageName(selectedOutputLang);
            data.whatsappCountryCode = whatsappCountryCode;
            
            // עדכן גם את ה-select של שפת הפלט
            const outputLanguageSelect = document.getElementById('outputLanguage');
            if (outputLanguageSelect) {
                outputLanguageSelect.value = selectedOutputLang;
            }
            
            console.log('Added language data:', { 
                language: selectedOutputLang, 
                outputLanguage: data.outputLanguage,
                country, 
                languageName: data.languageName,
                whatsappCountryCode 
            });
            return data;
        }

        // פונקציה לעדכון שפת הדף
        function updatePageLanguage(lang) {
            document.documentElement.lang = lang;
            if (lang === 'he' || lang === 'ar') {
                document.documentElement.dir = 'rtl';
            } else {
                document.documentElement.dir = 'ltr';
            }
            
            // אל תעדכן את שפת הפלט - תן למשתמש לבחור אותה בנפרד
            // const outputLanguageSelect = document.getElementById('outputLanguage');
            // if (outputLanguageSelect) {
            //     outputLanguageSelect.value = lang;
            // }
            
            translatePageCreatorInterface(lang);
        }

        function translatePageCreatorInterface(lang) {
            const translations = {
                'he': {
                    'main_title': 'יוצר דפי נחיתה מתקדם',
                    'main_subtitle': 'צור דף נחיתה מקצועי תוך דקות עם בוט AI חכם',
                    'create_page_title': 'צור דף',
                    'form_subtitle': 'מלא את הפרטים הבאים',
                    'fieldset_basic_details': 'פרטים בסיסיים',
                    'label_contact_name': 'שם איש קשר',
                    'label_email': 'אימייל',
                    'label_phone': 'טלפון',
                    'label_description': 'תיאור העסק',
                    'label_address': 'כתובת',
                    'fieldset_optional_sections': 'סעיפים אופציונליים',
                    'fieldset_social_media': 'רשתות חברתיות',
                    'label_youtube_display': 'הצגת YouTube',
                    'label_youtube_embed': 'קוד הטמעה',
                    'label_youtube_link': 'קישור',
                    'fieldset_design': 'עיצוב',
                    'label_hero_image': 'תמונת כותרת',
                    'label_use_as_background': 'השתמש כרקע',
                    'note_image_upload': 'העלה תמונה או השאר ריק',
                    'label_additional_settings': 'הגדרות נוספות',
                    'label_output_language': 'שפת הפלט',
                    'label_design_style': 'סגנון עיצוב',
                    'style_minimalist_pro': 'מינימליסטי מקצועי',
                    'style_midnight': 'חצות',
                    'style_claymorphism': 'קליי',
                    'style_retro_title': 'רטרו',
                    'style_retro': 'רטרו',
                    'style_aurora': 'אורורה',
                    'style_bento': 'בנטו',
                    'style_comic': 'קומיקס',
                    'style_surreal': 'סוריאליסטי',
                    'btn_back': 'חזור',
                    'btn_generate': 'צור דף',
                    'fieldset_external_links': 'קישורים חיצוניים',
                    'label_main_button_text': 'טקסט הכפתור הראשי',
                    'label_main_button_url': 'כתובת הכפתור הראשי',
                    'fieldset_property_details': 'פרטי הנכס',
                    'label_beds': 'חדרי שינה',
                    'label_baths': 'חדרי רחצה',
                    'label_sqft': 'מ״ר',
                    'label_price': 'מחיר',
                    'fieldset_app_links': 'קישורי אפליקציות',
                    'label_app_store_link': 'קישור App Store',
                    'label_google_play_link': 'קישור Google Play',
                    'modal_close_btn': 'סגור'
                },
                'en': {
                    'main_title': 'Advanced Landing Page Creator',
                    'main_subtitle': 'Create professional landing pages in minutes with smart AI bot',
                    'create_page_title': 'Create Page',
                    'form_subtitle': 'Fill in the following details',
                    'fieldset_basic_details': 'Basic Details',
                    'label_contact_name': 'Contact Name',
                    'label_email': 'Email',
                    'label_phone': 'Phone',
                    'label_description': 'Business Description',
                    'label_address': 'Address',
                    'fieldset_optional_sections': 'Optional Sections',
                    'fieldset_social_media': 'Social Media',
                    'label_youtube_display': 'YouTube Display',
                    'label_youtube_embed': 'Embed Code',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hero Image',
                    'label_use_as_background': 'Use as Background',
                    'note_image_upload': 'Upload image or leave blank',
                    'label_additional_settings': 'Additional Settings',
                    'label_output_language': 'Output Language',
                    'label_design_style': 'Design Style',
                    'style_minimalist_pro': 'Minimalist Pro',
                    'style_midnight': 'Midnight',
                    'style_claymorphism': 'Clay',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Back',
                    'btn_generate': 'Create Page',
                    'fieldset_external_links': 'External Links',
                    'label_main_button_text': 'Main Button Text',
                    'label_main_button_url': 'Main Button URL',
                    'fieldset_property_details': 'Property Details',
                    'label_beds': 'Bedrooms',
                    'label_baths': 'Bathrooms',
                    'label_sqft': 'Sq Ft',
                    'label_price': 'Price',
                    'fieldset_app_links': 'App Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link',
                    'modal_close_btn': 'Close'
                },
                'ar': {
                    'main_title': 'منشئ صفحات الهبوط المتقدم',
                    'main_subtitle': 'أنشئ صفحات هبوط احترافية في دقائق مع بوت ذكي',
                    'create_page_title': 'إنشاء صفحة',
                    'form_subtitle': 'املأ التفاصيل التالية',
                    'fieldset_basic_details': 'التفاصيل الأساسية',
                    'label_contact_name': 'اسم جهة الاتصال',
                    'label_email': 'البريد الإلكتروني',
                    'label_phone': 'الهاتف',
                        'label_description': 'وصف ال;عمل',
                    'label_address': 'العنوان',
                    'fieldset_optional_sections': 'أقسام اختيارية',
                    'fieldset_social_media': 'وسائل التواصل الاجتماعي',
                    'label_youtube_display': 'عرض YouTube',
                    'label_youtube_embed': 'كود التضمين',
                    'label_youtube_link': 'الرابط',
                    'fieldset_design': 'التصميم',
                    'label_hero_image': 'صورة البطل',
                    'label_use_as_background': 'استخدام كخلفية',
                    'note_image_upload': 'رفع صورة أو اتركها فارغة',
                    'label_additional_settings': 'إعدادات إضافية',
                    'label_output_language': 'لغة الإخراج',
                    'label_design_style': 'نمط التصميم',
                    'style_minimalist_pro': 'بسيط احترافي',
                    'style_midnight': 'منتصف الليل',
                    'style_claymorphism': 'طيني',
                    'style_retro_title': 'رجعي',
                    'style_retro': 'رجعي',
                    'style_aurora': 'الشفق',
                    'style_bento': 'بنتو',
                    'btn_back': 'رجوع',
                    'btn_generate': 'إنشاء صفحة',
                    'fieldset_external_links': 'روابط خارجية',
                    'label_main_button_text': 'نص الزر الرئيسي',
                    'label_main_button_url': 'رابط الزر الرئيسي',
                    'fieldset_property_details': 'تفاصيل العقار',
                    'label_beds': 'غرف النوم',
                    'label_baths': 'الحمامات',
                    'label_sqft': 'قدم مربع',
                    'label_price': 'السعر',
                    'fieldset_app_links': 'روابط التطبيقات',
                    'label_app_store_link': 'رابط App Store',
                    'label_google_play_link': 'رابط Google Play',
                    'modal_close_btn': 'إغلاق'
                },
                'ja': {
                    'main_title': '高度なランディングページ作成者',
                    'main_subtitle': 'スマートAIボットで数分でプロフェッショナルなランディングページを作成',
                    'create_page_title': 'ページ作成',
                    'form_subtitle': '以下の詳細を入力してください',
                    'fieldset_basic_details': '基本詳細',
                    'label_contact_name': '連絡先名',
                    'label_email': 'メール',
                    'label_phone': '電話番号',
                    'label_description': 'ビジネス説明',
                    'label_address': '住所',
                    'fieldset_optional_sections': 'オプションセクション',
                    'fieldset_social_media': 'ソーシャルメディア',
                    'label_youtube_display': 'YouTube表示',
                    'label_youtube_embed': '埋め込みコード',
                    'label_youtube_link': 'リンク',
                    'fieldset_design': 'デザイン',
                    'label_hero_image': 'ヒーロー画像',
                    'label_use_as_background': '背景として使用',
                    'note_image_upload': '画像をアップロードまたは空白のまま',
                    'label_additional_settings': '追加設定',
                    'label_output_language': '出力言語',
                    'label_design_style': 'デザインスタイル',
                    'style_minimalist_pro': 'ミニマリストプロ',
                    'style_midnight': 'ミッドナイト',
                    'style_claymorphism': 'クレイ',
                    'style_retro_title': 'レトロ',
                    'style_retro': 'レトロ',
                    'style_aurora': 'オーロラ',
                    'style_bento': 'ベント',
                    'btn_back': '戻る',
                    'btn_generate': 'ページ作成',
                    'fieldset_external_links': '外部リンク',
                    'label_main_button_text': 'メインボタンテキスト',
                    'label_main_button_url': 'メインボタンURL',
                    'fieldset_property_details': '物件詳細',
                    'label_beds': '寝室',
                    'label_baths': 'バスルーム',
                    'label_sqft': '平方フィート',
                    'label_price': '価格',
                    'fieldset_app_links': 'アプリリンク',
                    'label_app_store_link': 'App Storeリンク',
                    'label_google_play_link': 'Google Playリンク',
                    'modal_close_btn': '閉じる'
                },
                'es': {
                    'main_title': 'Creador Avanzado de Páginas de Aterrizaje',
                    'main_subtitle': 'Crea páginas de aterrizaje profesionales en minutos con bot IA inteligente',
                    'create_page_title': 'Crear Página',
                    'form_subtitle': 'Complete los siguientes detalles',
                    'fieldset_basic_details': 'Detalles Básicos',
                    'label_contact_name': 'Nombre de Contacto',
                    'label_email': 'Correo Electrónico',
                    'label_phone': 'Teléfono',
                    'label_description': 'Descripción del Negocio',
                    'label_address': 'Dirección',
                    'fieldset_optional_sections': 'Secciones Opcionales',
                    'fieldset_social_media': 'Redes Sociales',
                    'label_youtube_display': 'Mostrar YouTube',
                    'label_youtube_embed': 'Código de Incrustación',
                    'label_youtube_link': 'Enlace',
                    'fieldset_design': 'Diseño',
                    'label_hero_image': 'Imagen Principal',
                    'label_use_as_background': 'Usar como Fondo',
                    'note_image_upload': 'Subir imagen o dejar en blanco',
                    'label_additional_settings': 'Configuraciones Adicionales',
                    'label_output_language': 'Idioma de Salida',
                    'label_design_style': 'Estilo de Diseño',
                    'style_minimalist_pro': 'Minimalista Pro',
                    'style_midnight': 'Medianoche',
                    'style_claymorphism': 'Arcilla',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Atrás',
                    'btn_generate': 'Crear Página',
                    'fieldset_external_links': 'Enlaces Externos',
                    'label_main_button_text': 'Texto del Botón Principal',
                    'label_main_button_url': 'URL del Botón Principal',
                    'fieldset_property_details': 'Detalles de la Propiedad',
                    'label_beds': 'Dormitorios',
                    'label_baths': 'Baños',
                    'label_sqft': 'Pies Cuadrados',
                    'label_price': 'Precio',
                    'fieldset_app_links': 'Enlaces de Aplicaciones',
                    'label_app_store_link': 'Enlace de App Store',
                    'label_google_play_link': 'Enlace de Google Play',
                    'modal_close_btn': 'Cerrar'
                },
                'fr': {
                    'main_title': 'Créateur de Pages d\'Atterrissage Avancé',
                    'main_subtitle': 'Créez des pages d\'atterrissage professionnelles en minutes avec un bot IA intelligent',
                    'create_page_title': 'Créer une Page',
                    'form_subtitle': 'Remplissez les détails suivants',
                    'fieldset_basic_details': 'Détails de Base',
                    'label_contact_name': 'Nom de Contact',
                    'label_email': 'E-mail',
                    'label_phone': 'Téléphone',
                    'label_description': 'Description de l\'Entreprise',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Sections Optionnelles',
                    'fieldset_social_media': 'Réseaux Sociaux',
                    'label_youtube_display': 'Affichage YouTube',
                    'label_youtube_embed': 'Code d\'Intégration',
                    'label_youtube_link': 'Lien',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Image Principale',
                    'label_use_as_background': 'Utiliser comme Arrière-plan',
                    'note_image_upload': 'Télécharger une image ou laisser vide',
                    'label_additional_settings': 'Paramètres Supplémentaires',
                    'label_output_language': 'Langue de Sortie',
                    'label_design_style': 'Style de Design',
                    'style_minimalist_pro': 'Minimaliste Pro',
                    'style_midnight': 'Minuit',
                    'style_claymorphism': 'Argile',
                    'style_retro_title': 'Rétro',
                    'style_retro': 'Rétro',
                    'style_aurora': 'Aurore',
                    'style_bento': 'Bento',
                    'btn_back': 'Retour',
                    'btn_generate': 'Créer une Page',
                    'fieldset_external_links': 'Liens Externes',
                    'label_main_button_text': 'Texte du Bouton Principal',
                    'label_main_button_url': 'URL du Bouton Principal',
                    'fieldset_property_details': 'Détails de la Propriété',
                    'label_beds': 'Chambres',
                    'label_baths': 'Salles de Bain',
                    'label_sqft': 'Pieds Carrés',
                    'label_price': 'Prix',
                    'fieldset_app_links': 'Liens d\'Applications',
                    'label_app_store_link': 'Lien App Store',
                    'label_google_play_link': 'Lien Google Play',
                    'modal_close_btn': 'Fermer'
                },
                'de': {
                    'main_title': 'Erweiterter Landing Page Creator',
                    'main_subtitle': 'Erstellen Sie professionelle Landing Pages in Minuten mit intelligentem KI-Bot',
                    'create_page_title': 'Seite Erstellen',
                    'form_subtitle': 'Füllen Sie die folgenden Details aus',
                    'fieldset_basic_details': 'Grundlegende Details',
                    'label_contact_name': 'Kontaktname',
                    'label_email': 'E-Mail',
                    'label_phone': 'Telefon',
                    'label_description': 'Geschäftsbeschreibung',
                    'label_address': 'Adresse',
                    'fieldset_optional_sections': 'Optionale Abschnitte',
                    'fieldset_social_media': 'Soziale Medien',
                    'label_youtube_display': 'YouTube-Anzeige',
                    'label_youtube_embed': 'Einbettungscode',
                    'label_youtube_link': 'Link',
                    'fieldset_design': 'Design',
                    'label_hero_image': 'Hauptbild',
                    'label_use_as_background': 'Als Hintergrund verwenden',
                    'note_image_upload': 'Bild hochladen oder leer lassen',
                    'label_additional_settings': 'Zusätzliche Einstellungen',
                    'label_output_language': 'Ausgabesprache',
                    'label_design_style': 'Design-Stil',
                    'style_minimalist_pro': 'Minimalistisch Pro',
                    'style_midnight': 'Mitternacht',
                    'style_claymorphism': 'Ton',
                    'style_retro_title': 'Retro',
                    'style_retro': 'Retro',
                    'style_aurora': 'Aurora',
                    'style_bento': 'Bento',
                    'btn_back': 'Zurück',
                    'btn_generate': 'Seite Erstellen',
                    'fieldset_external_links': 'Externe Links',
                    'label_main_button_text': 'Hauptbutton-Text',
                    'label_main_button_url': 'Hauptbutton-URL',
                    'fieldset_property_details': 'Immobiliendetails',
                    'label_beds': 'Schlafzimmer',
                    'label_baths': 'Badezimmer',
                    'label_sqft': 'Quadratfuß',
                    'label_price': 'Preis',
                    'fieldset_app_links': 'App-Links',
                    'label_app_store_link': 'App Store Link',
                    'label_google_play_link': 'Google Play Link',
                    'modal_close_btn': 'Schließen'
                },
                'ru': {
                    'main_title': 'Продвинутый Создатель Лендингов',
                    'main_subtitle': 'Создавайте профессиональные лендинги за минуты с умным ИИ ботом',
                    'create_page_title': 'Создать Страницу',
                    'form_subtitle': 'Заполните следующие детали',
                    'fieldset_basic_details': 'Основные Детали',
                    'label_contact_name': 'Имя Контакта',
                    'label_email': 'Электронная Почта',
                    'label_phone': 'Телефон',
                    'label_description': 'Описание Бизнеса',
                    'label_address': 'Адрес',
                    'fieldset_optional_sections': 'Дополнительные Разделы',
                    'fieldset_social_media': 'Социальные Сети',
                    'label_youtube_display': 'Отображение YouTube',
                    'label_youtube_embed': 'Код Встраивания',
                    'label_youtube_link': 'Ссылка',
                    'fieldset_design': 'Дизайн',
                    'label_hero_image': 'Главное Изображение',
                    'label_use_as_background': 'Использовать как Фон',
                    'note_image_upload': 'Загрузить изображение или оставить пустым',
                    'label_additional_settings': 'Дополнительные Настройки',
                    'label_output_language': 'Язык Вывода',
                    'label_design_style': 'Стиль Дизайна',
                    'style_minimalist_pro': 'Минималистичный Про',
                    'style_midnight': 'Полночь',
                    'style_claymorphism': 'Глина',
                    'style_retro_title': 'Ретро',
                    'style_retro': 'Ретро',
                    'style_aurora': 'Аврора',
                    'style_bento': 'Бенто',
                    'btn_back': 'Назад',
                    'btn_generate': 'Создать Страницу',
                    'fieldset_external_links': 'Внешние Ссылки',
                    'label_main_button_text': 'Текст Главной Кнопки',
                    'label_main_button_url': 'URL Главной Кнопки',
                    'fieldset_property_details': 'Детали Недвижимости',
                    'label_beds': 'Спальни',
                    'label_baths': 'Ванные Комнаты',
                    'label_sqft': 'Квадратные Футы',
                    'label_price': 'Цена',
                    'fieldset_app_links': 'Ссылки на Приложения',
                    'label_app_store_link': 'Ссылка App Store',
                    'label_google_play_link': 'Ссылка Google Play',
                    'modal_close_btn': 'Закрыть'
                },
                'zh': {
                    'main_title': '高级着陆页创建器',
                    'main_subtitle': '使用智能AI机器人几分钟内创建专业着陆页',
                    'create_page_title': '创建页面',
                    'form_subtitle': '填写以下详细信息',
                    'fieldset_basic_details': '基本详情',
                    'label_contact_name': '联系人姓名',
                    'label_email': '电子邮件',
                    'label_phone': '电话',
                    'label_description': '业务描述',
                    'label_address': '地址',
                    'fieldset_optional_sections': '可选部分',
                    'fieldset_social_media': '社交媒体',
                    'label_youtube_display': 'YouTube显示',
                    'label_youtube_embed': '嵌入代码',
                    'label_youtube_link': '链接',
                    'fieldset_design': '设计',
                    'label_hero_image': '主图',
                    'label_use_as_background': '用作背景',
                    'note_image_upload': '上传图片或留空',
                    'label_additional_settings': '附加设置',
                    'label_output_language': '输出语言',
                    'label_design_style': '设计风格',
                    'style_minimalist_pro': '极简专业',
                    'style_midnight': '午夜',
                    'style_claymorphism': '粘土',
                    'style_retro_title': '复古',
                    'style_retro': '复古',
                    'style_aurora': '极光',
                    'style_bento': '便当',
                    'btn_back': '返回',
                    'btn_generate': '创建页面',
                    'fieldset_external_links': '外部链接',
                    'label_main_button_text': '主按钮文本',
                    'label_main_button_url': '主按钮URL',
                    'fieldset_property_details': '房产详情',
                    'label_beds': '卧室',
                    'label_baths': '浴室',
                    'label_sqft': '平方英尺',
                    'label_price': '价格',
                    'fieldset_app_links': '应用链接',
                    'label_app_store_link': 'App Store链接',
                    'label_google_play_link': 'Google Play链接',
                    'modal_close_btn': '关闭'
                }
            };

            const t = translations[lang] || translations['he'];
            
            // עדכן טקסטים עם data-translate-key
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (t[key]) {
                    element.textContent = t[key];
                }
            });
            
            // עדכן כותרת הדף
            document.title = t.main_title;
        }

        // טען פרמטרים מ-URL בעת טעינת הדף
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            if (urlLang) {
                const selector = document.getElementById('language-selector');
                if (selector) {
                    selector.value = urlLang;
                    updatePageLanguage(urlLang);
                }
            } else {
                // ברירת מחדל - עברית
                updatePageLanguage('he');
            }
        });



    </script>

</body>

        <!-- Store Management Dashboard -->
        <div id="store-management-dashboard" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-11/12 h-5/6 max-w-7xl overflow-hidden">
                <!-- Dashboard Header -->
                <div class="bg-gradient-to-r from-purple-600 to-pink-500 text-white p-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold" id="dashboard-title">ניהול</h1>
                        <button id="close-dashboard-btn" class="text-white hover:text-gray-200 text-2xl">×</button>
                    </div>
                </div>

                <!-- Dashboard Navigation -->
                <div class="bg-gray-100 border-b">
                    <nav class="flex space-x-8 px-6">
                        <button class="dashboard-nav-btn active" data-section="dashboard">דשבורד</button>
                        <button class="dashboard-nav-btn" data-section="orders">הזמנות</button>
                        <button class="dashboard-nav-btn" data-section="customers">לקוחות</button>
                        <button class="dashboard-nav-btn" data-section="products">מוצרים</button>
                        <button class="dashboard-nav-btn" data-section="media">תמונות</button>
                        <button class="dashboard-nav-btn" data-section="analytics">סטטיסטיקות</button>
                        <button class="dashboard-nav-btn" data-section="users">משתמשים</button>
                    </nav>
                </div>

                <!-- Dashboard Content -->
                <div class="p-6 h-full overflow-y-auto">
                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="dashboard-section">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg">
                                <h3 class="text-lg font-semibold">מכירות היום</h3>
                                <p class="text-3xl font-bold">₪2,450</p>
                            </div>
                            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg">
                                <h3 class="text-lg font-semibold">הזמנות חדשות</h3>
                                <p class="text-3xl font-bold">12</p>
                            </div>
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg">
                                <h3 class="text-lg font-semibold">לקוחות חדשים</h3>
                                <p class="text-3xl font-bold">8</p>
                            </div>
                            <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-6 rounded-lg">
                                <h3 class="text-lg font-semibold">מוצרים במלאי</h3>
                                <p class="text-3xl font-bold">156</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white border rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">מכירות שבועיות</h3>
                                <div class="h-64 bg-gray-100 rounded flex items-center justify-center">
                                    <p class="text-gray-500">גרף מכירות שבועיות</p>
                                </div>
                            </div>
                            <div class="bg-white border rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">מוצרים פופולריים</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span>מוצר A</span>
                                        <span class="text-green-600">45 מכירות</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>מוצר B</span>
                                        <span class="text-green-600">32 מכירות</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>מוצר C</span>
                                        <span class="text-green-600">28 מכירות</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Section -->
                    <div id="orders-section" class="dashboard-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">הזמנות</h2>
                            <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">ייצא דוח</button>
                        </div>
                        
                        <div class="bg-white border rounded-lg overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right">מספר הזמנה</th>
                                        <th class="px-6 py-3 text-right">לקוח</th>
                                        <th class="px-6 py-3 text-right">סכום</th>
                                        <th class="px-6 py-3 text-right">תאריך</th>
                                        <th class="px-6 py-3 text-right">סטטוס</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t">
                                        <td class="px-6 py-4">#12345</td>
                                        <td class="px-6 py-4">יוסי כהן</td>
                                        <td class="px-6 py-4">₪450</td>
                                        <td class="px-6 py-4">2024-01-15</td>
                                        <td class="px-6 py-4"><span class="bg-green-100 text-green-800 px-2 py-1 rounded">הושלם</span></td>
                                    </tr>
                                    <tr class="border-t">
                                        <td class="px-6 py-4">#12346</td>
                                        <td class="px-6 py-4">שרה לוי</td>
                                        <td class="px-6 py-4">₪320</td>
                                        <td class="px-6 py-4">2024-01-15</td>
                                        <td class="px-6 py-4"><span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">בטיפול</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Customers Section -->
                    <div id="customers-section" class="dashboard-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">לקוחות</h2>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">הוסף לקוח</button>
                        </div>
                        
                        <div class="bg-white border rounded-lg overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right">שם</th>
                                        <th class="px-6 py-3 text-right">אימייל</th>
                                        <th class="px-6 py-3 text-right">טלפון</th>
                                        <th class="px-6 py-3 text-right">סכום קניות</th>
                                        <th class="px-6 py-3 text-right">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t">
                                        <td class="px-6 py-4">יוסי כהן</td>
                                        <td class="px-6 py-4">yossi@example.com</td>
                                        <td class="px-6 py-4">050-1234567</td>
                                        <td class="px-6 py-4">₪1,250</td>
                                        <td class="px-6 py-4">
                                            <button class="text-blue-600 hover:text-blue-800">שלח הודעה</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Products Section -->
                    <div id="products-section" class="dashboard-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">מוצרים</h2>
                            <button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">הוסף מוצר</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white border rounded-lg p-6">
                                <img src="https://via.placeholder.com/200x150" alt="מוצר" class="w-full h-32 object-cover rounded mb-4">
                                <h3 class="font-semibold">מוצר A</h3>
                                <p class="text-gray-600">₪120</p>
                                <p class="text-sm text-gray-500">מלאי: 25</p>
                                <div class="mt-4 flex gap-2">
                                    <button class="bg-blue-600 text-white px-3 py-1 rounded text-sm">ערוך</button>
                                    <button class="bg-red-600 text-white px-3 py-1 rounded text-sm">מחק</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Media Section -->
                    <div id="media-section" class="dashboard-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">תמונות וקבצים</h2>
                            <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">העלה קובץ</button>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            <div class="bg-white border rounded-lg p-4">
                                <img src="https://via.placeholder.com/150x150" alt="תמונה" class="w-full h-24 object-cover rounded mb-2">
                                <p class="text-sm text-gray-600">image1.jpg</p>
                                <button class="text-red-600 text-sm mt-2">מחק</button>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Section -->
                    <div id="analytics-section" class="dashboard-section hidden">
                        <h2 class="text-2xl font-bold mb-6">סטטיסטיקות</h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white border rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">מכירות לפי שעות</h3>
                                <div class="h-64 bg-gray-100 rounded flex items-center justify-center">
                                    <p class="text-gray-500">גרף מכירות לפי שעות</p>
                                </div>
                            </div>
                            <div class="bg-white border rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4">ניתוח התנהגות לקוחות</h3>
                                <div class="h-64 bg-gray-100 rounded flex items-center justify-center">
                                    <p class="text-gray-500">גרף התנהגות לקוחות</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Section -->
                    <div id="users-section" class="dashboard-section hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">משתמשים ומנהלים</h2>
                            <button class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">הוסף מנהל</button>
                        </div>
                        
                        <div class="bg-white border rounded-lg overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right">שם משתמש</th>
                                        <th class="px-6 py-3 text-right">אימייל</th>
                                        <th class="px-6 py-3 text-right">תפקיד</th>
                                        <th class="px-6 py-3 text-right">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-t">
                                        <td class="px-6 py-4">admin</td>
                                        <td class="px-6 py-4">admin@store.com</td>
                                        <td class="px-6 py-4">מנהל ראשי</td>
                                        <td class="px-6 py-4">
                                            <button class="text-blue-600 hover:text-blue-800">ערוך</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // Store functionality injection
        function injectStoreScripts(htmlContent, data) {
            console.log('Injecting store scripts for page:', data.title);
            
            const pageName = data.title || 'store_' + Date.now();
            
            const storeScript = `
<script>
console.log('Store scripts loaded for: ${pageName}');

let userId = localStorage.getItem('userId') || 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
let storeId = '${pageName}';

// Get page info from URL
let pageFileName = decodeURIComponent(window.location.pathname.split('/').pop());
let pageUserId = window.location.pathname.split('/')[2]; // Extract userId from path /pages/userId/fileName

// Start with empty cart for new page load
let cart = [];
localStorage.setItem('cart_' + storeId, JSON.stringify(cart));

console.log('Store initialized with empty cart:', { pageName: '${pageName}', fileName: pageFileName, userId: pageUserId });

localStorage.setItem('userId', userId);

function updateCartDisplay() {
    cart = JSON.parse(localStorage.getItem('cart_' + storeId) || '[]');
    const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
    
    console.log('Updating cart display. Total items:', cartCount);
    
    // Update ALL cart badges (both ours and N8N's)
    const allBadges = document.querySelectorAll('.cart-count-badge, [class*="badge"], [class*="count"], span[class*="cart"]');
    allBadges.forEach(badge => {
        // Skip if it's inside our sidebar
        if (badge.closest('.cart-sidebar, #cart-sidebar')) {
            return;
        }
        
        badge.textContent = cartCount;
        badge.style.display = cartCount > 0 ? 'flex' : 'none';
        console.log('Updated badge:', badge.className);
    });
    
    // Update our badge
    const cartBadge = document.querySelector('.cart-count-badge');
    if (cartBadge) {
        cartBadge.textContent = cartCount;
        cartBadge.style.display = cartCount > 0 ? 'flex' : 'none';
    }
    
    const cartItems = document.querySelector('.cart-items');
    const cartTotal = document.querySelector('.cart-total');
    
    if (cartItems) {
        if (cart.length === 0) {
            cartItems.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;"><div style="font-size: 48px; margin-bottom: 15px;">🛒</div><div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">העגלה ריקה</div></div>';
        } else {
            const itemsHtml = cart.map(item => {
                const itemTotal = (item.price * item.quantity).toFixed(2);
                return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: white; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">' +
                    '<div style="flex: 1;">' +
                        '<div style="font-weight: bold; color: #333; margin-bottom: 5px; font-size: 16px;">' + item.name + '</div>' +
                        '<div style="color: #666; font-size: 14px;">₪' + item.price + ' x ' + item.quantity + '</div>' +
                    '</div>' +
                    '<div style="font-weight: bold; color: #007bff; font-size: 18px;">₪' + itemTotal + '</div>' +
                '</div>';
            }).join('');
            cartItems.innerHTML = itemsHtml;
            console.log('Cart items updated:', cart.length, 'items');
        }
    }
    
    if (cartTotal) {
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        cartTotal.textContent = '₪' + total;
    }
}

function addToCart(productName, price, image) {
    console.log('addToCart called:', { productName, price, image, storeId });
    
    cart = JSON.parse(localStorage.getItem('cart_' + storeId) || '[]');
    console.log('Current cart:', cart);
    
    const existingItem = cart.find(item => item.name === productName);
    
    if (existingItem) {
        existingItem.quantity += 1;
        console.log('Updated existing item quantity:', existingItem);
    } else {
        const newItem = {
            id: 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            name: productName,
            price: parseFloat(price),
            quantity: 1,
            image: image || ''
        };
        cart.push(newItem);
        console.log('Added new item:', newItem);
    }
    
    localStorage.setItem('cart_' + storeId, JSON.stringify(cart));
    console.log('Cart saved to localStorage');
    
    updateCartDisplay();
    console.log('Cart display updated');
    
    // Open cart sidebar
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    if (cartSidebar) {
        cartSidebar.classList.add('open');
    }
    
    alert(productName + ' נוסף לעגלה!');
}

function quickBuy(productName, price, image) {
    addToCart(productName, price, image);
    const cartSidebar = document.querySelector('.cart-sidebar');
    if (cartSidebar) {
        cartSidebar.classList.add('open');
    }
    setTimeout(() => checkout(), 1000);
}

function checkout() {
    cart = JSON.parse(localStorage.getItem('cart_' + storeId) || '[]');
    if (cart.length === 0) {
        alert('העגלה ריקה');
        return;
    }
    
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    // Show checkout form in the cart sidebar
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    if (!cartSidebar) return;
    
    cartSidebar.innerHTML = \`
        <div style="height: 100%; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                <h3 style="margin: 0; color: #007bff; font-size: 24px;">💳 תשלום</h3>
                <button onclick="cancelCheckout()" style="background: #6c757d; color: white; border: none; font-size: 16px; padding: 8px 16px; border-radius: 6px; cursor: pointer;">חזור</button>
            </div>
            
            <div style="flex: 1; overflow-y: auto;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">סיכום הזמנה</h4>
                    \${cart.map(item => \`
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                            <span>\${item.name} x \${item.quantity}</span>
                            <span style="font-weight: bold;">₪\${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    \`).join('')}
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                        <span>סכום ביניים:</span>
                        <span style="font-weight: bold;">₪\${total.toFixed(2)}</span>
                    </div>
                    <div id="shipping-cost-display" style="display: none; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6;">
                        <span>משלוח:</span>
                        <span style="font-weight: bold; color: #007bff;">₪35.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 15px 0 0 0; font-size: 20px; font-weight: bold; color: #28a745;">
                        <span>סה"כ לתשלום:</span>
                        <span id="final-total">₪\${total.toFixed(2)}</span>
                    </div>
                </div>
                
                <form id="checkout-form" style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">שם מלא *</label>
                        <input type="text" id="checkout-name" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">טלפון *</label>
                        <input type="tel" id="checkout-phone" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="050-1234567">
                    </div>
                    
                    <div>
                        <label style="display: flex; align-items: center; margin-bottom: 10px; gap: 8px;">
                            <input type="checkbox" id="checkout-shipping" onchange="toggleShipping()" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-weight: bold; color: #333;">משלוח (+ ₪35)</span>
                        </label>
                        <div id="shipping-address" style="display: none;">
                            <input type="text" id="checkout-address" placeholder="רחוב, מספר בית, עיר" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">אמצעי תשלום *</label>
                        <select id="checkout-payment-method" onchange="togglePaymentFields()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="credit">כרטיס אשראי</option>
                            <option value="paypal">PayPal</option>
                            <option value="bit">ביט</option>
                        </select>
                    </div>
                    
                    <div id="credit-card-fields">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">מספר כרטיס אשראי *</label>
                            <input type="text" id="checkout-card" placeholder="1234 5678 9012 3456" maxlength="19" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">תוקף *</label>
                                <input type="text" id="checkout-expiry" placeholder="MM/YY" maxlength="5" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">CVV *</label>
                                <input type="text" id="checkout-cvv" placeholder="123" maxlength="3" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                    </div>
                    
                    <div id="paypal-info" style="display: none; background: #fff3cd; padding: 12px; border-radius: 6px; border: 1px solid #ffc107;">
                        <p style="margin: 0; color: #856404; font-size: 14px;">תועבר לדף PayPal לסיום התשלום</p>
                    </div>
                    
                    <div id="bit-info" style="display: none; background: #d1ecf1; padding: 12px; border-radius: 6px; border: 1px solid #0dcaf0;">
                        <p style="margin: 0; color: #055160; font-size: 14px;">תועבר לאפליקציית ביט לסיום התשלום</p>
                    </div>
                </form>
            </div>
            
            <div style="padding-top: 15px; border-top: 2px solid #dee2e6;">
                <button onclick="processPayment()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                    ✅ אישור תשלום - ₪\${total.toFixed(2)}
                </button>
            </div>
        </div>
    \`;
    
    // Format card number
    const cardInput = document.getElementById('checkout-card');
    if (cardInput) {
        cardInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });
    }
    
    // Format expiry
    const expiryInput = document.getElementById('checkout-expiry');
    if (expiryInput) {
        expiryInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
    }
}

function cancelCheckout() {
    // Return to cart view
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    if (cartSidebar) {
        cartSidebar.innerHTML = \`
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                <h3 style="margin: 0; color: #007bff; font-size: 24px;">🛒 עגלת קניות</h3>
                <button onclick="toggleCart()" style="background: #dc3545; color: white; border: none; font-size: 20px; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">×</button>
            </div>
            <div class="cart-items"></div>
            <div class="cart-total" style="font-weight: bold; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 20px 0; font-size: 18px; color: #007bff;"></div>
            <button onclick="checkout()" style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 16px; font-weight: bold;">💳 המשך לתשלום</button>
            <button onclick="clearCart()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 14px;">🗑️ נקה עגלה</button>
        \`;
        updateCartDisplay();
    }
}

function toggleShipping() {
    const shippingCheckbox = document.getElementById('checkout-shipping');
    const shippingAddress = document.getElementById('shipping-address');
    const shippingCostDisplay = document.getElementById('shipping-cost-display');
    const finalTotal = document.getElementById('final-total');
    
    const cart = JSON.parse(localStorage.getItem('cart_' + storeId) || '[]');
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    if (shippingCheckbox.checked) {
        shippingAddress.style.display = 'block';
        shippingCostDisplay.style.display = 'flex';
        finalTotal.textContent = '₪' + (subtotal + 35).toFixed(2);
    } else {
        shippingAddress.style.display = 'none';
        shippingCostDisplay.style.display = 'none';
        finalTotal.textContent = '₪' + subtotal.toFixed(2);
    }
}

function togglePaymentFields() {
    const paymentMethod = document.getElementById('checkout-payment-method')?.value;
    const creditFields = document.getElementById('credit-card-fields');
    const paypalInfo = document.getElementById('paypal-info');
    const bitInfo = document.getElementById('bit-info');
    
    if (paymentMethod === 'credit') {
        creditFields.style.display = 'block';
        paypalInfo.style.display = 'none';
        bitInfo.style.display = 'none';
    } else if (paymentMethod === 'paypal') {
        creditFields.style.display = 'none';
        paypalInfo.style.display = 'block';
        bitInfo.style.display = 'none';
    } else if (paymentMethod === 'bit') {
        creditFields.style.display = 'none';
        paypalInfo.style.display = 'none';
        bitInfo.style.display = 'block';
    }
}

function processPayment() {
    const name = document.getElementById('checkout-name')?.value;
    const phone = document.getElementById('checkout-phone')?.value;
    const shippingCheckbox = document.getElementById('checkout-shipping')?.checked;
    const address = shippingCheckbox ? document.getElementById('checkout-address')?.value : '';
    const paymentMethod = document.getElementById('checkout-payment-method')?.value;
    
    // Validate required fields
    if (!name || !phone) {
        alert('אנא מלא שם וטלפון');
        return;
    }
    
    if (shippingCheckbox && !address) {
        alert('אנא מלא כתובת למשלוח');
        return;
    }
    
    // Validate payment method fields
    if (paymentMethod === 'credit') {
        const card = document.getElementById('checkout-card')?.value;
        const expiry = document.getElementById('checkout-expiry')?.value;
        const cvv = document.getElementById('checkout-cvv')?.value;
        
        if (!card || !expiry || !cvv) {
            alert('אנא מלא את פרטי כרטיס האשראי');
            return;
        }
    }
    
    cart = JSON.parse(localStorage.getItem('cart_' + storeId) || '[]');
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const shippingCost = shippingCheckbox ? 35 : 0;
    const total = subtotal + shippingCost;
    
    // Show loading
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    cartSidebar.innerHTML = \`
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 20px; animation: spin 1s linear infinite;">⏳</div>
            <h3 style="color: #007bff; margin: 0 0 10px 0;">מעבד תשלום...</h3>
            <p style="color: #666;">אנא המתן</p>
        </div>
        <style>
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        </style>
    \`;
    
    // Record purchase
    const purchaseData = {
        userId: userId,
        storeId: pageFileName,
        pageName: storeId,
        pageOwnerId: pageUserId,
        customerName: name,
        customerPhone: phone,
        customerAddress: address || 'איסוף עצמי',
        shipping: shippingCheckbox,
        shippingCost: shippingCost,
        products: cart,
        subtotal: subtotal,
        total: total,
        paymentMethod: paymentMethod,
        createdAt: new Date().toISOString()
    };
    
    console.log('Recording purchase:', purchaseData);
    
    // Try to send to server
    fetch(window.location.origin + '/api/purchase', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(purchaseData)
    }).then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Server not available');
    })
    .then(data => {
        console.log('Purchase recorded on server:', data);
    })
    .catch(error => {
        console.log('Server not available, saving locally:', error);
        const purchases = JSON.parse(localStorage.getItem('pending_purchases') || '[]');
        purchases.push(purchaseData);
        localStorage.setItem('pending_purchases', JSON.stringify(purchases));
    });
    
    // Show success after 2 seconds
    setTimeout(() => {
        cartSidebar.innerHTML = \`
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
                <div style="font-size: 80px; margin-bottom: 20px; color: #28a745;">✅</div>
                <h3 style="color: #28a745; margin: 0 0 10px 0;">תשלום בוצע בהצלחה!</h3>
                <p style="color: #666; margin-bottom: 30px;">תודה על הקנייה</p>
                <button onclick="closeCartAndReset()" style="padding: 12px 30px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                    סגור
                </button>
            </div>
        \`;
        
        // Clear cart
        localStorage.removeItem('cart_' + storeId);
        
        // Close cart after 3 seconds
        setTimeout(() => {
            closeCartAndReset();
        }, 3000);
    }, 2000);
}

function toggleCart() {
    console.log('toggleCart called');
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    let overlay = document.querySelector('.cart-overlay');
    
    // Create overlay if doesn't exist
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'cart-overlay';
        overlay.onclick = function() {
            toggleCart(); // Close cart when clicking overlay
        };
        document.body.appendChild(overlay);
    }
    
    if (cartSidebar) {
        console.log('Cart sidebar found, toggling...');
        const isOpen = cartSidebar.classList.contains('open');
        
        if (isOpen) {
            // Close cart
            cartSidebar.classList.remove('open');
            overlay.classList.remove('show');
        } else {
            // Open cart
            cartSidebar.classList.add('open');
            overlay.classList.add('show');
        }
        
        console.log('Cart sidebar classes:', cartSidebar.className);
    } else {
        console.error('Cart sidebar not found!');
    }
}

function closeCartAndReset() {
    const cartSidebar = document.querySelector('.cart-sidebar') || document.getElementById('cart-sidebar');
    const overlay = document.querySelector('.cart-overlay');
    
    if (cartSidebar) {
        cartSidebar.classList.remove('open');
        if (overlay) {
            overlay.classList.remove('show');
        }
        
        // Reset cart content after closing
        setTimeout(() => {
            cartSidebar.innerHTML = \`
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                    <h3 style="margin: 0; color: #007bff; font-size: 24px;">🛒 עגלת קניות</h3>
                    <button onclick="toggleCart()" style="background: #dc3545; color: white; border: none; font-size: 20px; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">×</button>
                </div>
                <div class="cart-items"></div>
                <div class="cart-total" style="font-weight: bold; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 20px 0; font-size: 18px; color: #007bff;"></div>
                <button onclick="checkout()" style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 16px; font-weight: bold;">💳 המשך לתשלום</button>
                <button onclick="clearCart()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 14px;">🗑️ נקה עגלה</button>
            \`;
            updateCartDisplay();
        }, 400);
    }
}

function clearCart() {
    if (confirm('האם אתה בטוח שברצונך לנקות את העגלה?')) {
        localStorage.removeItem('cart_' + storeId);
        updateCartDisplay();
        alert('העגלה נוקתה בהצלחה!');
    }
}

// Make functions globally available IMMEDIATELY
window.addToCart = addToCart;
window.quickBuy = quickBuy;
window.toggleCart = toggleCart;
window.checkout = checkout;
window.clearCart = clearCart;
window.processPayment = processPayment;
window.cancelCheckout = cancelCheckout;
window.closeCartAndReset = closeCartAndReset;
window.toggleShipping = toggleShipping;
window.togglePaymentFields = togglePaymentFields;

console.log('Functions registered globally:', {
    addToCart: typeof window.addToCart,
    quickBuy: typeof window.quickBuy,
    toggleCart: typeof window.toggleCart,
    checkout: typeof window.checkout,
    clearCart: typeof window.clearCart,
    processPayment: typeof window.processPayment,
    cancelCheckout: typeof window.cancelCheckout,
    closeCartAndReset: typeof window.closeCartAndReset
});

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing store...');
    
    // Re-register functions after DOM load (just in case)
    window.addToCart = addToCart;
    window.quickBuy = quickBuy;
    window.toggleCart = toggleCart;
    window.checkout = checkout;
    window.clearCart = clearCart;
    window.processPayment = processPayment;
    window.cancelCheckout = cancelCheckout;
    window.closeCartAndReset = closeCartAndReset;
    window.toggleShipping = toggleShipping;
    window.togglePaymentFields = togglePaymentFields;
    
    // Auto-attach event listeners to ALL buttons and cart icons
    setTimeout(() => {
        console.log('Starting auto-attachment...');
        
        // Find cart icon with class="cart-icon" and attach toggleCart
        const cartIcon = document.querySelector('.cart-icon');
        if (cartIcon) {
            cartIcon.onclick = (e) => {
                e.preventDefault();
                toggleCart();
            };
            cartIcon.style.cursor = 'pointer';
            cartIcon.style.position = 'relative';
            
            // Add badge to cart icon
            if (!cartIcon.querySelector('.cart-count-badge')) {
                const badge = document.createElement('span');
                badge.className = 'cart-count-badge';
                badge.textContent = '0';
                badge.style.display = 'none';
                cartIcon.appendChild(badge);
                console.log('Added badge to cart icon');
            }
            console.log('Cart icon found and connected!');
        } else {
            console.log('No cart icon found with class="cart-icon"');
        }
        
        // Find all product cards and add "Add to Cart" buttons if missing
        const productCards = document.querySelectorAll('[class*="product"], [class*="item"], [class*="card"]');
        console.log('Found potential product cards:', productCards.length);
        
        productCards.forEach((card, idx) => {
            // Check if it looks like a product (has image and price)
            const hasImage = card.querySelector('img');
            const hasPrice = card.textContent.includes('₪');
            
            if (!hasImage || !hasPrice) return;
            
            // Check if it already has an "Add to Cart" button
            const hasButton = Array.from(card.querySelectorAll('button')).some(btn => 
                btn.textContent.includes('הוסף') || btn.textContent.includes('עגלה') || btn.textContent.includes('Add') || btn.onclick
            );
            
            if (hasButton) {
                console.log(\`Product card \${idx} already has button\`);
                return;
            }
            
            // Extract product details
            const nameElement = card.querySelector('h1, h2, h3, h4, h5, h6');
            const productName = nameElement ? nameElement.textContent.trim() : 'מוצר ' + (idx + 1);
            
            const priceMatch = card.textContent.match(/₪\s*(\d+[\d,\.]*)/);
            const price = priceMatch ? parseFloat(priceMatch[1].replace(/,/g, '')) : 99;
            
            const image = card.querySelector('img')?.src || '';
            
            // Add button to card
            const button = document.createElement('button');
            button.textContent = '🛒 הוסף לעגלה';
            button.onclick = () => addToCart(productName, price, image);
            button.style.cssText = 'width: 100%; padding: 12px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);';
            button.onmouseover = () => button.style.transform = 'translateY(-2px)';
            button.onmouseout = () => button.style.transform = 'translateY(0)';
            
            card.appendChild(button);
            console.log(\`Added button to product: \${productName}, ₪\${price}\`);
        });
        
        console.log('Auto-attachment completed!');
    }, 1500);
    
    if (!document.getElementById('cart-sidebar')) {
        const sidebar = document.createElement('div');
        sidebar.id = 'cart-sidebar';
        sidebar.className = 'cart-sidebar';
        sidebar.innerHTML = \`
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                <h3 style="margin: 0; color: #007bff; font-size: 24px;">🛒 עגלת קניות</h3>
                <button onclick="toggleCart()" style="background: #dc3545; color: white; border: none; font-size: 20px; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">×</button>
            </div>
            <div class="cart-items"></div>
            <div class="cart-total" style="font-weight: bold; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 20px 0; font-size: 18px; color: #007bff;"></div>
            <button onclick="checkout()" style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 16px; font-weight: bold;">💳 המשך לתשלום</button>
            <button onclick="clearCart()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 14px;">🗑️ נקה עגלה</button>
        \`;
        document.body.appendChild(sidebar);
    }
    
    // Always create our cart icon if N8N didn't create a working one
    if (!document.querySelector('.cart-icon')) {
        // Create floating cart button
        const cartButton = document.createElement('div');
        cartButton.className = 'cart-icon';
        cartButton.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4); z-index: 1001; transition: all 0.3s;';
        cartButton.innerHTML = \`
            <svg style="width: 30px; height: 30px; fill: white;" viewBox="0 0 24 24">
                <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
            <span class="cart-count-badge" style="position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; border-radius: 50%; min-width: 24px; height: 24px; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">0</span>
        \`;
        cartButton.onclick = toggleCart;
        document.body.appendChild(cartButton);
        console.log('Created floating cart button');
    }
    
    updateCartDisplay();
    console.log('Store initialized successfully!');
});
</` + `script>

<style>
/* === CRITICAL CART STYLES - OVERRIDE ALL THEMES === */
.cart-sidebar, #cart-sidebar {
    position: fixed !important;
    top: 0 !important;
    right: -500px !important;
    width: 450px !important;
    max-width: 90vw !important;
    height: 100vh !important;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
    box-shadow: -5px 0 30px rgba(0,0,0,0.2) !important;
    transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    z-index: 2147483647 !important; /* Maximum z-index */
    padding: 25px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    border-left: 4px solid #007bff !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    direction: rtl !important;
    text-align: right !important;
}

.cart-sidebar.open, #cart-sidebar.open {
    right: 0 !important;
}

/* Cart overlay */
.cart-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.5) !important;
    z-index: 2147483646 !important;
    display: none !important;
    opacity: 0 !important;
    transition: opacity 0.3s ease !important;
}

.cart-overlay.show {
    display: block !important;
    opacity: 1 !important;
}

.cart-icon, [class*="cart-icon"], [id*="cart-icon"] {
    position: relative !important;
    cursor: pointer !important;
    z-index: 999998 !important;
}

.cart-count-badge, [class*="cart-count"], [class*="badge"] {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-width: 22px !important;
    height: 22px !important;
    padding: 0 6px !important;
    background: #dc3545 !important;
    color: white !important;
    border-radius: 11px !important;
    font-size: 12px !important;
    font-weight: bold !important;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4) !important;
    position: absolute !important;
    top: -8px !important;
    left: -8px !important;
}

/* Ensure cart always appears above everything */
.cart-sidebar * {
    box-sizing: border-box !important;
}

/* Remove any modal overlays that might interfere */
body.cart-open::before {
    content: none !important;
}

/* Override any theme-specific modal styles */
.modal, .overlay, .backdrop {
    z-index: 999997 !important;
}
</style>
`;
            
            if (htmlContent.includes('</body>')) {
                htmlContent = htmlContent.replace('</body>', storeScript + '</body>');
            } else {
                htmlContent += storeScript;
            }
            
            return htmlContent;
        }
        </script>

</html>

     הקובץ מוכן לקבלת הקוד שלך -->
<!-- אנא הדבק את הקוד המלא כאן -->
